              title: File Extension Spoofing
            product: Windows Defender Antivirus
 vulnerable version: 4.18.1908.7-0
      fixed version: Virus Definition Update of 2019/09/30
         CVE number: -
             impact: High
              found: 2019-09-25
                 by: David Haintz (Office Vienna)
                     SEC Consult Vulnerability Lab

                     An integrated part of SEC Consult
                     Europe | Asia | North America

                     https://www.sec-consult.com

=======================================================================

Vendor description:
-------------------
"Keep your PC safe with trusted antivirus protection built-in to Windows 10.
protection against software threats like viruses, malware and spyware across
email, apps, the cloud and the web."



Business recommendation:
------------------------
Update to the latest version of the Windows Defender Antivirus definitions.


Vulnerability overview/description:
-----------------------------------
The vulnerability is based on the file extension spoofing method using the RTL
unicode character to display a spoofed file extension. This method uses the LTR
unicode character, that instructs the following text to be shown in left-to-right
order. Lets assume [LTR] is the LTR unicode character, an attacker can use this
unicode character to fool a user into believing that a file has a different extension.

For example an attacker may name an executable file (.exe) &#039;spoofed-[LTR]gpj.exe&#039;,
which would be displayed as &#039;spoofed-exe.jpg&#039; on an LTR-based system. The most important
point here is to have the extension you want to be shown in reverse order, since it will
be shown right-to-left.
Combined with the right file icon, an attacker can imitate an arbitrary file extension.

Same goes for other extensions too, like &#039;xlsx&#039; for a Microsoft Excel Sheet. During testing
it happened that &#039;xlsx&#039; was typed in the wrong order (&#039;xslx&#039; instead of &#039;xlsx&#039; since reverse
order) and Windows Defender Antivirus removed the test file while we tried to execute it.
As a result, two files were created, with the exact same executable but with different fake
extensions:
1. spoofed-[RTL]xslx.exe (displayed as &#039;spoofed-exe.xlsx&#039;)
2. spoofed-[RTL]xlsx.exe (displayed as &#039;spoofed-exe.xslx&#039;)

The second one was deleted, while the first one could be executed without any problem.

Therefore, other extensions related to Microsoft Office were tested as well, but it seems
only the xlsx extension had a detection for it.


While the security issue of spoofing the file extension by using the RTL unicode character
(on RTL systems it is the same just with LTR) is widely known, it seems to be unknown that
Microsoft already started to add detection mechanisms for this issue. But since it is not
implemented for all extensions and it seems to be implemented in the wrong order, this
feature is mostly unknown.


Proof of concept:
-----------------
For the proof of concept a file has to be renamed in Unicode mode using the Unicode
character &#039;202E&#039; (&#039;\u202E&#039; in C), which stands for RTL. The sample code is written in
C/C++ and uses the unicode API of Windows. A Python PoC has been made as well.

C/C++:

#include <Windows.h>

int main(int argc, char** argv)
{
  wchar_t opath[] = L"test.exe";
  wchar_t npath_ok[] = L"spoofed-\u202Exslx.exe"; // String for filename &#039;spoofed-exe.xlsx&#039;
  wchar_t npath_wrong[] = L"spoofed-\u202Exlsx.exe"; // String for filename &#039;spoofed-exe.xslx&#039;
  
  // Copy &#039;test.exe&#039; to file shown as &#039;spoofed-exe.xlsx&#039;
  CopyFileW(opath, npath_ok, false);
  // Copy &#039;test.exe&#039; to file shown as &#039;spoofed-exe.xslx&#039;
  CopyFileW(opath, npath_wrong, false);
}


Python:

from shutil import copyfile

opath = "test.exe"
npath_ok = "spoofed-\u202Exslx.exe" # String for filename &#039;spoofed-exe.xlsx&#039;
npath_wrong = "spoofed-\u202Exlsx.exe" # String for filename &#039;spoofed-exe.xslx&#039;

# Copy &#039;test.exe&#039; to file shown as &#039;spoofed-exe.xlsx&#039;
copyfile(opath, npath_ok)
# Copy &#039;test.exe&#039; to file shown as &#039;spoofed-exe.xslx&#039;
copyfile(opath, npath_wrong)


There will be two new files after the execution (as long as &#039;test.exe&#039; exists) and the file
shown as &#039;spoofed-exe.xslx&#039; will be deleted while trying to execute (or earlier) as shown
in figure 1.

[ win-defender-ext-spoofing1.png ]
Figure 1: File gets deleted by Windows Defender Antivirus.


But the file shown as &#039;spoofed-exe.xlsx&#039; will be executed without any problem.

[ win-defender-ext-spoofing2.png ]
Figure2: Test file is executed.



Vulnerable / tested versions:
-----------------------------
Windows Defender Antivirus has been tested in its latest version 4.18.1908.7-0, updated at 25th
of September 2019.


Vendor contact timeline:
------------------------
2019-09-26: Providing vendor the advisory through secure@microsoft.com
2019-10-01: Microsoft answered that this is no vulnerability, but the virus definition
            database will be updated
2019-12-11: Public release of security advisory


Solution:
---------
The update of the virus definition database of the 30th of September provides a fix.

