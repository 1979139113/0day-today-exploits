# Google Dork: N/A
# Date: 05.09.2014
# Exploit Author: Fikri Fadzil - fikri.fadzil@impact-alliance.org
# Vendor Homepage - N/A
# Software Link: http://mods.mybb.com/view/user-social-networks
# Version: 1.2
# Tested on: PHP
 
 
Description:
This plugin allows you to add social networks, or related, in user
profiles. The information will be shown in a user profile and visible for
anyone who view the profile.
 
Proof of Concept
1. Login into your account.
2. Go to "Edit Profile" page at "/usercp.php?action=profile"
3. Update your Social Network ID with
"><script>alert(document.cookie)</script><"
4. The result can be seen in multiple places, including your profile page.
 
* The script will be executed whenever anyone view your profile.
** The result can also be seen in threads you involve IF the administrator
configure this plugin to allow user&#039;s social sites information to be
published in every post.
 
Solution:
Replace the content of "inc/plugins/usersocial.php" with this fix:

	

    <?php
    /**
     *
     * Fixed by Fikri Fadzil - fikri.fadzil@impact-alliance.org
     * - As I couldn&#039;t contact the developer, this is the patch for time being.
     *
     * User Social 1.1
     *
     * Copyright 2014 CrazyCat
     *
     * This program is free software: you can redistribute it
     * and/or modify it under the terms of the GNU General Public License
     * as published by the Free Software Foundation, either version 3
     * of the License, or (at your option) any later version.
     *
     * This program is distributed in the hope that it will be useful,
     * but WITHOUT ANY WARRANTY; without even the implied warranty of
     * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
     * See the GNU General Public License for more details.
     *
     *You should have received a copy of the GNU General Public License
     * along with this program.
     *If not, see <http://www.gnu.org/licenses/>.
    **/
     
    /**
     * Short changelog
     *
     * 1.2 : corrected usercp and member profil queries
     *
     * 1.1 : corrected package (pictures missing, language variables)
     * Upgrade: unactivate the plugin, upload the new version and re-activate
     *
     * 1.0 : Initial release
    **/
     
     
    if(!defined(&#039;IN_MYBB&#039;))
    {
        die(&#039;This file cannot be accessed directly.&#039;);
    }
     
    function usersocial_info()
    {
        return array(
            &#039;name&#039;          => "User social fields",
            &#039;description&#039;   => "Display more user social ids",
            &#039;website&#039;       => &#039;http://www.g33k-zone.org/&#039;,
            &#039;author&#039;        => &#039;CrazyCat&#039;,
            &#039;authorsite&#039;    => &#039;http://www.g33k-zone.org/&#039;,
            &#039;version&#039;       => &#039;1.2&#039;,
            &#039;compatibility&#039; => &#039;16*&#039;,
            &#039;guid&#039;          => &#039;da8691c12e504d9bba121d7b073bd3ed&#039;
        );
    }
     
    if(defined(&#039;IN_ADMINCP&#039;))
    {
        $plugins->add_hook(&#039;admin_user_menu&#039;, &#039;usersocial_menu&#039;);
        $plugins->add_hook(&#039;admin_user_action_handler&#039;, &#039;usersocial_action_handler&#039;);
        $plugins->add_hook(&#039;admin_load&#039;, &#039;usersocial_admin_load&#039;);
        $plugins->add_hook(&#039;admin_user_permissions&#039;, &#039;usersocial_admin_permissions&#039;);
    }
    else
    {
        $plugins->add_hook(&#039;postbit_pm&#039;, &#039;usersocial_postbit&#039;);
        $plugins->add_hook(&#039;postbit&#039;, &#039;usersocial_postbit&#039;);
        $plugins->add_hook(&#039;postbit_announcement&#039;, &#039;usersocial_postbit&#039;);
        $plugins->add_hook(&#039;member_profile_end&#039;, &#039;usersocial_profile&#039;);
        $plugins->add_hook(&#039;usercp_profile_start&#039;, &#039;usersocial_usercp&#039;);
        $plugins->add_hook(&#039;datahandler_user_update&#039;, &#039;usersocial_update_user&#039;);
    }
     
    function usersocial_menu(&$sub_menu)
    {
        global $lang;
            $lang->load(&#039;usersocial&#039;);
        $sub_menu[] = array(&#039;id&#039; => &#039;usersocial&#039;, &#039;title&#039; => $lang->usersocial, &#039;link&#039; => &#039;index.php?module=user-usersocial&#039;);
    }
     
    function usersocial_install()
    {
        global $db;
        if (usersocial_is_installed()) {
            usersocial_uninstall();
        }
        $collation = $db->build_create_table_collation();
        if(!$db->table_exists(&#039;social_network&#039;))
        {
            $db->write_query("CREATE TABLE IF NOT EXISTS ".TABLE_PREFIX."social_network (
               `snid` int(11) NOT NULL AUTO_INCREMENT,
               `sn_name` varchar(50) NOT NULL,
               `sn_label` varchar(255) NOT NULL,
               `sn_active` int(1) NOT NULL DEFAULT &#039;1&#039;,
               `sn_profil` int(1) NOT NULL DEFAULT &#039;1&#039;,
               `sn_postbit` int(1) NOT NULL DEFAULT &#039;0&#039;,
               `sn_link` varchar(250) NOT NULL,
               `sn_image` varchar(50) NOT NULL,
               `sn_order` int(5) NOT NULL,
               PRIMARY KEY (`snid`)
               ) ENGINE=MyISAM{$collation};"
            );
        }
        $db->insert_query(&#039;social_network&#039;,
            array(
                &#039;sn_name&#039; => &#039;Facebook&#039;,
                &#039;sn_label&#039; => &#039;Insert your Facebook username&#039;,
                &#039;sn_link&#039; => &#039;http://www.facebook.com/#username#&#039;,
                &#039;sn_image&#039; => &#039;facebook.png&#039;,
                &#039;sn_order&#039; => 1
            )
        );
        $db->insert_query(&#039;social_network&#039;,
            array(
                &#039;sn_name&#039; => &#039;Twitter&#039;,
                &#039;sn_label&#039; => &#039;Insert your Twitter username&#039;,
                &#039;sn_link&#039; => &#039;http://www.twitter.com/#username#&#039;,
                &#039;sn_image&#039; => &#039;twitter.png&#039;,
                &#039;sn_order&#039; => 2
            )
        );
        $db->insert_query(&#039;social_network&#039;,
            array(
                &#039;sn_name&#039; => &#039;Pinterest&#039;,
                &#039;sn_label&#039; => &#039;Insert your Pinterest username&#039;,
                &#039;sn_link&#039; => &#039;http://www.pinterest.com/#username#/&#039;,
                &#039;sn_image&#039; => &#039;pinterest.png&#039;,
                &#039;sn_order&#039; => 3
            )
        );
       
        if(!$db->table_exists(&#039;social_user_network&#039;))
        {
            $db->write_query("CREATE TABLE IF NOT EXISTS ".TABLE_PREFIX."social_user_network (
               `snid` int(11) NOT NULL,
               `uid` int(11) NOT NULL,
               `sn_value` varchar(255) NOT NULL,
               `sn_private` int(1) NOT NULL DEFAULT &#039;0&#039;,
               UNIQUE KEY `snid` (`snid`,`uid`)
               ) ENGINE=MyISAM{$collation};"
            );
        }
    }
     
    function usersocial_is_installed()
    {
        global $db;
        if( $db->table_exists(&#039;social_network&#039;) && $db->table_exists(&#039;social_user_network&#039;)) {
            return true;
        }
        return false;
    }
     
    function usersocial_uninstall()
    {
        global $db;
        if($db->table_exists(&#039;social_network&#039;))
        {
            $db->drop_table(&#039;social_network&#039;);
        }
        if($db->table_exists(&#039;social_user_network&#039;))
        {
            $db->drop_table(&#039;social_user_network&#039;);
        }
    }
     
    function usersocial_activate()
    {
        global $db, $mybb;
        $db->insert_query(&#039;templates&#039;,
            array(
                &#039;title&#039;     =>  &#039;usersocial_postbit&#039;,
                &#039;template&#039;  =>  $db->escape_string(&#039;<a href="{$network[\&#039;sn_link\&#039;]}" title="{$network[\&#039;sn_name\&#039;]}"><img src="{$network[\&#039;sn_image\&#039;]}" /></a>&#039;),
                &#039;version&#039;   =>  intval(1614),
                &#039;dateline&#039;  =>  TIME_NOW,
                &#039;sid&#039;       =>  -1
            )
        );
        $db->insert_query(&#039;templates&#039;,
            array(
                &#039;title&#039; => &#039;usersocial_member_profile_row&#039;,
                &#039;template&#039; => $db->escape_string(&#039;<tr>
       <td class="trow{$network[\&#039;even\&#039;]}"><strong>{$network[\&#039;sn_name\&#039;]}</strong></td>
       <td class="trow{$network[\&#039;even\&#039;]}">{$network[\&#039;ulink\&#039;]}</td>
    </tr>&#039;),
                 &#039;version&#039; => intval(1614),
                &#039;dateline&#039; => TIME_NOW,
                &#039;sid&#039; => -1
            )
        );
        $db->insert_query(&#039;templates&#039;,
            array(
                &#039;title&#039; => &#039;usersocial_usercp_row&#039;,
                &#039;template&#039; => $db->escape_string(&#039;<tr>
       <td><span class="smalltext">{$network[\&#039;sn_name\&#039;]}</span></td>
       <td><input type="text" class="textbox" size="25" name="sn[{$network[\&#039;snid\&#039;]}]" value="{$network[\&#039;sn_value\&#039;]}" /></td>
            <td><input type="checkbox" name="snp[{$network[\&#039;snid\&#039;]}]" {$network[\&#039;checked\&#039;]} value="1" /></td>
    </tr>
    <tr>
       <td colspan="3"><span class="smalltext">{$network[\&#039;sn_label\&#039;]}</span></td>
    </tr>&#039;),
                &#039;version&#039; => intval(1614),
                &#039;dateline&#039; => TIME_NOW,
                &#039;sid&#039; => -1
            )
        );
        $db->insert_query(&#039;templates&#039;,
            array(
                &#039;title&#039; => &#039;usersocial_usercp&#039;,
                &#039;template&#039; => $db->escape_string(&#039;<fieldset class="trow2">
    <legend><strong>{$lang->usersocial}</strong></legend>
    <table cellspacing="0" cellpadding="5">
    <tr>
            <th>{$lang->usersocial_network}</th>
            <th>{$lang->usersocial_username}</th>
            <th>{$lang->usersocial_private}</th>
    </tr>
    {$usersocial_rows}
    </table>
    </fieldset>&#039;),
                &#039;version&#039; => intval(1614),
                            &#039;dateline&#039; => TIME_NOW,
                            &#039;sid&#039; => -1
                    )
            );
        require_once MYBB_ROOT.&#039;/inc/adminfunctions_templates.php&#039;;
        rebuild_settings();
    }
     
    function usersocial_deactivate()
    {
        global $db, $mybb;
        $db->delete_query(&#039;templates&#039;, "title LIKE &#039;usersocial%&#039;");
     
        require_once MYBB_ROOT.&#039;/inc/adminfunctions_templates.php&#039;;
        rebuild_settings();
    }
     
    function usersocial_action_handler(&$action)
    {
        $action[&#039;usersocial&#039;] = array(&#039;active&#039; => &#039;usersocial&#039;, &#039;file&#039; => &#039;usersocial&#039;);
    }
     
     
    function usersocial_admin_permissions(&$admin_permissions)
    {
        global $lang;
        $lang->load(&#039;usersocial&#039;);
        $admin_permissions[&#039;usersocial&#039;] = $lang->usersocial_admin_action;
    }
     
    function usersocial_admin_load()
    {
        global $run_module, $action_file, $lang;
        $lang->load(&#039;usersocial&#039;);
        if ($run_module == &#039;user&#039; && $action_file == &#039;usersocial&#039;)
        {
            global $mybb, $db, $page, $lang;
            $page->add_breadcrumb_item($lang->usersocial, &#039;index.php?module=user-usersocial&#039;);
            $page->output_header($lang->usersocial);
            $mybb->input[&#039;aid&#039;] = intval($mybb->input[&#039;aid&#039;]);
            $mybb->input[&#039;uid&#039;] = intval($mybb->input[&#039;uid&#039;]);
            if (!$mybb->input[&#039;action&#039;] || in_array($mybb->input[&#039;action&#039;], array(&#039;add&#039;, &#039;edit&#039;)))
            {
                $sub_tabs[&#039;usersocial_view&#039;] = array(
                                    &#039;title&#039; => $lang->usersocial_list,
                                    &#039;link&#039; => &#039;index.php?module=user-usersocial&#039;,
                                    &#039;description&#039; => $lang->usersocial_list_desc
                );
                $sub_tabs[&#039;usersocial_add&#039;] = array(
                    &#039;title&#039; => $lang->usersocial_add,
                    &#039;link&#039; => &#039;index.php?module=user-usersocial&action=add&#039;,
                    &#039;description&#039; => $lang->usersocial_add_desc
                );
                $sub_tabs[&#039;usersocial_edit&#039;] = array(
                                    &#039;title&#039; => $lang->usersocial_edit,
                                    &#039;link&#039; => &#039;index.php?module=user-usersocial&action=edit&#039;,
                                    &#039;description&#039; => $lang->usersocial_edit_desc,
                            );
            }
            if (!$mybb->input[&#039;action&#039;] || $mybb->input[&#039;action&#039;] == &#039;view&#039;)
            {
                $page->output_nav_tabs($sub_tabs, &#039;usersocial_view&#039;);
                $table = new Table();
                $table->construct_header($lang->usersocial_icon, array(&#039;width&#039; => &#039;10%&#039;));
                $table->construct_header($lang->usersocial_network, array(&#039;width&#039; => &#039;45%&#039;));
                $table->construct_header($lang->usersocial_active, array(&#039;width&#039; => &#039;10%&#039;, &#039;class&#039; => &#039;align_center&#039;));
                $table->construct_header($lang->usersocial_profil, array(&#039;width&#039; => &#039;10%&#039;, &#039;class&#039; => &#039;align_center&#039;));
                $table->construct_header($lang->usersocial_post, array(&#039;width&#039; => &#039;10%&#039;, &#039;class&#039; => &#039;align_center&#039;));
                $table->construct_header($lang->usersocial_action, array(&#039;width&#039; => &#039;15%&#039;, &#039;class&#039; => &#039;align_center&#039;));
                $query = $db->simple_select(&#039;social_network&#039;, "*", "1=1", array("order_by" => &#039;sn_order&#039;, "order_dir" => &#039;ASC&#039;));
                if($db->num_rows($query) < 1)
                {
                    $table->construct_cell(&#039;<div align="center">&#039;.$lang->usersocial_no_network.&#039;</div>&#039;, array(&#039;colspan&#039; => 6));
                    $table->construct_row();
                }
                else
                {
                    while ($network = $db->fetch_array($query))
                    {
                        $table->construct_cell(&#039;<img src="&#039;.usersocial_get_icon($network[&#039;sn_image&#039;]).&#039;" />&#039;, array(&#039;class&#039; => &#039;align_center&#039;));
                        $table->construct_cell(htmlspecialchars_uni($network[&#039;sn_name&#039;]));
                        $table->construct_cell(&#039;<img src="../images/usersocial/bullet_&#039;.(($network[&#039;sn_active&#039;]==0) ? &#039;red&#039; : &#039;green&#039;).&#039;.png" alt="" title="&#039;.(($network[&#039;sn_active&#039;]==0) ? $lang->no : $lang->yes).&#039;" />&#039;, array(&#039;class&#039; => &#039;align_center&#039;));
                        $table->construct_cell(&#039;<img src="../images/usersocial/bullet_&#039;.(($network[&#039;sn_profil&#039;]==0) ? &#039;red&#039; : &#039;green&#039;).&#039;.png" alt="" title="&#039;.(($network[&#039;sn_profil&#039;]==0) ? $lang->no : $lang->yes).&#039;" />&#039;, array(&#039;class&#039; => &#039;align_center&#039;));
                        $table->construct_cell(&#039;<img src="../images/usersocial/bullet_&#039;.(($network[&#039;sn_postbit&#039;]==0) ? &#039;red&#039; : &#039;green&#039;).&#039;.png" alt="" title="&#039;.(($network[&#039;sn_postbit&#039;]==0) ? $lang->no : $lang->yes).&#039;" />&#039;, array(&#039;class&#039; => &#039;align_center&#039;));
                        $popup = new PopupMenu("usersocial_{$network[&#039;snid&#039;]}", $lang->options);
                        $popup->add_item($lang->usersocial_edit, "index.php?module=user-usersocial&amp;action=edit&amp;snid={$network[&#039;snid&#039;]}");
                        $popup->add_item($lang->usersocial_del, "index.php?module=user-usersocial&amp;action=delete&amp;snid={$network[&#039;snid&#039;]}");
                        $table->construct_cell($popup->fetch(), array(&#039;class&#039; => &#039;align_center&#039;));
                        $table->construct_row();
                    }
                }
                $db->free_result($query);
                $table->output($lang->usersocial_network);
            }
            elseif ($mybb->input[&#039;action&#039;] == &#039;add&#039;)
            {
                if ($mybb->request_method == &#039;post&#039;)
                {
                    if ($mybb->input[&#039;sn_name&#039;] == &#039;&#039;)
                    {
                        flash_message($lang->usersocial_add_error, &#039;error&#039;);
                        admin_redirect("index.php?module=user-usersocial&amp;action=add");
                    }
                    $insert = array(
                        &#039;sn_name&#039; => $mybb->input[&#039;sn_name&#039;],
                        &#039;sn_label&#039; => $mybb->input[&#039;sn_label&#039;],
                        &#039;sn_active&#039; => $mybb->input[&#039;sn_active&#039;],
                        &#039;sn_profil&#039; => $mybb->input[&#039;sn_profil&#039;],
                        &#039;sn_postbit&#039; => $mybb->input[&#039;sn_postbit&#039;],
                        &#039;sn_link&#039; => $mybb->input[&#039;sn_link&#039;],
                        &#039;sn_image&#039; => $mybb->input[&#039;sn_image&#039;],
                        &#039;sn_order&#039; => $mybb->input[&#039;sn_order&#039;]
                    );
                    log_admin_action($lang->usersocial_new_network . &#039; : &#039;.$insert[&#039;sn_name&#039;]);
                    usersocial_add_network($insert);
                    flash_message($lang->usersocial_add_success, &#039;success&#039;);
                    admin_redirect("index.php?module=user-usersocial");
                }
                $page->output_nav_tabs($sub_tabs, &#039;usersocial_add&#039;);
                $form = new Form(&#039;index.php?module=user-usersocial&amp;action=add&#039;, "post");
                $form_container = new FormContainer($lang->usersocial_add_network);
                $form_container->output_row($lang->usersocial_row_name, $lang->usersocial_row_name_desc, $form->generate_text_box(&#039;sn_name&#039;));
                $form_container->output_row($lang->usersocial_row_label, $lang->usersocial_row_label_desc, $form->generate_text_area(&#039;sn_label&#039;, &#039;&#039;, array(&#039;rows&#039; => 5, &#039;style&#039; => &#039;width:80%;&#039;)));
                $form_container->output_row($lang->usersocial_row_active, $lang->usersocial_row_active_desc, $form->generate_yes_no_radio(&#039;sn_active&#039;));
                $form_container->output_row($lang->usersocial_row_profil, $lang->usersocial_row_profil_desc, $form->generate_yes_no_radio(&#039;sn_profil&#039;));
                $form_container->output_row($lang->usersocial_row_postbit, $lang->usersocial_row_postbit_desc, $form->generate_yes_no_radio(&#039;sn_postbit&#039;));
                $form_container->output_row($lang->usersocial_row_link, $lang->usersocial_row_link_desc, $form->generate_text_box(&#039;sn_link&#039;));
                $form_container->output_row($lang->usersocial_row_icon, $lang->usersocial_row_icon_desc, $form->generate_text_box(&#039;sn_image&#039;));
                $form_container->output_row($lang->usersocial_row_order, $lang->usersocial_row_order_desc, $form->generate_text_box(&#039;sn_order&#039;));
                $form_container->end();
                $buttons = array();
                $buttons[] = $form->generate_submit_button($lang->usersocial_add);
                $buttons[] = $form->generate_reset_button($lang->usersocial_cancel);
                $form->output_submit_wrapper($buttons);
                $form->end();
            }
             elseif ($mybb->input[&#039;action&#039;] == &#039;edit&#039;)
                    {
                            if(!($network = usersocial_get_network($mybb->input[&#039;snid&#039;])))
                            {
                                    flash_message($lang->usersocial_edit_none, &#039;error&#039;);
                                    admin_redirect("index.php?module=user-usersocial");
                            }
                            if ($mybb->request_method == &#039;post&#039;)
                            {
                                    if ($mybb->input[&#039;sn_name&#039;] == &#039;&#039;)
                                    {
                                            flash_message($lang->usersocial_edit_error, &#039;error&#039;);
                                            admin_redirect("index.php?module=user-usersocial&amp;action=edit");
                                    }
                                    $update = array(
                                            &#039;sn_name&#039; => $mybb->input[&#039;sn_name&#039;],
                                            &#039;sn_label&#039; => $mybb->input[&#039;sn_label&#039;],
                                            &#039;sn_active&#039; => $mybb->input[&#039;sn_active&#039;],
                                            &#039;sn_profil&#039; => $mybb->input[&#039;sn_profil&#039;],
                                            &#039;sn_postbit&#039; => $mybb->input[&#039;sn_postbit&#039;],
                                            &#039;sn_link&#039; => $mybb->input[&#039;sn_link&#039;],
                                            &#039;sn_image&#039; => $mybb->input[&#039;sn_image&#039;],
                                            &#039;sn_order&#039; => $mybb->input[&#039;sn_order&#039;]
                                    );
                                    log_admin_action($lang->usersocial_edit_network . &#039; : &#039;.$update[&#039;sn_name&#039;]);
                                    usersocial_update_network($network[&#039;snid&#039;], $update);
                                    flash_message($lang->usersocial_edit_success, &#039;success&#039;);
                                    admin_redirect("index.php?module=user-usersocial");
                            }
                            $page->output_nav_tabs($sub_tabs, &#039;usersocial_edit&#039;);
                            $form = new Form("index.php?module=user-usersocial&amp;action=edit&amp;snid={$network[&#039;snid&#039;]}", "post");
                            $form_container = new FormContainer($lang->usersocial_edit_network);
                            $form_container->output_row($lang->usersocial_row_name, $lang->usersocial_row_name_desc, $form->generate_text_box(&#039;sn_name&#039;, $network[&#039;sn_name&#039;]));
                            $form_container->output_row($lang->usersocial_row_label, $lang->usersocial_row_label_desc, $form->generate_text_area(&#039;sn_label&#039;, htmlspecialchars_uni($network[&#039;sn_label&#039;]), array(&#039;rows&#039; => 5, &#039;style&#039; => &#039;width:80%;&#039;)));
                            $form_container->output_row($lang->usersocial_row_active, $lang->usersocial_row_active_desc, $form->generate_yes_no_radio(&#039;sn_active&#039;, intval($network[&#039;sn_active&#039;])));
                            $form_container->output_row($lang->usersocial_row_profil, $lang->usersocial_row_profil_desc, $form->generate_yes_no_radio(&#039;sn_profil&#039;, intval($network[&#039;sn_profil&#039;])));
                            $form_container->output_row($lang->usersocial_row_postbit, $lang->usersocial_row_postbit_desc, $form->generate_yes_no_radio(&#039;sn_postbit&#039;, intval($network[&#039;sn_postbit&#039;])));
                            $form_container->output_row($lang->usersocial_row_link, $lang->usersocial_row_link_desc, $form->generate_text_box(&#039;sn_link&#039;, htmlspecialchars_uni($network[&#039;sn_link&#039;])));
                            $form_container->output_row($lang->usersocial_row_icon, $lang->usersocial_row_icon_desc, $form->generate_text_box(&#039;sn_image&#039;, htmlspecialchars_uni($network[&#039;sn_image&#039;])));
                            $form_container->output_row($lang->usersocial_row_order, $lang->usersocial_row_order_desc, $form->generate_text_box(&#039;sn_order&#039;, intval($network[&#039;sn_order&#039;])));
                            $form_container->end();
                            $buttons = array();
                            $buttons[] = $form->generate_submit_button($lang->usersocial_add);
                            $form->output_submit_wrapper($buttons);
                            $form->end();
                    }
            elseif($mybb->input[&#039;action&#039;] == &#039;delete&#039;)
            {
                if(!($network = usersocial_get_network($mybb->input[&#039;snid&#039;])) || ($mybb->request_method == &#039;post&#039; && $mybb->input[&#039;my_post_key&#039;] != $mybb->post_code) || $mybb->input[&#039;no&#039;])
                {
                    if(!$mybb->input[&#039;no&#039;])
                    {
                        flash_message($lang->usersocial_del_error, &#039;error&#039;);
                    }
                    admin_redirect("index.php?module=user-usersocial");
                }
                if($mybb->request_method == &#039;post&#039;)
                {
                    log_admin_action($lang->usersocial_del_network . &#039; : &#039;.$network[&#039;sn_name&#039;], $network[&#039;snid&#039;]);
                    usersocial_delete_network($network[&#039;snid&#039;]);
                    flash_message($lang->usersocial_del_success, &#039;success&#039;);
                    admin_redirect("index.php?module=user-usersocial");
                }
                $form = new Form("index.php?module=user-usersocial&amp;action=delete&amp;snid={$network[&#039;snid&#039;]}&amp;my_post_key={$mybb->post_code}", &#039;post&#039;);
                echo("
                   <div class=\"confirm_action\">\n
                   <p>". $lang->usersocial_del_confirm."</p><br />\n
                   <p class=\"buttons\">
                   {$form->generate_submit_button($lang->yes, array(&#039;class&#039; => &#039;button_yes&#039;))}
                   {$form->generate_submit_button($lang->no, array("name" => "no", &#039;class&#039; => &#039;button_no&#039;))}
                   </p>\n
                   </div>
               ");
                $form->end();
            }
            $page->output_footer();
     
        }
    }
     
    function usersocial_add_network($data)
    {
        global $db;
        if (!is_array($data))
        {
            $data = array();
        }
        if ($data[&#039;sn_name&#039;])
        {
            $data[&#039;sn_name&#039;] = $db->escape_string($data[&#039;sn_name&#039;]);
        }
        if ($data[&#039;sn_label&#039;])
        {
            $data[&#039;sn_label&#039;] = $db->escape_string($data[&#039;sn_label&#039;]);
        }
        if ($data[&#039;sn_active&#039;])
        {
            $data[&#039;sn_active&#039;] = intval($data[&#039;sn_active&#039;]);
        }
        if ($data[&#039;sn_profil&#039;])
        {
            $data[&#039;sn_profil&#039;] = intval($data[&#039;sn_profil&#039;]);
        }
        if ($data[&#039;sn_postbit&#039;])
        {
            $data[&#039;sn_postbit&#039;] = intval($data[&#039;sn_postbit&#039;]);
        }
        if ($data[&#039;sn_image&#039;])
        {
            $data[&#039;sn_image&#039;] = $db->escape_string($data[&#039;sn_image&#039;]);
        }
        if ($data[&#039;sn_order&#039;])
        {
            $data[&#039;sn_order&#039;] = intval($data[&#039;sn_order&#039;]);
        }
        $db->insert_query(&#039;social_network&#039;, $data);
     
    }
     
    function usersocial_update_network($snid, $data)
    {
            global $db;
            if (!is_array($data))
            {
                    $data = array();
            }
            if ($data[&#039;sn_name&#039;])
            {
                    $data[&#039;sn_name&#039;] = $db->escape_string($data[&#039;sn_name&#039;]);
            }
            if ($data[&#039;sn_label&#039;])
            {
                    $data[&#039;sn_label&#039;] = $db->escape_string($data[&#039;sn_label&#039;]);
            }
            if ($data[&#039;sn_active&#039;])
            {
                    $data[&#039;sn_active&#039;] = intval($data[&#039;sn_active&#039;]);
            }
            if ($data[&#039;sn_profil&#039;])
            {
                    $data[&#039;sn_profil&#039;] = intval($data[&#039;sn_profil&#039;]);
            }
            if ($data[&#039;sn_postbit&#039;])
            {
                    $data[&#039;sn_postbit&#039;] = intval($data[&#039;sn_postbit&#039;]);
            }
            if ($data[&#039;sn_image&#039;])
            {
                    $data[&#039;sn_image&#039;] = $db->escape_string($data[&#039;sn_image&#039;]);
            }
            if ($data[&#039;sn_order&#039;])
            {
                    $data[&#039;sn_order&#039;] = intval($data[&#039;sn_order&#039;]);
            }
            $db->update_query(&#039;social_network&#039;, $data, "snid=&#039;{$snid}&#039;");
    }
     
    function usersocial_delete_network($snid)
    {
        global $db;
        $snid = intval($snid);
        $db->delete_query(&#039;social_network&#039;, "snid=&#039;{$snid}&#039;");
        $db->delete_query(&#039;social_user_network&#039;, "snid=&#039;{$snid}&#039;");
    }
     
    function usersocial_get_icon($img)
    {
        global $mybb;
        $image = $mybb->settings[&#039;bburl&#039;].&#039;/images/usersocial/default.png&#039;;
        if(my_strpos($img, "ttp:/"))
        {
            $image = $img;
        }
        if(!my_strpos($img, "/") && !empty($img) && file_exists(MYBB_ROOT.&#039;/images/usersocial/&#039;.$img))
        {
            $image = $mybb->settings[&#039;bburl&#039;].&#039;/images/usersocial/&#039;.htmlspecialchars_uni($img);
        }
        if(!empty($img) && file_exists(MYBB_ROOT.&#039;/images/&#039;.$img))
        {
            $image = $mybb->settings[&#039;bburl&#039;].&#039;/images/&#039;.htmlspecialchars_uni($img);
        }
        return $image;
    }
     
    function usersocial_get_network($snid)
    {
        global $db;
     
        $snid = intval($snid);
        $query = $db->simple_select(&#039;social_network&#039;, &#039;*&#039;, "snid=&#039;{$snid}&#039;");
        $network = $db->fetch_array($query);
        $db->free_result($query);
     
        if($network[&#039;snid&#039;])
        {
            return $network;
        }
        return false;
    }
     
    function usersocial_postbit(&$post)
    {
        global $db, $mybb, $templates;
        $post[&#039;usersocial&#039;] = &#039;&#039;;
        $sql = "SELECT s.sn_name, s.sn_link, s.sn_image, u.sn_value
       FROM ".TABLE_PREFIX."social_network s, ".TABLE_PREFIX."social_user_network u
       WHERE s.snid=u.snid AND u.uid=&#039;".$post[&#039;uid&#039;]."&#039; AND u.sn_private=0 AND u.sn_value<>&#039;&#039; AND s.sn_active=1 AND s.sn_postbit=1
       ORDER BY s.sn_order ASC";
        $query = $db->query($sql);
        if ($db->num_rows($query)>0) {
            $post[&#039;usersocial&#039;] = &#039;<br />&#039;;
            while ($network = $db->fetch_array($query)) {
                $network[&#039;sn_link&#039;] = str_replace(&#039;#username#&#039;, htmlspecialchars($network[&#039;sn_value&#039;], ENT_QUOTES), $network[&#039;sn_link&#039;]);
                $network[&#039;sn_image&#039;] = usersocial_get_icon($network[&#039;sn_image&#039;]);
                eval("\$post[&#039;usersocial&#039;] .= \"".$templates->get("usersocial_postbit")."\";");
            }
        }
    }
     
    function usersocial_profile()
    {
        global $db, $mybb, $templates, $memprofile, $lang;
        $lang->load(&#039;usersocial&#039;);
        $memprofile[&#039;usersocial&#039;] = &#039;&#039;;
        $sql = "SELECT s.sn_name, s.sn_link, s.sn_image, u.sn_value, u.sn_private
       FROM ".TABLE_PREFIX."social_network s
       LEFT JOIN ".TABLE_PREFIX."social_user_network u ON ( u.snid = s.snid AND u.uid=".$mybb->user[&#039;uid&#039;].")
       WHERE s.sn_active=1 AND s.sn_profil=1
       ORDER BY s.sn_order ASC";
        $query = $db->query($sql);
        if ($db->num_rows($query)>0) {
            $cpt = 0;
            $tr = &#039;</tr><tr>&#039;;
            while ($network = $db->fetch_array($query)) {
                $cpt++;
                $network[&#039;even&#039;] = ($cpt%2)+1;
                if ($network[&#039;sn_private&#039;]==1 || trim($network[&#039;sn_value&#039;])==&#039;&#039;)
                {
                    $network[&#039;ulink&#039;] = &#039;&#039;;
                }
                else
                {
                    $network[&#039;ulink&#039;] = &#039;<a href="&#039;.str_replace(&#039;#username#&#039;, htmlspecialchars($network[&#039;sn_value&#039;], ENT_QUOTES), $network[&#039;sn_link&#039;]).&#039;">&#039;. $lang->usersocial_contact .&#039; &#039;.$network[&#039;sn_name&#039;].&#039;</a>&#039;;
                }
                eval("\$memprofile[&#039;usersocial&#039;] .= \"</tr><tr>".$templates->get("usersocial_member_profile_row")."\";");
            }
        }
    }
     
    function usersocial_usercp()
    {
        global $db, $mybb, $templates, $usersocial, $usersocial_rows, $lang;
        $lang->load(&#039;usersocial&#039;);
        $sql = "SELECT s.snid, s.sn_name, s.sn_link, s.sn_image, s.sn_label, u.sn_value, u.sn_private
           FROM ".TABLE_PREFIX."social_network s
           LEFT JOIN ".TABLE_PREFIX."social_user_network u ON ( u.snid = s.snid AND u.uid=".$mybb->user[&#039;uid&#039;].")
           WHERE s.sn_active=1
           ORDER BY s.sn_order ASC";
        $query = $db->query($sql);
        $usersocial = &#039;&#039;;
        if ($db->num_rows($query)>0)
        {
            $usersocial_rows = &#039;&#039;;
            while ($network = $db->fetch_array($query)) {
                if ($network[&#039;sn_private&#039;]==1)
                {
                    $network[&#039;checked&#039;] = &#039; checked="checked"&#039;;
                }
                eval("\$usersocial_rows .= \"".$templates->get(&#039;usersocial_usercp_row&#039;)."\";");
            }
            eval("\$usersocial .= \"".$templates->get(&#039;usersocial_usercp&#039;)."\";");
        }
    }
     
    function usersocial_update_user()
    {
        global $db, $mybb;
        if($mybb->input[&#039;action&#039;] == "do_profile" && $mybb->request_method == "post")
        {
            $db->delete_query(&#039;social_user_network&#039;, &#039;uid=&#039;.$mybb->user[&#039;uid&#039;]);
            foreach($mybb->input[&#039;sn&#039;] as $k => $v) {
                if (isset($mybb->input[&#039;snp&#039;][$k]) && $mybb->input[&#039;snp&#039;][$k]==1)
                {
                    $mybb->input[&#039;snp&#039;][$k] = 1;
                }
                else
                {
                    $mybb->input[&#039;snp&#039;][$k] = 0;
                }
                $userdata = array(
                    &#039;snid&#039; => intval($k),
                    &#039;uid&#039; => intval($mybb->user[&#039;uid&#039;]),
                    &#039;sn_value&#039; => $db->escape_string(trim($v)),
                    &#039;sn_private&#039; => $mybb->input[&#039;snp&#039;][$k]
                );
                $db->insert_query(&#039;social_user_network&#039;, $userdata);
            }
        }
    }

