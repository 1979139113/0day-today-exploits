
CVE-2017-7116



When the dongle wishes to notify the host OS of an event, it does so by encoding a special "packet" and transmitting it to the host. These packets have an ether type of 0x886C, and do not contain actual packet data, but rather encapsulate information about events which must be handled by the driver.

One of the supported event packets is the WLC_E_COUNTRY_CODE_CHANGED message, which notifies that host that the country code has been modified. On iOS, these events are handled by the "handleCountryCodeChangedEvent" function in the "AppleBCMWLANCore" driver. Each packet of this type starts with the common event message header (which is 48 bytes long), followed by the 3-character country code, delimited by a NUL.

Here is a snippet of "handleCountryCodeChangedEvent"'s high-level logic:

int64_t handleCountryCodeChangedEvent(void* this, uint8_t* event_packet) {

  char* country_code = (char*)this + 3244;
  char* alt_country_code = (char*)this + 3248;
  strncpy(country_code, event_packet + 48, 3);
  country_code[3] = '\0';

  if ( strncmp(country_code, "XZ", strlen("XZ")) &&
       strncmp(alt_country_code, country_code 4)) {

    strncpy(alt_country_code, country_code, 3);
    alt_country_code[3] = '\0';
    updateChannelSpecsAsync(this);

  }
  ...
}

int64_t updateChannelSpecsAsync(void* this)
{
  char request_buffer[0x1C2];
  bzero(request_buffer, 0x1C2);
  char* country_code = (char*)this + 3244;
  strlcpy(request_buffer, country_code, 4);
  return issueCommand(..., request_buffer, ...); //Getting the "chanspecs" IO-Var
  ...
}


This bug is subject to a 90 day disclosure deadline. After 90 days elapse
or a patch has been made broadly available, the bug report will become
visible to the public.

